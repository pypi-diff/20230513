# Comparing `tmp/copyparty-1.7.0.tar.gz` & `tmp/copyparty-1.7.1.tar.gz`

## filetype from file(1)

```diff
@@ -1 +1 @@
-gzip compressed data, was "copyparty-1.7.0.tar", last modified: Sat Apr 29 22:23:54 2023, max compression
+gzip compressed data, was "copyparty-1.7.1.tar", last modified: Sun May  7 19:33:41 2023, max compression
```

## Comparing `copyparty-1.7.0.tar` & `copyparty-1.7.1.tar`

### file list

```diff
@@ -1,126 +1,122 @@
-drwxr-xr-x   0 ed        (1000) ed        (1000)        0 2023-04-29 22:23:54.663016 copyparty-1.7.0/
--rw-r--r--   0 ed        (1000) ed        (1000)     1059 2021-09-11 12:44:53.000000 copyparty-1.7.0/LICENSE
--rw-r--r--   0 ed        (1000) ed        (1000)      102 2023-04-29 22:23:53.000000 copyparty-1.7.0/MANIFEST.in
--rw-r--r--   0 ed        (1000) ed        (1000)    94511 2023-04-29 22:23:54.663016 copyparty-1.7.0/PKG-INFO
--rw-r--r--   0 ed        (1000) ed        (1000)    92715 2023-04-29 21:30:48.000000 copyparty-1.7.0/README.md
-drwxr-xr-x   0 ed        (1000) ed        (1000)        0 2023-04-29 22:23:54.649016 copyparty-1.7.0/bin/
--rwxr-xr-x   0 ed        (1000) ed        (1000)    32276 2023-04-29 22:22:13.000000 copyparty-1.7.0/bin/partyfuse.py
--rwxr-xr-x   0 ed        (1000) ed        (1000)    36249 2023-04-29 22:22:13.000000 copyparty-1.7.0/bin/up2k.py
-drwxr-xr-x   0 ed        (1000) ed        (1000)        0 2023-04-29 22:23:54.653016 copyparty-1.7.0/copyparty/
--rw-r--r--   0 ed        (1000) ed        (1000)     1063 2023-04-29 22:22:13.000000 copyparty-1.7.0/copyparty/__init__.py
--rwxr-xr-x   0 ed        (1000) ed        (1000)    68599 2023-04-29 22:22:13.000000 copyparty-1.7.0/copyparty/__main__.py
--rw-r--r--   0 ed        (1000) ed        (1000)      249 2023-04-29 22:22:13.000000 copyparty-1.7.0/copyparty/__version__.py
--rw-r--r--   0 ed        (1000) ed        (1000)    65210 2023-04-29 22:22:13.000000 copyparty-1.7.0/copyparty/authsrv.py
-drwxr-xr-x   0 ed        (1000) ed        (1000)        0 2023-04-29 22:23:54.653016 copyparty-1.7.0/copyparty/bos/
--rw-r--r--   0 ed        (1000) ed        (1000)        0 2023-04-29 22:22:13.000000 copyparty-1.7.0/copyparty/bos/__init__.py
--rw-r--r--   0 ed        (1000) ed        (1000)     1560 2023-04-29 22:22:13.000000 copyparty-1.7.0/copyparty/bos/bos.py
--rw-r--r--   0 ed        (1000) ed        (1000)      777 2023-04-29 22:22:13.000000 copyparty-1.7.0/copyparty/bos/path.py
--rw-r--r--   0 ed        (1000) ed        (1000)     3590 2023-04-29 22:22:13.000000 copyparty-1.7.0/copyparty/broker_mp.py
--rw-r--r--   0 ed        (1000) ed        (1000)     3200 2023-04-29 22:22:13.000000 copyparty-1.7.0/copyparty/broker_mpw.py
--rw-r--r--   0 ed        (1000) ed        (1000)     1759 2023-04-29 22:22:13.000000 copyparty-1.7.0/copyparty/broker_thr.py
--rw-r--r--   0 ed        (1000) ed        (1000)     1489 2023-04-29 22:22:13.000000 copyparty-1.7.0/copyparty/broker_util.py
--rw-r--r--   0 ed        (1000) ed        (1000)     6617 2023-04-29 22:22:13.000000 copyparty-1.7.0/copyparty/cfg.py
--rw-r--r--   0 ed        (1000) ed        (1000)     1548 2023-04-29 22:22:13.000000 copyparty-1.7.0/copyparty/dxml.py
--rw-r--r--   0 ed        (1000) ed        (1000)     3932 2023-04-29 22:22:13.000000 copyparty-1.7.0/copyparty/fsutil.py
--rw-r--r--   0 ed        (1000) ed        (1000)    15239 2023-04-29 22:22:13.000000 copyparty-1.7.0/copyparty/ftpd.py
--rw-r--r--   0 ed        (1000) ed        (1000)   122389 2023-04-29 22:22:13.000000 copyparty-1.7.0/copyparty/httpcli.py
--rw-r--r--   0 ed        (1000) ed        (1000)     6891 2023-04-29 22:22:13.000000 copyparty-1.7.0/copyparty/httpconn.py
--rw-r--r--   0 ed        (1000) ed        (1000)    15141 2023-04-29 22:22:13.000000 copyparty-1.7.0/copyparty/httpsrv.py
--rw-r--r--   0 ed        (1000) ed        (1000)     2643 2023-04-29 22:22:13.000000 copyparty-1.7.0/copyparty/ico.py
--rw-r--r--   0 ed        (1000) ed        (1000)    16978 2023-04-29 22:22:13.000000 copyparty-1.7.0/copyparty/mdns.py
--rw-r--r--   0 ed        (1000) ed        (1000)    16844 2023-04-29 22:22:13.000000 copyparty-1.7.0/copyparty/mtag.py
--rw-r--r--   0 ed        (1000) ed        (1000)    11520 2023-04-29 22:22:13.000000 copyparty-1.7.0/copyparty/multicast.py
-drwxr-xr-x   0 ed        (1000) ed        (1000)        0 2023-04-29 22:23:54.654016 copyparty-1.7.0/copyparty/res/
--rw-r--r--   0 ed        (1000) ed        (1000)    10570 2023-04-29 22:22:13.000000 copyparty-1.7.0/copyparty/res/COPYING.txt
--rw-r--r--   0 ed        (1000) ed        (1000)     2876 2023-04-23 21:16:05.000000 copyparty-1.7.0/copyparty/res/insecure.pem
--rw-r--r--   0 ed        (1000) ed        (1000)    10623 2023-04-29 22:22:13.000000 copyparty-1.7.0/copyparty/smbd.py
--rw-r--r--   0 ed        (1000) ed        (1000)     6153 2023-04-29 22:22:13.000000 copyparty-1.7.0/copyparty/ssdp.py
--rw-r--r--   0 ed        (1000) ed        (1000)     2699 2023-04-29 22:22:13.000000 copyparty-1.7.0/copyparty/star.py
-drwxr-xr-x   0 ed        (1000) ed        (1000)        0 2023-04-29 22:23:54.654016 copyparty-1.7.0/copyparty/stolen/
--rw-r--r--   0 ed        (1000) ed        (1000)        0 2023-04-29 22:22:13.000000 copyparty-1.7.0/copyparty/stolen/__init__.py
-drwxr-xr-x   0 ed        (1000) ed        (1000)        0 2023-04-29 22:23:54.655016 copyparty-1.7.0/copyparty/stolen/dnslib/
--rw-r--r--   0 ed        (1000) ed        (1000)      159 2023-04-29 22:22:13.000000 copyparty-1.7.0/copyparty/stolen/dnslib/__init__.py
--rw-r--r--   0 ed        (1000) ed        (1000)     1182 2023-04-29 22:22:13.000000 copyparty-1.7.0/copyparty/stolen/dnslib/bimap.py
--rw-r--r--   0 ed        (1000) ed        (1000)      348 2023-04-29 22:22:13.000000 copyparty-1.7.0/copyparty/stolen/dnslib/bit.py
--rw-r--r--   0 ed        (1000) ed        (1000)     1407 2023-04-29 22:22:13.000000 copyparty-1.7.0/copyparty/stolen/dnslib/buffer.py
--rw-r--r--   0 ed        (1000) ed        (1000)    20956 2023-04-29 22:22:13.000000 copyparty-1.7.0/copyparty/stolen/dnslib/dns.py
--rw-r--r--   0 ed        (1000) ed        (1000)     4893 2023-04-29 22:22:13.000000 copyparty-1.7.0/copyparty/stolen/dnslib/label.py
--rw-r--r--   0 ed        (1000) ed        (1000)     2615 2023-04-29 22:22:13.000000 copyparty-1.7.0/copyparty/stolen/dnslib/lex.py
--rw-r--r--   0 ed        (1000) ed        (1000)     1810 2023-04-29 22:22:13.000000 copyparty-1.7.0/copyparty/stolen/dnslib/ranges.py
-drwxr-xr-x   0 ed        (1000) ed        (1000)        0 2023-04-29 22:23:54.655016 copyparty-1.7.0/copyparty/stolen/ifaddr/
--rw-r--r--   0 ed        (1000) ed        (1000)      463 2023-04-29 22:22:13.000000 copyparty-1.7.0/copyparty/stolen/ifaddr/__init__.py
--rw-r--r--   0 ed        (1000) ed        (1000)     2626 2023-04-29 22:22:13.000000 copyparty-1.7.0/copyparty/stolen/ifaddr/_posix.py
--rw-r--r--   0 ed        (1000) ed        (1000)     6111 2023-04-29 22:22:13.000000 copyparty-1.7.0/copyparty/stolen/ifaddr/_shared.py
--rw-r--r--   0 ed        (1000) ed        (1000)     4026 2023-04-29 22:22:13.000000 copyparty-1.7.0/copyparty/stolen/ifaddr/_win32.py
--rw-r--r--   0 ed        (1000) ed        (1000)    21469 2023-04-29 22:22:13.000000 copyparty-1.7.0/copyparty/stolen/qrcodegen.py
--rw-r--r--   0 ed        (1000) ed        (1000)     5573 2023-04-29 22:22:13.000000 copyparty-1.7.0/copyparty/stolen/surrogateescape.py
--rw-r--r--   0 ed        (1000) ed        (1000)      972 2023-04-29 22:22:13.000000 copyparty-1.7.0/copyparty/sutil.py
--rw-r--r--   0 ed        (1000) ed        (1000)    23625 2023-04-29 22:22:13.000000 copyparty-1.7.0/copyparty/svchub.py
--rw-r--r--   0 ed        (1000) ed        (1000)     8166 2023-04-29 22:22:13.000000 copyparty-1.7.0/copyparty/szip.py
--rw-r--r--   0 ed        (1000) ed        (1000)    16643 2023-04-29 22:22:13.000000 copyparty-1.7.0/copyparty/tcpsrv.py
--rw-r--r--   0 ed        (1000) ed        (1000)     3826 2023-04-29 22:22:13.000000 copyparty-1.7.0/copyparty/th_cli.py
--rw-r--r--   0 ed        (1000) ed        (1000)    22379 2023-04-29 22:22:13.000000 copyparty-1.7.0/copyparty/th_srv.py
--rw-r--r--   0 ed        (1000) ed        (1000)    10585 2023-04-29 22:22:13.000000 copyparty-1.7.0/copyparty/u2idx.py
--rw-r--r--   0 ed        (1000) ed        (1000)   121985 2023-04-29 22:22:13.000000 copyparty-1.7.0/copyparty/up2k.py
--rw-r--r--   0 ed        (1000) ed        (1000)    71964 2023-04-29 22:22:13.000000 copyparty-1.7.0/copyparty/util.py
-drwxr-xr-x   0 ed        (1000) ed        (1000)        0 2023-04-29 22:23:54.658016 copyparty-1.7.0/copyparty/web/
-drwxr-xr-x   0 ed        (1000) ed        (1000)        0 2023-04-29 22:23:54.659016 copyparty-1.7.0/copyparty/web/a/
--rw-r--r--   0 ed        (1000) ed        (1000)        0 2023-04-29 22:22:13.000000 copyparty-1.7.0/copyparty/web/a/__init__.py
--rwxr-xr-x   0 ed        (1000) ed        (1000)    32276 2023-04-29 22:22:13.000000 copyparty-1.7.0/copyparty/web/a/partyfuse.py
--rwxr-xr-x   0 ed        (1000) ed        (1000)    36249 2023-04-29 22:22:13.000000 copyparty-1.7.0/copyparty/web/a/up2k.py
--rw-r--r--   0 ed        (1000) ed        (1000)     1449 2023-02-20 20:21:49.000000 copyparty-1.7.0/copyparty/web/a/webdav-cfg.bat
--rw-r--r--   0 ed        (1000) ed        (1000)     7295 2023-03-30 21:17:33.000000 copyparty-1.7.0/copyparty/web/baguettebox.js.gz
--rw-r--r--   0 ed        (1000) ed        (1000)    10956 2023-04-27 21:10:24.000000 copyparty-1.7.0/copyparty/web/browser.css.gz
--rw-r--r--   0 ed        (1000) ed        (1000)     5286 2023-03-15 22:20:24.000000 copyparty-1.7.0/copyparty/web/browser.html
--rw-r--r--   0 ed        (1000) ed        (1000)    59012 2023-04-29 09:29:49.000000 copyparty-1.7.0/copyparty/web/browser.js.gz
--rw-r--r--   0 ed        (1000) ed        (1000)     1604 2022-12-10 19:54:48.000000 copyparty-1.7.0/copyparty/web/browser2.html
--rw-r--r--   0 ed        (1000) ed        (1000)      585 2022-07-03 13:28:49.000000 copyparty-1.7.0/copyparty/web/cf.html
--rw-r--r--   0 ed        (1000) ed        (1000)      126 2021-09-11 12:44:53.000000 copyparty-1.7.0/copyparty/web/copyparty.gif
--rw-r--r--   0 ed        (1000) ed        (1000)      687 2022-07-14 21:26:48.000000 copyparty-1.7.0/copyparty/web/dbg-audio.js.gz
-drwxr-xr-x   0 ed        (1000) ed        (1000)        0 2023-04-29 22:23:54.660016 copyparty-1.7.0/copyparty/web/dd/
--rw-r--r--   0 ed        (1000) ed        (1000)      258 2021-09-11 12:44:53.000000 copyparty-1.7.0/copyparty/web/dd/2.png
--rw-r--r--   0 ed        (1000) ed        (1000)      252 2021-09-11 12:44:53.000000 copyparty-1.7.0/copyparty/web/dd/3.png
--rw-r--r--   0 ed        (1000) ed        (1000)      248 2021-09-11 12:44:53.000000 copyparty-1.7.0/copyparty/web/dd/4.png
--rw-r--r--   0 ed        (1000) ed        (1000)      250 2021-09-11 12:44:53.000000 copyparty-1.7.0/copyparty/web/dd/5.png
--rw-r--r--   0 ed        (1000) ed        (1000)        0 2023-04-29 22:22:13.000000 copyparty-1.7.0/copyparty/web/dd/__init__.py
-drwxr-xr-x   0 ed        (1000) ed        (1000)        0 2023-04-29 22:23:54.662016 copyparty-1.7.0/copyparty/web/deps/
--rw-r--r--   0 ed        (1000) ed        (1000)        0 2023-04-29 22:22:13.000000 copyparty-1.7.0/copyparty/web/deps/__init__.py
--rw-r--r--   0 ed        (1000) ed        (1000)     3053 2023-02-20 10:55:39.000000 copyparty-1.7.0/copyparty/web/deps/easymde.css.gz
--rw-r--r--   0 ed        (1000) ed        (1000)    76953 2023-04-01 14:48:07.000000 copyparty-1.7.0/copyparty/web/deps/easymde.js.gz
--rw-r--r--   0 ed        (1000) ed        (1000)    14819 2023-04-01 14:47:51.000000 copyparty-1.7.0/copyparty/web/deps/marked.js.gz
--rw-r--r--   0 ed        (1000) ed        (1000)      584 2023-04-01 14:48:09.000000 copyparty-1.7.0/copyparty/web/deps/mini-fa.css.gz
--rw-r--r--   0 ed        (1000) ed        (1000)     2784 2023-04-01 14:48:09.000000 copyparty-1.7.0/copyparty/web/deps/mini-fa.woff
--rw-r--r--   0 ed        (1000) ed        (1000)     1478 2022-12-29 03:41:18.000000 copyparty-1.7.0/copyparty/web/deps/prism.css.gz
--rw-r--r--   0 ed        (1000) ed        (1000)    41428 2022-12-29 03:41:18.000000 copyparty-1.7.0/copyparty/web/deps/prism.js.gz
--rw-r--r--   0 ed        (1000) ed        (1000)     1647 2022-12-29 03:41:18.000000 copyparty-1.7.0/copyparty/web/deps/prismd.css.gz
--rw-r--r--   0 ed        (1000) ed        (1000)     8612 2023-04-01 14:48:10.000000 copyparty-1.7.0/copyparty/web/deps/scp.woff2
--rw-r--r--   0 ed        (1000) ed        (1000)     7043 2023-04-01 14:23:12.000000 copyparty-1.7.0/copyparty/web/deps/sha512.ac.js.gz
--rw-r--r--   0 ed        (1000) ed        (1000)     8119 2021-07-22 23:48:12.000000 copyparty-1.7.0/copyparty/web/deps/sha512.hw.js.gz
--rw-r--r--   0 ed        (1000) ed        (1000)     2011 2022-10-30 15:38:07.000000 copyparty-1.7.0/copyparty/web/md.css.gz
--rw-r--r--   0 ed        (1000) ed        (1000)     4063 2022-12-10 20:27:29.000000 copyparty-1.7.0/copyparty/web/md.html
--rw-r--r--   0 ed        (1000) ed        (1000)     4121 2023-03-26 01:52:00.000000 copyparty-1.7.0/copyparty/web/md.js.gz
--rw-r--r--   0 ed        (1000) ed        (1000)      680 2022-12-01 22:41:28.000000 copyparty-1.7.0/copyparty/web/md2.css.gz
--rw-r--r--   0 ed        (1000) ed        (1000)     8209 2023-01-25 20:58:01.000000 copyparty-1.7.0/copyparty/web/md2.js.gz
--rw-r--r--   0 ed        (1000) ed        (1000)      929 2022-04-15 15:07:16.000000 copyparty-1.7.0/copyparty/web/mde.css.gz
--rw-r--r--   0 ed        (1000) ed        (1000)     1640 2022-12-10 20:27:33.000000 copyparty-1.7.0/copyparty/web/mde.html
--rw-r--r--   0 ed        (1000) ed        (1000)     2218 2022-12-01 07:23:41.000000 copyparty-1.7.0/copyparty/web/mde.js.gz
--rw-r--r--   0 ed        (1000) ed        (1000)      252 2021-09-11 12:44:53.000000 copyparty-1.7.0/copyparty/web/msg.css.gz
--rw-r--r--   0 ed        (1000) ed        (1000)      898 2022-12-10 19:57:40.000000 copyparty-1.7.0/copyparty/web/msg.html
--rw-r--r--   0 ed        (1000) ed        (1000)      927 2023-02-17 22:46:57.000000 copyparty-1.7.0/copyparty/web/splash.css.gz
--rw-r--r--   0 ed        (1000) ed        (1000)     3741 2023-02-19 19:41:20.000000 copyparty-1.7.0/copyparty/web/splash.html
--rw-r--r--   0 ed        (1000) ed        (1000)     1235 2023-02-17 22:28:18.000000 copyparty-1.7.0/copyparty/web/splash.js.gz
--rw-r--r--   0 ed        (1000) ed        (1000)    10612 2023-04-24 00:08:26.000000 copyparty-1.7.0/copyparty/web/svcs.html
--rw-r--r--   0 ed        (1000) ed        (1000)      519 2022-12-04 17:10:33.000000 copyparty-1.7.0/copyparty/web/svcs.js.gz
--rw-r--r--   0 ed        (1000) ed        (1000)     2418 2023-03-26 02:06:03.000000 copyparty-1.7.0/copyparty/web/ui.css.gz
--rw-r--r--   0 ed        (1000) ed        (1000)    21538 2023-03-06 02:35:26.000000 copyparty-1.7.0/copyparty/web/up2k.js.gz
--rw-r--r--   0 ed        (1000) ed        (1000)    13078 2023-03-30 20:54:19.000000 copyparty-1.7.0/copyparty/web/util.js.gz
--rw-r--r--   0 ed        (1000) ed        (1000)     1059 2023-03-02 22:42:45.000000 copyparty-1.7.0/copyparty/web/w.hash.js.gz
-drwxr-xr-x   0 ed        (1000) ed        (1000)        0 2023-04-29 22:23:54.653016 copyparty-1.7.0/copyparty.egg-info/
--rw-r--r--   0 ed        (1000) ed        (1000)    94511 2023-04-29 22:23:54.000000 copyparty-1.7.0/copyparty.egg-info/PKG-INFO
--rw-r--r--   0 ed        (1000) ed        (1000)     2828 2023-04-29 22:23:54.000000 copyparty-1.7.0/copyparty.egg-info/SOURCES.txt
--rw-r--r--   0 ed        (1000) ed        (1000)        1 2023-04-29 22:23:54.000000 copyparty-1.7.0/copyparty.egg-info/dependency_links.txt
--rw-r--r--   0 ed        (1000) ed        (1000)       54 2023-04-29 22:23:54.000000 copyparty-1.7.0/copyparty.egg-info/entry_points.txt
--rw-r--r--   0 ed        (1000) ed        (1000)      117 2023-04-29 22:23:54.000000 copyparty-1.7.0/copyparty.egg-info/requires.txt
--rw-r--r--   0 ed        (1000) ed        (1000)       10 2023-04-29 22:23:54.000000 copyparty-1.7.0/copyparty.egg-info/top_level.txt
--rw-r--r--   0 ed        (1000) ed        (1000)       38 2023-04-29 22:23:54.663016 copyparty-1.7.0/setup.cfg
--rwxr-xr-x   0 ed        (1000) ed        (1000)     4479 2023-02-15 18:44:28.000000 copyparty-1.7.0/setup.py
+drwxr-xr-x   0 ed        (1000) ed        (1000)        0 2023-05-07 19:33:41.091013 copyparty-1.7.1/
+-rw-r--r--   0 ed        (1000) ed        (1000)     1059 2021-09-11 12:44:53.000000 copyparty-1.7.1/LICENSE
+-rw-r--r--   0 ed        (1000) ed        (1000)    94637 2023-05-07 19:33:41.090013 copyparty-1.7.1/PKG-INFO
+-rw-r--r--   0 ed        (1000) ed        (1000)    92687 2023-05-07 15:16:06.000000 copyparty-1.7.1/README.md
+drwxr-xr-x   0 ed        (1000) ed        (1000)        0 2023-05-07 19:33:41.078013 copyparty-1.7.1/copyparty/
+-rw-r--r--   0 ed        (1000) ed        (1000)     1063 2023-05-07 19:33:26.000000 copyparty-1.7.1/copyparty/__init__.py
+-rwxr-xr-x   0 ed        (1000) ed        (1000)    68805 2023-05-07 19:33:26.000000 copyparty-1.7.1/copyparty/__main__.py
+-rw-r--r--   0 ed        (1000) ed        (1000)      248 2023-05-07 19:33:26.000000 copyparty-1.7.1/copyparty/__version__.py
+-rw-r--r--   0 ed        (1000) ed        (1000)    65534 2023-05-07 19:33:26.000000 copyparty-1.7.1/copyparty/authsrv.py
+drwxr-xr-x   0 ed        (1000) ed        (1000)        0 2023-05-07 19:33:41.079013 copyparty-1.7.1/copyparty/bos/
+-rw-r--r--   0 ed        (1000) ed        (1000)        0 2023-05-07 19:33:26.000000 copyparty-1.7.1/copyparty/bos/__init__.py
+-rw-r--r--   0 ed        (1000) ed        (1000)     1560 2023-05-07 19:33:26.000000 copyparty-1.7.1/copyparty/bos/bos.py
+-rw-r--r--   0 ed        (1000) ed        (1000)      777 2023-05-07 19:33:26.000000 copyparty-1.7.1/copyparty/bos/path.py
+-rw-r--r--   0 ed        (1000) ed        (1000)     3590 2023-05-07 19:33:26.000000 copyparty-1.7.1/copyparty/broker_mp.py
+-rw-r--r--   0 ed        (1000) ed        (1000)     3200 2023-05-07 19:33:26.000000 copyparty-1.7.1/copyparty/broker_mpw.py
+-rw-r--r--   0 ed        (1000) ed        (1000)     1759 2023-05-07 19:33:26.000000 copyparty-1.7.1/copyparty/broker_thr.py
+-rw-r--r--   0 ed        (1000) ed        (1000)     1489 2023-05-07 19:33:26.000000 copyparty-1.7.1/copyparty/broker_util.py
+-rw-r--r--   0 ed        (1000) ed        (1000)     6714 2023-05-07 19:33:26.000000 copyparty-1.7.1/copyparty/cfg.py
+-rw-r--r--   0 ed        (1000) ed        (1000)     1548 2023-05-07 19:33:26.000000 copyparty-1.7.1/copyparty/dxml.py
+-rw-r--r--   0 ed        (1000) ed        (1000)     3932 2023-05-07 19:33:26.000000 copyparty-1.7.1/copyparty/fsutil.py
+-rw-r--r--   0 ed        (1000) ed        (1000)    15258 2023-05-07 19:33:26.000000 copyparty-1.7.1/copyparty/ftpd.py
+-rw-r--r--   0 ed        (1000) ed        (1000)   122642 2023-05-07 19:33:26.000000 copyparty-1.7.1/copyparty/httpcli.py
+-rw-r--r--   0 ed        (1000) ed        (1000)     6891 2023-05-07 19:33:26.000000 copyparty-1.7.1/copyparty/httpconn.py
+-rw-r--r--   0 ed        (1000) ed        (1000)    15141 2023-05-07 19:33:26.000000 copyparty-1.7.1/copyparty/httpsrv.py
+-rw-r--r--   0 ed        (1000) ed        (1000)     2643 2023-05-07 19:33:26.000000 copyparty-1.7.1/copyparty/ico.py
+-rw-r--r--   0 ed        (1000) ed        (1000)    16978 2023-05-07 19:33:26.000000 copyparty-1.7.1/copyparty/mdns.py
+-rw-r--r--   0 ed        (1000) ed        (1000)    16844 2023-05-07 19:33:26.000000 copyparty-1.7.1/copyparty/mtag.py
+-rw-r--r--   0 ed        (1000) ed        (1000)    11520 2023-05-07 19:33:26.000000 copyparty-1.7.1/copyparty/multicast.py
+drwxr-xr-x   0 ed        (1000) ed        (1000)        0 2023-05-07 19:33:41.080013 copyparty-1.7.1/copyparty/res/
+-rw-r--r--   0 ed        (1000) ed        (1000)    10570 2023-05-07 19:33:26.000000 copyparty-1.7.1/copyparty/res/COPYING.txt
+-rw-r--r--   0 ed        (1000) ed        (1000)        0 2023-05-07 19:33:26.000000 copyparty-1.7.1/copyparty/res/__init__.py
+-rw-r--r--   0 ed        (1000) ed        (1000)     2876 2023-04-23 21:16:05.000000 copyparty-1.7.1/copyparty/res/insecure.pem
+-rw-r--r--   0 ed        (1000) ed        (1000)    10623 2023-05-07 19:33:26.000000 copyparty-1.7.1/copyparty/smbd.py
+-rw-r--r--   0 ed        (1000) ed        (1000)     6153 2023-05-07 19:33:26.000000 copyparty-1.7.1/copyparty/ssdp.py
+-rw-r--r--   0 ed        (1000) ed        (1000)     2699 2023-05-07 19:33:26.000000 copyparty-1.7.1/copyparty/star.py
+drwxr-xr-x   0 ed        (1000) ed        (1000)        0 2023-05-07 19:33:41.080013 copyparty-1.7.1/copyparty/stolen/
+-rw-r--r--   0 ed        (1000) ed        (1000)        0 2023-05-07 19:33:26.000000 copyparty-1.7.1/copyparty/stolen/__init__.py
+drwxr-xr-x   0 ed        (1000) ed        (1000)        0 2023-05-07 19:33:41.081013 copyparty-1.7.1/copyparty/stolen/dnslib/
+-rw-r--r--   0 ed        (1000) ed        (1000)      159 2023-05-07 19:33:26.000000 copyparty-1.7.1/copyparty/stolen/dnslib/__init__.py
+-rw-r--r--   0 ed        (1000) ed        (1000)     1182 2023-05-07 19:33:26.000000 copyparty-1.7.1/copyparty/stolen/dnslib/bimap.py
+-rw-r--r--   0 ed        (1000) ed        (1000)      348 2023-05-07 19:33:26.000000 copyparty-1.7.1/copyparty/stolen/dnslib/bit.py
+-rw-r--r--   0 ed        (1000) ed        (1000)     1407 2023-05-07 19:33:26.000000 copyparty-1.7.1/copyparty/stolen/dnslib/buffer.py
+-rw-r--r--   0 ed        (1000) ed        (1000)    20956 2023-05-07 19:33:26.000000 copyparty-1.7.1/copyparty/stolen/dnslib/dns.py
+-rw-r--r--   0 ed        (1000) ed        (1000)     4893 2023-05-07 19:33:26.000000 copyparty-1.7.1/copyparty/stolen/dnslib/label.py
+-rw-r--r--   0 ed        (1000) ed        (1000)     2615 2023-05-07 19:33:26.000000 copyparty-1.7.1/copyparty/stolen/dnslib/lex.py
+-rw-r--r--   0 ed        (1000) ed        (1000)     1810 2023-05-07 19:33:26.000000 copyparty-1.7.1/copyparty/stolen/dnslib/ranges.py
+drwxr-xr-x   0 ed        (1000) ed        (1000)        0 2023-05-07 19:33:41.082013 copyparty-1.7.1/copyparty/stolen/ifaddr/
+-rw-r--r--   0 ed        (1000) ed        (1000)      463 2023-05-07 19:33:26.000000 copyparty-1.7.1/copyparty/stolen/ifaddr/__init__.py
+-rw-r--r--   0 ed        (1000) ed        (1000)     2626 2023-05-07 19:33:26.000000 copyparty-1.7.1/copyparty/stolen/ifaddr/_posix.py
+-rw-r--r--   0 ed        (1000) ed        (1000)     6111 2023-05-07 19:33:26.000000 copyparty-1.7.1/copyparty/stolen/ifaddr/_shared.py
+-rw-r--r--   0 ed        (1000) ed        (1000)     4026 2023-05-07 19:33:26.000000 copyparty-1.7.1/copyparty/stolen/ifaddr/_win32.py
+-rw-r--r--   0 ed        (1000) ed        (1000)    21469 2023-05-07 19:33:26.000000 copyparty-1.7.1/copyparty/stolen/qrcodegen.py
+-rw-r--r--   0 ed        (1000) ed        (1000)     5573 2023-05-07 19:33:26.000000 copyparty-1.7.1/copyparty/stolen/surrogateescape.py
+-rw-r--r--   0 ed        (1000) ed        (1000)      972 2023-05-07 19:33:26.000000 copyparty-1.7.1/copyparty/sutil.py
+-rw-r--r--   0 ed        (1000) ed        (1000)    23625 2023-05-07 19:33:26.000000 copyparty-1.7.1/copyparty/svchub.py
+-rw-r--r--   0 ed        (1000) ed        (1000)     8166 2023-05-07 19:33:26.000000 copyparty-1.7.1/copyparty/szip.py
+-rw-r--r--   0 ed        (1000) ed        (1000)    16643 2023-05-07 19:33:26.000000 copyparty-1.7.1/copyparty/tcpsrv.py
+-rw-r--r--   0 ed        (1000) ed        (1000)     3826 2023-05-07 19:33:26.000000 copyparty-1.7.1/copyparty/th_cli.py
+-rw-r--r--   0 ed        (1000) ed        (1000)    22379 2023-05-07 19:33:26.000000 copyparty-1.7.1/copyparty/th_srv.py
+-rw-r--r--   0 ed        (1000) ed        (1000)    10585 2023-05-07 19:33:26.000000 copyparty-1.7.1/copyparty/u2idx.py
+-rw-r--r--   0 ed        (1000) ed        (1000)   121987 2023-05-07 19:33:26.000000 copyparty-1.7.1/copyparty/up2k.py
+-rw-r--r--   0 ed        (1000) ed        (1000)    71993 2023-05-07 19:33:26.000000 copyparty-1.7.1/copyparty/util.py
+drwxr-xr-x   0 ed        (1000) ed        (1000)        0 2023-05-07 19:33:41.085013 copyparty-1.7.1/copyparty/web/
+drwxr-xr-x   0 ed        (1000) ed        (1000)        0 2023-05-07 19:33:41.086013 copyparty-1.7.1/copyparty/web/a/
+-rw-r--r--   0 ed        (1000) ed        (1000)        0 2023-05-07 19:33:26.000000 copyparty-1.7.1/copyparty/web/a/__init__.py
+-rwxr-xr-x   0 ed        (1000) ed        (1000)    32276 2023-05-07 19:33:26.000000 copyparty-1.7.1/copyparty/web/a/partyfuse.py
+-rwxr-xr-x   0 ed        (1000) ed        (1000)    36247 2023-05-07 19:33:26.000000 copyparty-1.7.1/copyparty/web/a/u2c.py
+-rw-r--r--   0 ed        (1000) ed        (1000)     1449 2023-02-20 20:21:49.000000 copyparty-1.7.1/copyparty/web/a/webdav-cfg.bat
+-rw-r--r--   0 ed        (1000) ed        (1000)     7296 2023-03-30 21:17:33.000000 copyparty-1.7.1/copyparty/web/baguettebox.js.gz
+-rw-r--r--   0 ed        (1000) ed        (1000)    10960 2023-04-27 21:10:24.000000 copyparty-1.7.1/copyparty/web/browser.css.gz
+-rw-r--r--   0 ed        (1000) ed        (1000)     5286 2023-03-15 22:20:24.000000 copyparty-1.7.1/copyparty/web/browser.html
+-rw-r--r--   0 ed        (1000) ed        (1000)    59104 2023-05-06 16:26:44.000000 copyparty-1.7.1/copyparty/web/browser.js.gz
+-rw-r--r--   0 ed        (1000) ed        (1000)     1604 2022-12-10 19:54:48.000000 copyparty-1.7.1/copyparty/web/browser2.html
+-rw-r--r--   0 ed        (1000) ed        (1000)      585 2022-07-03 13:28:49.000000 copyparty-1.7.1/copyparty/web/cf.html
+-rw-r--r--   0 ed        (1000) ed        (1000)      688 2022-07-14 21:26:48.000000 copyparty-1.7.1/copyparty/web/dbg-audio.js.gz
+drwxr-xr-x   0 ed        (1000) ed        (1000)        0 2023-05-07 19:33:41.087013 copyparty-1.7.1/copyparty/web/dd/
+-rw-r--r--   0 ed        (1000) ed        (1000)      258 2021-09-11 12:44:53.000000 copyparty-1.7.1/copyparty/web/dd/2.png
+-rw-r--r--   0 ed        (1000) ed        (1000)      252 2021-09-11 12:44:53.000000 copyparty-1.7.1/copyparty/web/dd/3.png
+-rw-r--r--   0 ed        (1000) ed        (1000)      248 2021-09-11 12:44:53.000000 copyparty-1.7.1/copyparty/web/dd/4.png
+-rw-r--r--   0 ed        (1000) ed        (1000)      250 2021-09-11 12:44:53.000000 copyparty-1.7.1/copyparty/web/dd/5.png
+-rw-r--r--   0 ed        (1000) ed        (1000)        0 2023-05-07 19:33:26.000000 copyparty-1.7.1/copyparty/web/dd/__init__.py
+drwxr-xr-x   0 ed        (1000) ed        (1000)        0 2023-05-07 19:33:41.090013 copyparty-1.7.1/copyparty/web/deps/
+-rw-r--r--   0 ed        (1000) ed        (1000)        0 2023-05-07 19:33:26.000000 copyparty-1.7.1/copyparty/web/deps/__init__.py
+-rw-r--r--   0 ed        (1000) ed        (1000)     3053 2023-02-20 10:55:39.000000 copyparty-1.7.1/copyparty/web/deps/easymde.css.gz
+-rw-r--r--   0 ed        (1000) ed        (1000)    76953 2023-04-01 14:48:07.000000 copyparty-1.7.1/copyparty/web/deps/easymde.js.gz
+-rw-r--r--   0 ed        (1000) ed        (1000)    14819 2023-04-01 14:47:51.000000 copyparty-1.7.1/copyparty/web/deps/marked.js.gz
+-rw-r--r--   0 ed        (1000) ed        (1000)      584 2023-04-01 14:48:09.000000 copyparty-1.7.1/copyparty/web/deps/mini-fa.css.gz
+-rw-r--r--   0 ed        (1000) ed        (1000)     2784 2023-04-01 14:48:09.000000 copyparty-1.7.1/copyparty/web/deps/mini-fa.woff
+-rw-r--r--   0 ed        (1000) ed        (1000)     1478 2022-12-29 03:41:18.000000 copyparty-1.7.1/copyparty/web/deps/prism.css.gz
+-rw-r--r--   0 ed        (1000) ed        (1000)    41428 2022-12-29 03:41:18.000000 copyparty-1.7.1/copyparty/web/deps/prism.js.gz
+-rw-r--r--   0 ed        (1000) ed        (1000)     1647 2022-12-29 03:41:18.000000 copyparty-1.7.1/copyparty/web/deps/prismd.css.gz
+-rw-r--r--   0 ed        (1000) ed        (1000)     8612 2023-04-01 14:48:10.000000 copyparty-1.7.1/copyparty/web/deps/scp.woff2
+-rw-r--r--   0 ed        (1000) ed        (1000)     7043 2023-04-01 14:23:12.000000 copyparty-1.7.1/copyparty/web/deps/sha512.ac.js.gz
+-rw-r--r--   0 ed        (1000) ed        (1000)     8119 2021-07-22 23:48:12.000000 copyparty-1.7.1/copyparty/web/deps/sha512.hw.js.gz
+-rw-r--r--   0 ed        (1000) ed        (1000)     2011 2022-10-30 15:38:07.000000 copyparty-1.7.1/copyparty/web/md.css.gz
+-rw-r--r--   0 ed        (1000) ed        (1000)     4063 2022-12-10 20:27:29.000000 copyparty-1.7.1/copyparty/web/md.html
+-rw-r--r--   0 ed        (1000) ed        (1000)     4121 2023-03-26 01:52:00.000000 copyparty-1.7.1/copyparty/web/md.js.gz
+-rw-r--r--   0 ed        (1000) ed        (1000)      681 2022-12-01 22:41:28.000000 copyparty-1.7.1/copyparty/web/md2.css.gz
+-rw-r--r--   0 ed        (1000) ed        (1000)     8213 2023-01-25 20:58:01.000000 copyparty-1.7.1/copyparty/web/md2.js.gz
+-rw-r--r--   0 ed        (1000) ed        (1000)      929 2022-04-15 15:07:16.000000 copyparty-1.7.1/copyparty/web/mde.css.gz
+-rw-r--r--   0 ed        (1000) ed        (1000)     1640 2022-12-10 20:27:33.000000 copyparty-1.7.1/copyparty/web/mde.html
+-rw-r--r--   0 ed        (1000) ed        (1000)     2219 2022-12-01 07:23:41.000000 copyparty-1.7.1/copyparty/web/mde.js.gz
+-rw-r--r--   0 ed        (1000) ed        (1000)      252 2021-09-11 12:44:53.000000 copyparty-1.7.1/copyparty/web/msg.css.gz
+-rw-r--r--   0 ed        (1000) ed        (1000)      898 2022-12-10 19:57:40.000000 copyparty-1.7.1/copyparty/web/msg.html
+-rw-r--r--   0 ed        (1000) ed        (1000)      927 2023-02-17 22:46:57.000000 copyparty-1.7.1/copyparty/web/splash.css.gz
+-rw-r--r--   0 ed        (1000) ed        (1000)     3741 2023-02-19 19:41:20.000000 copyparty-1.7.1/copyparty/web/splash.html
+-rw-r--r--   0 ed        (1000) ed        (1000)     1235 2023-02-17 22:28:18.000000 copyparty-1.7.1/copyparty/web/splash.js.gz
+-rw-r--r--   0 ed        (1000) ed        (1000)    10610 2023-05-07 15:13:28.000000 copyparty-1.7.1/copyparty/web/svcs.html
+-rw-r--r--   0 ed        (1000) ed        (1000)      520 2022-12-04 17:10:33.000000 copyparty-1.7.1/copyparty/web/svcs.js.gz
+-rw-r--r--   0 ed        (1000) ed        (1000)     2419 2023-03-26 02:06:03.000000 copyparty-1.7.1/copyparty/web/ui.css.gz
+-rw-r--r--   0 ed        (1000) ed        (1000)    21540 2023-03-06 02:35:26.000000 copyparty-1.7.1/copyparty/web/up2k.js.gz
+-rw-r--r--   0 ed        (1000) ed        (1000)    13074 2023-05-06 18:53:00.000000 copyparty-1.7.1/copyparty/web/util.js.gz
+-rw-r--r--   0 ed        (1000) ed        (1000)     1060 2023-03-02 22:42:45.000000 copyparty-1.7.1/copyparty/web/w.hash.js.gz
+drwxr-xr-x   0 ed        (1000) ed        (1000)        0 2023-05-07 19:33:41.079013 copyparty-1.7.1/copyparty.egg-info/
+-rw-r--r--   0 ed        (1000) ed        (1000)    94637 2023-05-07 19:33:41.000000 copyparty-1.7.1/copyparty.egg-info/PKG-INFO
+-rw-r--r--   0 ed        (1000) ed        (1000)     2790 2023-05-07 19:33:41.000000 copyparty-1.7.1/copyparty.egg-info/SOURCES.txt
+-rw-r--r--   0 ed        (1000) ed        (1000)        1 2023-05-07 19:33:41.000000 copyparty-1.7.1/copyparty.egg-info/dependency_links.txt
+-rw-r--r--   0 ed        (1000) ed        (1000)      128 2023-05-07 19:33:41.000000 copyparty-1.7.1/copyparty.egg-info/entry_points.txt
+-rw-r--r--   0 ed        (1000) ed        (1000)      117 2023-05-07 19:33:41.000000 copyparty-1.7.1/copyparty.egg-info/requires.txt
+-rw-r--r--   0 ed        (1000) ed        (1000)       10 2023-05-07 19:33:41.000000 copyparty-1.7.1/copyparty.egg-info/top_level.txt
+-rw-r--r--   0 ed        (1000) ed        (1000)     4041 2023-05-07 18:02:24.000000 copyparty-1.7.1/pyproject.toml
+-rw-r--r--   0 ed        (1000) ed        (1000)       38 2023-05-07 19:33:41.091013 copyparty-1.7.1/setup.cfg
```

### Comparing `copyparty-1.7.0/LICENSE` & `copyparty-1.7.1/LICENSE`

 * *Files identical despite different names*

### Comparing `copyparty-1.7.0/PKG-INFO` & `copyparty-1.7.1/PKG-INFO`

 * *Files 1% similar despite different names*

```diff
@@ -1,15 +1,16 @@
 Metadata-Version: 2.1
 Name: copyparty
-Version: 1.7.0
-Summary: Portable file server with accelerated resumable uploads, deduplication, WebDAV, FTP, zeroconf, media indexer, video thumbnails, audio transcoding, and write-only folders
-Home-page: https://github.com/9001/copyparty
-Author: ed
-Author-email: copyparty@ocv.me
+Version: 1.7.1
+Summary:   Portable file server with accelerated resumable uploads, deduplication, WebDAV, FTP, zeroconf, media indexer, video thumbnails, audio transcoding, and write-only folders
+Author-email: ed <copyparty@ocv.me>
 License: MIT
+Project-URL: Source Code, https://github.com/9001/copyparty
+Project-URL: Bug Tracker, https://github.com/9001/copyparty/issues
+Project-URL: Demo Server, https://a.ocv.me/pub/demo/
 Classifier: Development Status :: 5 - Production/Stable
 Classifier: License :: OSI Approved :: MIT License
 Classifier: Programming Language :: Python
 Classifier: Programming Language :: Python :: 3
 Classifier: Programming Language :: Python :: 3.3
 Classifier: Programming Language :: Python :: 3.4
 Classifier: Programming Language :: Python :: 3.5
@@ -26,14 +27,15 @@
 Classifier: Environment :: Console
 Classifier: Environment :: No Input/Output (Daemon)
 Classifier: Intended Audience :: End Users/Desktop
 Classifier: Intended Audience :: System Administrators
 Classifier: Topic :: Communications :: File Sharing
 Classifier: Topic :: Internet :: File Transfer Protocol (FTP)
 Classifier: Topic :: Internet :: WWW/HTTP :: HTTP Servers
+Requires-Python: >=3.3
 Description-Content-Type: text/markdown
 Provides-Extra: thumbnails
 Provides-Extra: thumbnails2
 Provides-Extra: audiotags
 Provides-Extra: ftpd
 Provides-Extra: ftps
 License-File: LICENSE
@@ -140,17 +142,17 @@
 * [devnotes](#devnotes) - for build instructions etc, see [./docs/devnotes.md](./docs/devnotes.md)
 
 
 ## quickstart
 
 just run **[copyparty-sfx.py](https://github.com/9001/copyparty/releases/latest/download/copyparty-sfx.py)** -- that's it! 🎉
 
-* or install through pypi (python3 only): `python3 -m pip install --user -U copyparty`
+* or install through pypi: `python3 -m pip install --user -U copyparty`
 * or if you cannot install python, you can use [copyparty.exe](#copypartyexe) instead
-* or [install through nix](#nix-package), or [on NixOS](#nixos-module), or [on arch](#arch-package)
+* or install [on arch](#arch-package) ╱ [on NixOS](#nixos-module) ╱ [through nix](#nix-package)
 * or if you are on android, [install copyparty in termux](#install-on-android)
 * or if you prefer to [use docker](./scripts/docker/) 🐋 you can do that too
   * docker has all deps built-in, so skip this step:
 
 enable thumbnails (images/audio/video), media indexing, and audio transcoding by installing some recommended deps:
 
 * **Alpine:** `apk add py3-pillow ffmpeg`
@@ -341,15 +343,15 @@
 
 upgrade notes
 
 * `1.6.0` (2023-01-29):
   * http-api: delete/move is now `POST` instead of `GET`
   * everything other than `GET` and `HEAD` must pass [cors validation](#cors)
 * `1.5.0` (2022-12-03): [new chunksize formula](https://github.com/9001/copyparty/commit/54e1c8d261df) for files larger than 128 GiB
-  * **users:** upgrade to the latest [cli uploader](https://github.com/9001/copyparty/blob/hovudstraum/bin/up2k.py) if you use that
+  * **users:** upgrade to the latest [cli uploader](https://github.com/9001/copyparty/blob/hovudstraum/bin/u2c.py) if you use that
   * **devs:** update third-party up2k clients (if those even exist)
 
 
 # FAQ
 
 "frequently" asked questions
 
@@ -548,15 +550,15 @@
 you can also zip a selection of files or folders by clicking them in the browser, that brings up a selection editor and zip button in the bottom right
 
 ![copyparty-zipsel-fs8](https://user-images.githubusercontent.com/241032/129635374-e5136e01-470a-49b1-a762-848e8a4c9cdc.png)
 
 
 ## uploading
 
-drag files/folders into the web-browser to upload  (or use the [command-line uploader](https://github.com/9001/copyparty/tree/hovudstraum/bin#up2kpy))
+drag files/folders into the web-browser to upload  (or use the [command-line uploader](https://github.com/9001/copyparty/tree/hovudstraum/bin#u2cpy))
 
 this initiates an upload using `up2k`; there are two uploaders available:
 * `[🎈] bup`, the basic uploader, supports almost every browser since netscape 4.0
 * `[🚀] up2k`, the good / fancy one
 
 NB: you can undo/delete your own uploads with `[🧯]` [unpost](#unpost)
 
@@ -1410,18 +1412,18 @@
   * `chunk(){ curl -H pw:wark -T- http://127.0.0.1:3923/;}`  
     `chunk <movie.mkv`
 
 * bash: when curl and wget is not available or too boring
   * `(printf 'PUT /junk?pw=wark HTTP/1.1\r\n\r\n'; cat movie.mkv) | nc 127.0.0.1 3923`
   * `(printf 'PUT / HTTP/1.1\r\n\r\n'; cat movie.mkv) >/dev/tcp/127.0.0.1/3923`
 
-* python: [up2k.py](https://github.com/9001/copyparty/blob/hovudstraum/bin/up2k.py) is a command-line up2k client [(webm)](https://ocv.me/stuff/u2cli.webm)
+* python: [u2c.py](https://github.com/9001/copyparty/blob/hovudstraum/bin/u2c.py) is a command-line up2k client [(webm)](https://ocv.me/stuff/u2cli.webm)
   * file uploads, file-search, [folder sync](#folder-sync), autoresume of aborted/broken uploads
-  * can be downloaded from copyparty: controlpanel -> connect -> [up2k.py](http://127.0.0.1:3923/.cpr/a/up2k.py)
-  * see [./bin/README.md#up2kpy](bin/README.md#up2kpy)
+  * can be downloaded from copyparty: controlpanel -> connect -> [u2c.py](http://127.0.0.1:3923/.cpr/a/u2c.py)
+  * see [./bin/README.md#u2cpy](bin/README.md#u2cpy)
 
 * FUSE: mount a copyparty server as a local filesystem
   * cross-platform python client available in [./bin/](bin/)
   * can be downloaded from copyparty: controlpanel -> connect -> [partyfuse.py](http://127.0.0.1:3923/.cpr/a/partyfuse.py)
   * [rclone](https://rclone.org/) as client can give ~5x performance, see [./docs/rclone.md](docs/rclone.md)
 
 * sharex (screenshot utility): see [./contrib/sharex.sxcu](contrib/#sharexsxcu)
@@ -1436,19 +1438,19 @@
 NOTE: curl will not send the original filename if you use `-T` combined with url-params! Also, make sure to always leave a trailing slash in URLs unless you want to override the filename
 
 
 ## folder sync
 
 sync folders to/from copyparty
 
-the commandline uploader [up2k.py](https://github.com/9001/copyparty/tree/hovudstraum/bin#up2kpy) with `--dr` is the best way to sync a folder to copyparty; verifies checksums and does files in parallel, and deletes unexpected files on the server after upload has finished which makes file-renames really cheap (it'll rename serverside and skip uploading)
+the commandline uploader [u2c.py](https://github.com/9001/copyparty/tree/hovudstraum/bin#u2cpy) with `--dr` is the best way to sync a folder to copyparty; verifies checksums and does files in parallel, and deletes unexpected files on the server after upload has finished which makes file-renames really cheap (it'll rename serverside and skip uploading)
 
 alternatively there is [rclone](./docs/rclone.md) which allows for bidirectional sync and is *way* more flexible (stream files straight from sftp/s3/gcs to copyparty, ...), although there is no integrity check and it won't work with files over 100 MiB if copyparty is behind cloudflare
 
-* starting from rclone v1.63 (currently [in beta](https://beta.rclone.org/?filter=latest)), rclone will also be faster than up2k.py
+* starting from rclone v1.63 (currently [in beta](https://beta.rclone.org/?filter=latest)), rclone will also be faster than u2c.py
 
 
 ## mount as drive
 
 a remote copyparty server as a local filesystem;  go to the control-panel and click `connect` to see a list of commands to do that
 
 alternatively, some alternatives roughly sorted by speed (unreproducible benchmark), best first:
@@ -1507,15 +1509,15 @@
 ## client-side
 
 when uploading files,
 
 * chrome is recommended, at least compared to firefox:
   * up to 90% faster when hashing, especially on SSDs
   * up to 40% faster when uploading over extremely fast internets
-  * but [up2k.py](https://github.com/9001/copyparty/blob/hovudstraum/bin/up2k.py) can be 40% faster than chrome again
+  * but [u2c.py](https://github.com/9001/copyparty/blob/hovudstraum/bin/u2c.py) can be 40% faster than chrome again
 
 * if you're cpu-bottlenecked, or the browser is maxing a cpu core:
   * up to 30% faster uploads if you hide the upload status list by switching away from the `[🚀]` up2k ui-tab (or closing it)
     * optionally you can switch to the lightweight potato ui by clicking the `[🥔]`
     * switching to another browser-tab also works, the favicon will update every 10 seconds in that case
   * unlikely to be a problem, but can happen when uploding many small files, or your internet is too fast, or PC too slow
```

### Comparing `copyparty-1.7.0/README.md` & `copyparty-1.7.1/README.md`

 * *Files 1% similar despite different names*

```diff
@@ -100,17 +100,17 @@
 * [devnotes](#devnotes) - for build instructions etc, see [./docs/devnotes.md](./docs/devnotes.md)
 
 
 ## quickstart
 
 just run **[copyparty-sfx.py](https://github.com/9001/copyparty/releases/latest/download/copyparty-sfx.py)** -- that's it! 🎉
 
-* or install through pypi (python3 only): `python3 -m pip install --user -U copyparty`
+* or install through pypi: `python3 -m pip install --user -U copyparty`
 * or if you cannot install python, you can use [copyparty.exe](#copypartyexe) instead
-* or [install through nix](#nix-package), or [on NixOS](#nixos-module), or [on arch](#arch-package)
+* or install [on arch](#arch-package) ╱ [on NixOS](#nixos-module) ╱ [through nix](#nix-package)
 * or if you are on android, [install copyparty in termux](#install-on-android)
 * or if you prefer to [use docker](./scripts/docker/) 🐋 you can do that too
   * docker has all deps built-in, so skip this step:
 
 enable thumbnails (images/audio/video), media indexing, and audio transcoding by installing some recommended deps:
 
 * **Alpine:** `apk add py3-pillow ffmpeg`
@@ -301,15 +301,15 @@
 
 upgrade notes
 
 * `1.6.0` (2023-01-29):
   * http-api: delete/move is now `POST` instead of `GET`
   * everything other than `GET` and `HEAD` must pass [cors validation](#cors)
 * `1.5.0` (2022-12-03): [new chunksize formula](https://github.com/9001/copyparty/commit/54e1c8d261df) for files larger than 128 GiB
-  * **users:** upgrade to the latest [cli uploader](https://github.com/9001/copyparty/blob/hovudstraum/bin/up2k.py) if you use that
+  * **users:** upgrade to the latest [cli uploader](https://github.com/9001/copyparty/blob/hovudstraum/bin/u2c.py) if you use that
   * **devs:** update third-party up2k clients (if those even exist)
 
 
 # FAQ
 
 "frequently" asked questions
 
@@ -508,15 +508,15 @@
 you can also zip a selection of files or folders by clicking them in the browser, that brings up a selection editor and zip button in the bottom right
 
 ![copyparty-zipsel-fs8](https://user-images.githubusercontent.com/241032/129635374-e5136e01-470a-49b1-a762-848e8a4c9cdc.png)
 
 
 ## uploading
 
-drag files/folders into the web-browser to upload  (or use the [command-line uploader](https://github.com/9001/copyparty/tree/hovudstraum/bin#up2kpy))
+drag files/folders into the web-browser to upload  (or use the [command-line uploader](https://github.com/9001/copyparty/tree/hovudstraum/bin#u2cpy))
 
 this initiates an upload using `up2k`; there are two uploaders available:
 * `[🎈] bup`, the basic uploader, supports almost every browser since netscape 4.0
 * `[🚀] up2k`, the good / fancy one
 
 NB: you can undo/delete your own uploads with `[🧯]` [unpost](#unpost)
 
@@ -1370,18 +1370,18 @@
   * `chunk(){ curl -H pw:wark -T- http://127.0.0.1:3923/;}`  
     `chunk <movie.mkv`
 
 * bash: when curl and wget is not available or too boring
   * `(printf 'PUT /junk?pw=wark HTTP/1.1\r\n\r\n'; cat movie.mkv) | nc 127.0.0.1 3923`
   * `(printf 'PUT / HTTP/1.1\r\n\r\n'; cat movie.mkv) >/dev/tcp/127.0.0.1/3923`
 
-* python: [up2k.py](https://github.com/9001/copyparty/blob/hovudstraum/bin/up2k.py) is a command-line up2k client [(webm)](https://ocv.me/stuff/u2cli.webm)
+* python: [u2c.py](https://github.com/9001/copyparty/blob/hovudstraum/bin/u2c.py) is a command-line up2k client [(webm)](https://ocv.me/stuff/u2cli.webm)
   * file uploads, file-search, [folder sync](#folder-sync), autoresume of aborted/broken uploads
-  * can be downloaded from copyparty: controlpanel -> connect -> [up2k.py](http://127.0.0.1:3923/.cpr/a/up2k.py)
-  * see [./bin/README.md#up2kpy](bin/README.md#up2kpy)
+  * can be downloaded from copyparty: controlpanel -> connect -> [u2c.py](http://127.0.0.1:3923/.cpr/a/u2c.py)
+  * see [./bin/README.md#u2cpy](bin/README.md#u2cpy)
 
 * FUSE: mount a copyparty server as a local filesystem
   * cross-platform python client available in [./bin/](bin/)
   * can be downloaded from copyparty: controlpanel -> connect -> [partyfuse.py](http://127.0.0.1:3923/.cpr/a/partyfuse.py)
   * [rclone](https://rclone.org/) as client can give ~5x performance, see [./docs/rclone.md](docs/rclone.md)
 
 * sharex (screenshot utility): see [./contrib/sharex.sxcu](contrib/#sharexsxcu)
@@ -1396,19 +1396,19 @@
 NOTE: curl will not send the original filename if you use `-T` combined with url-params! Also, make sure to always leave a trailing slash in URLs unless you want to override the filename
 
 
 ## folder sync
 
 sync folders to/from copyparty
 
-the commandline uploader [up2k.py](https://github.com/9001/copyparty/tree/hovudstraum/bin#up2kpy) with `--dr` is the best way to sync a folder to copyparty; verifies checksums and does files in parallel, and deletes unexpected files on the server after upload has finished which makes file-renames really cheap (it'll rename serverside and skip uploading)
+the commandline uploader [u2c.py](https://github.com/9001/copyparty/tree/hovudstraum/bin#u2cpy) with `--dr` is the best way to sync a folder to copyparty; verifies checksums and does files in parallel, and deletes unexpected files on the server after upload has finished which makes file-renames really cheap (it'll rename serverside and skip uploading)
 
 alternatively there is [rclone](./docs/rclone.md) which allows for bidirectional sync and is *way* more flexible (stream files straight from sftp/s3/gcs to copyparty, ...), although there is no integrity check and it won't work with files over 100 MiB if copyparty is behind cloudflare
 
-* starting from rclone v1.63 (currently [in beta](https://beta.rclone.org/?filter=latest)), rclone will also be faster than up2k.py
+* starting from rclone v1.63 (currently [in beta](https://beta.rclone.org/?filter=latest)), rclone will also be faster than u2c.py
 
 
 ## mount as drive
 
 a remote copyparty server as a local filesystem;  go to the control-panel and click `connect` to see a list of commands to do that
 
 alternatively, some alternatives roughly sorted by speed (unreproducible benchmark), best first:
@@ -1467,15 +1467,15 @@
 ## client-side
 
 when uploading files,
 
 * chrome is recommended, at least compared to firefox:
   * up to 90% faster when hashing, especially on SSDs
   * up to 40% faster when uploading over extremely fast internets
-  * but [up2k.py](https://github.com/9001/copyparty/blob/hovudstraum/bin/up2k.py) can be 40% faster than chrome again
+  * but [u2c.py](https://github.com/9001/copyparty/blob/hovudstraum/bin/u2c.py) can be 40% faster than chrome again
 
 * if you're cpu-bottlenecked, or the browser is maxing a cpu core:
   * up to 30% faster uploads if you hide the upload status list by switching away from the `[🚀]` up2k ui-tab (or closing it)
     * optionally you can switch to the lightweight potato ui by clicking the `[🥔]`
     * switching to another browser-tab also works, the favicon will update every 10 seconds in that case
   * unlikely to be a problem, but can happen when uploding many small files, or your internet is too fast, or PC too slow
```

### Comparing `copyparty-1.7.0/bin/partyfuse.py` & `copyparty-1.7.1/copyparty/web/a/partyfuse.py`

 * *Files identical despite different names*

### Comparing `copyparty-1.7.0/bin/up2k.py` & `copyparty-1.7.1/copyparty/web/a/u2c.py`

 * *Files 1% similar despite different names*

```diff
@@ -1,17 +1,17 @@
 #!/usr/bin/env python3
 from __future__ import print_function, unicode_literals
 
-S_VERSION = "1.8"
-S_BUILD_DT = "2023-04-27"
+S_VERSION = "1.9"
+S_BUILD_DT = "2023-05-07"
 
 """
-up2k.py: upload to copyparty
+u2c.py: upload to copyparty
 2021, ed <irc.rizon.net>, MIT-Licensed
-https://github.com/9001/copyparty/blob/hovudstraum/bin/up2k.py
+https://github.com/9001/copyparty/blob/hovudstraum/bin/u2c.py
 
 - dependencies: requests
 - supports python 2.6, 2.7, and 3.3 through 3.12
 - if something breaks just try again and it'll autoresume
 """
 
 import os
```

### Comparing `copyparty-1.7.0/copyparty/__init__.py` & `copyparty-1.7.1/copyparty/__init__.py`

 * *Files identical despite different names*

### Comparing `copyparty-1.7.0/copyparty/__main__.py` & `copyparty-1.7.1/copyparty/__main__.py`

 * *Files 0% similar despite different names*

```diff
@@ -176,30 +176,30 @@
 
         td = tempfile.TemporaryDirectory(prefix="")
         atexit.register(td.cleanup)
         tdn = td.name
 
         with open_binary("copyparty", "z.tar") as tgz:
             with tarfile.open(fileobj=tgz) as tf:
-                tf.extractall(tdn)
+                tf.extractall(tdn)  # nosec (archive is safe)
 
         return tdn
 
     try:
         E.mod = os.path.dirname(os.path.realpath(__file__))
         if E.mod.endswith("__init__"):
             E.mod = os.path.dirname(E.mod)
     except:
         if not E.ox:
             raise
 
         E.mod = _unpack()
 
     if sys.platform == "win32":
-        bdir = os.environ.get("APPDATA") or os.environ.get("TEMP")
+        bdir = os.environ.get("APPDATA") or os.environ.get("TEMP") or "."
         E.cfg = os.path.normpath(bdir + "/copyparty")
     elif sys.platform == "darwin":
         E.cfg = os.path.expanduser("~/Library/Preferences/copyparty")
     else:
         E.cfg = get_unixdir()
 
     E.cfg = E.cfg.replace("\\", "/")
@@ -775,14 +775,15 @@
 
 def add_webdav(ap):
     ap2 = ap.add_argument_group('WebDAV options')
     ap2.add_argument("--daw", action="store_true", help="enable full write support, even if client may not be webdav. \033[1;31mWARNING:\033[0m This has side-effects -- PUT-operations will now \033[1;31mOVERWRITE\033[0m existing files, rather than inventing new filenames to avoid loss of data. You might want to instead set this as a volflag where needed. By not setting this flag, uploaded files can get written to a filename which the client does not expect (which might be okay, depending on client)")
     ap2.add_argument("--dav-inf", action="store_true", help="allow depth:infinite requests (recursive file listing); extremely server-heavy but required for spec compliance -- luckily few clients rely on this")
     ap2.add_argument("--dav-mac", action="store_true", help="disable apple-garbage filter -- allow macos to create junk files (._* and .DS_Store, .Spotlight-*, .fseventsd, .Trashes, .AppleDouble, __MACOS)")
     ap2.add_argument("--dav-rt", action="store_true", help="show symlink-destination's lastmodified instead of the link itself; always enabled for recursive listings (volflag=davrt)")
+    ap2.add_argument("--dav-auth", action="store_true", help="force auth for all folders (required by davfs2 when only some folders are world-readable) (volflag=davauth)")
 
 
 def add_smb(ap):
     ap2 = ap.add_argument_group('SMB/CIFS options')
     ap2.add_argument("--smb", action="store_true", help="enable smb (read-only) -- this requires running copyparty as root on linux and macos unless --smb-port is set above 1024 and your OS does port-forwarding from 445 to that.\n\033[1;31mWARNING:\033[0m this protocol is dangerous! Never expose to the internet. Account permissions are coalesced; if one account has write-access to a volume, then all accounts do.")
     ap2.add_argument("--smbw", action="store_true", help="enable write support (please dont)")
     ap2.add_argument("--smb1", action="store_true", help="disable SMBv2, only enable SMBv1 (CIFS)")
```

### Comparing `copyparty-1.7.0/copyparty/authsrv.py` & `copyparty-1.7.1/copyparty/authsrv.py`

 * *Files 1% similar despite different names*

```diff
@@ -1167,14 +1167,22 @@
                 c=1,
             )
             raise Exception("invalid config")
 
         if LEELOO_DALLAS in all_users:
             raise Exception("sorry, reserved username: " + LEELOO_DALLAS)
 
+        seenpwds = {}
+        for usr, pwd in acct.items():
+            if pwd in seenpwds:
+                t = "accounts [{}] and [{}] have the same password; this is not supported"
+                self.log(t.format(seenpwds[pwd], usr), 1)
+                raise Exception("invalid config")
+            seenpwds[pwd] = usr
+
         promote = []
         demote = []
         for vol in vfs.all_vols.values():
             zb = hashlib.sha512(afsenc(vol.realpath)).digest()
             hid = base64.b32encode(zb).decode("ascii").lower()
             vflag = vol.flags.get("hist")
             if vflag == "-":
```

### Comparing `copyparty-1.7.0/copyparty/bos/bos.py` & `copyparty-1.7.1/copyparty/bos/bos.py`

 * *Files identical despite different names*

### Comparing `copyparty-1.7.0/copyparty/bos/path.py` & `copyparty-1.7.1/copyparty/bos/path.py`

 * *Files identical despite different names*

### Comparing `copyparty-1.7.0/copyparty/broker_mp.py` & `copyparty-1.7.1/copyparty/broker_mp.py`

 * *Files identical despite different names*

### Comparing `copyparty-1.7.0/copyparty/broker_mpw.py` & `copyparty-1.7.1/copyparty/broker_mpw.py`

 * *Files identical despite different names*

### Comparing `copyparty-1.7.0/copyparty/broker_thr.py` & `copyparty-1.7.1/copyparty/broker_thr.py`

 * *Files identical despite different names*

### Comparing `copyparty-1.7.0/copyparty/broker_util.py` & `copyparty-1.7.1/copyparty/broker_util.py`

 * *Files identical despite different names*

### Comparing `copyparty-1.7.0/copyparty/cfg.py` & `copyparty-1.7.1/copyparty/cfg.py`

 * *Files 2% similar despite different names*

```diff
@@ -9,14 +9,15 @@
 def vf_bmap()   :
     """argv-to-volflag: simple bools"""
     ret = {
         "never_symlink": "neversymlink",
         "no_dedup": "copydupes",
         "no_dupe": "nodupe",
         "no_forget": "noforget",
+        "dav_auth": "davauth",
         "dav_rt": "davrt",
     }
     for k in (
         "dotsrch",
         "e2t",
         "e2ts",
         "e2tsr",
@@ -140,13 +141,14 @@
         "sb_md": "enable js sandbox for markdown files (default)",
         "sb_lg": "enable js sandbox for prologue/epilogue (default)",
         "md_sbf": "list of markdown-sandbox safeguards to disable",
         "lg_sbf": "list of *logue-sandbox safeguards to disable",
     },
     "others": {
         "fk=8": 'generates per-file accesskeys,\nwhich will then be required at the "g" permission',
+        "davauth": "ask webdav clients to login for all folders",
         "davrt": "show lastmod time of symlink destination, not the link itself\n(note: this option is always enabled for recursive listings)",
     },
 }
 
 
 flagdescs = {k.split("=")[0]: v for tab in flagcats.values() for k, v in tab.items()}
```

### Comparing `copyparty-1.7.0/copyparty/dxml.py` & `copyparty-1.7.1/copyparty/dxml.py`

 * *Files identical despite different names*

### Comparing `copyparty-1.7.0/copyparty/fsutil.py` & `copyparty-1.7.1/copyparty/fsutil.py`

 * *Files identical despite different names*

### Comparing `copyparty-1.7.0/copyparty/ftpd.py` & `copyparty-1.7.1/copyparty/ftpd.py`

 * *Files 0% similar despite different names*

```diff
@@ -85,15 +85,15 @@
                 bonk, ip = g.bonk(ip, handler.username)
                 if bonk:
                     logging.warning("client banned: invalid passwords")
                     bans[ip] = bonk
 
             raise AuthenticationFailed("Authentication failed.")
 
-        handler.uname = uname
+        handler.uname = handler.username = uname
 
     def get_home_dir(self, username )  :
         return "/"
 
     def has_user(self, username )  :
         asrv = self.hub.asrv
         return username in asrv.acct or username in asrv.iacct
```

### Comparing `copyparty-1.7.0/copyparty/httpcli.py` & `copyparty-1.7.1/copyparty/httpcli.py`

 * *Files 1% similar despite different names*

```diff
@@ -592,7059 +592,7075 @@
 000024f0: 7428 2226 2229 3a0a 2020 2020 2020 2020  t("&"):.        
 00002500: 2020 2020 2020 2020 6966 2022 3d22 2069          if "=" i
 00002510: 6e20 6b3a 0a20 2020 2020 2020 2020 2020  n k:.           
 00002520: 2020 2020 2020 2020 206b 2c20 7a73 203d           k, zs =
 00002530: 206b 2e73 706c 6974 2822 3d22 2c20 3129   k.split("=", 1)
 00002540: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
 00002550: 2020 2020 2075 7061 7261 6d5b 6b2e 6c6f       uparam[k.lo
-00002560: 7765 7228 295d 203d 207a 732e 7374 7269  wer()] = zs.stri
-00002570: 7028 290a 2020 2020 2020 2020 2020 2020  p().            
-00002580: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-00002590: 2020 2020 2020 2020 2020 2020 2020 7570                up
-000025a0: 6172 616d 5b6b 2e6c 6f77 6572 2829 5d20  aram[k.lower()] 
-000025b0: 3d20 2222 0a0a 2020 2020 2020 2020 6966  = ""..        if
-000025c0: 2073 656c 662e 6973 5f76 7072 6f78 6965   self.is_vproxie
-000025d0: 643a 0a20 2020 2020 2020 2020 2020 2069  d:.            i
-000025e0: 6620 7670 6174 682e 7374 6172 7473 7769  f vpath.startswi
-000025f0: 7468 2873 656c 662e 6172 6773 2e52 293a  th(self.args.R):
-00002600: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00002610: 2076 7061 7468 203d 2076 7061 7468 5b6c   vpath = vpath[l
-00002620: 656e 2873 656c 662e 6172 6773 2e52 2920  en(self.args.R) 
-00002630: 2b20 3120 3a5d 0a20 2020 2020 2020 2020  + 1 :].         
-00002640: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-00002650: 2020 2020 2020 2020 2074 203d 2022 696e           t = "in
-00002660: 636f 7272 6563 7420 2d2d 7270 2d6c 6f63  correct --rp-loc
-00002670: 206f 7220 7765 6273 6572 7665 7220 636f   or webserver co
-00002680: 6e66 6967 3b20 6578 7065 6374 6564 2076  nfig; expected v
-00002690: 7061 7468 2073 7461 7274 696e 6720 7769  path starting wi
-000026a0: 7468 205b 7b7d 5d20 6275 7420 676f 7420  th [{}] but got 
-000026b0: 5b7b 7d5d 220a 2020 2020 2020 2020 2020  [{}]".          
-000026c0: 2020 2020 2020 7365 6c66 2e6c 6f67 2874        self.log(t
-000026d0: 2e66 6f72 6d61 7428 7365 6c66 2e61 7267  .format(self.arg
-000026e0: 732e 522c 2076 7061 7468 292c 2031 290a  s.R, vpath), 1).
-000026f0: 0a20 2020 2020 2020 2073 656c 662e 6f75  .        self.ou
-00002700: 7061 7261 6d20 3d20 7b6b 3a20 7a73 2066  param = {k: zs f
-00002710: 6f72 206b 2c20 7a73 2069 6e20 7570 6172  or k, zs in upar
-00002720: 616d 2e69 7465 6d73 2829 7d0a 0a20 2020  am.items()}..   
-00002730: 2020 2020 2069 6620 7365 6c66 2e61 7267       if self.arg
-00002740: 732e 7273 705f 736c 703a 0a20 2020 2020  s.rsp_slp:.     
-00002750: 2020 2020 2020 2074 696d 652e 736c 6565         time.slee
-00002760: 7028 7365 6c66 2e61 7267 732e 7273 705f  p(self.args.rsp_
-00002770: 736c 7029 0a20 2020 2020 2020 2020 2020  slp).           
-00002780: 2069 6620 7365 6c66 2e61 7267 732e 7273   if self.args.rs
-00002790: 705f 6a74 723a 0a20 2020 2020 2020 2020  p_jtr:.         
-000027a0: 2020 2020 2020 2074 696d 652e 736c 6565         time.slee
-000027b0: 7028 7261 6e64 6f6d 2e72 616e 646f 6d28  p(random.random(
-000027c0: 2920 2a20 7365 6c66 2e61 7267 732e 7273  ) * self.args.rs
-000027d0: 705f 6a74 7229 0a0a 2020 2020 2020 2020  p_jtr)..        
-000027e0: 7a73 6f20 3d20 7365 6c66 2e68 6561 6465  zso = self.heade
-000027f0: 7273 2e67 6574 2822 636f 6f6b 6965 2229  rs.get("cookie")
-00002800: 0a20 2020 2020 2020 2069 6620 7a73 6f3a  .        if zso:
-00002810: 0a20 2020 2020 2020 2020 2020 207a 736c  .            zsl
-00002820: 6c20 3d20 5b78 2e73 706c 6974 2822 3d22  l = [x.split("="
-00002830: 2c20 3129 2066 6f72 2078 2069 6e20 7a73  , 1) for x in zs
-00002840: 6f2e 7370 6c69 7428 223b 2229 2069 6620  o.split(";") if 
-00002850: 223d 2220 696e 2078 5d0a 2020 2020 2020  "=" in x].      
-00002860: 2020 2020 2020 636f 6f6b 6965 7320 3d20        cookies = 
-00002870: 7b6b 2e73 7472 6970 2829 3a20 756e 6573  {k.strip(): unes
-00002880: 6361 7065 5f63 6f6f 6b69 6528 7a73 2920  cape_cookie(zs) 
-00002890: 666f 7220 6b2c 207a 7320 696e 207a 736c  for k, zs in zsl
-000028a0: 6c7d 0a20 2020 2020 2020 2020 2020 2063  l}.            c
-000028b0: 6f6f 6b69 655f 7077 203d 2063 6f6f 6b69  ookie_pw = cooki
-000028c0: 6573 2e67 6574 2822 6370 7077 7322 2920  es.get("cppws") 
-000028d0: 6f72 2063 6f6f 6b69 6573 2e67 6574 2822  or cookies.get("
-000028e0: 6370 7077 6422 2920 6f72 2022 220a 2020  cppwd") or "".  
-000028f0: 2020 2020 2020 2020 2020 6966 2022 6222            if "b"
-00002900: 2069 6e20 636f 6f6b 6965 7320 616e 6420   in cookies and 
-00002910: 2262 2220 6e6f 7420 696e 2075 7061 7261  "b" not in upara
-00002920: 6d3a 0a20 2020 2020 2020 2020 2020 2020  m:.             
-00002930: 2020 2075 7061 7261 6d5b 2262 225d 203d     uparam["b"] =
-00002940: 2063 6f6f 6b69 6573 5b22 6222 5d0a 2020   cookies["b"].  
-00002950: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-00002960: 2020 2020 2020 2020 636f 6f6b 6965 7320          cookies 
-00002970: 3d20 7b7d 0a20 2020 2020 2020 2020 2020  = {}.           
-00002980: 2063 6f6f 6b69 655f 7077 203d 2022 220a   cookie_pw = "".
-00002990: 0a20 2020 2020 2020 2069 6620 6c65 6e28  .        if len(
-000029a0: 7570 6172 616d 2920 3e20 3130 206f 7220  uparam) > 10 or 
-000029b0: 6c65 6e28 636f 6f6b 6965 7329 203e 2035  len(cookies) > 5
-000029c0: 303a 0a20 2020 2020 2020 2020 2020 2072  0:.            r
-000029d0: 6169 7365 2050 6562 6b61 6328 3430 302c  aise Pebkac(400,
-000029e0: 2022 7520 776f 7420 6d38 2229 0a0a 2020   "u wot m8")..  
-000029f0: 2020 2020 2020 7365 6c66 2e75 7061 7261        self.upara
-00002a00: 6d20 3d20 7570 6172 616d 0a20 2020 2020  m = uparam.     
-00002a10: 2020 2073 656c 662e 636f 6f6b 6965 7320     self.cookies 
-00002a20: 3d20 636f 6f6b 6965 730a 2020 2020 2020  = cookies.      
-00002a30: 2020 7365 6c66 2e76 7061 7468 203d 2075    self.vpath = u
-00002a40: 6e71 756f 7465 7028 7670 6174 6829 2020  nquotep(vpath)  
-00002a50: 2320 6e6f 7420 7175 6572 792c 2073 6f20  # not query, so 
-00002a60: 2b20 6d65 616e 7320 2b0a 0a20 2020 2020  + means +..     
-00002a70: 2020 206f 6b20 3d20 225c 7830 3022 206e     ok = "\x00" n
-00002a80: 6f74 2069 6e20 7365 6c66 2e76 7061 7468  ot in self.vpath
-00002a90: 0a20 2020 2020 2020 2069 6620 414e 5957  .        if ANYW
-00002aa0: 494e 3a0a 2020 2020 2020 2020 2020 2020  IN:.            
-00002ab0: 6f6b 203d 206f 6b20 616e 6420 6e6f 7420  ok = ok and not 
-00002ac0: 7265 6c63 686b 2873 656c 662e 7670 6174  relchk(self.vpat
-00002ad0: 6829 0a0a 2020 2020 2020 2020 6966 206e  h)..        if n
-00002ae0: 6f74 206f 6b20 616e 6420 2873 656c 662e  ot ok and (self.
-00002af0: 7670 6174 6820 213d 2022 2a22 206f 7220  vpath != "*" or 
-00002b00: 7365 6c66 2e6d 6f64 6520 213d 2022 4f50  self.mode != "OP
-00002b10: 5449 4f4e 5322 293a 0a20 2020 2020 2020  TIONS"):.       
-00002b20: 2020 2020 2073 656c 662e 6c6f 6728 2269       self.log("i
-00002b30: 6e76 616c 6964 2072 656c 7061 7468 205b  nvalid relpath [
-00002b40: 7b7d 5d22 2e66 6f72 6d61 7428 7365 6c66  {}]".format(self
-00002b50: 2e76 7061 7468 2929 0a20 2020 2020 2020  .vpath)).       
-00002b60: 2020 2020 2072 6574 7572 6e20 7365 6c66       return self
-00002b70: 2e74 785f 3430 3428 2920 616e 6420 7365  .tx_404() and se
-00002b80: 6c66 2e6b 6565 7061 6c69 7665 0a0a 2020  lf.keepalive..  
-00002b90: 2020 2020 2020 7a73 6f20 3d20 7365 6c66        zso = self
-00002ba0: 2e68 6561 6465 7273 2e67 6574 2822 6175  .headers.get("au
-00002bb0: 7468 6f72 697a 6174 696f 6e22 290a 2020  thorization").  
-00002bc0: 2020 2020 2020 6261 7574 6820 3d20 2222        bauth = ""
-00002bd0: 0a20 2020 2020 2020 2069 6620 7a73 6f3a  .        if zso:
-00002be0: 0a20 2020 2020 2020 2020 2020 2074 7279  .            try
-00002bf0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00002c00: 2020 7a62 203d 207a 736f 2e73 706c 6974    zb = zso.split
-00002c10: 2822 2022 295b 315d 2e65 6e63 6f64 6528  (" ")[1].encode(
-00002c20: 2261 7363 6969 2229 0a20 2020 2020 2020  "ascii").       
-00002c30: 2020 2020 2020 2020 207a 7320 3d20 6261           zs = ba
-00002c40: 7365 3634 2e62 3634 6465 636f 6465 287a  se64.b64decode(z
-00002c50: 6229 2e64 6563 6f64 6528 2275 7466 2d38  b).decode("utf-8
-00002c60: 2229 0a20 2020 2020 2020 2020 2020 2020  ").             
-00002c70: 2020 2023 2074 7279 2022 7077 6422 2c20     # try "pwd", 
-00002c80: 2278 3a70 7764 222c 2022 7077 643a 7822  "x:pwd", "pwd:x"
-00002c90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00002ca0: 2066 6f72 2062 6175 7468 2069 6e20 5b7a   for bauth in [z
-00002cb0: 735d 202b 207a 732e 7370 6c69 7428 223a  s] + zs.split(":
-00002cc0: 222c 2031 295b 3a3a 2d31 5d3a 0a20 2020  ", 1)[::-1]:.   
-00002cd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002ce0: 2069 6620 7365 6c66 2e61 7372 762e 6961   if self.asrv.ia
-00002cf0: 6363 742e 6765 7428 6261 7574 6829 3a0a  cct.get(bauth):.
-00002d00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002d10: 2020 2020 2020 2020 6272 6561 6b0a 2020          break.  
-00002d20: 2020 2020 2020 2020 2020 6578 6365 7074            except
-00002d30: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00002d40: 2020 7061 7373 0a0a 2020 2020 2020 2020    pass..        
-00002d50: 7365 6c66 2e70 7720 3d20 7570 6172 616d  self.pw = uparam
-00002d60: 2e67 6574 2822 7077 2229 206f 7220 7365  .get("pw") or se
-00002d70: 6c66 2e68 6561 6465 7273 2e67 6574 2822  lf.headers.get("
-00002d80: 7077 2229 206f 7220 6261 7574 6820 6f72  pw") or bauth or
-00002d90: 2063 6f6f 6b69 655f 7077 0a20 2020 2020   cookie_pw.     
-00002da0: 2020 2073 656c 662e 756e 616d 6520 3d20     self.uname = 
-00002db0: 7365 6c66 2e61 7372 762e 6961 6363 742e  self.asrv.iacct.
-00002dc0: 6765 7428 7365 6c66 2e70 7729 206f 7220  get(self.pw) or 
-00002dd0: 222a 220a 2020 2020 2020 2020 7365 6c66  "*".        self
-00002de0: 2e72 766f 6c20 3d20 7365 6c66 2e61 7372  .rvol = self.asr
-00002df0: 762e 7666 732e 6172 6561 645b 7365 6c66  v.vfs.aread[self
-00002e00: 2e75 6e61 6d65 5d0a 2020 2020 2020 2020  .uname].        
-00002e10: 7365 6c66 2e77 766f 6c20 3d20 7365 6c66  self.wvol = self
-00002e20: 2e61 7372 762e 7666 732e 6177 7269 7465  .asrv.vfs.awrite
-00002e30: 5b73 656c 662e 756e 616d 655d 0a20 2020  [self.uname].   
-00002e40: 2020 2020 2073 656c 662e 6d76 6f6c 203d       self.mvol =
-00002e50: 2073 656c 662e 6173 7276 2e76 6673 2e61   self.asrv.vfs.a
-00002e60: 6d6f 7665 5b73 656c 662e 756e 616d 655d  move[self.uname]
-00002e70: 0a20 2020 2020 2020 2073 656c 662e 6476  .        self.dv
-00002e80: 6f6c 203d 2073 656c 662e 6173 7276 2e76  ol = self.asrv.v
-00002e90: 6673 2e61 6465 6c5b 7365 6c66 2e75 6e61  fs.adel[self.una
-00002ea0: 6d65 5d0a 2020 2020 2020 2020 7365 6c66  me].        self
-00002eb0: 2e67 766f 6c20 3d20 7365 6c66 2e61 7372  .gvol = self.asr
-00002ec0: 762e 7666 732e 6167 6574 5b73 656c 662e  v.vfs.aget[self.
-00002ed0: 756e 616d 655d 0a20 2020 2020 2020 2073  uname].        s
-00002ee0: 656c 662e 7570 766f 6c20 3d20 7365 6c66  elf.upvol = self
-00002ef0: 2e61 7372 762e 7666 732e 6170 6765 745b  .asrv.vfs.apget[
-00002f00: 7365 6c66 2e75 6e61 6d65 5d0a 0a20 2020  self.uname]..   
-00002f10: 2020 2020 2069 6620 7365 6c66 2e70 7720       if self.pw 
-00002f20: 616e 6420 280a 2020 2020 2020 2020 2020  and (.          
-00002f30: 2020 7365 6c66 2e70 7720 213d 2063 6f6f    self.pw != coo
-00002f40: 6b69 655f 7077 206f 7220 7365 6c66 2e63  kie_pw or self.c
-00002f50: 6f6e 6e2e 6672 6573 6865 6e5f 7077 6420  onn.freshen_pwd 
-00002f60: 2b20 3330 203c 2074 696d 652e 7469 6d65  + 30 < time.time
-00002f70: 2829 0a20 2020 2020 2020 2029 3a0a 2020  ().        ):.  
-00002f80: 2020 2020 2020 2020 2020 7365 6c66 2e63            self.c
-00002f90: 6f6e 6e2e 6672 6573 6865 6e5f 7077 6420  onn.freshen_pwd 
-00002fa0: 3d20 7469 6d65 2e74 696d 6528 290a 2020  = time.time().  
-00002fb0: 2020 2020 2020 2020 2020 7365 6c66 2e67            self.g
-00002fc0: 6574 5f70 7764 5f63 6f6f 6b69 6528 7365  et_pwd_cookie(se
-00002fd0: 6c66 2e70 7729 0a0a 2020 2020 2020 2020  lf.pw)..        
-00002fe0: 6966 2073 656c 662e 6973 5f72 636c 6f6e  if self.is_rclon
-00002ff0: 653a 0a20 2020 2020 2020 2020 2020 2023  e:.            #
-00003000: 2064 6f74 733a 2061 6c77 6179 7320 696e   dots: always in
-00003010: 636c 7564 6520 646f 7466 696c 6573 2069  clude dotfiles i
-00003020: 6620 7065 726d 6974 7465 640a 2020 2020  f permitted.    
-00003030: 2020 2020 2020 2020 2320 6c74 3a20 7072          # lt: pr
-00003040: 6f62 6162 6c79 206d 6f72 6520 696d 706f  obably more impo
-00003050: 7274 616e 7420 7368 6f77 696e 6720 7468  rtant showing th
-00003060: 6520 636f 7272 6563 7420 7469 6d65 7374  e correct timest
-00003070: 616d 7073 206f 6620 616e 7920 6475 7065  amps of any dupe
-00003080: 7320 6974 206a 7573 7420 7570 6c6f 6164  s it just upload
-00003090: 6564 2072 6174 6865 7220 7468 616e 2074  ed rather than t
-000030a0: 6865 206c 6173 746d 6f64 2074 696d 6520  he lastmod time 
-000030b0: 6f66 2061 6e79 206e 6f6e 2d63 6f70 7970  of any non-copyp
-000030c0: 6172 7479 2d6d 616e 6167 6564 2073 796d  arty-managed sym
-000030d0: 6c69 6e6b 730a 2020 2020 2020 2020 2020  links.          
-000030e0: 2020 2320 623a 2062 6173 6963 2d62 726f    # b: basic-bro
-000030f0: 7773 6572 2069 6620 6974 2074 7269 6573  wser if it tries
-00003100: 2074 6f20 7061 7273 6520 7468 6520 6874   to parse the ht
-00003110: 6d6c 206c 6973 7469 6e67 0a20 2020 2020  ml listing.     
-00003120: 2020 2020 2020 2075 7061 7261 6d5b 2264         uparam["d
-00003130: 6f74 7322 5d20 3d20 2222 0a20 2020 2020  ots"] = "".     
-00003140: 2020 2020 2020 2075 7061 7261 6d5b 226c         uparam["l
-00003150: 7422 5d20 3d20 2222 0a20 2020 2020 2020  t"] = "".       
-00003160: 2020 2020 2075 7061 7261 6d5b 2262 225d       uparam["b"]
-00003170: 203d 2022 220a 2020 2020 2020 2020 2020   = "".          
-00003180: 2020 636f 6f6b 6965 735b 2262 225d 203d    cookies["b"] =
-00003190: 2022 220a 0a20 2020 2020 2020 2076 6e2c   ""..        vn,
-000031a0: 2072 656d 203d 2073 656c 662e 6173 7276   rem = self.asrv
-000031b0: 2e76 6673 2e67 6574 2873 656c 662e 7670  .vfs.get(self.vp
-000031c0: 6174 682c 2073 656c 662e 756e 616d 652c  ath, self.uname,
-000031d0: 2046 616c 7365 2c20 4661 6c73 6529 0a20   False, False). 
-000031e0: 2020 2020 2020 2069 6620 2278 6465 7622         if "xdev"
-000031f0: 2069 6e20 766e 2e66 6c61 6773 206f 7220   in vn.flags or 
-00003200: 2278 766f 6c22 2069 6e20 766e 2e66 6c61  "xvol" in vn.fla
-00003210: 6773 3a0a 2020 2020 2020 2020 2020 2020  gs:.            
-00003220: 6170 203d 2076 6e2e 6361 6e6f 6e69 6361  ap = vn.canonica
-00003230: 6c28 7265 6d29 0a20 2020 2020 2020 2020  l(rem).         
-00003240: 2020 2061 766e 203d 2076 6e2e 6368 6b5f     avn = vn.chk_
-00003250: 6170 2861 7029 0a20 2020 2020 2020 2065  ap(ap).        e
-00003260: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-00003270: 2061 766e 203d 2076 6e0a 0a20 2020 2020   avn = vn..     
-00003280: 2020 2028 0a20 2020 2020 2020 2020 2020     (.           
-00003290: 2073 656c 662e 6361 6e5f 7265 6164 2c0a   self.can_read,.
-000032a0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-000032b0: 2e63 616e 5f77 7269 7465 2c0a 2020 2020  .can_write,.    
+00002560: 7765 7228 295d 203d 2075 6e71 756f 7465  wer()] = unquote
+00002570: 7028 7a73 2e73 7472 6970 2829 2e72 6570  p(zs.strip().rep
+00002580: 6c61 6365 2822 2b22 2c20 2220 2229 290a  lace("+", " ")).
+00002590: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000025a0: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+000025b0: 2020 2020 2020 2020 2020 7570 6172 616d            uparam
+000025c0: 5b6b 2e6c 6f77 6572 2829 5d20 3d20 2222  [k.lower()] = ""
+000025d0: 0a0a 2020 2020 2020 2020 6966 2073 656c  ..        if sel
+000025e0: 662e 6973 5f76 7072 6f78 6965 643a 0a20  f.is_vproxied:. 
+000025f0: 2020 2020 2020 2020 2020 2069 6620 7670             if vp
+00002600: 6174 682e 7374 6172 7473 7769 7468 2873  ath.startswith(s
+00002610: 656c 662e 6172 6773 2e52 293a 0a20 2020  elf.args.R):.   
+00002620: 2020 2020 2020 2020 2020 2020 2076 7061               vpa
+00002630: 7468 203d 2076 7061 7468 5b6c 656e 2873  th = vpath[len(s
+00002640: 656c 662e 6172 6773 2e52 2920 2b20 3120  elf.args.R) + 1 
+00002650: 3a5d 0a20 2020 2020 2020 2020 2020 2065  :].            e
+00002660: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+00002670: 2020 2020 2074 203d 2022 696e 636f 7272       t = "incorr
+00002680: 6563 7420 2d2d 7270 2d6c 6f63 206f 7220  ect --rp-loc or 
+00002690: 7765 6273 6572 7665 7220 636f 6e66 6967  webserver config
+000026a0: 3b20 6578 7065 6374 6564 2076 7061 7468  ; expected vpath
+000026b0: 2073 7461 7274 696e 6720 7769 7468 205b   starting with [
+000026c0: 7b7d 5d20 6275 7420 676f 7420 5b7b 7d5d  {}] but got [{}]
+000026d0: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
+000026e0: 2020 7365 6c66 2e6c 6f67 2874 2e66 6f72    self.log(t.for
+000026f0: 6d61 7428 7365 6c66 2e61 7267 732e 522c  mat(self.args.R,
+00002700: 2076 7061 7468 292c 2031 290a 0a20 2020   vpath), 1)..   
+00002710: 2020 2020 2073 656c 662e 6f75 7061 7261       self.oupara
+00002720: 6d20 3d20 7b6b 3a20 7a73 2066 6f72 206b  m = {k: zs for k
+00002730: 2c20 7a73 2069 6e20 7570 6172 616d 2e69  , zs in uparam.i
+00002740: 7465 6d73 2829 7d0a 0a20 2020 2020 2020  tems()}..       
+00002750: 2069 6620 7365 6c66 2e61 7267 732e 7273   if self.args.rs
+00002760: 705f 736c 703a 0a20 2020 2020 2020 2020  p_slp:.         
+00002770: 2020 2074 696d 652e 736c 6565 7028 7365     time.sleep(se
+00002780: 6c66 2e61 7267 732e 7273 705f 736c 7029  lf.args.rsp_slp)
+00002790: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+000027a0: 7365 6c66 2e61 7267 732e 7273 705f 6a74  self.args.rsp_jt
+000027b0: 723a 0a20 2020 2020 2020 2020 2020 2020  r:.             
+000027c0: 2020 2074 696d 652e 736c 6565 7028 7261     time.sleep(ra
+000027d0: 6e64 6f6d 2e72 616e 646f 6d28 2920 2a20  ndom.random() * 
+000027e0: 7365 6c66 2e61 7267 732e 7273 705f 6a74  self.args.rsp_jt
+000027f0: 7229 0a0a 2020 2020 2020 2020 7a73 6f20  r)..        zso 
+00002800: 3d20 7365 6c66 2e68 6561 6465 7273 2e67  = self.headers.g
+00002810: 6574 2822 636f 6f6b 6965 2229 0a20 2020  et("cookie").   
+00002820: 2020 2020 2069 6620 7a73 6f3a 0a20 2020       if zso:.   
+00002830: 2020 2020 2020 2020 207a 736c 6c20 3d20           zsll = 
+00002840: 5b78 2e73 706c 6974 2822 3d22 2c20 3129  [x.split("=", 1)
+00002850: 2066 6f72 2078 2069 6e20 7a73 6f2e 7370   for x in zso.sp
+00002860: 6c69 7428 223b 2229 2069 6620 223d 2220  lit(";") if "=" 
+00002870: 696e 2078 5d0a 2020 2020 2020 2020 2020  in x].          
+00002880: 2020 636f 6f6b 6965 7320 3d20 7b6b 2e73    cookies = {k.s
+00002890: 7472 6970 2829 3a20 756e 6573 6361 7065  trip(): unescape
+000028a0: 5f63 6f6f 6b69 6528 7a73 2920 666f 7220  _cookie(zs) for 
+000028b0: 6b2c 207a 7320 696e 207a 736c 6c7d 0a20  k, zs in zsll}. 
+000028c0: 2020 2020 2020 2020 2020 2063 6f6f 6b69             cooki
+000028d0: 655f 7077 203d 2063 6f6f 6b69 6573 2e67  e_pw = cookies.g
+000028e0: 6574 2822 6370 7077 7322 2920 6f72 2063  et("cppws") or c
+000028f0: 6f6f 6b69 6573 2e67 6574 2822 6370 7077  ookies.get("cppw
+00002900: 6422 2920 6f72 2022 220a 2020 2020 2020  d") or "".      
+00002910: 2020 2020 2020 6966 2022 6222 2069 6e20        if "b" in 
+00002920: 636f 6f6b 6965 7320 616e 6420 2262 2220  cookies and "b" 
+00002930: 6e6f 7420 696e 2075 7061 7261 6d3a 0a20  not in uparam:. 
+00002940: 2020 2020 2020 2020 2020 2020 2020 2075                 u
+00002950: 7061 7261 6d5b 2262 225d 203d 2063 6f6f  param["b"] = coo
+00002960: 6b69 6573 5b22 6222 5d0a 2020 2020 2020  kies["b"].      
+00002970: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+00002980: 2020 2020 636f 6f6b 6965 7320 3d20 7b7d      cookies = {}
+00002990: 0a20 2020 2020 2020 2020 2020 2063 6f6f  .            coo
+000029a0: 6b69 655f 7077 203d 2022 220a 0a20 2020  kie_pw = ""..   
+000029b0: 2020 2020 2069 6620 6c65 6e28 7570 6172       if len(upar
+000029c0: 616d 2920 3e20 3130 206f 7220 6c65 6e28  am) > 10 or len(
+000029d0: 636f 6f6b 6965 7329 203e 2035 303a 0a20  cookies) > 50:. 
+000029e0: 2020 2020 2020 2020 2020 2072 6169 7365             raise
+000029f0: 2050 6562 6b61 6328 3430 302c 2022 7520   Pebkac(400, "u 
+00002a00: 776f 7420 6d38 2229 0a0a 2020 2020 2020  wot m8")..      
+00002a10: 2020 7365 6c66 2e75 7061 7261 6d20 3d20    self.uparam = 
+00002a20: 7570 6172 616d 0a20 2020 2020 2020 2073  uparam.        s
+00002a30: 656c 662e 636f 6f6b 6965 7320 3d20 636f  elf.cookies = co
+00002a40: 6f6b 6965 730a 2020 2020 2020 2020 7365  okies.        se
+00002a50: 6c66 2e76 7061 7468 203d 2075 6e71 756f  lf.vpath = unquo
+00002a60: 7465 7028 7670 6174 6829 2020 2320 6e6f  tep(vpath)  # no
+00002a70: 7420 7175 6572 792c 2073 6f20 2b20 6d65  t query, so + me
+00002a80: 616e 7320 2b0a 0a20 2020 2020 2020 206f  ans +..        o
+00002a90: 6b20 3d20 225c 7830 3022 206e 6f74 2069  k = "\x00" not i
+00002aa0: 6e20 7365 6c66 2e76 7061 7468 0a20 2020  n self.vpath.   
+00002ab0: 2020 2020 2069 6620 414e 5957 494e 3a0a       if ANYWIN:.
+00002ac0: 2020 2020 2020 2020 2020 2020 6f6b 203d              ok =
+00002ad0: 206f 6b20 616e 6420 6e6f 7420 7265 6c63   ok and not relc
+00002ae0: 686b 2873 656c 662e 7670 6174 6829 0a0a  hk(self.vpath)..
+00002af0: 2020 2020 2020 2020 6966 206e 6f74 206f          if not o
+00002b00: 6b20 616e 6420 2873 656c 662e 7670 6174  k and (self.vpat
+00002b10: 6820 213d 2022 2a22 206f 7220 7365 6c66  h != "*" or self
+00002b20: 2e6d 6f64 6520 213d 2022 4f50 5449 4f4e  .mode != "OPTION
+00002b30: 5322 293a 0a20 2020 2020 2020 2020 2020  S"):.           
+00002b40: 2073 656c 662e 6c6f 6728 2269 6e76 616c   self.log("inval
+00002b50: 6964 2072 656c 7061 7468 205b 7b7d 5d22  id relpath [{}]"
+00002b60: 2e66 6f72 6d61 7428 7365 6c66 2e76 7061  .format(self.vpa
+00002b70: 7468 2929 0a20 2020 2020 2020 2020 2020  th)).           
+00002b80: 2072 6574 7572 6e20 7365 6c66 2e74 785f   return self.tx_
+00002b90: 3430 3428 2920 616e 6420 7365 6c66 2e6b  404() and self.k
+00002ba0: 6565 7061 6c69 7665 0a0a 2020 2020 2020  eepalive..      
+00002bb0: 2020 7a73 6f20 3d20 7365 6c66 2e68 6561    zso = self.hea
+00002bc0: 6465 7273 2e67 6574 2822 6175 7468 6f72  ders.get("author
+00002bd0: 697a 6174 696f 6e22 290a 2020 2020 2020  ization").      
+00002be0: 2020 6261 7574 6820 3d20 2222 0a20 2020    bauth = "".   
+00002bf0: 2020 2020 2069 6620 7a73 6f3a 0a20 2020       if zso:.   
+00002c00: 2020 2020 2020 2020 2074 7279 3a0a 2020           try:.  
+00002c10: 2020 2020 2020 2020 2020 2020 2020 7a62                zb
+00002c20: 203d 207a 736f 2e73 706c 6974 2822 2022   = zso.split(" "
+00002c30: 295b 315d 2e65 6e63 6f64 6528 2261 7363  )[1].encode("asc
+00002c40: 6969 2229 0a20 2020 2020 2020 2020 2020  ii").           
+00002c50: 2020 2020 207a 7320 3d20 6261 7365 3634       zs = base64
+00002c60: 2e62 3634 6465 636f 6465 287a 6229 2e64  .b64decode(zb).d
+00002c70: 6563 6f64 6528 2275 7466 2d38 2229 0a20  ecode("utf-8"). 
+00002c80: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+00002c90: 2074 7279 2022 7077 6422 2c20 2278 3a70   try "pwd", "x:p
+00002ca0: 7764 222c 2022 7077 643a 7822 0a20 2020  wd", "pwd:x".   
+00002cb0: 2020 2020 2020 2020 2020 2020 2066 6f72               for
+00002cc0: 2062 6175 7468 2069 6e20 5b7a 735d 202b   bauth in [zs] +
+00002cd0: 207a 732e 7370 6c69 7428 223a 222c 2031   zs.split(":", 1
+00002ce0: 295b 3a3a 2d31 5d3a 0a20 2020 2020 2020  )[::-1]:.       
+00002cf0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+00002d00: 7365 6c66 2e61 7372 762e 6961 6363 742e  self.asrv.iacct.
+00002d10: 6765 7428 6261 7574 6829 3a0a 2020 2020  get(bauth):.    
+00002d20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002d30: 2020 2020 6272 6561 6b0a 2020 2020 2020      break.      
+00002d40: 2020 2020 2020 6578 6365 7074 3a0a 2020        except:.  
+00002d50: 2020 2020 2020 2020 2020 2020 2020 7061                pa
+00002d60: 7373 0a0a 2020 2020 2020 2020 7365 6c66  ss..        self
+00002d70: 2e70 7720 3d20 7570 6172 616d 2e67 6574  .pw = uparam.get
+00002d80: 2822 7077 2229 206f 7220 7365 6c66 2e68  ("pw") or self.h
+00002d90: 6561 6465 7273 2e67 6574 2822 7077 2229  eaders.get("pw")
+00002da0: 206f 7220 6261 7574 6820 6f72 2063 6f6f   or bauth or coo
+00002db0: 6b69 655f 7077 0a20 2020 2020 2020 2073  kie_pw.        s
+00002dc0: 656c 662e 756e 616d 6520 3d20 7365 6c66  elf.uname = self
+00002dd0: 2e61 7372 762e 6961 6363 742e 6765 7428  .asrv.iacct.get(
+00002de0: 7365 6c66 2e70 7729 206f 7220 222a 220a  self.pw) or "*".
+00002df0: 2020 2020 2020 2020 7365 6c66 2e72 766f          self.rvo
+00002e00: 6c20 3d20 7365 6c66 2e61 7372 762e 7666  l = self.asrv.vf
+00002e10: 732e 6172 6561 645b 7365 6c66 2e75 6e61  s.aread[self.una
+00002e20: 6d65 5d0a 2020 2020 2020 2020 7365 6c66  me].        self
+00002e30: 2e77 766f 6c20 3d20 7365 6c66 2e61 7372  .wvol = self.asr
+00002e40: 762e 7666 732e 6177 7269 7465 5b73 656c  v.vfs.awrite[sel
+00002e50: 662e 756e 616d 655d 0a20 2020 2020 2020  f.uname].       
+00002e60: 2073 656c 662e 6d76 6f6c 203d 2073 656c   self.mvol = sel
+00002e70: 662e 6173 7276 2e76 6673 2e61 6d6f 7665  f.asrv.vfs.amove
+00002e80: 5b73 656c 662e 756e 616d 655d 0a20 2020  [self.uname].   
+00002e90: 2020 2020 2073 656c 662e 6476 6f6c 203d       self.dvol =
+00002ea0: 2073 656c 662e 6173 7276 2e76 6673 2e61   self.asrv.vfs.a
+00002eb0: 6465 6c5b 7365 6c66 2e75 6e61 6d65 5d0a  del[self.uname].
+00002ec0: 2020 2020 2020 2020 7365 6c66 2e67 766f          self.gvo
+00002ed0: 6c20 3d20 7365 6c66 2e61 7372 762e 7666  l = self.asrv.vf
+00002ee0: 732e 6167 6574 5b73 656c 662e 756e 616d  s.aget[self.unam
+00002ef0: 655d 0a20 2020 2020 2020 2073 656c 662e  e].        self.
+00002f00: 7570 766f 6c20 3d20 7365 6c66 2e61 7372  upvol = self.asr
+00002f10: 762e 7666 732e 6170 6765 745b 7365 6c66  v.vfs.apget[self
+00002f20: 2e75 6e61 6d65 5d0a 0a20 2020 2020 2020  .uname]..       
+00002f30: 2069 6620 7365 6c66 2e70 7720 616e 6420   if self.pw and 
+00002f40: 280a 2020 2020 2020 2020 2020 2020 7365  (.            se
+00002f50: 6c66 2e70 7720 213d 2063 6f6f 6b69 655f  lf.pw != cookie_
+00002f60: 7077 206f 7220 7365 6c66 2e63 6f6e 6e2e  pw or self.conn.
+00002f70: 6672 6573 6865 6e5f 7077 6420 2b20 3330  freshen_pwd + 30
+00002f80: 203c 2074 696d 652e 7469 6d65 2829 0a20   < time.time(). 
+00002f90: 2020 2020 2020 2029 3a0a 2020 2020 2020         ):.      
+00002fa0: 2020 2020 2020 7365 6c66 2e63 6f6e 6e2e        self.conn.
+00002fb0: 6672 6573 6865 6e5f 7077 6420 3d20 7469  freshen_pwd = ti
+00002fc0: 6d65 2e74 696d 6528 290a 2020 2020 2020  me.time().      
+00002fd0: 2020 2020 2020 7365 6c66 2e67 6574 5f70        self.get_p
+00002fe0: 7764 5f63 6f6f 6b69 6528 7365 6c66 2e70  wd_cookie(self.p
+00002ff0: 7729 0a0a 2020 2020 2020 2020 6966 2073  w)..        if s
+00003000: 656c 662e 6973 5f72 636c 6f6e 653a 0a20  elf.is_rclone:. 
+00003010: 2020 2020 2020 2020 2020 2023 2064 6f74             # dot
+00003020: 733a 2061 6c77 6179 7320 696e 636c 7564  s: always includ
+00003030: 6520 646f 7466 696c 6573 2069 6620 7065  e dotfiles if pe
+00003040: 726d 6974 7465 640a 2020 2020 2020 2020  rmitted.        
+00003050: 2020 2020 2320 6c74 3a20 7072 6f62 6162      # lt: probab
+00003060: 6c79 206d 6f72 6520 696d 706f 7274 616e  ly more importan
+00003070: 7420 7368 6f77 696e 6720 7468 6520 636f  t showing the co
+00003080: 7272 6563 7420 7469 6d65 7374 616d 7073  rrect timestamps
+00003090: 206f 6620 616e 7920 6475 7065 7320 6974   of any dupes it
+000030a0: 206a 7573 7420 7570 6c6f 6164 6564 2072   just uploaded r
+000030b0: 6174 6865 7220 7468 616e 2074 6865 206c  ather than the l
+000030c0: 6173 746d 6f64 2074 696d 6520 6f66 2061  astmod time of a
+000030d0: 6e79 206e 6f6e 2d63 6f70 7970 6172 7479  ny non-copyparty
+000030e0: 2d6d 616e 6167 6564 2073 796d 6c69 6e6b  -managed symlink
+000030f0: 730a 2020 2020 2020 2020 2020 2020 2320  s.            # 
+00003100: 623a 2062 6173 6963 2d62 726f 7773 6572  b: basic-browser
+00003110: 2069 6620 6974 2074 7269 6573 2074 6f20   if it tries to 
+00003120: 7061 7273 6520 7468 6520 6874 6d6c 206c  parse the html l
+00003130: 6973 7469 6e67 0a20 2020 2020 2020 2020  isting.         
+00003140: 2020 2075 7061 7261 6d5b 2264 6f74 7322     uparam["dots"
+00003150: 5d20 3d20 2222 0a20 2020 2020 2020 2020  ] = "".         
+00003160: 2020 2075 7061 7261 6d5b 226c 7422 5d20     uparam["lt"] 
+00003170: 3d20 2222 0a20 2020 2020 2020 2020 2020  = "".           
+00003180: 2075 7061 7261 6d5b 2262 225d 203d 2022   uparam["b"] = "
+00003190: 220a 2020 2020 2020 2020 2020 2020 636f  ".            co
+000031a0: 6f6b 6965 735b 2262 225d 203d 2022 220a  okies["b"] = "".
+000031b0: 0a20 2020 2020 2020 2076 6e2c 2072 656d  .        vn, rem
+000031c0: 203d 2073 656c 662e 6173 7276 2e76 6673   = self.asrv.vfs
+000031d0: 2e67 6574 2873 656c 662e 7670 6174 682c  .get(self.vpath,
+000031e0: 2073 656c 662e 756e 616d 652c 2046 616c   self.uname, Fal
+000031f0: 7365 2c20 4661 6c73 6529 0a20 2020 2020  se, False).     
+00003200: 2020 2069 6620 2278 6465 7622 2069 6e20     if "xdev" in 
+00003210: 766e 2e66 6c61 6773 206f 7220 2278 766f  vn.flags or "xvo
+00003220: 6c22 2069 6e20 766e 2e66 6c61 6773 3a0a  l" in vn.flags:.
+00003230: 2020 2020 2020 2020 2020 2020 6170 203d              ap =
+00003240: 2076 6e2e 6361 6e6f 6e69 6361 6c28 7265   vn.canonical(re
+00003250: 6d29 0a20 2020 2020 2020 2020 2020 2061  m).            a
+00003260: 766e 203d 2076 6e2e 6368 6b5f 6170 2861  vn = vn.chk_ap(a
+00003270: 7029 0a20 2020 2020 2020 2065 6c73 653a  p).        else:
+00003280: 0a20 2020 2020 2020 2020 2020 2061 766e  .            avn
+00003290: 203d 2076 6e0a 0a20 2020 2020 2020 2028   = vn..        (
+000032a0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+000032b0: 662e 6361 6e5f 7265 6164 2c0a 2020 2020  f.can_read,.    
 000032c0: 2020 2020 2020 2020 7365 6c66 2e63 616e          self.can
-000032d0: 5f6d 6f76 652c 0a20 2020 2020 2020 2020  _move,.         
-000032e0: 2020 2073 656c 662e 6361 6e5f 6465 6c65     self.can_dele
-000032f0: 7465 2c0a 2020 2020 2020 2020 2020 2020  te,.            
-00003300: 7365 6c66 2e63 616e 5f67 6574 2c0a 2020  self.can_get,.  
-00003310: 2020 2020 2020 2020 2020 7365 6c66 2e63            self.c
-00003320: 616e 5f75 7067 6574 2c0a 2020 2020 2020  an_upget,.      
-00003330: 2020 2920 3d20 280a 2020 2020 2020 2020    ) = (.        
-00003340: 2020 2020 6176 6e2e 6361 6e5f 6163 6365      avn.can_acce
-00003350: 7373 2822 222c 2073 656c 662e 756e 616d  ss("", self.unam
-00003360: 6529 2069 6620 6176 6e20 656c 7365 205b  e) if avn else [
-00003370: 4661 6c73 655d 202a 2036 0a20 2020 2020  False] * 6.     
-00003380: 2020 2029 0a20 2020 2020 2020 2073 656c     ).        sel
-00003390: 662e 6176 6e20 3d20 6176 6e0a 0a20 2020  f.avn = avn..   
-000033a0: 2020 2020 2073 656c 662e 732e 7365 7474       self.s.sett
-000033b0: 696d 656f 7574 2873 656c 662e 6172 6773  imeout(self.args
-000033c0: 2e73 5f74 626f 6479 206f 7220 4e6f 6e65  .s_tbody or None
-000033d0: 290a 0a20 2020 2020 2020 2074 7279 3a0a  )..        try:.
-000033e0: 2020 2020 2020 2020 2020 2020 636f 7273              cors
-000033f0: 5f6b 203d 2073 656c 662e 5f63 6f72 7328  _k = self._cors(
-00003400: 290a 2020 2020 2020 2020 2020 2020 6966  ).            if
-00003410: 2073 656c 662e 6d6f 6465 2069 6e20 2822   self.mode in ("
-00003420: 4745 5422 2c20 2248 4541 4422 293a 0a20  GET", "HEAD"):. 
-00003430: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-00003440: 6574 7572 6e20 7365 6c66 2e68 616e 646c  eturn self.handl
-00003450: 655f 6765 7428 2920 616e 6420 7365 6c66  e_get() and self
-00003460: 2e6b 6565 7061 6c69 7665 0a20 2020 2020  .keepalive.     
-00003470: 2020 2020 2020 2069 6620 7365 6c66 2e6d         if self.m
-00003480: 6f64 6520 3d3d 2022 4f50 5449 4f4e 5322  ode == "OPTIONS"
-00003490: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-000034a0: 2020 7265 7475 726e 2073 656c 662e 6861    return self.ha
-000034b0: 6e64 6c65 5f6f 7074 696f 6e73 2829 2061  ndle_options() a
-000034c0: 6e64 2073 656c 662e 6b65 6570 616c 6976  nd self.keepaliv
-000034d0: 650a 0a20 2020 2020 2020 2020 2020 2069  e..            i
-000034e0: 6620 6e6f 7420 636f 7273 5f6b 3a0a 2020  f not cors_k:.  
-000034f0: 2020 2020 2020 2020 2020 2020 2020 6f72                or
-00003500: 6967 696e 203d 2073 656c 662e 6865 6164  igin = self.head
-00003510: 6572 732e 6765 7428 226f 7269 6769 6e22  ers.get("origin"
-00003520: 2c20 223c 3f3e 2229 0a20 2020 2020 2020  , "<?>").       
-00003530: 2020 2020 2020 2020 2073 656c 662e 6c6f           self.lo
-00003540: 6728 2263 6f72 732d 7265 6a65 6374 207b  g("cors-reject {
-00003550: 7d20 6672 6f6d 207b 7d22 2e66 6f72 6d61  } from {}".forma
-00003560: 7428 7365 6c66 2e6d 6f64 652c 206f 7269  t(self.mode, ori
-00003570: 6769 6e29 2c20 3329 0a20 2020 2020 2020  gin), 3).       
-00003580: 2020 2020 2020 2020 2072 6169 7365 2050           raise P
-00003590: 6562 6b61 6328 3430 332c 2022 6e6f 2073  ebkac(403, "no s
-000035a0: 7572 6669 6e67 2229 0a0a 2020 2020 2020  urfing")..      
-000035b0: 2020 2020 2020 2320 6765 7461 7474 7228        # getattr(
-000035c0: 7365 6c66 2e6d 6f64 6529 2069 7320 6e6f  self.mode) is no
-000035d0: 7420 7965 7420 6661 7374 6572 2074 6861  t yet faster tha
-000035e0: 6e20 7468 6973 0a20 2020 2020 2020 2020  n this.         
-000035f0: 2020 2069 6620 7365 6c66 2e6d 6f64 6520     if self.mode 
-00003600: 3d3d 2022 504f 5354 223a 0a20 2020 2020  == "POST":.     
-00003610: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-00003620: 6e20 7365 6c66 2e68 616e 646c 655f 706f  n self.handle_po
-00003630: 7374 2829 2061 6e64 2073 656c 662e 6b65  st() and self.ke
-00003640: 6570 616c 6976 650a 2020 2020 2020 2020  epalive.        
-00003650: 2020 2020 656c 6966 2073 656c 662e 6d6f      elif self.mo
-00003660: 6465 203d 3d20 2250 5554 223a 0a20 2020  de == "PUT":.   
-00003670: 2020 2020 2020 2020 2020 2020 2072 6574               ret
-00003680: 7572 6e20 7365 6c66 2e68 616e 646c 655f  urn self.handle_
-00003690: 7075 7428 2920 616e 6420 7365 6c66 2e6b  put() and self.k
-000036a0: 6565 7061 6c69 7665 0a20 2020 2020 2020  eepalive.       
-000036b0: 2020 2020 2065 6c69 6620 7365 6c66 2e6d       elif self.m
-000036c0: 6f64 6520 3d3d 2022 5052 4f50 4649 4e44  ode == "PROPFIND
-000036d0: 223a 0a20 2020 2020 2020 2020 2020 2020  ":.             
-000036e0: 2020 2072 6574 7572 6e20 7365 6c66 2e68     return self.h
-000036f0: 616e 646c 655f 7072 6f70 6669 6e64 2829  andle_propfind()
-00003700: 2061 6e64 2073 656c 662e 6b65 6570 616c   and self.keepal
-00003710: 6976 650a 2020 2020 2020 2020 2020 2020  ive.            
-00003720: 656c 6966 2073 656c 662e 6d6f 6465 203d  elif self.mode =
-00003730: 3d20 2244 454c 4554 4522 3a0a 2020 2020  = "DELETE":.    
-00003740: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-00003750: 726e 2073 656c 662e 6861 6e64 6c65 5f64  rn self.handle_d
-00003760: 656c 6574 6528 2920 616e 6420 7365 6c66  elete() and self
-00003770: 2e6b 6565 7061 6c69 7665 0a20 2020 2020  .keepalive.     
-00003780: 2020 2020 2020 2065 6c69 6620 7365 6c66         elif self
-00003790: 2e6d 6f64 6520 3d3d 2022 5052 4f50 5041  .mode == "PROPPA
-000037a0: 5443 4822 3a0a 2020 2020 2020 2020 2020  TCH":.          
-000037b0: 2020 2020 2020 7265 7475 726e 2073 656c        return sel
-000037c0: 662e 6861 6e64 6c65 5f70 726f 7070 6174  f.handle_proppat
-000037d0: 6368 2829 2061 6e64 2073 656c 662e 6b65  ch() and self.ke
-000037e0: 6570 616c 6976 650a 2020 2020 2020 2020  epalive.        
-000037f0: 2020 2020 656c 6966 2073 656c 662e 6d6f      elif self.mo
-00003800: 6465 203d 3d20 224c 4f43 4b22 3a0a 2020  de == "LOCK":.  
-00003810: 2020 2020 2020 2020 2020 2020 2020 7265                re
-00003820: 7475 726e 2073 656c 662e 6861 6e64 6c65  turn self.handle
-00003830: 5f6c 6f63 6b28 2920 616e 6420 7365 6c66  _lock() and self
-00003840: 2e6b 6565 7061 6c69 7665 0a20 2020 2020  .keepalive.     
-00003850: 2020 2020 2020 2065 6c69 6620 7365 6c66         elif self
-00003860: 2e6d 6f64 6520 3d3d 2022 554e 4c4f 434b  .mode == "UNLOCK
-00003870: 223a 0a20 2020 2020 2020 2020 2020 2020  ":.             
-00003880: 2020 2072 6574 7572 6e20 7365 6c66 2e68     return self.h
-00003890: 616e 646c 655f 756e 6c6f 636b 2829 2061  andle_unlock() a
-000038a0: 6e64 2073 656c 662e 6b65 6570 616c 6976  nd self.keepaliv
-000038b0: 650a 2020 2020 2020 2020 2020 2020 656c  e.            el
-000038c0: 6966 2073 656c 662e 6d6f 6465 203d 3d20  if self.mode == 
-000038d0: 224d 4b43 4f4c 223a 0a20 2020 2020 2020  "MKCOL":.       
-000038e0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-000038f0: 7365 6c66 2e68 616e 646c 655f 6d6b 636f  self.handle_mkco
-00003900: 6c28 2920 616e 6420 7365 6c66 2e6b 6565  l() and self.kee
-00003910: 7061 6c69 7665 0a20 2020 2020 2020 2020  palive.         
-00003920: 2020 2065 6c69 6620 7365 6c66 2e6d 6f64     elif self.mod
-00003930: 6520 3d3d 2022 4d4f 5645 223a 0a20 2020  e == "MOVE":.   
-00003940: 2020 2020 2020 2020 2020 2020 2072 6574               ret
-00003950: 7572 6e20 7365 6c66 2e68 616e 646c 655f  urn self.handle_
-00003960: 6d6f 7665 2829 2061 6e64 2073 656c 662e  move() and self.
-00003970: 6b65 6570 616c 6976 650a 2020 2020 2020  keepalive.      
-00003980: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-00003990: 2020 2020 2020 2020 2020 2020 7261 6973              rais
-000039a0: 6520 5065 626b 6163 2834 3030 2c20 2769  e Pebkac(400, 'i
-000039b0: 6e76 616c 6964 2048 5454 5020 6d6f 6465  nvalid HTTP mode
-000039c0: 2022 7b30 7d22 272e 666f 726d 6174 2873   "{0}"'.format(s
-000039d0: 656c 662e 6d6f 6465 2929 0a0a 2020 2020  elf.mode))..    
-000039e0: 2020 2020 6578 6365 7074 2045 7863 6570      except Excep
-000039f0: 7469 6f6e 2061 7320 6578 3a0a 2020 2020  tion as ex:.    
-00003a00: 2020 2020 2020 2020 6966 206e 6f74 2069          if not i
-00003a10: 7369 6e73 7461 6e63 6528 6578 2c20 5065  sinstance(ex, Pe
-00003a20: 626b 6163 293a 0a20 2020 2020 2020 2020  bkac):.         
-00003a30: 2020 2020 2020 2070 6578 203d 2050 6562         pex = Peb
-00003a40: 6b61 6328 3530 3029 0a20 2020 2020 2020  kac(500).       
-00003a50: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-00003a60: 2020 2020 2020 2020 2020 2070 6578 2020             pex  
-00003a70: 3d20 6578 2020 2320 7479 7065 3a20 6967  = ex  # type: ig
-00003a80: 6e6f 7265 0a0a 2020 2020 2020 2020 2020  nore..          
-00003a90: 2020 7472 793a 0a20 2020 2020 2020 2020    try:.         
-00003aa0: 2020 2020 2020 2070 6f73 7420 3d20 7365         post = se
-00003ab0: 6c66 2e6d 6f64 6520 696e 205b 2250 4f53  lf.mode in ["POS
-00003ac0: 5422 2c20 2250 5554 225d 206f 7220 2263  T", "PUT"] or "c
-00003ad0: 6f6e 7465 6e74 2d6c 656e 6774 6822 2069  ontent-length" i
-00003ae0: 6e20 7365 6c66 2e68 6561 6465 7273 0a20  n self.headers. 
-00003af0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00003b00: 6620 6e6f 7420 7365 6c66 2e5f 6368 6563  f not self._chec
-00003b10: 6b5f 6e6f 6e66 6174 616c 2870 6578 2c20  k_nonfatal(pex, 
-00003b20: 706f 7374 293a 0a20 2020 2020 2020 2020  post):.         
-00003b30: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-00003b40: 6b65 6570 616c 6976 6520 3d20 4661 6c73  keepalive = Fals
-00003b50: 650a 0a20 2020 2020 2020 2020 2020 2020  e..             
-00003b60: 2020 2065 6d20 3d20 7374 7228 6578 290a     em = str(ex).
-00003b70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003b80: 6d73 6720 3d20 656d 2069 6620 7065 7820  msg = em if pex 
-00003b90: 3d3d 2065 7820 656c 7365 206d 696e 5f65  == ex else min_e
-00003ba0: 7828 290a 2020 2020 2020 2020 2020 2020  x().            
-00003bb0: 2020 2020 6966 2070 6578 2e63 6f64 6520      if pex.code 
-00003bc0: 213d 2034 3034 206f 7220 7365 6c66 2e64  != 404 or self.d
-00003bd0: 6f5f 6c6f 673a 0a20 2020 2020 2020 2020  o_log:.         
-00003be0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-00003bf0: 6c6f 6728 0a20 2020 2020 2020 2020 2020  log(.           
-00003c00: 2020 2020 2020 2020 2020 2020 2022 7b7d               "{}
-00003c10: 5c30 3333 5b30 6d2c 207b 7d22 2e66 6f72  \033[0m, {}".for
-00003c20: 6d61 7428 6d73 672c 2073 656c 662e 7670  mat(msg, self.vp
-00003c30: 6174 6829 2c0a 2020 2020 2020 2020 2020  ath),.          
-00003c40: 2020 2020 2020 2020 2020 2020 2020 3620                6 
-00003c50: 6966 2065 6d2e 7374 6172 7473 7769 7468  if em.startswith
-00003c60: 2822 636c 6965 6e74 2064 2f63 2022 2920  ("client d/c ") 
-00003c70: 656c 7365 2033 2c0a 2020 2020 2020 2020  else 3,.        
-00003c80: 2020 2020 2020 2020 2020 2020 290a 0a20              ).. 
-00003c90: 2020 2020 2020 2020 2020 2020 2020 206d                 m
-00003ca0: 7367 203d 2022 7b7d 5c72 5c6e 5552 4c3a  sg = "{}\r\nURL:
-00003cb0: 207b 7d5c 725c 6e22 2e66 6f72 6d61 7428   {}\r\n".format(
-00003cc0: 656d 2c20 7365 6c66 2e76 7061 7468 290a  em, self.vpath).
-00003cd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003ce0: 6966 2073 656c 662e 6869 6e74 3a0a 2020  if self.hint:.  
-00003cf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003d00: 2020 6d73 6720 2b3d 2022 6869 6e74 3a20    msg += "hint: 
-00003d10: 7b7d 5c72 5c6e 222e 666f 726d 6174 2873  {}\r\n".format(s
-00003d20: 656c 662e 6869 6e74 290a 0a20 2020 2020  elf.hint)..     
-00003d30: 2020 2020 2020 2020 2020 2069 6620 2264             if "d
-00003d40: 6174 6162 6173 6520 6973 206c 6f63 6b65  atabase is locke
-00003d50: 6422 2069 6e20 656d 3a0a 2020 2020 2020  d" in em:.      
-00003d60: 2020 2020 2020 2020 2020 2020 2020 7365                se
-00003d70: 6c66 2e63 6f6e 6e2e 6873 7276 2e62 726f  lf.conn.hsrv.bro
-00003d80: 6b65 722e 7361 7928 226c 6f67 5f73 7461  ker.say("log_sta
-00003d90: 636b 7322 290a 2020 2020 2020 2020 2020  cks").          
-00003da0: 2020 2020 2020 2020 2020 6d73 6720 2b3d            msg +=
-00003db0: 2022 6869 6e74 3a20 696d 706f 7274 616e   "hint: importan
-00003dc0: 7420 696e 666f 2069 6e20 7468 6520 7365  t info in the se
-00003dd0: 7276 6572 206c 6f67 5c72 5c6e 220a 0a20  rver log\r\n".. 
-00003de0: 2020 2020 2020 2020 2020 2020 2020 207a                 z
-00003df0: 6220 3d20 6222 3c70 7265 3e22 202b 2068  b = b"<pre>" + h
-00003e00: 746d 6c5f 6573 6361 7065 286d 7367 292e  tml_escape(msg).
-00003e10: 656e 636f 6465 2822 7574 662d 3822 2c20  encode("utf-8", 
-00003e20: 2272 6570 6c61 6365 2229 0a20 2020 2020  "replace").     
-00003e30: 2020 2020 2020 2020 2020 2068 203d 207b             h = {
-00003e40: 2257 5757 2d41 7574 6865 6e74 6963 6174  "WWW-Authenticat
-00003e50: 6522 3a20 2742 6173 6963 2072 6561 6c6d  e": 'Basic realm
-00003e60: 3d22 6122 277d 2069 6620 7065 782e 636f  ="a"'} if pex.co
-00003e70: 6465 203d 3d20 3430 3120 656c 7365 207b  de == 401 else {
-00003e80: 7d0a 2020 2020 2020 2020 2020 2020 2020  }.              
-00003e90: 2020 7365 6c66 2e72 6570 6c79 287a 622c    self.reply(zb,
-00003ea0: 2073 7461 7475 733d 7065 782e 636f 6465   status=pex.code
-00003eb0: 2c20 6865 6164 6572 733d 682c 2076 6f6c  , headers=h, vol
-00003ec0: 7361 6e3d 5472 7565 290a 2020 2020 2020  san=True).      
-00003ed0: 2020 2020 2020 2020 2020 7265 7475 726e            return
-00003ee0: 2073 656c 662e 6b65 6570 616c 6976 650a   self.keepalive.
-00003ef0: 2020 2020 2020 2020 2020 2020 6578 6365              exce
-00003f00: 7074 2050 6562 6b61 633a 0a20 2020 2020  pt Pebkac:.     
-00003f10: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-00003f20: 6e20 4661 6c73 650a 0a20 2020 2064 6566  n False..    def
-00003f30: 2064 6970 2873 656c 6629 2020 3a0a 2020   dip(self)  :.  
-00003f40: 2020 2020 2020 6966 2073 656c 662e 6172        if self.ar
-00003f50: 6773 2e70 6c61 696e 5f69 703a 0a20 2020  gs.plain_ip:.   
-00003f60: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-00003f70: 7365 6c66 2e69 702e 7265 706c 6163 6528  self.ip.replace(
-00003f80: 223a 222c 2022 2e22 290a 2020 2020 2020  ":", ".").      
-00003f90: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-00003fa0: 2020 2020 7265 7475 726e 2073 656c 662e      return self.
-00003fb0: 636f 6e6e 2e69 7068 6173 682e 7328 7365  conn.iphash.s(se
-00003fc0: 6c66 2e69 7029 0a0a 2020 2020 6465 6620  lf.ip)..    def 
-00003fd0: 6973 5f62 616e 6e65 6428 7365 6c66 2920  is_banned(self) 
-00003fe0: 203a 0a20 2020 2020 2020 2069 6620 6e6f   :.        if no
-00003ff0: 7420 7365 6c66 2e63 6f6e 6e2e 6261 6e73  t self.conn.bans
-00004000: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
-00004010: 7475 726e 2046 616c 7365 0a0a 2020 2020  turn False..    
-00004020: 2020 2020 6261 6e73 203d 2073 656c 662e      bans = self.
-00004030: 636f 6e6e 2e62 616e 730a 2020 2020 2020  conn.bans.      
-00004040: 2020 6970 203d 2069 706e 6f72 6d28 7365    ip = ipnorm(se
-00004050: 6c66 2e69 7029 0a20 2020 2020 2020 2069  lf.ip).        i
-00004060: 6620 6970 206e 6f74 2069 6e20 6261 6e73  f ip not in bans
-00004070: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
-00004080: 7475 726e 2046 616c 7365 0a0a 2020 2020  turn False..    
-00004090: 2020 2020 7274 203d 2062 616e 735b 6970      rt = bans[ip
-000040a0: 5d20 2d20 7469 6d65 2e74 696d 6528 290a  ] - time.time().
-000040b0: 2020 2020 2020 2020 6966 2072 7420 3c20          if rt < 
-000040c0: 303a 0a20 2020 2020 2020 2020 2020 2073  0:.            s
-000040d0: 656c 662e 6c6f 6728 2263 6c69 656e 7420  elf.log("client 
-000040e0: 756e 6261 6e6e 6564 222c 2033 290a 2020  unbanned", 3).  
-000040f0: 2020 2020 2020 2020 2020 6465 6c20 6261            del ba
-00004100: 6e73 5b69 705d 0a20 2020 2020 2020 2020  ns[ip].         
-00004110: 2020 2072 6574 7572 6e20 4661 6c73 650a     return False.
-00004120: 0a20 2020 2020 2020 2073 656c 662e 6c6f  .        self.lo
-00004130: 6728 2262 616e 6e65 6420 666f 7220 7b3a  g("banned for {:
-00004140: 2e30 667d 2073 6563 222e 666f 726d 6174  .0f} sec".format
-00004150: 2872 7429 2c20 3629 0a20 2020 2020 2020  (rt), 6).       
-00004160: 207a 6220 3d20 6222 4854 5450 2f31 2e30   zb = b"HTTP/1.0
-00004170: 2034 3033 2046 6f72 6269 6464 656e 5c72   403 Forbidden\r
-00004180: 5c6e 5c72 5c6e 7468 616e 6b20 796f 7520  \n\r\nthank you 
-00004190: 666f 7220 706c 6179 696e 6722 0a20 2020  for playing".   
-000041a0: 2020 2020 2073 656c 662e 732e 7365 6e64       self.s.send
-000041b0: 616c 6c28 7a62 290a 2020 2020 2020 2020  all(zb).        
-000041c0: 7265 7475 726e 2054 7275 650a 0a20 2020  return True..   
-000041d0: 2064 6566 2070 6572 6d69 745f 6361 6368   def permit_cach
-000041e0: 696e 6728 7365 6c66 2920 203a 0a20 2020  ing(self)  :.   
-000041f0: 2020 2020 2063 6163 6865 203d 2073 656c       cache = sel
-00004200: 662e 7570 6172 616d 2e67 6574 2822 6361  f.uparam.get("ca
-00004210: 6368 6522 290a 2020 2020 2020 2020 6966  che").        if
-00004220: 2063 6163 6865 2069 7320 4e6f 6e65 3a0a   cache is None:.
-00004230: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00004240: 2e6f 7574 5f68 6561 6465 7273 2e75 7064  .out_headers.upd
-00004250: 6174 6528 4e4f 5f43 4143 4845 290a 2020  ate(NO_CACHE).  
-00004260: 2020 2020 2020 2020 2020 7265 7475 726e            return
-00004270: 0a0a 2020 2020 2020 2020 6e20 3d20 2236  ..        n = "6
-00004280: 3034 3836 3922 2069 6620 6361 6368 6520  04869" if cache 
-00004290: 3d3d 2022 6922 2065 6c73 6520 6361 6368  == "i" else cach
-000042a0: 6520 6f72 2022 3639 220a 2020 2020 2020  e or "69".      
-000042b0: 2020 7365 6c66 2e6f 7574 5f68 6561 6465    self.out_heade
-000042c0: 7273 5b22 4361 6368 652d 436f 6e74 726f  rs["Cache-Contro
-000042d0: 6c22 5d20 3d20 226d 6178 2d61 6765 3d22  l"] = "max-age="
-000042e0: 202b 206e 0a0a 2020 2020 6465 6620 6b33   + n..    def k3
-000042f0: 3034 2873 656c 6629 2020 3a0a 2020 2020  04(self)  :.    
-00004300: 2020 2020 6b33 3034 203d 2073 656c 662e      k304 = self.
-00004310: 636f 6f6b 6965 732e 6765 7428 226b 3330  cookies.get("k30
-00004320: 3422 290a 2020 2020 2020 2020 7265 7475  4").        retu
-00004330: 726e 206b 3330 3420 3d3d 2022 7922 206f  rn k304 == "y" o
-00004340: 7220 2822 3b20 5472 6964 656e 742f 2220  r ("; Trident/" 
-00004350: 696e 2073 656c 662e 7561 2061 6e64 206e  in self.ua and n
-00004360: 6f74 206b 3330 3429 0a0a 2020 2020 6465  ot k304)..    de
-00004370: 6620 7365 6e64 5f68 6561 6465 7273 280a  f send_headers(.
-00004380: 2020 2020 2020 2020 7365 6c66 2c0a 2020          self,.  
-00004390: 2020 2020 2020 6c65 6e67 7468 202c 0a20        length ,. 
-000043a0: 2020 2020 2020 2073 7461 7475 7320 203d         status  =
-000043b0: 2032 3030 2c0a 2020 2020 2020 2020 6d69   200,.        mi
-000043c0: 6d65 2020 3d20 4e6f 6e65 2c0a 2020 2020  me  = None,.    
-000043d0: 2020 2020 6865 6164 6572 7320 2020 3d20      headers   = 
-000043e0: 4e6f 6e65 2c0a 2020 2020 2920 203a 0a20  None,.    )  :. 
-000043f0: 2020 2020 2020 2072 6573 706f 6e73 6520         response 
-00004400: 3d20 5b22 2573 2025 7320 2573 2220 2520  = ["%s %s %s" % 
-00004410: 2873 656c 662e 6874 7470 5f76 6572 2c20  (self.http_ver, 
-00004420: 7374 6174 7573 2c20 4854 5450 434f 4445  status, HTTPCODE
-00004430: 5b73 7461 7475 735d 295d 0a0a 2020 2020  [status])]..    
-00004440: 2020 2020 6966 206c 656e 6774 6820 6973      if length is
-00004450: 206e 6f74 204e 6f6e 653a 0a20 2020 2020   not None:.     
-00004460: 2020 2020 2020 2072 6573 706f 6e73 652e         response.
-00004470: 6170 7065 6e64 2822 436f 6e74 656e 742d  append("Content-
-00004480: 4c65 6e67 7468 3a20 2220 2b20 756e 6963  Length: " + unic
-00004490: 6f64 6528 6c65 6e67 7468 2929 0a0a 2020  ode(length))..  
-000044a0: 2020 2020 2020 6966 2073 7461 7475 7320        if status 
-000044b0: 3d3d 2033 3034 2061 6e64 2073 656c 662e  == 304 and self.
-000044c0: 6b33 3034 2829 3a0a 2020 2020 2020 2020  k304():.        
-000044d0: 2020 2020 7365 6c66 2e6b 6565 7061 6c69      self.keepali
-000044e0: 7665 203d 2046 616c 7365 0a0a 2020 2020  ve = False..    
-000044f0: 2020 2020 2320 636c 6f73 6520 6966 2075      # close if u
-00004500: 6e6b 6e6f 776e 206c 656e 6774 682c 206f  nknown length, o
-00004510: 7468 6572 7769 7365 2074 616b 6520 636c  therwise take cl
-00004520: 6965 6e74 2773 2070 7265 6665 7265 6e63  ient's preferenc
-00004530: 650a 2020 2020 2020 2020 7265 7370 6f6e  e.        respon
-00004540: 7365 2e61 7070 656e 6428 2243 6f6e 6e65  se.append("Conne
-00004550: 6374 696f 6e3a 2022 202b 2028 224b 6565  ction: " + ("Kee
-00004560: 702d 416c 6976 6522 2069 6620 7365 6c66  p-Alive" if self
-00004570: 2e6b 6565 7061 6c69 7665 2065 6c73 6520  .keepalive else 
-00004580: 2243 6c6f 7365 2229 290a 2020 2020 2020  "Close")).      
-00004590: 2020 7265 7370 6f6e 7365 2e61 7070 656e    response.appen
-000045a0: 6428 2244 6174 653a 2022 202b 2066 6f72  d("Date: " + for
-000045b0: 6d61 7464 6174 6528 7573 6567 6d74 3d54  matdate(usegmt=T
-000045c0: 7275 6529 290a 0a20 2020 2020 2020 2023  rue))..        #
-000045d0: 2068 6561 6465 7273 7b7d 206f 7665 7272   headers{} overr
-000045e0: 6964 6573 2061 6e79 7468 696e 6720 7365  ides anything se
-000045f0: 7420 7072 6576 696f 7573 6c79 0a20 2020  t previously.   
-00004600: 2020 2020 2069 6620 6865 6164 6572 733a       if headers:
-00004610: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-00004620: 662e 6f75 745f 6865 6164 6572 732e 7570  f.out_headers.up
-00004630: 6461 7465 2868 6561 6465 7273 290a 0a20  date(headers).. 
-00004640: 2020 2020 2020 2023 2064 6566 6175 6c74         # default
-00004650: 2074 6f20 7574 6638 2068 746d 6c20 6966   to utf8 html if
-00004660: 206e 6f20 636f 6e74 656e 742d 7479 7065   no content-type
-00004670: 2069 7320 7365 740a 2020 2020 2020 2020   is set.        
-00004680: 6966 206e 6f74 206d 696d 653a 0a20 2020  if not mime:.   
-00004690: 2020 2020 2020 2020 206d 696d 6520 3d20           mime = 
-000046a0: 7365 6c66 2e6f 7574 5f68 6561 6465 7273  self.out_headers
-000046b0: 2e67 6574 2822 436f 6e74 656e 742d 5479  .get("Content-Ty
-000046c0: 7065 222c 2022 7465 7874 2f68 746d 6c3b  pe", "text/html;
-000046d0: 2063 6861 7273 6574 3d75 7466 2d38 2229   charset=utf-8")
-000046e0: 0a0a 2020 2020 2020 2020 6173 7365 7274  ..        assert
-000046f0: 206d 696d 650a 2020 2020 2020 2020 7365   mime.        se
-00004700: 6c66 2e6f 7574 5f68 6561 6465 7273 5b22  lf.out_headers["
-00004710: 436f 6e74 656e 742d 5479 7065 225d 203d  Content-Type"] =
-00004720: 206d 696d 650a 0a20 2020 2020 2020 2066   mime..        f
-00004730: 6f72 206b 2c20 7a73 2069 6e20 6c69 7374  or k, zs in list
-00004740: 2873 656c 662e 6f75 745f 6865 6164 6572  (self.out_header
-00004750: 732e 6974 656d 7328 2929 202b 2073 656c  s.items()) + sel
-00004760: 662e 6f75 745f 6865 6164 6572 6c69 7374  f.out_headerlist
-00004770: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
-00004780: 7370 6f6e 7365 2e61 7070 656e 6428 2225  sponse.append("%
-00004790: 733a 2025 7322 2025 2028 6b2c 207a 7329  s: %s" % (k, zs)
-000047a0: 290a 0a20 2020 2020 2020 2074 7279 3a0a  )..        try:.
-000047b0: 2020 2020 2020 2020 2020 2020 2320 6265              # be
-000047c0: 7374 2070 7261 6374 6963 6520 746f 2073  st practice to s
-000047d0: 6570 6172 6174 6520 6865 6164 6572 7320  eparate headers 
-000047e0: 616e 6420 626f 6479 2069 6e74 6f20 6469  and body into di
-000047f0: 6666 6572 656e 7420 7061 636b 6574 730a  fferent packets.
-00004800: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00004810: 2e73 2e73 656e 6461 6c6c 2822 5c72 5c6e  .s.sendall("\r\n
-00004820: 222e 6a6f 696e 2872 6573 706f 6e73 6529  ".join(response)
-00004830: 2e65 6e63 6f64 6528 2275 7466 2d38 2229  .encode("utf-8")
-00004840: 202b 2062 225c 725c 6e5c 725c 6e22 290a   + b"\r\n\r\n").
-00004850: 2020 2020 2020 2020 6578 6365 7074 3a0a          except:.
-00004860: 2020 2020 2020 2020 2020 2020 7261 6973              rais
-00004870: 6520 5065 626b 6163 2834 3030 2c20 2263  e Pebkac(400, "c
-00004880: 6c69 656e 7420 642f 6320 7768 696c 6520  lient d/c while 
-00004890: 7265 706c 7969 6e67 2068 6561 6465 7273  replying headers
-000048a0: 2229 0a0a 2020 2020 6465 6620 7265 706c  ")..    def repl
-000048b0: 7928 0a20 2020 2020 2020 2073 656c 662c  y(.        self,
-000048c0: 0a20 2020 2020 2020 2062 6f64 7920 2c0a  .        body ,.
-000048d0: 2020 2020 2020 2020 7374 6174 7573 2020          status  
-000048e0: 3d20 3230 302c 0a20 2020 2020 2020 206d  = 200,.        m
-000048f0: 696d 6520 203d 204e 6f6e 652c 0a20 2020  ime  = None,.   
-00004900: 2020 2020 2068 6561 6465 7273 2020 203d       headers   =
-00004910: 204e 6f6e 652c 0a20 2020 2020 2020 2076   None,.        v
-00004920: 6f6c 7361 6e20 203d 2046 616c 7365 2c0a  olsan  = False,.
-00004930: 2020 2020 2920 203a 0a20 2020 2020 2020      )  :.       
-00004940: 2069 6620 7374 6174 7573 203d 3d20 3430   if status == 40
-00004950: 343a 0a20 2020 2020 2020 2020 2020 2067  4:.            g
-00004960: 203d 2073 656c 662e 636f 6e6e 2e68 7372   = self.conn.hsr
-00004970: 762e 6734 3034 0a20 2020 2020 2020 2020  v.g404.         
-00004980: 2020 2069 6620 672e 6c69 6d3a 0a20 2020     if g.lim:.   
-00004990: 2020 2020 2020 2020 2020 2020 2062 6f6e               bon
-000049a0: 6b2c 2069 7020 3d20 672e 626f 6e6b 2873  k, ip = g.bonk(s
-000049b0: 656c 662e 6970 2c20 7365 6c66 2e76 7061  elf.ip, self.vpa
-000049c0: 7468 290a 2020 2020 2020 2020 2020 2020  th).            
-000049d0: 2020 2020 6966 2062 6f6e 6b3a 0a20 2020      if bonk:.   
+000032d0: 5f77 7269 7465 2c0a 2020 2020 2020 2020  _write,.        
+000032e0: 2020 2020 7365 6c66 2e63 616e 5f6d 6f76      self.can_mov
+000032f0: 652c 0a20 2020 2020 2020 2020 2020 2073  e,.            s
+00003300: 656c 662e 6361 6e5f 6465 6c65 7465 2c0a  elf.can_delete,.
+00003310: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+00003320: 2e63 616e 5f67 6574 2c0a 2020 2020 2020  .can_get,.      
+00003330: 2020 2020 2020 7365 6c66 2e63 616e 5f75        self.can_u
+00003340: 7067 6574 2c0a 2020 2020 2020 2020 2920  pget,.        ) 
+00003350: 3d20 280a 2020 2020 2020 2020 2020 2020  = (.            
+00003360: 6176 6e2e 6361 6e5f 6163 6365 7373 2822  avn.can_access("
+00003370: 222c 2073 656c 662e 756e 616d 6529 2069  ", self.uname) i
+00003380: 6620 6176 6e20 656c 7365 205b 4661 6c73  f avn else [Fals
+00003390: 655d 202a 2036 0a20 2020 2020 2020 2029  e] * 6.        )
+000033a0: 0a20 2020 2020 2020 2073 656c 662e 6176  .        self.av
+000033b0: 6e20 3d20 6176 6e0a 0a20 2020 2020 2020  n = avn..       
+000033c0: 2073 656c 662e 732e 7365 7474 696d 656f   self.s.settimeo
+000033d0: 7574 2873 656c 662e 6172 6773 2e73 5f74  ut(self.args.s_t
+000033e0: 626f 6479 206f 7220 4e6f 6e65 290a 0a20  body or None).. 
+000033f0: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
+00003400: 2020 2020 2020 2020 636f 7273 5f6b 203d          cors_k =
+00003410: 2073 656c 662e 5f63 6f72 7328 290a 2020   self._cors().  
+00003420: 2020 2020 2020 2020 2020 6966 2073 656c            if sel
+00003430: 662e 6d6f 6465 2069 6e20 2822 4745 5422  f.mode in ("GET"
+00003440: 2c20 2248 4541 4422 293a 0a20 2020 2020  , "HEAD"):.     
+00003450: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+00003460: 6e20 7365 6c66 2e68 616e 646c 655f 6765  n self.handle_ge
+00003470: 7428 2920 616e 6420 7365 6c66 2e6b 6565  t() and self.kee
+00003480: 7061 6c69 7665 0a20 2020 2020 2020 2020  palive.         
+00003490: 2020 2069 6620 7365 6c66 2e6d 6f64 6520     if self.mode 
+000034a0: 3d3d 2022 4f50 5449 4f4e 5322 3a0a 2020  == "OPTIONS":.  
+000034b0: 2020 2020 2020 2020 2020 2020 2020 7265                re
+000034c0: 7475 726e 2073 656c 662e 6861 6e64 6c65  turn self.handle
+000034d0: 5f6f 7074 696f 6e73 2829 2061 6e64 2073  _options() and s
+000034e0: 656c 662e 6b65 6570 616c 6976 650a 0a20  elf.keepalive.. 
+000034f0: 2020 2020 2020 2020 2020 2069 6620 6e6f             if no
+00003500: 7420 636f 7273 5f6b 3a0a 2020 2020 2020  t cors_k:.      
+00003510: 2020 2020 2020 2020 2020 6f72 6967 696e            origin
+00003520: 203d 2073 656c 662e 6865 6164 6572 732e   = self.headers.
+00003530: 6765 7428 226f 7269 6769 6e22 2c20 223c  get("origin", "<
+00003540: 3f3e 2229 0a20 2020 2020 2020 2020 2020  ?>").           
+00003550: 2020 2020 2073 656c 662e 6c6f 6728 2263       self.log("c
+00003560: 6f72 732d 7265 6a65 6374 207b 7d20 6672  ors-reject {} fr
+00003570: 6f6d 207b 7d22 2e66 6f72 6d61 7428 7365  om {}".format(se
+00003580: 6c66 2e6d 6f64 652c 206f 7269 6769 6e29  lf.mode, origin)
+00003590: 2c20 3329 0a20 2020 2020 2020 2020 2020  , 3).           
+000035a0: 2020 2020 2072 6169 7365 2050 6562 6b61       raise Pebka
+000035b0: 6328 3430 332c 2022 6e6f 2073 7572 6669  c(403, "no surfi
+000035c0: 6e67 2229 0a0a 2020 2020 2020 2020 2020  ng")..          
+000035d0: 2020 2320 6765 7461 7474 7228 7365 6c66    # getattr(self
+000035e0: 2e6d 6f64 6529 2069 7320 6e6f 7420 7965  .mode) is not ye
+000035f0: 7420 6661 7374 6572 2074 6861 6e20 7468  t faster than th
+00003600: 6973 0a20 2020 2020 2020 2020 2020 2069  is.            i
+00003610: 6620 7365 6c66 2e6d 6f64 6520 3d3d 2022  f self.mode == "
+00003620: 504f 5354 223a 0a20 2020 2020 2020 2020  POST":.         
+00003630: 2020 2020 2020 2072 6574 7572 6e20 7365         return se
+00003640: 6c66 2e68 616e 646c 655f 706f 7374 2829  lf.handle_post()
+00003650: 2061 6e64 2073 656c 662e 6b65 6570 616c   and self.keepal
+00003660: 6976 650a 2020 2020 2020 2020 2020 2020  ive.            
+00003670: 656c 6966 2073 656c 662e 6d6f 6465 203d  elif self.mode =
+00003680: 3d20 2250 5554 223a 0a20 2020 2020 2020  = "PUT":.       
+00003690: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+000036a0: 7365 6c66 2e68 616e 646c 655f 7075 7428  self.handle_put(
+000036b0: 2920 616e 6420 7365 6c66 2e6b 6565 7061  ) and self.keepa
+000036c0: 6c69 7665 0a20 2020 2020 2020 2020 2020  live.           
+000036d0: 2065 6c69 6620 7365 6c66 2e6d 6f64 6520   elif self.mode 
+000036e0: 3d3d 2022 5052 4f50 4649 4e44 223a 0a20  == "PROPFIND":. 
+000036f0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+00003700: 6574 7572 6e20 7365 6c66 2e68 616e 646c  eturn self.handl
+00003710: 655f 7072 6f70 6669 6e64 2829 2061 6e64  e_propfind() and
+00003720: 2073 656c 662e 6b65 6570 616c 6976 650a   self.keepalive.
+00003730: 2020 2020 2020 2020 2020 2020 656c 6966              elif
+00003740: 2073 656c 662e 6d6f 6465 203d 3d20 2244   self.mode == "D
+00003750: 454c 4554 4522 3a0a 2020 2020 2020 2020  ELETE":.        
+00003760: 2020 2020 2020 2020 7265 7475 726e 2073          return s
+00003770: 656c 662e 6861 6e64 6c65 5f64 656c 6574  elf.handle_delet
+00003780: 6528 2920 616e 6420 7365 6c66 2e6b 6565  e() and self.kee
+00003790: 7061 6c69 7665 0a20 2020 2020 2020 2020  palive.         
+000037a0: 2020 2065 6c69 6620 7365 6c66 2e6d 6f64     elif self.mod
+000037b0: 6520 3d3d 2022 5052 4f50 5041 5443 4822  e == "PROPPATCH"
+000037c0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+000037d0: 2020 7265 7475 726e 2073 656c 662e 6861    return self.ha
+000037e0: 6e64 6c65 5f70 726f 7070 6174 6368 2829  ndle_proppatch()
+000037f0: 2061 6e64 2073 656c 662e 6b65 6570 616c   and self.keepal
+00003800: 6976 650a 2020 2020 2020 2020 2020 2020  ive.            
+00003810: 656c 6966 2073 656c 662e 6d6f 6465 203d  elif self.mode =
+00003820: 3d20 224c 4f43 4b22 3a0a 2020 2020 2020  = "LOCK":.      
+00003830: 2020 2020 2020 2020 2020 7265 7475 726e            return
+00003840: 2073 656c 662e 6861 6e64 6c65 5f6c 6f63   self.handle_loc
+00003850: 6b28 2920 616e 6420 7365 6c66 2e6b 6565  k() and self.kee
+00003860: 7061 6c69 7665 0a20 2020 2020 2020 2020  palive.         
+00003870: 2020 2065 6c69 6620 7365 6c66 2e6d 6f64     elif self.mod
+00003880: 6520 3d3d 2022 554e 4c4f 434b 223a 0a20  e == "UNLOCK":. 
+00003890: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+000038a0: 6574 7572 6e20 7365 6c66 2e68 616e 646c  eturn self.handl
+000038b0: 655f 756e 6c6f 636b 2829 2061 6e64 2073  e_unlock() and s
+000038c0: 656c 662e 6b65 6570 616c 6976 650a 2020  elf.keepalive.  
+000038d0: 2020 2020 2020 2020 2020 656c 6966 2073            elif s
+000038e0: 656c 662e 6d6f 6465 203d 3d20 224d 4b43  elf.mode == "MKC
+000038f0: 4f4c 223a 0a20 2020 2020 2020 2020 2020  OL":.           
+00003900: 2020 2020 2072 6574 7572 6e20 7365 6c66       return self
+00003910: 2e68 616e 646c 655f 6d6b 636f 6c28 2920  .handle_mkcol() 
+00003920: 616e 6420 7365 6c66 2e6b 6565 7061 6c69  and self.keepali
+00003930: 7665 0a20 2020 2020 2020 2020 2020 2065  ve.            e
+00003940: 6c69 6620 7365 6c66 2e6d 6f64 6520 3d3d  lif self.mode ==
+00003950: 2022 4d4f 5645 223a 0a20 2020 2020 2020   "MOVE":.       
+00003960: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+00003970: 7365 6c66 2e68 616e 646c 655f 6d6f 7665  self.handle_move
+00003980: 2829 2061 6e64 2073 656c 662e 6b65 6570  () and self.keep
+00003990: 616c 6976 650a 2020 2020 2020 2020 2020  alive.          
+000039a0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+000039b0: 2020 2020 2020 2020 7261 6973 6520 5065          raise Pe
+000039c0: 626b 6163 2834 3030 2c20 2769 6e76 616c  bkac(400, 'inval
+000039d0: 6964 2048 5454 5020 6d6f 6465 2022 7b30  id HTTP mode "{0
+000039e0: 7d22 272e 666f 726d 6174 2873 656c 662e  }"'.format(self.
+000039f0: 6d6f 6465 2929 0a0a 2020 2020 2020 2020  mode))..        
+00003a00: 6578 6365 7074 2045 7863 6570 7469 6f6e  except Exception
+00003a10: 2061 7320 6578 3a0a 2020 2020 2020 2020   as ex:.        
+00003a20: 2020 2020 6966 206e 6f74 2069 7369 6e73      if not isins
+00003a30: 7461 6e63 6528 6578 2c20 5065 626b 6163  tance(ex, Pebkac
+00003a40: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+00003a50: 2020 2070 6578 203d 2050 6562 6b61 6328     pex = Pebkac(
+00003a60: 3530 3029 0a20 2020 2020 2020 2020 2020  500).           
+00003a70: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+00003a80: 2020 2020 2020 2070 6578 2020 3d20 6578         pex  = ex
+00003a90: 2020 2320 7479 7065 3a20 6967 6e6f 7265    # type: ignore
+00003aa0: 0a0a 2020 2020 2020 2020 2020 2020 7472  ..            tr
+00003ab0: 793a 0a20 2020 2020 2020 2020 2020 2020  y:.             
+00003ac0: 2020 2070 6f73 7420 3d20 7365 6c66 2e6d     post = self.m
+00003ad0: 6f64 6520 696e 205b 2250 4f53 5422 2c20  ode in ["POST", 
+00003ae0: 2250 5554 225d 206f 7220 2263 6f6e 7465  "PUT"] or "conte
+00003af0: 6e74 2d6c 656e 6774 6822 2069 6e20 7365  nt-length" in se
+00003b00: 6c66 2e68 6561 6465 7273 0a20 2020 2020  lf.headers.     
+00003b10: 2020 2020 2020 2020 2020 2069 6620 6e6f             if no
+00003b20: 7420 7365 6c66 2e5f 6368 6563 6b5f 6e6f  t self._check_no
+00003b30: 6e66 6174 616c 2870 6578 2c20 706f 7374  nfatal(pex, post
+00003b40: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+00003b50: 2020 2020 2020 2073 656c 662e 6b65 6570         self.keep
+00003b60: 616c 6976 6520 3d20 4661 6c73 650a 0a20  alive = False.. 
+00003b70: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+00003b80: 6d20 3d20 7374 7228 6578 290a 2020 2020  m = str(ex).    
+00003b90: 2020 2020 2020 2020 2020 2020 6d73 6720              msg 
+00003ba0: 3d20 656d 2069 6620 7065 7820 3d3d 2065  = em if pex == e
+00003bb0: 7820 656c 7365 206d 696e 5f65 7828 290a  x else min_ex().
+00003bc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003bd0: 6966 2070 6578 2e63 6f64 6520 213d 2034  if pex.code != 4
+00003be0: 3034 206f 7220 7365 6c66 2e64 6f5f 6c6f  04 or self.do_lo
+00003bf0: 673a 0a20 2020 2020 2020 2020 2020 2020  g:.             
+00003c00: 2020 2020 2020 2073 656c 662e 6c6f 6728         self.log(
+00003c10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00003c20: 2020 2020 2020 2020 2022 7b7d 5c30 3333           "{}\033
+00003c30: 5b30 6d2c 207b 7d22 2e66 6f72 6d61 7428  [0m, {}".format(
+00003c40: 6d73 672c 2073 656c 662e 7670 6174 6829  msg, self.vpath)
+00003c50: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00003c60: 2020 2020 2020 2020 2020 3620 6966 2065            6 if e
+00003c70: 6d2e 7374 6172 7473 7769 7468 2822 636c  m.startswith("cl
+00003c80: 6965 6e74 2064 2f63 2022 2920 656c 7365  ient d/c ") else
+00003c90: 2033 2c0a 2020 2020 2020 2020 2020 2020   3,.            
+00003ca0: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
+00003cb0: 2020 2020 2020 2020 2020 206d 7367 203d             msg =
+00003cc0: 2022 7b7d 5c72 5c6e 5552 4c3a 207b 7d5c   "{}\r\nURL: {}\
+00003cd0: 725c 6e22 2e66 6f72 6d61 7428 656d 2c20  r\n".format(em, 
+00003ce0: 7365 6c66 2e76 7061 7468 290a 2020 2020  self.vpath).    
+00003cf0: 2020 2020 2020 2020 2020 2020 6966 2073              if s
+00003d00: 656c 662e 6869 6e74 3a0a 2020 2020 2020  elf.hint:.      
+00003d10: 2020 2020 2020 2020 2020 2020 2020 6d73                ms
+00003d20: 6720 2b3d 2022 6869 6e74 3a20 7b7d 5c72  g += "hint: {}\r
+00003d30: 5c6e 222e 666f 726d 6174 2873 656c 662e  \n".format(self.
+00003d40: 6869 6e74 290a 0a20 2020 2020 2020 2020  hint)..         
+00003d50: 2020 2020 2020 2069 6620 2264 6174 6162         if "datab
+00003d60: 6173 6520 6973 206c 6f63 6b65 6422 2069  ase is locked" i
+00003d70: 6e20 656d 3a0a 2020 2020 2020 2020 2020  n em:.          
+00003d80: 2020 2020 2020 2020 2020 7365 6c66 2e63            self.c
+00003d90: 6f6e 6e2e 6873 7276 2e62 726f 6b65 722e  onn.hsrv.broker.
+00003da0: 7361 7928 226c 6f67 5f73 7461 636b 7322  say("log_stacks"
+00003db0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00003dc0: 2020 2020 2020 6d73 6720 2b3d 2022 6869        msg += "hi
+00003dd0: 6e74 3a20 696d 706f 7274 616e 7420 696e  nt: important in
+00003de0: 666f 2069 6e20 7468 6520 7365 7276 6572  fo in the server
+00003df0: 206c 6f67 5c72 5c6e 220a 0a20 2020 2020   log\r\n"..     
+00003e00: 2020 2020 2020 2020 2020 207a 6220 3d20             zb = 
+00003e10: 6222 3c70 7265 3e22 202b 2068 746d 6c5f  b"<pre>" + html_
+00003e20: 6573 6361 7065 286d 7367 292e 656e 636f  escape(msg).enco
+00003e30: 6465 2822 7574 662d 3822 2c20 2272 6570  de("utf-8", "rep
+00003e40: 6c61 6365 2229 0a20 2020 2020 2020 2020  lace").         
+00003e50: 2020 2020 2020 2068 203d 207b 2257 5757         h = {"WWW
+00003e60: 2d41 7574 6865 6e74 6963 6174 6522 3a20  -Authenticate": 
+00003e70: 2742 6173 6963 2072 6561 6c6d 3d22 6122  'Basic realm="a"
+00003e80: 277d 2069 6620 7065 782e 636f 6465 203d  '} if pex.code =
+00003e90: 3d20 3430 3120 656c 7365 207b 7d0a 2020  = 401 else {}.  
+00003ea0: 2020 2020 2020 2020 2020 2020 2020 7365                se
+00003eb0: 6c66 2e72 6570 6c79 287a 622c 2073 7461  lf.reply(zb, sta
+00003ec0: 7475 733d 7065 782e 636f 6465 2c20 6865  tus=pex.code, he
+00003ed0: 6164 6572 733d 682c 2076 6f6c 7361 6e3d  aders=h, volsan=
+00003ee0: 5472 7565 290a 2020 2020 2020 2020 2020  True).          
+00003ef0: 2020 2020 2020 7265 7475 726e 2073 656c        return sel
+00003f00: 662e 6b65 6570 616c 6976 650a 2020 2020  f.keepalive.    
+00003f10: 2020 2020 2020 2020 6578 6365 7074 2050          except P
+00003f20: 6562 6b61 633a 0a20 2020 2020 2020 2020  ebkac:.         
+00003f30: 2020 2020 2020 2072 6574 7572 6e20 4661         return Fa
+00003f40: 6c73 650a 0a20 2020 2064 6566 2064 6970  lse..    def dip
+00003f50: 2873 656c 6629 2020 3a0a 2020 2020 2020  (self)  :.      
+00003f60: 2020 6966 2073 656c 662e 6172 6773 2e70    if self.args.p
+00003f70: 6c61 696e 5f69 703a 0a20 2020 2020 2020  lain_ip:.       
+00003f80: 2020 2020 2072 6574 7572 6e20 7365 6c66       return self
+00003f90: 2e69 702e 7265 706c 6163 6528 223a 222c  .ip.replace(":",
+00003fa0: 2022 2e22 290a 2020 2020 2020 2020 656c   ".").        el
+00003fb0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+00003fc0: 7265 7475 726e 2073 656c 662e 636f 6e6e  return self.conn
+00003fd0: 2e69 7068 6173 682e 7328 7365 6c66 2e69  .iphash.s(self.i
+00003fe0: 7029 0a0a 2020 2020 6465 6620 6973 5f62  p)..    def is_b
+00003ff0: 616e 6e65 6428 7365 6c66 2920 203a 0a20  anned(self)  :. 
+00004000: 2020 2020 2020 2069 6620 6e6f 7420 7365         if not se
+00004010: 6c66 2e63 6f6e 6e2e 6261 6e73 3a0a 2020  lf.conn.bans:.  
+00004020: 2020 2020 2020 2020 2020 7265 7475 726e            return
+00004030: 2046 616c 7365 0a0a 2020 2020 2020 2020   False..        
+00004040: 6261 6e73 203d 2073 656c 662e 636f 6e6e  bans = self.conn
+00004050: 2e62 616e 730a 2020 2020 2020 2020 6970  .bans.        ip
+00004060: 203d 2069 706e 6f72 6d28 7365 6c66 2e69   = ipnorm(self.i
+00004070: 7029 0a20 2020 2020 2020 2069 6620 6970  p).        if ip
+00004080: 206e 6f74 2069 6e20 6261 6e73 3a0a 2020   not in bans:.  
+00004090: 2020 2020 2020 2020 2020 7265 7475 726e            return
+000040a0: 2046 616c 7365 0a0a 2020 2020 2020 2020   False..        
+000040b0: 7274 203d 2062 616e 735b 6970 5d20 2d20  rt = bans[ip] - 
+000040c0: 7469 6d65 2e74 696d 6528 290a 2020 2020  time.time().    
+000040d0: 2020 2020 6966 2072 7420 3c20 303a 0a20      if rt < 0:. 
+000040e0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+000040f0: 6c6f 6728 2263 6c69 656e 7420 756e 6261  log("client unba
+00004100: 6e6e 6564 222c 2033 290a 2020 2020 2020  nned", 3).      
+00004110: 2020 2020 2020 6465 6c20 6261 6e73 5b69        del bans[i
+00004120: 705d 0a20 2020 2020 2020 2020 2020 2072  p].            r
+00004130: 6574 7572 6e20 4661 6c73 650a 0a20 2020  eturn False..   
+00004140: 2020 2020 2073 656c 662e 6c6f 6728 2262       self.log("b
+00004150: 616e 6e65 6420 666f 7220 7b3a 2e30 667d  anned for {:.0f}
+00004160: 2073 6563 222e 666f 726d 6174 2872 7429   sec".format(rt)
+00004170: 2c20 3629 0a20 2020 2020 2020 207a 6220  , 6).        zb 
+00004180: 3d20 6222 4854 5450 2f31 2e30 2034 3033  = b"HTTP/1.0 403
+00004190: 2046 6f72 6269 6464 656e 5c72 5c6e 5c72   Forbidden\r\n\r
+000041a0: 5c6e 7468 616e 6b20 796f 7520 666f 7220  \nthank you for 
+000041b0: 706c 6179 696e 6722 0a20 2020 2020 2020  playing".       
+000041c0: 2073 656c 662e 732e 7365 6e64 616c 6c28   self.s.sendall(
+000041d0: 7a62 290a 2020 2020 2020 2020 7265 7475  zb).        retu
+000041e0: 726e 2054 7275 650a 0a20 2020 2064 6566  rn True..    def
+000041f0: 2070 6572 6d69 745f 6361 6368 696e 6728   permit_caching(
+00004200: 7365 6c66 2920 203a 0a20 2020 2020 2020  self)  :.       
+00004210: 2063 6163 6865 203d 2073 656c 662e 7570   cache = self.up
+00004220: 6172 616d 2e67 6574 2822 6361 6368 6522  aram.get("cache"
+00004230: 290a 2020 2020 2020 2020 6966 2063 6163  ).        if cac
+00004240: 6865 2069 7320 4e6f 6e65 3a0a 2020 2020  he is None:.    
+00004250: 2020 2020 2020 2020 7365 6c66 2e6f 7574          self.out
+00004260: 5f68 6561 6465 7273 2e75 7064 6174 6528  _headers.update(
+00004270: 4e4f 5f43 4143 4845 290a 2020 2020 2020  NO_CACHE).      
+00004280: 2020 2020 2020 7265 7475 726e 0a0a 2020        return..  
+00004290: 2020 2020 2020 6e20 3d20 2236 3034 3836        n = "60486
+000042a0: 3922 2069 6620 6361 6368 6520 3d3d 2022  9" if cache == "
+000042b0: 6922 2065 6c73 6520 6361 6368 6520 6f72  i" else cache or
+000042c0: 2022 3639 220a 2020 2020 2020 2020 7365   "69".        se
+000042d0: 6c66 2e6f 7574 5f68 6561 6465 7273 5b22  lf.out_headers["
+000042e0: 4361 6368 652d 436f 6e74 726f 6c22 5d20  Cache-Control"] 
+000042f0: 3d20 226d 6178 2d61 6765 3d22 202b 206e  = "max-age=" + n
+00004300: 0a0a 2020 2020 6465 6620 6b33 3034 2873  ..    def k304(s
+00004310: 656c 6629 2020 3a0a 2020 2020 2020 2020  elf)  :.        
+00004320: 6b33 3034 203d 2073 656c 662e 636f 6f6b  k304 = self.cook
+00004330: 6965 732e 6765 7428 226b 3330 3422 290a  ies.get("k304").
+00004340: 2020 2020 2020 2020 7265 7475 726e 206b          return k
+00004350: 3330 3420 3d3d 2022 7922 206f 7220 2822  304 == "y" or ("
+00004360: 3b20 5472 6964 656e 742f 2220 696e 2073  ; Trident/" in s
+00004370: 656c 662e 7561 2061 6e64 206e 6f74 206b  elf.ua and not k
+00004380: 3330 3429 0a0a 2020 2020 6465 6620 7365  304)..    def se
+00004390: 6e64 5f68 6561 6465 7273 280a 2020 2020  nd_headers(.    
+000043a0: 2020 2020 7365 6c66 2c0a 2020 2020 2020      self,.      
+000043b0: 2020 6c65 6e67 7468 202c 0a20 2020 2020    length ,.     
+000043c0: 2020 2073 7461 7475 7320 203d 2032 3030     status  = 200
+000043d0: 2c0a 2020 2020 2020 2020 6d69 6d65 2020  ,.        mime  
+000043e0: 3d20 4e6f 6e65 2c0a 2020 2020 2020 2020  = None,.        
+000043f0: 6865 6164 6572 7320 2020 3d20 4e6f 6e65  headers   = None
+00004400: 2c0a 2020 2020 2920 203a 0a20 2020 2020  ,.    )  :.     
+00004410: 2020 2072 6573 706f 6e73 6520 3d20 5b22     response = ["
+00004420: 2573 2025 7320 2573 2220 2520 2873 656c  %s %s %s" % (sel
+00004430: 662e 6874 7470 5f76 6572 2c20 7374 6174  f.http_ver, stat
+00004440: 7573 2c20 4854 5450 434f 4445 5b73 7461  us, HTTPCODE[sta
+00004450: 7475 735d 295d 0a0a 2020 2020 2020 2020  tus])]..        
+00004460: 6966 206c 656e 6774 6820 6973 206e 6f74  if length is not
+00004470: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
+00004480: 2020 2072 6573 706f 6e73 652e 6170 7065     response.appe
+00004490: 6e64 2822 436f 6e74 656e 742d 4c65 6e67  nd("Content-Leng
+000044a0: 7468 3a20 2220 2b20 756e 6963 6f64 6528  th: " + unicode(
+000044b0: 6c65 6e67 7468 2929 0a0a 2020 2020 2020  length))..      
+000044c0: 2020 6966 2073 7461 7475 7320 3d3d 2033    if status == 3
+000044d0: 3034 2061 6e64 2073 656c 662e 6b33 3034  04 and self.k304
+000044e0: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
+000044f0: 7365 6c66 2e6b 6565 7061 6c69 7665 203d  self.keepalive =
+00004500: 2046 616c 7365 0a0a 2020 2020 2020 2020   False..        
+00004510: 2320 636c 6f73 6520 6966 2075 6e6b 6e6f  # close if unkno
+00004520: 776e 206c 656e 6774 682c 206f 7468 6572  wn length, other
+00004530: 7769 7365 2074 616b 6520 636c 6965 6e74  wise take client
+00004540: 2773 2070 7265 6665 7265 6e63 650a 2020  's preference.  
+00004550: 2020 2020 2020 7265 7370 6f6e 7365 2e61        response.a
+00004560: 7070 656e 6428 2243 6f6e 6e65 6374 696f  ppend("Connectio
+00004570: 6e3a 2022 202b 2028 224b 6565 702d 416c  n: " + ("Keep-Al
+00004580: 6976 6522 2069 6620 7365 6c66 2e6b 6565  ive" if self.kee
+00004590: 7061 6c69 7665 2065 6c73 6520 2243 6c6f  palive else "Clo
+000045a0: 7365 2229 290a 2020 2020 2020 2020 7265  se")).        re
+000045b0: 7370 6f6e 7365 2e61 7070 656e 6428 2244  sponse.append("D
+000045c0: 6174 653a 2022 202b 2066 6f72 6d61 7464  ate: " + formatd
+000045d0: 6174 6528 7573 6567 6d74 3d54 7275 6529  ate(usegmt=True)
+000045e0: 290a 0a20 2020 2020 2020 2023 2068 6561  )..        # hea
+000045f0: 6465 7273 7b7d 206f 7665 7272 6964 6573  ders{} overrides
+00004600: 2061 6e79 7468 696e 6720 7365 7420 7072   anything set pr
+00004610: 6576 696f 7573 6c79 0a20 2020 2020 2020  eviously.       
+00004620: 2069 6620 6865 6164 6572 733a 0a20 2020   if headers:.   
+00004630: 2020 2020 2020 2020 2073 656c 662e 6f75           self.ou
+00004640: 745f 6865 6164 6572 732e 7570 6461 7465  t_headers.update
+00004650: 2868 6561 6465 7273 290a 0a20 2020 2020  (headers)..     
+00004660: 2020 2023 2064 6566 6175 6c74 2074 6f20     # default to 
+00004670: 7574 6638 2068 746d 6c20 6966 206e 6f20  utf8 html if no 
+00004680: 636f 6e74 656e 742d 7479 7065 2069 7320  content-type is 
+00004690: 7365 740a 2020 2020 2020 2020 6966 206e  set.        if n
+000046a0: 6f74 206d 696d 653a 0a20 2020 2020 2020  ot mime:.       
+000046b0: 2020 2020 206d 696d 6520 3d20 7365 6c66       mime = self
+000046c0: 2e6f 7574 5f68 6561 6465 7273 2e67 6574  .out_headers.get
+000046d0: 2822 436f 6e74 656e 742d 5479 7065 222c  ("Content-Type",
+000046e0: 2022 7465 7874 2f68 746d 6c3b 2063 6861   "text/html; cha
+000046f0: 7273 6574 3d75 7466 2d38 2229 0a0a 2020  rset=utf-8")..  
+00004700: 2020 2020 2020 6173 7365 7274 206d 696d        assert mim
+00004710: 650a 2020 2020 2020 2020 7365 6c66 2e6f  e.        self.o
+00004720: 7574 5f68 6561 6465 7273 5b22 436f 6e74  ut_headers["Cont
+00004730: 656e 742d 5479 7065 225d 203d 206d 696d  ent-Type"] = mim
+00004740: 650a 0a20 2020 2020 2020 2066 6f72 206b  e..        for k
+00004750: 2c20 7a73 2069 6e20 6c69 7374 2873 656c  , zs in list(sel
+00004760: 662e 6f75 745f 6865 6164 6572 732e 6974  f.out_headers.it
+00004770: 656d 7328 2929 202b 2073 656c 662e 6f75  ems()) + self.ou
+00004780: 745f 6865 6164 6572 6c69 7374 3a0a 2020  t_headerlist:.  
+00004790: 2020 2020 2020 2020 2020 7265 7370 6f6e            respon
+000047a0: 7365 2e61 7070 656e 6428 2225 733a 2025  se.append("%s: %
+000047b0: 7322 2025 2028 6b2c 207a 7329 290a 0a20  s" % (k, zs)).. 
+000047c0: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
+000047d0: 2020 2020 2020 2020 2320 6265 7374 2070          # best p
+000047e0: 7261 6374 6963 6520 746f 2073 6570 6172  ractice to separ
+000047f0: 6174 6520 6865 6164 6572 7320 616e 6420  ate headers and 
+00004800: 626f 6479 2069 6e74 6f20 6469 6666 6572  body into differ
+00004810: 656e 7420 7061 636b 6574 730a 2020 2020  ent packets.    
+00004820: 2020 2020 2020 2020 7365 6c66 2e73 2e73          self.s.s
+00004830: 656e 6461 6c6c 2822 5c72 5c6e 222e 6a6f  endall("\r\n".jo
+00004840: 696e 2872 6573 706f 6e73 6529 2e65 6e63  in(response).enc
+00004850: 6f64 6528 2275 7466 2d38 2229 202b 2062  ode("utf-8") + b
+00004860: 225c 725c 6e5c 725c 6e22 290a 2020 2020  "\r\n\r\n").    
+00004870: 2020 2020 6578 6365 7074 3a0a 2020 2020      except:.    
+00004880: 2020 2020 2020 2020 7261 6973 6520 5065          raise Pe
+00004890: 626b 6163 2834 3030 2c20 2263 6c69 656e  bkac(400, "clien
+000048a0: 7420 642f 6320 7768 696c 6520 7265 706c  t d/c while repl
+000048b0: 7969 6e67 2068 6561 6465 7273 2229 0a0a  ying headers")..
+000048c0: 2020 2020 6465 6620 7265 706c 7928 0a20      def reply(. 
+000048d0: 2020 2020 2020 2073 656c 662c 0a20 2020         self,.   
+000048e0: 2020 2020 2062 6f64 7920 2c0a 2020 2020       body ,.    
+000048f0: 2020 2020 7374 6174 7573 2020 3d20 3230      status  = 20
+00004900: 302c 0a20 2020 2020 2020 206d 696d 6520  0,.        mime 
+00004910: 203d 204e 6f6e 652c 0a20 2020 2020 2020   = None,.       
+00004920: 2068 6561 6465 7273 2020 203d 204e 6f6e   headers   = Non
+00004930: 652c 0a20 2020 2020 2020 2076 6f6c 7361  e,.        volsa
+00004940: 6e20 203d 2046 616c 7365 2c0a 2020 2020  n  = False,.    
+00004950: 2920 203a 0a20 2020 2020 2020 2069 6620  )  :.        if 
+00004960: 7374 6174 7573 203d 3d20 3430 343a 0a20  status == 404:. 
+00004970: 2020 2020 2020 2020 2020 2067 203d 2073             g = s
+00004980: 656c 662e 636f 6e6e 2e68 7372 762e 6734  elf.conn.hsrv.g4
+00004990: 3034 0a20 2020 2020 2020 2020 2020 2069  04.            i
+000049a0: 6620 672e 6c69 6d3a 0a20 2020 2020 2020  f g.lim:.       
+000049b0: 2020 2020 2020 2020 2062 6f6e 6b2c 2069           bonk, i
+000049c0: 7020 3d20 672e 626f 6e6b 2873 656c 662e  p = g.bonk(self.
+000049d0: 6970 2c20 7365 6c66 2e76 7061 7468 290a  ip, self.vpath).
 000049e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000049f0: 2073 656c 662e 6c6f 6728 2263 6c69 656e   self.log("clien
-00004a00: 7420 6261 6e6e 6564 3a20 3430 3473 222c  t banned: 404s",
-00004a10: 2031 290a 2020 2020 2020 2020 2020 2020   1).            
-00004a20: 2020 2020 2020 2020 7365 6c66 2e63 6f6e          self.con
-00004a30: 6e2e 6873 7276 2e62 616e 735b 6970 5d20  n.hsrv.bans[ip] 
-00004a40: 3d20 626f 6e6b 0a0a 2020 2020 2020 2020  = bonk..        
-00004a50: 6966 2076 6f6c 7361 6e3a 0a20 2020 2020  if volsan:.     
-00004a60: 2020 2020 2020 2076 6f6c 7320 3d20 6c69         vols = li
-00004a70: 7374 2873 656c 662e 6173 7276 2e76 6673  st(self.asrv.vfs
-00004a80: 2e61 6c6c 5f76 6f6c 732e 7661 6c75 6573  .all_vols.values
-00004a90: 2829 290a 2020 2020 2020 2020 2020 2020  ()).            
-00004aa0: 626f 6479 203d 2076 6f6c 5f73 616e 2876  body = vol_san(v
-00004ab0: 6f6c 732c 2062 6f64 7929 0a0a 2020 2020  ols, body)..    
-00004ac0: 2020 2020 7365 6c66 2e73 656e 645f 6865      self.send_he
-00004ad0: 6164 6572 7328 6c65 6e28 626f 6479 292c  aders(len(body),
-00004ae0: 2073 7461 7475 732c 206d 696d 652c 2068   status, mime, h
-00004af0: 6561 6465 7273 290a 0a20 2020 2020 2020  eaders)..       
-00004b00: 2074 7279 3a0a 2020 2020 2020 2020 2020   try:.          
-00004b10: 2020 6966 2073 656c 662e 6d6f 6465 2021    if self.mode !
-00004b20: 3d20 2248 4541 4422 3a0a 2020 2020 2020  = "HEAD":.      
-00004b30: 2020 2020 2020 2020 2020 7365 6c66 2e73            self.s
-00004b40: 2e73 656e 6461 6c6c 2862 6f64 7929 0a20  .sendall(body). 
-00004b50: 2020 2020 2020 2065 7863 6570 743a 0a20         except:. 
-00004b60: 2020 2020 2020 2020 2020 2072 6169 7365             raise
-00004b70: 2050 6562 6b61 6328 3430 302c 2022 636c   Pebkac(400, "cl
-00004b80: 6965 6e74 2064 2f63 2077 6869 6c65 2072  ient d/c while r
-00004b90: 6570 6c79 696e 6720 626f 6479 2229 0a0a  eplying body")..
-00004ba0: 2020 2020 2020 2020 7265 7475 726e 2062          return b
-00004bb0: 6f64 790a 0a20 2020 2064 6566 206c 6f75  ody..    def lou
-00004bc0: 645f 7265 706c 7928 7365 6c66 2c20 626f  d_reply(self, bo
-00004bd0: 6479 202c 202a 6172 6773 202c 202a 2a6b  dy , *args , **k
-00004be0: 7761 7267 7320 2920 203a 0a20 2020 2020  wargs )  :.     
-00004bf0: 2020 2069 6620 6e6f 7420 6b77 6172 6773     if not kwargs
-00004c00: 2e67 6574 2822 6d69 6d65 2229 3a0a 2020  .get("mime"):.  
-00004c10: 2020 2020 2020 2020 2020 6b77 6172 6773            kwargs
-00004c20: 5b22 6d69 6d65 225d 203d 2022 7465 7874  ["mime"] = "text
-00004c30: 2f70 6c61 696e 3b20 6368 6172 7365 743d  /plain; charset=
-00004c40: 7574 662d 3822 0a0a 2020 2020 2020 2020  utf-8"..        
-00004c50: 7365 6c66 2e6c 6f67 2862 6f64 792e 7273  self.log(body.rs
-00004c60: 7472 6970 2829 290a 2020 2020 2020 2020  trip()).        
-00004c70: 7365 6c66 2e72 6570 6c79 2862 6f64 792e  self.reply(body.
-00004c80: 656e 636f 6465 2822 7574 662d 3822 2920  encode("utf-8") 
-00004c90: 2b20 6222 5c72 5c6e 222c 202a 6c69 7374  + b"\r\n", *list
-00004ca0: 2861 7267 7329 2c20 2a2a 6b77 6172 6773  (args), **kwargs
-00004cb0: 290a 0a20 2020 2064 6566 2075 726c 7128  )..    def urlq(
-00004cc0: 7365 6c66 2c20 6164 6420 202c 2072 6d20  self, add  , rm 
-00004cd0: 2920 203a 0a20 2020 2020 2020 2022 2222  )  :.        """
-00004ce0: 0a20 2020 2020 2020 2067 656e 6572 6174  .        generat
-00004cf0: 6573 2075 726c 2071 7565 7279 2062 6173  es url query bas
-00004d00: 6564 206f 6e20 7570 6172 616d 2028 622c  ed on uparam (b,
-00004d10: 2070 772c 2061 6c6c 206f 7468 6572 7329   pw, all others)
-00004d20: 0a20 2020 2020 2020 2072 656d 6f76 696e  .        removin
-00004d30: 6720 616e 7974 6869 6e67 2069 6e20 726d  g anything in rm
-00004d40: 2c20 6164 6469 6e67 2070 6169 7273 2069  , adding pairs i
-00004d50: 6e20 6164 640a 0a20 2020 2020 2020 2061  n add..        a
-00004d60: 6c73 6f20 6c69 7374 2066 6173 7465 7220  lso list faster 
-00004d70: 7468 616e 2073 6574 2075 6e74 696c 207e  than set until ~
-00004d80: 3230 2069 7465 6d73 0a20 2020 2020 2020  20 items.       
-00004d90: 2022 2222 0a0a 2020 2020 2020 2020 6966   """..        if
-00004da0: 2073 656c 662e 6973 5f72 636c 6f6e 653a   self.is_rclone:
-00004db0: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-00004dc0: 7572 6e20 2222 0a0a 2020 2020 2020 2020  urn ""..        
-00004dd0: 6b76 203d 207b 6b3a 207a 7320 666f 7220  kv = {k: zs for 
-00004de0: 6b2c 207a 7320 696e 2073 656c 662e 7570  k, zs in self.up
-00004df0: 6172 616d 2e69 7465 6d73 2829 2069 6620  aram.items() if 
-00004e00: 6b20 6e6f 7420 696e 2072 6d7d 0a20 2020  k not in rm}.   
-00004e10: 2020 2020 2069 6620 2270 7722 2069 6e20       if "pw" in 
-00004e20: 6b76 3a0a 2020 2020 2020 2020 2020 2020  kv:.            
-00004e30: 7077 203d 2073 656c 662e 636f 6f6b 6965  pw = self.cookie
-00004e40: 732e 6765 7428 2263 7070 7773 2229 206f  s.get("cppws") o
-00004e50: 7220 7365 6c66 2e63 6f6f 6b69 6573 2e67  r self.cookies.g
-00004e60: 6574 2822 6370 7077 6422 290a 2020 2020  et("cppwd").    
-00004e70: 2020 2020 2020 2020 6966 206b 765b 2270          if kv["p
-00004e80: 7722 5d20 3d3d 2070 773a 0a20 2020 2020  w"] == pw:.     
-00004e90: 2020 2020 2020 2020 2020 2064 656c 206b             del k
-00004ea0: 765b 2270 7722 5d0a 0a20 2020 2020 2020  v["pw"]..       
-00004eb0: 206b 762e 7570 6461 7465 2861 6464 290a   kv.update(add).
-00004ec0: 2020 2020 2020 2020 6966 206e 6f74 206b          if not k
-00004ed0: 763a 0a20 2020 2020 2020 2020 2020 2072  v:.            r
-00004ee0: 6574 7572 6e20 2222 0a0a 2020 2020 2020  eturn ""..      
-00004ef0: 2020 7220 3d20 5b22 2573 3d25 7322 2025    r = ["%s=%s" %
-00004f00: 2028 6b2c 2071 756f 7465 7028 7a73 2929   (k, quotep(zs))
-00004f10: 2069 6620 7a73 2065 6c73 6520 6b20 666f   if zs else k fo
-00004f20: 7220 6b2c 207a 7320 696e 206b 762e 6974  r k, zs in kv.it
-00004f30: 656d 7328 295d 0a20 2020 2020 2020 2072  ems()].        r
-00004f40: 6574 7572 6e20 223f 2220 2b20 2226 616d  eturn "?" + "&am
-00004f50: 703b 222e 6a6f 696e 2872 290a 0a20 2020  p;".join(r)..   
-00004f60: 2064 6566 2072 6564 6972 6563 7428 0a20   def redirect(. 
-00004f70: 2020 2020 2020 2073 656c 662c 0a20 2020         self,.   
-00004f80: 2020 2020 2076 7061 7468 202c 0a20 2020       vpath ,.   
-00004f90: 2020 2020 2073 7566 2020 3d20 2222 2c0a       suf  = "",.
-00004fa0: 2020 2020 2020 2020 6d73 6720 203d 2022          msg  = "
-00004fb0: 6169 6768 7422 2c0a 2020 2020 2020 2020  aight",.        
-00004fc0: 666c 6176 6f72 2020 3d20 2267 6f20 746f  flavor  = "go to
-00004fd0: 222c 0a20 2020 2020 2020 2063 6c69 636b  ",.        click
-00004fe0: 2020 3d20 5472 7565 2c0a 2020 2020 2020    = True,.      
-00004ff0: 2020 7374 6174 7573 2020 3d20 3230 302c    status  = 200,
-00005000: 0a20 2020 2020 2020 2075 7365 3330 3220  .        use302 
-00005010: 203d 2046 616c 7365 2c0a 2020 2020 2920   = False,.    ) 
-00005020: 203a 0a20 2020 2020 2020 2076 7020 3d20   :.        vp = 
-00005030: 7365 6c66 2e61 7267 732e 5253 202b 2076  self.args.RS + v
-00005040: 7061 7468 0a20 2020 2020 2020 2068 746d  path.        htm
-00005050: 6c20 3d20 7365 6c66 2e6a 3273 280a 2020  l = self.j2s(.  
-00005060: 2020 2020 2020 2020 2020 226d 7367 222c            "msg",
-00005070: 0a20 2020 2020 2020 2020 2020 2068 323d  .            h2=
-00005080: 273c 6120 6872 6566 3d22 2f7b 7d22 3e7b  '<a href="/{}">{
-00005090: 7d20 2f7b 7d3c 2f61 3e27 2e66 6f72 6d61  } /{}</a>'.forma
-000050a0: 7428 0a20 2020 2020 2020 2020 2020 2020  t(.             
-000050b0: 2020 2071 756f 7465 7028 7670 2920 2b20     quotep(vp) + 
-000050c0: 7375 662c 2066 6c61 766f 722c 2068 746d  suf, flavor, htm
-000050d0: 6c5f 6573 6361 7065 2876 702c 2063 726c  l_escape(vp, crl
-000050e0: 663d 5472 7565 2920 2b20 7375 660a 2020  f=True) + suf.  
-000050f0: 2020 2020 2020 2020 2020 292c 0a20 2020            ),.   
-00005100: 2020 2020 2020 2020 2070 7265 3d6d 7367           pre=msg
-00005110: 2c0a 2020 2020 2020 2020 2020 2020 636c  ,.            cl
-00005120: 6963 6b3d 636c 6963 6b2c 0a20 2020 2020  ick=click,.     
-00005130: 2020 2029 2e65 6e63 6f64 6528 2275 7466     ).encode("utf
-00005140: 2d38 222c 2022 7265 706c 6163 6522 290a  -8", "replace").
-00005150: 0a20 2020 2020 2020 2069 6620 7573 6533  .        if use3
-00005160: 3032 3a0a 2020 2020 2020 2020 2020 2020  02:.            
-00005170: 7365 6c66 2e72 6570 6c79 2868 746d 6c2c  self.reply(html,
-00005180: 2073 7461 7475 733d 3330 322c 2068 6561   status=302, hea
-00005190: 6465 7273 3d7b 224c 6f63 6174 696f 6e22  ders={"Location"
-000051a0: 3a20 222f 2220 2b20 7670 6174 687d 290a  : "/" + vpath}).
-000051b0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-000051c0: 2020 2020 2020 2020 2020 7365 6c66 2e72            self.r
-000051d0: 6570 6c79 2868 746d 6c2c 2073 7461 7475  eply(html, statu
-000051e0: 733d 7374 6174 7573 290a 0a20 2020 2020  s=status)..     
-000051f0: 2020 2072 6574 7572 6e20 5472 7565 0a0a     return True..
-00005200: 2020 2020 6465 6620 5f63 6f72 7328 7365      def _cors(se
-00005210: 6c66 2920 203a 0a20 2020 2020 2020 2069  lf)  :.        i
-00005220: 6820 3d20 7365 6c66 2e68 6561 6465 7273  h = self.headers
-00005230: 0a20 2020 2020 2020 206f 7269 6769 6e20  .        origin 
-00005240: 3d20 6968 2e67 6574 2822 6f72 6967 696e  = ih.get("origin
-00005250: 2229 0a20 2020 2020 2020 2069 6620 6e6f  ").        if no
-00005260: 7420 6f72 6967 696e 3a0a 2020 2020 2020  t origin:.      
-00005270: 2020 2020 2020 7366 7369 7465 203d 2069        sfsite = i
-00005280: 682e 6765 7428 2273 6563 2d66 6574 6368  h.get("sec-fetch
-00005290: 2d73 6974 6522 290a 2020 2020 2020 2020  -site").        
-000052a0: 2020 2020 6966 2073 6673 6974 6520 616e      if sfsite an
-000052b0: 6420 7366 7369 7465 2e6c 6f77 6572 2829  d sfsite.lower()
-000052c0: 2e73 7461 7274 7377 6974 6828 2263 726f  .startswith("cro
-000052d0: 7373 2229 3a0a 2020 2020 2020 2020 2020  ss"):.          
-000052e0: 2020 2020 2020 6f72 6967 696e 203d 2022        origin = "
-000052f0: 3a7c 2220 2023 2073 616e 6462 6f78 6564  :|"  # sandboxed
-00005300: 2069 6672 616d 650a 2020 2020 2020 2020   iframe.        
-00005310: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-00005320: 2020 2020 2020 2020 2020 7265 7475 726e            return
-00005330: 2054 7275 650a 0a20 2020 2020 2020 206f   True..        o
-00005340: 6820 3d20 7365 6c66 2e6f 7574 5f68 6561  h = self.out_hea
-00005350: 6465 7273 0a20 2020 2020 2020 206f 7269  ders.        ori
-00005360: 6769 6e20 3d20 6f72 6967 696e 2e6c 6f77  gin = origin.low
-00005370: 6572 2829 0a20 2020 2020 2020 2067 6f6f  er().        goo
-00005380: 645f 6f72 6967 696e 7320 3d20 7365 6c66  d_origins = self
-00005390: 2e61 7267 732e 6163 616f 202b 205b 0a20  .args.acao + [. 
-000053a0: 2020 2020 2020 2020 2020 2022 7b7d 3a2f             "{}:/
-000053b0: 2f7b 7d22 2e66 6f72 6d61 7428 0a20 2020  /{}".format(.   
-000053c0: 2020 2020 2020 2020 2020 2020 2022 6874               "ht
-000053d0: 7470 7322 2069 6620 7365 6c66 2e69 735f  tps" if self.is_
-000053e0: 6874 7470 7320 656c 7365 2022 6874 7470  https else "http
-000053f0: 222c 0a20 2020 2020 2020 2020 2020 2020  ",.             
-00005400: 2020 2073 656c 662e 686f 7374 2e6c 6f77     self.host.low
-00005410: 6572 2829 2e73 706c 6974 2822 3a22 295b  er().split(":")[
-00005420: 305d 2c0a 2020 2020 2020 2020 2020 2020  0],.            
-00005430: 290a 2020 2020 2020 2020 5d0a 2020 2020  ).        ].    
-00005440: 2020 2020 6966 2072 652e 7375 6228 7222      if re.sub(r"
-00005450: 283a 5b30 2d39 5d7b 312c 357d 293f 2f3f  (:[0-9]{1,5})?/?
-00005460: 2422 2c20 2222 2c20 6f72 6967 696e 2920  $", "", origin) 
-00005470: 696e 2067 6f6f 645f 6f72 6967 696e 733a  in good_origins:
-00005480: 0a20 2020 2020 2020 2020 2020 2067 6f6f  .            goo
-00005490: 645f 6f72 6967 696e 203d 2054 7275 650a  d_origin = True.
-000054a0: 2020 2020 2020 2020 2020 2020 6261 645f              bad_
-000054b0: 6864 7273 203d 2028 2222 2c29 0a20 2020  hdrs = ("",).   
-000054c0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-000054d0: 2020 2020 2020 2067 6f6f 645f 6f72 6967         good_orig
-000054e0: 696e 203d 2046 616c 7365 0a20 2020 2020  in = False.     
-000054f0: 2020 2020 2020 2062 6164 5f68 6472 7320         bad_hdrs 
-00005500: 3d20 2822 222c 2022 7077 2229 0a0a 2020  = ("", "pw")..  
-00005510: 2020 2020 2020 2320 272a 2720 626c 6f63        # '*' bloc
-00005520: 6b73 2061 6c6c 2063 7265 6465 6e74 6961  ks all credentia
-00005530: 6c73 2028 636f 6f6b 6965 732c 2068 7474  ls (cookies, htt
-00005540: 702d 6175 7468 293b 0a20 2020 2020 2020  p-auth);.       
-00005550: 2023 2065 7861 6374 2d6d 6174 6368 2066   # exact-match f
-00005560: 6f72 204f 7269 6769 6e20 6973 206e 6563  or Origin is nec
-00005570: 6573 7361 7279 2074 6f20 756e 6c6f 636b  essary to unlock
-00005580: 2074 686f 7365 2c0a 2020 2020 2020 2020   those,.        
-00005590: 2320 686f 7765 7665 7220 796f 6c6f 2d72  # however yolo-r
-000055a0: 6571 7565 7374 7320 283f 7077 3d29 2061  equests (?pw=) a
-000055b0: 7265 2061 6c77 6179 7320 616c 6c6f 7765  re always allowe
-000055c0: 640a 2020 2020 2020 2020 6163 6168 203d  d.        acah =
-000055d0: 2069 682e 6765 7428 2261 6363 6573 732d   ih.get("access-
-000055e0: 636f 6e74 726f 6c2d 7265 7175 6573 742d  control-request-
-000055f0: 6865 6164 6572 7322 2c20 2222 290a 2020  headers", "").  
-00005600: 2020 2020 2020 6163 616f 203d 2028 6f72        acao = (or
-00005610: 6967 696e 2069 6620 676f 6f64 5f6f 7269  igin if good_ori
-00005620: 6769 6e20 656c 7365 204e 6f6e 6529 206f  gin else None) o
-00005630: 7220 280a 2020 2020 2020 2020 2020 2020  r (.            
-00005640: 222a 2220 6966 2022 2a22 2069 6e20 676f  "*" if "*" in go
-00005650: 6f64 5f6f 7269 6769 6e73 2065 6c73 6520  od_origins else 
-00005660: 4e6f 6e65 0a20 2020 2020 2020 2029 0a20  None.        ). 
-00005670: 2020 2020 2020 2069 6620 7365 6c66 2e61         if self.a
-00005680: 7267 732e 616c 6c6f 775f 6373 7266 3a0a  rgs.allow_csrf:.
-00005690: 2020 2020 2020 2020 2020 2020 6163 616f              acao
-000056a0: 203d 206f 7269 6769 6e20 6f72 2061 6361   = origin or aca
-000056b0: 6f20 6f72 2022 2a22 2020 2320 6578 706c  o or "*"  # expl
-000056c0: 6963 6974 6c79 2070 6572 6d69 7420 696d  icitly permit im
-000056d0: 7065 7273 6f6e 6174 696f 6e0a 2020 2020  personation.    
-000056e0: 2020 2020 2020 2020 6163 616d 203d 2022          acam = "
-000056f0: 2c20 222e 6a6f 696e 2873 656c 662e 636f  , ".join(self.co
-00005700: 6e6e 2e68 7372 762e 6d61 6c6c 6f77 2920  nn.hsrv.mallow) 
-00005710: 2023 2061 6e64 2061 6c6c 206d 6574 686f   # and all metho
-00005720: 6473 202b 2068 6561 6465 7273 0a20 2020  ds + headers.   
-00005730: 2020 2020 2020 2020 206f 685b 2241 6363           oh["Acc
-00005740: 6573 732d 436f 6e74 726f 6c2d 416c 6c6f  ess-Control-Allo
-00005750: 772d 4372 6564 656e 7469 616c 7322 5d20  w-Credentials"] 
-00005760: 3d20 2274 7275 6522 0a20 2020 2020 2020  = "true".       
-00005770: 2020 2020 2067 6f6f 645f 6f72 6967 696e       good_origin
-00005780: 203d 2054 7275 650a 2020 2020 2020 2020   = True.        
-00005790: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-000057a0: 2020 6163 616d 203d 2022 2c20 222e 6a6f    acam = ", ".jo
-000057b0: 696e 2873 656c 662e 6172 6773 2e61 6361  in(self.args.aca
-000057c0: 6d29 0a20 2020 2020 2020 2020 2020 2023  m).            #
-000057d0: 2077 6173 6820 636c 6965 6e74 2d72 6571   wash client-req
-000057e0: 7565 7374 6564 2068 6561 6465 7273 2061  uested headers a
-000057f0: 6e64 2072 6f6c 6c20 7769 7468 2074 6861  nd roll with tha
-00005800: 740a 2020 2020 2020 2020 2020 2020 6966  t.            if
-00005810: 2022 7261 6e67 6522 206e 6f74 2069 6e20   "range" not in 
-00005820: 6163 6168 2e6c 6f77 6572 2829 3a0a 2020  acah.lower():.  
-00005830: 2020 2020 2020 2020 2020 2020 2020 6163                ac
-00005840: 6168 202b 3d20 222c 5261 6e67 6522 2020  ah += ",Range"  
-00005850: 2320 6669 7265 666f 780a 2020 2020 2020  # firefox.      
-00005860: 2020 2020 2020 7265 715f 6820 3d20 6163        req_h = ac
-00005870: 6168 2e73 706c 6974 2822 2c22 290a 2020  ah.split(",").  
-00005880: 2020 2020 2020 2020 2020 7265 715f 6820            req_h 
-00005890: 3d20 5b78 2e73 7472 6970 2829 2066 6f72  = [x.strip() for
-000058a0: 2078 2069 6e20 7265 715f 685d 0a20 2020   x in req_h].   
-000058b0: 2020 2020 2020 2020 2072 6571 5f68 203d           req_h =
-000058c0: 205b 7820 666f 7220 7820 696e 2072 6571   [x for x in req
-000058d0: 5f68 2069 6620 782e 6c6f 7765 7228 2920  _h if x.lower() 
-000058e0: 6e6f 7420 696e 2062 6164 5f68 6472 735d  not in bad_hdrs]
-000058f0: 0a20 2020 2020 2020 2020 2020 2061 6361  .            aca
-00005900: 6820 3d20 222c 2022 2e6a 6f69 6e28 7265  h = ", ".join(re
-00005910: 715f 6829 0a0a 2020 2020 2020 2020 6966  q_h)..        if
-00005920: 206e 6f74 2061 6361 6f3a 0a20 2020 2020   not acao:.     
-00005930: 2020 2020 2020 2072 6574 7572 6e20 4661         return Fa
-00005940: 6c73 650a 0a20 2020 2020 2020 206f 685b  lse..        oh[
-00005950: 2241 6363 6573 732d 436f 6e74 726f 6c2d  "Access-Control-
-00005960: 416c 6c6f 772d 4f72 6967 696e 225d 203d  Allow-Origin"] =
-00005970: 2061 6361 6f0a 2020 2020 2020 2020 6f68   acao.        oh
-00005980: 5b22 4163 6365 7373 2d43 6f6e 7472 6f6c  ["Access-Control
-00005990: 2d41 6c6c 6f77 2d4d 6574 686f 6473 225d  -Allow-Methods"]
-000059a0: 203d 2061 6361 6d2e 7570 7065 7228 290a   = acam.upper().
-000059b0: 2020 2020 2020 2020 6966 2061 6361 683a          if acah:
-000059c0: 0a20 2020 2020 2020 2020 2020 206f 685b  .            oh[
-000059d0: 2241 6363 6573 732d 436f 6e74 726f 6c2d  "Access-Control-
-000059e0: 416c 6c6f 772d 4865 6164 6572 7322 5d20  Allow-Headers"] 
-000059f0: 3d20 6163 6168 0a0a 2020 2020 2020 2020  = acah..        
-00005a00: 7265 7475 726e 2067 6f6f 645f 6f72 6967  return good_orig
-00005a10: 696e 0a0a 2020 2020 6465 6620 6861 6e64  in..    def hand
-00005a20: 6c65 5f67 6574 2873 656c 6629 2020 3a0a  le_get(self)  :.
-00005a30: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
-00005a40: 646f 5f6c 6f67 3a0a 2020 2020 2020 2020  do_log:.        
-00005a50: 2020 2020 6c6f 676d 7367 203d 2022 7b3a      logmsg = "{:
-00005a60: 347d 207b 7d22 2e66 6f72 6d61 7428 7365  4} {}".format(se
-00005a70: 6c66 2e6d 6f64 652c 2073 656c 662e 7265  lf.mode, self.re
-00005a80: 7129 0a0a 2020 2020 2020 2020 2020 2020  q)..            
-00005a90: 6966 2022 7261 6e67 6522 2069 6e20 7365  if "range" in se
-00005aa0: 6c66 2e68 6561 6465 7273 3a0a 2020 2020  lf.headers:.    
-00005ab0: 2020 2020 2020 2020 2020 2020 7472 793a              try:
-00005ac0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00005ad0: 2020 2020 2072 7661 6c20 3d20 7365 6c66       rval = self
-00005ae0: 2e68 6561 6465 7273 5b22 7261 6e67 6522  .headers["range"
-00005af0: 5d2e 7370 6c69 7428 223d 222c 2031 295b  ].split("=", 1)[
-00005b00: 315d 0a20 2020 2020 2020 2020 2020 2020  1].             
-00005b10: 2020 2065 7863 6570 743a 0a20 2020 2020     except:.     
-00005b20: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-00005b30: 7661 6c20 3d20 7365 6c66 2e68 6561 6465  val = self.heade
-00005b40: 7273 5b22 7261 6e67 6522 5d0a 0a20 2020  rs["range"]..   
-00005b50: 2020 2020 2020 2020 2020 2020 206c 6f67               log
-00005b60: 6d73 6720 2b3d 2022 205b 5c30 3333 5b33  msg += " [\033[3
-00005b70: 366d 2220 2b20 7276 616c 202b 2022 5c30  6m" + rval + "\0
-00005b80: 3333 5b30 6d5d 220a 0a20 2020 2020 2020  33[0m]"..       
-00005b90: 2020 2020 2073 656c 662e 6c6f 6728 6c6f       self.log(lo
-00005ba0: 676d 7367 290a 0a20 2020 2020 2020 2023  gmsg)..        #
-00005bb0: 2022 656d 6265 6464 6564 2220 7265 736f   "embedded" reso
-00005bc0: 7572 6365 730a 2020 2020 2020 2020 6966  urces.        if
-00005bd0: 2073 656c 662e 7670 6174 682e 7374 6172   self.vpath.star
-00005be0: 7473 7769 7468 2822 2e63 7072 2229 3a0a  tswith(".cpr"):.
-00005bf0: 2020 2020 2020 2020 2020 2020 6966 2073              if s
-00005c00: 656c 662e 7670 6174 682e 7374 6172 7473  elf.vpath.starts
-00005c10: 7769 7468 2822 2e63 7072 2f69 636f 2f22  with(".cpr/ico/"
-00005c20: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-00005c30: 2020 2072 6574 7572 6e20 7365 6c66 2e74     return self.t
-00005c40: 785f 6963 6f28 7365 6c66 2e76 7061 7468  x_ico(self.vpath
-00005c50: 2e73 706c 6974 2822 2f22 295b 2d31 5d2c  .split("/")[-1],
-00005c60: 2065 7861 6374 3d54 7275 6529 0a0a 2020   exact=True)..  
-00005c70: 2020 2020 2020 2020 2020 6966 2073 656c            if sel
-00005c80: 662e 7670 6174 682e 7374 6172 7473 7769  f.vpath.startswi
-00005c90: 7468 2822 2e63 7072 2f73 7364 7022 293a  th(".cpr/ssdp"):
-00005ca0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00005cb0: 2072 6574 7572 6e20 7365 6c66 2e63 6f6e   return self.con
-00005cc0: 6e2e 6873 7276 2e73 7364 702e 7265 706c  n.hsrv.ssdp.repl
-00005cd0: 7928 7365 6c66 290a 0a20 2020 2020 2020  y(self)..       
-00005ce0: 2020 2020 2069 6620 7365 6c66 2e76 7061       if self.vpa
-00005cf0: 7468 2e73 7461 7274 7377 6974 6828 222e  th.startswith(".
-00005d00: 6370 722f 6464 2f22 2920 616e 6420 7365  cpr/dd/") and se
-00005d10: 6c66 2e61 7267 732e 6d70 6d63 3a0a 2020  lf.args.mpmc:.  
-00005d20: 2020 2020 2020 2020 2020 2020 2020 6966                if
-00005d30: 2073 656c 662e 6172 6773 2e6d 706d 6320   self.args.mpmc 
-00005d40: 3d3d 2022 2e22 3a0a 2020 2020 2020 2020  == ".":.        
-00005d50: 2020 2020 2020 2020 2020 2020 7261 6973              rais
-00005d60: 6520 5065 626b 6163 2834 3034 290a 0a20  e Pebkac(404).. 
-00005d70: 2020 2020 2020 2020 2020 2020 2020 206c                 l
-00005d80: 6f63 203d 2073 656c 662e 6172 6773 2e6d  oc = self.args.m
-00005d90: 706d 632e 7273 7472 6970 2822 2f22 2920  pmc.rstrip("/") 
-00005da0: 2b20 7365 6c66 2e76 7061 7468 5b73 656c  + self.vpath[sel
-00005db0: 662e 7670 6174 682e 7266 696e 6428 222f  f.vpath.rfind("/
-00005dc0: 2229 203a 5d0a 2020 2020 2020 2020 2020  ") :].          
-00005dd0: 2020 2020 2020 6820 3d20 7b22 4c6f 6361        h = {"Loca
-00005de0: 7469 6f6e 223a 206c 6f63 2c20 2243 6163  tion": loc, "Cac
-00005df0: 6865 2d43 6f6e 7472 6f6c 223a 2022 6d61  he-Control": "ma
-00005e00: 782d 6167 653d 3339 227d 0a20 2020 2020  x-age=39"}.     
-00005e10: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-00005e20: 7265 706c 7928 6222 222c 2033 3031 2c20  reply(b"", 301, 
-00005e30: 6865 6164 6572 733d 6829 0a20 2020 2020  headers=h).     
-00005e40: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-00005e50: 6e20 5472 7565 0a0a 2020 2020 2020 2020  n True..        
-00005e60: 2020 2020 7374 6174 6963 5f70 6174 6820      static_path 
-00005e70: 3d20 6f73 2e70 6174 682e 6a6f 696e 2873  = os.path.join(s
-00005e80: 656c 662e 452e 6d6f 642c 2022 7765 622f  elf.E.mod, "web/
-00005e90: 222c 2073 656c 662e 7670 6174 685b 353a  ", self.vpath[5:
-00005ea0: 5d29 0a20 2020 2020 2020 2020 2020 2072  ]).            r
-00005eb0: 6574 7572 6e20 7365 6c66 2e74 785f 6669  eturn self.tx_fi
-00005ec0: 6c65 2873 7461 7469 635f 7061 7468 290a  le(static_path).
-00005ed0: 0a20 2020 2020 2020 2069 6620 2263 665f  .        if "cf_
-00005ee0: 6368 616c 6c65 6e67 6522 2069 6e20 7365  challenge" in se
-00005ef0: 6c66 2e75 7061 7261 6d3a 0a20 2020 2020  lf.uparam:.     
-00005f00: 2020 2020 2020 2073 656c 662e 7265 706c         self.repl
-00005f10: 7928 7365 6c66 2e6a 3273 2822 6366 2229  y(self.j2s("cf")
-00005f20: 2e65 6e63 6f64 6528 2275 7466 2d38 222c  .encode("utf-8",
-00005f30: 2022 7265 706c 6163 6522 2929 0a20 2020   "replace")).   
-00005f40: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-00005f50: 5472 7565 0a0a 2020 2020 2020 2020 6966  True..        if
-00005f60: 206e 6f74 2073 656c 662e 6361 6e5f 7265   not self.can_re
-00005f70: 6164 2061 6e64 206e 6f74 2073 656c 662e  ad and not self.
-00005f80: 6361 6e5f 7772 6974 6520 616e 6420 6e6f  can_write and no
-00005f90: 7420 7365 6c66 2e63 616e 5f67 6574 3a0a  t self.can_get:.
-00005fa0: 2020 2020 2020 2020 2020 2020 6966 2073              if s
-00005fb0: 656c 662e 7670 6174 683a 0a20 2020 2020  elf.vpath:.     
-00005fc0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-00005fd0: 6c6f 6728 2269 6e61 6363 6573 7369 626c  log("inaccessibl
-00005fe0: 653a 205b 7b7d 5d22 2e66 6f72 6d61 7428  e: [{}]".format(
-00005ff0: 7365 6c66 2e76 7061 7468 2929 0a20 2020  self.vpath)).   
-00006000: 2020 2020 2020 2020 2020 2020 2072 6574               ret
-00006010: 7572 6e20 7365 6c66 2e74 785f 3430 3428  urn self.tx_404(
-00006020: 5472 7565 290a 0a20 2020 2020 2020 2020  True)..         
-00006030: 2020 2073 656c 662e 7570 6172 616d 5b22     self.uparam["
-00006040: 6822 5d20 3d20 2222 0a0a 2020 2020 2020  h"] = ""..      
-00006050: 2020 6966 2022 7472 6565 2220 696e 2073    if "tree" in s
-00006060: 656c 662e 7570 6172 616d 3a0a 2020 2020  elf.uparam:.    
-00006070: 2020 2020 2020 2020 7265 7475 726e 2073          return s
-00006080: 656c 662e 7478 5f74 7265 6528 290a 0a20  elf.tx_tree().. 
-00006090: 2020 2020 2020 2069 6620 2273 6361 6e22         if "scan"
-000060a0: 2069 6e20 7365 6c66 2e75 7061 7261 6d3a   in self.uparam:
-000060b0: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-000060c0: 7572 6e20 7365 6c66 2e73 6361 6e76 6f6c  urn self.scanvol
-000060d0: 2829 0a0a 2020 2020 2020 2020 6966 2073  ()..        if s
-000060e0: 656c 662e 6172 6773 2e67 6574 6d6f 643a  elf.args.getmod:
-000060f0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-00006100: 2264 656c 6574 6522 2069 6e20 7365 6c66  "delete" in self
-00006110: 2e75 7061 7261 6d3a 0a20 2020 2020 2020  .uparam:.       
-00006120: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-00006130: 7365 6c66 2e68 616e 646c 655f 726d 285b  self.handle_rm([
-00006140: 5d29 0a0a 2020 2020 2020 2020 2020 2020  ])..            
-00006150: 6966 2022 6d6f 7665 2220 696e 2073 656c  if "move" in sel
-00006160: 662e 7570 6172 616d 3a0a 2020 2020 2020  f.uparam:.      
-00006170: 2020 2020 2020 2020 2020 7265 7475 726e            return
-00006180: 2073 656c 662e 6861 6e64 6c65 5f6d 7628   self.handle_mv(
-00006190: 290a 0a20 2020 2020 2020 2069 6620 6e6f  )..        if no
-000061a0: 7420 7365 6c66 2e76 7061 7468 3a0a 2020  t self.vpath:.  
-000061b0: 2020 2020 2020 2020 2020 6966 2022 7265            if "re
-000061c0: 6c6f 6164 2220 696e 2073 656c 662e 7570  load" in self.up
-000061d0: 6172 616d 3a0a 2020 2020 2020 2020 2020  aram:.          
-000061e0: 2020 2020 2020 7265 7475 726e 2073 656c        return sel
-000061f0: 662e 6861 6e64 6c65 5f72 656c 6f61 6428  f.handle_reload(
-00006200: 290a 0a20 2020 2020 2020 2020 2020 2069  )..            i
-00006210: 6620 2273 7461 636b 2220 696e 2073 656c  f "stack" in sel
-00006220: 662e 7570 6172 616d 3a0a 2020 2020 2020  f.uparam:.      
-00006230: 2020 2020 2020 2020 2020 7265 7475 726e            return
-00006240: 2073 656c 662e 7478 5f73 7461 636b 2829   self.tx_stack()
-00006250: 0a0a 2020 2020 2020 2020 2020 2020 6966  ..            if
-00006260: 2022 7570 7322 2069 6e20 7365 6c66 2e75   "ups" in self.u
-00006270: 7061 7261 6d3a 0a20 2020 2020 2020 2020  param:.         
-00006280: 2020 2020 2020 2072 6574 7572 6e20 7365         return se
-00006290: 6c66 2e74 785f 7570 7328 290a 0a20 2020  lf.tx_ups()..   
-000062a0: 2020 2020 2020 2020 2069 6620 226b 3330           if "k30
-000062b0: 3422 2069 6e20 7365 6c66 2e75 7061 7261  4" in self.upara
-000062c0: 6d3a 0a20 2020 2020 2020 2020 2020 2020  m:.             
-000062d0: 2020 2072 6574 7572 6e20 7365 6c66 2e73     return self.s
-000062e0: 6574 5f6b 3330 3428 290a 0a20 2020 2020  et_k304()..     
-000062f0: 2020 2020 2020 2069 6620 2273 6574 636b         if "setck
-00006300: 2220 696e 2073 656c 662e 7570 6172 616d  " in self.uparam
-00006310: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00006320: 2020 7265 7475 726e 2073 656c 662e 7365    return self.se
-00006330: 7463 6b28 290a 0a20 2020 2020 2020 2020  tck()..         
-00006340: 2020 2069 6620 2272 6573 6574 2220 696e     if "reset" in
-00006350: 2073 656c 662e 7570 6172 616d 3a0a 2020   self.uparam:.  
-00006360: 2020 2020 2020 2020 2020 2020 2020 7265                re
-00006370: 7475 726e 2073 656c 662e 7365 745f 6366  turn self.set_cf
-00006380: 675f 7265 7365 7428 290a 0a20 2020 2020  g_reset()..     
-00006390: 2020 2020 2020 2069 6620 2268 6322 2069         if "hc" i
-000063a0: 6e20 7365 6c66 2e75 7061 7261 6d3a 0a20  n self.uparam:. 
-000063b0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-000063c0: 6574 7572 6e20 7365 6c66 2e74 785f 7376  eturn self.tx_sv
-000063d0: 6373 2829 0a0a 2020 2020 2020 2020 6966  cs()..        if
-000063e0: 2022 6822 2069 6e20 7365 6c66 2e75 7061   "h" in self.upa
-000063f0: 7261 6d3a 0a20 2020 2020 2020 2020 2020  ram:.           
-00006400: 2072 6574 7572 6e20 7365 6c66 2e74 785f   return self.tx_
-00006410: 6d6f 756e 7473 2829 0a0a 2020 2020 2020  mounts()..      
-00006420: 2020 2320 636f 6e64 6974 696f 6e61 6c20    # conditional 
-00006430: 7265 6469 7265 6374 2074 6f20 7369 6e67  redirect to sing
-00006440: 6c65 2076 6f6c 756d 6573 0a20 2020 2020  le volumes.     
-00006450: 2020 2069 6620 7365 6c66 2e76 7061 7468     if self.vpath
-00006460: 203d 3d20 2222 2061 6e64 206e 6f74 2073   == "" and not s
-00006470: 656c 662e 6f75 7061 7261 6d3a 0a20 2020  elf.ouparam:.   
-00006480: 2020 2020 2020 2020 206e 7265 6164 203d           nread =
-00006490: 206c 656e 2873 656c 662e 7276 6f6c 290a   len(self.rvol).
-000064a0: 2020 2020 2020 2020 2020 2020 6e77 7269              nwri
-000064b0: 7465 203d 206c 656e 2873 656c 662e 7776  te = len(self.wv
-000064c0: 6f6c 290a 2020 2020 2020 2020 2020 2020  ol).            
-000064d0: 6966 206e 7265 6164 202b 206e 7772 6974  if nread + nwrit
-000064e0: 6520 3d3d 2031 206f 7220 2873 656c 662e  e == 1 or (self.
-000064f0: 7276 6f6c 203d 3d20 7365 6c66 2e77 766f  rvol == self.wvo
-00006500: 6c20 616e 6420 6e72 6561 6420 3d3d 2031  l and nread == 1
-00006510: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-00006520: 2020 2069 6620 6e72 6561 6420 3d3d 2031     if nread == 1
-00006530: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00006540: 2020 2020 2020 7670 6174 6820 3d20 7365        vpath = se
-00006550: 6c66 2e72 766f 6c5b 305d 0a20 2020 2020  lf.rvol[0].     
-00006560: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
-00006570: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00006580: 2020 2020 2076 7061 7468 203d 2073 656c       vpath = sel
-00006590: 662e 7776 6f6c 5b30 5d0a 0a20 2020 2020  f.wvol[0]..     
-000065a0: 2020 2020 2020 2020 2020 2069 6620 7365             if se
-000065b0: 6c66 2e76 7061 7468 2021 3d20 7670 6174  lf.vpath != vpat
-000065c0: 683a 0a20 2020 2020 2020 2020 2020 2020  h:.             
-000065d0: 2020 2020 2020 2073 656c 662e 7265 6469         self.redi
-000065e0: 7265 6374 2876 7061 7468 2c20 666c 6176  rect(vpath, flav
-000065f0: 6f72 3d22 7265 6469 7265 6374 696e 6720  or="redirecting 
-00006600: 746f 222c 2075 7365 3330 323d 5472 7565  to", use302=True
-00006610: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00006620: 2020 2020 2020 7265 7475 726e 2054 7275        return Tru
-00006630: 650a 0a20 2020 2020 2020 2072 6574 7572  e..        retur
-00006640: 6e20 7365 6c66 2e74 785f 6272 6f77 7365  n self.tx_browse
-00006650: 7228 290a 0a20 2020 2064 6566 2068 616e  r()..    def han
-00006660: 646c 655f 7072 6f70 6669 6e64 2873 656c  dle_propfind(sel
-00006670: 6629 2020 3a0a 2020 2020 2020 2020 6966  f)  :.        if
-00006680: 2073 656c 662e 646f 5f6c 6f67 3a0a 2020   self.do_log:.  
-00006690: 2020 2020 2020 2020 2020 7365 6c66 2e6c            self.l
-000066a0: 6f67 2822 5046 494e 4420 2220 2b20 7365  og("PFIND " + se
-000066b0: 6c66 2e72 6571 290a 0a20 2020 2020 2020  lf.req)..       
-000066c0: 2069 6620 7365 6c66 2e61 7267 732e 6e6f   if self.args.no
-000066d0: 5f64 6176 3a0a 2020 2020 2020 2020 2020  _dav:.          
-000066e0: 2020 7261 6973 6520 5065 626b 6163 2834    raise Pebkac(4
-000066f0: 3035 2c20 2257 6562 4441 5620 6973 2064  05, "WebDAV is d
-00006700: 6973 6162 6c65 6420 696e 2073 6572 7665  isabled in serve
-00006710: 7220 636f 6e66 6967 2229 0a0a 2020 2020  r config")..    
-00006720: 2020 2020 6966 206e 6f74 2073 656c 662e      if not self.
-00006730: 6361 6e5f 7265 6164 2061 6e64 206e 6f74  can_read and not
-00006740: 2073 656c 662e 6361 6e5f 7772 6974 6520   self.can_write 
-00006750: 616e 6420 6e6f 7420 7365 6c66 2e63 616e  and not self.can
-00006760: 5f67 6574 3a0a 2020 2020 2020 2020 2020  _get:.          
-00006770: 2020 6966 2073 656c 662e 7670 6174 683a    if self.vpath:
-00006780: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00006790: 2073 656c 662e 6c6f 6728 2269 6e61 6363   self.log("inacc
-000067a0: 6573 7369 626c 653a 205b 7b7d 5d22 2e66  essible: [{}]".f
-000067b0: 6f72 6d61 7428 7365 6c66 2e76 7061 7468  ormat(self.vpath
-000067c0: 2929 0a20 2020 2020 2020 2020 2020 2020  )).             
-000067d0: 2020 2072 6169 7365 2050 6562 6b61 6328     raise Pebkac(
-000067e0: 3430 312c 2022 6175 7468 656e 7469 6361  401, "authentica
-000067f0: 7465 2229 0a0a 2020 2020 2020 2020 2020  te")..          
-00006800: 2020 7365 6c66 2e75 7061 7261 6d5b 2268    self.uparam["h
-00006810: 225d 203d 2022 220a 0a20 2020 2020 2020  "] = ""..       
-00006820: 2066 726f 6d20 2e64 786d 6c20 696d 706f   from .dxml impo
-00006830: 7274 2070 6172 7365 5f78 6d6c 0a0a 2020  rt parse_xml..  
-00006840: 2020 2020 2020 2320 656e 6320 3d20 2277        # enc = "w
-00006850: 696e 646f 7773 2d33 316a 220a 2020 2020  indows-31j".    
-00006860: 2020 2020 2320 656e 6320 3d20 2273 6869      # enc = "shi
-00006870: 6674 5f6a 6973 220a 2020 2020 2020 2020  ft_jis".        
-00006880: 656e 6320 3d20 2275 7466 2d38 220a 2020  enc = "utf-8".  
-00006890: 2020 2020 2020 7565 6e63 203d 2065 6e63        uenc = enc
-000068a0: 2e75 7070 6572 2829 0a0a 2020 2020 2020  .upper()..      
-000068b0: 2020 636c 656e 203d 2069 6e74 2873 656c    clen = int(sel
-000068c0: 662e 6865 6164 6572 732e 6765 7428 2263  f.headers.get("c
-000068d0: 6f6e 7465 6e74 2d6c 656e 6774 6822 2c20  ontent-length", 
-000068e0: 3029 290a 2020 2020 2020 2020 6966 2063  0)).        if c
-000068f0: 6c65 6e3a 0a20 2020 2020 2020 2020 2020  len:.           
-00006900: 2062 7566 203d 2062 2222 0a20 2020 2020   buf = b"".     
-00006910: 2020 2020 2020 2066 6f72 2072 6275 6620         for rbuf 
-00006920: 696e 2073 656c 662e 6765 745f 626f 6479  in self.get_body
-00006930: 5f72 6561 6465 7228 295b 305d 3a0a 2020  _reader()[0]:.  
-00006940: 2020 2020 2020 2020 2020 2020 2020 6275                bu
-00006950: 6620 2b3d 2072 6275 660a 2020 2020 2020  f += rbuf.      
-00006960: 2020 2020 2020 2020 2020 6966 206e 6f74            if not
-00006970: 2072 6275 6620 6f72 206c 656e 2862 7566   rbuf or len(buf
-00006980: 2920 3e3d 2033 3237 3638 3a0a 2020 2020  ) >= 32768:.    
-00006990: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000069a0: 6272 6561 6b0a 0a20 2020 2020 2020 2020  break..         
-000069b0: 2020 2078 726f 6f74 203d 2070 6172 7365     xroot = parse
-000069c0: 5f78 6d6c 2862 7566 2e64 6563 6f64 6528  _xml(buf.decode(
-000069d0: 656e 632c 2022 7265 706c 6163 6522 2929  enc, "replace"))
-000069e0: 0a20 2020 2020 2020 2020 2020 2078 7461  .            xta
-000069f0: 6720 3d20 6e65 7874 2878 2066 6f72 2078  g = next(x for x
-00006a00: 2069 6e20 7872 6f6f 7420 6966 2078 2e74   in xroot if x.t
-00006a10: 6167 2e73 706c 6974 2822 7d22 295b 2d31  ag.split("}")[-1
-00006a20: 5d20 3d3d 2022 7072 6f70 2229 0a20 2020  ] == "prop").   
-00006a30: 2020 2020 2020 2020 2070 726f 7073 5f6c           props_l
-00006a40: 7374 203d 205b 792e 7461 672e 7370 6c69  st = [y.tag.spli
-00006a50: 7428 227d 2229 5b2d 315d 2066 6f72 2079  t("}")[-1] for y
-00006a60: 2069 6e20 7874 6167 5d0a 2020 2020 2020   in xtag].      
-00006a70: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-00006a80: 2020 2020 7072 6f70 735f 6c73 7420 3d20      props_lst = 
-00006a90: 5b0a 2020 2020 2020 2020 2020 2020 2020  [.              
-00006aa0: 2020 2263 6f6e 7465 6e74 636c 6173 7322    "contentclass"
-00006ab0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00006ac0: 2020 2263 7265 6174 696f 6e64 6174 6522    "creationdate"
-00006ad0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00006ae0: 2020 2264 6566 6175 6c74 646f 6375 6d65    "defaultdocume
-00006af0: 6e74 222c 0a20 2020 2020 2020 2020 2020  nt",.           
-00006b00: 2020 2020 2022 6469 7370 6c61 796e 616d       "displaynam
-00006b10: 6522 2c0a 2020 2020 2020 2020 2020 2020  e",.            
-00006b20: 2020 2020 2267 6574 636f 6e74 656e 746c      "getcontentl
-00006b30: 616e 6775 6167 6522 2c0a 2020 2020 2020  anguage",.      
-00006b40: 2020 2020 2020 2020 2020 2267 6574 636f            "getco
-00006b50: 6e74 656e 746c 656e 6774 6822 2c0a 2020  ntentlength",.  
-00006b60: 2020 2020 2020 2020 2020 2020 2020 2267                "g
-00006b70: 6574 636f 6e74 656e 7474 7970 6522 2c0a  etcontenttype",.
-00006b80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006b90: 2267 6574 6c61 7374 6d6f 6469 6669 6564  "getlastmodified
-00006ba0: 222c 0a20 2020 2020 2020 2020 2020 2020  ",.             
-00006bb0: 2020 2022 6872 6566 222c 0a20 2020 2020     "href",.     
-00006bc0: 2020 2020 2020 2020 2020 2022 6973 636f             "isco
-00006bd0: 6c6c 6563 7469 6f6e 222c 0a20 2020 2020  llection",.     
-00006be0: 2020 2020 2020 2020 2020 2022 6973 6869             "ishi
-00006bf0: 6464 656e 222c 0a20 2020 2020 2020 2020  dden",.         
-00006c00: 2020 2020 2020 2022 6973 7265 6164 6f6e         "isreadon
-00006c10: 6c79 222c 0a20 2020 2020 2020 2020 2020  ly",.           
-00006c20: 2020 2020 2022 6973 726f 6f74 222c 0a20       "isroot",. 
-00006c30: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-00006c40: 6973 7374 7275 6374 7572 6564 646f 6375  isstructureddocu
-00006c50: 6d65 6e74 222c 0a20 2020 2020 2020 2020  ment",.         
-00006c60: 2020 2020 2020 2022 6c61 7374 6163 6365         "lastacce
-00006c70: 7373 6564 222c 0a20 2020 2020 2020 2020  ssed",.         
-00006c80: 2020 2020 2020 2022 6e61 6d65 222c 0a20         "name",. 
-00006c90: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-00006ca0: 7061 7265 6e74 6e61 6d65 222c 0a20 2020  parentname",.   
-00006cb0: 2020 2020 2020 2020 2020 2020 2022 7265               "re
-00006cc0: 736f 7572 6365 7479 7065 222c 0a20 2020  sourcetype",.   
-00006cd0: 2020 2020 2020 2020 2020 2020 2022 7375               "su
-00006ce0: 7070 6f72 7465 646c 6f63 6b22 2c0a 2020  pportedlock",.  
-00006cf0: 2020 2020 2020 2020 2020 5d0a 0a20 2020            ]..   
-00006d00: 2020 2020 2070 726f 7073 203d 2073 6574       props = set
-00006d10: 2870 726f 7073 5f6c 7374 290a 2020 2020  (props_lst).    
-00006d20: 2020 2020 766e 2c20 7265 6d20 3d20 7365      vn, rem = se
-00006d30: 6c66 2e61 7372 762e 7666 732e 6765 7428  lf.asrv.vfs.get(
-00006d40: 7365 6c66 2e76 7061 7468 2c20 7365 6c66  self.vpath, self
-00006d50: 2e75 6e61 6d65 2c20 5472 7565 2c20 4661  .uname, True, Fa
-00006d60: 6c73 652c 2065 7272 3d34 3031 290a 2020  lse, err=401).  
-00006d70: 2020 2020 2020 7461 7020 3d20 766e 2e63        tap = vn.c
-00006d80: 616e 6f6e 6963 616c 2872 656d 290a 2020  anonical(rem).  
-00006d90: 2020 2020 2020 6465 7074 6820 3d20 7365        depth = se
-00006da0: 6c66 2e68 6561 6465 7273 2e67 6574 2822  lf.headers.get("
-00006db0: 6465 7074 6822 2c20 2269 6e66 696e 6974  depth", "infinit
-00006dc0: 7922 292e 6c6f 7765 7228 290a 0a20 2020  y").lower()..   
-00006dd0: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
-00006de0: 2020 2020 2020 746f 7064 6972 203d 207b        topdir = {
-00006df0: 2276 7022 3a20 2222 2c20 2273 7422 3a20  "vp": "", "st": 
-00006e00: 626f 732e 7374 6174 2874 6170 297d 0a20  bos.stat(tap)}. 
-00006e10: 2020 2020 2020 2065 7863 6570 7420 4f53         except OS
-00006e20: 4572 726f 7220 6173 2065 783a 0a20 2020  Error as ex:.   
-00006e30: 2020 2020 2020 2020 2069 6620 6578 2e65           if ex.e
-00006e40: 7272 6e6f 206e 6f74 2069 6e20 2865 7272  rrno not in (err
-00006e50: 6e6f 2e45 4e4f 454e 542c 2065 7272 6e6f  no.ENOENT, errno
-00006e60: 2e45 4e4f 5444 4952 293a 0a20 2020 2020  .ENOTDIR):.     
-00006e70: 2020 2020 2020 2020 2020 2072 6169 7365             raise
-00006e80: 0a20 2020 2020 2020 2020 2020 2072 6169  .            rai
-00006e90: 7365 2050 6562 6b61 6328 3430 3429 0a0a  se Pebkac(404)..
-00006ea0: 2020 2020 2020 2020 6966 206e 6f74 2073          if not s
-00006eb0: 7461 742e 535f 4953 4449 5228 746f 7064  tat.S_ISDIR(topd
-00006ec0: 6972 5b22 7374 225d 2e73 745f 6d6f 6465  ir["st"].st_mode
-00006ed0: 293a 0a20 2020 2020 2020 2020 2020 2066  ):.            f
-00006ee0: 6765 6e20 3d20 5b5d 0a0a 2020 2020 2020  gen = []..      
-00006ef0: 2020 656c 6966 2064 6570 7468 203d 3d20    elif depth == 
-00006f00: 2269 6e66 696e 6974 7922 3a0a 2020 2020  "infinity":.    
-00006f10: 2020 2020 2020 2020 6966 206e 6f74 2073          if not s
-00006f20: 656c 662e 6172 6773 2e64 6176 5f69 6e66  elf.args.dav_inf
-00006f30: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00006f40: 2020 7365 6c66 2e6c 6f67 2822 636c 6965    self.log("clie
-00006f50: 6e74 2077 616e 7473 202d 2d64 6176 2d69  nt wants --dav-i
-00006f60: 6e66 222c 2033 290a 2020 2020 2020 2020  nf", 3).        
-00006f70: 2020 2020 2020 2020 7a62 203d 2062 273c          zb = b'<
-00006f80: 3f78 6d6c 2076 6572 7369 6f6e 3d22 312e  ?xml version="1.
-00006f90: 3022 2065 6e63 6f64 696e 673d 2275 7466  0" encoding="utf
-00006fa0: 2d38 223f 3e5c 6e3c 443a 6572 726f 7220  -8"?>\n<D:error 
-00006fb0: 786d 6c6e 733a 443d 2244 4156 3a22 3e3c  xmlns:D="DAV:"><
-00006fc0: 443a 7072 6f70 6669 6e64 2d66 696e 6974  D:propfind-finit
-00006fd0: 652d 6465 7074 682f 3e3c 2f44 3a65 7272  e-depth/></D:err
-00006fe0: 6f72 3e27 0a20 2020 2020 2020 2020 2020  or>'.           
-00006ff0: 2020 2020 2073 656c 662e 7265 706c 7928       self.reply(
-00007000: 7a62 2c20 3430 332c 2022 6170 706c 6963  zb, 403, "applic
-00007010: 6174 696f 6e2f 786d 6c3b 2063 6861 7273  ation/xml; chars
-00007020: 6574 3d75 7466 2d38 2229 0a20 2020 2020  et=utf-8").     
-00007030: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-00007040: 6e20 5472 7565 0a0a 2020 2020 2020 2020  n True..        
-00007050: 2020 2020 2320 7468 6973 2077 696c 6c20      # this will 
-00007060: 7265 7475 726e 2073 796d 6c69 6e6b 2d74  return symlink-t
-00007070: 6172 6765 7420 7469 6d65 7374 616d 7073  arget timestamps
-00007080: 0a20 2020 2020 2020 2020 2020 2023 2062  .            # b
-00007090: 6563 6175 7365 206c 7374 6174 3d74 7275  ecause lstat=tru
-000070a0: 6520 776f 756c 6420 6e6f 7420 7265 6375  e would not recu
-000070b0: 7273 6520 696e 746f 2073 7562 666f 6c64  rse into subfold
-000070c0: 6572 730a 2020 2020 2020 2020 2020 2020  ers.            
-000070d0: 2320 616e 6420 7468 6973 2069 7320 6120  # and this is a 
-000070e0: 7261 7265 2063 6173 6520 7768 6572 6520  rare case where 
-000070f0: 7765 2061 6374 7561 6c6c 7920 7761 6e74  we actually want
-00007100: 2074 6861 740a 2020 2020 2020 2020 2020   that.          
-00007110: 2020 6667 656e 203d 2076 6e2e 7a69 7067    fgen = vn.zipg
-00007120: 656e 280a 2020 2020 2020 2020 2020 2020  en(.            
-00007130: 2020 2020 7265 6d2c 0a20 2020 2020 2020      rem,.       
-00007140: 2020 2020 2020 2020 2072 656d 2c0a 2020           rem,.  
-00007150: 2020 2020 2020 2020 2020 2020 2020 7365                se
-00007160: 7428 292c 0a20 2020 2020 2020 2020 2020  t(),.           
-00007170: 2020 2020 2073 656c 662e 756e 616d 652c       self.uname,
-00007180: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00007190: 2073 656c 662e 6172 6773 2e65 642c 0a20   self.args.ed,. 
-000071a0: 2020 2020 2020 2020 2020 2020 2020 2054                 T
-000071b0: 7275 652c 0a20 2020 2020 2020 2020 2020  rue,.           
-000071c0: 2020 2020 206e 6f74 2073 656c 662e 6172       not self.ar
-000071d0: 6773 2e6e 6f5f 7363 616e 6469 722c 0a20  gs.no_scandir,. 
-000071e0: 2020 2020 2020 2020 2020 2020 2020 2077                 w
-000071f0: 7261 703d 4661 6c73 652c 0a20 2020 2020  rap=False,.     
-00007200: 2020 2020 2020 2029 0a0a 2020 2020 2020         )..      
-00007210: 2020 656c 6966 2064 6570 7468 203d 3d20    elif depth == 
-00007220: 2231 223a 0a20 2020 2020 2020 2020 2020  "1":.           
-00007230: 205f 2c20 7666 735f 6c73 2c20 7666 735f   _, vfs_ls, vfs_
-00007240: 7669 7274 203d 2076 6e2e 6c73 280a 2020  virt = vn.ls(.  
-00007250: 2020 2020 2020 2020 2020 2020 2020 7265                re
-00007260: 6d2c 0a20 2020 2020 2020 2020 2020 2020  m,.             
-00007270: 2020 2073 656c 662e 756e 616d 652c 0a20     self.uname,. 
-00007280: 2020 2020 2020 2020 2020 2020 2020 206e                 n
-00007290: 6f74 2073 656c 662e 6172 6773 2e6e 6f5f  ot self.args.no_
-000072a0: 7363 616e 6469 722c 0a20 2020 2020 2020  scandir,.       
-000072b0: 2020 2020 2020 2020 205b 5b54 7275 652c           [[True,
-000072c0: 2046 616c 7365 5d5d 2c0a 2020 2020 2020   False]],.      
-000072d0: 2020 2020 2020 2020 2020 6c73 7461 743d            lstat=
-000072e0: 2264 6176 7274 2220 6e6f 7420 696e 2076  "davrt" not in v
-000072f0: 6e2e 666c 6167 732c 0a20 2020 2020 2020  n.flags,.       
-00007300: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
-00007310: 2020 2069 6620 6e6f 7420 7365 6c66 2e61     if not self.a
-00007320: 7267 732e 6564 3a0a 2020 2020 2020 2020  rgs.ed:.        
-00007330: 2020 2020 2020 2020 6e61 6d65 7320 3d20          names = 
-00007340: 7365 7428 6578 636c 7564 655f 646f 7466  set(exclude_dotf
-00007350: 696c 6573 285b 785b 305d 2066 6f72 2078  iles([x[0] for x
-00007360: 2069 6e20 7666 735f 6c73 5d29 290a 2020   in vfs_ls])).  
-00007370: 2020 2020 2020 2020 2020 2020 2020 7666                vf
-00007380: 735f 6c73 203d 205b 7820 666f 7220 7820  s_ls = [x for x 
-00007390: 696e 2076 6673 5f6c 7320 6966 2078 5b30  in vfs_ls if x[0
-000073a0: 5d20 696e 206e 616d 6573 5d0a 0a20 2020  ] in names]..   
-000073b0: 2020 2020 2020 2020 207a 6920 3d20 696e           zi = in
-000073c0: 7428 7469 6d65 2e74 696d 6528 2929 0a20  t(time.time()). 
-000073d0: 2020 2020 2020 2020 2020 207a 7372 203d             zsr =
-000073e0: 206f 732e 7374 6174 5f72 6573 756c 7428   os.stat_result(
-000073f0: 2831 3638 3737 2c20 2d31 2c20 2d31 2c20  (16877, -1, -1, 
-00007400: 312c 2031 3030 302c 2031 3030 302c 2038  1, 1000, 1000, 8
-00007410: 2c20 7a69 2c20 7a69 2c20 7a69 2929 0a20  , zi, zi, zi)). 
-00007420: 2020 2020 2020 2020 2020 206c 7320 3d20             ls = 
-00007430: 5b7b 2276 7022 3a20 7670 2c20 2273 7422  [{"vp": vp, "st"
-00007440: 3a20 7374 7d20 666f 7220 7670 2c20 7374  : st} for vp, st
-00007450: 2069 6e20 7666 735f 6c73 5d0a 2020 2020   in vfs_ls].    
-00007460: 2020 2020 2020 2020 6c73 202b 3d20 5b7b          ls += [{
-00007470: 2276 7022 3a20 762c 2022 7374 223a 207a  "vp": v, "st": z
-00007480: 7372 7d20 666f 7220 7620 696e 2076 6673  sr} for v in vfs
-00007490: 5f76 6972 745d 0a20 2020 2020 2020 2020  _virt].         
-000074a0: 2020 2066 6765 6e20 3d20 6c73 2020 2320     fgen = ls  # 
-000074b0: 7479 7065 3a20 6967 6e6f 7265 0a0a 2020  type: ignore..  
-000074c0: 2020 2020 2020 656c 6966 2064 6570 7468        elif depth
-000074d0: 203d 3d20 2230 223a 0a20 2020 2020 2020   == "0":.       
-000074e0: 2020 2020 2066 6765 6e20 3d20 5b5d 2020       fgen = []  
-000074f0: 2320 7479 7065 3a20 6967 6e6f 7265 0a0a  # type: ignore..
-00007500: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-00007510: 2020 2020 2020 2020 2020 7420 3d20 2269            t = "i
-00007520: 6e76 616c 6964 2064 6570 7468 2076 616c  nvalid depth val
-00007530: 7565 2027 7b7d 2720 286d 7573 7420 6265  ue '{}' (must be
-00007540: 2065 6974 6865 7220 2730 2720 6f72 2027   either '0' or '
-00007550: 3127 7b7d 2922 0a20 2020 2020 2020 2020  1'{})".         
-00007560: 2020 2074 3220 3d20 2220 6f72 2027 696e     t2 = " or 'in
-00007570: 6669 6e69 7479 2722 2069 6620 7365 6c66  finity'" if self
-00007580: 2e61 7267 732e 6461 765f 696e 6620 656c  .args.dav_inf el
-00007590: 7365 2022 220a 2020 2020 2020 2020 2020  se "".          
-000075a0: 2020 7261 6973 6520 5065 626b 6163 2834    raise Pebkac(4
-000075b0: 3132 2c20 742e 666f 726d 6174 2864 6570  12, t.format(dep
-000075c0: 7468 2c20 7432 2929 0a0a 2020 2020 2020  th, t2))..      
-000075d0: 2020 6667 656e 203d 2069 7465 7274 6f6f    fgen = itertoo
-000075e0: 6c73 2e63 6861 696e 285b 746f 7064 6972  ls.chain([topdir
-000075f0: 5d2c 2066 6765 6e29 2020 2320 7479 7065  ], fgen)  # type
-00007600: 3a20 6967 6e6f 7265 0a20 2020 2020 2020  : ignore.       
-00007610: 2076 746f 7020 3d20 766a 6f69 6e28 7365   vtop = vjoin(se
-00007620: 6c66 2e61 7267 732e 522c 2076 6a6f 696e  lf.args.R, vjoin
-00007630: 2876 6e2e 7670 6174 682c 2072 656d 2929  (vn.vpath, rem))
-00007640: 0a0a 2020 2020 2020 2020 6368 756e 6b73  ..        chunks
-00007650: 7a20 3d20 3078 3746 4638 2020 2320 7072  z = 0x7FF8  # pr
-00007660: 6566 6572 7265 6420 6279 206e 6769 6e78  eferred by nginx
-00007670: 206f 7220 6366 2028 6475 6e6e 6f20 7768   or cf (dunno wh
-00007680: 6963 6829 0a0a 2020 2020 2020 2020 7365  ich)..        se
-00007690: 6c66 2e73 656e 645f 6865 6164 6572 7328  lf.send_headers(
-000076a0: 0a20 2020 2020 2020 2020 2020 204e 6f6e  .            Non
-000076b0: 652c 2032 3037 2c20 2274 6578 742f 786d  e, 207, "text/xm
-000076c0: 6c3b 2063 6861 7273 6574 3d22 202b 2065  l; charset=" + e
-000076d0: 6e63 2c20 7b22 5472 616e 7366 6572 2d45  nc, {"Transfer-E
-000076e0: 6e63 6f64 696e 6722 3a20 2263 6875 6e6b  ncoding": "chunk
-000076f0: 6564 227d 0a20 2020 2020 2020 2029 0a0a  ed"}.        )..
-00007700: 2020 2020 2020 2020 7265 7420 3d20 273c          ret = '<
-00007710: 3f78 6d6c 2076 6572 7369 6f6e 3d22 312e  ?xml version="1.
-00007720: 3022 2065 6e63 6f64 696e 673d 227b 7d22  0" encoding="{}"
-00007730: 3f3e 5c6e 3c44 3a6d 756c 7469 7374 6174  ?>\n<D:multistat
-00007740: 7573 2078 6d6c 6e73 3a44 3d22 4441 563a  us xmlns:D="DAV:
-00007750: 223e 270a 2020 2020 2020 2020 7265 7420  ">'.        ret 
-00007760: 3d20 7265 742e 666f 726d 6174 2875 656e  = ret.format(uen
-00007770: 6329 0a20 2020 2020 2020 2066 6f72 2078  c).        for x
-00007780: 2069 6e20 6667 656e 3a0a 2020 2020 2020   in fgen:.      
-00007790: 2020 2020 2020 7270 203d 2076 6a6f 696e        rp = vjoin
-000077a0: 2876 746f 702c 2078 5b22 7670 225d 290a  (vtop, x["vp"]).
-000077b0: 2020 2020 2020 2020 2020 2020 7374 2020              st  
-000077c0: 3d20 785b 2273 7422 5d0a 2020 2020 2020  = x["st"].      
-000077d0: 2020 2020 2020 6d74 696d 6520 3d20 7374        mtime = st
-000077e0: 2e73 745f 6d74 696d 650a 2020 2020 2020  .st_mtime.      
-000077f0: 2020 2020 2020 6966 2073 7461 742e 535f        if stat.S_
-00007800: 4953 4c4e 4b28 7374 2e73 745f 6d6f 6465  ISLNK(st.st_mode
-00007810: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-00007820: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
-00007830: 2020 2020 2020 2020 2020 2020 7374 203d              st =
-00007840: 2062 6f73 2e73 7461 7428 6f73 2e70 6174   bos.stat(os.pat
-00007850: 682e 6a6f 696e 2874 6170 2c20 785b 2276  h.join(tap, x["v
-00007860: 7022 5d29 290a 2020 2020 2020 2020 2020  p"])).          
-00007870: 2020 2020 2020 6578 6365 7074 3a0a 2020        except:.  
+000049f0: 6966 2062 6f6e 6b3a 0a20 2020 2020 2020  if bonk:.       
+00004a00: 2020 2020 2020 2020 2020 2020 2073 656c               sel
+00004a10: 662e 6c6f 6728 2263 6c69 656e 7420 6261  f.log("client ba
+00004a20: 6e6e 6564 3a20 3430 3473 222c 2031 290a  nned: 404s", 1).
+00004a30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004a40: 2020 2020 7365 6c66 2e63 6f6e 6e2e 6873      self.conn.hs
+00004a50: 7276 2e62 616e 735b 6970 5d20 3d20 626f  rv.bans[ip] = bo
+00004a60: 6e6b 0a0a 2020 2020 2020 2020 6966 2076  nk..        if v
+00004a70: 6f6c 7361 6e3a 0a20 2020 2020 2020 2020  olsan:.         
+00004a80: 2020 2076 6f6c 7320 3d20 6c69 7374 2873     vols = list(s
+00004a90: 656c 662e 6173 7276 2e76 6673 2e61 6c6c  elf.asrv.vfs.all
+00004aa0: 5f76 6f6c 732e 7661 6c75 6573 2829 290a  _vols.values()).
+00004ab0: 2020 2020 2020 2020 2020 2020 626f 6479              body
+00004ac0: 203d 2076 6f6c 5f73 616e 2876 6f6c 732c   = vol_san(vols,
+00004ad0: 2062 6f64 7929 0a0a 2020 2020 2020 2020   body)..        
+00004ae0: 7365 6c66 2e73 656e 645f 6865 6164 6572  self.send_header
+00004af0: 7328 6c65 6e28 626f 6479 292c 2073 7461  s(len(body), sta
+00004b00: 7475 732c 206d 696d 652c 2068 6561 6465  tus, mime, heade
+00004b10: 7273 290a 0a20 2020 2020 2020 2074 7279  rs)..        try
+00004b20: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
+00004b30: 2073 656c 662e 6d6f 6465 2021 3d20 2248   self.mode != "H
+00004b40: 4541 4422 3a0a 2020 2020 2020 2020 2020  EAD":.          
+00004b50: 2020 2020 2020 7365 6c66 2e73 2e73 656e        self.s.sen
+00004b60: 6461 6c6c 2862 6f64 7929 0a20 2020 2020  dall(body).     
+00004b70: 2020 2065 7863 6570 743a 0a20 2020 2020     except:.     
+00004b80: 2020 2020 2020 2072 6169 7365 2050 6562         raise Peb
+00004b90: 6b61 6328 3430 302c 2022 636c 6965 6e74  kac(400, "client
+00004ba0: 2064 2f63 2077 6869 6c65 2072 6570 6c79   d/c while reply
+00004bb0: 696e 6720 626f 6479 2229 0a0a 2020 2020  ing body")..    
+00004bc0: 2020 2020 7265 7475 726e 2062 6f64 790a      return body.
+00004bd0: 0a20 2020 2064 6566 206c 6f75 645f 7265  .    def loud_re
+00004be0: 706c 7928 7365 6c66 2c20 626f 6479 202c  ply(self, body ,
+00004bf0: 202a 6172 6773 202c 202a 2a6b 7761 7267   *args , **kwarg
+00004c00: 7320 2920 203a 0a20 2020 2020 2020 2069  s )  :.        i
+00004c10: 6620 6e6f 7420 6b77 6172 6773 2e67 6574  f not kwargs.get
+00004c20: 2822 6d69 6d65 2229 3a0a 2020 2020 2020  ("mime"):.      
+00004c30: 2020 2020 2020 6b77 6172 6773 5b22 6d69        kwargs["mi
+00004c40: 6d65 225d 203d 2022 7465 7874 2f70 6c61  me"] = "text/pla
+00004c50: 696e 3b20 6368 6172 7365 743d 7574 662d  in; charset=utf-
+00004c60: 3822 0a0a 2020 2020 2020 2020 7365 6c66  8"..        self
+00004c70: 2e6c 6f67 2862 6f64 792e 7273 7472 6970  .log(body.rstrip
+00004c80: 2829 290a 2020 2020 2020 2020 7365 6c66  ()).        self
+00004c90: 2e72 6570 6c79 2862 6f64 792e 656e 636f  .reply(body.enco
+00004ca0: 6465 2822 7574 662d 3822 2920 2b20 6222  de("utf-8") + b"
+00004cb0: 5c72 5c6e 222c 202a 6c69 7374 2861 7267  \r\n", *list(arg
+00004cc0: 7329 2c20 2a2a 6b77 6172 6773 290a 0a20  s), **kwargs).. 
+00004cd0: 2020 2064 6566 2075 726c 7128 7365 6c66     def urlq(self
+00004ce0: 2c20 6164 6420 202c 2072 6d20 2920 203a  , add  , rm )  :
+00004cf0: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
+00004d00: 2020 2020 2067 656e 6572 6174 6573 2075       generates u
+00004d10: 726c 2071 7565 7279 2062 6173 6564 206f  rl query based o
+00004d20: 6e20 7570 6172 616d 2028 622c 2070 772c  n uparam (b, pw,
+00004d30: 2061 6c6c 206f 7468 6572 7329 0a20 2020   all others).   
+00004d40: 2020 2020 2072 656d 6f76 696e 6720 616e       removing an
+00004d50: 7974 6869 6e67 2069 6e20 726d 2c20 6164  ything in rm, ad
+00004d60: 6469 6e67 2070 6169 7273 2069 6e20 6164  ding pairs in ad
+00004d70: 640a 0a20 2020 2020 2020 2061 6c73 6f20  d..        also 
+00004d80: 6c69 7374 2066 6173 7465 7220 7468 616e  list faster than
+00004d90: 2073 6574 2075 6e74 696c 207e 3230 2069   set until ~20 i
+00004da0: 7465 6d73 0a20 2020 2020 2020 2022 2222  tems.        """
+00004db0: 0a0a 2020 2020 2020 2020 6966 2073 656c  ..        if sel
+00004dc0: 662e 6973 5f72 636c 6f6e 653a 0a20 2020  f.is_rclone:.   
+00004dd0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+00004de0: 2222 0a0a 2020 2020 2020 2020 6b76 203d  ""..        kv =
+00004df0: 207b 6b3a 207a 7320 666f 7220 6b2c 207a   {k: zs for k, z
+00004e00: 7320 696e 2073 656c 662e 7570 6172 616d  s in self.uparam
+00004e10: 2e69 7465 6d73 2829 2069 6620 6b20 6e6f  .items() if k no
+00004e20: 7420 696e 2072 6d7d 0a20 2020 2020 2020  t in rm}.       
+00004e30: 2069 6620 2270 7722 2069 6e20 6b76 3a0a   if "pw" in kv:.
+00004e40: 2020 2020 2020 2020 2020 2020 7077 203d              pw =
+00004e50: 2073 656c 662e 636f 6f6b 6965 732e 6765   self.cookies.ge
+00004e60: 7428 2263 7070 7773 2229 206f 7220 7365  t("cppws") or se
+00004e70: 6c66 2e63 6f6f 6b69 6573 2e67 6574 2822  lf.cookies.get("
+00004e80: 6370 7077 6422 290a 2020 2020 2020 2020  cppwd").        
+00004e90: 2020 2020 6966 206b 765b 2270 7722 5d20      if kv["pw"] 
+00004ea0: 3d3d 2070 773a 0a20 2020 2020 2020 2020  == pw:.         
+00004eb0: 2020 2020 2020 2064 656c 206b 765b 2270         del kv["p
+00004ec0: 7722 5d0a 0a20 2020 2020 2020 206b 762e  w"]..        kv.
+00004ed0: 7570 6461 7465 2861 6464 290a 2020 2020  update(add).    
+00004ee0: 2020 2020 6966 206e 6f74 206b 763a 0a20      if not kv:. 
+00004ef0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+00004f00: 6e20 2222 0a0a 2020 2020 2020 2020 7220  n ""..        r 
+00004f10: 3d20 5b22 2573 3d25 7322 2025 2028 6b2c  = ["%s=%s" % (k,
+00004f20: 2071 756f 7465 7028 7a73 2929 2069 6620   quotep(zs)) if 
+00004f30: 7a73 2065 6c73 6520 6b20 666f 7220 6b2c  zs else k for k,
+00004f40: 207a 7320 696e 206b 762e 6974 656d 7328   zs in kv.items(
+00004f50: 295d 0a20 2020 2020 2020 2072 6574 7572  )].        retur
+00004f60: 6e20 223f 2220 2b20 2226 616d 703b 222e  n "?" + "&amp;".
+00004f70: 6a6f 696e 2872 290a 0a20 2020 2064 6566  join(r)..    def
+00004f80: 2072 6564 6972 6563 7428 0a20 2020 2020   redirect(.     
+00004f90: 2020 2073 656c 662c 0a20 2020 2020 2020     self,.       
+00004fa0: 2076 7061 7468 202c 0a20 2020 2020 2020   vpath ,.       
+00004fb0: 2073 7566 2020 3d20 2222 2c0a 2020 2020   suf  = "",.    
+00004fc0: 2020 2020 6d73 6720 203d 2022 6169 6768      msg  = "aigh
+00004fd0: 7422 2c0a 2020 2020 2020 2020 666c 6176  t",.        flav
+00004fe0: 6f72 2020 3d20 2267 6f20 746f 222c 0a20  or  = "go to",. 
+00004ff0: 2020 2020 2020 2063 6c69 636b 2020 3d20         click  = 
+00005000: 5472 7565 2c0a 2020 2020 2020 2020 7374  True,.        st
+00005010: 6174 7573 2020 3d20 3230 302c 0a20 2020  atus  = 200,.   
+00005020: 2020 2020 2075 7365 3330 3220 203d 2046       use302  = F
+00005030: 616c 7365 2c0a 2020 2020 2920 203a 0a20  alse,.    )  :. 
+00005040: 2020 2020 2020 2076 7020 3d20 7365 6c66         vp = self
+00005050: 2e61 7267 732e 5253 202b 2076 7061 7468  .args.RS + vpath
+00005060: 0a20 2020 2020 2020 2068 746d 6c20 3d20  .        html = 
+00005070: 7365 6c66 2e6a 3273 280a 2020 2020 2020  self.j2s(.      
+00005080: 2020 2020 2020 226d 7367 222c 0a20 2020        "msg",.   
+00005090: 2020 2020 2020 2020 2068 323d 273c 6120           h2='<a 
+000050a0: 6872 6566 3d22 2f7b 7d22 3e7b 7d20 2f7b  href="/{}">{} /{
+000050b0: 7d3c 2f61 3e27 2e66 6f72 6d61 7428 0a20  }</a>'.format(. 
+000050c0: 2020 2020 2020 2020 2020 2020 2020 2071                 q
+000050d0: 756f 7465 7028 7670 2920 2b20 7375 662c  uotep(vp) + suf,
+000050e0: 2066 6c61 766f 722c 2068 746d 6c5f 6573   flavor, html_es
+000050f0: 6361 7065 2876 702c 2063 726c 663d 5472  cape(vp, crlf=Tr
+00005100: 7565 2920 2b20 7375 660a 2020 2020 2020  ue) + suf.      
+00005110: 2020 2020 2020 292c 0a20 2020 2020 2020        ),.       
+00005120: 2020 2020 2070 7265 3d6d 7367 2c0a 2020       pre=msg,.  
+00005130: 2020 2020 2020 2020 2020 636c 6963 6b3d            click=
+00005140: 636c 6963 6b2c 0a20 2020 2020 2020 2029  click,.        )
+00005150: 2e65 6e63 6f64 6528 2275 7466 2d38 222c  .encode("utf-8",
+00005160: 2022 7265 706c 6163 6522 290a 0a20 2020   "replace")..   
+00005170: 2020 2020 2069 6620 7573 6533 3032 3a0a       if use302:.
+00005180: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+00005190: 2e72 6570 6c79 2868 746d 6c2c 2073 7461  .reply(html, sta
+000051a0: 7475 733d 3330 322c 2068 6561 6465 7273  tus=302, headers
+000051b0: 3d7b 224c 6f63 6174 696f 6e22 3a20 222f  ={"Location": "/
+000051c0: 2220 2b20 7670 6174 687d 290a 2020 2020  " + vpath}).    
+000051d0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+000051e0: 2020 2020 2020 7365 6c66 2e72 6570 6c79        self.reply
+000051f0: 2868 746d 6c2c 2073 7461 7475 733d 7374  (html, status=st
+00005200: 6174 7573 290a 0a20 2020 2020 2020 2072  atus)..        r
+00005210: 6574 7572 6e20 5472 7565 0a0a 2020 2020  eturn True..    
+00005220: 6465 6620 5f63 6f72 7328 7365 6c66 2920  def _cors(self) 
+00005230: 203a 0a20 2020 2020 2020 2069 6820 3d20   :.        ih = 
+00005240: 7365 6c66 2e68 6561 6465 7273 0a20 2020  self.headers.   
+00005250: 2020 2020 206f 7269 6769 6e20 3d20 6968       origin = ih
+00005260: 2e67 6574 2822 6f72 6967 696e 2229 0a20  .get("origin"). 
+00005270: 2020 2020 2020 2069 6620 6e6f 7420 6f72         if not or
+00005280: 6967 696e 3a0a 2020 2020 2020 2020 2020  igin:.          
+00005290: 2020 7366 7369 7465 203d 2069 682e 6765    sfsite = ih.ge
+000052a0: 7428 2273 6563 2d66 6574 6368 2d73 6974  t("sec-fetch-sit
+000052b0: 6522 290a 2020 2020 2020 2020 2020 2020  e").            
+000052c0: 6966 2073 6673 6974 6520 616e 6420 7366  if sfsite and sf
+000052d0: 7369 7465 2e6c 6f77 6572 2829 2e73 7461  site.lower().sta
+000052e0: 7274 7377 6974 6828 2263 726f 7373 2229  rtswith("cross")
+000052f0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00005300: 2020 6f72 6967 696e 203d 2022 3a7c 2220    origin = ":|" 
+00005310: 2023 2073 616e 6462 6f78 6564 2069 6672   # sandboxed ifr
+00005320: 616d 650a 2020 2020 2020 2020 2020 2020  ame.            
+00005330: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+00005340: 2020 2020 2020 7265 7475 726e 2054 7275        return Tru
+00005350: 650a 0a20 2020 2020 2020 206f 6820 3d20  e..        oh = 
+00005360: 7365 6c66 2e6f 7574 5f68 6561 6465 7273  self.out_headers
+00005370: 0a20 2020 2020 2020 206f 7269 6769 6e20  .        origin 
+00005380: 3d20 6f72 6967 696e 2e6c 6f77 6572 2829  = origin.lower()
+00005390: 0a20 2020 2020 2020 2067 6f6f 645f 6f72  .        good_or
+000053a0: 6967 696e 7320 3d20 7365 6c66 2e61 7267  igins = self.arg
+000053b0: 732e 6163 616f 202b 205b 0a20 2020 2020  s.acao + [.     
+000053c0: 2020 2020 2020 2022 7b7d 3a2f 2f7b 7d22         "{}://{}"
+000053d0: 2e66 6f72 6d61 7428 0a20 2020 2020 2020  .format(.       
+000053e0: 2020 2020 2020 2020 2022 6874 7470 7322           "https"
+000053f0: 2069 6620 7365 6c66 2e69 735f 6874 7470   if self.is_http
+00005400: 7320 656c 7365 2022 6874 7470 222c 0a20  s else "http",. 
+00005410: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00005420: 656c 662e 686f 7374 2e6c 6f77 6572 2829  elf.host.lower()
+00005430: 2e73 706c 6974 2822 3a22 295b 305d 2c0a  .split(":")[0],.
+00005440: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
+00005450: 2020 2020 2020 5d0a 2020 2020 2020 2020        ].        
+00005460: 6966 2072 652e 7375 6228 7222 283a 5b30  if re.sub(r"(:[0
+00005470: 2d39 5d7b 312c 357d 293f 2f3f 2422 2c20  -9]{1,5})?/?$", 
+00005480: 2222 2c20 6f72 6967 696e 2920 696e 2067  "", origin) in g
+00005490: 6f6f 645f 6f72 6967 696e 733a 0a20 2020  ood_origins:.   
+000054a0: 2020 2020 2020 2020 2067 6f6f 645f 6f72           good_or
+000054b0: 6967 696e 203d 2054 7275 650a 2020 2020  igin = True.    
+000054c0: 2020 2020 2020 2020 6261 645f 6864 7273          bad_hdrs
+000054d0: 203d 2028 2222 2c29 0a20 2020 2020 2020   = ("",).       
+000054e0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+000054f0: 2020 2067 6f6f 645f 6f72 6967 696e 203d     good_origin =
+00005500: 2046 616c 7365 0a20 2020 2020 2020 2020   False.         
+00005510: 2020 2062 6164 5f68 6472 7320 3d20 2822     bad_hdrs = ("
+00005520: 222c 2022 7077 2229 0a0a 2020 2020 2020  ", "pw")..      
+00005530: 2020 2320 272a 2720 626c 6f63 6b73 2061    # '*' blocks a
+00005540: 6c6c 2063 7265 6465 6e74 6961 6c73 2028  ll credentials (
+00005550: 636f 6f6b 6965 732c 2068 7474 702d 6175  cookies, http-au
+00005560: 7468 293b 0a20 2020 2020 2020 2023 2065  th);.        # e
+00005570: 7861 6374 2d6d 6174 6368 2066 6f72 204f  xact-match for O
+00005580: 7269 6769 6e20 6973 206e 6563 6573 7361  rigin is necessa
+00005590: 7279 2074 6f20 756e 6c6f 636b 2074 686f  ry to unlock tho
+000055a0: 7365 2c0a 2020 2020 2020 2020 2320 686f  se,.        # ho
+000055b0: 7765 7665 7220 796f 6c6f 2d72 6571 7565  wever yolo-reque
+000055c0: 7374 7320 283f 7077 3d29 2061 7265 2061  sts (?pw=) are a
+000055d0: 6c77 6179 7320 616c 6c6f 7765 640a 2020  lways allowed.  
+000055e0: 2020 2020 2020 6163 6168 203d 2069 682e        acah = ih.
+000055f0: 6765 7428 2261 6363 6573 732d 636f 6e74  get("access-cont
+00005600: 726f 6c2d 7265 7175 6573 742d 6865 6164  rol-request-head
+00005610: 6572 7322 2c20 2222 290a 2020 2020 2020  ers", "").      
+00005620: 2020 6163 616f 203d 2028 6f72 6967 696e    acao = (origin
+00005630: 2069 6620 676f 6f64 5f6f 7269 6769 6e20   if good_origin 
+00005640: 656c 7365 204e 6f6e 6529 206f 7220 280a  else None) or (.
+00005650: 2020 2020 2020 2020 2020 2020 222a 2220              "*" 
+00005660: 6966 2022 2a22 2069 6e20 676f 6f64 5f6f  if "*" in good_o
+00005670: 7269 6769 6e73 2065 6c73 6520 4e6f 6e65  rigins else None
+00005680: 0a20 2020 2020 2020 2029 0a20 2020 2020  .        ).     
+00005690: 2020 2069 6620 7365 6c66 2e61 7267 732e     if self.args.
+000056a0: 616c 6c6f 775f 6373 7266 3a0a 2020 2020  allow_csrf:.    
+000056b0: 2020 2020 2020 2020 6163 616f 203d 206f          acao = o
+000056c0: 7269 6769 6e20 6f72 2061 6361 6f20 6f72  rigin or acao or
+000056d0: 2022 2a22 2020 2320 6578 706c 6963 6974   "*"  # explicit
+000056e0: 6c79 2070 6572 6d69 7420 696d 7065 7273  ly permit impers
+000056f0: 6f6e 6174 696f 6e0a 2020 2020 2020 2020  onation.        
+00005700: 2020 2020 6163 616d 203d 2022 2c20 222e      acam = ", ".
+00005710: 6a6f 696e 2873 656c 662e 636f 6e6e 2e68  join(self.conn.h
+00005720: 7372 762e 6d61 6c6c 6f77 2920 2023 2061  srv.mallow)  # a
+00005730: 6e64 2061 6c6c 206d 6574 686f 6473 202b  nd all methods +
+00005740: 2068 6561 6465 7273 0a20 2020 2020 2020   headers.       
+00005750: 2020 2020 206f 685b 2241 6363 6573 732d       oh["Access-
+00005760: 436f 6e74 726f 6c2d 416c 6c6f 772d 4372  Control-Allow-Cr
+00005770: 6564 656e 7469 616c 7322 5d20 3d20 2274  edentials"] = "t
+00005780: 7275 6522 0a20 2020 2020 2020 2020 2020  rue".           
+00005790: 2067 6f6f 645f 6f72 6967 696e 203d 2054   good_origin = T
+000057a0: 7275 650a 2020 2020 2020 2020 656c 7365  rue.        else
+000057b0: 3a0a 2020 2020 2020 2020 2020 2020 6163  :.            ac
+000057c0: 616d 203d 2022 2c20 222e 6a6f 696e 2873  am = ", ".join(s
+000057d0: 656c 662e 6172 6773 2e61 6361 6d29 0a20  elf.args.acam). 
+000057e0: 2020 2020 2020 2020 2020 2023 2077 6173             # was
+000057f0: 6820 636c 6965 6e74 2d72 6571 7565 7374  h client-request
+00005800: 6564 2068 6561 6465 7273 2061 6e64 2072  ed headers and r
+00005810: 6f6c 6c20 7769 7468 2074 6861 740a 2020  oll with that.  
+00005820: 2020 2020 2020 2020 2020 6966 2022 7261            if "ra
+00005830: 6e67 6522 206e 6f74 2069 6e20 6163 6168  nge" not in acah
+00005840: 2e6c 6f77 6572 2829 3a0a 2020 2020 2020  .lower():.      
+00005850: 2020 2020 2020 2020 2020 6163 6168 202b            acah +
+00005860: 3d20 222c 5261 6e67 6522 2020 2320 6669  = ",Range"  # fi
+00005870: 7265 666f 780a 2020 2020 2020 2020 2020  refox.          
+00005880: 2020 7265 715f 6820 3d20 6163 6168 2e73    req_h = acah.s
+00005890: 706c 6974 2822 2c22 290a 2020 2020 2020  plit(",").      
+000058a0: 2020 2020 2020 7265 715f 6820 3d20 5b78        req_h = [x
+000058b0: 2e73 7472 6970 2829 2066 6f72 2078 2069  .strip() for x i
+000058c0: 6e20 7265 715f 685d 0a20 2020 2020 2020  n req_h].       
+000058d0: 2020 2020 2072 6571 5f68 203d 205b 7820       req_h = [x 
+000058e0: 666f 7220 7820 696e 2072 6571 5f68 2069  for x in req_h i
+000058f0: 6620 782e 6c6f 7765 7228 2920 6e6f 7420  f x.lower() not 
+00005900: 696e 2062 6164 5f68 6472 735d 0a20 2020  in bad_hdrs].   
+00005910: 2020 2020 2020 2020 2061 6361 6820 3d20           acah = 
+00005920: 222c 2022 2e6a 6f69 6e28 7265 715f 6829  ", ".join(req_h)
+00005930: 0a0a 2020 2020 2020 2020 6966 206e 6f74  ..        if not
+00005940: 2061 6361 6f3a 0a20 2020 2020 2020 2020   acao:.         
+00005950: 2020 2072 6574 7572 6e20 4661 6c73 650a     return False.
+00005960: 0a20 2020 2020 2020 206f 685b 2241 6363  .        oh["Acc
+00005970: 6573 732d 436f 6e74 726f 6c2d 416c 6c6f  ess-Control-Allo
+00005980: 772d 4f72 6967 696e 225d 203d 2061 6361  w-Origin"] = aca
+00005990: 6f0a 2020 2020 2020 2020 6f68 5b22 4163  o.        oh["Ac
+000059a0: 6365 7373 2d43 6f6e 7472 6f6c 2d41 6c6c  cess-Control-All
+000059b0: 6f77 2d4d 6574 686f 6473 225d 203d 2061  ow-Methods"] = a
+000059c0: 6361 6d2e 7570 7065 7228 290a 2020 2020  cam.upper().    
+000059d0: 2020 2020 6966 2061 6361 683a 0a20 2020      if acah:.   
+000059e0: 2020 2020 2020 2020 206f 685b 2241 6363           oh["Acc
+000059f0: 6573 732d 436f 6e74 726f 6c2d 416c 6c6f  ess-Control-Allo
+00005a00: 772d 4865 6164 6572 7322 5d20 3d20 6163  w-Headers"] = ac
+00005a10: 6168 0a0a 2020 2020 2020 2020 7265 7475  ah..        retu
+00005a20: 726e 2067 6f6f 645f 6f72 6967 696e 0a0a  rn good_origin..
+00005a30: 2020 2020 6465 6620 6861 6e64 6c65 5f67      def handle_g
+00005a40: 6574 2873 656c 6629 2020 3a0a 2020 2020  et(self)  :.    
+00005a50: 2020 2020 6966 2073 656c 662e 646f 5f6c      if self.do_l
+00005a60: 6f67 3a0a 2020 2020 2020 2020 2020 2020  og:.            
+00005a70: 6c6f 676d 7367 203d 2022 2534 7320 2573  logmsg = "%4s %s
+00005a80: 2040 2573 2220 2520 2873 656c 662e 6d6f   @%s" % (self.mo
+00005a90: 6465 2c20 7365 6c66 2e72 6571 2c20 7365  de, self.req, se
+00005aa0: 6c66 2e75 6e61 6d65 290a 0a20 2020 2020  lf.uname)..     
+00005ab0: 2020 2020 2020 2069 6620 2272 616e 6765         if "range
+00005ac0: 2220 696e 2073 656c 662e 6865 6164 6572  " in self.header
+00005ad0: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
+00005ae0: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
+00005af0: 2020 2020 2020 2020 2020 2020 7276 616c              rval
+00005b00: 203d 2073 656c 662e 6865 6164 6572 735b   = self.headers[
+00005b10: 2272 616e 6765 225d 2e73 706c 6974 2822  "range"].split("
+00005b20: 3d22 2c20 3129 5b31 5d0a 2020 2020 2020  =", 1)[1].      
+00005b30: 2020 2020 2020 2020 2020 6578 6365 7074            except
+00005b40: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00005b50: 2020 2020 2020 7276 616c 203d 2073 656c        rval = sel
+00005b60: 662e 6865 6164 6572 735b 2272 616e 6765  f.headers["range
+00005b70: 225d 0a0a 2020 2020 2020 2020 2020 2020  "]..            
+00005b80: 2020 2020 6c6f 676d 7367 202b 3d20 2220      logmsg += " 
+00005b90: 5b5c 3033 335b 3336 6d22 202b 2072 7661  [\033[36m" + rva
+00005ba0: 6c20 2b20 225c 3033 335b 306d 5d22 0a0a  l + "\033[0m]"..
+00005bb0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+00005bc0: 2e6c 6f67 286c 6f67 6d73 6729 0a0a 2020  .log(logmsg)..  
+00005bd0: 2020 2020 2020 2320 2265 6d62 6564 6465        # "embedde
+00005be0: 6422 2072 6573 6f75 7263 6573 0a20 2020  d" resources.   
+00005bf0: 2020 2020 2069 6620 7365 6c66 2e76 7061       if self.vpa
+00005c00: 7468 2e73 7461 7274 7377 6974 6828 222e  th.startswith(".
+00005c10: 6370 7222 293a 0a20 2020 2020 2020 2020  cpr"):.         
+00005c20: 2020 2069 6620 7365 6c66 2e76 7061 7468     if self.vpath
+00005c30: 2e73 7461 7274 7377 6974 6828 222e 6370  .startswith(".cp
+00005c40: 722f 6963 6f2f 2229 3a0a 2020 2020 2020  r/ico/"):.      
+00005c50: 2020 2020 2020 2020 2020 7265 7475 726e            return
+00005c60: 2073 656c 662e 7478 5f69 636f 2873 656c   self.tx_ico(sel
+00005c70: 662e 7670 6174 682e 7370 6c69 7428 222f  f.vpath.split("/
+00005c80: 2229 5b2d 315d 2c20 6578 6163 743d 5472  ")[-1], exact=Tr
+00005c90: 7565 290a 0a20 2020 2020 2020 2020 2020  ue)..           
+00005ca0: 2069 6620 7365 6c66 2e76 7061 7468 2e73   if self.vpath.s
+00005cb0: 7461 7274 7377 6974 6828 222e 6370 722f  tartswith(".cpr/
+00005cc0: 7373 6470 2229 3a0a 2020 2020 2020 2020  ssdp"):.        
+00005cd0: 2020 2020 2020 2020 7265 7475 726e 2073          return s
+00005ce0: 656c 662e 636f 6e6e 2e68 7372 762e 7373  elf.conn.hsrv.ss
+00005cf0: 6470 2e72 6570 6c79 2873 656c 6629 0a0a  dp.reply(self)..
+00005d00: 2020 2020 2020 2020 2020 2020 6966 2073              if s
+00005d10: 656c 662e 7670 6174 682e 7374 6172 7473  elf.vpath.starts
+00005d20: 7769 7468 2822 2e63 7072 2f64 642f 2229  with(".cpr/dd/")
+00005d30: 2061 6e64 2073 656c 662e 6172 6773 2e6d   and self.args.m
+00005d40: 706d 633a 0a20 2020 2020 2020 2020 2020  pmc:.           
+00005d50: 2020 2020 2069 6620 7365 6c66 2e61 7267       if self.arg
+00005d60: 732e 6d70 6d63 203d 3d20 222e 223a 0a20  s.mpmc == ".":. 
+00005d70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005d80: 2020 2072 6169 7365 2050 6562 6b61 6328     raise Pebkac(
+00005d90: 3430 3429 0a0a 2020 2020 2020 2020 2020  404)..          
+00005da0: 2020 2020 2020 6c6f 6320 3d20 7365 6c66        loc = self
+00005db0: 2e61 7267 732e 6d70 6d63 2e72 7374 7269  .args.mpmc.rstri
+00005dc0: 7028 222f 2229 202b 2073 656c 662e 7670  p("/") + self.vp
+00005dd0: 6174 685b 7365 6c66 2e76 7061 7468 2e72  ath[self.vpath.r
+00005de0: 6669 6e64 2822 2f22 2920 3a5d 0a20 2020  find("/") :].   
+00005df0: 2020 2020 2020 2020 2020 2020 2068 203d               h =
+00005e00: 207b 224c 6f63 6174 696f 6e22 3a20 6c6f   {"Location": lo
+00005e10: 632c 2022 4361 6368 652d 436f 6e74 726f  c, "Cache-Contro
+00005e20: 6c22 3a20 226d 6178 2d61 6765 3d33 3922  l": "max-age=39"
+00005e30: 7d0a 2020 2020 2020 2020 2020 2020 2020  }.              
+00005e40: 2020 7365 6c66 2e72 6570 6c79 2862 2222    self.reply(b""
+00005e50: 2c20 3330 312c 2068 6561 6465 7273 3d68  , 301, headers=h
+00005e60: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00005e70: 2020 7265 7475 726e 2054 7275 650a 0a20    return True.. 
+00005e80: 2020 2020 2020 2020 2020 2073 7461 7469             stati
+00005e90: 635f 7061 7468 203d 206f 732e 7061 7468  c_path = os.path
+00005ea0: 2e6a 6f69 6e28 7365 6c66 2e45 2e6d 6f64  .join(self.E.mod
+00005eb0: 2c20 2277 6562 2f22 2c20 7365 6c66 2e76  , "web/", self.v
+00005ec0: 7061 7468 5b35 3a5d 290a 2020 2020 2020  path[5:]).      
+00005ed0: 2020 2020 2020 7265 7475 726e 2073 656c        return sel
+00005ee0: 662e 7478 5f66 696c 6528 7374 6174 6963  f.tx_file(static
+00005ef0: 5f70 6174 6829 0a0a 2020 2020 2020 2020  _path)..        
+00005f00: 6966 2022 6366 5f63 6861 6c6c 656e 6765  if "cf_challenge
+00005f10: 2220 696e 2073 656c 662e 7570 6172 616d  " in self.uparam
+00005f20: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
+00005f30: 6c66 2e72 6570 6c79 2873 656c 662e 6a32  lf.reply(self.j2
+00005f40: 7328 2263 6622 292e 656e 636f 6465 2822  s("cf").encode("
+00005f50: 7574 662d 3822 2c20 2272 6570 6c61 6365  utf-8", "replace
+00005f60: 2229 290a 2020 2020 2020 2020 2020 2020  ")).            
+00005f70: 7265 7475 726e 2054 7275 650a 0a20 2020  return True..   
+00005f80: 2020 2020 2069 6620 6e6f 7420 7365 6c66       if not self
+00005f90: 2e63 616e 5f72 6561 6420 616e 6420 6e6f  .can_read and no
+00005fa0: 7420 7365 6c66 2e63 616e 5f77 7269 7465  t self.can_write
+00005fb0: 2061 6e64 206e 6f74 2073 656c 662e 6361   and not self.ca
+00005fc0: 6e5f 6765 743a 0a20 2020 2020 2020 2020  n_get:.         
+00005fd0: 2020 2069 6620 7365 6c66 2e76 7061 7468     if self.vpath
+00005fe0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00005ff0: 2020 7365 6c66 2e6c 6f67 2822 696e 6163    self.log("inac
+00006000: 6365 7373 6962 6c65 3a20 5b7b 7d5d 222e  cessible: [{}]".
+00006010: 666f 726d 6174 2873 656c 662e 7670 6174  format(self.vpat
+00006020: 6829 290a 2020 2020 2020 2020 2020 2020  h)).            
+00006030: 2020 2020 7265 7475 726e 2073 656c 662e      return self.
+00006040: 7478 5f34 3034 2854 7275 6529 0a0a 2020  tx_404(True)..  
+00006050: 2020 2020 2020 2020 2020 7365 6c66 2e75            self.u
+00006060: 7061 7261 6d5b 2268 225d 203d 2022 220a  param["h"] = "".
+00006070: 0a20 2020 2020 2020 2069 6620 2274 7265  .        if "tre
+00006080: 6522 2069 6e20 7365 6c66 2e75 7061 7261  e" in self.upara
+00006090: 6d3a 0a20 2020 2020 2020 2020 2020 2072  m:.            r
+000060a0: 6574 7572 6e20 7365 6c66 2e74 785f 7472  eturn self.tx_tr
+000060b0: 6565 2829 0a0a 2020 2020 2020 2020 6966  ee()..        if
+000060c0: 2022 7363 616e 2220 696e 2073 656c 662e   "scan" in self.
+000060d0: 7570 6172 616d 3a0a 2020 2020 2020 2020  uparam:.        
+000060e0: 2020 2020 7265 7475 726e 2073 656c 662e      return self.
+000060f0: 7363 616e 766f 6c28 290a 0a20 2020 2020  scanvol()..     
+00006100: 2020 2069 6620 7365 6c66 2e61 7267 732e     if self.args.
+00006110: 6765 746d 6f64 3a0a 2020 2020 2020 2020  getmod:.        
+00006120: 2020 2020 6966 2022 6465 6c65 7465 2220      if "delete" 
+00006130: 696e 2073 656c 662e 7570 6172 616d 3a0a  in self.uparam:.
+00006140: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006150: 7265 7475 726e 2073 656c 662e 6861 6e64  return self.hand
+00006160: 6c65 5f72 6d28 5b5d 290a 0a20 2020 2020  le_rm([])..     
+00006170: 2020 2020 2020 2069 6620 226d 6f76 6522         if "move"
+00006180: 2069 6e20 7365 6c66 2e75 7061 7261 6d3a   in self.uparam:
+00006190: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000061a0: 2072 6574 7572 6e20 7365 6c66 2e68 616e   return self.han
+000061b0: 646c 655f 6d76 2829 0a0a 2020 2020 2020  dle_mv()..      
+000061c0: 2020 6966 206e 6f74 2073 656c 662e 7670    if not self.vp
+000061d0: 6174 683a 0a20 2020 2020 2020 2020 2020  ath:.           
+000061e0: 2069 6620 2272 656c 6f61 6422 2069 6e20   if "reload" in 
+000061f0: 7365 6c66 2e75 7061 7261 6d3a 0a20 2020  self.uparam:.   
+00006200: 2020 2020 2020 2020 2020 2020 2072 6574               ret
+00006210: 7572 6e20 7365 6c66 2e68 616e 646c 655f  urn self.handle_
+00006220: 7265 6c6f 6164 2829 0a0a 2020 2020 2020  reload()..      
+00006230: 2020 2020 2020 6966 2022 7374 6163 6b22        if "stack"
+00006240: 2069 6e20 7365 6c66 2e75 7061 7261 6d3a   in self.uparam:
+00006250: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00006260: 2072 6574 7572 6e20 7365 6c66 2e74 785f   return self.tx_
+00006270: 7374 6163 6b28 290a 0a20 2020 2020 2020  stack()..       
+00006280: 2020 2020 2069 6620 2275 7073 2220 696e       if "ups" in
+00006290: 2073 656c 662e 7570 6172 616d 3a0a 2020   self.uparam:.  
+000062a0: 2020 2020 2020 2020 2020 2020 2020 7265                re
+000062b0: 7475 726e 2073 656c 662e 7478 5f75 7073  turn self.tx_ups
+000062c0: 2829 0a0a 2020 2020 2020 2020 2020 2020  ()..            
+000062d0: 6966 2022 6b33 3034 2220 696e 2073 656c  if "k304" in sel
+000062e0: 662e 7570 6172 616d 3a0a 2020 2020 2020  f.uparam:.      
+000062f0: 2020 2020 2020 2020 2020 7265 7475 726e            return
+00006300: 2073 656c 662e 7365 745f 6b33 3034 2829   self.set_k304()
+00006310: 0a0a 2020 2020 2020 2020 2020 2020 6966  ..            if
+00006320: 2022 7365 7463 6b22 2069 6e20 7365 6c66   "setck" in self
+00006330: 2e75 7061 7261 6d3a 0a20 2020 2020 2020  .uparam:.       
+00006340: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+00006350: 7365 6c66 2e73 6574 636b 2829 0a0a 2020  self.setck()..  
+00006360: 2020 2020 2020 2020 2020 6966 2022 7265            if "re
+00006370: 7365 7422 2069 6e20 7365 6c66 2e75 7061  set" in self.upa
+00006380: 7261 6d3a 0a20 2020 2020 2020 2020 2020  ram:.           
+00006390: 2020 2020 2072 6574 7572 6e20 7365 6c66       return self
+000063a0: 2e73 6574 5f63 6667 5f72 6573 6574 2829  .set_cfg_reset()
+000063b0: 0a0a 2020 2020 2020 2020 2020 2020 6966  ..            if
+000063c0: 2022 6863 2220 696e 2073 656c 662e 7570   "hc" in self.up
+000063d0: 6172 616d 3a0a 2020 2020 2020 2020 2020  aram:.          
+000063e0: 2020 2020 2020 7265 7475 726e 2073 656c        return sel
+000063f0: 662e 7478 5f73 7663 7328 290a 0a20 2020  f.tx_svcs()..   
+00006400: 2020 2020 2069 6620 2268 2220 696e 2073       if "h" in s
+00006410: 656c 662e 7570 6172 616d 3a0a 2020 2020  elf.uparam:.    
+00006420: 2020 2020 2020 2020 7265 7475 726e 2073          return s
+00006430: 656c 662e 7478 5f6d 6f75 6e74 7328 290a  elf.tx_mounts().
+00006440: 0a20 2020 2020 2020 2023 2063 6f6e 6469  .        # condi
+00006450: 7469 6f6e 616c 2072 6564 6972 6563 7420  tional redirect 
+00006460: 746f 2073 696e 676c 6520 766f 6c75 6d65  to single volume
+00006470: 730a 2020 2020 2020 2020 6966 2073 656c  s.        if sel
+00006480: 662e 7670 6174 6820 3d3d 2022 2220 616e  f.vpath == "" an
+00006490: 6420 6e6f 7420 7365 6c66 2e6f 7570 6172  d not self.oupar
+000064a0: 616d 3a0a 2020 2020 2020 2020 2020 2020  am:.            
+000064b0: 6e72 6561 6420 3d20 6c65 6e28 7365 6c66  nread = len(self
+000064c0: 2e72 766f 6c29 0a20 2020 2020 2020 2020  .rvol).         
+000064d0: 2020 206e 7772 6974 6520 3d20 6c65 6e28     nwrite = len(
+000064e0: 7365 6c66 2e77 766f 6c29 0a20 2020 2020  self.wvol).     
+000064f0: 2020 2020 2020 2069 6620 6e72 6561 6420         if nread 
+00006500: 2b20 6e77 7269 7465 203d 3d20 3120 6f72  + nwrite == 1 or
+00006510: 2028 7365 6c66 2e72 766f 6c20 3d3d 2073   (self.rvol == s
+00006520: 656c 662e 7776 6f6c 2061 6e64 206e 7265  elf.wvol and nre
+00006530: 6164 203d 3d20 3129 3a0a 2020 2020 2020  ad == 1):.      
+00006540: 2020 2020 2020 2020 2020 6966 206e 7265            if nre
+00006550: 6164 203d 3d20 313a 0a20 2020 2020 2020  ad == 1:.       
+00006560: 2020 2020 2020 2020 2020 2020 2076 7061               vpa
+00006570: 7468 203d 2073 656c 662e 7276 6f6c 5b30  th = self.rvol[0
+00006580: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
+00006590: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+000065a0: 2020 2020 2020 2020 2020 2020 7670 6174              vpat
+000065b0: 6820 3d20 7365 6c66 2e77 766f 6c5b 305d  h = self.wvol[0]
+000065c0: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+000065d0: 2020 6966 2073 656c 662e 7670 6174 6820    if self.vpath 
+000065e0: 213d 2076 7061 7468 3a0a 2020 2020 2020  != vpath:.      
+000065f0: 2020 2020 2020 2020 2020 2020 2020 7365                se
+00006600: 6c66 2e72 6564 6972 6563 7428 7670 6174  lf.redirect(vpat
+00006610: 682c 2066 6c61 766f 723d 2272 6564 6972  h, flavor="redir
+00006620: 6563 7469 6e67 2074 6f22 2c20 7573 6533  ecting to", use3
+00006630: 3032 3d54 7275 6529 0a20 2020 2020 2020  02=True).       
+00006640: 2020 2020 2020 2020 2020 2020 2072 6574               ret
+00006650: 7572 6e20 5472 7565 0a0a 2020 2020 2020  urn True..      
+00006660: 2020 7265 7475 726e 2073 656c 662e 7478    return self.tx
+00006670: 5f62 726f 7773 6572 2829 0a0a 2020 2020  _browser()..    
+00006680: 6465 6620 6861 6e64 6c65 5f70 726f 7066  def handle_propf
+00006690: 696e 6428 7365 6c66 2920 203a 0a20 2020  ind(self)  :.   
+000066a0: 2020 2020 2069 6620 7365 6c66 2e64 6f5f       if self.do_
+000066b0: 6c6f 673a 0a20 2020 2020 2020 2020 2020  log:.           
+000066c0: 2073 656c 662e 6c6f 6728 2250 4649 4e44   self.log("PFIND
+000066d0: 2025 7320 4025 7322 2025 2028 7365 6c66   %s @%s" % (self
+000066e0: 2e72 6571 2c20 7365 6c66 2e75 6e61 6d65  .req, self.uname
+000066f0: 2929 0a0a 2020 2020 2020 2020 6966 2073  ))..        if s
+00006700: 656c 662e 6172 6773 2e6e 6f5f 6461 763a  elf.args.no_dav:
+00006710: 0a20 2020 2020 2020 2020 2020 2072 6169  .            rai
+00006720: 7365 2050 6562 6b61 6328 3430 352c 2022  se Pebkac(405, "
+00006730: 5765 6244 4156 2069 7320 6469 7361 626c  WebDAV is disabl
+00006740: 6564 2069 6e20 7365 7276 6572 2063 6f6e  ed in server con
+00006750: 6669 6722 290a 0a20 2020 2020 2020 2076  fig")..        v
+00006760: 6e2c 2072 656d 203d 2073 656c 662e 6173  n, rem = self.as
+00006770: 7276 2e76 6673 2e67 6574 2873 656c 662e  rv.vfs.get(self.
+00006780: 7670 6174 682c 2073 656c 662e 756e 616d  vpath, self.unam
+00006790: 652c 2046 616c 7365 2c20 4661 6c73 652c  e, False, False,
+000067a0: 2065 7272 3d34 3031 290a 2020 2020 2020   err=401).      
+000067b0: 2020 7461 7020 3d20 766e 2e63 616e 6f6e    tap = vn.canon
+000067c0: 6963 616c 2872 656d 290a 0a20 2020 2020  ical(rem)..     
+000067d0: 2020 2069 6620 2264 6176 6175 7468 2220     if "davauth" 
+000067e0: 696e 2076 6e2e 666c 6167 7320 616e 6420  in vn.flags and 
+000067f0: 7365 6c66 2e75 6e61 6d65 203d 3d20 222a  self.uname == "*
+00006800: 223a 0a20 2020 2020 2020 2020 2020 2073  ":.            s
+00006810: 656c 662e 6361 6e5f 7265 6164 203d 2073  elf.can_read = s
+00006820: 656c 662e 6361 6e5f 7772 6974 6520 3d20  elf.can_write = 
+00006830: 7365 6c66 2e63 616e 5f67 6574 203d 2046  self.can_get = F
+00006840: 616c 7365 0a0a 2020 2020 2020 2020 6966  alse..        if
+00006850: 206e 6f74 2073 656c 662e 6361 6e5f 7265   not self.can_re
+00006860: 6164 2061 6e64 206e 6f74 2073 656c 662e  ad and not self.
+00006870: 6361 6e5f 7772 6974 6520 616e 6420 6e6f  can_write and no
+00006880: 7420 7365 6c66 2e63 616e 5f67 6574 3a0a  t self.can_get:.
+00006890: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+000068a0: 2e6c 6f67 2822 696e 6163 6365 7373 6962  .log("inaccessib
+000068b0: 6c65 3a20 5b7b 7d5d 222e 666f 726d 6174  le: [{}]".format
+000068c0: 2873 656c 662e 7670 6174 6829 290a 2020  (self.vpath)).  
+000068d0: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
+000068e0: 5065 626b 6163 2834 3031 2c20 2261 7574  Pebkac(401, "aut
+000068f0: 6865 6e74 6963 6174 6522 290a 0a20 2020  henticate")..   
+00006900: 2020 2020 2066 726f 6d20 2e64 786d 6c20       from .dxml 
+00006910: 696d 706f 7274 2070 6172 7365 5f78 6d6c  import parse_xml
+00006920: 0a0a 2020 2020 2020 2020 2320 656e 6320  ..        # enc 
+00006930: 3d20 2277 696e 646f 7773 2d33 316a 220a  = "windows-31j".
+00006940: 2020 2020 2020 2020 2320 656e 6320 3d20          # enc = 
+00006950: 2273 6869 6674 5f6a 6973 220a 2020 2020  "shift_jis".    
+00006960: 2020 2020 656e 6320 3d20 2275 7466 2d38      enc = "utf-8
+00006970: 220a 2020 2020 2020 2020 7565 6e63 203d  ".        uenc =
+00006980: 2065 6e63 2e75 7070 6572 2829 0a0a 2020   enc.upper()..  
+00006990: 2020 2020 2020 636c 656e 203d 2069 6e74        clen = int
+000069a0: 2873 656c 662e 6865 6164 6572 732e 6765  (self.headers.ge
+000069b0: 7428 2263 6f6e 7465 6e74 2d6c 656e 6774  t("content-lengt
+000069c0: 6822 2c20 3029 290a 2020 2020 2020 2020  h", 0)).        
+000069d0: 6966 2063 6c65 6e3a 0a20 2020 2020 2020  if clen:.       
+000069e0: 2020 2020 2062 7566 203d 2062 2222 0a20       buf = b"". 
+000069f0: 2020 2020 2020 2020 2020 2066 6f72 2072             for r
+00006a00: 6275 6620 696e 2073 656c 662e 6765 745f  buf in self.get_
+00006a10: 626f 6479 5f72 6561 6465 7228 295b 305d  body_reader()[0]
+00006a20: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00006a30: 2020 6275 6620 2b3d 2072 6275 660a 2020    buf += rbuf.  
+00006a40: 2020 2020 2020 2020 2020 2020 2020 6966                if
+00006a50: 206e 6f74 2072 6275 6620 6f72 206c 656e   not rbuf or len
+00006a60: 2862 7566 2920 3e3d 2033 3237 3638 3a0a  (buf) >= 32768:.
+00006a70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006a80: 2020 2020 6272 6561 6b0a 0a20 2020 2020      break..     
+00006a90: 2020 2020 2020 2078 726f 6f74 203d 2070         xroot = p
+00006aa0: 6172 7365 5f78 6d6c 2862 7566 2e64 6563  arse_xml(buf.dec
+00006ab0: 6f64 6528 656e 632c 2022 7265 706c 6163  ode(enc, "replac
+00006ac0: 6522 2929 0a20 2020 2020 2020 2020 2020  e")).           
+00006ad0: 2078 7461 6720 3d20 6e65 7874 2878 2066   xtag = next(x f
+00006ae0: 6f72 2078 2069 6e20 7872 6f6f 7420 6966  or x in xroot if
+00006af0: 2078 2e74 6167 2e73 706c 6974 2822 7d22   x.tag.split("}"
+00006b00: 295b 2d31 5d20 3d3d 2022 7072 6f70 2229  )[-1] == "prop")
+00006b10: 0a20 2020 2020 2020 2020 2020 2070 726f  .            pro
+00006b20: 7073 5f6c 7374 203d 205b 792e 7461 672e  ps_lst = [y.tag.
+00006b30: 7370 6c69 7428 227d 2229 5b2d 315d 2066  split("}")[-1] f
+00006b40: 6f72 2079 2069 6e20 7874 6167 5d0a 2020  or y in xtag].  
+00006b50: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+00006b60: 2020 2020 2020 2020 7072 6f70 735f 6c73          props_ls
+00006b70: 7420 3d20 5b0a 2020 2020 2020 2020 2020  t = [.          
+00006b80: 2020 2020 2020 2263 6f6e 7465 6e74 636c        "contentcl
+00006b90: 6173 7322 2c0a 2020 2020 2020 2020 2020  ass",.          
+00006ba0: 2020 2020 2020 2263 7265 6174 696f 6e64        "creationd
+00006bb0: 6174 6522 2c0a 2020 2020 2020 2020 2020  ate",.          
+00006bc0: 2020 2020 2020 2264 6566 6175 6c74 646f        "defaultdo
+00006bd0: 6375 6d65 6e74 222c 0a20 2020 2020 2020  cument",.       
+00006be0: 2020 2020 2020 2020 2022 6469 7370 6c61           "displa
+00006bf0: 796e 616d 6522 2c0a 2020 2020 2020 2020  yname",.        
+00006c00: 2020 2020 2020 2020 2267 6574 636f 6e74          "getcont
+00006c10: 656e 746c 616e 6775 6167 6522 2c0a 2020  entlanguage",.  
+00006c20: 2020 2020 2020 2020 2020 2020 2020 2267                "g
+00006c30: 6574 636f 6e74 656e 746c 656e 6774 6822  etcontentlength"
+00006c40: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00006c50: 2020 2267 6574 636f 6e74 656e 7474 7970    "getcontenttyp
+00006c60: 6522 2c0a 2020 2020 2020 2020 2020 2020  e",.            
+00006c70: 2020 2020 2267 6574 6c61 7374 6d6f 6469      "getlastmodi
+00006c80: 6669 6564 222c 0a20 2020 2020 2020 2020  fied",.         
+00006c90: 2020 2020 2020 2022 6872 6566 222c 0a20         "href",. 
+00006ca0: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+00006cb0: 6973 636f 6c6c 6563 7469 6f6e 222c 0a20  iscollection",. 
+00006cc0: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+00006cd0: 6973 6869 6464 656e 222c 0a20 2020 2020  ishidden",.     
+00006ce0: 2020 2020 2020 2020 2020 2022 6973 7265             "isre
+00006cf0: 6164 6f6e 6c79 222c 0a20 2020 2020 2020  adonly",.       
+00006d00: 2020 2020 2020 2020 2022 6973 726f 6f74           "isroot
+00006d10: 222c 0a20 2020 2020 2020 2020 2020 2020  ",.             
+00006d20: 2020 2022 6973 7374 7275 6374 7572 6564     "isstructured
+00006d30: 646f 6375 6d65 6e74 222c 0a20 2020 2020  document",.     
+00006d40: 2020 2020 2020 2020 2020 2022 6c61 7374             "last
+00006d50: 6163 6365 7373 6564 222c 0a20 2020 2020  accessed",.     
+00006d60: 2020 2020 2020 2020 2020 2022 6e61 6d65             "name
+00006d70: 222c 0a20 2020 2020 2020 2020 2020 2020  ",.             
+00006d80: 2020 2022 7061 7265 6e74 6e61 6d65 222c     "parentname",
+00006d90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00006da0: 2022 7265 736f 7572 6365 7479 7065 222c   "resourcetype",
+00006db0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00006dc0: 2022 7375 7070 6f72 7465 646c 6f63 6b22   "supportedlock"
+00006dd0: 2c0a 2020 2020 2020 2020 2020 2020 5d0a  ,.            ].
+00006de0: 0a20 2020 2020 2020 2070 726f 7073 203d  .        props =
+00006df0: 2073 6574 2870 726f 7073 5f6c 7374 290a   set(props_lst).
+00006e00: 2020 2020 2020 2020 6465 7074 6820 3d20          depth = 
+00006e10: 7365 6c66 2e68 6561 6465 7273 2e67 6574  self.headers.get
+00006e20: 2822 6465 7074 6822 2c20 2269 6e66 696e  ("depth", "infin
+00006e30: 6974 7922 292e 6c6f 7765 7228 290a 0a20  ity").lower().. 
+00006e40: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
+00006e50: 2020 2020 2020 2020 746f 7064 6972 203d          topdir =
+00006e60: 207b 2276 7022 3a20 2222 2c20 2273 7422   {"vp": "", "st"
+00006e70: 3a20 626f 732e 7374 6174 2874 6170 297d  : bos.stat(tap)}
+00006e80: 0a20 2020 2020 2020 2065 7863 6570 7420  .        except 
+00006e90: 4f53 4572 726f 7220 6173 2065 783a 0a20  OSError as ex:. 
+00006ea0: 2020 2020 2020 2020 2020 2069 6620 6578             if ex
+00006eb0: 2e65 7272 6e6f 206e 6f74 2069 6e20 2865  .errno not in (e
+00006ec0: 7272 6e6f 2e45 4e4f 454e 542c 2065 7272  rrno.ENOENT, err
+00006ed0: 6e6f 2e45 4e4f 5444 4952 293a 0a20 2020  no.ENOTDIR):.   
+00006ee0: 2020 2020 2020 2020 2020 2020 2072 6169               rai
+00006ef0: 7365 0a20 2020 2020 2020 2020 2020 2072  se.            r
+00006f00: 6169 7365 2050 6562 6b61 6328 3430 3429  aise Pebkac(404)
+00006f10: 0a0a 2020 2020 2020 2020 6966 2064 6570  ..        if dep
+00006f20: 7468 203d 3d20 2230 2220 6f72 206e 6f74  th == "0" or not
+00006f30: 2073 656c 662e 6361 6e5f 7265 6164 206f   self.can_read o
+00006f40: 7220 6e6f 7420 7374 6174 2e53 5f49 5344  r not stat.S_ISD
+00006f50: 4952 2874 6f70 6469 725b 2273 7422 5d2e  IR(topdir["st"].
+00006f60: 7374 5f6d 6f64 6529 3a0a 2020 2020 2020  st_mode):.      
+00006f70: 2020 2020 2020 6667 656e 203d 205b 5d0a        fgen = [].
+00006f80: 0a20 2020 2020 2020 2065 6c69 6620 6465  .        elif de
+00006f90: 7074 6820 3d3d 2022 696e 6669 6e69 7479  pth == "infinity
+00006fa0: 223a 0a20 2020 2020 2020 2020 2020 2069  ":.            i
+00006fb0: 6620 6e6f 7420 7365 6c66 2e61 7267 732e  f not self.args.
+00006fc0: 6461 765f 696e 663a 0a20 2020 2020 2020  dav_inf:.       
+00006fd0: 2020 2020 2020 2020 2073 656c 662e 6c6f           self.lo
+00006fe0: 6728 2263 6c69 656e 7420 7761 6e74 7320  g("client wants 
+00006ff0: 2d2d 6461 762d 696e 6622 2c20 3329 0a20  --dav-inf", 3). 
+00007000: 2020 2020 2020 2020 2020 2020 2020 207a                 z
+00007010: 6220 3d20 6227 3c3f 786d 6c20 7665 7273  b = b'<?xml vers
+00007020: 696f 6e3d 2231 2e30 2220 656e 636f 6469  ion="1.0" encodi
+00007030: 6e67 3d22 7574 662d 3822 3f3e 5c6e 3c44  ng="utf-8"?>\n<D
+00007040: 3a65 7272 6f72 2078 6d6c 6e73 3a44 3d22  :error xmlns:D="
+00007050: 4441 563a 223e 3c44 3a70 726f 7066 696e  DAV:"><D:propfin
+00007060: 642d 6669 6e69 7465 2d64 6570 7468 2f3e  d-finite-depth/>
+00007070: 3c2f 443a 6572 726f 723e 270a 2020 2020  </D:error>'.    
+00007080: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+00007090: 2e72 6570 6c79 287a 622c 2034 3033 2c20  .reply(zb, 403, 
+000070a0: 2261 7070 6c69 6361 7469 6f6e 2f78 6d6c  "application/xml
+000070b0: 3b20 6368 6172 7365 743d 7574 662d 3822  ; charset=utf-8"
+000070c0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+000070d0: 2020 7265 7475 726e 2054 7275 650a 0a20    return True.. 
+000070e0: 2020 2020 2020 2020 2020 2023 2074 6869             # thi
+000070f0: 7320 7769 6c6c 2072 6574 7572 6e20 7379  s will return sy
+00007100: 6d6c 696e 6b2d 7461 7267 6574 2074 696d  mlink-target tim
+00007110: 6573 7461 6d70 730a 2020 2020 2020 2020  estamps.        
+00007120: 2020 2020 2320 6265 6361 7573 6520 6c73      # because ls
+00007130: 7461 743d 7472 7565 2077 6f75 6c64 206e  tat=true would n
+00007140: 6f74 2072 6563 7572 7365 2069 6e74 6f20  ot recurse into 
+00007150: 7375 6266 6f6c 6465 7273 0a20 2020 2020  subfolders.     
+00007160: 2020 2020 2020 2023 2061 6e64 2074 6869         # and thi
+00007170: 7320 6973 2061 2072 6172 6520 6361 7365  s is a rare case
+00007180: 2077 6865 7265 2077 6520 6163 7475 616c   where we actual
+00007190: 6c79 2077 616e 7420 7468 6174 0a20 2020  ly want that.   
+000071a0: 2020 2020 2020 2020 2066 6765 6e20 3d20           fgen = 
+000071b0: 766e 2e7a 6970 6765 6e28 0a20 2020 2020  vn.zipgen(.     
+000071c0: 2020 2020 2020 2020 2020 2072 656d 2c0a             rem,.
+000071d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000071e0: 7265 6d2c 0a20 2020 2020 2020 2020 2020  rem,.           
+000071f0: 2020 2020 2073 6574 2829 2c0a 2020 2020       set(),.    
+00007200: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+00007210: 2e75 6e61 6d65 2c0a 2020 2020 2020 2020  .uname,.        
+00007220: 2020 2020 2020 2020 7365 6c66 2e61 7267          self.arg
+00007230: 732e 6564 2c0a 2020 2020 2020 2020 2020  s.ed,.          
+00007240: 2020 2020 2020 5472 7565 2c0a 2020 2020        True,.    
+00007250: 2020 2020 2020 2020 2020 2020 6e6f 7420              not 
+00007260: 7365 6c66 2e61 7267 732e 6e6f 5f73 6361  self.args.no_sca
+00007270: 6e64 6972 2c0a 2020 2020 2020 2020 2020  ndir,.          
+00007280: 2020 2020 2020 7772 6170 3d46 616c 7365        wrap=False
+00007290: 2c0a 2020 2020 2020 2020 2020 2020 290a  ,.            ).
+000072a0: 0a20 2020 2020 2020 2065 6c69 6620 6465  .        elif de
+000072b0: 7074 6820 3d3d 2022 3122 3a0a 2020 2020  pth == "1":.    
+000072c0: 2020 2020 2020 2020 5f2c 2076 6673 5f6c          _, vfs_l
+000072d0: 732c 2076 6673 5f76 6972 7420 3d20 766e  s, vfs_virt = vn
+000072e0: 2e6c 7328 0a20 2020 2020 2020 2020 2020  .ls(.           
+000072f0: 2020 2020 2072 656d 2c0a 2020 2020 2020       rem,.      
+00007300: 2020 2020 2020 2020 2020 7365 6c66 2e75            self.u
+00007310: 6e61 6d65 2c0a 2020 2020 2020 2020 2020  name,.          
+00007320: 2020 2020 2020 6e6f 7420 7365 6c66 2e61        not self.a
+00007330: 7267 732e 6e6f 5f73 6361 6e64 6972 2c0a  rgs.no_scandir,.
+00007340: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007350: 5b5b 5472 7565 2c20 4661 6c73 655d 5d2c  [[True, False]],
+00007360: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00007370: 206c 7374 6174 3d22 6461 7672 7422 206e   lstat="davrt" n
+00007380: 6f74 2069 6e20 766e 2e66 6c61 6773 2c0a  ot in vn.flags,.
+00007390: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
+000073a0: 2020 2020 2020 2020 2020 6966 206e 6f74            if not
+000073b0: 2073 656c 662e 6172 6773 2e65 643a 0a20   self.args.ed:. 
+000073c0: 2020 2020 2020 2020 2020 2020 2020 206e                 n
+000073d0: 616d 6573 203d 2073 6574 2865 7863 6c75  ames = set(exclu
+000073e0: 6465 5f64 6f74 6669 6c65 7328 5b78 5b30  de_dotfiles([x[0
+000073f0: 5d20 666f 7220 7820 696e 2076 6673 5f6c  ] for x in vfs_l
+00007400: 735d 2929 0a20 2020 2020 2020 2020 2020  s])).           
+00007410: 2020 2020 2076 6673 5f6c 7320 3d20 5b78       vfs_ls = [x
+00007420: 2066 6f72 2078 2069 6e20 7666 735f 6c73   for x in vfs_ls
+00007430: 2069 6620 785b 305d 2069 6e20 6e61 6d65   if x[0] in name
+00007440: 735d 0a0a 2020 2020 2020 2020 2020 2020  s]..            
+00007450: 7a69 203d 2069 6e74 2874 696d 652e 7469  zi = int(time.ti
+00007460: 6d65 2829 290a 2020 2020 2020 2020 2020  me()).          
+00007470: 2020 7a73 7220 3d20 6f73 2e73 7461 745f    zsr = os.stat_
+00007480: 7265 7375 6c74 2828 3136 3837 372c 202d  result((16877, -
+00007490: 312c 202d 312c 2031 2c20 3130 3030 2c20  1, -1, 1, 1000, 
+000074a0: 3130 3030 2c20 382c 207a 692c 207a 692c  1000, 8, zi, zi,
+000074b0: 207a 6929 290a 2020 2020 2020 2020 2020   zi)).          
+000074c0: 2020 6c73 203d 205b 7b22 7670 223a 2076    ls = [{"vp": v
+000074d0: 702c 2022 7374 223a 2073 747d 2066 6f72  p, "st": st} for
+000074e0: 2076 702c 2073 7420 696e 2076 6673 5f6c   vp, st in vfs_l
+000074f0: 735d 0a20 2020 2020 2020 2020 2020 206c  s].            l
+00007500: 7320 2b3d 205b 7b22 7670 223a 2076 2c20  s += [{"vp": v, 
+00007510: 2273 7422 3a20 7a73 727d 2066 6f72 2076  "st": zsr} for v
+00007520: 2069 6e20 7666 735f 7669 7274 5d0a 2020   in vfs_virt].  
+00007530: 2020 2020 2020 2020 2020 6667 656e 203d            fgen =
+00007540: 206c 7320 2023 2074 7970 653a 2069 676e   ls  # type: ign
+00007550: 6f72 650a 0a20 2020 2020 2020 2065 6c73  ore..        els
+00007560: 653a 0a20 2020 2020 2020 2020 2020 2074  e:.            t
+00007570: 203d 2022 696e 7661 6c69 6420 6465 7074   = "invalid dept
+00007580: 6820 7661 6c75 6520 277b 7d27 2028 6d75  h value '{}' (mu
+00007590: 7374 2062 6520 6569 7468 6572 2027 3027  st be either '0'
+000075a0: 206f 7220 2731 277b 7d29 220a 2020 2020   or '1'{})".    
+000075b0: 2020 2020 2020 2020 7432 203d 2022 206f          t2 = " o
+000075c0: 7220 2769 6e66 696e 6974 7927 2220 6966  r 'infinity'" if
+000075d0: 2073 656c 662e 6172 6773 2e64 6176 5f69   self.args.dav_i
+000075e0: 6e66 2065 6c73 6520 2222 0a20 2020 2020  nf else "".     
+000075f0: 2020 2020 2020 2072 6169 7365 2050 6562         raise Peb
+00007600: 6b61 6328 3431 322c 2074 2e66 6f72 6d61  kac(412, t.forma
+00007610: 7428 6465 7074 682c 2074 3229 290a 0a20  t(depth, t2)).. 
+00007620: 2020 2020 2020 2066 6765 6e20 3d20 6974         fgen = it
+00007630: 6572 746f 6f6c 732e 6368 6169 6e28 5b74  ertools.chain([t
+00007640: 6f70 6469 725d 2c20 6667 656e 2920 2023  opdir], fgen)  #
+00007650: 2074 7970 653a 2069 676e 6f72 650a 2020   type: ignore.  
+00007660: 2020 2020 2020 7674 6f70 203d 2076 6a6f        vtop = vjo
+00007670: 696e 2873 656c 662e 6172 6773 2e52 2c20  in(self.args.R, 
+00007680: 766a 6f69 6e28 766e 2e76 7061 7468 2c20  vjoin(vn.vpath, 
+00007690: 7265 6d29 290a 0a20 2020 2020 2020 2063  rem))..        c
+000076a0: 6875 6e6b 737a 203d 2030 7837 4646 3820  hunksz = 0x7FF8 
+000076b0: 2023 2070 7265 6665 7272 6564 2062 7920   # preferred by 
+000076c0: 6e67 696e 7820 6f72 2063 6620 2864 756e  nginx or cf (dun
+000076d0: 6e6f 2077 6869 6368 290a 0a20 2020 2020  no which)..     
+000076e0: 2020 2073 656c 662e 7365 6e64 5f68 6561     self.send_hea
+000076f0: 6465 7273 280a 2020 2020 2020 2020 2020  ders(.          
+00007700: 2020 4e6f 6e65 2c20 3230 372c 2022 7465    None, 207, "te
+00007710: 7874 2f78 6d6c 3b20 6368 6172 7365 743d  xt/xml; charset=
+00007720: 2220 2b20 656e 632c 207b 2254 7261 6e73  " + enc, {"Trans
+00007730: 6665 722d 456e 636f 6469 6e67 223a 2022  fer-Encoding": "
+00007740: 6368 756e 6b65 6422 7d0a 2020 2020 2020  chunked"}.      
+00007750: 2020 290a 0a20 2020 2020 2020 2072 6574    )..        ret
+00007760: 203d 2027 3c3f 786d 6c20 7665 7273 696f   = '<?xml versio
+00007770: 6e3d 2231 2e30 2220 656e 636f 6469 6e67  n="1.0" encoding
+00007780: 3d22 7b7d 223f 3e5c 6e3c 443a 6d75 6c74  ="{}"?>\n<D:mult
+00007790: 6973 7461 7475 7320 786d 6c6e 733a 443d  istatus xmlns:D=
+000077a0: 2244 4156 3a22 3e27 0a20 2020 2020 2020  "DAV:">'.       
+000077b0: 2072 6574 203d 2072 6574 2e66 6f72 6d61   ret = ret.forma
+000077c0: 7428 7565 6e63 290a 2020 2020 2020 2020  t(uenc).        
+000077d0: 666f 7220 7820 696e 2066 6765 6e3a 0a20  for x in fgen:. 
+000077e0: 2020 2020 2020 2020 2020 2072 7020 3d20             rp = 
+000077f0: 766a 6f69 6e28 7674 6f70 2c20 785b 2276  vjoin(vtop, x["v
+00007800: 7022 5d29 0a20 2020 2020 2020 2020 2020  p"]).           
+00007810: 2073 7420 203d 2078 5b22 7374 225d 0a20   st  = x["st"]. 
+00007820: 2020 2020 2020 2020 2020 206d 7469 6d65             mtime
+00007830: 203d 2073 742e 7374 5f6d 7469 6d65 0a20   = st.st_mtime. 
+00007840: 2020 2020 2020 2020 2020 2069 6620 7374             if st
+00007850: 6174 2e53 5f49 534c 4e4b 2873 742e 7374  at.S_ISLNK(st.st
+00007860: 5f6d 6f64 6529 3a0a 2020 2020 2020 2020  _mode):.        
+00007870: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
 00007880: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007890: 2020 636f 6e74 696e 7565 0a0a 2020 2020    continue..    
-000078a0: 2020 2020 2020 2020 6973 6469 7220 3d20          isdir = 
-000078b0: 7374 6174 2e53 5f49 5344 4952 2873 742e  stat.S_ISDIR(st.
-000078c0: 7374 5f6d 6f64 6529 0a0a 2020 2020 2020  st_mode)..      
-000078d0: 2020 2020 2020 7265 7420 2b3d 2022 3c44        ret += "<D
-000078e0: 3a72 6573 706f 6e73 653e 3c44 3a68 7265  :response><D:hre
-000078f0: 663e 2f25 7325 733c 2f44 3a68 7265 663e  f>/%s%s</D:href>
-00007900: 3c44 3a70 726f 7073 7461 743e 3c44 3a70  <D:propstat><D:p
-00007910: 726f 703e 2220 2520 280a 2020 2020 2020  rop>" % (.      
-00007920: 2020 2020 2020 2020 2020 7175 6f74 6570            quotep
-00007930: 2872 7029 2c0a 2020 2020 2020 2020 2020  (rp),.          
-00007940: 2020 2020 2020 222f 2220 6966 2069 7364        "/" if isd
-00007950: 6972 2061 6e64 2072 7020 656c 7365 2022  ir and rp else "
-00007960: 222c 0a20 2020 2020 2020 2020 2020 2029  ",.            )
-00007970: 0a0a 2020 2020 2020 2020 2020 2020 7076  ..            pv
-00007980: 7320 2020 3d20 7b0a 2020 2020 2020 2020  s   = {.        
-00007990: 2020 2020 2020 2020 2264 6973 706c 6179          "display
-000079a0: 6e61 6d65 223a 2068 746d 6c5f 6573 6361  name": html_esca
-000079b0: 7065 2872 702e 7370 6c69 7428 222f 2229  pe(rp.split("/")
-000079c0: 5b2d 315d 292c 0a20 2020 2020 2020 2020  [-1]),.         
-000079d0: 2020 2020 2020 2022 6765 746c 6173 746d         "getlastm
-000079e0: 6f64 6966 6965 6422 3a20 666f 726d 6174  odified": format
-000079f0: 6461 7465 286d 7469 6d65 2c20 7573 6567  date(mtime, useg
-00007a00: 6d74 3d54 7275 6529 2c0a 2020 2020 2020  mt=True),.      
-00007a10: 2020 2020 2020 2020 2020 2272 6573 6f75            "resou
-00007a20: 7263 6574 7970 6522 3a20 273c 443a 636f  rcetype": '<D:co
-00007a30: 6c6c 6563 7469 6f6e 2078 6d6c 6e73 3a44  llection xmlns:D
-00007a40: 3d22 4441 563a 222f 3e27 2069 6620 6973  ="DAV:"/>' if is
-00007a50: 6469 7220 656c 7365 2022 222c 0a20 2020  dir else "",.   
-00007a60: 2020 2020 2020 2020 2020 2020 2022 7375               "su
-00007a70: 7070 6f72 7465 646c 6f63 6b22 3a20 273c  pportedlock": '<
-00007a80: 443a 6c6f 636b 656e 7472 7920 786d 6c6e  D:lockentry xmln
-00007a90: 733a 443d 2244 4156 3a22 3e3c 443a 6c6f  s:D="DAV:"><D:lo
-00007aa0: 636b 7363 6f70 653e 3c44 3a65 7863 6c75  ckscope><D:exclu
-00007ab0: 7369 7665 2f3e 3c2f 443a 6c6f 636b 7363  sive/></D:locksc
-00007ac0: 6f70 653e 3c44 3a6c 6f63 6b74 7970 653e  ope><D:locktype>
-00007ad0: 3c44 3a77 7269 7465 2f3e 3c2f 443a 6c6f  <D:write/></D:lo
-00007ae0: 636b 7479 7065 3e3c 2f44 3a6c 6f63 6b65  cktype></D:locke
-00007af0: 6e74 7279 3e27 2c0a 2020 2020 2020 2020  ntry>',.        
-00007b00: 2020 2020 7d0a 2020 2020 2020 2020 2020      }.          
-00007b10: 2020 6966 206e 6f74 2069 7364 6972 3a0a    if not isdir:.
-00007b20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007b30: 7076 735b 2267 6574 636f 6e74 656e 7474  pvs["getcontentt
-00007b40: 7970 6522 5d20 3d20 6874 6d6c 5f65 7363  ype"] = html_esc
-00007b50: 6170 6528 6775 6573 735f 6d69 6d65 2872  ape(guess_mime(r
-00007b60: 7029 290a 2020 2020 2020 2020 2020 2020  p)).            
-00007b70: 2020 2020 7076 735b 2267 6574 636f 6e74      pvs["getcont
-00007b80: 656e 746c 656e 6774 6822 5d20 3d20 7374  entlength"] = st
-00007b90: 7228 7374 2e73 745f 7369 7a65 290a 0a20  r(st.st_size).. 
-00007ba0: 2020 2020 2020 2020 2020 2066 6f72 206b             for k
-00007bb0: 2c20 7620 696e 2070 7673 2e69 7465 6d73  , v in pvs.items
-00007bc0: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
-00007bd0: 2020 2020 6966 206b 206e 6f74 2069 6e20      if k not in 
-00007be0: 7072 6f70 733a 0a20 2020 2020 2020 2020  props:.         
-00007bf0: 2020 2020 2020 2020 2020 2063 6f6e 7469             conti
-00007c00: 6e75 650a 2020 2020 2020 2020 2020 2020  nue.            
-00007c10: 2020 2020 656c 6966 2076 3a0a 2020 2020      elif v:.    
-00007c20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007c30: 7265 7420 2b3d 2022 3c44 3a25 733e 2573  ret += "<D:%s>%s
-00007c40: 3c2f 443a 2573 3e22 2025 2028 6b2c 2076  </D:%s>" % (k, v
-00007c50: 2c20 6b29 0a20 2020 2020 2020 2020 2020  , k).           
-00007c60: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-00007c70: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-00007c80: 6574 202b 3d20 223c 443a 2573 2f3e 2220  et += "<D:%s/>" 
-00007c90: 2520 286b 2c29 0a0a 2020 2020 2020 2020  % (k,)..        
-00007ca0: 2020 2020 7265 7420 2b3d 2022 3c2f 443a      ret += "</D:
-00007cb0: 7072 6f70 3e3c 443a 7374 6174 7573 3e48  prop><D:status>H
-00007cc0: 5454 502f 312e 3120 3230 3020 4f4b 3c2f  TTP/1.1 200 OK</
-00007cd0: 443a 7374 6174 7573 3e3c 2f44 3a70 726f  D:status></D:pro
-00007ce0: 7073 7461 743e 220a 0a20 2020 2020 2020  pstat>"..       
-00007cf0: 2020 2020 206d 6973 7369 6e67 203d 205b       missing = [
-00007d00: 223c 443a 2573 2f3e 2220 2520 2878 2c29  "<D:%s/>" % (x,)
-00007d10: 2066 6f72 2078 2069 6e20 7072 6f70 7320   for x in props 
-00007d20: 6966 2078 206e 6f74 2069 6e20 7076 735d  if x not in pvs]
-00007d30: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-00007d40: 6d69 7373 696e 6720 616e 6420 636c 656e  missing and clen
-00007d50: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00007d60: 2020 7420 3d20 223c 443a 7072 6f70 7374    t = "<D:propst
-00007d70: 6174 3e3c 443a 7072 6f70 3e7b 7d3c 2f44  at><D:prop>{}</D
-00007d80: 3a70 726f 703e 3c44 3a73 7461 7475 733e  :prop><D:status>
-00007d90: 4854 5450 2f31 2e31 2034 3034 204e 6f74  HTTP/1.1 404 Not
-00007da0: 2046 6f75 6e64 3c2f 443a 7374 6174 7573   Found</D:status
-00007db0: 3e3c 2f44 3a70 726f 7073 7461 743e 220a  ></D:propstat>".
-00007dc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007dd0: 7265 7420 2b3d 2074 2e66 6f72 6d61 7428  ret += t.format(
-00007de0: 2222 2e6a 6f69 6e28 6d69 7373 696e 6729  "".join(missing)
-00007df0: 290a 0a20 2020 2020 2020 2020 2020 2072  )..            r
-00007e00: 6574 202b 3d20 223c 2f44 3a72 6573 706f  et += "</D:respo
-00007e10: 6e73 653e 220a 2020 2020 2020 2020 2020  nse>".          
-00007e20: 2020 7768 696c 6520 6c65 6e28 7265 7429    while len(ret)
-00007e30: 203e 3d20 6368 756e 6b73 7a3a 0a20 2020   >= chunksz:.   
-00007e40: 2020 2020 2020 2020 2020 2020 2072 6574               ret
-00007e50: 203d 2073 656c 662e 7365 6e64 5f63 6875   = self.send_chu
-00007e60: 6e6b 2872 6574 2c20 656e 632c 2063 6875  nk(ret, enc, chu
-00007e70: 6e6b 737a 290a 0a20 2020 2020 2020 2072  nksz)..        r
-00007e80: 6574 202b 3d20 223c 2f44 3a6d 756c 7469  et += "</D:multi
-00007e90: 7374 6174 7573 3e22 0a20 2020 2020 2020  status>".       
-00007ea0: 2077 6869 6c65 2072 6574 3a0a 2020 2020   while ret:.    
-00007eb0: 2020 2020 2020 2020 7265 7420 3d20 7365          ret = se
-00007ec0: 6c66 2e73 656e 645f 6368 756e 6b28 7265  lf.send_chunk(re
-00007ed0: 742c 2065 6e63 2c20 6368 756e 6b73 7a29  t, enc, chunksz)
-00007ee0: 0a0a 2020 2020 2020 2020 7365 6c66 2e73  ..        self.s
-00007ef0: 656e 645f 6368 756e 6b28 2222 2c20 656e  end_chunk("", en
-00007f00: 632c 2063 6875 6e6b 737a 290a 2020 2020  c, chunksz).    
-00007f10: 2020 2020 2320 7365 6c66 2e72 6570 6c79      # self.reply
-00007f20: 2872 6574 2e65 6e63 6f64 6528 656e 632c  (ret.encode(enc,
-00007f30: 2022 7265 706c 6163 6522 292c 3230 372c   "replace"),207,
-00007f40: 2022 7465 7874 2f78 6d6c 3b20 6368 6172   "text/xml; char
-00007f50: 7365 743d 2220 2b20 656e 6329 0a20 2020  set=" + enc).   
-00007f60: 2020 2020 2072 6574 7572 6e20 5472 7565       return True
-00007f70: 0a0a 2020 2020 6465 6620 6861 6e64 6c65  ..    def handle
-00007f80: 5f70 726f 7070 6174 6368 2873 656c 6629  _proppatch(self)
-00007f90: 2020 3a0a 2020 2020 2020 2020 6966 2073    :.        if s
-00007fa0: 656c 662e 646f 5f6c 6f67 3a0a 2020 2020  elf.do_log:.    
-00007fb0: 2020 2020 2020 2020 7365 6c66 2e6c 6f67          self.log
-00007fc0: 2822 5050 4154 4348 2022 202b 2073 656c  ("PPATCH " + sel
-00007fd0: 662e 7265 7129 0a0a 2020 2020 2020 2020  f.req)..        
-00007fe0: 6966 2073 656c 662e 6172 6773 2e6e 6f5f  if self.args.no_
-00007ff0: 6461 763a 0a20 2020 2020 2020 2020 2020  dav:.           
-00008000: 2072 6169 7365 2050 6562 6b61 6328 3430   raise Pebkac(40
-00008010: 352c 2022 5765 6244 4156 2069 7320 6469  5, "WebDAV is di
-00008020: 7361 626c 6564 2069 6e20 7365 7276 6572  sabled in server
-00008030: 2063 6f6e 6669 6722 290a 0a20 2020 2020   config")..     
-00008040: 2020 2069 6620 6e6f 7420 7365 6c66 2e63     if not self.c
-00008050: 616e 5f77 7269 7465 3a0a 2020 2020 2020  an_write:.      
-00008060: 2020 2020 2020 7365 6c66 2e6c 6f67 2822        self.log("
-00008070: 7b7d 2074 7269 6564 2074 6f20 7072 6f70  {} tried to prop
-00008080: 7061 7463 6820 5b7b 7d5d 222e 666f 726d  patch [{}]".form
-00008090: 6174 2873 656c 662e 756e 616d 652c 2073  at(self.uname, s
-000080a0: 656c 662e 7670 6174 6829 290a 2020 2020  elf.vpath)).    
-000080b0: 2020 2020 2020 2020 7261 6973 6520 5065          raise Pe
-000080c0: 626b 6163 2834 3031 2c20 2261 7574 6865  bkac(401, "authe
-000080d0: 6e74 6963 6174 6522 290a 0a20 2020 2020  nticate")..     
-000080e0: 2020 2066 726f 6d20 786d 6c2e 6574 7265     from xml.etre
-000080f0: 6520 696d 706f 7274 2045 6c65 6d65 6e74  e import Element
-00008100: 5472 6565 2061 7320 4554 0a0a 2020 2020  Tree as ET..    
-00008110: 2020 2020 6672 6f6d 202e 6478 6d6c 2069      from .dxml i
-00008120: 6d70 6f72 7420 6d6b 656e 6f64 2c20 6d6b  mport mkenod, mk
-00008130: 746e 6f64 2c20 7061 7273 655f 786d 6c0a  tnod, parse_xml.
-00008140: 0a20 2020 2020 2020 2073 656c 662e 6173  .        self.as
-00008150: 7276 2e76 6673 2e67 6574 2873 656c 662e  rv.vfs.get(self.
-00008160: 7670 6174 682c 2073 656c 662e 756e 616d  vpath, self.unam
-00008170: 652c 2046 616c 7365 2c20 4661 6c73 6529  e, False, False)
-00008180: 0a20 2020 2020 2020 2023 2061 6273 7061  .        # abspa
-00008190: 7468 203d 2076 6e2e 6463 616e 6f6e 6963  th = vn.dcanonic
-000081a0: 616c 2872 656d 290a 0a20 2020 2020 2020  al(rem)..       
-000081b0: 2062 7566 203d 2062 2222 0a20 2020 2020   buf = b"".     
-000081c0: 2020 2066 6f72 2072 6275 6620 696e 2073     for rbuf in s
-000081d0: 656c 662e 6765 745f 626f 6479 5f72 6561  elf.get_body_rea
-000081e0: 6465 7228 295b 305d 3a0a 2020 2020 2020  der()[0]:.      
-000081f0: 2020 2020 2020 6275 6620 2b3d 2072 6275        buf += rbu
-00008200: 660a 2020 2020 2020 2020 2020 2020 6966  f.            if
-00008210: 206e 6f74 2072 6275 6620 6f72 206c 656e   not rbuf or len
-00008220: 2862 7566 2920 3e3d 2031 3238 202a 2031  (buf) >= 128 * 1
-00008230: 3032 343a 0a20 2020 2020 2020 2020 2020  024:.           
-00008240: 2020 2020 2062 7265 616b 0a0a 2020 2020       break..    
-00008250: 2020 2020 6966 2073 656c 662e 5f61 7070      if self._app
-00008260: 6c65 7361 6e28 293a 0a20 2020 2020 2020  lesan():.       
-00008270: 2020 2020 2072 6574 7572 6e20 5472 7565       return True
-00008280: 0a0a 2020 2020 2020 2020 7478 7420 3d20  ..        txt = 
-00008290: 6275 662e 6465 636f 6465 2822 6173 6369  buf.decode("asci
-000082a0: 6922 2c20 2272 6570 6c61 6365 2229 2e6c  i", "replace").l
-000082b0: 6f77 6572 2829 0a20 2020 2020 2020 2065  ower().        e
-000082c0: 6e63 203d 2073 656c 662e 6765 745f 786d  nc = self.get_xm
-000082d0: 6c5f 656e 6328 7478 7429 0a20 2020 2020  l_enc(txt).     
-000082e0: 2020 2075 656e 6320 3d20 656e 632e 7570     uenc = enc.up
-000082f0: 7065 7228 290a 0a20 2020 2020 2020 2074  per()..        t
-00008300: 7874 203d 2062 7566 2e64 6563 6f64 6528  xt = buf.decode(
-00008310: 656e 632c 2022 7265 706c 6163 6522 290a  enc, "replace").
-00008320: 2020 2020 2020 2020 4554 2e72 6567 6973          ET.regis
-00008330: 7465 725f 6e61 6d65 7370 6163 6528 2244  ter_namespace("D
-00008340: 222c 2022 4441 563a 2229 0a20 2020 2020  ", "DAV:").     
-00008350: 2020 2078 726f 6f74 203d 206d 6b65 6e6f     xroot = mkeno
-00008360: 6428 2244 3a6f 727a 2229 0a20 2020 2020  d("D:orz").     
-00008370: 2020 2078 726f 6f74 2e69 6e73 6572 7428     xroot.insert(
-00008380: 302c 2070 6172 7365 5f78 6d6c 2874 7874  0, parse_xml(txt
-00008390: 2929 0a20 2020 2020 2020 2078 7072 6f70  )).        xprop
-000083a0: 203d 2078 726f 6f74 2e66 696e 6428 7222   = xroot.find(r"
-000083b0: 2e2f 7b44 4156 3a7d 7072 6f70 6572 7479  ./{DAV:}property
-000083c0: 7570 6461 7465 2f7b 4441 563a 7d73 6574  update/{DAV:}set
-000083d0: 2f7b 4441 563a 7d70 726f 7022 290a 2020  /{DAV:}prop").  
-000083e0: 2020 2020 2020 6173 7365 7274 2078 7072        assert xpr
-000083f0: 6f70 0a20 2020 2020 2020 2066 6f72 207a  op.        for z
-00008400: 6520 696e 2078 7072 6f70 3a0a 2020 2020  e in xprop:.    
-00008410: 2020 2020 2020 2020 7a65 2e63 6c65 6172          ze.clear
-00008420: 2829 0a0a 2020 2020 2020 2020 7478 7420  ()..        txt 
-00008430: 3d20 2222 223c 6d75 6c74 6973 7461 7475  = """<multistatu
-00008440: 7320 786d 6c6e 733d 2244 4156 3a22 3e3c  s xmlns="DAV:"><
-00008450: 7265 7370 6f6e 7365 3e3c 7072 6f70 7374  response><propst
-00008460: 6174 3e3c 7374 6174 7573 3e48 5454 502f  at><status>HTTP/
-00008470: 312e 3120 3430 3320 466f 7262 6964 6465  1.1 403 Forbidde
-00008480: 6e3c 2f73 7461 7475 733e 3c2f 7072 6f70  n</status></prop
-00008490: 7374 6174 3e3c 2f72 6573 706f 6e73 653e  stat></response>
-000084a0: 3c2f 6d75 6c74 6973 7461 7475 733e 2222  </multistatus>""
-000084b0: 220a 2020 2020 2020 2020 7872 6f6f 7420  ".        xroot 
-000084c0: 3d20 7061 7273 655f 786d 6c28 7478 7429  = parse_xml(txt)
-000084d0: 0a0a 2020 2020 2020 2020 656c 203d 2078  ..        el = x
-000084e0: 726f 6f74 2e66 696e 6428 7222 2e2f 7b44  root.find(r"./{D
-000084f0: 4156 3a7d 7265 7370 6f6e 7365 2229 0a20  AV:}response"). 
-00008500: 2020 2020 2020 2061 7373 6572 7420 656c         assert el
-00008510: 0a20 2020 2020 2020 2065 3220 3d20 6d6b  .        e2 = mk
-00008520: 746e 6f64 2822 443a 6872 6566 222c 2071  tnod("D:href", q
-00008530: 756f 7465 7028 7365 6c66 2e61 7267 732e  uotep(self.args.
-00008540: 5352 5320 2b20 7365 6c66 2e76 7061 7468  SRS + self.vpath
-00008550: 2929 0a20 2020 2020 2020 2065 6c2e 696e  )).        el.in
-00008560: 7365 7274 2830 2c20 6532 290a 0a20 2020  sert(0, e2)..   
-00008570: 2020 2020 2065 6c20 3d20 7872 6f6f 742e       el = xroot.
-00008580: 6669 6e64 2872 222e 2f7b 4441 563a 7d72  find(r"./{DAV:}r
-00008590: 6573 706f 6e73 652f 7b44 4156 3a7d 7072  esponse/{DAV:}pr
-000085a0: 6f70 7374 6174 2229 0a20 2020 2020 2020  opstat").       
-000085b0: 2061 7373 6572 7420 656c 0a20 2020 2020   assert el.     
-000085c0: 2020 2065 6c2e 696e 7365 7274 2830 2c20     el.insert(0, 
-000085d0: 7870 726f 7029 0a0a 2020 2020 2020 2020  xprop)..        
-000085e0: 7265 7420 3d20 273c 3f78 6d6c 2076 6572  ret = '<?xml ver
-000085f0: 7369 6f6e 3d22 312e 3022 2065 6e63 6f64  sion="1.0" encod
-00008600: 696e 673d 227b 7d22 3f3e 5c6e 272e 666f  ing="{}"?>\n'.fo
-00008610: 726d 6174 2875 656e 6329 0a20 2020 2020  rmat(uenc).     
-00008620: 2020 2072 6574 202b 3d20 4554 2e74 6f73     ret += ET.tos
-00008630: 7472 696e 6728 7872 6f6f 7429 2e64 6563  tring(xroot).dec
-00008640: 6f64 6528 2275 7466 2d38 2229 0a0a 2020  ode("utf-8")..  
-00008650: 2020 2020 2020 7365 6c66 2e72 6570 6c79        self.reply
-00008660: 2872 6574 2e65 6e63 6f64 6528 656e 632c  (ret.encode(enc,
-00008670: 2022 7265 706c 6163 6522 292c 2032 3037   "replace"), 207
-00008680: 2c20 2274 6578 742f 786d 6c3b 2063 6861  , "text/xml; cha
-00008690: 7273 6574 3d22 202b 2065 6e63 290a 2020  rset=" + enc).  
-000086a0: 2020 2020 2020 7265 7475 726e 2054 7275        return Tru
-000086b0: 650a 0a20 2020 2064 6566 2068 616e 646c  e..    def handl
-000086c0: 655f 6c6f 636b 2873 656c 6629 2020 3a0a  e_lock(self)  :.
-000086d0: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
-000086e0: 646f 5f6c 6f67 3a0a 2020 2020 2020 2020  do_log:.        
-000086f0: 2020 2020 7365 6c66 2e6c 6f67 2822 4c4f      self.log("LO
-00008700: 434b 2022 202b 2073 656c 662e 7265 7129  CK " + self.req)
-00008710: 0a0a 2020 2020 2020 2020 6966 2073 656c  ..        if sel
-00008720: 662e 6172 6773 2e6e 6f5f 6461 763a 0a20  f.args.no_dav:. 
-00008730: 2020 2020 2020 2020 2020 2072 6169 7365             raise
-00008740: 2050 6562 6b61 6328 3430 352c 2022 5765   Pebkac(405, "We
-00008750: 6244 4156 2069 7320 6469 7361 626c 6564  bDAV is disabled
-00008760: 2069 6e20 7365 7276 6572 2063 6f6e 6669   in server confi
-00008770: 6722 290a 0a20 2020 2020 2020 2023 2077  g")..        # w
-00008780: 696e 372b 2064 6561 646c 6f63 6b73 2069  in7+ deadlocks i
-00008790: 6620 7765 2073 6179 206e 6f3b 206a 7573  f we say no; jus
-000087a0: 7420 736d 696c 6520 616e 6420 6e6f 640a  t smile and nod.
-000087b0: 2020 2020 2020 2020 6966 206e 6f74 2073          if not s
-000087c0: 656c 662e 6361 6e5f 7772 6974 6520 616e  elf.can_write an
-000087d0: 6420 224d 6963 726f 736f 6674 2d57 6562  d "Microsoft-Web
-000087e0: 4441 5622 206e 6f74 2069 6e20 7365 6c66  DAV" not in self
-000087f0: 2e75 613a 0a20 2020 2020 2020 2020 2020  .ua:.           
-00008800: 2073 656c 662e 6c6f 6728 227b 7d20 7472   self.log("{} tr
-00008810: 6965 6420 746f 206c 6f63 6b20 5b7b 7d5d  ied to lock [{}]
-00008820: 222e 666f 726d 6174 2873 656c 662e 756e  ".format(self.un
-00008830: 616d 652c 2073 656c 662e 7670 6174 6829  ame, self.vpath)
-00008840: 290a 2020 2020 2020 2020 2020 2020 7261  ).            ra
-00008850: 6973 6520 5065 626b 6163 2834 3031 2c20  ise Pebkac(401, 
-00008860: 2261 7574 6865 6e74 6963 6174 6522 290a  "authenticate").
-00008870: 0a20 2020 2020 2020 2066 726f 6d20 786d  .        from xm
-00008880: 6c2e 6574 7265 6520 696d 706f 7274 2045  l.etree import E
-00008890: 6c65 6d65 6e74 5472 6565 2061 7320 4554  lementTree as ET
-000088a0: 0a0a 2020 2020 2020 2020 6672 6f6d 202e  ..        from .
-000088b0: 6478 6d6c 2069 6d70 6f72 7420 6d6b 656e  dxml import mken
-000088c0: 6f64 2c20 6d6b 746e 6f64 2c20 7061 7273  od, mktnod, pars
-000088d0: 655f 786d 6c0a 0a20 2020 2020 2020 2076  e_xml..        v
-000088e0: 6e2c 2072 656d 203d 2073 656c 662e 6173  n, rem = self.as
-000088f0: 7276 2e76 6673 2e67 6574 2873 656c 662e  rv.vfs.get(self.
-00008900: 7670 6174 682c 2073 656c 662e 756e 616d  vpath, self.unam
-00008910: 652c 2046 616c 7365 2c20 4661 6c73 6529  e, False, False)
-00008920: 0a20 2020 2020 2020 2061 6273 7061 7468  .        abspath
-00008930: 203d 2076 6e2e 6463 616e 6f6e 6963 616c   = vn.dcanonical
-00008940: 2872 656d 290a 0a20 2020 2020 2020 2062  (rem)..        b
-00008950: 7566 203d 2062 2222 0a20 2020 2020 2020  uf = b"".       
-00008960: 2066 6f72 2072 6275 6620 696e 2073 656c   for rbuf in sel
-00008970: 662e 6765 745f 626f 6479 5f72 6561 6465  f.get_body_reade
-00008980: 7228 295b 305d 3a0a 2020 2020 2020 2020  r()[0]:.        
-00008990: 2020 2020 6275 6620 2b3d 2072 6275 660a      buf += rbuf.
-000089a0: 2020 2020 2020 2020 2020 2020 6966 206e              if n
-000089b0: 6f74 2072 6275 6620 6f72 206c 656e 2862  ot rbuf or len(b
-000089c0: 7566 2920 3e3d 2031 3238 202a 2031 3032  uf) >= 128 * 102
-000089d0: 343a 0a20 2020 2020 2020 2020 2020 2020  4:.             
-000089e0: 2020 2062 7265 616b 0a0a 2020 2020 2020     break..      
-000089f0: 2020 6966 2073 656c 662e 5f61 7070 6c65    if self._apple
-00008a00: 7361 6e28 293a 0a20 2020 2020 2020 2020  san():.         
-00008a10: 2020 2072 6574 7572 6e20 5472 7565 0a0a     return True..
-00008a20: 2020 2020 2020 2020 7478 7420 3d20 6275          txt = bu
-00008a30: 662e 6465 636f 6465 2822 6173 6369 6922  f.decode("ascii"
-00008a40: 2c20 2272 6570 6c61 6365 2229 2e6c 6f77  , "replace").low
-00008a50: 6572 2829 0a20 2020 2020 2020 2065 6e63  er().        enc
-00008a60: 203d 2073 656c 662e 6765 745f 786d 6c5f   = self.get_xml_
-00008a70: 656e 6328 7478 7429 0a20 2020 2020 2020  enc(txt).       
-00008a80: 2075 656e 6320 3d20 656e 632e 7570 7065   uenc = enc.uppe
-00008a90: 7228 290a 0a20 2020 2020 2020 2074 7874  r()..        txt
-00008aa0: 203d 2062 7566 2e64 6563 6f64 6528 656e   = buf.decode(en
-00008ab0: 632c 2022 7265 706c 6163 6522 290a 2020  c, "replace").  
-00008ac0: 2020 2020 2020 4554 2e72 6567 6973 7465        ET.registe
-00008ad0: 725f 6e61 6d65 7370 6163 6528 2244 222c  r_namespace("D",
-00008ae0: 2022 4441 563a 2229 0a20 2020 2020 2020   "DAV:").       
-00008af0: 206c 6b20 3d20 7061 7273 655f 786d 6c28   lk = parse_xml(
-00008b00: 7478 7429 0a20 2020 2020 2020 2061 7373  txt).        ass
-00008b10: 6572 7420 6c6b 2e74 6167 203d 3d20 227b  ert lk.tag == "{
-00008b20: 4441 563a 7d6c 6f63 6b69 6e66 6f22 0a0a  DAV:}lockinfo"..
-00008b30: 2020 2020 2020 2020 746f 6b65 6e20 3d20          token = 
-00008b40: 7374 7228 7575 6964 2e75 7569 6434 2829  str(uuid.uuid4()
-00008b50: 290a 0a20 2020 2020 2020 2069 6620 6e6f  )..        if no
-00008b60: 7420 6c6b 2e66 696e 6428 7222 2e2f 7b44  t lk.find(r"./{D
-00008b70: 4156 3a7d 6465 7074 6822 293a 0a20 2020  AV:}depth"):.   
-00008b80: 2020 2020 2020 2020 2064 6570 7468 203d           depth =
-00008b90: 2073 656c 662e 6865 6164 6572 732e 6765   self.headers.ge
-00008ba0: 7428 2264 6570 7468 222c 2022 696e 6669  t("depth", "infi
-00008bb0: 6e69 7479 2229 0a20 2020 2020 2020 2020  nity").         
-00008bc0: 2020 206c 6b2e 6170 7065 6e64 286d 6b74     lk.append(mkt
-00008bd0: 6e6f 6428 2244 3a64 6570 7468 222c 2064  nod("D:depth", d
-00008be0: 6570 7468 2929 0a0a 2020 2020 2020 2020  epth))..        
-00008bf0: 6c6b 2e61 7070 656e 6428 6d6b 746e 6f64  lk.append(mktnod
-00008c00: 2822 443a 7469 6d65 6f75 7422 2c20 2253  ("D:timeout", "S
-00008c10: 6563 6f6e 642d 3333 3130 2229 290a 2020  econd-3310")).  
-00008c20: 2020 2020 2020 6c6b 2e61 7070 656e 6428        lk.append(
-00008c30: 6d6b 656e 6f64 2822 443a 6c6f 636b 746f  mkenod("D:lockto
-00008c40: 6b65 6e22 2c20 6d6b 746e 6f64 2822 443a  ken", mktnod("D:
-00008c50: 6872 6566 222c 2074 6f6b 656e 2929 290a  href", token))).
-00008c60: 2020 2020 2020 2020 6c6b 2e61 7070 656e          lk.appen
-00008c70: 6428 0a20 2020 2020 2020 2020 2020 206d  d(.            m
-00008c80: 6b65 6e6f 6428 2244 3a6c 6f63 6b72 6f6f  kenod("D:lockroo
-00008c90: 7422 2c20 6d6b 746e 6f64 2822 443a 6872  t", mktnod("D:hr
-00008ca0: 6566 222c 2071 756f 7465 7028 7365 6c66  ef", quotep(self
-00008cb0: 2e61 7267 732e 5352 5320 2b20 7365 6c66  .args.SRS + self
-00008cc0: 2e76 7061 7468 2929 290a 2020 2020 2020  .vpath))).      
-00008cd0: 2020 290a 0a20 2020 2020 2020 206c 6b32    )..        lk2
-00008ce0: 203d 206d 6b65 6e6f 6428 2244 3a61 6374   = mkenod("D:act
-00008cf0: 6976 656c 6f63 6b22 290a 2020 2020 2020  ivelock").      
-00008d00: 2020 7872 6f6f 7420 3d20 6d6b 656e 6f64    xroot = mkenod
-00008d10: 2822 443a 7072 6f70 222c 206d 6b65 6e6f  ("D:prop", mkeno
-00008d20: 6428 2244 3a6c 6f63 6b64 6973 636f 7665  d("D:lockdiscove
-00008d30: 7279 222c 206c 6b32 2929 0a20 2020 2020  ry", lk2)).     
-00008d40: 2020 2066 6f72 2061 2069 6e20 6c6b 3a0a     for a in lk:.
-00008d50: 2020 2020 2020 2020 2020 2020 6c6b 322e              lk2.
-00008d60: 6170 7065 6e64 2861 290a 0a20 2020 2020  append(a)..     
-00008d70: 2020 2072 6574 203d 2027 3c3f 786d 6c20     ret = '<?xml 
-00008d80: 7665 7273 696f 6e3d 2231 2e30 2220 656e  version="1.0" en
-00008d90: 636f 6469 6e67 3d22 7b7d 223f 3e5c 6e27  coding="{}"?>\n'
-00008da0: 2e66 6f72 6d61 7428 7565 6e63 290a 2020  .format(uenc).  
-00008db0: 2020 2020 2020 7265 7420 2b3d 2045 542e        ret += ET.
-00008dc0: 746f 7374 7269 6e67 2878 726f 6f74 292e  tostring(xroot).
-00008dd0: 6465 636f 6465 2822 7574 662d 3822 290a  decode("utf-8").
-00008de0: 0a20 2020 2020 2020 2072 6320 3d20 3230  .        rc = 20
-00008df0: 300a 2020 2020 2020 2020 6966 2073 656c  0.        if sel
-00008e00: 662e 6361 6e5f 7772 6974 6520 616e 6420  f.can_write and 
-00008e10: 6e6f 7420 626f 732e 7061 7468 2e69 7366  not bos.path.isf
-00008e20: 696c 6528 6162 7370 6174 6829 3a0a 2020  ile(abspath):.  
-00008e30: 2020 2020 2020 2020 2020 7769 7468 206f            with o
-00008e40: 7065 6e28 6673 656e 6328 6162 7370 6174  pen(fsenc(abspat
-00008e50: 6829 2c20 2277 6222 2920 6173 205f 3a0a  h), "wb") as _:.
-00008e60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008e70: 7263 203d 2032 3031 0a0a 2020 2020 2020  rc = 201..      
-00008e80: 2020 7365 6c66 2e6f 7574 5f68 6561 6465    self.out_heade
-00008e90: 7273 5b22 4c6f 636b 2d54 6f6b 656e 225d  rs["Lock-Token"]
-00008ea0: 203d 2022 3c7b 7d3e 222e 666f 726d 6174   = "<{}>".format
-00008eb0: 2874 6f6b 656e 290a 2020 2020 2020 2020  (token).        
-00008ec0: 7365 6c66 2e72 6570 6c79 2872 6574 2e65  self.reply(ret.e
-00008ed0: 6e63 6f64 6528 656e 632c 2022 7265 706c  ncode(enc, "repl
-00008ee0: 6163 6522 292c 2072 632c 2022 7465 7874  ace"), rc, "text
-00008ef0: 2f78 6d6c 3b20 6368 6172 7365 743d 2220  /xml; charset=" 
-00008f00: 2b20 656e 6329 0a20 2020 2020 2020 2072  + enc).        r
-00008f10: 6574 7572 6e20 5472 7565 0a0a 2020 2020  eturn True..    
-00008f20: 6465 6620 6861 6e64 6c65 5f75 6e6c 6f63  def handle_unloc
-00008f30: 6b28 7365 6c66 2920 203a 0a20 2020 2020  k(self)  :.     
-00008f40: 2020 2069 6620 7365 6c66 2e64 6f5f 6c6f     if self.do_lo
-00008f50: 673a 0a20 2020 2020 2020 2020 2020 2073  g:.            s
-00008f60: 656c 662e 6c6f 6728 2255 4e4c 4f43 4b20  elf.log("UNLOCK 
-00008f70: 2220 2b20 7365 6c66 2e72 6571 290a 0a20  " + self.req).. 
-00008f80: 2020 2020 2020 2069 6620 7365 6c66 2e61         if self.a
-00008f90: 7267 732e 6e6f 5f64 6176 3a0a 2020 2020  rgs.no_dav:.    
-00008fa0: 2020 2020 2020 2020 7261 6973 6520 5065          raise Pe
-00008fb0: 626b 6163 2834 3035 2c20 2257 6562 4441  bkac(405, "WebDA
-00008fc0: 5620 6973 2064 6973 6162 6c65 6420 696e  V is disabled in
-00008fd0: 2073 6572 7665 7220 636f 6e66 6967 2229   server config")
-00008fe0: 0a0a 2020 2020 2020 2020 6966 206e 6f74  ..        if not
-00008ff0: 2073 656c 662e 6361 6e5f 7772 6974 6520   self.can_write 
-00009000: 616e 6420 224d 6963 726f 736f 6674 2d57  and "Microsoft-W
-00009010: 6562 4441 5622 206e 6f74 2069 6e20 7365  ebDAV" not in se
-00009020: 6c66 2e75 613a 0a20 2020 2020 2020 2020  lf.ua:.         
-00009030: 2020 2073 656c 662e 6c6f 6728 227b 7d20     self.log("{} 
-00009040: 7472 6965 6420 746f 206c 6f63 6b20 5b7b  tried to lock [{
-00009050: 7d5d 222e 666f 726d 6174 2873 656c 662e  }]".format(self.
-00009060: 756e 616d 652c 2073 656c 662e 7670 6174  uname, self.vpat
-00009070: 6829 290a 2020 2020 2020 2020 2020 2020  h)).            
-00009080: 7261 6973 6520 5065 626b 6163 2834 3031  raise Pebkac(401
-00009090: 2c20 2261 7574 6865 6e74 6963 6174 6522  , "authenticate"
-000090a0: 290a 0a20 2020 2020 2020 2073 656c 662e  )..        self.
-000090b0: 7365 6e64 5f68 6561 6465 7273 284e 6f6e  send_headers(Non
-000090c0: 652c 2032 3034 290a 2020 2020 2020 2020  e, 204).        
-000090d0: 7265 7475 726e 2054 7275 650a 0a20 2020  return True..   
-000090e0: 2064 6566 2068 616e 646c 655f 6d6b 636f   def handle_mkco
-000090f0: 6c28 7365 6c66 2920 203a 0a20 2020 2020  l(self)  :.     
-00009100: 2020 2069 6620 7365 6c66 2e5f 6170 706c     if self._appl
-00009110: 6573 616e 2829 3a0a 2020 2020 2020 2020  esan():.        
-00009120: 2020 2020 7265 7475 726e 2054 7275 650a      return True.
-00009130: 0a20 2020 2020 2020 2069 6620 7365 6c66  .        if self
-00009140: 2e64 6f5f 6c6f 673a 0a20 2020 2020 2020  .do_log:.       
-00009150: 2020 2020 2073 656c 662e 6c6f 6728 224d       self.log("M
-00009160: 4b43 4f4c 2022 202b 2073 656c 662e 7265  KCOL " + self.re
-00009170: 7129 0a0a 2020 2020 2020 2020 7472 793a  q)..        try:
-00009180: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-00009190: 7572 6e20 7365 6c66 2e5f 6d6b 6469 7228  urn self._mkdir(
-000091a0: 7365 6c66 2e76 7061 7468 2c20 5472 7565  self.vpath, True
-000091b0: 290a 2020 2020 2020 2020 6578 6365 7074  ).        except
-000091c0: 2050 6562 6b61 6320 6173 2065 783a 0a20   Pebkac as ex:. 
-000091d0: 2020 2020 2020 2020 2020 2069 6620 6578             if ex
-000091e0: 2e63 6f64 6520 3e3d 2035 3030 3a0a 2020  .code >= 500:.  
-000091f0: 2020 2020 2020 2020 2020 2020 2020 7261                ra
-00009200: 6973 650a 0a20 2020 2020 2020 2020 2020  ise..           
-00009210: 2073 656c 662e 7265 706c 7928 6222 222c   self.reply(b"",
-00009220: 2065 782e 636f 6465 290a 2020 2020 2020   ex.code).      
-00009230: 2020 2020 2020 7265 7475 726e 2054 7275        return Tru
-00009240: 650a 0a20 2020 2064 6566 2068 616e 646c  e..    def handl
-00009250: 655f 6d6f 7665 2873 656c 6629 2020 3a0a  e_move(self)  :.
-00009260: 2020 2020 2020 2020 6473 7420 3d20 7365          dst = se
-00009270: 6c66 2e68 6561 6465 7273 5b22 6465 7374  lf.headers["dest
-00009280: 696e 6174 696f 6e22 5d0a 2020 2020 2020  ination"].      
-00009290: 2020 6473 7420 3d20 7265 2e73 7562 2822    dst = re.sub("
-000092a0: 5e68 7474 7073 3f3a 2f2f 5b5e 2f5d 2b22  ^https?://[^/]+"
-000092b0: 2c20 2222 2c20 6473 7429 2e6c 7374 7269  , "", dst).lstri
-000092c0: 7028 290a 2020 2020 2020 2020 6473 7420  p().        dst 
-000092d0: 3d20 756e 7175 6f74 6570 2864 7374 290a  = unquotep(dst).
-000092e0: 2020 2020 2020 2020 6966 206e 6f74 2073          if not s
-000092f0: 656c 662e 5f6d 7628 7365 6c66 2e76 7061  elf._mv(self.vpa
-00009300: 7468 2c20 6473 742e 6c73 7472 6970 2822  th, dst.lstrip("
-00009310: 2f22 2929 3a0a 2020 2020 2020 2020 2020  /")):.          
-00009320: 2020 7265 7475 726e 2046 616c 7365 0a0a    return False..
-00009330: 2020 2020 2020 2020 7265 7475 726e 2054          return T
-00009340: 7275 650a 0a20 2020 2064 6566 205f 6170  rue..    def _ap
-00009350: 706c 6573 616e 2873 656c 6629 2020 3a0a  plesan(self)  :.
-00009360: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
-00009370: 6172 6773 2e64 6176 5f6d 6163 206f 7220  args.dav_mac or 
-00009380: 2244 6172 7769 6e2f 2220 6e6f 7420 696e  "Darwin/" not in
-00009390: 2073 656c 662e 7561 3a0a 2020 2020 2020   self.ua:.      
-000093a0: 2020 2020 2020 7265 7475 726e 2046 616c        return Fal
-000093b0: 7365 0a0a 2020 2020 2020 2020 7670 203d  se..        vp =
-000093c0: 2022 2f22 202b 2073 656c 662e 7670 6174   "/" + self.vpat
-000093d0: 680a 2020 2020 2020 2020 7074 6e20 3d20  h.        ptn = 
-000093e0: 7222 2f5c 2e28 5f7c 4453 5f53 746f 7265  r"/\.(_|DS_Store
-000093f0: 7c53 706f 746c 6967 6874 2d7c 6673 6576  |Spotlight-|fsev
-00009400: 656e 7473 647c 5472 6173 6865 737c 4170  entsd|Trashes|Ap
-00009410: 706c 6544 6f75 626c 6529 7c2f 5f5f 4d41  pleDouble)|/__MA
-00009420: 434f 5322 0a20 2020 2020 2020 2069 6620  COS".        if 
-00009430: 7265 2e73 6561 7263 6828 7074 6e2c 2076  re.search(ptn, v
-00009440: 7029 3a0a 2020 2020 2020 2020 2020 2020  p):.            
-00009450: 7a74 203d 2027 3c3f 786d 6c20 7665 7273  zt = '<?xml vers
-00009460: 696f 6e3d 2231 2e30 2220 656e 636f 6469  ion="1.0" encodi
-00009470: 6e67 3d22 7574 662d 3822 3f3e 5c6e 3c44  ng="utf-8"?>\n<D
-00009480: 3a65 7272 6f72 2078 6d6c 6e73 3a44 3d22  :error xmlns:D="
-00009490: 4441 563a 223e 3c44 3a6c 6f63 6b2d 746f  DAV:"><D:lock-to
-000094a0: 6b65 6e2d 7375 626d 6974 7465 643e 3c44  ken-submitted><D
-000094b0: 3a68 7265 663e 7b7d 3c2f 443a 6872 6566  :href>{}</D:href
-000094c0: 3e3c 2f44 3a6c 6f63 6b2d 746f 6b65 6e2d  ></D:lock-token-
-000094d0: 7375 626d 6974 7465 643e 3c2f 443a 6572  submitted></D:er
-000094e0: 726f 723e 270a 2020 2020 2020 2020 2020  ror>'.          
-000094f0: 2020 7a62 203d 207a 742e 666f 726d 6174    zb = zt.format
-00009500: 2876 7029 2e65 6e63 6f64 6528 2275 7466  (vp).encode("utf
-00009510: 2d38 222c 2022 7265 706c 6163 6522 290a  -8", "replace").
-00009520: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00009530: 2e72 6570 6c79 287a 622c 2034 3233 2c20  .reply(zb, 423, 
-00009540: 2274 6578 742f 786d 6c3b 2063 6861 7273  "text/xml; chars
-00009550: 6574 3d75 7466 2d38 2229 0a20 2020 2020  et=utf-8").     
-00009560: 2020 2020 2020 2072 6574 7572 6e20 5472         return Tr
-00009570: 7565 0a0a 2020 2020 2020 2020 7265 7475  ue..        retu
-00009580: 726e 2046 616c 7365 0a0a 2020 2020 6465  rn False..    de
-00009590: 6620 7365 6e64 5f63 6875 6e6b 2873 656c  f send_chunk(sel
-000095a0: 662c 2074 7874 202c 2065 6e63 202c 2062  f, txt , enc , b
-000095b0: 6d61 7820 2920 203a 0a20 2020 2020 2020  max )  :.       
-000095c0: 206f 7269 675f 6c65 6e20 3d20 6c65 6e28   orig_len = len(
-000095d0: 7478 7429 0a20 2020 2020 2020 2062 7566  txt).        buf
-000095e0: 203d 2074 7874 5b3a 626d 6178 5d2e 656e   = txt[:bmax].en
-000095f0: 636f 6465 2865 6e63 2c20 2272 6570 6c61  code(enc, "repla
-00009600: 6365 2229 5b3a 626d 6178 5d0a 2020 2020  ce")[:bmax].    
-00009610: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
-00009620: 2020 2020 205f 203d 2062 7566 2e64 6563       _ = buf.dec
-00009630: 6f64 6528 656e 6329 0a20 2020 2020 2020  ode(enc).       
-00009640: 2065 7863 6570 7420 556e 6963 6f64 6544   except UnicodeD
-00009650: 6563 6f64 6545 7272 6f72 2061 7320 7564  ecodeError as ud
-00009660: 653a 0a20 2020 2020 2020 2020 2020 2062  e:.            b
-00009670: 7566 203d 2062 7566 5b3a 2075 6465 2e73  uf = buf[: ude.s
-00009680: 7461 7274 5d0a 0a20 2020 2020 2020 2074  tart]..        t
-00009690: 7874 203d 2074 7874 5b6c 656e 2862 7566  xt = txt[len(buf
-000096a0: 2e64 6563 6f64 6528 656e 6329 2920 3a5d  .decode(enc)) :]
-000096b0: 0a20 2020 2020 2020 2069 6620 7478 7420  .        if txt 
-000096c0: 616e 6420 6c65 6e28 7478 7429 203d 3d20  and len(txt) == 
-000096d0: 6f72 6967 5f6c 656e 3a0a 2020 2020 2020  orig_len:.      
-000096e0: 2020 2020 2020 7261 6973 6520 5065 626b        raise Pebk
-000096f0: 6163 2835 3030 2c20 2263 6875 6e6b 2073  ac(500, "chunk s
-00009700: 6c69 6369 6e67 2066 6169 6c65 6422 290a  licing failed").
-00009710: 0a20 2020 2020 2020 2062 7566 203d 2022  .        buf = "
-00009720: 7b3a 787d 5c72 5c6e 222e 666f 726d 6174  {:x}\r\n".format
-00009730: 286c 656e 2862 7566 2929 2e65 6e63 6f64  (len(buf)).encod
-00009740: 6528 656e 6329 202b 2062 7566 0a20 2020  e(enc) + buf.   
-00009750: 2020 2020 2073 656c 662e 732e 7365 6e64       self.s.send
-00009760: 616c 6c28 6275 6620 2b20 6222 5c72 5c6e  all(buf + b"\r\n
-00009770: 2229 0a20 2020 2020 2020 2072 6574 7572  ").        retur
-00009780: 6e20 7478 740a 0a20 2020 2064 6566 2068  n txt..    def h
-00009790: 616e 646c 655f 6f70 7469 6f6e 7328 7365  andle_options(se
-000097a0: 6c66 2920 203a 0a20 2020 2020 2020 2069  lf)  :.        i
-000097b0: 6620 7365 6c66 2e64 6f5f 6c6f 673a 0a20  f self.do_log:. 
-000097c0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-000097d0: 6c6f 6728 224f 5054 494f 4e53 2022 202b  log("OPTIONS " +
-000097e0: 2073 656c 662e 7265 7129 0a0a 2020 2020   self.req)..    
-000097f0: 2020 2020 6f68 203d 2073 656c 662e 6f75      oh = self.ou
-00009800: 745f 6865 6164 6572 730a 2020 2020 2020  t_headers.      
-00009810: 2020 6f68 5b22 416c 6c6f 7722 5d20 3d20    oh["Allow"] = 
-00009820: 222c 2022 2e6a 6f69 6e28 7365 6c66 2e63  ", ".join(self.c
-00009830: 6f6e 6e2e 6873 7276 2e6d 616c 6c6f 7729  onn.hsrv.mallow)
-00009840: 0a0a 2020 2020 2020 2020 6966 206e 6f74  ..        if not
-00009850: 2073 656c 662e 6172 6773 2e6e 6f5f 6461   self.args.no_da
-00009860: 763a 0a20 2020 2020 2020 2020 2020 2023  v:.            #
-00009870: 2050 524f 5050 4154 4348 2c20 4c4f 434b   PROPPATCH, LOCK
-00009880: 2c20 554e 4c4f 434b 2c20 434f 5059 3a20  , UNLOCK, COPY: 
-00009890: 6e6f 6f70 2028 7370 6563 2d6d 7573 7429  noop (spec-must)
-000098a0: 0a20 2020 2020 2020 2020 2020 206f 685b  .            oh[
-000098b0: 2244 6176 225d 203d 2022 312c 2032 220a  "Dav"] = "1, 2".
-000098c0: 2020 2020 2020 2020 2020 2020 6f68 5b22              oh["
-000098d0: 4d73 2d41 7574 686f 722d 5669 6122 5d20  Ms-Author-Via"] 
-000098e0: 3d20 2244 4156 220a 0a20 2020 2020 2020  = "DAV"..       
-000098f0: 2023 2077 696e 7870 2d77 6562 6461 7620   # winxp-webdav 
-00009900: 646f 6573 6e74 206b 6e6f 7720 7768 6174  doesnt know what
-00009910: 2032 3034 2069 730a 2020 2020 2020 2020   204 is.        
-00009920: 7365 6c66 2e73 656e 645f 6865 6164 6572  self.send_header
-00009930: 7328 302c 2032 3030 290a 2020 2020 2020  s(0, 200).      
-00009940: 2020 7265 7475 726e 2054 7275 650a 0a20    return True.. 
-00009950: 2020 2064 6566 2068 616e 646c 655f 6465     def handle_de
-00009960: 6c65 7465 2873 656c 6629 2020 3a0a 2020  lete(self)  :.  
-00009970: 2020 2020 2020 7365 6c66 2e6c 6f67 2822        self.log("
-00009980: 4445 4c45 5445 2022 202b 2073 656c 662e  DELETE " + self.
-00009990: 7265 7129 0a20 2020 2020 2020 2072 6574  req).        ret
-000099a0: 7572 6e20 7365 6c66 2e68 616e 646c 655f  urn self.handle_
-000099b0: 726d 285b 5d29 0a0a 2020 2020 6465 6620  rm([])..    def 
-000099c0: 6861 6e64 6c65 5f70 7574 2873 656c 6629  handle_put(self)
-000099d0: 2020 3a0a 2020 2020 2020 2020 7365 6c66    :.        self
-000099e0: 2e6c 6f67 2822 5055 5420 2220 2b20 7365  .log("PUT " + se
-000099f0: 6c66 2e72 6571 290a 0a20 2020 2020 2020  lf.req)..       
-00009a00: 2069 6620 6e6f 7420 7365 6c66 2e63 616e   if not self.can
-00009a10: 5f77 7269 7465 3a0a 2020 2020 2020 2020  _write:.        
-00009a20: 2020 2020 7420 3d20 2275 7365 7220 7b7d      t = "user {}
-00009a30: 2064 6f65 7320 6e6f 7420 6861 7665 2077   does not have w
-00009a40: 7269 7465 2d61 6363 6573 7320 6865 7265  rite-access here
-00009a50: 220a 2020 2020 2020 2020 2020 2020 7261  ".            ra
-00009a60: 6973 6520 5065 626b 6163 2834 3033 2c20  ise Pebkac(403, 
-00009a70: 742e 666f 726d 6174 2873 656c 662e 756e  t.format(self.un
-00009a80: 616d 6529 290a 0a20 2020 2020 2020 2069  ame))..        i
-00009a90: 6620 6e6f 7420 7365 6c66 2e61 7267 732e  f not self.args.
-00009aa0: 6e6f 5f64 6176 2061 6e64 2073 656c 662e  no_dav and self.
-00009ab0: 5f61 7070 6c65 7361 6e28 293a 0a20 2020  _applesan():.   
-00009ac0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-00009ad0: 7365 6c66 2e68 6561 6465 7273 2e67 6574  self.headers.get
-00009ae0: 2822 636f 6e74 656e 742d 6c65 6e67 7468  ("content-length
-00009af0: 2229 203d 3d20 2230 220a 0a20 2020 2020  ") == "0"..     
-00009b00: 2020 2069 6620 7365 6c66 2e68 6561 6465     if self.heade
-00009b10: 7273 2e67 6574 2822 6578 7065 6374 222c  rs.get("expect",
-00009b20: 2022 2229 2e6c 6f77 6572 2829 203d 3d20   "").lower() == 
-00009b30: 2231 3030 2d63 6f6e 7469 6e75 6522 3a0a  "100-continue":.
-00009b40: 2020 2020 2020 2020 2020 2020 7472 793a              try:
-00009b50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00009b60: 2073 656c 662e 732e 7365 6e64 616c 6c28   self.s.sendall(
-00009b70: 6222 4854 5450 2f31 2e31 2031 3030 2043  b"HTTP/1.1 100 C
-00009b80: 6f6e 7469 6e75 655c 725c 6e5c 725c 6e22  ontinue\r\n\r\n"
-00009b90: 290a 2020 2020 2020 2020 2020 2020 6578  ).            ex
-00009ba0: 6365 7074 3a0a 2020 2020 2020 2020 2020  cept:.          
-00009bb0: 2020 2020 2020 7261 6973 6520 5065 626b        raise Pebk
-00009bc0: 6163 2834 3030 2c20 2263 6c69 656e 7420  ac(400, "client 
-00009bd0: 642f 6320 6265 666f 7265 2031 3030 2063  d/c before 100 c
-00009be0: 6f6e 7469 6e75 6522 290a 0a20 2020 2020  ontinue")..     
-00009bf0: 2020 2072 6574 7572 6e20 7365 6c66 2e68     return self.h
-00009c00: 616e 646c 655f 7374 6173 6828 5472 7565  andle_stash(True
-00009c10: 290a 0a20 2020 2064 6566 2068 616e 646c  )..    def handl
-00009c20: 655f 706f 7374 2873 656c 6629 2020 3a0a  e_post(self)  :.
-00009c30: 2020 2020 2020 2020 7365 6c66 2e6c 6f67          self.log
-00009c40: 2822 504f 5354 2022 202b 2073 656c 662e  ("POST " + self.
-00009c50: 7265 7129 0a0a 2020 2020 2020 2020 6966  req)..        if
-00009c60: 2073 656c 662e 6865 6164 6572 732e 6765   self.headers.ge
-00009c70: 7428 2265 7870 6563 7422 2c20 2222 292e  t("expect", "").
-00009c80: 6c6f 7765 7228 2920 3d3d 2022 3130 302d  lower() == "100-
-00009c90: 636f 6e74 696e 7565 223a 0a20 2020 2020  continue":.     
-00009ca0: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
-00009cb0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00009cc0: 2e73 2e73 656e 6461 6c6c 2862 2248 5454  .s.sendall(b"HTT
-00009cd0: 502f 312e 3120 3130 3020 436f 6e74 696e  P/1.1 100 Contin
-00009ce0: 7565 5c72 5c6e 5c72 5c6e 2229 0a20 2020  ue\r\n\r\n").   
-00009cf0: 2020 2020 2020 2020 2065 7863 6570 743a           except:
-00009d00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00009d10: 2072 6169 7365 2050 6562 6b61 6328 3430   raise Pebkac(40
-00009d20: 302c 2022 636c 6965 6e74 2064 2f63 2062  0, "client d/c b
-00009d30: 6566 6f72 6520 3130 3020 636f 6e74 696e  efore 100 contin
-00009d40: 7565 2229 0a0a 2020 2020 2020 2020 6966  ue")..        if
-00009d50: 2022 7261 7722 2069 6e20 7365 6c66 2e75   "raw" in self.u
-00009d60: 7061 7261 6d3a 0a20 2020 2020 2020 2020  param:.         
-00009d70: 2020 2072 6574 7572 6e20 7365 6c66 2e68     return self.h
-00009d80: 616e 646c 655f 7374 6173 6828 4661 6c73  andle_stash(Fals
-00009d90: 6529 0a0a 2020 2020 2020 2020 6374 7970  e)..        ctyp
-00009da0: 6520 3d20 7365 6c66 2e68 6561 6465 7273  e = self.headers
-00009db0: 2e67 6574 2822 636f 6e74 656e 742d 7479  .get("content-ty
-00009dc0: 7065 222c 2022 2229 2e6c 6f77 6572 2829  pe", "").lower()
-00009dd0: 0a0a 2020 2020 2020 2020 6966 2022 6d75  ..        if "mu
-00009de0: 6c74 6970 6172 742f 666f 726d 2d64 6174  ltipart/form-dat
-00009df0: 6122 2069 6e20 6374 7970 653a 0a20 2020  a" in ctype:.   
-00009e00: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-00009e10: 7365 6c66 2e68 616e 646c 655f 706f 7374  self.handle_post
-00009e20: 5f6d 756c 7469 7061 7274 2829 0a0a 2020  _multipart()..  
-00009e30: 2020 2020 2020 6966 2028 0a20 2020 2020        if (.     
-00009e40: 2020 2020 2020 2022 6170 706c 6963 6174         "applicat
-00009e50: 696f 6e2f 6a73 6f6e 2220 696e 2063 7479  ion/json" in cty
-00009e60: 7065 0a20 2020 2020 2020 2020 2020 206f  pe.            o
-00009e70: 7220 2274 6578 742f 706c 6169 6e22 2069  r "text/plain" i
-00009e80: 6e20 6374 7970 650a 2020 2020 2020 2020  n ctype.        
-00009e90: 2020 2020 6f72 2022 6170 706c 6963 6174      or "applicat
-00009ea0: 696f 6e2f 786d 6c22 2069 6e20 6374 7970  ion/xml" in ctyp
-00009eb0: 650a 2020 2020 2020 2020 293a 0a20 2020  e.        ):.   
-00009ec0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-00009ed0: 7365 6c66 2e68 616e 646c 655f 706f 7374  self.handle_post
-00009ee0: 5f6a 736f 6e28 290a 0a20 2020 2020 2020  _json()..       
-00009ef0: 2069 6620 226d 6f76 6522 2069 6e20 7365   if "move" in se
-00009f00: 6c66 2e75 7061 7261 6d3a 0a20 2020 2020  lf.uparam:.     
-00009f10: 2020 2020 2020 2072 6574 7572 6e20 7365         return se
-00009f20: 6c66 2e68 616e 646c 655f 6d76 2829 0a0a  lf.handle_mv()..
-00009f30: 2020 2020 2020 2020 6966 2022 6465 6c65          if "dele
-00009f40: 7465 2220 696e 2073 656c 662e 7570 6172  te" in self.upar
-00009f50: 616d 3a0a 2020 2020 2020 2020 2020 2020  am:.            
-00009f60: 7265 7475 726e 2073 656c 662e 6861 6e64  return self.hand
-00009f70: 6c65 5f72 6d28 5b5d 290a 0a20 2020 2020  le_rm([])..     
-00009f80: 2020 2069 6620 2261 7070 6c69 6361 7469     if "applicati
-00009f90: 6f6e 2f6f 6374 6574 2d73 7472 6561 6d22  on/octet-stream"
-00009fa0: 2069 6e20 6374 7970 653a 0a20 2020 2020   in ctype:.     
-00009fb0: 2020 2020 2020 2072 6574 7572 6e20 7365         return se
-00009fc0: 6c66 2e68 616e 646c 655f 706f 7374 5f62  lf.handle_post_b
-00009fd0: 696e 6172 7928 290a 0a20 2020 2020 2020  inary()..       
-00009fe0: 2069 6620 2261 7070 6c69 6361 7469 6f6e   if "application
-00009ff0: 2f78 2d77 7777 2d66 6f72 6d2d 7572 6c65  /x-www-form-urle
-0000a000: 6e63 6f64 6564 2220 696e 2063 7479 7065  ncoded" in ctype
-0000a010: 3a0a 2020 2020 2020 2020 2020 2020 6f70  :.            op
-0000a020: 7420 3d20 7365 6c66 2e61 7267 732e 7572  t = self.args.ur
-0000a030: 6c66 6f72 6d0a 2020 2020 2020 2020 2020  lform.          
-0000a040: 2020 6966 2022 7374 6173 6822 2069 6e20    if "stash" in 
-0000a050: 6f70 743a 0a20 2020 2020 2020 2020 2020  opt:.           
-0000a060: 2020 2020 2072 6574 7572 6e20 7365 6c66       return self
-0000a070: 2e68 616e 646c 655f 7374 6173 6828 4661  .handle_stash(Fa
-0000a080: 6c73 6529 0a0a 2020 2020 2020 2020 2020  lse)..          
-0000a090: 2020 6966 2022 7361 7665 2220 696e 206f    if "save" in o
-0000a0a0: 7074 3a0a 2020 2020 2020 2020 2020 2020  pt:.            
-0000a0b0: 2020 2020 706f 7374 5f73 7a2c 205f 2c20      post_sz, _, 
-0000a0c0: 5f2c 205f 2c20 7061 7468 2c20 5f20 3d20  _, _, path, _ = 
-0000a0d0: 7365 6c66 2e64 756d 705f 746f 5f66 696c  self.dump_to_fil
-0000a0e0: 6528 4661 6c73 6529 0a20 2020 2020 2020  e(False).       
-0000a0f0: 2020 2020 2020 2020 2073 656c 662e 6c6f           self.lo
-0000a100: 6728 2275 726c 666f 726d 3a20 7b7d 2062  g("urlform: {} b
-0000a110: 7974 6573 2c20 7b7d 222e 666f 726d 6174  ytes, {}".format
-0000a120: 2870 6f73 745f 737a 2c20 7061 7468 2929  (post_sz, path))
-0000a130: 0a20 2020 2020 2020 2020 2020 2065 6c69  .            eli
-0000a140: 6620 2270 7269 6e74 2220 696e 206f 7074  f "print" in opt
-0000a150: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0000a160: 2020 7265 6164 6572 2c20 5f20 3d20 7365    reader, _ = se
-0000a170: 6c66 2e67 6574 5f62 6f64 795f 7265 6164  lf.get_body_read
-0000a180: 6572 2829 0a20 2020 2020 2020 2020 2020  er().           
-0000a190: 2020 2020 2062 7566 203d 2062 2222 0a20       buf = b"". 
-0000a1a0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-0000a1b0: 6f72 2072 6275 6620 696e 2072 6561 6465  or rbuf in reade
-0000a1c0: 723a 0a20 2020 2020 2020 2020 2020 2020  r:.             
-0000a1d0: 2020 2020 2020 2062 7566 202b 3d20 7262         buf += rb
-0000a1e0: 7566 0a20 2020 2020 2020 2020 2020 2020  uf.             
-0000a1f0: 2020 2020 2020 2069 6620 6e6f 7420 7262         if not rb
-0000a200: 7566 206f 7220 6c65 6e28 6275 6629 203e  uf or len(buf) >
-0000a210: 3d20 3332 3736 383a 0a20 2020 2020 2020  = 32768:.       
-0000a220: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a230: 2062 7265 616b 0a0a 2020 2020 2020 2020   break..        
-0000a240: 2020 2020 2020 2020 6966 2062 7566 3a0a          if buf:.
-0000a250: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a260: 2020 2020 6f72 6967 203d 2062 7566 2e64      orig = buf.d
-0000a270: 6563 6f64 6528 2275 7466 2d38 222c 2022  ecode("utf-8", "
-0000a280: 7265 706c 6163 6522 290a 2020 2020 2020  replace").      
-0000a290: 2020 2020 2020 2020 2020 2020 2020 7420                t 
-0000a2a0: 3d20 2275 726c 666f 726d 5f72 6177 207b  = "urlform_raw {
-0000a2b0: 7d20 4020 7b7d 5c6e 2020 7b7d 5c6e 220a  } @ {}\n  {}\n".
-0000a2c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a2d0: 2020 2020 7365 6c66 2e6c 6f67 2874 2e66      self.log(t.f
-0000a2e0: 6f72 6d61 7428 6c65 6e28 6f72 6967 292c  ormat(len(orig),
-0000a2f0: 2073 656c 662e 7670 6174 682c 206f 7269   self.vpath, ori
-0000a300: 6729 290a 2020 2020 2020 2020 2020 2020  g)).            
-0000a310: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
-0000a320: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a330: 2020 2020 207a 6220 3d20 756e 7175 6f74       zb = unquot
-0000a340: 6528 6275 662e 7265 706c 6163 6528 6222  e(buf.replace(b"
-0000a350: 2b22 2c20 6222 2022 2929 0a20 2020 2020  +", b" ")).     
-0000a360: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a370: 2020 2070 6c61 696e 203d 207a 622e 6465     plain = zb.de
-0000a380: 636f 6465 2822 7574 662d 3822 2c20 2272  code("utf-8", "r
-0000a390: 6570 6c61 6365 2229 0a20 2020 2020 2020  eplace").       
-0000a3a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a3b0: 2069 6620 6275 662e 7374 6172 7473 7769   if buf.startswi
-0000a3c0: 7468 2862 226d 7367 3d22 293a 0a20 2020  th(b"msg="):.   
-0000a3d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a3e0: 2020 2020 2020 2020 2070 6c61 696e 203d           plain =
-0000a3f0: 2070 6c61 696e 5b34 3a5d 0a20 2020 2020   plain[4:].     
-0000a400: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a410: 2020 2020 2020 2076 6673 2c20 7265 6d20         vfs, rem 
-0000a420: 3d20 7365 6c66 2e61 7372 762e 7666 732e  = self.asrv.vfs.
-0000a430: 6765 7428 0a20 2020 2020 2020 2020 2020  get(.           
-0000a440: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a450: 2020 2020 2073 656c 662e 7670 6174 682c       self.vpath,
-0000a460: 2073 656c 662e 756e 616d 652c 2046 616c   self.uname, Fal
-0000a470: 7365 2c20 4661 6c73 650a 2020 2020 2020  se, False.      
-0000a480: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a490: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-0000a4a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a4b0: 2020 2020 786d 203d 2076 6673 2e66 6c61      xm = vfs.fla
-0000a4c0: 6773 2e67 6574 2822 786d 2229 0a20 2020  gs.get("xm").   
-0000a4d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a4e0: 2020 2020 2020 2020 2069 6620 786d 3a0a           if xm:.
+00007890: 2073 7420 3d20 626f 732e 7374 6174 286f   st = bos.stat(o
+000078a0: 732e 7061 7468 2e6a 6f69 6e28 7461 702c  s.path.join(tap,
+000078b0: 2078 5b22 7670 225d 2929 0a20 2020 2020   x["vp"])).     
+000078c0: 2020 2020 2020 2020 2020 2065 7863 6570             excep
+000078d0: 743a 0a20 2020 2020 2020 2020 2020 2020  t:.             
+000078e0: 2020 2020 2020 2063 6f6e 7469 6e75 650a         continue.
+000078f0: 0a20 2020 2020 2020 2020 2020 2069 7364  .            isd
+00007900: 6972 203d 2073 7461 742e 535f 4953 4449  ir = stat.S_ISDI
+00007910: 5228 7374 2e73 745f 6d6f 6465 290a 0a20  R(st.st_mode).. 
+00007920: 2020 2020 2020 2020 2020 2072 6574 202b             ret +
+00007930: 3d20 223c 443a 7265 7370 6f6e 7365 3e3c  = "<D:response><
+00007940: 443a 6872 6566 3e2f 2573 2573 3c2f 443a  D:href>/%s%s</D:
+00007950: 6872 6566 3e3c 443a 7072 6f70 7374 6174  href><D:propstat
+00007960: 3e3c 443a 7072 6f70 3e22 2025 2028 0a20  ><D:prop>" % (. 
+00007970: 2020 2020 2020 2020 2020 2020 2020 2071                 q
+00007980: 756f 7465 7028 7270 292c 0a20 2020 2020  uotep(rp),.     
+00007990: 2020 2020 2020 2020 2020 2022 2f22 2069             "/" i
+000079a0: 6620 6973 6469 7220 616e 6420 7270 2065  f isdir and rp e
+000079b0: 6c73 6520 2222 2c0a 2020 2020 2020 2020  lse "",.        
+000079c0: 2020 2020 290a 0a20 2020 2020 2020 2020      )..         
+000079d0: 2020 2070 7673 2020 203d 207b 0a20 2020     pvs   = {.   
+000079e0: 2020 2020 2020 2020 2020 2020 2022 6469               "di
+000079f0: 7370 6c61 796e 616d 6522 3a20 6874 6d6c  splayname": html
+00007a00: 5f65 7363 6170 6528 7270 2e73 706c 6974  _escape(rp.split
+00007a10: 2822 2f22 295b 2d31 5d29 2c0a 2020 2020  ("/")[-1]),.    
+00007a20: 2020 2020 2020 2020 2020 2020 2267 6574              "get
+00007a30: 6c61 7374 6d6f 6469 6669 6564 223a 2066  lastmodified": f
+00007a40: 6f72 6d61 7464 6174 6528 6d74 696d 652c  ormatdate(mtime,
+00007a50: 2075 7365 676d 743d 5472 7565 292c 0a20   usegmt=True),. 
+00007a60: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+00007a70: 7265 736f 7572 6365 7479 7065 223a 2027  resourcetype": '
+00007a80: 3c44 3a63 6f6c 6c65 6374 696f 6e20 786d  <D:collection xm
+00007a90: 6c6e 733a 443d 2244 4156 3a22 2f3e 2720  lns:D="DAV:"/>' 
+00007aa0: 6966 2069 7364 6972 2065 6c73 6520 2222  if isdir else ""
+00007ab0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00007ac0: 2020 2273 7570 706f 7274 6564 6c6f 636b    "supportedlock
+00007ad0: 223a 2027 3c44 3a6c 6f63 6b65 6e74 7279  ": '<D:lockentry
+00007ae0: 2078 6d6c 6e73 3a44 3d22 4441 563a 223e   xmlns:D="DAV:">
+00007af0: 3c44 3a6c 6f63 6b73 636f 7065 3e3c 443a  <D:lockscope><D:
+00007b00: 6578 636c 7573 6976 652f 3e3c 2f44 3a6c  exclusive/></D:l
+00007b10: 6f63 6b73 636f 7065 3e3c 443a 6c6f 636b  ockscope><D:lock
+00007b20: 7479 7065 3e3c 443a 7772 6974 652f 3e3c  type><D:write/><
+00007b30: 2f44 3a6c 6f63 6b74 7970 653e 3c2f 443a  /D:locktype></D:
+00007b40: 6c6f 636b 656e 7472 793e 272c 0a20 2020  lockentry>',.   
+00007b50: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
+00007b60: 2020 2020 2020 2069 6620 6e6f 7420 6973         if not is
+00007b70: 6469 723a 0a20 2020 2020 2020 2020 2020  dir:.           
+00007b80: 2020 2020 2070 7673 5b22 6765 7463 6f6e       pvs["getcon
+00007b90: 7465 6e74 7479 7065 225d 203d 2068 746d  tenttype"] = htm
+00007ba0: 6c5f 6573 6361 7065 2867 7565 7373 5f6d  l_escape(guess_m
+00007bb0: 696d 6528 7270 2929 0a20 2020 2020 2020  ime(rp)).       
+00007bc0: 2020 2020 2020 2020 2070 7673 5b22 6765           pvs["ge
+00007bd0: 7463 6f6e 7465 6e74 6c65 6e67 7468 225d  tcontentlength"]
+00007be0: 203d 2073 7472 2873 742e 7374 5f73 697a   = str(st.st_siz
+00007bf0: 6529 0a0a 2020 2020 2020 2020 2020 2020  e)..            
+00007c00: 666f 7220 6b2c 2076 2069 6e20 7076 732e  for k, v in pvs.
+00007c10: 6974 656d 7328 293a 0a20 2020 2020 2020  items():.       
+00007c20: 2020 2020 2020 2020 2069 6620 6b20 6e6f           if k no
+00007c30: 7420 696e 2070 726f 7073 3a0a 2020 2020  t in props:.    
+00007c40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007c50: 636f 6e74 696e 7565 0a20 2020 2020 2020  continue.       
+00007c60: 2020 2020 2020 2020 2065 6c69 6620 763a           elif v:
+00007c70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00007c80: 2020 2020 2072 6574 202b 3d20 223c 443a       ret += "<D:
+00007c90: 2573 3e25 733c 2f44 3a25 733e 2220 2520  %s>%s</D:%s>" % 
+00007ca0: 286b 2c20 762c 206b 290a 2020 2020 2020  (k, v, k).      
+00007cb0: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
+00007cc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007cd0: 2020 2020 7265 7420 2b3d 2022 3c44 3a25      ret += "<D:%
+00007ce0: 732f 3e22 2025 2028 6b2c 290a 0a20 2020  s/>" % (k,)..   
+00007cf0: 2020 2020 2020 2020 2072 6574 202b 3d20           ret += 
+00007d00: 223c 2f44 3a70 726f 703e 3c44 3a73 7461  "</D:prop><D:sta
+00007d10: 7475 733e 4854 5450 2f31 2e31 2032 3030  tus>HTTP/1.1 200
+00007d20: 204f 4b3c 2f44 3a73 7461 7475 733e 3c2f   OK</D:status></
+00007d30: 443a 7072 6f70 7374 6174 3e22 0a0a 2020  D:propstat>"..  
+00007d40: 2020 2020 2020 2020 2020 6d69 7373 696e            missin
+00007d50: 6720 3d20 5b22 3c44 3a25 732f 3e22 2025  g = ["<D:%s/>" %
+00007d60: 2028 782c 2920 666f 7220 7820 696e 2070   (x,) for x in p
+00007d70: 726f 7073 2069 6620 7820 6e6f 7420 696e  rops if x not in
+00007d80: 2070 7673 5d0a 2020 2020 2020 2020 2020   pvs].          
+00007d90: 2020 6966 206d 6973 7369 6e67 2061 6e64    if missing and
+00007da0: 2063 6c65 6e3a 0a20 2020 2020 2020 2020   clen:.         
+00007db0: 2020 2020 2020 2074 203d 2022 3c44 3a70         t = "<D:p
+00007dc0: 726f 7073 7461 743e 3c44 3a70 726f 703e  ropstat><D:prop>
+00007dd0: 7b7d 3c2f 443a 7072 6f70 3e3c 443a 7374  {}</D:prop><D:st
+00007de0: 6174 7573 3e48 5454 502f 312e 3120 3430  atus>HTTP/1.1 40
+00007df0: 3420 4e6f 7420 466f 756e 643c 2f44 3a73  4 Not Found</D:s
+00007e00: 7461 7475 733e 3c2f 443a 7072 6f70 7374  tatus></D:propst
+00007e10: 6174 3e22 0a20 2020 2020 2020 2020 2020  at>".           
+00007e20: 2020 2020 2072 6574 202b 3d20 742e 666f       ret += t.fo
+00007e30: 726d 6174 2822 222e 6a6f 696e 286d 6973  rmat("".join(mis
+00007e40: 7369 6e67 2929 0a0a 2020 2020 2020 2020  sing))..        
+00007e50: 2020 2020 7265 7420 2b3d 2022 3c2f 443a      ret += "</D:
+00007e60: 7265 7370 6f6e 7365 3e22 0a20 2020 2020  response>".     
+00007e70: 2020 2020 2020 2077 6869 6c65 206c 656e         while len
+00007e80: 2872 6574 2920 3e3d 2063 6875 6e6b 737a  (ret) >= chunksz
+00007e90: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00007ea0: 2020 7265 7420 3d20 7365 6c66 2e73 656e    ret = self.sen
+00007eb0: 645f 6368 756e 6b28 7265 742c 2065 6e63  d_chunk(ret, enc
+00007ec0: 2c20 6368 756e 6b73 7a29 0a0a 2020 2020  , chunksz)..    
+00007ed0: 2020 2020 7265 7420 2b3d 2022 3c2f 443a      ret += "</D:
+00007ee0: 6d75 6c74 6973 7461 7475 733e 220a 2020  multistatus>".  
+00007ef0: 2020 2020 2020 7768 696c 6520 7265 743a        while ret:
+00007f00: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+00007f10: 203d 2073 656c 662e 7365 6e64 5f63 6875   = self.send_chu
+00007f20: 6e6b 2872 6574 2c20 656e 632c 2063 6875  nk(ret, enc, chu
+00007f30: 6e6b 737a 290a 0a20 2020 2020 2020 2073  nksz)..        s
+00007f40: 656c 662e 7365 6e64 5f63 6875 6e6b 2822  elf.send_chunk("
+00007f50: 222c 2065 6e63 2c20 6368 756e 6b73 7a29  ", enc, chunksz)
+00007f60: 0a20 2020 2020 2020 2023 2073 656c 662e  .        # self.
+00007f70: 7265 706c 7928 7265 742e 656e 636f 6465  reply(ret.encode
+00007f80: 2865 6e63 2c20 2272 6570 6c61 6365 2229  (enc, "replace")
+00007f90: 2c32 3037 2c20 2274 6578 742f 786d 6c3b  ,207, "text/xml;
+00007fa0: 2063 6861 7273 6574 3d22 202b 2065 6e63   charset=" + enc
+00007fb0: 290a 2020 2020 2020 2020 7265 7475 726e  ).        return
+00007fc0: 2054 7275 650a 0a20 2020 2064 6566 2068   True..    def h
+00007fd0: 616e 646c 655f 7072 6f70 7061 7463 6828  andle_proppatch(
+00007fe0: 7365 6c66 2920 203a 0a20 2020 2020 2020  self)  :.       
+00007ff0: 2069 6620 7365 6c66 2e64 6f5f 6c6f 673a   if self.do_log:
+00008000: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+00008010: 662e 6c6f 6728 2250 5041 5443 4820 2573  f.log("PPATCH %s
+00008020: 2040 2573 2220 2520 2873 656c 662e 7265   @%s" % (self.re
+00008030: 712c 2073 656c 662e 756e 616d 6529 290a  q, self.uname)).
+00008040: 0a20 2020 2020 2020 2069 6620 7365 6c66  .        if self
+00008050: 2e61 7267 732e 6e6f 5f64 6176 3a0a 2020  .args.no_dav:.  
+00008060: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
+00008070: 5065 626b 6163 2834 3035 2c20 2257 6562  Pebkac(405, "Web
+00008080: 4441 5620 6973 2064 6973 6162 6c65 6420  DAV is disabled 
+00008090: 696e 2073 6572 7665 7220 636f 6e66 6967  in server config
+000080a0: 2229 0a0a 2020 2020 2020 2020 6966 206e  ")..        if n
+000080b0: 6f74 2073 656c 662e 6361 6e5f 7772 6974  ot self.can_writ
+000080c0: 653a 0a20 2020 2020 2020 2020 2020 2073  e:.            s
+000080d0: 656c 662e 6c6f 6728 227b 7d20 7472 6965  elf.log("{} trie
+000080e0: 6420 746f 2070 726f 7070 6174 6368 205b  d to proppatch [
+000080f0: 7b7d 5d22 2e66 6f72 6d61 7428 7365 6c66  {}]".format(self
+00008100: 2e75 6e61 6d65 2c20 7365 6c66 2e76 7061  .uname, self.vpa
+00008110: 7468 2929 0a20 2020 2020 2020 2020 2020  th)).           
+00008120: 2072 6169 7365 2050 6562 6b61 6328 3430   raise Pebkac(40
+00008130: 312c 2022 6175 7468 656e 7469 6361 7465  1, "authenticate
+00008140: 2229 0a0a 2020 2020 2020 2020 6672 6f6d  ")..        from
+00008150: 2078 6d6c 2e65 7472 6565 2069 6d70 6f72   xml.etree impor
+00008160: 7420 456c 656d 656e 7454 7265 6520 6173  t ElementTree as
+00008170: 2045 540a 0a20 2020 2020 2020 2066 726f   ET..        fro
+00008180: 6d20 2e64 786d 6c20 696d 706f 7274 206d  m .dxml import m
+00008190: 6b65 6e6f 642c 206d 6b74 6e6f 642c 2070  kenod, mktnod, p
+000081a0: 6172 7365 5f78 6d6c 0a0a 2020 2020 2020  arse_xml..      
+000081b0: 2020 7365 6c66 2e61 7372 762e 7666 732e    self.asrv.vfs.
+000081c0: 6765 7428 7365 6c66 2e76 7061 7468 2c20  get(self.vpath, 
+000081d0: 7365 6c66 2e75 6e61 6d65 2c20 4661 6c73  self.uname, Fals
+000081e0: 652c 2046 616c 7365 290a 2020 2020 2020  e, False).      
+000081f0: 2020 2320 6162 7370 6174 6820 3d20 766e    # abspath = vn
+00008200: 2e64 6361 6e6f 6e69 6361 6c28 7265 6d29  .dcanonical(rem)
+00008210: 0a0a 2020 2020 2020 2020 6275 6620 3d20  ..        buf = 
+00008220: 6222 220a 2020 2020 2020 2020 666f 7220  b"".        for 
+00008230: 7262 7566 2069 6e20 7365 6c66 2e67 6574  rbuf in self.get
+00008240: 5f62 6f64 795f 7265 6164 6572 2829 5b30  _body_reader()[0
+00008250: 5d3a 0a20 2020 2020 2020 2020 2020 2062  ]:.            b
+00008260: 7566 202b 3d20 7262 7566 0a20 2020 2020  uf += rbuf.     
+00008270: 2020 2020 2020 2069 6620 6e6f 7420 7262         if not rb
+00008280: 7566 206f 7220 6c65 6e28 6275 6629 203e  uf or len(buf) >
+00008290: 3d20 3132 3820 2a20 3130 3234 3a0a 2020  = 128 * 1024:.  
+000082a0: 2020 2020 2020 2020 2020 2020 2020 6272                br
+000082b0: 6561 6b0a 0a20 2020 2020 2020 2069 6620  eak..        if 
+000082c0: 7365 6c66 2e5f 6170 706c 6573 616e 2829  self._applesan()
+000082d0: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
+000082e0: 7475 726e 2054 7275 650a 0a20 2020 2020  turn True..     
+000082f0: 2020 2074 7874 203d 2062 7566 2e64 6563     txt = buf.dec
+00008300: 6f64 6528 2261 7363 6969 222c 2022 7265  ode("ascii", "re
+00008310: 706c 6163 6522 292e 6c6f 7765 7228 290a  place").lower().
+00008320: 2020 2020 2020 2020 656e 6320 3d20 7365          enc = se
+00008330: 6c66 2e67 6574 5f78 6d6c 5f65 6e63 2874  lf.get_xml_enc(t
+00008340: 7874 290a 2020 2020 2020 2020 7565 6e63  xt).        uenc
+00008350: 203d 2065 6e63 2e75 7070 6572 2829 0a0a   = enc.upper()..
+00008360: 2020 2020 2020 2020 7478 7420 3d20 6275          txt = bu
+00008370: 662e 6465 636f 6465 2865 6e63 2c20 2272  f.decode(enc, "r
+00008380: 6570 6c61 6365 2229 0a20 2020 2020 2020  eplace").       
+00008390: 2045 542e 7265 6769 7374 6572 5f6e 616d   ET.register_nam
+000083a0: 6573 7061 6365 2822 4422 2c20 2244 4156  espace("D", "DAV
+000083b0: 3a22 290a 2020 2020 2020 2020 7872 6f6f  :").        xroo
+000083c0: 7420 3d20 6d6b 656e 6f64 2822 443a 6f72  t = mkenod("D:or
+000083d0: 7a22 290a 2020 2020 2020 2020 7872 6f6f  z").        xroo
+000083e0: 742e 696e 7365 7274 2830 2c20 7061 7273  t.insert(0, pars
+000083f0: 655f 786d 6c28 7478 7429 290a 2020 2020  e_xml(txt)).    
+00008400: 2020 2020 7870 726f 7020 3d20 7872 6f6f      xprop = xroo
+00008410: 742e 6669 6e64 2872 222e 2f7b 4441 563a  t.find(r"./{DAV:
+00008420: 7d70 726f 7065 7274 7975 7064 6174 652f  }propertyupdate/
+00008430: 7b44 4156 3a7d 7365 742f 7b44 4156 3a7d  {DAV:}set/{DAV:}
+00008440: 7072 6f70 2229 0a20 2020 2020 2020 2061  prop").        a
+00008450: 7373 6572 7420 7870 726f 700a 2020 2020  ssert xprop.    
+00008460: 2020 2020 666f 7220 7a65 2069 6e20 7870      for ze in xp
+00008470: 726f 703a 0a20 2020 2020 2020 2020 2020  rop:.           
+00008480: 207a 652e 636c 6561 7228 290a 0a20 2020   ze.clear()..   
+00008490: 2020 2020 2074 7874 203d 2022 2222 3c6d       txt = """<m
+000084a0: 756c 7469 7374 6174 7573 2078 6d6c 6e73  ultistatus xmlns
+000084b0: 3d22 4441 563a 223e 3c72 6573 706f 6e73  ="DAV:"><respons
+000084c0: 653e 3c70 726f 7073 7461 743e 3c73 7461  e><propstat><sta
+000084d0: 7475 733e 4854 5450 2f31 2e31 2034 3033  tus>HTTP/1.1 403
+000084e0: 2046 6f72 6269 6464 656e 3c2f 7374 6174   Forbidden</stat
+000084f0: 7573 3e3c 2f70 726f 7073 7461 743e 3c2f  us></propstat></
+00008500: 7265 7370 6f6e 7365 3e3c 2f6d 756c 7469  response></multi
+00008510: 7374 6174 7573 3e22 2222 0a20 2020 2020  status>""".     
+00008520: 2020 2078 726f 6f74 203d 2070 6172 7365     xroot = parse
+00008530: 5f78 6d6c 2874 7874 290a 0a20 2020 2020  _xml(txt)..     
+00008540: 2020 2065 6c20 3d20 7872 6f6f 742e 6669     el = xroot.fi
+00008550: 6e64 2872 222e 2f7b 4441 563a 7d72 6573  nd(r"./{DAV:}res
+00008560: 706f 6e73 6522 290a 2020 2020 2020 2020  ponse").        
+00008570: 6173 7365 7274 2065 6c0a 2020 2020 2020  assert el.      
+00008580: 2020 6532 203d 206d 6b74 6e6f 6428 2244    e2 = mktnod("D
+00008590: 3a68 7265 6622 2c20 7175 6f74 6570 2873  :href", quotep(s
+000085a0: 656c 662e 6172 6773 2e53 5253 202b 2073  elf.args.SRS + s
+000085b0: 656c 662e 7670 6174 6829 290a 2020 2020  elf.vpath)).    
+000085c0: 2020 2020 656c 2e69 6e73 6572 7428 302c      el.insert(0,
+000085d0: 2065 3229 0a0a 2020 2020 2020 2020 656c   e2)..        el
+000085e0: 203d 2078 726f 6f74 2e66 696e 6428 7222   = xroot.find(r"
+000085f0: 2e2f 7b44 4156 3a7d 7265 7370 6f6e 7365  ./{DAV:}response
+00008600: 2f7b 4441 563a 7d70 726f 7073 7461 7422  /{DAV:}propstat"
+00008610: 290a 2020 2020 2020 2020 6173 7365 7274  ).        assert
+00008620: 2065 6c0a 2020 2020 2020 2020 656c 2e69   el.        el.i
+00008630: 6e73 6572 7428 302c 2078 7072 6f70 290a  nsert(0, xprop).
+00008640: 0a20 2020 2020 2020 2072 6574 203d 2027  .        ret = '
+00008650: 3c3f 786d 6c20 7665 7273 696f 6e3d 2231  <?xml version="1
+00008660: 2e30 2220 656e 636f 6469 6e67 3d22 7b7d  .0" encoding="{}
+00008670: 223f 3e5c 6e27 2e66 6f72 6d61 7428 7565  "?>\n'.format(ue
+00008680: 6e63 290a 2020 2020 2020 2020 7265 7420  nc).        ret 
+00008690: 2b3d 2045 542e 746f 7374 7269 6e67 2878  += ET.tostring(x
+000086a0: 726f 6f74 292e 6465 636f 6465 2822 7574  root).decode("ut
+000086b0: 662d 3822 290a 0a20 2020 2020 2020 2073  f-8")..        s
+000086c0: 656c 662e 7265 706c 7928 7265 742e 656e  elf.reply(ret.en
+000086d0: 636f 6465 2865 6e63 2c20 2272 6570 6c61  code(enc, "repla
+000086e0: 6365 2229 2c20 3230 372c 2022 7465 7874  ce"), 207, "text
+000086f0: 2f78 6d6c 3b20 6368 6172 7365 743d 2220  /xml; charset=" 
+00008700: 2b20 656e 6329 0a20 2020 2020 2020 2072  + enc).        r
+00008710: 6574 7572 6e20 5472 7565 0a0a 2020 2020  eturn True..    
+00008720: 6465 6620 6861 6e64 6c65 5f6c 6f63 6b28  def handle_lock(
+00008730: 7365 6c66 2920 203a 0a20 2020 2020 2020  self)  :.       
+00008740: 2069 6620 7365 6c66 2e64 6f5f 6c6f 673a   if self.do_log:
+00008750: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+00008760: 662e 6c6f 6728 224c 4f43 4b20 2573 2040  f.log("LOCK %s @
+00008770: 2573 2220 2520 2873 656c 662e 7265 712c  %s" % (self.req,
+00008780: 2073 656c 662e 756e 616d 6529 290a 0a20   self.uname)).. 
+00008790: 2020 2020 2020 2069 6620 7365 6c66 2e61         if self.a
+000087a0: 7267 732e 6e6f 5f64 6176 3a0a 2020 2020  rgs.no_dav:.    
+000087b0: 2020 2020 2020 2020 7261 6973 6520 5065          raise Pe
+000087c0: 626b 6163 2834 3035 2c20 2257 6562 4441  bkac(405, "WebDA
+000087d0: 5620 6973 2064 6973 6162 6c65 6420 696e  V is disabled in
+000087e0: 2073 6572 7665 7220 636f 6e66 6967 2229   server config")
+000087f0: 0a0a 2020 2020 2020 2020 2320 7769 6e37  ..        # win7
+00008800: 2b20 6465 6164 6c6f 636b 7320 6966 2077  + deadlocks if w
+00008810: 6520 7361 7920 6e6f 3b20 6a75 7374 2073  e say no; just s
+00008820: 6d69 6c65 2061 6e64 206e 6f64 0a20 2020  mile and nod.   
+00008830: 2020 2020 2069 6620 6e6f 7420 7365 6c66       if not self
+00008840: 2e63 616e 5f77 7269 7465 2061 6e64 2022  .can_write and "
+00008850: 4d69 6372 6f73 6f66 742d 5765 6244 4156  Microsoft-WebDAV
+00008860: 2220 6e6f 7420 696e 2073 656c 662e 7561  " not in self.ua
+00008870: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
+00008880: 6c66 2e6c 6f67 2822 7b7d 2074 7269 6564  lf.log("{} tried
+00008890: 2074 6f20 6c6f 636b 205b 7b7d 5d22 2e66   to lock [{}]".f
+000088a0: 6f72 6d61 7428 7365 6c66 2e75 6e61 6d65  ormat(self.uname
+000088b0: 2c20 7365 6c66 2e76 7061 7468 2929 0a20  , self.vpath)). 
+000088c0: 2020 2020 2020 2020 2020 2072 6169 7365             raise
+000088d0: 2050 6562 6b61 6328 3430 312c 2022 6175   Pebkac(401, "au
+000088e0: 7468 656e 7469 6361 7465 2229 0a0a 2020  thenticate")..  
+000088f0: 2020 2020 2020 6672 6f6d 2078 6d6c 2e65        from xml.e
+00008900: 7472 6565 2069 6d70 6f72 7420 456c 656d  tree import Elem
+00008910: 656e 7454 7265 6520 6173 2045 540a 0a20  entTree as ET.. 
+00008920: 2020 2020 2020 2066 726f 6d20 2e64 786d         from .dxm
+00008930: 6c20 696d 706f 7274 206d 6b65 6e6f 642c  l import mkenod,
+00008940: 206d 6b74 6e6f 642c 2070 6172 7365 5f78   mktnod, parse_x
+00008950: 6d6c 0a0a 2020 2020 2020 2020 766e 2c20  ml..        vn, 
+00008960: 7265 6d20 3d20 7365 6c66 2e61 7372 762e  rem = self.asrv.
+00008970: 7666 732e 6765 7428 7365 6c66 2e76 7061  vfs.get(self.vpa
+00008980: 7468 2c20 7365 6c66 2e75 6e61 6d65 2c20  th, self.uname, 
+00008990: 4661 6c73 652c 2046 616c 7365 290a 2020  False, False).  
+000089a0: 2020 2020 2020 6162 7370 6174 6820 3d20        abspath = 
+000089b0: 766e 2e64 6361 6e6f 6e69 6361 6c28 7265  vn.dcanonical(re
+000089c0: 6d29 0a0a 2020 2020 2020 2020 6275 6620  m)..        buf 
+000089d0: 3d20 6222 220a 2020 2020 2020 2020 666f  = b"".        fo
+000089e0: 7220 7262 7566 2069 6e20 7365 6c66 2e67  r rbuf in self.g
+000089f0: 6574 5f62 6f64 795f 7265 6164 6572 2829  et_body_reader()
+00008a00: 5b30 5d3a 0a20 2020 2020 2020 2020 2020  [0]:.           
+00008a10: 2062 7566 202b 3d20 7262 7566 0a20 2020   buf += rbuf.   
+00008a20: 2020 2020 2020 2020 2069 6620 6e6f 7420           if not 
+00008a30: 7262 7566 206f 7220 6c65 6e28 6275 6629  rbuf or len(buf)
+00008a40: 203e 3d20 3132 3820 2a20 3130 3234 3a0a   >= 128 * 1024:.
+00008a50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008a60: 6272 6561 6b0a 0a20 2020 2020 2020 2069  break..        i
+00008a70: 6620 7365 6c66 2e5f 6170 706c 6573 616e  f self._applesan
+00008a80: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
+00008a90: 7265 7475 726e 2054 7275 650a 0a20 2020  return True..   
+00008aa0: 2020 2020 2074 7874 203d 2062 7566 2e64       txt = buf.d
+00008ab0: 6563 6f64 6528 2261 7363 6969 222c 2022  ecode("ascii", "
+00008ac0: 7265 706c 6163 6522 292e 6c6f 7765 7228  replace").lower(
+00008ad0: 290a 2020 2020 2020 2020 656e 6320 3d20  ).        enc = 
+00008ae0: 7365 6c66 2e67 6574 5f78 6d6c 5f65 6e63  self.get_xml_enc
+00008af0: 2874 7874 290a 2020 2020 2020 2020 7565  (txt).        ue
+00008b00: 6e63 203d 2065 6e63 2e75 7070 6572 2829  nc = enc.upper()
+00008b10: 0a0a 2020 2020 2020 2020 7478 7420 3d20  ..        txt = 
+00008b20: 6275 662e 6465 636f 6465 2865 6e63 2c20  buf.decode(enc, 
+00008b30: 2272 6570 6c61 6365 2229 0a20 2020 2020  "replace").     
+00008b40: 2020 2045 542e 7265 6769 7374 6572 5f6e     ET.register_n
+00008b50: 616d 6573 7061 6365 2822 4422 2c20 2244  amespace("D", "D
+00008b60: 4156 3a22 290a 2020 2020 2020 2020 6c6b  AV:").        lk
+00008b70: 203d 2070 6172 7365 5f78 6d6c 2874 7874   = parse_xml(txt
+00008b80: 290a 2020 2020 2020 2020 6173 7365 7274  ).        assert
+00008b90: 206c 6b2e 7461 6720 3d3d 2022 7b44 4156   lk.tag == "{DAV
+00008ba0: 3a7d 6c6f 636b 696e 666f 220a 0a20 2020  :}lockinfo"..   
+00008bb0: 2020 2020 2074 6f6b 656e 203d 2073 7472       token = str
+00008bc0: 2875 7569 642e 7575 6964 3428 2929 0a0a  (uuid.uuid4())..
+00008bd0: 2020 2020 2020 2020 6966 206e 6f74 206c          if not l
+00008be0: 6b2e 6669 6e64 2872 222e 2f7b 4441 563a  k.find(r"./{DAV:
+00008bf0: 7d64 6570 7468 2229 3a0a 2020 2020 2020  }depth"):.      
+00008c00: 2020 2020 2020 6465 7074 6820 3d20 7365        depth = se
+00008c10: 6c66 2e68 6561 6465 7273 2e67 6574 2822  lf.headers.get("
+00008c20: 6465 7074 6822 2c20 2269 6e66 696e 6974  depth", "infinit
+00008c30: 7922 290a 2020 2020 2020 2020 2020 2020  y").            
+00008c40: 6c6b 2e61 7070 656e 6428 6d6b 746e 6f64  lk.append(mktnod
+00008c50: 2822 443a 6465 7074 6822 2c20 6465 7074  ("D:depth", dept
+00008c60: 6829 290a 0a20 2020 2020 2020 206c 6b2e  h))..        lk.
+00008c70: 6170 7065 6e64 286d 6b74 6e6f 6428 2244  append(mktnod("D
+00008c80: 3a74 696d 656f 7574 222c 2022 5365 636f  :timeout", "Seco
+00008c90: 6e64 2d33 3331 3022 2929 0a20 2020 2020  nd-3310")).     
+00008ca0: 2020 206c 6b2e 6170 7065 6e64 286d 6b65     lk.append(mke
+00008cb0: 6e6f 6428 2244 3a6c 6f63 6b74 6f6b 656e  nod("D:locktoken
+00008cc0: 222c 206d 6b74 6e6f 6428 2244 3a68 7265  ", mktnod("D:hre
+00008cd0: 6622 2c20 746f 6b65 6e29 2929 0a20 2020  f", token))).   
+00008ce0: 2020 2020 206c 6b2e 6170 7065 6e64 280a       lk.append(.
+00008cf0: 2020 2020 2020 2020 2020 2020 6d6b 656e              mken
+00008d00: 6f64 2822 443a 6c6f 636b 726f 6f74 222c  od("D:lockroot",
+00008d10: 206d 6b74 6e6f 6428 2244 3a68 7265 6622   mktnod("D:href"
+00008d20: 2c20 7175 6f74 6570 2873 656c 662e 6172  , quotep(self.ar
+00008d30: 6773 2e53 5253 202b 2073 656c 662e 7670  gs.SRS + self.vp
+00008d40: 6174 6829 2929 0a20 2020 2020 2020 2029  ath))).        )
+00008d50: 0a0a 2020 2020 2020 2020 6c6b 3220 3d20  ..        lk2 = 
+00008d60: 6d6b 656e 6f64 2822 443a 6163 7469 7665  mkenod("D:active
+00008d70: 6c6f 636b 2229 0a20 2020 2020 2020 2078  lock").        x
+00008d80: 726f 6f74 203d 206d 6b65 6e6f 6428 2244  root = mkenod("D
+00008d90: 3a70 726f 7022 2c20 6d6b 656e 6f64 2822  :prop", mkenod("
+00008da0: 443a 6c6f 636b 6469 7363 6f76 6572 7922  D:lockdiscovery"
+00008db0: 2c20 6c6b 3229 290a 2020 2020 2020 2020  , lk2)).        
+00008dc0: 666f 7220 6120 696e 206c 6b3a 0a20 2020  for a in lk:.   
+00008dd0: 2020 2020 2020 2020 206c 6b32 2e61 7070           lk2.app
+00008de0: 656e 6428 6129 0a0a 2020 2020 2020 2020  end(a)..        
+00008df0: 7265 7420 3d20 273c 3f78 6d6c 2076 6572  ret = '<?xml ver
+00008e00: 7369 6f6e 3d22 312e 3022 2065 6e63 6f64  sion="1.0" encod
+00008e10: 696e 673d 227b 7d22 3f3e 5c6e 272e 666f  ing="{}"?>\n'.fo
+00008e20: 726d 6174 2875 656e 6329 0a20 2020 2020  rmat(uenc).     
+00008e30: 2020 2072 6574 202b 3d20 4554 2e74 6f73     ret += ET.tos
+00008e40: 7472 696e 6728 7872 6f6f 7429 2e64 6563  tring(xroot).dec
+00008e50: 6f64 6528 2275 7466 2d38 2229 0a0a 2020  ode("utf-8")..  
+00008e60: 2020 2020 2020 7263 203d 2032 3030 0a20        rc = 200. 
+00008e70: 2020 2020 2020 2069 6620 7365 6c66 2e63         if self.c
+00008e80: 616e 5f77 7269 7465 2061 6e64 206e 6f74  an_write and not
+00008e90: 2062 6f73 2e70 6174 682e 6973 6669 6c65   bos.path.isfile
+00008ea0: 2861 6273 7061 7468 293a 0a20 2020 2020  (abspath):.     
+00008eb0: 2020 2020 2020 2077 6974 6820 6f70 656e         with open
+00008ec0: 2866 7365 6e63 2861 6273 7061 7468 292c  (fsenc(abspath),
+00008ed0: 2022 7762 2229 2061 7320 5f3a 0a20 2020   "wb") as _:.   
+00008ee0: 2020 2020 2020 2020 2020 2020 2072 6320               rc 
+00008ef0: 3d20 3230 310a 0a20 2020 2020 2020 2073  = 201..        s
+00008f00: 656c 662e 6f75 745f 6865 6164 6572 735b  elf.out_headers[
+00008f10: 224c 6f63 6b2d 546f 6b65 6e22 5d20 3d20  "Lock-Token"] = 
+00008f20: 223c 7b7d 3e22 2e66 6f72 6d61 7428 746f  "<{}>".format(to
+00008f30: 6b65 6e29 0a20 2020 2020 2020 2073 656c  ken).        sel
+00008f40: 662e 7265 706c 7928 7265 742e 656e 636f  f.reply(ret.enco
+00008f50: 6465 2865 6e63 2c20 2272 6570 6c61 6365  de(enc, "replace
+00008f60: 2229 2c20 7263 2c20 2274 6578 742f 786d  "), rc, "text/xm
+00008f70: 6c3b 2063 6861 7273 6574 3d22 202b 2065  l; charset=" + e
+00008f80: 6e63 290a 2020 2020 2020 2020 7265 7475  nc).        retu
+00008f90: 726e 2054 7275 650a 0a20 2020 2064 6566  rn True..    def
+00008fa0: 2068 616e 646c 655f 756e 6c6f 636b 2873   handle_unlock(s
+00008fb0: 656c 6629 2020 3a0a 2020 2020 2020 2020  elf)  :.        
+00008fc0: 6966 2073 656c 662e 646f 5f6c 6f67 3a0a  if self.do_log:.
+00008fd0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+00008fe0: 2e6c 6f67 2822 554e 4c4f 434b 2025 7320  .log("UNLOCK %s 
+00008ff0: 4025 7322 2025 2028 7365 6c66 2e72 6571  @%s" % (self.req
+00009000: 2c20 7365 6c66 2e75 6e61 6d65 2929 0a0a  , self.uname))..
+00009010: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
+00009020: 6172 6773 2e6e 6f5f 6461 763a 0a20 2020  args.no_dav:.   
+00009030: 2020 2020 2020 2020 2072 6169 7365 2050           raise P
+00009040: 6562 6b61 6328 3430 352c 2022 5765 6244  ebkac(405, "WebD
+00009050: 4156 2069 7320 6469 7361 626c 6564 2069  AV is disabled i
+00009060: 6e20 7365 7276 6572 2063 6f6e 6669 6722  n server config"
+00009070: 290a 0a20 2020 2020 2020 2069 6620 6e6f  )..        if no
+00009080: 7420 7365 6c66 2e63 616e 5f77 7269 7465  t self.can_write
+00009090: 2061 6e64 2022 4d69 6372 6f73 6f66 742d   and "Microsoft-
+000090a0: 5765 6244 4156 2220 6e6f 7420 696e 2073  WebDAV" not in s
+000090b0: 656c 662e 7561 3a0a 2020 2020 2020 2020  elf.ua:.        
+000090c0: 2020 2020 7365 6c66 2e6c 6f67 2822 7b7d      self.log("{}
+000090d0: 2074 7269 6564 2074 6f20 6c6f 636b 205b   tried to lock [
+000090e0: 7b7d 5d22 2e66 6f72 6d61 7428 7365 6c66  {}]".format(self
+000090f0: 2e75 6e61 6d65 2c20 7365 6c66 2e76 7061  .uname, self.vpa
+00009100: 7468 2929 0a20 2020 2020 2020 2020 2020  th)).           
+00009110: 2072 6169 7365 2050 6562 6b61 6328 3430   raise Pebkac(40
+00009120: 312c 2022 6175 7468 656e 7469 6361 7465  1, "authenticate
+00009130: 2229 0a0a 2020 2020 2020 2020 7365 6c66  ")..        self
+00009140: 2e73 656e 645f 6865 6164 6572 7328 4e6f  .send_headers(No
+00009150: 6e65 2c20 3230 3429 0a20 2020 2020 2020  ne, 204).       
+00009160: 2072 6574 7572 6e20 5472 7565 0a0a 2020   return True..  
+00009170: 2020 6465 6620 6861 6e64 6c65 5f6d 6b63    def handle_mkc
+00009180: 6f6c 2873 656c 6629 2020 3a0a 2020 2020  ol(self)  :.    
+00009190: 2020 2020 6966 2073 656c 662e 5f61 7070      if self._app
+000091a0: 6c65 7361 6e28 293a 0a20 2020 2020 2020  lesan():.       
+000091b0: 2020 2020 2072 6574 7572 6e20 5472 7565       return True
+000091c0: 0a0a 2020 2020 2020 2020 6966 2073 656c  ..        if sel
+000091d0: 662e 646f 5f6c 6f67 3a0a 2020 2020 2020  f.do_log:.      
+000091e0: 2020 2020 2020 7365 6c66 2e6c 6f67 2822        self.log("
+000091f0: 4d4b 434f 4c20 2573 2040 2573 2220 2520  MKCOL %s @%s" % 
+00009200: 2873 656c 662e 7265 712c 2073 656c 662e  (self.req, self.
+00009210: 756e 616d 6529 290a 0a20 2020 2020 2020  uname))..       
+00009220: 2074 7279 3a0a 2020 2020 2020 2020 2020   try:.          
+00009230: 2020 7265 7475 726e 2073 656c 662e 5f6d    return self._m
+00009240: 6b64 6972 2873 656c 662e 7670 6174 682c  kdir(self.vpath,
+00009250: 2054 7275 6529 0a20 2020 2020 2020 2065   True).        e
+00009260: 7863 6570 7420 5065 626b 6163 2061 7320  xcept Pebkac as 
+00009270: 6578 3a0a 2020 2020 2020 2020 2020 2020  ex:.            
+00009280: 6966 2065 782e 636f 6465 203e 3d20 3530  if ex.code >= 50
+00009290: 303a 0a20 2020 2020 2020 2020 2020 2020  0:.             
+000092a0: 2020 2072 6169 7365 0a0a 2020 2020 2020     raise..      
+000092b0: 2020 2020 2020 7365 6c66 2e72 6570 6c79        self.reply
+000092c0: 2862 2222 2c20 6578 2e63 6f64 6529 0a20  (b"", ex.code). 
+000092d0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+000092e0: 6e20 5472 7565 0a0a 2020 2020 6465 6620  n True..    def 
+000092f0: 6861 6e64 6c65 5f6d 6f76 6528 7365 6c66  handle_move(self
+00009300: 2920 203a 0a20 2020 2020 2020 2064 7374  )  :.        dst
+00009310: 203d 2073 656c 662e 6865 6164 6572 735b   = self.headers[
+00009320: 2264 6573 7469 6e61 7469 6f6e 225d 0a20  "destination"]. 
+00009330: 2020 2020 2020 2064 7374 203d 2072 652e         dst = re.
+00009340: 7375 6228 225e 6874 7470 733f 3a2f 2f5b  sub("^https?://[
+00009350: 5e2f 5d2b 222c 2022 222c 2064 7374 292e  ^/]+", "", dst).
+00009360: 6c73 7472 6970 2829 0a20 2020 2020 2020  lstrip().       
+00009370: 2064 7374 203d 2075 6e71 756f 7465 7028   dst = unquotep(
+00009380: 6473 7429 0a20 2020 2020 2020 2069 6620  dst).        if 
+00009390: 6e6f 7420 7365 6c66 2e5f 6d76 2873 656c  not self._mv(sel
+000093a0: 662e 7670 6174 682c 2064 7374 2e6c 7374  f.vpath, dst.lst
+000093b0: 7269 7028 222f 2229 293a 0a20 2020 2020  rip("/")):.     
+000093c0: 2020 2020 2020 2072 6574 7572 6e20 4661         return Fa
+000093d0: 6c73 650a 0a20 2020 2020 2020 2072 6574  lse..        ret
+000093e0: 7572 6e20 5472 7565 0a0a 2020 2020 6465  urn True..    de
+000093f0: 6620 5f61 7070 6c65 7361 6e28 7365 6c66  f _applesan(self
+00009400: 2920 203a 0a20 2020 2020 2020 2069 6620  )  :.        if 
+00009410: 7365 6c66 2e61 7267 732e 6461 765f 6d61  self.args.dav_ma
+00009420: 6320 6f72 2022 4461 7277 696e 2f22 206e  c or "Darwin/" n
+00009430: 6f74 2069 6e20 7365 6c66 2e75 613a 0a20  ot in self.ua:. 
+00009440: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+00009450: 6e20 4661 6c73 650a 0a20 2020 2020 2020  n False..       
+00009460: 2076 7020 3d20 222f 2220 2b20 7365 6c66   vp = "/" + self
+00009470: 2e76 7061 7468 0a20 2020 2020 2020 2070  .vpath.        p
+00009480: 746e 203d 2072 222f 5c2e 285f 7c44 535f  tn = r"/\.(_|DS_
+00009490: 5374 6f72 657c 5370 6f74 6c69 6768 742d  Store|Spotlight-
+000094a0: 7c66 7365 7665 6e74 7364 7c54 7261 7368  |fseventsd|Trash
+000094b0: 6573 7c41 7070 6c65 446f 7562 6c65 297c  es|AppleDouble)|
+000094c0: 2f5f 5f4d 4143 4f53 220a 2020 2020 2020  /__MACOS".      
+000094d0: 2020 6966 2072 652e 7365 6172 6368 2870    if re.search(p
+000094e0: 746e 2c20 7670 293a 0a20 2020 2020 2020  tn, vp):.       
+000094f0: 2020 2020 207a 7420 3d20 273c 3f78 6d6c       zt = '<?xml
+00009500: 2076 6572 7369 6f6e 3d22 312e 3022 2065   version="1.0" e
+00009510: 6e63 6f64 696e 673d 2275 7466 2d38 223f  ncoding="utf-8"?
+00009520: 3e5c 6e3c 443a 6572 726f 7220 786d 6c6e  >\n<D:error xmln
+00009530: 733a 443d 2244 4156 3a22 3e3c 443a 6c6f  s:D="DAV:"><D:lo
+00009540: 636b 2d74 6f6b 656e 2d73 7562 6d69 7474  ck-token-submitt
+00009550: 6564 3e3c 443a 6872 6566 3e7b 7d3c 2f44  ed><D:href>{}</D
+00009560: 3a68 7265 663e 3c2f 443a 6c6f 636b 2d74  :href></D:lock-t
+00009570: 6f6b 656e 2d73 7562 6d69 7474 6564 3e3c  oken-submitted><
+00009580: 2f44 3a65 7272 6f72 3e27 0a20 2020 2020  /D:error>'.     
+00009590: 2020 2020 2020 207a 6220 3d20 7a74 2e66         zb = zt.f
+000095a0: 6f72 6d61 7428 7670 292e 656e 636f 6465  ormat(vp).encode
+000095b0: 2822 7574 662d 3822 2c20 2272 6570 6c61  ("utf-8", "repla
+000095c0: 6365 2229 0a20 2020 2020 2020 2020 2020  ce").           
+000095d0: 2073 656c 662e 7265 706c 7928 7a62 2c20   self.reply(zb, 
+000095e0: 3432 332c 2022 7465 7874 2f78 6d6c 3b20  423, "text/xml; 
+000095f0: 6368 6172 7365 743d 7574 662d 3822 290a  charset=utf-8").
+00009600: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+00009610: 726e 2054 7275 650a 0a20 2020 2020 2020  rn True..       
+00009620: 2072 6574 7572 6e20 4661 6c73 650a 0a20   return False.. 
+00009630: 2020 2064 6566 2073 656e 645f 6368 756e     def send_chun
+00009640: 6b28 7365 6c66 2c20 7478 7420 2c20 656e  k(self, txt , en
+00009650: 6320 2c20 626d 6178 2029 2020 3a0a 2020  c , bmax )  :.  
+00009660: 2020 2020 2020 6f72 6967 5f6c 656e 203d        orig_len =
+00009670: 206c 656e 2874 7874 290a 2020 2020 2020   len(txt).      
+00009680: 2020 6275 6620 3d20 7478 745b 3a62 6d61    buf = txt[:bma
+00009690: 785d 2e65 6e63 6f64 6528 656e 632c 2022  x].encode(enc, "
+000096a0: 7265 706c 6163 6522 295b 3a62 6d61 785d  replace")[:bmax]
+000096b0: 0a20 2020 2020 2020 2074 7279 3a0a 2020  .        try:.  
+000096c0: 2020 2020 2020 2020 2020 5f20 3d20 6275            _ = bu
+000096d0: 662e 6465 636f 6465 2865 6e63 290a 2020  f.decode(enc).  
+000096e0: 2020 2020 2020 6578 6365 7074 2055 6e69        except Uni
+000096f0: 636f 6465 4465 636f 6465 4572 726f 7220  codeDecodeError 
+00009700: 6173 2075 6465 3a0a 2020 2020 2020 2020  as ude:.        
+00009710: 2020 2020 6275 6620 3d20 6275 665b 3a20      buf = buf[: 
+00009720: 7564 652e 7374 6172 745d 0a0a 2020 2020  ude.start]..    
+00009730: 2020 2020 7478 7420 3d20 7478 745b 6c65      txt = txt[le
+00009740: 6e28 6275 662e 6465 636f 6465 2865 6e63  n(buf.decode(enc
+00009750: 2929 203a 5d0a 2020 2020 2020 2020 6966  )) :].        if
+00009760: 2074 7874 2061 6e64 206c 656e 2874 7874   txt and len(txt
+00009770: 2920 3d3d 206f 7269 675f 6c65 6e3a 0a20  ) == orig_len:. 
+00009780: 2020 2020 2020 2020 2020 2072 6169 7365             raise
+00009790: 2050 6562 6b61 6328 3530 302c 2022 6368   Pebkac(500, "ch
+000097a0: 756e 6b20 736c 6963 696e 6720 6661 696c  unk slicing fail
+000097b0: 6564 2229 0a0a 2020 2020 2020 2020 6275  ed")..        bu
+000097c0: 6620 3d20 227b 3a78 7d5c 725c 6e22 2e66  f = "{:x}\r\n".f
+000097d0: 6f72 6d61 7428 6c65 6e28 6275 6629 292e  ormat(len(buf)).
+000097e0: 656e 636f 6465 2865 6e63 2920 2b20 6275  encode(enc) + bu
+000097f0: 660a 2020 2020 2020 2020 7365 6c66 2e73  f.        self.s
+00009800: 2e73 656e 6461 6c6c 2862 7566 202b 2062  .sendall(buf + b
+00009810: 225c 725c 6e22 290a 2020 2020 2020 2020  "\r\n").        
+00009820: 7265 7475 726e 2074 7874 0a0a 2020 2020  return txt..    
+00009830: 6465 6620 6861 6e64 6c65 5f6f 7074 696f  def handle_optio
+00009840: 6e73 2873 656c 6629 2020 3a0a 2020 2020  ns(self)  :.    
+00009850: 2020 2020 6966 2073 656c 662e 646f 5f6c      if self.do_l
+00009860: 6f67 3a0a 2020 2020 2020 2020 2020 2020  og:.            
+00009870: 7365 6c66 2e6c 6f67 2822 4f50 5449 4f4e  self.log("OPTION
+00009880: 5320 2573 2040 2573 2220 2520 2873 656c  S %s @%s" % (sel
+00009890: 662e 7265 712c 2073 656c 662e 756e 616d  f.req, self.unam
+000098a0: 6529 290a 0a20 2020 2020 2020 206f 6820  e))..        oh 
+000098b0: 3d20 7365 6c66 2e6f 7574 5f68 6561 6465  = self.out_heade
+000098c0: 7273 0a20 2020 2020 2020 206f 685b 2241  rs.        oh["A
+000098d0: 6c6c 6f77 225d 203d 2022 2c20 222e 6a6f  llow"] = ", ".jo
+000098e0: 696e 2873 656c 662e 636f 6e6e 2e68 7372  in(self.conn.hsr
+000098f0: 762e 6d61 6c6c 6f77 290a 0a20 2020 2020  v.mallow)..     
+00009900: 2020 2069 6620 6e6f 7420 7365 6c66 2e61     if not self.a
+00009910: 7267 732e 6e6f 5f64 6176 3a0a 2020 2020  rgs.no_dav:.    
+00009920: 2020 2020 2020 2020 2320 5052 4f50 5041          # PROPPA
+00009930: 5443 482c 204c 4f43 4b2c 2055 4e4c 4f43  TCH, LOCK, UNLOC
+00009940: 4b2c 2043 4f50 593a 206e 6f6f 7020 2873  K, COPY: noop (s
+00009950: 7065 632d 6d75 7374 290a 2020 2020 2020  pec-must).      
+00009960: 2020 2020 2020 6f68 5b22 4461 7622 5d20        oh["Dav"] 
+00009970: 3d20 2231 2c20 3222 0a20 2020 2020 2020  = "1, 2".       
+00009980: 2020 2020 206f 685b 224d 732d 4175 7468       oh["Ms-Auth
+00009990: 6f72 2d56 6961 225d 203d 2022 4441 5622  or-Via"] = "DAV"
+000099a0: 0a0a 2020 2020 2020 2020 2320 7769 6e78  ..        # winx
+000099b0: 702d 7765 6264 6176 2064 6f65 736e 7420  p-webdav doesnt 
+000099c0: 6b6e 6f77 2077 6861 7420 3230 3420 6973  know what 204 is
+000099d0: 0a20 2020 2020 2020 2073 656c 662e 7365  .        self.se
+000099e0: 6e64 5f68 6561 6465 7273 2830 2c20 3230  nd_headers(0, 20
+000099f0: 3029 0a20 2020 2020 2020 2072 6574 7572  0).        retur
+00009a00: 6e20 5472 7565 0a0a 2020 2020 6465 6620  n True..    def 
+00009a10: 6861 6e64 6c65 5f64 656c 6574 6528 7365  handle_delete(se
+00009a20: 6c66 2920 203a 0a20 2020 2020 2020 2073  lf)  :.        s
+00009a30: 656c 662e 6c6f 6728 2244 454c 4554 4520  elf.log("DELETE 
+00009a40: 2573 2040 2573 2220 2520 2873 656c 662e  %s @%s" % (self.
+00009a50: 7265 712c 2073 656c 662e 756e 616d 6529  req, self.uname)
+00009a60: 290a 2020 2020 2020 2020 7265 7475 726e  ).        return
+00009a70: 2073 656c 662e 6861 6e64 6c65 5f72 6d28   self.handle_rm(
+00009a80: 5b5d 290a 0a20 2020 2064 6566 2068 616e  [])..    def han
+00009a90: 646c 655f 7075 7428 7365 6c66 2920 203a  dle_put(self)  :
+00009aa0: 0a20 2020 2020 2020 2073 656c 662e 6c6f  .        self.lo
+00009ab0: 6728 2250 5554 2025 7320 4025 7322 2025  g("PUT %s @%s" %
+00009ac0: 2028 7365 6c66 2e72 6571 2c20 7365 6c66   (self.req, self
+00009ad0: 2e75 6e61 6d65 2929 0a0a 2020 2020 2020  .uname))..      
+00009ae0: 2020 6966 206e 6f74 2073 656c 662e 6361    if not self.ca
+00009af0: 6e5f 7772 6974 653a 0a20 2020 2020 2020  n_write:.       
+00009b00: 2020 2020 2074 203d 2022 7573 6572 207b       t = "user {
+00009b10: 7d20 646f 6573 206e 6f74 2068 6176 6520  } does not have 
+00009b20: 7772 6974 652d 6163 6365 7373 2068 6572  write-access her
+00009b30: 6522 0a20 2020 2020 2020 2020 2020 2072  e".            r
+00009b40: 6169 7365 2050 6562 6b61 6328 3430 332c  aise Pebkac(403,
+00009b50: 2074 2e66 6f72 6d61 7428 7365 6c66 2e75   t.format(self.u
+00009b60: 6e61 6d65 2929 0a0a 2020 2020 2020 2020  name))..        
+00009b70: 6966 206e 6f74 2073 656c 662e 6172 6773  if not self.args
+00009b80: 2e6e 6f5f 6461 7620 616e 6420 7365 6c66  .no_dav and self
+00009b90: 2e5f 6170 706c 6573 616e 2829 3a0a 2020  ._applesan():.  
+00009ba0: 2020 2020 2020 2020 2020 7265 7475 726e            return
+00009bb0: 2073 656c 662e 6865 6164 6572 732e 6765   self.headers.ge
+00009bc0: 7428 2263 6f6e 7465 6e74 2d6c 656e 6774  t("content-lengt
+00009bd0: 6822 2920 3d3d 2022 3022 0a0a 2020 2020  h") == "0"..    
+00009be0: 2020 2020 6966 2073 656c 662e 6865 6164      if self.head
+00009bf0: 6572 732e 6765 7428 2265 7870 6563 7422  ers.get("expect"
+00009c00: 2c20 2222 292e 6c6f 7765 7228 2920 3d3d  , "").lower() ==
+00009c10: 2022 3130 302d 636f 6e74 696e 7565 223a   "100-continue":
+00009c20: 0a20 2020 2020 2020 2020 2020 2074 7279  .            try
+00009c30: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00009c40: 2020 7365 6c66 2e73 2e73 656e 6461 6c6c    self.s.sendall
+00009c50: 2862 2248 5454 502f 312e 3120 3130 3020  (b"HTTP/1.1 100 
+00009c60: 436f 6e74 696e 7565 5c72 5c6e 5c72 5c6e  Continue\r\n\r\n
+00009c70: 2229 0a20 2020 2020 2020 2020 2020 2065  ").            e
+00009c80: 7863 6570 743a 0a20 2020 2020 2020 2020  xcept:.         
+00009c90: 2020 2020 2020 2072 6169 7365 2050 6562         raise Peb
+00009ca0: 6b61 6328 3430 302c 2022 636c 6965 6e74  kac(400, "client
+00009cb0: 2064 2f63 2062 6566 6f72 6520 3130 3020   d/c before 100 
+00009cc0: 636f 6e74 696e 7565 2229 0a0a 2020 2020  continue")..    
+00009cd0: 2020 2020 7265 7475 726e 2073 656c 662e      return self.
+00009ce0: 6861 6e64 6c65 5f73 7461 7368 2854 7275  handle_stash(Tru
+00009cf0: 6529 0a0a 2020 2020 6465 6620 6861 6e64  e)..    def hand
+00009d00: 6c65 5f70 6f73 7428 7365 6c66 2920 203a  le_post(self)  :
+00009d10: 0a20 2020 2020 2020 2073 656c 662e 6c6f  .        self.lo
+00009d20: 6728 2250 4f53 5420 2573 2040 2573 2220  g("POST %s @%s" 
+00009d30: 2520 2873 656c 662e 7265 712c 2073 656c  % (self.req, sel
+00009d40: 662e 756e 616d 6529 290a 0a20 2020 2020  f.uname))..     
+00009d50: 2020 2069 6620 7365 6c66 2e68 6561 6465     if self.heade
+00009d60: 7273 2e67 6574 2822 6578 7065 6374 222c  rs.get("expect",
+00009d70: 2022 2229 2e6c 6f77 6572 2829 203d 3d20   "").lower() == 
+00009d80: 2231 3030 2d63 6f6e 7469 6e75 6522 3a0a  "100-continue":.
+00009d90: 2020 2020 2020 2020 2020 2020 7472 793a              try:
+00009da0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00009db0: 2073 656c 662e 732e 7365 6e64 616c 6c28   self.s.sendall(
+00009dc0: 6222 4854 5450 2f31 2e31 2031 3030 2043  b"HTTP/1.1 100 C
+00009dd0: 6f6e 7469 6e75 655c 725c 6e5c 725c 6e22  ontinue\r\n\r\n"
+00009de0: 290a 2020 2020 2020 2020 2020 2020 6578  ).            ex
+00009df0: 6365 7074 3a0a 2020 2020 2020 2020 2020  cept:.          
+00009e00: 2020 2020 2020 7261 6973 6520 5065 626b        raise Pebk
+00009e10: 6163 2834 3030 2c20 2263 6c69 656e 7420  ac(400, "client 
+00009e20: 642f 6320 6265 666f 7265 2031 3030 2063  d/c before 100 c
+00009e30: 6f6e 7469 6e75 6522 290a 0a20 2020 2020  ontinue")..     
+00009e40: 2020 2069 6620 2272 6177 2220 696e 2073     if "raw" in s
+00009e50: 656c 662e 7570 6172 616d 3a0a 2020 2020  elf.uparam:.    
+00009e60: 2020 2020 2020 2020 7265 7475 726e 2073          return s
+00009e70: 656c 662e 6861 6e64 6c65 5f73 7461 7368  elf.handle_stash
+00009e80: 2846 616c 7365 290a 0a20 2020 2020 2020  (False)..       
+00009e90: 2063 7479 7065 203d 2073 656c 662e 6865   ctype = self.he
+00009ea0: 6164 6572 732e 6765 7428 2263 6f6e 7465  aders.get("conte
+00009eb0: 6e74 2d74 7970 6522 2c20 2222 292e 6c6f  nt-type", "").lo
+00009ec0: 7765 7228 290a 0a20 2020 2020 2020 2069  wer()..        i
+00009ed0: 6620 226d 756c 7469 7061 7274 2f66 6f72  f "multipart/for
+00009ee0: 6d2d 6461 7461 2220 696e 2063 7479 7065  m-data" in ctype
+00009ef0: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
+00009f00: 7475 726e 2073 656c 662e 6861 6e64 6c65  turn self.handle
+00009f10: 5f70 6f73 745f 6d75 6c74 6970 6172 7428  _post_multipart(
+00009f20: 290a 0a20 2020 2020 2020 2069 6620 280a  )..        if (.
+00009f30: 2020 2020 2020 2020 2020 2020 2261 7070              "app
+00009f40: 6c69 6361 7469 6f6e 2f6a 736f 6e22 2069  lication/json" i
+00009f50: 6e20 6374 7970 650a 2020 2020 2020 2020  n ctype.        
+00009f60: 2020 2020 6f72 2022 7465 7874 2f70 6c61      or "text/pla
+00009f70: 696e 2220 696e 2063 7479 7065 0a20 2020  in" in ctype.   
+00009f80: 2020 2020 2020 2020 206f 7220 2261 7070           or "app
+00009f90: 6c69 6361 7469 6f6e 2f78 6d6c 2220 696e  lication/xml" in
+00009fa0: 2063 7479 7065 0a20 2020 2020 2020 2029   ctype.        )
+00009fb0: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
+00009fc0: 7475 726e 2073 656c 662e 6861 6e64 6c65  turn self.handle
+00009fd0: 5f70 6f73 745f 6a73 6f6e 2829 0a0a 2020  _post_json()..  
+00009fe0: 2020 2020 2020 6966 2022 6d6f 7665 2220        if "move" 
+00009ff0: 696e 2073 656c 662e 7570 6172 616d 3a0a  in self.uparam:.
+0000a000: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+0000a010: 726e 2073 656c 662e 6861 6e64 6c65 5f6d  rn self.handle_m
+0000a020: 7628 290a 0a20 2020 2020 2020 2069 6620  v()..        if 
+0000a030: 2264 656c 6574 6522 2069 6e20 7365 6c66  "delete" in self
+0000a040: 2e75 7061 7261 6d3a 0a20 2020 2020 2020  .uparam:.       
+0000a050: 2020 2020 2072 6574 7572 6e20 7365 6c66       return self
+0000a060: 2e68 616e 646c 655f 726d 285b 5d29 0a0a  .handle_rm([])..
+0000a070: 2020 2020 2020 2020 6966 2022 6170 706c          if "appl
+0000a080: 6963 6174 696f 6e2f 6f63 7465 742d 7374  ication/octet-st
+0000a090: 7265 616d 2220 696e 2063 7479 7065 3a0a  ream" in ctype:.
+0000a0a0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+0000a0b0: 726e 2073 656c 662e 6861 6e64 6c65 5f70  rn self.handle_p
+0000a0c0: 6f73 745f 6269 6e61 7279 2829 0a0a 2020  ost_binary()..  
+0000a0d0: 2020 2020 2020 6966 2022 6170 706c 6963        if "applic
+0000a0e0: 6174 696f 6e2f 782d 7777 772d 666f 726d  ation/x-www-form
+0000a0f0: 2d75 726c 656e 636f 6465 6422 2069 6e20  -urlencoded" in 
+0000a100: 6374 7970 653a 0a20 2020 2020 2020 2020  ctype:.         
+0000a110: 2020 206f 7074 203d 2073 656c 662e 6172     opt = self.ar
+0000a120: 6773 2e75 726c 666f 726d 0a20 2020 2020  gs.urlform.     
+0000a130: 2020 2020 2020 2069 6620 2273 7461 7368         if "stash
+0000a140: 2220 696e 206f 7074 3a0a 2020 2020 2020  " in opt:.      
+0000a150: 2020 2020 2020 2020 2020 7265 7475 726e            return
+0000a160: 2073 656c 662e 6861 6e64 6c65 5f73 7461   self.handle_sta
+0000a170: 7368 2846 616c 7365 290a 0a20 2020 2020  sh(False)..     
+0000a180: 2020 2020 2020 2069 6620 2273 6176 6522         if "save"
+0000a190: 2069 6e20 6f70 743a 0a20 2020 2020 2020   in opt:.       
+0000a1a0: 2020 2020 2020 2020 2070 6f73 745f 737a           post_sz
+0000a1b0: 2c20 5f2c 205f 2c20 5f2c 2070 6174 682c  , _, _, _, path,
+0000a1c0: 205f 203d 2073 656c 662e 6475 6d70 5f74   _ = self.dump_t
+0000a1d0: 6f5f 6669 6c65 2846 616c 7365 290a 2020  o_file(False).  
+0000a1e0: 2020 2020 2020 2020 2020 2020 2020 7365                se
+0000a1f0: 6c66 2e6c 6f67 2822 7572 6c66 6f72 6d3a  lf.log("urlform:
+0000a200: 207b 7d20 6279 7465 732c 207b 7d22 2e66   {} bytes, {}".f
+0000a210: 6f72 6d61 7428 706f 7374 5f73 7a2c 2070  ormat(post_sz, p
+0000a220: 6174 6829 290a 2020 2020 2020 2020 2020  ath)).          
+0000a230: 2020 656c 6966 2022 7072 696e 7422 2069    elif "print" i
+0000a240: 6e20 6f70 743a 0a20 2020 2020 2020 2020  n opt:.         
+0000a250: 2020 2020 2020 2072 6561 6465 722c 205f         reader, _
+0000a260: 203d 2073 656c 662e 6765 745f 626f 6479   = self.get_body
+0000a270: 5f72 6561 6465 7228 290a 2020 2020 2020  _reader().      
+0000a280: 2020 2020 2020 2020 2020 6275 6620 3d20            buf = 
+0000a290: 6222 220a 2020 2020 2020 2020 2020 2020  b"".            
+0000a2a0: 2020 2020 666f 7220 7262 7566 2069 6e20      for rbuf in 
+0000a2b0: 7265 6164 6572 3a0a 2020 2020 2020 2020  reader:.        
+0000a2c0: 2020 2020 2020 2020 2020 2020 6275 6620              buf 
+0000a2d0: 2b3d 2072 6275 660a 2020 2020 2020 2020  += rbuf.        
+0000a2e0: 2020 2020 2020 2020 2020 2020 6966 206e              if n
+0000a2f0: 6f74 2072 6275 6620 6f72 206c 656e 2862  ot rbuf or len(b
+0000a300: 7566 2920 3e3d 2033 3237 3638 3a0a 2020  uf) >= 32768:.  
+0000a310: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a320: 2020 2020 2020 6272 6561 6b0a 0a20 2020        break..   
+0000a330: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+0000a340: 6275 663a 0a20 2020 2020 2020 2020 2020  buf:.           
+0000a350: 2020 2020 2020 2020 206f 7269 6720 3d20           orig = 
+0000a360: 6275 662e 6465 636f 6465 2822 7574 662d  buf.decode("utf-
+0000a370: 3822 2c20 2272 6570 6c61 6365 2229 0a20  8", "replace"). 
+0000a380: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a390: 2020 2074 203d 2022 7572 6c66 6f72 6d5f     t = "urlform_
+0000a3a0: 7261 7720 7b7d 2040 207b 7d5c 6e20 207b  raw {} @ {}\n  {
+0000a3b0: 7d5c 6e22 0a20 2020 2020 2020 2020 2020  }\n".           
+0000a3c0: 2020 2020 2020 2020 2073 656c 662e 6c6f           self.lo
+0000a3d0: 6728 742e 666f 726d 6174 286c 656e 286f  g(t.format(len(o
+0000a3e0: 7269 6729 2c20 7365 6c66 2e76 7061 7468  rig), self.vpath
+0000a3f0: 2c20 6f72 6967 2929 0a20 2020 2020 2020  , orig)).       
+0000a400: 2020 2020 2020 2020 2020 2020 2074 7279               try
+0000a410: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0000a420: 2020 2020 2020 2020 2020 7a62 203d 2075            zb = u
+0000a430: 6e71 756f 7465 2862 7566 2e72 6570 6c61  nquote(buf.repla
+0000a440: 6365 2862 222b 222c 2062 2220 2229 290a  ce(b"+", b" ")).
+0000a450: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a460: 2020 2020 2020 2020 706c 6169 6e20 3d20          plain = 
+0000a470: 7a62 2e64 6563 6f64 6528 2275 7466 2d38  zb.decode("utf-8
+0000a480: 222c 2022 7265 706c 6163 6522 290a 2020  ", "replace").  
+0000a490: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a4a0: 2020 2020 2020 6966 2062 7566 2e73 7461        if buf.sta
+0000a4b0: 7274 7377 6974 6828 6222 6d73 673d 2229  rtswith(b"msg=")
+0000a4c0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0000a4d0: 2020 2020 2020 2020 2020 2020 2020 706c                pl
+0000a4e0: 6169 6e20 3d20 706c 6169 6e5b 343a 5d0a  ain = plain[4:].
 0000a4f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a500: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a510: 7275 6e68 6f6f 6b28 0a20 2020 2020 2020  runhook(.       
-0000a520: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a530: 2020 2020 2020 2020 2020 2020 2073 656c               sel
-0000a540: 662e 6c6f 672c 0a20 2020 2020 2020 2020  f.log,.         
-0000a550: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a560: 2020 2020 2020 2020 2020 2078 6d2c 0a20             xm,. 
+0000a500: 2020 2020 2020 2020 2020 2020 7666 732c              vfs,
+0000a510: 2072 656d 203d 2073 656c 662e 6173 7276   rem = self.asrv
+0000a520: 2e76 6673 2e67 6574 280a 2020 2020 2020  .vfs.get(.      
+0000a530: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a540: 2020 2020 2020 2020 2020 7365 6c66 2e76            self.v
+0000a550: 7061 7468 2c20 7365 6c66 2e75 6e61 6d65  path, self.uname
+0000a560: 2c20 4661 6c73 652c 2046 616c 7365 0a20  , False, False. 
 0000a570: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a580: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a590: 2020 2076 6673 2e63 616e 6f6e 6963 616c     vfs.canonical
-0000a5a0: 2872 656d 292c 0a20 2020 2020 2020 2020  (rem),.         
-0000a5b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a5c0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-0000a5d0: 7670 6174 682c 0a20 2020 2020 2020 2020  vpath,.         
-0000a5e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a5f0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-0000a600: 686f 7374 2c0a 2020 2020 2020 2020 2020  host,.          
+0000a580: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
+0000a590: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a5a0: 2020 2020 2020 2020 2078 6d20 3d20 7666           xm = vf
+0000a5b0: 732e 666c 6167 732e 6765 7428 2278 6d22  s.flags.get("xm"
+0000a5c0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0000a5d0: 2020 2020 2020 2020 2020 2020 2020 6966                if
+0000a5e0: 2078 6d3a 0a20 2020 2020 2020 2020 2020   xm:.           
+0000a5f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a600: 2020 2020 2072 756e 686f 6f6b 280a 2020       runhook(.  
 0000a610: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a620: 2020 2020 2020 2020 2020 7365 6c66 2e75            self.u
-0000a630: 6e61 6d65 2c0a 2020 2020 2020 2020 2020  name,.          
+0000a620: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a630: 2020 7365 6c66 2e6c 6f67 2c0a 2020 2020    self.log,.    
 0000a640: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a650: 2020 2020 2020 2020 2020 7469 6d65 2e74            time.t
-0000a660: 696d 6528 292c 0a20 2020 2020 2020 2020  ime(),.         
+0000a650: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a660: 786d 2c0a 2020 2020 2020 2020 2020 2020  xm,.            
 0000a670: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a680: 2020 2020 2020 2020 2020 206c 656e 2878             len(x
-0000a690: 6d29 2c0a 2020 2020 2020 2020 2020 2020  m),.            
+0000a680: 2020 2020 2020 2020 7666 732e 6361 6e6f          vfs.cano
+0000a690: 6e69 6361 6c28 7265 6d29 2c0a 2020 2020  nical(rem),.    
 0000a6a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a6b0: 2020 2020 2020 2020 7365 6c66 2e69 702c          self.ip,
-0000a6c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000a6b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a6c0: 7365 6c66 2e76 7061 7468 2c0a 2020 2020  self.vpath,.    
 0000a6d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a6e0: 2020 2020 2074 696d 652e 7469 6d65 2829       time.time()
-0000a6f0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0000a6e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a6f0: 7365 6c66 2e68 6f73 742c 0a20 2020 2020  self.host,.     
 0000a700: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a710: 2020 2020 2020 706c 6169 6e2c 0a20 2020        plain,.   
-0000a720: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a730: 2020 2020 2020 2020 2020 2020 2029 0a0a               )..
-0000a740: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a750: 2020 2020 2020 2020 7420 3d20 2275 726c          t = "url
-0000a760: 666f 726d 5f64 6563 207b 7d20 4020 7b7d  form_dec {} @ {}
-0000a770: 5c6e 2020 7b7d 5c6e 220a 2020 2020 2020  \n  {}\n".      
-0000a780: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a790: 2020 7365 6c66 2e6c 6f67 2874 2e66 6f72    self.log(t.for
-0000a7a0: 6d61 7428 6c65 6e28 706c 6169 6e29 2c20  mat(len(plain), 
-0000a7b0: 7365 6c66 2e76 7061 7468 2c20 706c 6169  self.vpath, plai
-0000a7c0: 6e29 290a 0a20 2020 2020 2020 2020 2020  n))..           
-0000a7d0: 2020 2020 2020 2020 2065 7863 6570 7420           except 
-0000a7e0: 4578 6365 7074 696f 6e20 6173 2065 783a  Exception as ex:
-0000a7f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000a800: 2020 2020 2020 2020 2073 656c 662e 6c6f           self.lo
-0000a810: 6728 7265 7072 2865 7829 290a 0a20 2020  g(repr(ex))..   
-0000a820: 2020 2020 2020 2020 2069 6620 2267 6574           if "get
-0000a830: 2220 696e 206f 7074 3a0a 2020 2020 2020  " in opt:.      
-0000a840: 2020 2020 2020 2020 2020 7265 7475 726e            return
-0000a850: 2073 656c 662e 6861 6e64 6c65 5f67 6574   self.handle_get
-0000a860: 2829 0a0a 2020 2020 2020 2020 2020 2020  ()..            
-0000a870: 7261 6973 6520 5065 626b 6163 2834 3035  raise Pebkac(405
-0000a880: 2c20 2250 4f53 5428 7b7d 2920 6973 2064  , "POST({}) is d
-0000a890: 6973 6162 6c65 6420 696e 2073 6572 7665  isabled in serve
-0000a8a0: 7220 636f 6e66 6967 222e 666f 726d 6174  r config".format
-0000a8b0: 2863 7479 7065 2929 0a0a 2020 2020 2020  (ctype))..      
-0000a8c0: 2020 7261 6973 6520 5065 626b 6163 2834    raise Pebkac(4
-0000a8d0: 3035 2c20 2264 6f6e 2774 206b 6e6f 7720  05, "don't know 
-0000a8e0: 686f 7720 746f 2068 616e 646c 6520 504f  how to handle PO
-0000a8f0: 5354 287b 7d29 222e 666f 726d 6174 2863  ST({})".format(c
-0000a900: 7479 7065 2929 0a0a 2020 2020 6465 6620  type))..    def 
-0000a910: 6765 745f 786d 6c5f 656e 6328 7365 6c66  get_xml_enc(self
-0000a920: 2c20 7478 7420 2920 203a 0a20 2020 2020  , txt )  :.     
-0000a930: 2020 206f 6673 203d 2074 7874 5b3a 3531     ofs = txt[:51
-0000a940: 325d 2e66 696e 6428 2720 656e 636f 6469  2].find(' encodi
-0000a950: 6e67 3d22 2729 0a20 2020 2020 2020 2065  ng="').        e
-0000a960: 6e63 203d 2022 220a 2020 2020 2020 2020  nc = "".        
-0000a970: 6966 206f 6673 202b 2031 3a0a 2020 2020  if ofs + 1:.    
-0000a980: 2020 2020 2020 2020 656e 6320 3d20 7478          enc = tx
-0000a990: 745b 6f66 7320 2b20 3620 3a5d 2e73 706c  t[ofs + 6 :].spl
-0000a9a0: 6974 2827 2227 295b 315d 0a20 2020 2020  it('"')[1].     
-0000a9b0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-0000a9c0: 2020 2020 2065 6e63 203d 2073 656c 662e       enc = self.
-0000a9d0: 6865 6164 6572 732e 6765 7428 2263 6f6e  headers.get("con
-0000a9e0: 7465 6e74 2d74 7970 6522 2c20 2222 292e  tent-type", "").
-0000a9f0: 6c6f 7765 7228 290a 2020 2020 2020 2020  lower().        
-0000aa00: 2020 2020 6f66 7320 3d20 656e 632e 6669      ofs = enc.fi
-0000aa10: 6e64 2822 6368 6172 7365 743d 2229 0a20  nd("charset="). 
-0000aa20: 2020 2020 2020 2020 2020 2069 6620 6f66             if of
-0000aa30: 7320 2b20 313a 0a20 2020 2020 2020 2020  s + 1:.         
-0000aa40: 2020 2020 2020 2065 6e63 203d 2065 6e63         enc = enc
-0000aa50: 5b6f 6673 202b 2034 5d2e 7370 6c69 7428  [ofs + 4].split(
-0000aa60: 223d 2229 5b31 5d2e 7370 6c69 7428 223b  "=")[1].split(";
-0000aa70: 2229 5b30 5d2e 7374 7269 7028 225c 2227  ")[0].strip("\"'
-0000aa80: 2229 0a20 2020 2020 2020 2020 2020 2065  ").            e
-0000aa90: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-0000aaa0: 2020 2020 2065 6e63 203d 2022 220a 0a20       enc = "".. 
-0000aab0: 2020 2020 2020 2072 6574 7572 6e20 656e         return en
-0000aac0: 6320 6f72 2022 7574 662d 3822 0a0a 2020  c or "utf-8"..  
-0000aad0: 2020 6465 6620 6765 745f 626f 6479 5f72    def get_body_r
-0000aae0: 6561 6465 7228 7365 6c66 2920 2020 2020  eader(self)     
-0000aaf0: 3a0a 2020 2020 2020 2020 6966 2022 6368  :.        if "ch
-0000ab00: 756e 6b65 6422 2069 6e20 7365 6c66 2e68  unked" in self.h
-0000ab10: 6561 6465 7273 2e67 6574 2822 7472 616e  eaders.get("tran
-0000ab20: 7366 6572 2d65 6e63 6f64 696e 6722 2c20  sfer-encoding", 
-0000ab30: 2222 292e 6c6f 7765 7228 293a 0a20 2020  "").lower():.   
-0000ab40: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-0000ab50: 7265 6164 5f73 6f63 6b65 745f 6368 756e  read_socket_chun
-0000ab60: 6b65 6428 7365 6c66 2e73 7229 2c20 2d31  ked(self.sr), -1
-0000ab70: 0a0a 2020 2020 2020 2020 7265 6d61 696e  ..        remain
-0000ab80: 7320 3d20 696e 7428 7365 6c66 2e68 6561  s = int(self.hea
-0000ab90: 6465 7273 2e67 6574 2822 636f 6e74 656e  ders.get("conten
-0000aba0: 742d 6c65 6e67 7468 222c 202d 3129 290a  t-length", -1)).
-0000abb0: 2020 2020 2020 2020 6966 2072 656d 6169          if remai
-0000abc0: 6e73 203d 3d20 2d31 3a0a 2020 2020 2020  ns == -1:.      
-0000abd0: 2020 2020 2020 7365 6c66 2e6b 6565 7061        self.keepa
-0000abe0: 6c69 7665 203d 2046 616c 7365 0a20 2020  live = False.   
-0000abf0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-0000ac00: 7265 6164 5f73 6f63 6b65 745f 756e 626f  read_socket_unbo
-0000ac10: 756e 6465 6428 7365 6c66 2e73 7229 2c20  unded(self.sr), 
-0000ac20: 7265 6d61 696e 730a 2020 2020 2020 2020  remains.        
-0000ac30: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-0000ac40: 2020 7265 7475 726e 2072 6561 645f 736f    return read_so
-0000ac50: 636b 6574 2873 656c 662e 7372 2c20 7265  cket(self.sr, re
-0000ac60: 6d61 696e 7329 2c20 7265 6d61 696e 730a  mains), remains.
-0000ac70: 0a20 2020 2064 6566 2064 756d 705f 746f  .    def dump_to
-0000ac80: 5f66 696c 6528 7365 6c66 2c20 6973 5f70  _file(self, is_p
-0000ac90: 7574 2029 2020 2020 2020 203a 0a20 2020  ut )       :.   
-0000aca0: 2020 2020 2023 2070 6f73 745f 737a 2c20       # post_sz, 
-0000acb0: 7368 615f 6865 782c 2073 6861 5f62 3634  sha_hex, sha_b64
-0000acc0: 2c20 7265 6d61 696e 732c 2070 6174 682c  , remains, path,
-0000acd0: 2075 726c 0a20 2020 2020 2020 2072 6561   url.        rea
-0000ace0: 6465 722c 2072 656d 6169 6e73 203d 2073  der, remains = s
-0000acf0: 656c 662e 6765 745f 626f 6479 5f72 6561  elf.get_body_rea
-0000ad00: 6465 7228 290a 2020 2020 2020 2020 7666  der().        vf
-0000ad10: 732c 2072 656d 203d 2073 656c 662e 6173  s, rem = self.as
-0000ad20: 7276 2e76 6673 2e67 6574 2873 656c 662e  rv.vfs.get(self.
-0000ad30: 7670 6174 682c 2073 656c 662e 756e 616d  vpath, self.unam
-0000ad40: 652c 2046 616c 7365 2c20 5472 7565 290a  e, False, True).
-0000ad50: 2020 2020 2020 2020 726e 642c 205f 2c20          rnd, _, 
-0000ad60: 6c69 6665 7469 6d65 2c20 7862 752c 2078  lifetime, xbu, x
-0000ad70: 6175 203d 2073 656c 662e 7570 6c6f 6164  au = self.upload
-0000ad80: 5f66 6c61 6773 2876 6673 290a 2020 2020  _flags(vfs).    
-0000ad90: 2020 2020 6c69 6d20 3d20 7666 732e 6765      lim = vfs.ge
-0000ada0: 745f 6462 7628 7265 6d29 5b30 5d2e 6c69  t_dbv(rem)[0].li
-0000adb0: 6d0a 2020 2020 2020 2020 6664 6972 203d  m.        fdir =
-0000adc0: 2076 6673 2e63 616e 6f6e 6963 616c 2872   vfs.canonical(r
-0000add0: 656d 290a 2020 2020 2020 2020 6966 206c  em).        if l
-0000ade0: 696d 3a0a 2020 2020 2020 2020 2020 2020  im:.            
-0000adf0: 6664 6972 2c20 7265 6d20 3d20 6c69 6d2e  fdir, rem = lim.
-0000ae00: 616c 6c28 7365 6c66 2e69 702c 2072 656d  all(self.ip, rem
-0000ae10: 2c20 7265 6d61 696e 732c 2066 6469 7229  , remains, fdir)
-0000ae20: 0a0a 2020 2020 2020 2020 666e 203d 204e  ..        fn = N
-0000ae30: 6f6e 650a 2020 2020 2020 2020 6966 2072  one.        if r
-0000ae40: 656d 2061 6e64 206e 6f74 2073 656c 662e  em and not self.
-0000ae50: 7472 6169 6c69 6e67 5f73 6c61 7368 2061  trailing_slash a
-0000ae60: 6e64 206e 6f74 2062 6f73 2e70 6174 682e  nd not bos.path.
-0000ae70: 6973 6469 7228 6664 6972 293a 0a20 2020  isdir(fdir):.   
-0000ae80: 2020 2020 2020 2020 2066 6469 722c 2066           fdir, f
-0000ae90: 6e20 3d20 6f73 2e70 6174 682e 7370 6c69  n = os.path.spli
-0000aea0: 7428 6664 6972 290a 2020 2020 2020 2020  t(fdir).        
-0000aeb0: 2020 2020 7265 6d2c 205f 203d 2076 7370      rem, _ = vsp
-0000aec0: 6c69 7428 7265 6d29 0a0a 2020 2020 2020  lit(rem)..      
-0000aed0: 2020 626f 732e 6d61 6b65 6469 7273 2866    bos.makedirs(f
-0000aee0: 6469 7229 0a0a 2020 2020 2020 2020 6f70  dir)..        op
-0000aef0: 656e 5f6b 6120 2020 3d20 7b22 6675 6e22  en_ka   = {"fun"
-0000af00: 3a20 6f70 656e 7d0a 2020 2020 2020 2020  : open}.        
-0000af10: 6f70 656e 5f61 203d 205b 2277 6222 2c20  open_a = ["wb", 
-0000af20: 3531 3220 2a20 3130 3234 5d0a 0a20 2020  512 * 1024]..   
-0000af30: 2020 2020 2023 2075 7365 722d 7265 7175       # user-requ
-0000af40: 6573 7420 7c7c 2063 6f6e 6669 672d 666f  est || config-fo
-0000af50: 7263 650a 2020 2020 2020 2020 6966 2028  rce.        if (
-0000af60: 2267 7a22 2069 6e20 7666 732e 666c 6167  "gz" in vfs.flag
-0000af70: 7320 6f72 2022 787a 2220 696e 2076 6673  s or "xz" in vfs
-0000af80: 2e66 6c61 6773 2920 616e 6420 280a 2020  .flags) and (.  
-0000af90: 2020 2020 2020 2020 2020 2270 6b22 2069            "pk" i
-0000afa0: 6e20 7666 732e 666c 6167 730a 2020 2020  n vfs.flags.    
-0000afb0: 2020 2020 2020 2020 6f72 2022 706b 2220          or "pk" 
-0000afc0: 696e 2073 656c 662e 7570 6172 616d 0a20  in self.uparam. 
-0000afd0: 2020 2020 2020 2020 2020 206f 7220 2267             or "g
-0000afe0: 7a22 2069 6e20 7365 6c66 2e75 7061 7261  z" in self.upara
-0000aff0: 6d0a 2020 2020 2020 2020 2020 2020 6f72  m.            or
-0000b000: 2022 787a 2220 696e 2073 656c 662e 7570   "xz" in self.up
-0000b010: 6172 616d 0a20 2020 2020 2020 2029 3a0a  aram.        ):.
-0000b020: 2020 2020 2020 2020 2020 2020 6662 203d              fb =
-0000b030: 207b 2267 7a22 3a20 392c 2022 787a 223a   {"gz": 9, "xz":
-0000b040: 2030 7d20 2023 2064 6566 6175 6c74 2f66   0}  # default/f
-0000b050: 616c 6c62 6163 6b20 6c65 7665 6c0a 2020  allback level.  
-0000b060: 2020 2020 2020 2020 2020 6c76 203d 207b            lv = {
-0000b070: 7d20 2023 2073 656c 6563 7465 6420 6c65  }  # selected le
-0000b080: 7665 6c0a 2020 2020 2020 2020 2020 2020  vel.            
-0000b090: 616c 6720 3d20 2222 2020 2320 7365 6c65  alg = ""  # sele
-0000b0a0: 6374 6564 2061 6c67 6f20 2867 7a3d 7072  cted algo (gz=pr
-0000b0b0: 6566 6572 7265 6429 0a0a 2020 2020 2020  eferred)..      
-0000b0c0: 2020 2020 2020 2320 7573 6572 2d70 7265        # user-pre
-0000b0d0: 6673 2066 6972 7374 0a20 2020 2020 2020  fs first.       
-0000b0e0: 2020 2020 2069 6620 2267 7a22 2069 6e20       if "gz" in 
-0000b0f0: 7365 6c66 2e75 7061 7261 6d20 6f72 2022  self.uparam or "
-0000b100: 706b 2220 696e 2073 656c 662e 7570 6172  pk" in self.upar
-0000b110: 616d 3a20 2023 2064 6566 2e70 6b0a 2020  am:  # def.pk.  
-0000b120: 2020 2020 2020 2020 2020 2020 2020 616c                al
-0000b130: 6720 3d20 2267 7a22 0a20 2020 2020 2020  g = "gz".       
-0000b140: 2020 2020 2069 6620 2278 7a22 2069 6e20       if "xz" in 
-0000b150: 7365 6c66 2e75 7061 7261 6d3a 0a20 2020  self.uparam:.   
-0000b160: 2020 2020 2020 2020 2020 2020 2061 6c67               alg
-0000b170: 203d 2022 787a 220a 2020 2020 2020 2020   = "xz".        
-0000b180: 2020 2020 6966 2061 6c67 3a0a 2020 2020      if alg:.    
-0000b190: 2020 2020 2020 2020 2020 2020 7a73 6f20              zso 
-0000b1a0: 3d20 7365 6c66 2e75 7061 7261 6d2e 6765  = self.uparam.ge
-0000b1b0: 7428 616c 6729 0a20 2020 2020 2020 2020  t(alg).         
-0000b1c0: 2020 2020 2020 206c 765b 616c 675d 203d         lv[alg] =
-0000b1d0: 2066 625b 616c 675d 2069 6620 7a73 6f20   fb[alg] if zso 
-0000b1e0: 6973 204e 6f6e 6520 656c 7365 2069 6e74  is None else int
-0000b1f0: 287a 736f 290a 0a20 2020 2020 2020 2020  (zso)..         
-0000b200: 2020 2069 6620 616c 6720 6e6f 7420 696e     if alg not in
-0000b210: 2076 6673 2e66 6c61 6773 3a0a 2020 2020   vfs.flags:.    
-0000b220: 2020 2020 2020 2020 2020 2020 616c 6720              alg 
-0000b230: 3d20 2267 7a22 2069 6620 2267 7a22 2069  = "gz" if "gz" i
-0000b240: 6e20 7666 732e 666c 6167 7320 656c 7365  n vfs.flags else
-0000b250: 2022 787a 220a 0a20 2020 2020 2020 2020   "xz"..         
-0000b260: 2020 2023 2074 6865 6e20 7365 7276 6572     # then server
-0000b270: 206f 7665 7272 6964 6573 0a20 2020 2020   overrides.     
-0000b280: 2020 2020 2020 2070 6b20 3d20 7666 732e         pk = vfs.
-0000b290: 666c 6167 732e 6765 7428 2270 6b22 290a  flags.get("pk").
-0000b2a0: 2020 2020 2020 2020 2020 2020 6966 2070              if p
-0000b2b0: 6b20 6973 206e 6f74 204e 6f6e 653a 0a20  k is not None:. 
-0000b2c0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-0000b2d0: 2063 6f6e 6669 672d 666f 7263 6564 206f   config-forced o
-0000b2e0: 6e0a 2020 2020 2020 2020 2020 2020 2020  n.              
-0000b2f0: 2020 616c 6720 3d20 616c 6720 6f72 2022    alg = alg or "
-0000b300: 677a 2220 2023 2064 6566 2e70 6b0a 2020  gz"  # def.pk.  
-0000b310: 2020 2020 2020 2020 2020 2020 2020 7472                tr
-0000b320: 793a 0a20 2020 2020 2020 2020 2020 2020  y:.             
-0000b330: 2020 2020 2020 2023 2063 6f6e 6669 672d         # config-
-0000b340: 666f 7263 6564 206f 7074 730a 2020 2020  forced opts.    
-0000b350: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b360: 616c 672c 206e 6c76 203d 2070 6b2e 7370  alg, nlv = pk.sp
-0000b370: 6c69 7428 222c 2229 0a20 2020 2020 2020  lit(",").       
-0000b380: 2020 2020 2020 2020 2020 2020 206c 765b               lv[
-0000b390: 616c 675d 203d 2069 6e74 286e 6c76 290a  alg] = int(nlv).
-0000b3a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b3b0: 6578 6365 7074 3a0a 2020 2020 2020 2020  except:.        
-0000b3c0: 2020 2020 2020 2020 2020 2020 7061 7373              pass
-0000b3d0: 0a0a 2020 2020 2020 2020 2020 2020 6c76  ..            lv
-0000b3e0: 5b61 6c67 5d20 3d20 6c76 2e67 6574 2861  [alg] = lv.get(a
-0000b3f0: 6c67 2920 6f72 2066 622e 6765 7428 616c  lg) or fb.get(al
-0000b400: 6729 206f 7220 300a 0a20 2020 2020 2020  g) or 0..       
-0000b410: 2020 2020 2073 656c 662e 6c6f 6728 2263       self.log("c
-0000b420: 6f6d 7072 6573 7369 6e67 2077 6974 6820  ompressing with 
-0000b430: 7b7d 206c 6576 656c 207b 7d22 2e66 6f72  {} level {}".for
-0000b440: 6d61 7428 616c 672c 206c 762e 6765 7428  mat(alg, lv.get(
-0000b450: 616c 6729 2929 0a20 2020 2020 2020 2020  alg))).         
-0000b460: 2020 2069 6620 616c 6720 3d3d 2022 677a     if alg == "gz
-0000b470: 223a 0a20 2020 2020 2020 2020 2020 2020  ":.             
-0000b480: 2020 206f 7065 6e5f 6b61 5b22 6675 6e22     open_ka["fun"
-0000b490: 5d20 3d20 677a 6970 2e47 7a69 7046 696c  ] = gzip.GzipFil
-0000b4a0: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
-0000b4b0: 2020 6f70 656e 5f61 203d 205b 2277 6222    open_a = ["wb"
-0000b4c0: 2c20 6c76 5b61 6c67 5d2c 204e 6f6e 652c  , lv[alg], None,
-0000b4d0: 2030 7835 4645 4536 3630 305d 2020 2320   0x5FEE6600]  # 
-0000b4e0: 3230 3231 2d30 312d 3031 0a20 2020 2020  2021-01-01.     
-0000b4f0: 2020 2020 2020 2065 6c69 6620 616c 6720         elif alg 
-0000b500: 3d3d 2022 787a 223a 0a20 2020 2020 2020  == "xz":.       
-0000b510: 2020 2020 2020 2020 206f 7065 6e5f 6b61           open_ka
-0000b520: 203d 207b 2266 756e 223a 206c 7a6d 612e   = {"fun": lzma.
-0000b530: 6f70 656e 2c20 2270 7265 7365 7422 3a20  open, "preset": 
-0000b540: 6c76 5b61 6c67 5d7d 0a20 2020 2020 2020  lv[alg]}.       
-0000b550: 2020 2020 2020 2020 206f 7065 6e5f 6120           open_a 
-0000b560: 3d20 5b22 7762 225d 0a20 2020 2020 2020  = ["wb"].       
-0000b570: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-0000b580: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-0000b590: 6c6f 6728 2266 616c 6c74 6872 6f75 6768  log("fallthrough
-0000b5a0: 3f20 7468 6174 7320 6120 6275 6722 2c20  ? thats a bug", 
-0000b5b0: 3129 0a0a 2020 2020 2020 2020 7375 6666  1)..        suff
-0000b5c0: 6978 203d 2022 2d7b 3a2e 3666 7d2d 7b7d  ix = "-{:.6f}-{}
-0000b5d0: 222e 666f 726d 6174 2874 696d 652e 7469  ".format(time.ti
-0000b5e0: 6d65 2829 2c20 7365 6c66 2e64 6970 2829  me(), self.dip()
-0000b5f0: 290a 2020 2020 2020 2020 6e61 6d65 6c65  ).        namele
-0000b600: 7373 203d 206e 6f74 2066 6e0a 2020 2020  ss = not fn.    
-0000b610: 2020 2020 6966 206e 616d 656c 6573 733a      if nameless:
-0000b620: 0a20 2020 2020 2020 2020 2020 2073 7566  .            suf
-0000b630: 6669 7820 2b3d 2022 2e62 696e 220a 2020  fix += ".bin".  
-0000b640: 2020 2020 2020 2020 2020 666e 203d 2022            fn = "
-0000b650: 7075 7422 202b 2073 7566 6669 780a 0a20  put" + suffix.. 
-0000b660: 2020 2020 2020 2070 6172 616d 7320 3d20         params = 
-0000b670: 7b22 7375 6666 6978 223a 2073 7566 6669  {"suffix": suffi
-0000b680: 782c 2022 6664 6972 223a 2066 6469 727d  x, "fdir": fdir}
-0000b690: 0a20 2020 2020 2020 2069 6620 7365 6c66  .        if self
-0000b6a0: 2e61 7267 732e 6e77 3a0a 2020 2020 2020  .args.nw:.      
-0000b6b0: 2020 2020 2020 7061 7261 6d73 203d 207b        params = {
-0000b6c0: 7d0a 2020 2020 2020 2020 2020 2020 666e  }.            fn
-0000b6d0: 203d 206f 732e 6465 766e 756c 6c0a 0a20   = os.devnull.. 
-0000b6e0: 2020 2020 2020 2070 6172 616d 732e 7570         params.up
-0000b6f0: 6461 7465 286f 7065 6e5f 6b61 290a 2020  date(open_ka).  
-0000b700: 2020 2020 2020 6173 7365 7274 2066 6e0a        assert fn.
-0000b710: 0a20 2020 2020 2020 2069 6620 6e6f 7420  .        if not 
-0000b720: 7365 6c66 2e61 7267 732e 6e77 3a0a 2020  self.args.nw:.  
-0000b730: 2020 2020 2020 2020 2020 6966 2072 6e64            if rnd
-0000b740: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0000b750: 2020 666e 203d 2072 616e 645f 6e61 6d65    fn = rand_name
-0000b760: 2866 6469 722c 2066 6e2c 2072 6e64 290a  (fdir, fn, rnd).
-0000b770: 0a20 2020 2020 2020 2020 2020 2066 6e20  .            fn 
-0000b780: 3d20 7361 6e69 7469 7a65 5f66 6e28 666e  = sanitize_fn(fn
-0000b790: 206f 7220 2222 2c20 2222 2c20 5b22 2e70   or "", "", [".p
-0000b7a0: 726f 6c6f 6775 652e 6874 6d6c 222c 2022  rologue.html", "
-0000b7b0: 2e65 7069 6c6f 6775 652e 6874 6d6c 225d  .epilogue.html"]
-0000b7c0: 290a 0a20 2020 2020 2020 2070 6174 6820  )..        path 
-0000b7d0: 3d20 6f73 2e70 6174 682e 6a6f 696e 2866  = os.path.join(f
-0000b7e0: 6469 722c 2066 6e29 0a0a 2020 2020 2020  dir, fn)..      
-0000b7f0: 2020 6966 2078 6275 3a0a 2020 2020 2020    if xbu:.      
-0000b800: 2020 2020 2020 6174 203d 2074 696d 652e        at = time.
-0000b810: 7469 6d65 2829 202d 206c 6966 6574 696d  time() - lifetim
-0000b820: 650a 2020 2020 2020 2020 2020 2020 6966  e.            if
-0000b830: 206e 6f74 2072 756e 686f 6f6b 280a 2020   not runhook(.  
-0000b840: 2020 2020 2020 2020 2020 2020 2020 7365                se
-0000b850: 6c66 2e6c 6f67 2c0a 2020 2020 2020 2020  lf.log,.        
-0000b860: 2020 2020 2020 2020 7862 752c 0a20 2020          xbu,.   
-0000b870: 2020 2020 2020 2020 2020 2020 2070 6174               pat
-0000b880: 682c 0a20 2020 2020 2020 2020 2020 2020  h,.             
-0000b890: 2020 2073 656c 662e 7670 6174 682c 0a20     self.vpath,. 
-0000b8a0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-0000b8b0: 656c 662e 686f 7374 2c0a 2020 2020 2020  elf.host,.      
-0000b8c0: 2020 2020 2020 2020 2020 7365 6c66 2e75            self.u
-0000b8d0: 6e61 6d65 2c0a 2020 2020 2020 2020 2020  name,.          
-0000b8e0: 2020 2020 2020 6174 2c0a 2020 2020 2020        at,.      
-0000b8f0: 2020 2020 2020 2020 2020 7265 6d61 696e            remain
-0000b900: 732c 0a20 2020 2020 2020 2020 2020 2020  s,.             
-0000b910: 2020 2073 656c 662e 6970 2c0a 2020 2020     self.ip,.    
-0000b920: 2020 2020 2020 2020 2020 2020 6174 2c0a              at,.
-0000b930: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b940: 2222 2c0a 2020 2020 2020 2020 2020 2020  "",.            
-0000b950: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-0000b960: 2020 2074 203d 2022 7570 6c6f 6164 2062     t = "upload b
-0000b970: 6c6f 636b 6564 2062 7920 7862 7520 7365  locked by xbu se
-0000b980: 7276 6572 2063 6f6e 6669 6722 0a20 2020  rver config".   
-0000b990: 2020 2020 2020 2020 2020 2020 2073 656c               sel
-0000b9a0: 662e 6c6f 6728 742c 2031 290a 2020 2020  f.log(t, 1).    
-0000b9b0: 2020 2020 2020 2020 2020 2020 7261 6973              rais
-0000b9c0: 6520 5065 626b 6163 2834 3033 2c20 7429  e Pebkac(403, t)
-0000b9d0: 0a0a 2020 2020 2020 2020 6966 2069 735f  ..        if is_
-0000b9e0: 7075 7420 616e 6420 6e6f 7420 2873 656c  put and not (sel
-0000b9f0: 662e 6172 6773 2e6e 6f5f 6461 7620 6f72  f.args.no_dav or
-0000ba00: 2073 656c 662e 6172 6773 2e6e 7729 2061   self.args.nw) a
-0000ba10: 6e64 2062 6f73 2e70 6174 682e 6578 6973  nd bos.path.exis
-0000ba20: 7473 2870 6174 6829 3a0a 2020 2020 2020  ts(path):.      
-0000ba30: 2020 2020 2020 2320 616c 6c6f 7720 6f76        # allow ov
-0000ba40: 6572 7772 6974 6520 6966 2e2e 2e0a 2020  erwrite if....  
-0000ba50: 2020 2020 2020 2020 2020 2320 202a 2076            #  * v
-0000ba60: 6f6c 666c 6167 2027 6461 7727 2069 7320  olflag 'daw' is 
-0000ba70: 7365 742c 206f 7220 636c 6965 6e74 2069  set, or client i
-0000ba80: 7320 6465 6669 6e69 7465 6c79 2077 6562  s definitely web
-0000ba90: 6461 760a 2020 2020 2020 2020 2020 2020  dav.            
-0000baa0: 2320 202a 2061 6e64 2061 6363 6f75 6e74  #  * and account
-0000bab0: 2068 6173 2064 656c 6574 652d 6163 6365   has delete-acce
-0000bac0: 7373 0a20 2020 2020 2020 2020 2020 2023  ss.            #
-0000bad0: 206f 722e 2e2e 0a20 2020 2020 2020 2020   or....         
-0000bae0: 2020 2023 2020 2a20 6669 6c65 2065 7869     #  * file exi
-0000baf0: 7374 732c 2069 7320 656d 7074 792c 2073  sts, is empty, s
-0000bb00: 7566 6669 6369 656e 746c 7920 6e65 770a  ufficiently new.
-0000bb10: 2020 2020 2020 2020 2020 2020 2320 202a              #  *
-0000bb20: 2061 6e64 2074 6865 7265 2069 7320 6e6f   and there is no
-0000bb30: 202e 5041 5254 4941 4c0a 0a20 2020 2020   .PARTIAL..     
-0000bb40: 2020 2020 2020 2074 6e61 6d20 3d20 666e         tnam = fn
-0000bb50: 202b 2022 2e50 4152 5449 414c 220a 2020   + ".PARTIAL".  
-0000bb60: 2020 2020 2020 2020 2020 6966 2073 656c            if sel
-0000bb70: 662e 6172 6773 2e64 6f74 7061 7274 3a0a  f.args.dotpart:.
-0000bb80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000bb90: 746e 616d 203d 2022 2e22 202b 2074 6e61  tnam = "." + tna
-0000bba0: 6d0a 0a20 2020 2020 2020 2020 2020 2069  m..            i
-0000bbb0: 6620 280a 2020 2020 2020 2020 2020 2020  f (.            
-0000bbc0: 2020 2020 7365 6c66 2e63 616e 5f64 656c      self.can_del
-0000bbd0: 6574 650a 2020 2020 2020 2020 2020 2020  ete.            
-0000bbe0: 2020 2020 616e 6420 2876 6673 2e66 6c61      and (vfs.fla
-0000bbf0: 6773 2e67 6574 2822 6461 7722 2920 6f72  gs.get("daw") or
-0000bc00: 2022 782d 6f63 2d6d 7469 6d65 2220 696e   "x-oc-mtime" in
-0000bc10: 2073 656c 662e 6865 6164 6572 7329 0a20   self.headers). 
-0000bc20: 2020 2020 2020 2020 2020 2029 206f 7220             ) or 
-0000bc30: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-0000bc40: 2020 6e6f 7420 626f 732e 7061 7468 2e65    not bos.path.e
-0000bc50: 7869 7374 7328 6f73 2e70 6174 682e 6a6f  xists(os.path.jo
-0000bc60: 696e 2866 6469 722c 2074 6e61 6d29 290a  in(fdir, tnam)).
-0000bc70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000bc80: 616e 6420 6e6f 7420 626f 732e 7061 7468  and not bos.path
-0000bc90: 2e67 6574 7369 7a65 2870 6174 6829 0a20  .getsize(path). 
-0000bca0: 2020 2020 2020 2020 2020 2020 2020 2061                 a
-0000bcb0: 6e64 2062 6f73 2e70 6174 682e 6765 746d  nd bos.path.getm
-0000bcc0: 7469 6d65 2870 6174 6829 203e 3d20 7469  time(path) >= ti
-0000bcd0: 6d65 2e74 696d 6528 2920 2d20 7365 6c66  me.time() - self
-0000bce0: 2e61 7267 732e 626c 616e 6b5f 7774 0a20  .args.blank_wt. 
-0000bcf0: 2020 2020 2020 2020 2020 2029 3a0a 2020             ):.  
-0000bd00: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-0000bd10: 736d 616c 6c20 746f 6374 6f75 2c20 6275  small toctou, bu
-0000bd20: 7420 6265 7474 6572 2074 6861 6e20 636c  t better than cl
-0000bd30: 6f62 6265 7269 6e67 2061 2068 6172 646c  obbering a hardl
-0000bd40: 696e 6b0a 2020 2020 2020 2020 2020 2020  ink.            
-0000bd50: 2020 2020 626f 732e 756e 6c69 6e6b 2870      bos.unlink(p
-0000bd60: 6174 6829 0a0a 2020 2020 2020 2020 7769  ath)..        wi
-0000bd70: 7468 2072 656e 5f6f 7065 6e28 666e 2c20  th ren_open(fn, 
-0000bd80: 2a6f 7065 6e5f 612c 202a 2a70 6172 616d  *open_a, **param
-0000bd90: 7329 2061 7320 7a66 773a 0a20 2020 2020  s) as zfw:.     
-0000bda0: 2020 2020 2020 2066 2c20 666e 203d 207a         f, fn = z
-0000bdb0: 6677 5b22 6f72 7a22 5d0a 2020 2020 2020  fw["orz"].      
-0000bdc0: 2020 2020 2020 7061 7468 203d 206f 732e        path = os.
-0000bdd0: 7061 7468 2e6a 6f69 6e28 6664 6972 2c20  path.join(fdir, 
-0000bde0: 666e 290a 2020 2020 2020 2020 2020 2020  fn).            
-0000bdf0: 706f 7374 5f73 7a2c 2073 6861 5f68 6578  post_sz, sha_hex
-0000be00: 2c20 7368 615f 6236 3420 3d20 6861 7368  , sha_b64 = hash
-0000be10: 636f 7079 2872 6561 6465 722c 2066 2c20  copy(reader, f, 
-0000be20: 7365 6c66 2e61 7267 732e 735f 7772 5f73  self.args.s_wr_s
-0000be30: 6c70 290a 0a20 2020 2020 2020 2069 6620  lp)..        if 
-0000be40: 6c69 6d3a 0a20 2020 2020 2020 2020 2020  lim:.           
-0000be50: 206c 696d 2e6e 7570 2873 656c 662e 6970   lim.nup(self.ip
-0000be60: 290a 2020 2020 2020 2020 2020 2020 6c69  ).            li
-0000be70: 6d2e 6275 7028 7365 6c66 2e69 702c 2070  m.bup(self.ip, p
-0000be80: 6f73 745f 737a 290a 2020 2020 2020 2020  ost_sz).        
-0000be90: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
-0000bea0: 2020 2020 2020 2020 206c 696d 2e63 686b           lim.chk
-0000beb0: 5f73 7a28 706f 7374 5f73 7a29 0a20 2020  _sz(post_sz).   
-0000bec0: 2020 2020 2020 2020 2065 7863 6570 743a           except:
-0000bed0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000bee0: 2062 6f73 2e75 6e6c 696e 6b28 7061 7468   bos.unlink(path
-0000bef0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-0000bf00: 2020 7261 6973 650a 0a20 2020 2020 2020    raise..       
-0000bf10: 2069 6620 7365 6c66 2e61 7267 732e 6e77   if self.args.nw
-0000bf20: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
-0000bf30: 7475 726e 2070 6f73 745f 737a 2c20 7368  turn post_sz, sh
-0000bf40: 615f 6865 782c 2073 6861 5f62 3634 2c20  a_hex, sha_b64, 
-0000bf50: 7265 6d61 696e 732c 2070 6174 682c 2022  remains, path, "
-0000bf60: 220a 0a20 2020 2020 2020 2061 7420 3d20  "..        at = 
-0000bf70: 6d74 203d 2074 696d 652e 7469 6d65 2829  mt = time.time()
-0000bf80: 202d 206c 6966 6574 696d 650a 2020 2020   - lifetime.    
-0000bf90: 2020 2020 636c 695f 6d74 203d 2073 656c      cli_mt = sel
-0000bfa0: 662e 6865 6164 6572 732e 6765 7428 2278  f.headers.get("x
-0000bfb0: 2d6f 632d 6d74 696d 6522 290a 2020 2020  -oc-mtime").    
-0000bfc0: 2020 2020 6966 2063 6c69 5f6d 743a 0a20      if cli_mt:. 
-0000bfd0: 2020 2020 2020 2020 2020 2074 7279 3a0a             try:.
-0000bfe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000bff0: 6d74 203d 2069 6e74 2863 6c69 5f6d 7429  mt = int(cli_mt)
-0000c000: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000c010: 2074 696d 6573 203d 2028 696e 7428 7469   times = (int(ti
-0000c020: 6d65 2e74 696d 6528 2929 2c20 6d74 290a  me.time()), mt).
-0000c030: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c040: 626f 732e 7574 696d 6528 7061 7468 2c20  bos.utime(path, 
-0000c050: 7469 6d65 732c 2046 616c 7365 290a 2020  times, False).  
-0000c060: 2020 2020 2020 2020 2020 6578 6365 7074            except
-0000c070: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0000c080: 2020 7061 7373 0a0a 2020 2020 2020 2020    pass..        
-0000c090: 6966 206e 616d 656c 6573 7320 616e 6420  if nameless and 
-0000c0a0: 226d 6167 6963 2220 696e 2076 6673 2e66  "magic" in vfs.f
-0000c0b0: 6c61 6773 3a0a 2020 2020 2020 2020 2020  lags:.          
-0000c0c0: 2020 7472 793a 0a20 2020 2020 2020 2020    try:.         
-0000c0d0: 2020 2020 2020 2065 7874 203d 2073 656c         ext = sel
-0000c0e0: 662e 636f 6e6e 2e68 7372 762e 6d61 6769  f.conn.hsrv.magi
-0000c0f0: 6369 616e 2e65 7874 2870 6174 6829 0a20  cian.ext(path). 
-0000c100: 2020 2020 2020 2020 2020 2065 7863 6570             excep
-0000c110: 7420 4578 6365 7074 696f 6e20 6173 2065  t Exception as e
-0000c120: 783a 0a20 2020 2020 2020 2020 2020 2020  x:.             
-0000c130: 2020 2073 656c 662e 6c6f 6728 2266 696c     self.log("fil
-0000c140: 6574 7970 6520 6465 7465 6374 696f 6e20  etype detection 
-0000c150: 6661 696c 6564 2066 6f72 205b 7b7d 5d3a  failed for [{}]:
-0000c160: 207b 7d22 2e66 6f72 6d61 7428 7061 7468   {}".format(path
-0000c170: 2c20 6578 292c 2036 290a 2020 2020 2020  , ex), 6).      
-0000c180: 2020 2020 2020 2020 2020 6578 7420 3d20            ext = 
-0000c190: 4e6f 6e65 0a0a 2020 2020 2020 2020 2020  None..          
-0000c1a0: 2020 6966 2065 7874 3a0a 2020 2020 2020    if ext:.      
-0000c1b0: 2020 2020 2020 2020 2020 6966 2072 6e64            if rnd
-0000c1c0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0000c1d0: 2020 2020 2020 666e 3220 3d20 7261 6e64        fn2 = rand
-0000c1e0: 5f6e 616d 6528 6664 6972 2c20 2261 2e22  _name(fdir, "a."
-0000c1f0: 202b 2065 7874 2c20 726e 6429 0a20 2020   + ext, rnd).   
-0000c200: 2020 2020 2020 2020 2020 2020 2065 6c73               els
-0000c210: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-0000c220: 2020 2020 2020 2066 6e32 203d 2066 6e2e         fn2 = fn.
-0000c230: 7273 706c 6974 2822 2e22 2c20 3129 5b30  rsplit(".", 1)[0
-0000c240: 5d20 2b20 222e 2220 2b20 6578 740a 0a20  ] + "." + ext.. 
-0000c250: 2020 2020 2020 2020 2020 2020 2020 2070                 p
-0000c260: 6172 616d 735b 2273 7566 6669 7822 5d20  arams["suffix"] 
-0000c270: 3d20 7375 6666 6978 5b3a 2d34 5d0a 2020  = suffix[:-4].  
-0000c280: 2020 2020 2020 2020 2020 2020 2020 7769                wi
-0000c290: 7468 2072 656e 5f6f 7065 6e28 666e 2c20  th ren_open(fn, 
-0000c2a0: 2a6f 7065 6e5f 612c 202a 2a70 6172 616d  *open_a, **param
-0000c2b0: 7329 2061 7320 7a66 773a 0a20 2020 2020  s) as zfw:.     
-0000c2c0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-0000c2d0: 2c20 666e 203d 207a 6677 5b22 6f72 7a22  , fn = zfw["orz"
-0000c2e0: 5d0a 0a20 2020 2020 2020 2020 2020 2020  ]..             
-0000c2f0: 2020 2070 6174 6832 203d 206f 732e 7061     path2 = os.pa
-0000c300: 7468 2e6a 6f69 6e28 6664 6972 2c20 666e  th.join(fdir, fn
-0000c310: 3229 0a20 2020 2020 2020 2020 2020 2020  2).             
-0000c320: 2020 2061 746f 6d69 635f 6d6f 7665 2870     atomic_move(p
-0000c330: 6174 682c 2070 6174 6832 290a 2020 2020  ath, path2).    
-0000c340: 2020 2020 2020 2020 2020 2020 666e 203d              fn =
-0000c350: 2066 6e32 0a20 2020 2020 2020 2020 2020   fn2.           
-0000c360: 2020 2020 2070 6174 6820 3d20 7061 7468       path = path
-0000c370: 320a 0a20 2020 2020 2020 2069 6620 7861  2..        if xa
-0000c380: 7520 616e 6420 6e6f 7420 7275 6e68 6f6f  u and not runhoo
-0000c390: 6b28 0a20 2020 2020 2020 2020 2020 2073  k(.            s
-0000c3a0: 656c 662e 6c6f 672c 0a20 2020 2020 2020  elf.log,.       
-0000c3b0: 2020 2020 2078 6175 2c0a 2020 2020 2020       xau,.      
-0000c3c0: 2020 2020 2020 7061 7468 2c0a 2020 2020        path,.    
-0000c3d0: 2020 2020 2020 2020 7365 6c66 2e76 7061          self.vpa
-0000c3e0: 7468 2c0a 2020 2020 2020 2020 2020 2020  th,.            
-0000c3f0: 7365 6c66 2e68 6f73 742c 0a20 2020 2020  self.host,.     
-0000c400: 2020 2020 2020 2073 656c 662e 756e 616d         self.unam
-0000c410: 652c 0a20 2020 2020 2020 2020 2020 206d  e,.            m
-0000c420: 742c 0a20 2020 2020 2020 2020 2020 2070  t,.            p
-0000c430: 6f73 745f 737a 2c0a 2020 2020 2020 2020  ost_sz,.        
-0000c440: 2020 2020 7365 6c66 2e69 702c 0a20 2020      self.ip,.   
-0000c450: 2020 2020 2020 2020 2061 742c 0a20 2020           at,.   
-0000c460: 2020 2020 2020 2020 2022 222c 0a20 2020           "",.   
-0000c470: 2020 2020 2029 3a0a 2020 2020 2020 2020       ):.        
-0000c480: 2020 2020 7420 3d20 2275 706c 6f61 6420      t = "upload 
-0000c490: 626c 6f63 6b65 6420 6279 2078 6175 2073  blocked by xau s
-0000c4a0: 6572 7665 7220 636f 6e66 6967 220a 2020  erver config".  
-0000c4b0: 2020 2020 2020 2020 2020 7365 6c66 2e6c            self.l
-0000c4c0: 6f67 2874 2c20 3129 0a20 2020 2020 2020  og(t, 1).       
-0000c4d0: 2020 2020 206f 732e 756e 6c69 6e6b 2870       os.unlink(p
-0000c4e0: 6174 6829 0a20 2020 2020 2020 2020 2020  ath).           
-0000c4f0: 2072 6169 7365 2050 6562 6b61 6328 3430   raise Pebkac(40
-0000c500: 332c 2074 290a 0a20 2020 2020 2020 2076  3, t)..        v
-0000c510: 6673 2c20 7265 6d20 3d20 7666 732e 6765  fs, rem = vfs.ge
-0000c520: 745f 6462 7628 7265 6d29 0a20 2020 2020  t_dbv(rem).     
-0000c530: 2020 2073 656c 662e 636f 6e6e 2e68 7372     self.conn.hsr
-0000c540: 762e 6272 6f6b 6572 2e73 6179 280a 2020  v.broker.say(.  
-0000c550: 2020 2020 2020 2020 2020 2275 7032 6b2e            "up2k.
-0000c560: 6861 7368 5f66 696c 6522 2c0a 2020 2020  hash_file",.    
-0000c570: 2020 2020 2020 2020 7666 732e 7265 616c          vfs.real
-0000c580: 7061 7468 2c0a 2020 2020 2020 2020 2020  path,.          
-0000c590: 2020 7666 732e 7670 6174 682c 0a20 2020    vfs.vpath,.   
-0000c5a0: 2020 2020 2020 2020 2076 6673 2e66 6c61           vfs.fla
-0000c5b0: 6773 2c0a 2020 2020 2020 2020 2020 2020  gs,.            
-0000c5c0: 7265 6d2c 0a20 2020 2020 2020 2020 2020  rem,.           
-0000c5d0: 2066 6e2c 0a20 2020 2020 2020 2020 2020   fn,.           
-0000c5e0: 2073 656c 662e 6970 2c0a 2020 2020 2020   self.ip,.      
-0000c5f0: 2020 2020 2020 6174 2c0a 2020 2020 2020        at,.      
-0000c600: 2020 2020 2020 7365 6c66 2e75 6e61 6d65        self.uname
-0000c610: 2c0a 2020 2020 2020 2020 2020 2020 5472  ,.            Tr
-0000c620: 7565 2c0a 2020 2020 2020 2020 290a 0a20  ue,.        ).. 
-0000c630: 2020 2020 2020 2076 7375 6620 3d20 2222         vsuf = ""
-0000c640: 0a20 2020 2020 2020 2069 6620 2873 656c  .        if (sel
-0000c650: 662e 6361 6e5f 7265 6164 206f 7220 7365  f.can_read or se
-0000c660: 6c66 2e63 616e 5f75 7067 6574 2920 616e  lf.can_upget) an
-0000c670: 6420 2266 6b22 2069 6e20 7666 732e 666c  d "fk" in vfs.fl
-0000c680: 6167 733a 0a20 2020 2020 2020 2020 2020  ags:.           
-0000c690: 2076 7375 6620 3d20 223f 6b3d 2220 2b20   vsuf = "?k=" + 
-0000c6a0: 7365 6c66 2e67 656e 5f66 6b28 0a20 2020  self.gen_fk(.   
-0000c6b0: 2020 2020 2020 2020 2020 2020 2073 656c               sel
-0000c6c0: 662e 6172 6773 2e66 6b5f 7361 6c74 2c0a  f.args.fk_salt,.
-0000c6d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c6e0: 7061 7468 2c0a 2020 2020 2020 2020 2020  path,.          
-0000c6f0: 2020 2020 2020 706f 7374 5f73 7a2c 0a20        post_sz,. 
-0000c700: 2020 2020 2020 2020 2020 2020 2020 2030                 0
-0000c710: 2069 6620 414e 5957 494e 2065 6c73 6520   if ANYWIN else 
-0000c720: 626f 732e 7374 6174 2870 6174 6829 2e73  bos.stat(path).s
-0000c730: 745f 696e 6f2c 0a20 2020 2020 2020 2020  t_ino,.         
-0000c740: 2020 2029 5b3a 2076 6673 2e66 6c61 6773     )[: vfs.flags
-0000c750: 5b22 666b 225d 5d0a 0a20 2020 2020 2020  ["fk"]]..       
-0000c760: 2076 7061 7468 203d 2022 2f22 2e6a 6f69   vpath = "/".joi
-0000c770: 6e28 5b78 2066 6f72 2078 2069 6e20 5b76  n([x for x in [v
-0000c780: 6673 2e76 7061 7468 2c20 7265 6d2c 2066  fs.vpath, rem, f
-0000c790: 6e5d 2069 6620 785d 290a 2020 2020 2020  n] if x]).      
-0000c7a0: 2020 7670 6174 6820 3d20 7175 6f74 6570    vpath = quotep
-0000c7b0: 2876 7061 7468 290a 0a20 2020 2020 2020  (vpath)..       
-0000c7c0: 2075 726c 203d 2022 7b7d 3a2f 2f7b 7d2f   url = "{}://{}/
-0000c7d0: 7b7d 222e 666f 726d 6174 280a 2020 2020  {}".format(.    
-0000c7e0: 2020 2020 2020 2020 2268 7474 7073 2220          "https" 
-0000c7f0: 6966 2073 656c 662e 6973 5f68 7474 7073  if self.is_https
-0000c800: 2065 6c73 6520 2268 7474 7022 2c0a 2020   else "http",.  
-0000c810: 2020 2020 2020 2020 2020 7365 6c66 2e68            self.h
-0000c820: 6f73 742c 0a20 2020 2020 2020 2020 2020  ost,.           
-0000c830: 2073 656c 662e 6172 6773 2e52 5320 2b20   self.args.RS + 
-0000c840: 7670 6174 6820 2b20 7673 7566 2c0a 2020  vpath + vsuf,.  
-0000c850: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
-0000c860: 2072 6574 7572 6e20 706f 7374 5f73 7a2c   return post_sz,
-0000c870: 2073 6861 5f68 6578 2c20 7368 615f 6236   sha_hex, sha_b6
-0000c880: 342c 2072 656d 6169 6e73 2c20 7061 7468  4, remains, path
-0000c890: 2c20 7572 6c0a 0a20 2020 2064 6566 2068  , url..    def h
-0000c8a0: 616e 646c 655f 7374 6173 6828 7365 6c66  andle_stash(self
-0000c8b0: 2c20 6973 5f70 7574 2029 2020 3a0a 2020  , is_put )  :.  
-0000c8c0: 2020 2020 2020 706f 7374 5f73 7a2c 2073        post_sz, s
-0000c8d0: 6861 5f68 6578 2c20 7368 615f 6236 342c  ha_hex, sha_b64,
-0000c8e0: 2072 656d 6169 6e73 2c20 7061 7468 2c20   remains, path, 
-0000c8f0: 7572 6c20 3d20 7365 6c66 2e64 756d 705f  url = self.dump_
-0000c900: 746f 5f66 696c 6528 6973 5f70 7574 290a  to_file(is_put).
-0000c910: 2020 2020 2020 2020 7370 6420 3d20 7365          spd = se
-0000c920: 6c66 2e5f 7370 6428 706f 7374 5f73 7a29  lf._spd(post_sz)
-0000c930: 0a20 2020 2020 2020 2074 203d 2022 7b7d  .        t = "{}
-0000c940: 2077 726f 7465 207b 7d2f 7b7d 2062 7974   wrote {}/{} byt
-0000c950: 6573 2074 6f20 7b7d 2020 2320 7b7d 220a  es to {}  # {}".
-0000c960: 2020 2020 2020 2020 7365 6c66 2e6c 6f67          self.log
-0000c970: 2874 2e66 6f72 6d61 7428 7370 642c 2070  (t.format(spd, p
-0000c980: 6f73 745f 737a 2c20 7265 6d61 696e 732c  ost_sz, remains,
-0000c990: 2070 6174 682c 2073 6861 5f62 3634 5b3a   path, sha_b64[:
-0000c9a0: 3238 5d29 2920 2023 2032 310a 0a20 2020  28]))  # 21..   
-0000c9b0: 2020 2020 2061 6320 3d20 7365 6c66 2e75       ac = self.u
-0000c9c0: 7061 7261 6d2e 6765 7428 0a20 2020 2020  param.get(.     
-0000c9d0: 2020 2020 2020 2022 7761 6e74 222c 2073         "want", s
-0000c9e0: 656c 662e 6865 6164 6572 732e 6765 7428  elf.headers.get(
-0000c9f0: 2261 6363 6570 7422 2c20 2222 292e 6c6f  "accept", "").lo
-0000ca00: 7765 7228 292e 7370 6c69 7428 223b 2229  wer().split(";")
-0000ca10: 5b2d 315d 0a20 2020 2020 2020 2029 0a20  [-1].        ). 
-0000ca20: 2020 2020 2020 2069 6620 6163 203d 3d20         if ac == 
-0000ca30: 2275 726c 223a 0a20 2020 2020 2020 2020  "url":.         
-0000ca40: 2020 2074 203d 2075 726c 0a20 2020 2020     t = url.     
-0000ca50: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-0000ca60: 2020 2020 2074 203d 2022 7b7d 5c6e 7b7d       t = "{}\n{}
-0000ca70: 5c6e 7b7d 5c6e 7b7d 5c6e 222e 666f 726d  \n{}\n{}\n".form
-0000ca80: 6174 2870 6f73 745f 737a 2c20 7368 615f  at(post_sz, sha_
-0000ca90: 6236 342c 2073 6861 5f68 6578 5b3a 3536  b64, sha_hex[:56
-0000caa0: 5d2c 2075 726c 290a 0a20 2020 2020 2020  ], url)..       
-0000cab0: 2068 203d 207b 224c 6f63 6174 696f 6e22   h = {"Location"
-0000cac0: 3a20 7572 6c7d 2069 6620 6973 5f70 7574  : url} if is_put
-0000cad0: 2061 6e64 2075 726c 2065 6c73 6520 7b7d   and url else {}
-0000cae0: 0a0a 2020 2020 2020 2020 6966 2022 782d  ..        if "x-
-0000caf0: 6f63 2d6d 7469 6d65 2220 696e 2073 656c  oc-mtime" in sel
-0000cb00: 662e 6865 6164 6572 733a 0a20 2020 2020  f.headers:.     
-0000cb10: 2020 2020 2020 2068 5b22 582d 4f43 2d4d         h["X-OC-M
-0000cb20: 5469 6d65 225d 203d 2022 6163 6365 7074  Time"] = "accept
-0000cb30: 6564 220a 2020 2020 2020 2020 2020 2020  ed".            
-0000cb40: 7420 3d20 2222 2020 2320 736f 6d65 2077  t = ""  # some w
-0000cb50: 6562 6461 7620 636c 6965 6e74 7320 6578  ebdav clients ex
-0000cb60: 7065 6374 2f70 7265 6665 7220 7468 6973  pect/prefer this
-0000cb70: 0a0a 2020 2020 2020 2020 7365 6c66 2e72  ..        self.r
-0000cb80: 6570 6c79 2874 2e65 6e63 6f64 6528 2275  eply(t.encode("u
-0000cb90: 7466 2d38 2229 2c20 3230 312c 2068 6561  tf-8"), 201, hea
-0000cba0: 6465 7273 3d68 290a 2020 2020 2020 2020  ders=h).        
-0000cbb0: 7265 7475 726e 2054 7275 650a 0a20 2020  return True..   
-0000cbc0: 2064 6566 2062 616b 666c 6970 2873 656c   def bakflip(sel
-0000cbd0: 662c 2066 202c 206f 6673 202c 2073 7a20  f, f , ofs , sz 
-0000cbe0: 2c20 7368 6120 2920 203a 0a20 2020 2020  , sha )  :.     
-0000cbf0: 2020 2069 6620 6e6f 7420 7365 6c66 2e61     if not self.a
-0000cc00: 7267 732e 6261 6b5f 666c 6970 7320 6f72  rgs.bak_flips or
-0000cc10: 2073 656c 662e 6172 6773 2e6e 773a 0a20   self.args.nw:. 
-0000cc20: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-0000cc30: 6e0a 0a20 2020 2020 2020 2073 6469 7220  n..        sdir 
-0000cc40: 3d20 7365 6c66 2e61 7267 732e 6266 5f64  = self.args.bf_d
-0000cc50: 6972 0a20 2020 2020 2020 2066 7020 3d20  ir.        fp = 
-0000cc60: 6f73 2e70 6174 682e 6a6f 696e 2873 6469  os.path.join(sdi
-0000cc70: 722c 2073 6861 290a 2020 2020 2020 2020  r, sha).        
-0000cc80: 6966 2062 6f73 2e70 6174 682e 6578 6973  if bos.path.exis
-0000cc90: 7473 2866 7029 3a0a 2020 2020 2020 2020  ts(fp):.        
-0000cca0: 2020 2020 7265 7475 726e 2073 656c 662e      return self.
-0000ccb0: 6c6f 6728 226e 6f20 6261 6b66 6c69 703b  log("no bakflip;
-0000ccc0: 2068 6176 6520 6974 222c 2036 290a 0a20   have it", 6).. 
-0000ccd0: 2020 2020 2020 2069 6620 6e6f 7420 626f         if not bo
-0000cce0: 732e 7061 7468 2e69 7364 6972 2873 6469  s.path.isdir(sdi
-0000ccf0: 7229 3a0a 2020 2020 2020 2020 2020 2020  r):.            
-0000cd00: 626f 732e 6d61 6b65 6469 7273 2873 6469  bos.makedirs(sdi
-0000cd10: 7229 0a0a 2020 2020 2020 2020 6966 206c  r)..        if l
-0000cd20: 656e 2862 6f73 2e6c 6973 7464 6972 2873  en(bos.listdir(s
-0000cd30: 6469 7229 2920 3e3d 2073 656c 662e 6172  dir)) >= self.ar
-0000cd40: 6773 2e62 665f 6e63 3a0a 2020 2020 2020  gs.bf_nc:.      
-0000cd50: 2020 2020 2020 7265 7475 726e 2073 656c        return sel
-0000cd60: 662e 6c6f 6728 226e 6f20 6261 6b66 6c69  f.log("no bakfli
-0000cd70: 703b 2074 6f6f 206d 616e 7922 2c20 3329  p; too many", 3)
-0000cd80: 0a0a 2020 2020 2020 2020 6e72 656d 203d  ..        nrem =
-0000cd90: 2073 7a0a 2020 2020 2020 2020 662e 7365   sz.        f.se
-0000cda0: 656b 286f 6673 290a 2020 2020 2020 2020  ek(ofs).        
-0000cdb0: 7769 7468 206f 7065 6e28 6670 2c20 2277  with open(fp, "w
-0000cdc0: 6222 2920 6173 2066 6f3a 0a20 2020 2020  b") as fo:.     
-0000cdd0: 2020 2020 2020 2077 6869 6c65 206e 7265         while nre
-0000cde0: 6d3a 0a20 2020 2020 2020 2020 2020 2020  m:.             
-0000cdf0: 2020 2062 7566 203d 2066 2e72 6561 6428     buf = f.read(
-0000ce00: 6d69 6e28 6e72 656d 2c20 3531 3220 2a20  min(nrem, 512 * 
-0000ce10: 3130 3234 2929 0a20 2020 2020 2020 2020  1024)).         
-0000ce20: 2020 2020 2020 2069 6620 6e6f 7420 6275         if not bu
-0000ce30: 663a 0a20 2020 2020 2020 2020 2020 2020  f:.             
-0000ce40: 2020 2020 2020 2062 7265 616b 0a0a 2020         break..  
-0000ce50: 2020 2020 2020 2020 2020 2020 2020 6e72                nr
-0000ce60: 656d 202d 3d20 6c65 6e28 6275 6629 0a20  em -= len(buf). 
-0000ce70: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-0000ce80: 6f2e 7772 6974 6528 6275 6629 0a0a 2020  o.write(buf)..  
-0000ce90: 2020 2020 2020 6966 206e 7265 6d3a 0a20        if nrem:. 
-0000cea0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-0000ceb0: 6c6f 6728 2262 616b 666c 6970 2074 7275  log("bakflip tru
-0000cec0: 6e63 6174 6564 3b20 7b7d 2072 656d 6169  ncated; {} remai
-0000ced0: 6e73 222e 666f 726d 6174 286e 7265 6d29  ns".format(nrem)
-0000cee0: 2c20 3129 0a20 2020 2020 2020 2020 2020  , 1).           
-0000cef0: 2061 746f 6d69 635f 6d6f 7665 2866 702c   atomic_move(fp,
-0000cf00: 2066 7020 2b20 222e 7472 756e 6322 290a   fp + ".trunc").
-0000cf10: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-0000cf20: 2020 2020 2020 2020 2020 7365 6c66 2e6c            self.l
-0000cf30: 6f67 2822 6261 6b66 6c69 7020 6f6b 222c  og("bakflip ok",
-0000cf40: 2032 290a 0a20 2020 2064 6566 205f 7370   2)..    def _sp
-0000cf50: 6428 7365 6c66 2c20 6e62 7974 6573 202c  d(self, nbytes ,
-0000cf60: 2061 6464 2020 3d20 5472 7565 2920 203a   add  = True)  :
-0000cf70: 0a20 2020 2020 2020 2069 6620 6164 643a  .        if add:
-0000cf80: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-0000cf90: 662e 636f 6e6e 2e6e 6279 7465 202b 3d20  f.conn.nbyte += 
-0000cfa0: 6e62 7974 6573 0a0a 2020 2020 2020 2020  nbytes..        
-0000cfb0: 7370 6431 203d 2067 6574 5f73 7064 286e  spd1 = get_spd(n
-0000cfc0: 6279 7465 732c 2073 656c 662e 7430 290a  bytes, self.t0).
-0000cfd0: 2020 2020 2020 2020 7370 6432 203d 2067          spd2 = g
-0000cfe0: 6574 5f73 7064 2873 656c 662e 636f 6e6e  et_spd(self.conn
-0000cff0: 2e6e 6279 7465 2c20 7365 6c66 2e63 6f6e  .nbyte, self.con
-0000d000: 6e2e 7430 290a 2020 2020 2020 2020 7265  n.t0).        re
-0000d010: 7475 726e 2022 2573 2025 7320 6e25 7322  turn "%s %s n%s"
-0000d020: 2025 2028 7370 6431 2c20 7370 6432 2c20   % (spd1, spd2, 
-0000d030: 7365 6c66 2e63 6f6e 6e2e 6e72 6571 290a  self.conn.nreq).
-0000d040: 0a20 2020 2064 6566 2068 616e 646c 655f  .    def handle_
-0000d050: 706f 7374 5f6d 756c 7469 7061 7274 2873  post_multipart(s
-0000d060: 656c 6629 2020 3a0a 2020 2020 2020 2020  elf)  :.        
-0000d070: 7365 6c66 2e70 6172 7365 7220 3d20 4d75  self.parser = Mu
-0000d080: 6c74 6970 6172 7450 6172 7365 7228 7365  ltipartParser(se
-0000d090: 6c66 2e6c 6f67 2c20 7365 6c66 2e73 722c  lf.log, self.sr,
-0000d0a0: 2073 656c 662e 6865 6164 6572 7329 0a20   self.headers). 
-0000d0b0: 2020 2020 2020 2073 656c 662e 7061 7273         self.pars
-0000d0c0: 6572 2e70 6172 7365 2829 0a0a 2020 2020  er.parse()..    
-0000d0d0: 2020 2020 6163 7420 3d20 7365 6c66 2e70      act = self.p
-0000d0e0: 6172 7365 722e 7265 7175 6972 6528 2261  arser.require("a
-0000d0f0: 6374 222c 2036 3429 0a0a 2020 2020 2020  ct", 64)..      
-0000d100: 2020 6966 2061 6374 203d 3d20 226c 6f67    if act == "log
-0000d110: 696e 223a 0a20 2020 2020 2020 2020 2020  in":.           
-0000d120: 2072 6574 7572 6e20 7365 6c66 2e68 616e   return self.han
-0000d130: 646c 655f 6c6f 6769 6e28 290a 0a20 2020  dle_login()..   
-0000d140: 2020 2020 2069 6620 6163 7420 3d3d 2022       if act == "
-0000d150: 6d6b 6469 7222 3a0a 2020 2020 2020 2020  mkdir":.        
-0000d160: 2020 2020 7265 7475 726e 2073 656c 662e      return self.
-0000d170: 6861 6e64 6c65 5f6d 6b64 6972 2829 0a0a  handle_mkdir()..
-0000d180: 2020 2020 2020 2020 6966 2061 6374 203d          if act =
-0000d190: 3d20 226e 6577 5f6d 6422 3a0a 2020 2020  = "new_md":.    
-0000d1a0: 2020 2020 2020 2020 2320 6b69 6e64 6120          # kinda 
-0000d1b0: 7369 6c6c 7920 6275 7420 6861 7320 7468  silly but has th
-0000d1c0: 6520 6c65 6173 7420 7369 6465 2065 6666  e least side eff
-0000d1d0: 6563 7473 0a20 2020 2020 2020 2020 2020  ects.           
-0000d1e0: 2072 6574 7572 6e20 7365 6c66 2e68 616e   return self.han
-0000d1f0: 646c 655f 6e65 775f 6d64 2829 0a0a 2020  dle_new_md()..  
-0000d200: 2020 2020 2020 6966 2061 6374 203d 3d20        if act == 
-0000d210: 2262 7075 7422 3a0a 2020 2020 2020 2020  "bput":.        
-0000d220: 2020 2020 7265 7475 726e 2073 656c 662e      return self.
-0000d230: 6861 6e64 6c65 5f70 6c61 696e 5f75 706c  handle_plain_upl
-0000d240: 6f61 6428 290a 0a20 2020 2020 2020 2069  oad()..        i
-0000d250: 6620 6163 7420 3d3d 2022 7470 7574 223a  f act == "tput":
-0000d260: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-0000d270: 7572 6e20 7365 6c66 2e68 616e 646c 655f  urn self.handle_
-0000d280: 7465 7874 5f75 706c 6f61 6428 290a 0a20  text_upload().. 
-0000d290: 2020 2020 2020 2069 6620 6163 7420 3d3d         if act ==
-0000d2a0: 2022 7a69 7022 3a0a 2020 2020 2020 2020   "zip":.        
-0000d2b0: 2020 2020 7265 7475 726e 2073 656c 662e      return self.
-0000d2c0: 6861 6e64 6c65 5f7a 6970 5f70 6f73 7428  handle_zip_post(
-0000d2d0: 290a 0a20 2020 2020 2020 2072 6169 7365  )..        raise
-0000d2e0: 2050 6562 6b61 6328 3432 322c 2027 696e   Pebkac(422, 'in
-0000d2f0: 7661 6c69 6420 6163 7469 6f6e 2022 7b7d  valid action "{}
-0000d300: 2227 2e66 6f72 6d61 7428 6163 7429 290a  "'.format(act)).
-0000d310: 0a20 2020 2064 6566 2068 616e 646c 655f  .    def handle_
-0000d320: 7a69 705f 706f 7374 2873 656c 6629 2020  zip_post(self)  
-0000d330: 3a0a 2020 2020 2020 2020 6173 7365 7274  :.        assert
-0000d340: 2073 656c 662e 7061 7273 6572 0a20 2020   self.parser.   
-0000d350: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
-0000d360: 2020 2020 2020 6b20 3d20 6e65 7874 2878        k = next(x
-0000d370: 2066 6f72 2078 2069 6e20 7365 6c66 2e75   for x in self.u
-0000d380: 7061 7261 6d20 6966 2078 2069 6e20 2822  param if x in ("
-0000d390: 7a69 7022 2c20 2274 6172 2229 290a 2020  zip", "tar")).  
-0000d3a0: 2020 2020 2020 6578 6365 7074 3a0a 2020        except:.  
-0000d3b0: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
-0000d3c0: 5065 626b 6163 2834 3232 2c20 226e 6565  Pebkac(422, "nee
-0000d3d0: 6420 7a69 7020 6f72 2074 6172 206b 6579  d zip or tar key
-0000d3e0: 776f 7264 2229 0a0a 2020 2020 2020 2020  word")..        
-0000d3f0: 7620 3d20 7365 6c66 2e75 7061 7261 6d5b  v = self.uparam[
-0000d400: 6b5d 0a0a 2020 2020 2020 2020 766e 2c20  k]..        vn, 
-0000d410: 7265 6d20 3d20 7365 6c66 2e61 7372 762e  rem = self.asrv.
-0000d420: 7666 732e 6765 7428 7365 6c66 2e76 7061  vfs.get(self.vpa
-0000d430: 7468 2c20 7365 6c66 2e75 6e61 6d65 2c20  th, self.uname, 
-0000d440: 5472 7565 2c20 4661 6c73 6529 0a20 2020  True, False).   
-0000d450: 2020 2020 207a 7320 3d20 7365 6c66 2e70       zs = self.p
-0000d460: 6172 7365 722e 7265 7175 6972 6528 2266  arser.require("f
-0000d470: 696c 6573 222c 2031 3032 3420 2a20 3130  iles", 1024 * 10
-0000d480: 3234 290a 2020 2020 2020 2020 6966 206e  24).        if n
-0000d490: 6f74 207a 733a 0a20 2020 2020 2020 2020  ot zs:.         
-0000d4a0: 2020 2072 6169 7365 2050 6562 6b61 6328     raise Pebkac(
-0000d4b0: 3432 322c 2022 6e65 6564 2066 696c 6573  422, "need files
-0000d4c0: 206c 6973 7422 290a 0a20 2020 2020 2020   list")..       
-0000d4d0: 2069 7465 6d73 203d 207a 732e 7265 706c   items = zs.repl
-0000d4e0: 6163 6528 225c 7222 2c20 2222 292e 7370  ace("\r", "").sp
-0000d4f0: 6c69 7428 225c 6e22 290a 2020 2020 2020  lit("\n").      
-0000d500: 2020 6974 656d 7320 3d20 5b75 6e71 756f    items = [unquo
-0000d510: 7465 7028 7829 2066 6f72 2078 2069 6e20  tep(x) for x in 
-0000d520: 6974 656d 7320 6966 2069 7465 6d73 5d0a  items if items].
-0000d530: 0a20 2020 2020 2020 2073 656c 662e 7061  .        self.pa
-0000d540: 7273 6572 2e64 726f 7028 290a 2020 2020  rser.drop().    
-0000d550: 2020 2020 7265 7475 726e 2073 656c 662e      return self.
-0000d560: 7478 5f7a 6970 286b 2c20 762c 2022 222c  tx_zip(k, v, "",
-0000d570: 2076 6e2c 2072 656d 2c20 6974 656d 732c   vn, rem, items,
-0000d580: 2073 656c 662e 6172 6773 2e65 6429 0a0a   self.args.ed)..
-0000d590: 2020 2020 6465 6620 6861 6e64 6c65 5f70      def handle_p
-0000d5a0: 6f73 745f 6a73 6f6e 2873 656c 6629 2020  ost_json(self)  
-0000d5b0: 3a0a 2020 2020 2020 2020 7472 793a 0a20  :.        try:. 
-0000d5c0: 2020 2020 2020 2020 2020 2072 656d 6169             remai
-0000d5d0: 6e73 203d 2069 6e74 2873 656c 662e 6865  ns = int(self.he
-0000d5e0: 6164 6572 735b 2263 6f6e 7465 6e74 2d6c  aders["content-l
-0000d5f0: 656e 6774 6822 5d29 0a20 2020 2020 2020  ength"]).       
-0000d600: 2065 7863 6570 743a 0a20 2020 2020 2020   except:.       
-0000d610: 2020 2020 2072 6169 7365 2050 6562 6b61       raise Pebka
-0000d620: 6328 3431 3129 0a0a 2020 2020 2020 2020  c(411)..        
-0000d630: 6966 2072 656d 6169 6e73 203e 2031 3032  if remains > 102
-0000d640: 3420 2a20 3130 3234 3a0a 2020 2020 2020  4 * 1024:.      
-0000d650: 2020 2020 2020 7261 6973 6520 5065 626b        raise Pebk
-0000d660: 6163 2834 3133 2c20 226a 736f 6e20 3262  ac(413, "json 2b
-0000d670: 6967 2229 0a0a 2020 2020 2020 2020 656e  ig")..        en
-0000d680: 6320 3d20 2275 7466 2d38 220a 2020 2020  c = "utf-8".    
-0000d690: 2020 2020 6374 7970 6520 3d20 7365 6c66      ctype = self
-0000d6a0: 2e68 6561 6465 7273 2e67 6574 2822 636f  .headers.get("co
-0000d6b0: 6e74 656e 742d 7479 7065 222c 2022 2229  ntent-type", "")
-0000d6c0: 2e6c 6f77 6572 2829 0a20 2020 2020 2020  .lower().       
-0000d6d0: 2069 6620 2263 6861 7273 6574 2220 696e   if "charset" in
-0000d6e0: 2063 7479 7065 3a0a 2020 2020 2020 2020   ctype:.        
-0000d6f0: 2020 2020 656e 6320 3d20 6374 7970 652e      enc = ctype.
-0000d700: 7370 6c69 7428 2263 6861 7273 6574 2229  split("charset")
-0000d710: 5b31 5d2e 7374 7269 7028 2220 3d22 292e  [1].strip(" =").
-0000d720: 7370 6c69 7428 223b 2229 5b30 5d2e 7374  split(";")[0].st
-0000d730: 7269 7028 290a 0a20 2020 2020 2020 2074  rip()..        t
-0000d740: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
-0000d750: 6a73 6f6e 5f62 7566 203d 2073 656c 662e  json_buf = self.
-0000d760: 7372 2e72 6563 765f 6578 2872 656d 6169  sr.recv_ex(remai
-0000d770: 6e73 290a 2020 2020 2020 2020 6578 6365  ns).        exce
-0000d780: 7074 2055 6e72 6563 7645 4f46 3a0a 2020  pt UnrecvEOF:.  
-0000d790: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
-0000d7a0: 5065 626b 6163 2834 3232 2c20 2263 6c69  Pebkac(422, "cli
-0000d7b0: 656e 7420 6469 7363 6f6e 6e65 6374 6564  ent disconnected
-0000d7c0: 2077 6869 6c65 2070 6f73 7469 6e67 204a   while posting J
-0000d7d0: 534f 4e22 290a 0a20 2020 2020 2020 2073  SON")..        s
-0000d7e0: 656c 662e 6c6f 6728 2264 6563 6f64 696e  elf.log("decodin
-0000d7f0: 6720 7b7d 2062 7974 6573 206f 6620 7b7d  g {} bytes of {}
-0000d800: 206a 736f 6e22 2e66 6f72 6d61 7428 6c65   json".format(le
-0000d810: 6e28 6a73 6f6e 5f62 7566 292c 2065 6e63  n(json_buf), enc
-0000d820: 2929 0a20 2020 2020 2020 2074 7279 3a0a  )).        try:.
-0000d830: 2020 2020 2020 2020 2020 2020 626f 6479              body
-0000d840: 203d 206a 736f 6e2e 6c6f 6164 7328 6a73   = json.loads(js
-0000d850: 6f6e 5f62 7566 2e64 6563 6f64 6528 656e  on_buf.decode(en
-0000d860: 632c 2022 7265 706c 6163 6522 2929 0a20  c, "replace")). 
-0000d870: 2020 2020 2020 2065 7863 6570 743a 0a20         except:. 
-0000d880: 2020 2020 2020 2020 2020 2072 6169 7365             raise
-0000d890: 2050 6562 6b61 6328 3432 322c 2022 796f   Pebkac(422, "yo
-0000d8a0: 7520 504f 5354 6564 2069 6e76 616c 6964  u POSTed invalid
-0000d8b0: 206a 736f 6e22 290a 0a20 2020 2020 2020   json")..       
-0000d8c0: 2023 2073 656c 662e 7265 706c 7928 6222   # self.reply(b"
-0000d8d0: 636c 6f75 6466 6c61 7265 222c 2035 3033  cloudflare", 503
-0000d8e0: 290a 2020 2020 2020 2020 2320 7265 7475  ).        # retu
-0000d8f0: 726e 2054 7275 650a 0a20 2020 2020 2020  rn True..       
-0000d900: 2069 6620 2273 7263 6822 2069 6e20 7365   if "srch" in se
-0000d910: 6c66 2e75 7061 7261 6d20 6f72 2022 7372  lf.uparam or "sr
-0000d920: 6368 2220 696e 2062 6f64 793a 0a20 2020  ch" in body:.   
-0000d930: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-0000d940: 7365 6c66 2e68 616e 646c 655f 7365 6172  self.handle_sear
-0000d950: 6368 2862 6f64 7929 0a0a 2020 2020 2020  ch(body)..      
-0000d960: 2020 6966 2022 6465 6c65 7465 2220 696e    if "delete" in
-0000d970: 2073 656c 662e 7570 6172 616d 3a0a 2020   self.uparam:.  
-0000d980: 2020 2020 2020 2020 2020 7265 7475 726e            return
-0000d990: 2073 656c 662e 6861 6e64 6c65 5f72 6d28   self.handle_rm(
-0000d9a0: 626f 6479 290a 0a20 2020 2020 2020 206e  body)..        n
-0000d9b0: 616d 6520 3d20 756e 646f 7428 626f 6479  ame = undot(body
-0000d9c0: 5b22 6e61 6d65 225d 290a 2020 2020 2020  ["name"]).      
-0000d9d0: 2020 6966 2022 2f22 2069 6e20 6e61 6d65    if "/" in name
-0000d9e0: 3a0a 2020 2020 2020 2020 2020 2020 7261  :.            ra
-0000d9f0: 6973 6520 5065 626b 6163 2834 3030 2c20  ise Pebkac(400, 
-0000da00: 2279 6f75 7220 636c 6965 6e74 2069 7320  "your client is 
-0000da10: 6f6c 643b 2070 7265 7373 2043 5452 4c2d  old; press CTRL-
-0000da20: 5348 4946 542d 5220 616e 6420 7472 7920  SHIFT-R and try 
-0000da30: 6167 6169 6e22 290a 0a20 2020 2020 2020  again")..       
-0000da40: 2076 6673 2c20 7265 6d20 3d20 7365 6c66   vfs, rem = self
-0000da50: 2e61 7372 762e 7666 732e 6765 7428 7365  .asrv.vfs.get(se
-0000da60: 6c66 2e76 7061 7468 2c20 7365 6c66 2e75  lf.vpath, self.u
-0000da70: 6e61 6d65 2c20 4661 6c73 652c 2054 7275  name, False, Tru
-0000da80: 6529 0a20 2020 2020 2020 2064 6276 2c20  e).        dbv, 
-0000da90: 7672 656d 203d 2076 6673 2e67 6574 5f64  vrem = vfs.get_d
-0000daa0: 6276 2872 656d 290a 0a20 2020 2020 2020  bv(rem)..       
-0000dab0: 2062 6f64 795b 2276 746f 7022 5d20 3d20   body["vtop"] = 
-0000dac0: 6462 762e 7670 6174 680a 2020 2020 2020  dbv.vpath.      
-0000dad0: 2020 626f 6479 5b22 7074 6f70 225d 203d    body["ptop"] =
-0000dae0: 2064 6276 2e72 6561 6c70 6174 680a 2020   dbv.realpath.  
-0000daf0: 2020 2020 2020 626f 6479 5b22 7072 656c        body["prel
-0000db00: 225d 203d 2076 7265 6d0a 2020 2020 2020  "] = vrem.      
-0000db10: 2020 626f 6479 5b22 686f 7374 225d 203d    body["host"] =
-0000db20: 2073 656c 662e 686f 7374 0a20 2020 2020   self.host.     
-0000db30: 2020 2062 6f64 795b 2275 7365 7222 5d20     body["user"] 
-0000db40: 3d20 7365 6c66 2e75 6e61 6d65 0a20 2020  = self.uname.   
-0000db50: 2020 2020 2062 6f64 795b 2261 6464 7222       body["addr"
-0000db60: 5d20 3d20 7365 6c66 2e69 700a 2020 2020  ] = self.ip.    
-0000db70: 2020 2020 626f 6479 5b22 7663 6667 225d      body["vcfg"]
-0000db80: 203d 2064 6276 2e66 6c61 6773 0a0a 2020   = dbv.flags..  
-0000db90: 2020 2020 2020 6966 206e 6f74 2073 656c        if not sel
-0000dba0: 662e 6361 6e5f 6465 6c65 7465 3a0a 2020  f.can_delete:.  
-0000dbb0: 2020 2020 2020 2020 2020 626f 6479 2e70            body.p
-0000dbc0: 6f70 2822 7265 706c 6163 6522 2c20 4e6f  op("replace", No
-0000dbd0: 6e65 290a 0a20 2020 2020 2020 2069 6620  ne)..        if 
-0000dbe0: 7265 6d3a 0a20 2020 2020 2020 2020 2020  rem:.           
-0000dbf0: 2064 7374 203d 2076 6673 2e63 616e 6f6e   dst = vfs.canon
-0000dc00: 6963 616c 2872 656d 290a 2020 2020 2020  ical(rem).      
-0000dc10: 2020 2020 2020 7472 793a 0a20 2020 2020        try:.     
-0000dc20: 2020 2020 2020 2020 2020 2069 6620 6e6f             if no
-0000dc30: 7420 626f 732e 7061 7468 2e69 7364 6972  t bos.path.isdir
-0000dc40: 2864 7374 293a 0a20 2020 2020 2020 2020  (dst):.         
-0000dc50: 2020 2020 2020 2020 2020 2062 6f73 2e6d             bos.m
-0000dc60: 616b 6564 6972 7328 6473 7429 0a20 2020  akedirs(dst).   
-0000dc70: 2020 2020 2020 2020 2065 7863 6570 7420           except 
-0000dc80: 4f53 4572 726f 7220 6173 2065 783a 0a20  OSError as ex:. 
-0000dc90: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-0000dca0: 656c 662e 6c6f 6728 226d 616b 6564 6972  elf.log("makedir
-0000dcb0: 7320 6661 696c 6564 205b 7b7d 5d22 2e66  s failed [{}]".f
-0000dcc0: 6f72 6d61 7428 6473 7429 290a 2020 2020  ormat(dst)).    
-0000dcd0: 2020 2020 2020 2020 2020 2020 6966 206e              if n
-0000dce0: 6f74 2062 6f73 2e70 6174 682e 6973 6469  ot bos.path.isdi
-0000dcf0: 7228 6473 7429 3a0a 2020 2020 2020 2020  r(dst):.        
-0000dd00: 2020 2020 2020 2020 2020 2020 6966 2065              if e
-0000dd10: 782e 6572 726e 6f20 3d3d 2065 7272 6e6f  x.errno == errno
-0000dd20: 2e45 4143 4345 533a 0a20 2020 2020 2020  .EACCES:.       
-0000dd30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000dd40: 2072 6169 7365 2050 6562 6b61 6328 3530   raise Pebkac(50
-0000dd50: 302c 2022 7468 6520 7365 7276 6572 204f  0, "the server O
-0000dd60: 5320 6465 6e69 6564 2077 7269 7465 2d61  S denied write-a
-0000dd70: 6363 6573 7322 290a 0a20 2020 2020 2020  ccess")..       
-0000dd80: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-0000dd90: 6578 2e65 7272 6e6f 203d 3d20 6572 726e  ex.errno == errn
-0000dda0: 6f2e 4545 5849 5354 3a0a 2020 2020 2020  o.EEXIST:.      
-0000ddb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ddc0: 2020 7261 6973 6520 5065 626b 6163 2834    raise Pebkac(4
-0000ddd0: 3030 2c20 2273 6f6d 6520 6669 6c65 2067  00, "some file g
-0000dde0: 6f74 2079 6f75 7220 666f 6c64 6572 206e  ot your folder n
-0000ddf0: 616d 6522 290a 0a20 2020 2020 2020 2020  ame")..         
-0000de00: 2020 2020 2020 2020 2020 2072 6169 7365             raise
-0000de10: 2050 6562 6b61 6328 3530 302c 206d 696e   Pebkac(500, min
-0000de20: 5f65 7828 2929 0a20 2020 2020 2020 2020  _ex()).         
-0000de30: 2020 2065 7863 6570 743a 0a20 2020 2020     except:.     
-0000de40: 2020 2020 2020 2020 2020 2072 6169 7365             raise
-0000de50: 2050 6562 6b61 6328 3530 302c 206d 696e   Pebkac(500, min
-0000de60: 5f65 7828 2929 0a0a 2020 2020 2020 2020  _ex())..        
-0000de70: 7820 3d20 7365 6c66 2e63 6f6e 6e2e 6873  x = self.conn.hs
-0000de80: 7276 2e62 726f 6b65 722e 6173 6b28 2275  rv.broker.ask("u
-0000de90: 7032 6b2e 6861 6e64 6c65 5f6a 736f 6e22  p2k.handle_json"
-0000dea0: 2c20 626f 6479 2c20 7365 6c66 2e75 3266  , body, self.u2f
-0000deb0: 682e 6170 7329 0a20 2020 2020 2020 2072  h.aps).        r
-0000dec0: 6574 203d 2078 2e67 6574 2829 0a20 2020  et = x.get().   
-0000ded0: 2020 2020 2069 6620 7365 6c66 2e69 735f       if self.is_
-0000dee0: 7670 726f 7869 6564 3a0a 2020 2020 2020  vproxied:.      
-0000def0: 2020 2020 2020 6966 2022 7075 726c 2220        if "purl" 
-0000df00: 696e 2072 6574 3a0a 2020 2020 2020 2020  in ret:.        
-0000df10: 2020 2020 2020 2020 7265 745b 2270 7572          ret["pur
-0000df20: 6c22 5d20 3d20 7365 6c66 2e61 7267 732e  l"] = self.args.
-0000df30: 5352 202b 2072 6574 5b22 7075 726c 225d  SR + ret["purl"]
-0000df40: 0a0a 2020 2020 2020 2020 7265 7420 3d20  ..        ret = 
-0000df50: 6a73 6f6e 2e64 756d 7073 2872 6574 290a  json.dumps(ret).
-0000df60: 2020 2020 2020 2020 7365 6c66 2e6c 6f67          self.log
-0000df70: 2872 6574 290a 2020 2020 2020 2020 7365  (ret).        se
-0000df80: 6c66 2e72 6570 6c79 2872 6574 2e65 6e63  lf.reply(ret.enc
-0000df90: 6f64 6528 2275 7466 2d38 2229 2c20 6d69  ode("utf-8"), mi
-0000dfa0: 6d65 3d22 6170 706c 6963 6174 696f 6e2f  me="application/
-0000dfb0: 6a73 6f6e 2229 0a20 2020 2020 2020 2072  json").        r
-0000dfc0: 6574 7572 6e20 5472 7565 0a0a 2020 2020  eturn True..    
-0000dfd0: 6465 6620 6861 6e64 6c65 5f73 6561 7263  def handle_searc
-0000dfe0: 6828 7365 6c66 2c20 626f 6479 2020 2920  h(self, body  ) 
-0000dff0: 203a 0a20 2020 2020 2020 2069 6478 203d   :.        idx =
-0000e000: 2073 656c 662e 636f 6e6e 2e67 6574 5f75   self.conn.get_u
-0000e010: 3269 6478 2829 0a20 2020 2020 2020 2069  2idx().        i
-0000e020: 6620 6e6f 7420 6964 7820 6f72 206e 6f74  f not idx or not
-0000e030: 2068 6173 6174 7472 2869 6478 2c20 2270   hasattr(idx, "p
-0000e040: 5f65 6e64 2229 3a0a 2020 2020 2020 2020  _end"):.        
-0000e050: 2020 2020 7261 6973 6520 5065 626b 6163      raise Pebkac
-0000e060: 2835 3030 2c20 2273 716c 6974 6533 2069  (500, "sqlite3 i
-0000e070: 7320 6e6f 7420 6176 6169 6c61 626c 6520  s not available 
-0000e080: 6f6e 2074 6865 2073 6572 7665 723b 2063  on the server; c
-0000e090: 616e 6e6f 7420 7365 6172 6368 2229 0a0a  annot search")..
-0000e0a0: 2020 2020 2020 2020 766f 6c73 203d 205b          vols = [
-0000e0b0: 5d0a 2020 2020 2020 2020 7365 656e 203d  ].        seen =
-0000e0c0: 207b 7d0a 2020 2020 2020 2020 666f 7220   {}.        for 
-0000e0d0: 7674 6f70 2069 6e20 7365 6c66 2e72 766f  vtop in self.rvo
-0000e0e0: 6c3a 0a20 2020 2020 2020 2020 2020 2076  l:.            v
-0000e0f0: 6673 2c20 5f20 3d20 7365 6c66 2e61 7372  fs, _ = self.asr
-0000e100: 762e 7666 732e 6765 7428 7674 6f70 2c20  v.vfs.get(vtop, 
-0000e110: 7365 6c66 2e75 6e61 6d65 2c20 5472 7565  self.uname, True
-0000e120: 2c20 4661 6c73 6529 0a20 2020 2020 2020  , False).       
-0000e130: 2020 2020 2076 6673 203d 2076 6673 2e64       vfs = vfs.d
-0000e140: 6276 206f 7220 7666 730a 2020 2020 2020  bv or vfs.      
-0000e150: 2020 2020 2020 6966 2076 6673 2069 6e20        if vfs in 
-0000e160: 7365 656e 3a0a 2020 2020 2020 2020 2020  seen:.          
-0000e170: 2020 2020 2020 636f 6e74 696e 7565 0a0a        continue..
-0000e180: 2020 2020 2020 2020 2020 2020 7365 656e              seen
-0000e190: 5b76 6673 5d20 3d20 5472 7565 0a20 2020  [vfs] = True.   
-0000e1a0: 2020 2020 2020 2020 2076 6f6c 732e 6170           vols.ap
-0000e1b0: 7065 6e64 2828 7666 732e 7670 6174 682c  pend((vfs.vpath,
-0000e1c0: 2076 6673 2e72 6561 6c70 6174 682c 2076   vfs.realpath, v
-0000e1d0: 6673 2e66 6c61 6773 2929 0a0a 2020 2020  fs.flags))..    
-0000e1e0: 2020 2020 7430 203d 2074 696d 652e 7469      t0 = time.ti
-0000e1f0: 6d65 2829 0a20 2020 2020 2020 2069 6620  me().        if 
-0000e200: 6964 782e 705f 656e 643a 0a20 2020 2020  idx.p_end:.     
-0000e210: 2020 2020 2020 2070 656e 616c 7479 203d         penalty =
-0000e220: 2030 2e37 0a20 2020 2020 2020 2020 2020   0.7.           
-0000e230: 2074 5f69 646c 6520 3d20 7430 202d 2069   t_idle = t0 - i
-0000e240: 6478 2e70 5f65 6e64 0a20 2020 2020 2020  dx.p_end.       
-0000e250: 2020 2020 2069 6620 6964 782e 705f 6475       if idx.p_du
-0000e260: 7220 3e20 302e 3720 616e 6420 745f 6964  r > 0.7 and t_id
-0000e270: 6c65 203c 2070 656e 616c 7479 3a0a 2020  le < penalty:.  
-0000e280: 2020 2020 2020 2020 2020 2020 2020 7420                t 
-0000e290: 3d20 2272 6174 652d 6c69 6d69 7420 7b3a  = "rate-limit {:
-0000e2a0: 2e31 667d 2073 6563 2c20 636f 7374 207b  .1f} sec, cost {
-0000e2b0: 3a2e 3266 7d2c 2069 646c 6520 7b3a 2e32  :.2f}, idle {:.2
-0000e2c0: 667d 220a 2020 2020 2020 2020 2020 2020  f}".            
-0000e2d0: 2020 2020 7261 6973 6520 5065 626b 6163      raise Pebkac
-0000e2e0: 2834 3239 2c20 742e 666f 726d 6174 2870  (429, t.format(p
-0000e2f0: 656e 616c 7479 2c20 6964 782e 705f 6475  enalty, idx.p_du
-0000e300: 722c 2074 5f69 646c 6529 290a 0a20 2020  r, t_idle))..   
-0000e310: 2020 2020 2069 6620 2273 7263 6822 2069       if "srch" i
-0000e320: 6e20 626f 6479 3a0a 2020 2020 2020 2020  n body:.        
-0000e330: 2020 2020 2320 7365 6172 6368 2062 7920      # search by 
-0000e340: 7570 326b 2068 6173 686c 6973 740a 2020  up2k hashlist.  
-0000e350: 2020 2020 2020 2020 2020 7662 6f64 7920            vbody 
-0000e360: 3d20 636f 7079 2e64 6565 7063 6f70 7928  = copy.deepcopy(
-0000e370: 626f 6479 290a 2020 2020 2020 2020 2020  body).          
-0000e380: 2020 7662 6f64 795b 2268 6173 6822 5d20    vbody["hash"] 
-0000e390: 3d20 6c65 6e28 7662 6f64 795b 2268 6173  = len(vbody["has
-0000e3a0: 6822 5d29 0a20 2020 2020 2020 2020 2020  h"]).           
-0000e3b0: 2073 656c 662e 6c6f 6728 2271 6a3a 2022   self.log("qj: "
-0000e3c0: 202b 2072 6570 7228 7662 6f64 7929 290a   + repr(vbody)).
-0000e3d0: 2020 2020 2020 2020 2020 2020 6869 7473              hits
-0000e3e0: 203d 2069 6478 2e66 7365 6172 6368 2876   = idx.fsearch(v
-0000e3f0: 6f6c 732c 2062 6f64 7929 0a20 2020 2020  ols, body).     
-0000e400: 2020 2020 2020 206d 7367 2020 3d20 7265         msg  = re
-0000e410: 7072 2868 6974 7329 0a20 2020 2020 2020  pr(hits).       
-0000e420: 2020 2020 2074 6167 6c69 7374 2020 3d20       taglist  = 
-0000e430: 5b5d 0a20 2020 2020 2020 2020 2020 2074  [].            t
-0000e440: 7275 6e63 203d 2046 616c 7365 0a20 2020  runc = False.   
-0000e450: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-0000e460: 2020 2020 2020 2023 2073 6561 7263 6820         # search 
-0000e470: 6279 2071 7565 7279 2070 6172 616d 730a  by query params.
-0000e480: 2020 2020 2020 2020 2020 2020 7120 3d20              q = 
-0000e490: 626f 6479 5b22 7122 5d0a 2020 2020 2020  body["q"].      
-0000e4a0: 2020 2020 2020 6e20 3d20 626f 6479 2e67        n = body.g
-0000e4b0: 6574 2822 6e22 2c20 7365 6c66 2e61 7267  et("n", self.arg
-0000e4c0: 732e 7372 6368 5f68 6974 7329 0a20 2020  s.srch_hits).   
-0000e4d0: 2020 2020 2020 2020 2073 656c 662e 6c6f           self.lo
-0000e4e0: 6728 2271 6a3a 207b 7d20 7c7b 7d7c 222e  g("qj: {} |{}|".
-0000e4f0: 666f 726d 6174 2871 2c20 6e29 290a 2020  format(q, n)).  
-0000e500: 2020 2020 2020 2020 2020 6869 7473 2c20            hits, 
-0000e510: 7461 676c 6973 742c 2074 7275 6e63 203d  taglist, trunc =
-0000e520: 2069 6478 2e73 6561 7263 6828 766f 6c73   idx.search(vols
-0000e530: 2c20 712c 206e 290a 2020 2020 2020 2020  , q, n).        
-0000e540: 2020 2020 6d73 6720 3d20 6c65 6e28 6869      msg = len(hi
-0000e550: 7473 290a 0a20 2020 2020 2020 2069 6478  ts)..        idx
-0000e560: 2e70 5f65 6e64 203d 2074 696d 652e 7469  .p_end = time.ti
-0000e570: 6d65 2829 0a20 2020 2020 2020 2069 6478  me().        idx
-0000e580: 2e70 5f64 7572 203d 2069 6478 2e70 5f65  .p_dur = idx.p_e
-0000e590: 6e64 202d 2074 300a 2020 2020 2020 2020  nd - t0.        
-0000e5a0: 7365 6c66 2e6c 6f67 2822 7123 3a20 7b7d  self.log("q#: {}
-0000e5b0: 2028 7b3a 2e32 667d 7329 222e 666f 726d   ({:.2f}s)".form
-0000e5c0: 6174 286d 7367 2c20 6964 782e 705f 6475  at(msg, idx.p_du
-0000e5d0: 7229 290a 0a20 2020 2020 2020 206f 7264  r))..        ord
-0000e5e0: 6572 203d 205b 5d0a 2020 2020 2020 2020  er = [].        
-0000e5f0: 6366 6720 3d20 7365 6c66 2e61 7267 732e  cfg = self.args.
-0000e600: 6d74 652e 7370 6c69 7428 222c 2229 0a20  mte.split(","). 
-0000e610: 2020 2020 2020 2066 6f72 2074 2069 6e20         for t in 
-0000e620: 6366 673a 0a20 2020 2020 2020 2020 2020  cfg:.           
-0000e630: 2069 6620 7420 696e 2074 6167 6c69 7374   if t in taglist
-0000e640: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0000e650: 2020 6f72 6465 722e 6170 7065 6e64 2874    order.append(t
-0000e660: 290a 2020 2020 2020 2020 666f 7220 7420  ).        for t 
-0000e670: 696e 2074 6167 6c69 7374 3a0a 2020 2020  in taglist:.    
-0000e680: 2020 2020 2020 2020 6966 2074 206e 6f74          if t not
-0000e690: 2069 6e20 6f72 6465 723a 0a20 2020 2020   in order:.     
-0000e6a0: 2020 2020 2020 2020 2020 206f 7264 6572             order
-0000e6b0: 2e61 7070 656e 6428 7429 0a0a 2020 2020  .append(t)..    
-0000e6c0: 2020 2020 6966 2073 656c 662e 6973 5f76      if self.is_v
-0000e6d0: 7072 6f78 6965 643a 0a20 2020 2020 2020  proxied:.       
-0000e6e0: 2020 2020 2066 6f72 2068 6974 2069 6e20       for hit in 
-0000e6f0: 6869 7473 3a0a 2020 2020 2020 2020 2020  hits:.          
-0000e700: 2020 2020 2020 6869 745b 2272 7022 5d20        hit["rp"] 
-0000e710: 3d20 7365 6c66 2e61 7267 732e 5253 202b  = self.args.RS +
-0000e720: 2068 6974 5b22 7270 225d 0a0a 2020 2020   hit["rp"]..    
-0000e730: 2020 2020 726a 203d 207b 2268 6974 7322      rj = {"hits"
-0000e740: 3a20 6869 7473 2c20 2274 6167 5f6f 7264  : hits, "tag_ord
-0000e750: 6572 223a 206f 7264 6572 2c20 2274 7275  er": order, "tru
-0000e760: 6e63 223a 2074 7275 6e63 7d0a 2020 2020  nc": trunc}.    
-0000e770: 2020 2020 7220 3d20 6a73 6f6e 2e64 756d      r = json.dum
-0000e780: 7073 2872 6a29 2e65 6e63 6f64 6528 2275  ps(rj).encode("u
-0000e790: 7466 2d38 2229 0a20 2020 2020 2020 2073  tf-8").        s
-0000e7a0: 656c 662e 7265 706c 7928 722c 206d 696d  elf.reply(r, mim
-0000e7b0: 653d 2261 7070 6c69 6361 7469 6f6e 2f6a  e="application/j
-0000e7c0: 736f 6e22 290a 2020 2020 2020 2020 7265  son").        re
-0000e7d0: 7475 726e 2054 7275 650a 0a20 2020 2064  turn True..    d
-0000e7e0: 6566 2068 616e 646c 655f 706f 7374 5f62  ef handle_post_b
-0000e7f0: 696e 6172 7928 7365 6c66 2920 203a 0a20  inary(self)  :. 
-0000e800: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
-0000e810: 2020 2020 2020 2020 7265 6d61 696e 7320          remains 
-0000e820: 3d20 696e 7428 7365 6c66 2e68 6561 6465  = int(self.heade
-0000e830: 7273 5b22 636f 6e74 656e 742d 6c65 6e67  rs["content-leng
-0000e840: 7468 225d 290a 2020 2020 2020 2020 6578  th"]).        ex
-0000e850: 6365 7074 3a0a 2020 2020 2020 2020 2020  cept:.          
-0000e860: 2020 7261 6973 6520 5065 626b 6163 2834    raise Pebkac(4
-0000e870: 3030 2c20 2279 6f75 206d 7573 7420 7375  00, "you must su
-0000e880: 7070 6c79 2061 2063 6f6e 7465 6e74 2d6c  pply a content-l
-0000e890: 656e 6774 6820 666f 7220 6269 6e61 7279  ength for binary
-0000e8a0: 2050 4f53 5422 290a 0a20 2020 2020 2020   POST")..       
-0000e8b0: 2074 7279 3a0a 2020 2020 2020 2020 2020   try:.          
-0000e8c0: 2020 6368 6173 6820 3d20 7365 6c66 2e68    chash = self.h
-0000e8d0: 6561 6465 7273 5b22 782d 7570 326b 2d68  eaders["x-up2k-h
-0000e8e0: 6173 6822 5d0a 2020 2020 2020 2020 2020  ash"].          
-0000e8f0: 2020 7761 726b 203d 2073 656c 662e 6865    wark = self.he
-0000e900: 6164 6572 735b 2278 2d75 7032 6b2d 7761  aders["x-up2k-wa
-0000e910: 726b 225d 0a20 2020 2020 2020 2065 7863  rk"].        exc
-0000e920: 6570 7420 4b65 7945 7272 6f72 3a0a 2020  ept KeyError:.  
-0000e930: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
-0000e940: 5065 626b 6163 2834 3030 2c20 226e 6565  Pebkac(400, "nee
-0000e950: 6420 6861 7368 2061 6e64 2077 6172 6b20  d hash and wark 
-0000e960: 6865 6164 6572 7320 666f 7220 6269 6e61  headers for bina
-0000e970: 7279 2050 4f53 5422 290a 0a20 2020 2020  ry POST")..     
-0000e980: 2020 2076 6673 2c20 5f20 3d20 7365 6c66     vfs, _ = self
-0000e990: 2e61 7372 762e 7666 732e 6765 7428 7365  .asrv.vfs.get(se
-0000e9a0: 6c66 2e76 7061 7468 2c20 7365 6c66 2e75  lf.vpath, self.u
-0000e9b0: 6e61 6d65 2c20 4661 6c73 652c 2054 7275  name, False, Tru
-0000e9c0: 6529 0a20 2020 2020 2020 2070 746f 7020  e).        ptop 
-0000e9d0: 3d20 2876 6673 2e64 6276 206f 7220 7666  = (vfs.dbv or vf
-0000e9e0: 7329 2e72 6561 6c70 6174 680a 0a20 2020  s).realpath..   
-0000e9f0: 2020 2020 2078 203d 2073 656c 662e 636f       x = self.co
-0000ea00: 6e6e 2e68 7372 762e 6272 6f6b 6572 2e61  nn.hsrv.broker.a
-0000ea10: 736b 2822 7570 326b 2e68 616e 646c 655f  sk("up2k.handle_
-0000ea20: 6368 756e 6b22 2c20 7074 6f70 2c20 7761  chunk", ptop, wa
-0000ea30: 726b 2c20 6368 6173 6829 0a20 2020 2020  rk, chash).     
-0000ea40: 2020 2072 6573 706f 6e73 6520 3d20 782e     response = x.
-0000ea50: 6765 7428 290a 2020 2020 2020 2020 6368  get().        ch
-0000ea60: 756e 6b73 697a 652c 2063 7374 6172 742c  unksize, cstart,
-0000ea70: 2070 6174 682c 206c 6173 746d 6f64 2c20   path, lastmod, 
-0000ea80: 7370 7273 203d 2072 6573 706f 6e73 650a  sprs = response.
-0000ea90: 0a20 2020 2020 2020 2074 7279 3a0a 2020  .        try:.  
-0000eaa0: 2020 2020 2020 2020 2020 6966 2073 656c            if sel
-0000eab0: 662e 6172 6773 2e6e 773a 0a20 2020 2020  f.args.nw:.     
-0000eac0: 2020 2020 2020 2020 2020 2070 6174 6820             path 
-0000ead0: 3d20 6f73 2e64 6576 6e75 6c6c 0a0a 2020  = os.devnull..  
-0000eae0: 2020 2020 2020 2020 2020 6966 2072 656d            if rem
-0000eaf0: 6169 6e73 203e 2063 6875 6e6b 7369 7a65  ains > chunksize
-0000eb00: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0000eb10: 2020 7261 6973 6520 5065 626b 6163 2834    raise Pebkac(4
-0000eb20: 3030 2c20 2279 6f75 7220 6368 756e 6b20  00, "your chunk 
-0000eb30: 6973 2074 6f6f 2062 6967 2074 6f20 6669  is too big to fi
-0000eb40: 7422 290a 0a20 2020 2020 2020 2020 2020  t")..           
-0000eb50: 2073 656c 662e 6c6f 6728 2277 7269 7469   self.log("writi
-0000eb60: 6e67 207b 7d20 237b 7d20 407b 7d20 6c65  ng {} #{} @{} le
-0000eb70: 6e20 7b7d 222e 666f 726d 6174 2870 6174  n {}".format(pat
-0000eb80: 682c 2063 6861 7368 2c20 6373 7461 7274  h, chash, cstart
-0000eb90: 2c20 7265 6d61 696e 7329 290a 0a20 2020  , remains))..   
-0000eba0: 2020 2020 2020 2020 2072 6561 6465 7220           reader 
-0000ebb0: 3d20 7265 6164 5f73 6f63 6b65 7428 7365  = read_socket(se
-0000ebc0: 6c66 2e73 722c 2072 656d 6169 6e73 290a  lf.sr, remains).
-0000ebd0: 0a20 2020 2020 2020 2020 2020 2066 203d  .            f =
-0000ebe0: 204e 6f6e 650a 2020 2020 2020 2020 2020   None.          
-0000ebf0: 2020 6670 6f6f 6c20 3d20 6e6f 7420 7365    fpool = not se
-0000ec00: 6c66 2e61 7267 732e 6e6f 5f66 706f 6f6c  lf.args.no_fpool
-0000ec10: 2061 6e64 2073 7072 730a 2020 2020 2020   and sprs.      
-0000ec20: 2020 2020 2020 6966 2066 706f 6f6c 3a0a        if fpool:.
-0000ec30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ec40: 7769 7468 2073 656c 662e 6d75 7465 783a  with self.mutex:
-0000ec50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000ec60: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
-0000ec70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ec80: 2020 6620 3d20 7365 6c66 2e75 3266 682e    f = self.u2fh.
-0000ec90: 706f 7028 7061 7468 290a 2020 2020 2020  pop(path).      
-0000eca0: 2020 2020 2020 2020 2020 2020 2020 6578                ex
-0000ecb0: 6365 7074 3a0a 2020 2020 2020 2020 2020  cept:.          
-0000ecc0: 2020 2020 2020 2020 2020 2020 2020 7061                pa
-0000ecd0: 7373 0a0a 2020 2020 2020 2020 2020 2020  ss..            
-0000ece0: 6620 3d20 6620 6f72 206f 7065 6e28 6673  f = f or open(fs
-0000ecf0: 656e 6328 7061 7468 292c 2022 7262 2b22  enc(path), "rb+"
-0000ed00: 2c20 3531 3220 2a20 3130 3234 290a 0a20  , 512 * 1024).. 
-0000ed10: 2020 2020 2020 2020 2020 2074 7279 3a0a             try:.
-0000ed20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ed30: 662e 7365 656b 2863 7374 6172 745b 305d  f.seek(cstart[0]
-0000ed40: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-0000ed50: 2020 706f 7374 5f73 7a2c 205f 2c20 7368    post_sz, _, sh
-0000ed60: 615f 6236 3420 3d20 6861 7368 636f 7079  a_b64 = hashcopy
-0000ed70: 2872 6561 6465 722c 2066 2c20 7365 6c66  (reader, f, self
-0000ed80: 2e61 7267 732e 735f 7772 5f73 6c70 290a  .args.s_wr_slp).
-0000ed90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000eda0: 2069 6620 7368 615f 6236 3420 213d 2063   if sha_b64 != c
-0000edb0: 6861 7368 3a0a 2020 2020 2020 2020 2020  hash:.          
-0000edc0: 2020 2020 2020 2020 2020 7472 793a 0a20            try:. 
-0000edd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ede0: 2020 2020 2020 2073 656c 662e 6261 6b66         self.bakf
-0000edf0: 6c69 7028 662c 2063 7374 6172 745b 305d  lip(f, cstart[0]
-0000ee00: 2c20 706f 7374 5f73 7a2c 2073 6861 5f62  , post_sz, sha_b
-0000ee10: 3634 290a 2020 2020 2020 2020 2020 2020  64).            
-0000ee20: 2020 2020 2020 2020 6578 6365 7074 3a0a          except:.
-0000ee30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ee40: 2020 2020 2020 2020 7365 6c66 2e6c 6f67          self.log
-0000ee50: 2822 6261 6b66 6c69 7020 6661 696c 6564  ("bakflip failed
-0000ee60: 3a20 2220 2b20 6d69 6e5f 6578 2829 290a  : " + min_ex()).
-0000ee70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000ee80: 2020 2020 2074 203d 2022 796f 7572 2063       t = "your c
-0000ee90: 6875 6e6b 2067 6f74 2063 6f72 7275 7074  hunk got corrupt
-0000eea0: 6564 2073 6f6d 6568 6f77 2028 7265 6365  ed somehow (rece
-0000eeb0: 6976 6564 207b 7d20 6279 7465 7329 3b20  ived {} bytes); 
-0000eec0: 6578 7065 6374 6564 2076 7320 7265 6365  expected vs rece
-0000eed0: 6976 6564 2068 6173 683a 5c6e 7b7d 5c6e  ived hash:\n{}\n
-0000eee0: 7b7d 220a 2020 2020 2020 2020 2020 2020  {}".            
-0000eef0: 2020 2020 2020 2020 7261 6973 6520 5065          raise Pe
-0000ef00: 626b 6163 2834 3030 2c20 742e 666f 726d  bkac(400, t.form
-0000ef10: 6174 2870 6f73 745f 737a 2c20 6368 6173  at(post_sz, chas
-0000ef20: 682c 2073 6861 5f62 3634 2929 0a0a 2020  h, sha_b64))..  
-0000ef30: 2020 2020 2020 2020 2020 2020 2020 6966                if
-0000ef40: 206c 656e 2863 7374 6172 7429 203e 2031   len(cstart) > 1
-0000ef50: 2061 6e64 2070 6174 6820 213d 206f 732e   and path != os.
-0000ef60: 6465 766e 756c 6c3a 0a20 2020 2020 2020  devnull:.       
-0000ef70: 2020 2020 2020 2020 2020 2020 2073 656c               sel
-0000ef80: 662e 6c6f 6728 0a20 2020 2020 2020 2020  f.log(.         
-0000ef90: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-0000efa0: 636c 6f6e 6520 7b7d 2074 6f20 7b7d 222e  clone {} to {}".
-0000efb0: 666f 726d 6174 280a 2020 2020 2020 2020  format(.        
-0000efc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000efd0: 2020 2020 6373 7461 7274 5b30 5d2c 2022      cstart[0], "
-0000efe0: 2026 2022 2e6a 6f69 6e28 756e 6963 6f64   & ".join(unicod
-0000eff0: 6528 7829 2066 6f72 2078 2069 6e20 6373  e(x) for x in cs
-0000f000: 7461 7274 5b31 3a5d 290a 2020 2020 2020  tart[1:]).      
-0000f010: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f020: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
-0000f030: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-0000f040: 2020 2020 2020 2020 2020 2020 2020 6f66                of
-0000f050: 7320 3d20 300a 2020 2020 2020 2020 2020  s = 0.          
-0000f060: 2020 2020 2020 2020 2020 7768 696c 6520            while 
-0000f070: 6f66 7320 3c20 6368 756e 6b73 697a 653a  ofs < chunksize:
-0000f080: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000f090: 2020 2020 2020 2020 2062 7566 737a 203d           bufsz =
-0000f0a0: 206d 696e 2863 6875 6e6b 7369 7a65 202d   min(chunksize -
-0000f0b0: 206f 6673 2c20 3420 2a20 3130 3234 202a   ofs, 4 * 1024 *
-0000f0c0: 2031 3032 3429 0a20 2020 2020 2020 2020   1024).         
-0000f0d0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-0000f0e0: 2e73 6565 6b28 6373 7461 7274 5b30 5d20  .seek(cstart[0] 
-0000f0f0: 2b20 6f66 7329 0a20 2020 2020 2020 2020  + ofs).         
-0000f100: 2020 2020 2020 2020 2020 2020 2020 2062                 b
-0000f110: 7566 203d 2066 2e72 6561 6428 6275 6673  uf = f.read(bufs
-0000f120: 7a29 0a20 2020 2020 2020 2020 2020 2020  z).             
-0000f130: 2020 2020 2020 2020 2020 2066 6f72 2077             for w
-0000f140: 6f66 7320 696e 2063 7374 6172 745b 313a  ofs in cstart[1:
-0000f150: 5d3a 0a20 2020 2020 2020 2020 2020 2020  ]:.             
-0000f160: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-0000f170: 2e73 6565 6b28 776f 6673 202b 206f 6673  .seek(wofs + ofs
-0000f180: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-0000f190: 2020 2020 2020 2020 2020 2020 2020 662e                f.
-0000f1a0: 7772 6974 6528 6275 6629 0a0a 2020 2020  write(buf)..    
-0000f1b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f1c0: 2020 2020 6f66 7320 2b3d 206c 656e 2862      ofs += len(b
-0000f1d0: 7566 290a 0a20 2020 2020 2020 2020 2020  uf)..           
-0000f1e0: 2020 2020 2020 2020 2073 656c 662e 6c6f           self.lo
-0000f1f0: 6728 2263 6c6f 6e65 207b 7d20 646f 6e65  g("clone {} done
-0000f200: 222e 666f 726d 6174 2863 7374 6172 745b  ".format(cstart[
-0000f210: 305d 2929 0a0a 2020 2020 2020 2020 2020  0]))..          
-0000f220: 2020 2020 2020 6966 206e 6f74 2066 706f        if not fpo
-0000f230: 6f6c 3a0a 2020 2020 2020 2020 2020 2020  ol:.            
-0000f240: 2020 2020 2020 2020 662e 636c 6f73 6528          f.close(
-0000f250: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-0000f260: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-0000f270: 2020 2020 2020 2020 2020 2020 7769 7468              with
-0000f280: 2073 656c 662e 6d75 7465 783a 0a20 2020   self.mutex:.   
-0000f290: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f2a0: 2020 2020 2073 656c 662e 7532 6668 2e70       self.u2fh.p
-0000f2b0: 7574 2870 6174 682c 2066 290a 2020 2020  ut(path, f).    
-0000f2c0: 2020 2020 2020 2020 6578 6365 7074 3a0a          except:.
-0000f2d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f2e0: 2320 6d61 7962 6520 6275 7374 6564 2068  # maybe busted h
-0000f2f0: 616e 646c 6520 2865 672e 2064 6973 6b20  andle (eg. disk 
-0000f300: 7765 6e74 2066 756c 6c29 0a20 2020 2020  went full).     
-0000f310: 2020 2020 2020 2020 2020 2066 2e63 6c6f             f.clo
-0000f320: 7365 2829 0a20 2020 2020 2020 2020 2020  se().           
-0000f330: 2020 2020 2072 6169 7365 0a20 2020 2020       raise.     
-0000f340: 2020 2066 696e 616c 6c79 3a0a 2020 2020     finally:.    
-0000f350: 2020 2020 2020 2020 7820 3d20 7365 6c66          x = self
-0000f360: 2e63 6f6e 6e2e 6873 7276 2e62 726f 6b65  .conn.hsrv.broke
-0000f370: 722e 6173 6b28 2275 7032 6b2e 7265 6c65  r.ask("up2k.rele
-0000f380: 6173 655f 6368 756e 6b22 2c20 7074 6f70  ase_chunk", ptop
-0000f390: 2c20 7761 726b 2c20 6368 6173 6829 0a20  , wark, chash). 
-0000f3a0: 2020 2020 2020 2020 2020 2078 2e67 6574             x.get
-0000f3b0: 2829 2020 2320 626c 6f63 6b20 636c 6965  ()  # block clie
-0000f3c0: 6e74 2075 6e74 696c 2072 656c 6561 7365  nt until release
-0000f3d0: 640a 0a20 2020 2020 2020 2078 203d 2073  d..        x = s
-0000f3e0: 656c 662e 636f 6e6e 2e68 7372 762e 6272  elf.conn.hsrv.br
-0000f3f0: 6f6b 6572 2e61 736b 2822 7570 326b 2e63  oker.ask("up2k.c
-0000f400: 6f6e 6669 726d 5f63 6875 6e6b 222c 2070  onfirm_chunk", p
-0000f410: 746f 702c 2077 6172 6b2c 2063 6861 7368  top, wark, chash
-0000f420: 290a 2020 2020 2020 2020 7a74 6973 203d  ).        ztis =
-0000f430: 2078 2e67 6574 2829 0a20 2020 2020 2020   x.get().       
-0000f440: 2074 7279 3a0a 2020 2020 2020 2020 2020   try:.          
-0000f450: 2020 6e75 6d5f 6c65 6674 2c20 6669 6e5f    num_left, fin_
-0000f460: 7061 7468 203d 207a 7469 730a 2020 2020  path = ztis.    
-0000f470: 2020 2020 6578 6365 7074 3a0a 2020 2020      except:.    
-0000f480: 2020 2020 2020 2020 7365 6c66 2e6c 6f75          self.lou
-0000f490: 645f 7265 706c 7928 7a74 6973 2c20 7374  d_reply(ztis, st
-0000f4a0: 6174 7573 3d35 3030 290a 2020 2020 2020  atus=500).      
-0000f4b0: 2020 2020 2020 7265 7475 726e 2046 616c        return Fal
-0000f4c0: 7365 0a0a 2020 2020 2020 2020 6966 206e  se..        if n
-0000f4d0: 6f74 206e 756d 5f6c 6566 7420 616e 6420  ot num_left and 
-0000f4e0: 6670 6f6f 6c3a 0a20 2020 2020 2020 2020  fpool:.         
-0000f4f0: 2020 2077 6974 6820 7365 6c66 2e6d 7574     with self.mut
-0000f500: 6578 3a0a 2020 2020 2020 2020 2020 2020  ex:.            
-0000f510: 2020 2020 7365 6c66 2e75 3266 682e 636c      self.u2fh.cl
-0000f520: 6f73 6528 7061 7468 290a 0a20 2020 2020  ose(path)..     
-0000f530: 2020 2069 6620 6e6f 7420 6e75 6d5f 6c65     if not num_le
-0000f540: 6674 2061 6e64 206e 6f74 2073 656c 662e  ft and not self.
-0000f550: 6172 6773 2e6e 773a 0a20 2020 2020 2020  args.nw:.       
-0000f560: 2020 2020 2073 656c 662e 636f 6e6e 2e68       self.conn.h
-0000f570: 7372 762e 6272 6f6b 6572 2e61 736b 280a  srv.broker.ask(.
-0000f580: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f590: 2275 7032 6b2e 6669 6e69 7368 5f75 706c  "up2k.finish_upl
-0000f5a0: 6f61 6422 2c20 7074 6f70 2c20 7761 726b  oad", ptop, wark
-0000f5b0: 2c20 7365 6c66 2e75 3266 682e 6170 730a  , self.u2fh.aps.
-0000f5c0: 2020 2020 2020 2020 2020 2020 292e 6765              ).ge
-0000f5d0: 7428 290a 0a20 2020 2020 2020 2063 696e  t()..        cin
-0000f5e0: 6620 3d20 7365 6c66 2e68 6561 6465 7273  f = self.headers
-0000f5f0: 2e67 6574 2822 782d 7570 326b 2d73 7461  .get("x-up2k-sta
-0000f600: 7422 2c20 2222 290a 0a20 2020 2020 2020  t", "")..       
-0000f610: 2073 7064 203d 2073 656c 662e 5f73 7064   spd = self._spd
-0000f620: 2870 6f73 745f 737a 290a 2020 2020 2020  (post_sz).      
-0000f630: 2020 7365 6c66 2e6c 6f67 2822 7b3a 3730    self.log("{:70
-0000f640: 7d20 7468 616e 6b20 7b7d 222e 666f 726d  } thank {}".form
-0000f650: 6174 2873 7064 2c20 6369 6e66 2929 0a20  at(spd, cinf)). 
-0000f660: 2020 2020 2020 2073 656c 662e 7265 706c         self.repl
-0000f670: 7928 6222 7468 616e 6b22 290a 2020 2020  y(b"thank").    
-0000f680: 2020 2020 7265 7475 726e 2054 7275 650a      return True.
-0000f690: 0a20 2020 2064 6566 2068 616e 646c 655f  .    def handle_
-0000f6a0: 6c6f 6769 6e28 7365 6c66 2920 203a 0a20  login(self)  :. 
-0000f6b0: 2020 2020 2020 2061 7373 6572 7420 7365         assert se
-0000f6c0: 6c66 2e70 6172 7365 720a 2020 2020 2020  lf.parser.      
-0000f6d0: 2020 7077 6420 3d20 7365 6c66 2e70 6172    pwd = self.par
-0000f6e0: 7365 722e 7265 7175 6972 6528 2263 7070  ser.require("cpp
-0000f6f0: 7764 222c 2036 3429 0a20 2020 2020 2020  wd", 64).       
-0000f700: 2073 656c 662e 7061 7273 6572 2e64 726f   self.parser.dro
-0000f710: 7028 290a 0a20 2020 2020 2020 2073 656c  p()..        sel
-0000f720: 662e 6f75 745f 6865 6164 6572 6c69 7374  f.out_headerlist
-0000f730: 203d 205b 0a20 2020 2020 2020 2020 2020   = [.           
-0000f740: 2078 2066 6f72 2078 2069 6e20 7365 6c66   x for x in self
-0000f750: 2e6f 7574 5f68 6561 6465 726c 6973 7420  .out_headerlist 
-0000f760: 6966 2078 5b30 5d20 213d 2022 5365 742d  if x[0] != "Set-
-0000f770: 436f 6f6b 6965 2220 6f72 2022 6370 7077  Cookie" or "cppw
-0000f780: 2220 213d 2078 5b31 5d5b 3a34 5d0a 2020  " != x[1][:4].  
-0000f790: 2020 2020 2020 5d0a 0a20 2020 2020 2020        ]..       
-0000f7a0: 2064 7374 203d 2073 656c 662e 6172 6773   dst = self.args
-0000f7b0: 2e53 5253 0a20 2020 2020 2020 2069 6620  .SRS.        if 
-0000f7c0: 7365 6c66 2e76 7061 7468 3a0a 2020 2020  self.vpath:.    
-0000f7d0: 2020 2020 2020 2020 6473 7420 2b3d 2071          dst += q
-0000f7e0: 756f 7465 7028 7365 6c66 2e76 7061 7468  uotep(self.vpath
-0000f7f0: 290a 0a20 2020 2020 2020 206d 7367 203d  )..        msg =
-0000f800: 2073 656c 662e 6765 745f 7077 645f 636f   self.get_pwd_co
-0000f810: 6f6b 6965 2870 7764 290a 2020 2020 2020  okie(pwd).      
-0000f820: 2020 6874 6d6c 203d 2073 656c 662e 6a32    html = self.j2
-0000f830: 7328 226d 7367 222c 2068 313d 6d73 672c  s("msg", h1=msg,
-0000f840: 2068 323d 273c 6120 6872 6566 3d22 2720   h2='<a href="' 
-0000f850: 2b20 6473 7420 2b20 2722 3e61 636b 3c2f  + dst + '">ack</
-0000f860: 613e 272c 2072 6564 6972 3d64 7374 290a  a>', redir=dst).
-0000f870: 2020 2020 2020 2020 7365 6c66 2e72 6570          self.rep
-0000f880: 6c79 2868 746d 6c2e 656e 636f 6465 2822  ly(html.encode("
-0000f890: 7574 662d 3822 2929 0a20 2020 2020 2020  utf-8")).       
-0000f8a0: 2072 6574 7572 6e20 5472 7565 0a0a 2020   return True..  
-0000f8b0: 2020 6465 6620 6765 745f 7077 645f 636f    def get_pwd_co
-0000f8c0: 6f6b 6965 2873 656c 662c 2070 7764 2029  okie(self, pwd )
-0000f8d0: 2020 3a0a 2020 2020 2020 2020 6966 2070    :.        if p
-0000f8e0: 7764 2069 6e20 7365 6c66 2e61 7372 762e  wd in self.asrv.
-0000f8f0: 6961 6363 743a 0a20 2020 2020 2020 2020  iacct:.         
-0000f900: 2020 206d 7367 203d 2022 6c6f 6769 6e20     msg = "login 
-0000f910: 6f6b 220a 2020 2020 2020 2020 2020 2020  ok".            
-0000f920: 6475 7220 3d20 696e 7428 3630 202a 2036  dur = int(60 * 6
-0000f930: 3020 2a20 7365 6c66 2e61 7267 732e 6c6f  0 * self.args.lo
-0000f940: 676f 7574 290a 2020 2020 2020 2020 656c  gout).        el
-0000f950: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-0000f960: 7365 6c66 2e6c 6f67 2822 696e 7661 6c69  self.log("invali
-0000f970: 6420 7061 7373 776f 7264 3a20 7b7d 222e  d password: {}".
-0000f980: 666f 726d 6174 2870 7764 292c 2033 290a  format(pwd), 3).
-0000f990: 2020 2020 2020 2020 2020 2020 6720 3d20              g = 
-0000f9a0: 7365 6c66 2e63 6f6e 6e2e 6873 7276 2e67  self.conn.hsrv.g
-0000f9b0: 7077 640a 2020 2020 2020 2020 2020 2020  pwd.            
-0000f9c0: 6966 2067 2e6c 696d 3a0a 2020 2020 2020  if g.lim:.      
-0000f9d0: 2020 2020 2020 2020 2020 626f 6e6b 2c20            bonk, 
-0000f9e0: 6970 203d 2067 2e62 6f6e 6b28 7365 6c66  ip = g.bonk(self
-0000f9f0: 2e69 702c 2070 7764 290a 2020 2020 2020  .ip, pwd).      
-0000fa00: 2020 2020 2020 2020 2020 6966 2062 6f6e            if bon
-0000fa10: 6b3a 0a20 2020 2020 2020 2020 2020 2020  k:.             
-0000fa20: 2020 2020 2020 2073 656c 662e 6c6f 6728         self.log(
-0000fa30: 2263 6c69 656e 7420 6261 6e6e 6564 3a20  "client banned: 
-0000fa40: 696e 7661 6c69 6420 7061 7373 776f 7264  invalid password
-0000fa50: 7322 2c20 3129 0a20 2020 2020 2020 2020  s", 1).         
-0000fa60: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-0000fa70: 636f 6e6e 2e68 7372 762e 6261 6e73 5b69  conn.hsrv.bans[i
-0000fa80: 705d 203d 2062 6f6e 6b0a 0a20 2020 2020  p] = bonk..     
-0000fa90: 2020 2020 2020 206d 7367 203d 2022 6e61         msg = "na
-0000faa0: 7720 6475 6465 220a 2020 2020 2020 2020  w dude".        
-0000fab0: 2020 2020 7077 6420 3d20 2278 2220 2023      pwd = "x"  #
-0000fac0: 206e 6f73 6563 0a20 2020 2020 2020 2020   nosec.         
-0000fad0: 2020 2064 7572 203d 204e 6f6e 650a 0a20     dur = None.. 
-0000fae0: 2020 2020 2020 2069 6620 7077 6420 3d3d         if pwd ==
-0000faf0: 2022 7822 3a0a 2020 2020 2020 2020 2020   "x":.          
-0000fb00: 2020 2320 7265 7365 7420 626f 7468 2070    # reset both p
-0000fb10: 6c61 696e 7465 7874 2061 6e64 2074 6c73  laintext and tls
-0000fb20: 0a20 2020 2020 2020 2020 2020 2023 2028  .            # (
-0000fb30: 6f6e 6c79 2061 6666 6563 7473 2061 6374  only affects act
-0000fb40: 6976 6520 746c 7320 636f 6f6b 6965 7320  ive tls cookies 
-0000fb50: 7768 656e 2074 6c73 290a 2020 2020 2020  when tls).      
-0000fb60: 2020 2020 2020 666f 7220 6b20 696e 2028        for k in (
-0000fb70: 2263 7070 7764 222c 2022 6370 7077 7322  "cppwd", "cppws"
-0000fb80: 2920 6966 2073 656c 662e 6973 5f68 7474  ) if self.is_htt
-0000fb90: 7073 2065 6c73 6520 2822 6370 7077 6422  ps else ("cppwd"
-0000fba0: 2c29 3a0a 2020 2020 2020 2020 2020 2020  ,):.            
-0000fbb0: 2020 2020 636b 203d 2067 656e 636f 6f6b      ck = gencook
-0000fbc0: 6965 286b 2c20 7077 642c 2073 656c 662e  ie(k, pwd, self.
-0000fbd0: 6172 6773 2e52 2c20 4661 6c73 652c 2064  args.R, False, d
-0000fbe0: 7572 290a 2020 2020 2020 2020 2020 2020  ur).            
-0000fbf0: 2020 2020 7365 6c66 2e6f 7574 5f68 6561      self.out_hea
-0000fc00: 6465 726c 6973 742e 6170 7065 6e64 2828  derlist.append((
-0000fc10: 2253 6574 2d43 6f6f 6b69 6522 2c20 636b  "Set-Cookie", ck
-0000fc20: 2929 0a20 2020 2020 2020 2065 6c73 653a  )).        else:
-0000fc30: 0a20 2020 2020 2020 2020 2020 206b 203d  .            k =
-0000fc40: 2022 6370 7077 7322 2069 6620 7365 6c66   "cppws" if self
-0000fc50: 2e69 735f 6874 7470 7320 656c 7365 2022  .is_https else "
-0000fc60: 6370 7077 6422 0a20 2020 2020 2020 2020  cppwd".         
-0000fc70: 2020 2063 6b20 3d20 6765 6e63 6f6f 6b69     ck = gencooki
-0000fc80: 6528 6b2c 2070 7764 2c20 7365 6c66 2e61  e(k, pwd, self.a
-0000fc90: 7267 732e 522c 2073 656c 662e 6973 5f68  rgs.R, self.is_h
-0000fca0: 7474 7073 2c20 6475 7229 0a20 2020 2020  ttps, dur).     
-0000fcb0: 2020 2020 2020 2073 656c 662e 6f75 745f         self.out_
-0000fcc0: 6865 6164 6572 6c69 7374 2e61 7070 656e  headerlist.appen
-0000fcd0: 6428 2822 5365 742d 436f 6f6b 6965 222c  d(("Set-Cookie",
-0000fce0: 2063 6b29 290a 0a20 2020 2020 2020 2072   ck))..        r
-0000fcf0: 6574 7572 6e20 6d73 670a 0a20 2020 2064  eturn msg..    d
-0000fd00: 6566 2068 616e 646c 655f 6d6b 6469 7228  ef handle_mkdir(
-0000fd10: 7365 6c66 2920 203a 0a20 2020 2020 2020  self)  :.       
-0000fd20: 2061 7373 6572 7420 7365 6c66 2e70 6172   assert self.par
-0000fd30: 7365 720a 2020 2020 2020 2020 6e65 775f  ser.        new_
-0000fd40: 6469 7220 3d20 7365 6c66 2e70 6172 7365  dir = self.parse
-0000fd50: 722e 7265 7175 6972 6528 226e 616d 6522  r.require("name"
-0000fd60: 2c20 3531 3229 0a20 2020 2020 2020 2073  , 512).        s
-0000fd70: 656c 662e 7061 7273 6572 2e64 726f 7028  elf.parser.drop(
-0000fd80: 290a 0a20 2020 2020 2020 2073 616e 6974  )..        sanit
-0000fd90: 697a 6564 203d 2073 616e 6974 697a 655f  ized = sanitize_
-0000fda0: 666e 286e 6577 5f64 6972 2c20 2222 2c20  fn(new_dir, "", 
-0000fdb0: 5b5d 290a 2020 2020 2020 2020 7265 7475  []).        retu
-0000fdc0: 726e 2073 656c 662e 5f6d 6b64 6972 2876  rn self._mkdir(v
-0000fdd0: 6a6f 696e 2873 656c 662e 7670 6174 682c  join(self.vpath,
-0000fde0: 2073 616e 6974 697a 6564 2929 0a0a 2020   sanitized))..  
-0000fdf0: 2020 6465 6620 5f6d 6b64 6972 2873 656c    def _mkdir(sel
-0000fe00: 662c 2076 7061 7468 202c 2064 6176 2020  f, vpath , dav  
-0000fe10: 3d20 4661 6c73 6529 2020 3a0a 2020 2020  = False)  :.    
-0000fe20: 2020 2020 6e75 6c6c 7772 6974 6520 3d20      nullwrite = 
-0000fe30: 7365 6c66 2e61 7267 732e 6e77 0a20 2020  self.args.nw.   
-0000fe40: 2020 2020 2076 6673 2c20 7265 6d20 3d20       vfs, rem = 
-0000fe50: 7365 6c66 2e61 7372 762e 7666 732e 6765  self.asrv.vfs.ge
-0000fe60: 7428 7670 6174 682c 2073 656c 662e 756e  t(vpath, self.un
-0000fe70: 616d 652c 2046 616c 7365 2c20 5472 7565  ame, False, True
-0000fe80: 290a 2020 2020 2020 2020 7365 6c66 2e5f  ).        self._
-0000fe90: 6173 7365 7274 5f73 6166 655f 7265 6d28  assert_safe_rem(
-0000fea0: 7265 6d29 0a20 2020 2020 2020 2066 6e20  rem).        fn 
-0000feb0: 3d20 7666 732e 6361 6e6f 6e69 6361 6c28  = vfs.canonical(
-0000fec0: 7265 6d29 0a0a 2020 2020 2020 2020 6966  rem)..        if
-0000fed0: 206e 6f74 206e 756c 6c77 7269 7465 3a0a   not nullwrite:.
-0000fee0: 2020 2020 2020 2020 2020 2020 6664 6972              fdir
-0000fef0: 203d 206f 732e 7061 7468 2e64 6972 6e61   = os.path.dirna
-0000ff00: 6d65 2866 6e29 0a0a 2020 2020 2020 2020  me(fn)..        
-0000ff10: 2020 2020 6966 206e 6f74 2062 6f73 2e70      if not bos.p
-0000ff20: 6174 682e 6973 6469 7228 6664 6972 293a  ath.isdir(fdir):
-0000ff30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000ff40: 2072 6169 7365 2050 6562 6b61 6328 3430   raise Pebkac(40
-0000ff50: 392c 2022 7061 7265 6e74 2066 6f6c 6465  9, "parent folde
-0000ff60: 7220 646f 6573 206e 6f74 2065 7869 7374  r does not exist
-0000ff70: 2229 0a0a 2020 2020 2020 2020 2020 2020  ")..            
-0000ff80: 6966 2062 6f73 2e70 6174 682e 6973 6469  if bos.path.isdi
-0000ff90: 7228 666e 293a 0a20 2020 2020 2020 2020  r(fn):.         
-0000ffa0: 2020 2020 2020 2072 6169 7365 2050 6562         raise Peb
-0000ffb0: 6b61 6328 3430 352c 2022 7468 6174 2066  kac(405, "that f
-0000ffc0: 6f6c 6465 7220 6578 6973 7473 2061 6c72  older exists alr
-0000ffd0: 6561 6479 2229 0a0a 2020 2020 2020 2020  eady")..        
-0000ffe0: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
-0000fff0: 2020 2020 2020 2020 2062 6f73 2e6d 6b64           bos.mkd
-00010000: 6972 2866 6e29 0a20 2020 2020 2020 2020  ir(fn).         
-00010010: 2020 2065 7863 6570 7420 4f53 4572 726f     except OSErro
-00010020: 7220 6173 2065 783a 0a20 2020 2020 2020  r as ex:.       
-00010030: 2020 2020 2020 2020 2069 6620 6578 2e65           if ex.e
-00010040: 7272 6e6f 203d 3d20 6572 726e 6f2e 4541  rrno == errno.EA
-00010050: 4343 4553 3a0a 2020 2020 2020 2020 2020  CCES:.          
-00010060: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
-00010070: 5065 626b 6163 2835 3030 2c20 2274 6865  Pebkac(500, "the
-00010080: 2073 6572 7665 7220 4f53 2064 656e 6965   server OS denie
-00010090: 6420 7772 6974 652d 6163 6365 7373 2229  d write-access")
-000100a0: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-000100b0: 2020 7261 6973 6520 5065 626b 6163 2835    raise Pebkac(5
-000100c0: 3030 2c20 226d 6b64 6972 2066 6169 6c65  00, "mkdir faile
-000100d0: 643a 5c6e 2220 2b20 6d69 6e5f 6578 2829  d:\n" + min_ex()
-000100e0: 290a 2020 2020 2020 2020 2020 2020 6578  ).            ex
-000100f0: 6365 7074 3a0a 2020 2020 2020 2020 2020  cept:.          
-00010100: 2020 2020 2020 7261 6973 6520 5065 626b        raise Pebk
-00010110: 6163 2835 3030 2c20 6d69 6e5f 6578 2829  ac(500, min_ex()
-00010120: 290a 0a20 2020 2020 2020 2073 656c 662e  )..        self.
-00010130: 6f75 745f 6865 6164 6572 735b 2258 2d4e  out_headers["X-N
-00010140: 6577 2d44 6972 225d 203d 2071 756f 7465  ew-Dir"] = quote
-00010150: 7028 7670 6174 682e 7370 6c69 7428 222f  p(vpath.split("/
-00010160: 2229 5b2d 315d 290a 0a20 2020 2020 2020  ")[-1])..       
-00010170: 2069 6620 6461 763a 0a20 2020 2020 2020   if dav:.       
-00010180: 2020 2020 2073 656c 662e 7265 706c 7928       self.reply(
-00010190: 6222 222c 2032 3031 290a 2020 2020 2020  b"", 201).      
-000101a0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-000101b0: 2020 2020 7365 6c66 2e72 6564 6972 6563      self.redirec
-000101c0: 7428 7670 6174 682c 2073 7461 7475 733d  t(vpath, status=
-000101d0: 3230 3129 0a0a 2020 2020 2020 2020 7265  201)..        re
-000101e0: 7475 726e 2054 7275 650a 0a20 2020 2064  turn True..    d
-000101f0: 6566 2068 616e 646c 655f 6e65 775f 6d64  ef handle_new_md
-00010200: 2873 656c 6629 2020 3a0a 2020 2020 2020  (self)  :.      
-00010210: 2020 6173 7365 7274 2073 656c 662e 7061    assert self.pa
-00010220: 7273 6572 0a20 2020 2020 2020 206e 6577  rser.        new
-00010230: 5f66 696c 6520 3d20 7365 6c66 2e70 6172  _file = self.par
-00010240: 7365 722e 7265 7175 6972 6528 226e 616d  ser.require("nam
-00010250: 6522 2c20 3531 3229 0a20 2020 2020 2020  e", 512).       
-00010260: 2073 656c 662e 7061 7273 6572 2e64 726f   self.parser.dro
-00010270: 7028 290a 0a20 2020 2020 2020 206e 756c  p()..        nul
-00010280: 6c77 7269 7465 203d 2073 656c 662e 6172  lwrite = self.ar
-00010290: 6773 2e6e 770a 2020 2020 2020 2020 7666  gs.nw.        vf
-000102a0: 732c 2072 656d 203d 2073 656c 662e 6173  s, rem = self.as
-000102b0: 7276 2e76 6673 2e67 6574 2873 656c 662e  rv.vfs.get(self.
-000102c0: 7670 6174 682c 2073 656c 662e 756e 616d  vpath, self.unam
-000102d0: 652c 2046 616c 7365 2c20 5472 7565 290a  e, False, True).
-000102e0: 2020 2020 2020 2020 7365 6c66 2e5f 6173          self._as
-000102f0: 7365 7274 5f73 6166 655f 7265 6d28 7265  sert_safe_rem(re
-00010300: 6d29 0a0a 2020 2020 2020 2020 6966 206e  m)..        if n
-00010310: 6f74 206e 6577 5f66 696c 652e 656e 6473  ot new_file.ends
-00010320: 7769 7468 2822 2e6d 6422 293a 0a20 2020  with(".md"):.   
-00010330: 2020 2020 2020 2020 206e 6577 5f66 696c           new_fil
-00010340: 6520 2b3d 2022 2e6d 6422 0a0a 2020 2020  e += ".md"..    
-00010350: 2020 2020 7361 6e69 7469 7a65 6420 3d20      sanitized = 
-00010360: 7361 6e69 7469 7a65 5f66 6e28 6e65 775f  sanitize_fn(new_
-00010370: 6669 6c65 2c20 2222 2c20 5b5d 290a 0a20  file, "", []).. 
-00010380: 2020 2020 2020 2069 6620 6e6f 7420 6e75         if not nu
-00010390: 6c6c 7772 6974 653a 0a20 2020 2020 2020  llwrite:.       
-000103a0: 2020 2020 2066 6469 7220 3d20 7666 732e       fdir = vfs.
-000103b0: 6361 6e6f 6e69 6361 6c28 7265 6d29 0a20  canonical(rem). 
-000103c0: 2020 2020 2020 2020 2020 2066 6e20 3d20             fn = 
-000103d0: 6f73 2e70 6174 682e 6a6f 696e 2866 6469  os.path.join(fdi
-000103e0: 722c 2073 616e 6974 697a 6564 290a 0a20  r, sanitized).. 
-000103f0: 2020 2020 2020 2020 2020 2069 6620 626f             if bo
-00010400: 732e 7061 7468 2e65 7869 7374 7328 666e  s.path.exists(fn
-00010410: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-00010420: 2020 2072 6169 7365 2050 6562 6b61 6328     raise Pebkac(
-00010430: 3530 302c 2022 7468 6174 2066 696c 6520  500, "that file 
-00010440: 6578 6973 7473 2061 6c72 6561 6479 2229  exists already")
-00010450: 0a0a 2020 2020 2020 2020 2020 2020 7769  ..            wi
-00010460: 7468 206f 7065 6e28 6673 656e 6328 666e  th open(fsenc(fn
-00010470: 292c 2022 7762 2229 2061 7320 663a 0a20  ), "wb") as f:. 
-00010480: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00010490: 2e77 7269 7465 2862 2260 4752 554e 4e55  .write(b"`GRUNNU
-000104a0: 5260 5c6e 2229 0a0a 2020 2020 2020 2020  R`\n")..        
-000104b0: 7670 6174 6820 3d20 227b 7d2f 7b7d 222e  vpath = "{}/{}".
-000104c0: 666f 726d 6174 2873 656c 662e 7670 6174  format(self.vpat
-000104d0: 682c 2073 616e 6974 697a 6564 292e 6c73  h, sanitized).ls
-000104e0: 7472 6970 2822 2f22 290a 2020 2020 2020  trip("/").      
-000104f0: 2020 7365 6c66 2e72 6564 6972 6563 7428    self.redirect(
-00010500: 7670 6174 682c 2022 3f65 6469 7422 290a  vpath, "?edit").
-00010510: 2020 2020 2020 2020 7265 7475 726e 2054          return T
-00010520: 7275 650a 0a20 2020 2064 6566 2075 706c  rue..    def upl
-00010530: 6f61 645f 666c 6167 7328 7365 6c66 2c20  oad_flags(self, 
-00010540: 7666 7320 2920 2020 2020 203a 0a20 2020  vfs )      :.   
-00010550: 2020 2020 2069 6620 7365 6c66 2e61 7267       if self.arg
-00010560: 732e 6e77 3a0a 2020 2020 2020 2020 2020  s.nw:.          
-00010570: 2020 726e 6420 3d20 300a 2020 2020 2020    rnd = 0.      
-00010580: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-00010590: 2020 2020 726e 6420 3d20 696e 7428 7365      rnd = int(se
-000105a0: 6c66 2e75 7061 7261 6d2e 6765 7428 2272  lf.uparam.get("r
-000105b0: 616e 6422 2920 6f72 2073 656c 662e 6865  and") or self.he
-000105c0: 6164 6572 732e 6765 7428 2272 616e 6422  aders.get("rand"
-000105d0: 2920 6f72 2030 290a 2020 2020 2020 2020  ) or 0).        
-000105e0: 2020 2020 6966 2076 6673 2e66 6c61 6773      if vfs.flags
-000105f0: 2e67 6574 2822 7261 6e64 2229 3a20 2023  .get("rand"):  #
-00010600: 2066 6f72 6365 2d65 6e61 626c 650a 2020   force-enable.  
-00010610: 2020 2020 2020 2020 2020 2020 2020 726e                rn
-00010620: 6420 3d20 6d61 7828 726e 642c 2076 6673  d = max(rnd, vfs
-00010630: 2e66 6c61 6773 5b22 6e72 616e 6422 5d29  .flags["nrand"])
-00010640: 0a0a 2020 2020 2020 2020 6163 203d 2073  ..        ac = s
-00010650: 656c 662e 7570 6172 616d 2e67 6574 280a  elf.uparam.get(.
-00010660: 2020 2020 2020 2020 2020 2020 2277 616e              "wan
-00010670: 7422 2c20 7365 6c66 2e68 6561 6465 7273  t", self.headers
-00010680: 2e67 6574 2822 6163 6365 7074 222c 2022  .get("accept", "
-00010690: 2229 2e6c 6f77 6572 2829 2e73 706c 6974  ").lower().split
-000106a0: 2822 3b22 295b 2d31 5d0a 2020 2020 2020  (";")[-1].      
-000106b0: 2020 290a 2020 2020 2020 2020 7761 6e74    ).        want
-000106c0: 5f75 726c 203d 2061 6320 3d3d 2022 7572  _url = ac == "ur
-000106d0: 6c22 0a20 2020 2020 2020 207a 7320 3d20  l".        zs = 
-000106e0: 7365 6c66 2e75 7061 7261 6d2e 6765 7428  self.uparam.get(
-000106f0: 226c 6966 6522 2c20 7365 6c66 2e68 6561  "life", self.hea
-00010700: 6465 7273 2e67 6574 2822 6c69 6665 222c  ders.get("life",
-00010710: 2022 2229 290a 2020 2020 2020 2020 6966   "")).        if
-00010720: 207a 733a 0a20 2020 2020 2020 2020 2020   zs:.           
-00010730: 2076 6c69 6665 203d 2076 6673 2e66 6c61   vlife = vfs.fla
-00010740: 6773 2e67 6574 2822 6c69 6665 7469 6d65  gs.get("lifetime
-00010750: 2229 206f 7220 300a 2020 2020 2020 2020  ") or 0.        
-00010760: 2020 2020 6c69 6665 7469 6d65 203d 206d      lifetime = m
-00010770: 6178 2830 2c20 696e 7428 766c 6966 6520  ax(0, int(vlife 
-00010780: 2d20 696e 7428 7a73 2929 290a 2020 2020  - int(zs))).    
-00010790: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-000107a0: 2020 2020 2020 6c69 6665 7469 6d65 203d        lifetime =
-000107b0: 2030 0a0a 2020 2020 2020 2020 7265 7475   0..        retu
-000107c0: 726e 2028 0a20 2020 2020 2020 2020 2020  rn (.           
-000107d0: 2072 6e64 2c0a 2020 2020 2020 2020 2020   rnd,.          
-000107e0: 2020 7761 6e74 5f75 726c 2c0a 2020 2020    want_url,.    
-000107f0: 2020 2020 2020 2020 6c69 6665 7469 6d65          lifetime
-00010800: 2c0a 2020 2020 2020 2020 2020 2020 7666  ,.            vf
-00010810: 732e 666c 6167 732e 6765 7428 2278 6275  s.flags.get("xbu
-00010820: 2229 206f 7220 5b5d 2c0a 2020 2020 2020  ") or [],.      
-00010830: 2020 2020 2020 7666 732e 666c 6167 732e        vfs.flags.
-00010840: 6765 7428 2278 6175 2229 206f 7220 5b5d  get("xau") or []
-00010850: 2c0a 2020 2020 2020 2020 290a 0a20 2020  ,.        )..   
-00010860: 2064 6566 2068 616e 646c 655f 706c 6169   def handle_plai
-00010870: 6e5f 7570 6c6f 6164 2873 656c 6629 2020  n_upload(self)  
-00010880: 3a0a 2020 2020 2020 2020 6173 7365 7274  :.        assert
-00010890: 2073 656c 662e 7061 7273 6572 0a20 2020   self.parser.   
-000108a0: 2020 2020 206e 756c 6c77 7269 7465 203d       nullwrite =
-000108b0: 2073 656c 662e 6172 6773 2e6e 770a 2020   self.args.nw.  
-000108c0: 2020 2020 2020 7666 732c 2072 656d 203d        vfs, rem =
-000108d0: 2073 656c 662e 6173 7276 2e76 6673 2e67   self.asrv.vfs.g
-000108e0: 6574 2873 656c 662e 7670 6174 682c 2073  et(self.vpath, s
-000108f0: 656c 662e 756e 616d 652c 2046 616c 7365  elf.uname, False
-00010900: 2c20 5472 7565 290a 2020 2020 2020 2020  , True).        
-00010910: 7365 6c66 2e5f 6173 7365 7274 5f73 6166  self._assert_saf
-00010920: 655f 7265 6d28 7265 6d29 0a0a 2020 2020  e_rem(rem)..    
-00010930: 2020 2020 7570 6c6f 6164 5f76 7061 7468      upload_vpath
-00010940: 203d 2073 656c 662e 7670 6174 680a 2020   = self.vpath.  
-00010950: 2020 2020 2020 6c69 6d20 3d20 7666 732e        lim = vfs.
-00010960: 6765 745f 6462 7628 7265 6d29 5b30 5d2e  get_dbv(rem)[0].
-00010970: 6c69 6d0a 2020 2020 2020 2020 6664 6972  lim.        fdir
-00010980: 5f62 6173 6520 3d20 7666 732e 6361 6e6f  _base = vfs.cano
-00010990: 6e69 6361 6c28 7265 6d29 0a20 2020 2020  nical(rem).     
-000109a0: 2020 2069 6620 6c69 6d3a 0a20 2020 2020     if lim:.     
-000109b0: 2020 2020 2020 2066 6469 725f 6261 7365         fdir_base
-000109c0: 2c20 7265 6d20 3d20 6c69 6d2e 616c 6c28  , rem = lim.all(
-000109d0: 7365 6c66 2e69 702c 2072 656d 2c20 2d31  self.ip, rem, -1
-000109e0: 2c20 6664 6972 5f62 6173 6529 0a20 2020  , fdir_base).   
-000109f0: 2020 2020 2020 2020 2075 706c 6f61 645f           upload_
-00010a00: 7670 6174 6820 3d20 227b 7d2f 7b7d 222e  vpath = "{}/{}".
-00010a10: 666f 726d 6174 2876 6673 2e76 7061 7468  format(vfs.vpath
-00010a20: 2c20 7265 6d29 2e73 7472 6970 2822 2f22  , rem).strip("/"
-00010a30: 290a 2020 2020 2020 2020 2020 2020 6966  ).            if
-00010a40: 206e 6f74 206e 756c 6c77 7269 7465 3a0a   not nullwrite:.
-00010a50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010a60: 626f 732e 6d61 6b65 6469 7273 2866 6469  bos.makedirs(fdi
-00010a70: 725f 6261 7365 290a 0a20 2020 2020 2020  r_base)..       
-00010a80: 2072 6e64 2c20 7761 6e74 5f75 726c 2c20   rnd, want_url, 
-00010a90: 6c69 6665 7469 6d65 2c20 7862 752c 2078  lifetime, xbu, x
-00010aa0: 6175 203d 2073 656c 662e 7570 6c6f 6164  au = self.upload
-00010ab0: 5f66 6c61 6773 2876 6673 290a 0a20 2020  _flags(vfs)..   
-00010ac0: 2020 2020 2066 696c 6573 2020 2020 2020       files      
-00010ad0: 203d 205b 5d0a 2020 2020 2020 2020 2320   = [].        # 
-00010ae0: 737a 2c20 7368 615f 6865 782c 2073 6861  sz, sha_hex, sha
-00010af0: 5f62 3634 2c20 705f 6669 6c65 2c20 666e  _b64, p_file, fn
-00010b00: 616d 652c 2061 6273 7061 7468 0a20 2020  ame, abspath.   
-00010b10: 2020 2020 2065 7272 6d73 6720 3d20 2222       errmsg = ""
-00010b20: 0a20 2020 2020 2020 2064 6970 203d 2073  .        dip = s
-00010b30: 656c 662e 6469 7028 290a 2020 2020 2020  elf.dip().      
-00010b40: 2020 7430 203d 2074 696d 652e 7469 6d65    t0 = time.time
-00010b50: 2829 0a20 2020 2020 2020 2074 7279 3a0a  ().        try:.
-00010b60: 2020 2020 2020 2020 2020 2020 6173 7365              asse
-00010b70: 7274 2073 656c 662e 7061 7273 6572 2e67  rt self.parser.g
-00010b80: 656e 0a20 2020 2020 2020 2020 2020 2066  en.            f
-00010b90: 6f72 206e 6669 6c65 2c20 2870 5f66 6965  or nfile, (p_fie
-00010ba0: 6c64 2c20 705f 6669 6c65 2c20 705f 6461  ld, p_file, p_da
-00010bb0: 7461 2920 696e 2065 6e75 6d65 7261 7465  ta) in enumerate
-00010bc0: 2873 656c 662e 7061 7273 6572 2e67 656e  (self.parser.gen
-00010bd0: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-00010be0: 2020 2069 6620 6e6f 7420 705f 6669 6c65     if not p_file
-00010bf0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00010c00: 2020 2020 2020 7365 6c66 2e6c 6f67 2822        self.log("
-00010c10: 6469 7363 6172 6469 6e67 2069 6e63 6f6d  discarding incom
-00010c20: 696e 6720 6669 6c65 2077 6974 686f 7574  ing file without
-00010c30: 2066 696c 656e 616d 6522 290a 2020 2020   filename").    
-00010c40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010c50: 2320 6661 6c6c 7468 726f 7567 680a 0a20  # fallthrough.. 
-00010c60: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00010c70: 6469 7220 3d20 6664 6972 5f62 6173 650a  dir = fdir_base.
-00010c80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010c90: 666e 616d 6520 3d20 7361 6e69 7469 7a65  fname = sanitize
-00010ca0: 5f66 6e28 0a20 2020 2020 2020 2020 2020  _fn(.           
-00010cb0: 2020 2020 2020 2020 2070 5f66 696c 6520           p_file 
-00010cc0: 6f72 2022 222c 2022 222c 205b 222e 7072  or "", "", [".pr
-00010cd0: 6f6c 6f67 7565 2e68 746d 6c22 2c20 222e  ologue.html", ".
-00010ce0: 6570 696c 6f67 7565 2e68 746d 6c22 5d0a  epilogue.html"].
-00010cf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010d00: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00010d10: 2020 6966 2070 5f66 696c 6520 616e 6420    if p_file and 
-00010d20: 6e6f 7420 6e75 6c6c 7772 6974 653a 0a20  not nullwrite:. 
-00010d30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010d40: 2020 2069 6620 726e 643a 0a20 2020 2020     if rnd:.     
-00010d50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010d60: 2020 2066 6e61 6d65 203d 2072 616e 645f     fname = rand_
-00010d70: 6e61 6d65 2866 6469 722c 2066 6e61 6d65  name(fdir, fname
-00010d80: 2c20 726e 6429 0a0a 2020 2020 2020 2020  , rnd)..        
-00010d90: 2020 2020 2020 2020 2020 2020 6966 206e              if n
-00010da0: 6f74 2062 6f73 2e70 6174 682e 6973 6469  ot bos.path.isdi
-00010db0: 7228 6664 6972 293a 0a20 2020 2020 2020  r(fdir):.       
-00010dc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010dd0: 2072 6169 7365 2050 6562 6b61 6328 3430   raise Pebkac(40
-00010de0: 342c 2022 7468 6174 2066 6f6c 6465 7220  4, "that folder 
-00010df0: 646f 6573 206e 6f74 2065 7869 7374 2229  does not exist")
-00010e00: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00010e10: 2020 2020 2020 7375 6666 6978 203d 2022        suffix = "
-00010e20: 2d7b 3a2e 3666 7d2d 7b7d 222e 666f 726d  -{:.6f}-{}".form
-00010e30: 6174 2874 696d 652e 7469 6d65 2829 2c20  at(time.time(), 
-00010e40: 6469 7029 0a20 2020 2020 2020 2020 2020  dip).           
-00010e50: 2020 2020 2020 2020 206f 7065 6e5f 6172           open_ar
-00010e60: 6773 203d 207b 2266 6469 7222 3a20 6664  gs = {"fdir": fd
-00010e70: 6972 2c20 2273 7566 6669 7822 3a20 7375  ir, "suffix": su
-00010e80: 6666 6978 7d0a 0a20 2020 2020 2020 2020  ffix}..         
-00010e90: 2020 2020 2020 2020 2020 2023 2072 6573             # res
-00010ea0: 6572 7665 2064 6573 7469 6e61 7469 6f6e  erve destination
-00010eb0: 2066 696c 656e 616d 650a 2020 2020 2020   filename.      
-00010ec0: 2020 2020 2020 2020 2020 2020 2020 7769                wi
-00010ed0: 7468 2072 656e 5f6f 7065 6e28 666e 616d  th ren_open(fnam
-00010ee0: 652c 2022 7762 222c 2066 6469 723d 6664  e, "wb", fdir=fd
-00010ef0: 6972 2c20 7375 6666 6978 3d73 7566 6669  ir, suffix=suffi
-00010f00: 7829 2061 7320 7a66 773a 0a20 2020 2020  x) as zfw:.     
-00010f10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010f20: 2020 2066 6e61 6d65 203d 207a 6677 5b22     fname = zfw["
-00010f30: 6f72 7a22 5d5b 315d 0a0a 2020 2020 2020  orz"][1]..      
-00010f40: 2020 2020 2020 2020 2020 2020 2020 746e                tn
-00010f50: 616d 203d 2066 6e61 6d65 202b 2022 2e50  am = fname + ".P
-00010f60: 4152 5449 414c 220a 2020 2020 2020 2020  ARTIAL".        
-00010f70: 2020 2020 2020 2020 2020 2020 6966 2073              if s
-00010f80: 656c 662e 6172 6773 2e64 6f74 7061 7274  elf.args.dotpart
-00010f90: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00010fa0: 2020 2020 2020 2020 2020 746e 616d 203d            tnam =
-00010fb0: 2022 2e22 202b 2074 6e61 6d0a 0a20 2020   "." + tnam..   
-00010fc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010fd0: 2061 6273 7061 7468 203d 206f 732e 7061   abspath = os.pa
-00010fe0: 7468 2e6a 6f69 6e28 6664 6972 2c20 666e  th.join(fdir, fn
-00010ff0: 616d 6529 0a20 2020 2020 2020 2020 2020  ame).           
-00011000: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-00011010: 2020 2020 2020 2020 2020 2020 2020 206f                 o
-00011020: 7065 6e5f 6172 6773 203d 207b 7d0a 2020  pen_args = {}.  
+0000a710: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+0000a720: 656c 662e 756e 616d 652c 0a20 2020 2020  elf.uname,.     
+0000a730: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a740: 2020 2020 2020 2020 2020 2020 2020 2074                 t
+0000a750: 696d 652e 7469 6d65 2829 2c0a 2020 2020  ime.time(),.    
+0000a760: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a770: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a780: 6c65 6e28 786d 292c 0a20 2020 2020 2020  len(xm),.       
+0000a790: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a7a0: 2020 2020 2020 2020 2020 2020 2073 656c               sel
+0000a7b0: 662e 6970 2c0a 2020 2020 2020 2020 2020  f.ip,.          
+0000a7c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a7d0: 2020 2020 2020 2020 2020 7469 6d65 2e74            time.t
+0000a7e0: 696d 6528 292c 0a20 2020 2020 2020 2020  ime(),.         
+0000a7f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a800: 2020 2020 2020 2020 2020 2070 6c61 696e             plain
+0000a810: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0000a820: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a830: 2020 290a 0a20 2020 2020 2020 2020 2020    )..           
+0000a840: 2020 2020 2020 2020 2020 2020 2074 203d               t =
+0000a850: 2022 7572 6c66 6f72 6d5f 6465 6320 7b7d   "urlform_dec {}
+0000a860: 2040 207b 7d5c 6e20 207b 7d5c 6e22 0a20   @ {}\n  {}\n". 
+0000a870: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a880: 2020 2020 2020 2073 656c 662e 6c6f 6728         self.log(
+0000a890: 742e 666f 726d 6174 286c 656e 2870 6c61  t.format(len(pla
+0000a8a0: 696e 292c 2073 656c 662e 7670 6174 682c  in), self.vpath,
+0000a8b0: 2070 6c61 696e 2929 0a0a 2020 2020 2020   plain))..      
+0000a8c0: 2020 2020 2020 2020 2020 2020 2020 6578                ex
+0000a8d0: 6365 7074 2045 7863 6570 7469 6f6e 2061  cept Exception a
+0000a8e0: 7320 6578 3a0a 2020 2020 2020 2020 2020  s ex:.          
+0000a8f0: 2020 2020 2020 2020 2020 2020 2020 7365                se
+0000a900: 6c66 2e6c 6f67 2872 6570 7228 6578 2929  lf.log(repr(ex))
+0000a910: 0a0a 2020 2020 2020 2020 2020 2020 6966  ..            if
+0000a920: 2022 6765 7422 2069 6e20 6f70 743a 0a20   "get" in opt:. 
+0000a930: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+0000a940: 6574 7572 6e20 7365 6c66 2e68 616e 646c  eturn self.handl
+0000a950: 655f 6765 7428 290a 0a20 2020 2020 2020  e_get()..       
+0000a960: 2020 2020 2072 6169 7365 2050 6562 6b61       raise Pebka
+0000a970: 6328 3430 352c 2022 504f 5354 287b 7d29  c(405, "POST({})
+0000a980: 2069 7320 6469 7361 626c 6564 2069 6e20   is disabled in 
+0000a990: 7365 7276 6572 2063 6f6e 6669 6722 2e66  server config".f
+0000a9a0: 6f72 6d61 7428 6374 7970 6529 290a 0a20  ormat(ctype)).. 
+0000a9b0: 2020 2020 2020 2072 6169 7365 2050 6562         raise Peb
+0000a9c0: 6b61 6328 3430 352c 2022 646f 6e27 7420  kac(405, "don't 
+0000a9d0: 6b6e 6f77 2068 6f77 2074 6f20 6861 6e64  know how to hand
+0000a9e0: 6c65 2050 4f53 5428 7b7d 2922 2e66 6f72  le POST({})".for
+0000a9f0: 6d61 7428 6374 7970 6529 290a 0a20 2020  mat(ctype))..   
+0000aa00: 2064 6566 2067 6574 5f78 6d6c 5f65 6e63   def get_xml_enc
+0000aa10: 2873 656c 662c 2074 7874 2029 2020 3a0a  (self, txt )  :.
+0000aa20: 2020 2020 2020 2020 6f66 7320 3d20 7478          ofs = tx
+0000aa30: 745b 3a35 3132 5d2e 6669 6e64 2827 2065  t[:512].find(' e
+0000aa40: 6e63 6f64 696e 673d 2227 290a 2020 2020  ncoding="').    
+0000aa50: 2020 2020 656e 6320 3d20 2222 0a20 2020      enc = "".   
+0000aa60: 2020 2020 2069 6620 6f66 7320 2b20 313a       if ofs + 1:
+0000aa70: 0a20 2020 2020 2020 2020 2020 2065 6e63  .            enc
+0000aa80: 203d 2074 7874 5b6f 6673 202b 2036 203a   = txt[ofs + 6 :
+0000aa90: 5d2e 7370 6c69 7428 2722 2729 5b31 5d0a  ].split('"')[1].
+0000aaa0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+0000aab0: 2020 2020 2020 2020 2020 656e 6320 3d20            enc = 
+0000aac0: 7365 6c66 2e68 6561 6465 7273 2e67 6574  self.headers.get
+0000aad0: 2822 636f 6e74 656e 742d 7479 7065 222c  ("content-type",
+0000aae0: 2022 2229 2e6c 6f77 6572 2829 0a20 2020   "").lower().   
+0000aaf0: 2020 2020 2020 2020 206f 6673 203d 2065           ofs = e
+0000ab00: 6e63 2e66 696e 6428 2263 6861 7273 6574  nc.find("charset
+0000ab10: 3d22 290a 2020 2020 2020 2020 2020 2020  =").            
+0000ab20: 6966 206f 6673 202b 2031 3a0a 2020 2020  if ofs + 1:.    
+0000ab30: 2020 2020 2020 2020 2020 2020 656e 6320              enc 
+0000ab40: 3d20 656e 635b 6f66 7320 2b20 345d 2e73  = enc[ofs + 4].s
+0000ab50: 706c 6974 2822 3d22 295b 315d 2e73 706c  plit("=")[1].spl
+0000ab60: 6974 2822 3b22 295b 305d 2e73 7472 6970  it(";")[0].strip
+0000ab70: 2822 5c22 2722 290a 2020 2020 2020 2020  ("\"'").        
+0000ab80: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+0000ab90: 2020 2020 2020 2020 2020 656e 6320 3d20            enc = 
+0000aba0: 2222 0a0a 2020 2020 2020 2020 7265 7475  ""..        retu
+0000abb0: 726e 2065 6e63 206f 7220 2275 7466 2d38  rn enc or "utf-8
+0000abc0: 220a 0a20 2020 2064 6566 2067 6574 5f62  "..    def get_b
+0000abd0: 6f64 795f 7265 6164 6572 2873 656c 6629  ody_reader(self)
+0000abe0: 2020 2020 203a 0a20 2020 2020 2020 2069       :.        i
+0000abf0: 6620 2263 6875 6e6b 6564 2220 696e 2073  f "chunked" in s
+0000ac00: 656c 662e 6865 6164 6572 732e 6765 7428  elf.headers.get(
+0000ac10: 2274 7261 6e73 6665 722d 656e 636f 6469  "transfer-encodi
+0000ac20: 6e67 222c 2022 2229 2e6c 6f77 6572 2829  ng", "").lower()
+0000ac30: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
+0000ac40: 7475 726e 2072 6561 645f 736f 636b 6574  turn read_socket
+0000ac50: 5f63 6875 6e6b 6564 2873 656c 662e 7372  _chunked(self.sr
+0000ac60: 292c 202d 310a 0a20 2020 2020 2020 2072  ), -1..        r
+0000ac70: 656d 6169 6e73 203d 2069 6e74 2873 656c  emains = int(sel
+0000ac80: 662e 6865 6164 6572 732e 6765 7428 2263  f.headers.get("c
+0000ac90: 6f6e 7465 6e74 2d6c 656e 6774 6822 2c20  ontent-length", 
+0000aca0: 2d31 2929 0a20 2020 2020 2020 2069 6620  -1)).        if 
+0000acb0: 7265 6d61 696e 7320 3d3d 202d 313a 0a20  remains == -1:. 
+0000acc0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+0000acd0: 6b65 6570 616c 6976 6520 3d20 4661 6c73  keepalive = Fals
+0000ace0: 650a 2020 2020 2020 2020 2020 2020 7265  e.            re
+0000acf0: 7475 726e 2072 6561 645f 736f 636b 6574  turn read_socket
+0000ad00: 5f75 6e62 6f75 6e64 6564 2873 656c 662e  _unbounded(self.
+0000ad10: 7372 292c 2072 656d 6169 6e73 0a20 2020  sr), remains.   
+0000ad20: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+0000ad30: 2020 2020 2020 2072 6574 7572 6e20 7265         return re
+0000ad40: 6164 5f73 6f63 6b65 7428 7365 6c66 2e73  ad_socket(self.s
+0000ad50: 722c 2072 656d 6169 6e73 292c 2072 656d  r, remains), rem
+0000ad60: 6169 6e73 0a0a 2020 2020 6465 6620 6475  ains..    def du
+0000ad70: 6d70 5f74 6f5f 6669 6c65 2873 656c 662c  mp_to_file(self,
+0000ad80: 2069 735f 7075 7420 2920 2020 2020 2020   is_put )       
+0000ad90: 3a0a 2020 2020 2020 2020 2320 706f 7374  :.        # post
+0000ada0: 5f73 7a2c 2073 6861 5f68 6578 2c20 7368  _sz, sha_hex, sh
+0000adb0: 615f 6236 342c 2072 656d 6169 6e73 2c20  a_b64, remains, 
+0000adc0: 7061 7468 2c20 7572 6c0a 2020 2020 2020  path, url.      
+0000add0: 2020 7265 6164 6572 2c20 7265 6d61 696e    reader, remain
+0000ade0: 7320 3d20 7365 6c66 2e67 6574 5f62 6f64  s = self.get_bod
+0000adf0: 795f 7265 6164 6572 2829 0a20 2020 2020  y_reader().     
+0000ae00: 2020 2076 6673 2c20 7265 6d20 3d20 7365     vfs, rem = se
+0000ae10: 6c66 2e61 7372 762e 7666 732e 6765 7428  lf.asrv.vfs.get(
+0000ae20: 7365 6c66 2e76 7061 7468 2c20 7365 6c66  self.vpath, self
+0000ae30: 2e75 6e61 6d65 2c20 4661 6c73 652c 2054  .uname, False, T
+0000ae40: 7275 6529 0a20 2020 2020 2020 2072 6e64  rue).        rnd
+0000ae50: 2c20 5f2c 206c 6966 6574 696d 652c 2078  , _, lifetime, x
+0000ae60: 6275 2c20 7861 7520 3d20 7365 6c66 2e75  bu, xau = self.u
+0000ae70: 706c 6f61 645f 666c 6167 7328 7666 7329  pload_flags(vfs)
+0000ae80: 0a20 2020 2020 2020 206c 696d 203d 2076  .        lim = v
+0000ae90: 6673 2e67 6574 5f64 6276 2872 656d 295b  fs.get_dbv(rem)[
+0000aea0: 305d 2e6c 696d 0a20 2020 2020 2020 2066  0].lim.        f
+0000aeb0: 6469 7220 3d20 7666 732e 6361 6e6f 6e69  dir = vfs.canoni
+0000aec0: 6361 6c28 7265 6d29 0a20 2020 2020 2020  cal(rem).       
+0000aed0: 2069 6620 6c69 6d3a 0a20 2020 2020 2020   if lim:.       
+0000aee0: 2020 2020 2066 6469 722c 2072 656d 203d       fdir, rem =
+0000aef0: 206c 696d 2e61 6c6c 2873 656c 662e 6970   lim.all(self.ip
+0000af00: 2c20 7265 6d2c 2072 656d 6169 6e73 2c20  , rem, remains, 
+0000af10: 6664 6972 290a 0a20 2020 2020 2020 2066  fdir)..        f
+0000af20: 6e20 3d20 4e6f 6e65 0a20 2020 2020 2020  n = None.       
+0000af30: 2069 6620 7265 6d20 616e 6420 6e6f 7420   if rem and not 
+0000af40: 7365 6c66 2e74 7261 696c 696e 675f 736c  self.trailing_sl
+0000af50: 6173 6820 616e 6420 6e6f 7420 626f 732e  ash and not bos.
+0000af60: 7061 7468 2e69 7364 6972 2866 6469 7229  path.isdir(fdir)
+0000af70: 3a0a 2020 2020 2020 2020 2020 2020 6664  :.            fd
+0000af80: 6972 2c20 666e 203d 206f 732e 7061 7468  ir, fn = os.path
+0000af90: 2e73 706c 6974 2866 6469 7229 0a20 2020  .split(fdir).   
+0000afa0: 2020 2020 2020 2020 2072 656d 2c20 5f20           rem, _ 
+0000afb0: 3d20 7673 706c 6974 2872 656d 290a 0a20  = vsplit(rem).. 
+0000afc0: 2020 2020 2020 2062 6f73 2e6d 616b 6564         bos.maked
+0000afd0: 6972 7328 6664 6972 290a 0a20 2020 2020  irs(fdir)..     
+0000afe0: 2020 206f 7065 6e5f 6b61 2020 203d 207b     open_ka   = {
+0000aff0: 2266 756e 223a 206f 7065 6e7d 0a20 2020  "fun": open}.   
+0000b000: 2020 2020 206f 7065 6e5f 6120 3d20 5b22       open_a = ["
+0000b010: 7762 222c 2035 3132 202a 2031 3032 345d  wb", 512 * 1024]
+0000b020: 0a0a 2020 2020 2020 2020 2320 7573 6572  ..        # user
+0000b030: 2d72 6571 7565 7374 207c 7c20 636f 6e66  -request || conf
+0000b040: 6967 2d66 6f72 6365 0a20 2020 2020 2020  ig-force.       
+0000b050: 2069 6620 2822 677a 2220 696e 2076 6673   if ("gz" in vfs
+0000b060: 2e66 6c61 6773 206f 7220 2278 7a22 2069  .flags or "xz" i
+0000b070: 6e20 7666 732e 666c 6167 7329 2061 6e64  n vfs.flags) and
+0000b080: 2028 0a20 2020 2020 2020 2020 2020 2022   (.            "
+0000b090: 706b 2220 696e 2076 6673 2e66 6c61 6773  pk" in vfs.flags
+0000b0a0: 0a20 2020 2020 2020 2020 2020 206f 7220  .            or 
+0000b0b0: 2270 6b22 2069 6e20 7365 6c66 2e75 7061  "pk" in self.upa
+0000b0c0: 7261 6d0a 2020 2020 2020 2020 2020 2020  ram.            
+0000b0d0: 6f72 2022 677a 2220 696e 2073 656c 662e  or "gz" in self.
+0000b0e0: 7570 6172 616d 0a20 2020 2020 2020 2020  uparam.         
+0000b0f0: 2020 206f 7220 2278 7a22 2069 6e20 7365     or "xz" in se
+0000b100: 6c66 2e75 7061 7261 6d0a 2020 2020 2020  lf.uparam.      
+0000b110: 2020 293a 0a20 2020 2020 2020 2020 2020    ):.           
+0000b120: 2066 6220 3d20 7b22 677a 223a 2039 2c20   fb = {"gz": 9, 
+0000b130: 2278 7a22 3a20 307d 2020 2320 6465 6661  "xz": 0}  # defa
+0000b140: 756c 742f 6661 6c6c 6261 636b 206c 6576  ult/fallback lev
+0000b150: 656c 0a20 2020 2020 2020 2020 2020 206c  el.            l
+0000b160: 7620 3d20 7b7d 2020 2320 7365 6c65 6374  v = {}  # select
+0000b170: 6564 206c 6576 656c 0a20 2020 2020 2020  ed level.       
+0000b180: 2020 2020 2061 6c67 203d 2022 2220 2023       alg = ""  #
+0000b190: 2073 656c 6563 7465 6420 616c 676f 2028   selected algo (
+0000b1a0: 677a 3d70 7265 6665 7272 6564 290a 0a20  gz=preferred).. 
+0000b1b0: 2020 2020 2020 2020 2020 2023 2075 7365             # use
+0000b1c0: 722d 7072 6566 7320 6669 7273 740a 2020  r-prefs first.  
+0000b1d0: 2020 2020 2020 2020 2020 6966 2022 677a            if "gz
+0000b1e0: 2220 696e 2073 656c 662e 7570 6172 616d  " in self.uparam
+0000b1f0: 206f 7220 2270 6b22 2069 6e20 7365 6c66   or "pk" in self
+0000b200: 2e75 7061 7261 6d3a 2020 2320 6465 662e  .uparam:  # def.
+0000b210: 706b 0a20 2020 2020 2020 2020 2020 2020  pk.             
+0000b220: 2020 2061 6c67 203d 2022 677a 220a 2020     alg = "gz".  
+0000b230: 2020 2020 2020 2020 2020 6966 2022 787a            if "xz
+0000b240: 2220 696e 2073 656c 662e 7570 6172 616d  " in self.uparam
+0000b250: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0000b260: 2020 616c 6720 3d20 2278 7a22 0a20 2020    alg = "xz".   
+0000b270: 2020 2020 2020 2020 2069 6620 616c 673a           if alg:
+0000b280: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000b290: 207a 736f 203d 2073 656c 662e 7570 6172   zso = self.upar
+0000b2a0: 616d 2e67 6574 2861 6c67 290a 2020 2020  am.get(alg).    
+0000b2b0: 2020 2020 2020 2020 2020 2020 6c76 5b61              lv[a
+0000b2c0: 6c67 5d20 3d20 6662 5b61 6c67 5d20 6966  lg] = fb[alg] if
+0000b2d0: 207a 736f 2069 7320 4e6f 6e65 2065 6c73   zso is None els
+0000b2e0: 6520 696e 7428 7a73 6f29 0a0a 2020 2020  e int(zso)..    
+0000b2f0: 2020 2020 2020 2020 6966 2061 6c67 206e          if alg n
+0000b300: 6f74 2069 6e20 7666 732e 666c 6167 733a  ot in vfs.flags:
+0000b310: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000b320: 2061 6c67 203d 2022 677a 2220 6966 2022   alg = "gz" if "
+0000b330: 677a 2220 696e 2076 6673 2e66 6c61 6773  gz" in vfs.flags
+0000b340: 2065 6c73 6520 2278 7a22 0a0a 2020 2020   else "xz"..    
+0000b350: 2020 2020 2020 2020 2320 7468 656e 2073          # then s
+0000b360: 6572 7665 7220 6f76 6572 7269 6465 730a  erver overrides.
+0000b370: 2020 2020 2020 2020 2020 2020 706b 203d              pk =
+0000b380: 2076 6673 2e66 6c61 6773 2e67 6574 2822   vfs.flags.get("
+0000b390: 706b 2229 0a20 2020 2020 2020 2020 2020  pk").           
+0000b3a0: 2069 6620 706b 2069 7320 6e6f 7420 4e6f   if pk is not No
+0000b3b0: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
+0000b3c0: 2020 2020 2320 636f 6e66 6967 2d66 6f72      # config-for
+0000b3d0: 6365 6420 6f6e 0a20 2020 2020 2020 2020  ced on.         
+0000b3e0: 2020 2020 2020 2061 6c67 203d 2061 6c67         alg = alg
+0000b3f0: 206f 7220 2267 7a22 2020 2320 6465 662e   or "gz"  # def.
+0000b400: 706b 0a20 2020 2020 2020 2020 2020 2020  pk.             
+0000b410: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
+0000b420: 2020 2020 2020 2020 2020 2020 2320 636f              # co
+0000b430: 6e66 6967 2d66 6f72 6365 6420 6f70 7473  nfig-forced opts
+0000b440: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000b450: 2020 2020 2061 6c67 2c20 6e6c 7620 3d20       alg, nlv = 
+0000b460: 706b 2e73 706c 6974 2822 2c22 290a 2020  pk.split(",").  
+0000b470: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b480: 2020 6c76 5b61 6c67 5d20 3d20 696e 7428    lv[alg] = int(
+0000b490: 6e6c 7629 0a20 2020 2020 2020 2020 2020  nlv).           
+0000b4a0: 2020 2020 2065 7863 6570 743a 0a20 2020       except:.   
+0000b4b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b4c0: 2070 6173 730a 0a20 2020 2020 2020 2020   pass..         
+0000b4d0: 2020 206c 765b 616c 675d 203d 206c 762e     lv[alg] = lv.
+0000b4e0: 6765 7428 616c 6729 206f 7220 6662 2e67  get(alg) or fb.g
+0000b4f0: 6574 2861 6c67 2920 6f72 2030 0a0a 2020  et(alg) or 0..  
+0000b500: 2020 2020 2020 2020 2020 7365 6c66 2e6c            self.l
+0000b510: 6f67 2822 636f 6d70 7265 7373 696e 6720  og("compressing 
+0000b520: 7769 7468 207b 7d20 6c65 7665 6c20 7b7d  with {} level {}
+0000b530: 222e 666f 726d 6174 2861 6c67 2c20 6c76  ".format(alg, lv
+0000b540: 2e67 6574 2861 6c67 2929 290a 2020 2020  .get(alg))).    
+0000b550: 2020 2020 2020 2020 6966 2061 6c67 203d          if alg =
+0000b560: 3d20 2267 7a22 3a0a 2020 2020 2020 2020  = "gz":.        
+0000b570: 2020 2020 2020 2020 6f70 656e 5f6b 615b          open_ka[
+0000b580: 2266 756e 225d 203d 2067 7a69 702e 477a  "fun"] = gzip.Gz
+0000b590: 6970 4669 6c65 0a20 2020 2020 2020 2020  ipFile.         
+0000b5a0: 2020 2020 2020 206f 7065 6e5f 6120 3d20         open_a = 
+0000b5b0: 5b22 7762 222c 206c 765b 616c 675d 2c20  ["wb", lv[alg], 
+0000b5c0: 4e6f 6e65 2c20 3078 3546 4545 3636 3030  None, 0x5FEE6600
+0000b5d0: 5d20 2023 2032 3032 312d 3031 2d30 310a  ]  # 2021-01-01.
+0000b5e0: 2020 2020 2020 2020 2020 2020 656c 6966              elif
+0000b5f0: 2061 6c67 203d 3d20 2278 7a22 3a0a 2020   alg == "xz":.  
+0000b600: 2020 2020 2020 2020 2020 2020 2020 6f70                op
+0000b610: 656e 5f6b 6120 3d20 7b22 6675 6e22 3a20  en_ka = {"fun": 
+0000b620: 6c7a 6d61 2e6f 7065 6e2c 2022 7072 6573  lzma.open, "pres
+0000b630: 6574 223a 206c 765b 616c 675d 7d0a 2020  et": lv[alg]}.  
+0000b640: 2020 2020 2020 2020 2020 2020 2020 6f70                op
+0000b650: 656e 5f61 203d 205b 2277 6222 5d0a 2020  en_a = ["wb"].  
+0000b660: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
+0000b670: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b680: 7365 6c66 2e6c 6f67 2822 6661 6c6c 7468  self.log("fallth
+0000b690: 726f 7567 683f 2074 6861 7473 2061 2062  rough? thats a b
+0000b6a0: 7567 222c 2031 290a 0a20 2020 2020 2020  ug", 1)..       
+0000b6b0: 2073 7566 6669 7820 3d20 222d 7b3a 2e36   suffix = "-{:.6
+0000b6c0: 667d 2d7b 7d22 2e66 6f72 6d61 7428 7469  f}-{}".format(ti
+0000b6d0: 6d65 2e74 696d 6528 292c 2073 656c 662e  me.time(), self.
+0000b6e0: 6469 7028 2929 0a20 2020 2020 2020 206e  dip()).        n
+0000b6f0: 616d 656c 6573 7320 3d20 6e6f 7420 666e  ameless = not fn
+0000b700: 0a20 2020 2020 2020 2069 6620 6e61 6d65  .        if name
+0000b710: 6c65 7373 3a0a 2020 2020 2020 2020 2020  less:.          
+0000b720: 2020 7375 6666 6978 202b 3d20 222e 6269    suffix += ".bi
+0000b730: 6e22 0a20 2020 2020 2020 2020 2020 2066  n".            f
+0000b740: 6e20 3d20 2270 7574 2220 2b20 7375 6666  n = "put" + suff
+0000b750: 6978 0a0a 2020 2020 2020 2020 7061 7261  ix..        para
+0000b760: 6d73 203d 207b 2273 7566 6669 7822 3a20  ms = {"suffix": 
+0000b770: 7375 6666 6978 2c20 2266 6469 7222 3a20  suffix, "fdir": 
+0000b780: 6664 6972 7d0a 2020 2020 2020 2020 6966  fdir}.        if
+0000b790: 2073 656c 662e 6172 6773 2e6e 773a 0a20   self.args.nw:. 
+0000b7a0: 2020 2020 2020 2020 2020 2070 6172 616d             param
+0000b7b0: 7320 3d20 7b7d 0a20 2020 2020 2020 2020  s = {}.         
+0000b7c0: 2020 2066 6e20 3d20 6f73 2e64 6576 6e75     fn = os.devnu
+0000b7d0: 6c6c 0a0a 2020 2020 2020 2020 7061 7261  ll..        para
+0000b7e0: 6d73 2e75 7064 6174 6528 6f70 656e 5f6b  ms.update(open_k
+0000b7f0: 6129 0a20 2020 2020 2020 2061 7373 6572  a).        asser
+0000b800: 7420 666e 0a0a 2020 2020 2020 2020 6966  t fn..        if
+0000b810: 206e 6f74 2073 656c 662e 6172 6773 2e6e   not self.args.n
+0000b820: 773a 0a20 2020 2020 2020 2020 2020 2069  w:.            i
+0000b830: 6620 726e 643a 0a20 2020 2020 2020 2020  f rnd:.         
+0000b840: 2020 2020 2020 2066 6e20 3d20 7261 6e64         fn = rand
+0000b850: 5f6e 616d 6528 6664 6972 2c20 666e 2c20  _name(fdir, fn, 
+0000b860: 726e 6429 0a0a 2020 2020 2020 2020 2020  rnd)..          
+0000b870: 2020 666e 203d 2073 616e 6974 697a 655f    fn = sanitize_
+0000b880: 666e 2866 6e20 6f72 2022 222c 2022 222c  fn(fn or "", "",
+0000b890: 205b 222e 7072 6f6c 6f67 7565 2e68 746d   [".prologue.htm
+0000b8a0: 6c22 2c20 222e 6570 696c 6f67 7565 2e68  l", ".epilogue.h
+0000b8b0: 746d 6c22 5d29 0a0a 2020 2020 2020 2020  tml"])..        
+0000b8c0: 7061 7468 203d 206f 732e 7061 7468 2e6a  path = os.path.j
+0000b8d0: 6f69 6e28 6664 6972 2c20 666e 290a 0a20  oin(fdir, fn).. 
+0000b8e0: 2020 2020 2020 2069 6620 7862 753a 0a20         if xbu:. 
+0000b8f0: 2020 2020 2020 2020 2020 2061 7420 3d20             at = 
+0000b900: 7469 6d65 2e74 696d 6528 2920 2d20 6c69  time.time() - li
+0000b910: 6665 7469 6d65 0a20 2020 2020 2020 2020  fetime.         
+0000b920: 2020 2069 6620 6e6f 7420 7275 6e68 6f6f     if not runhoo
+0000b930: 6b28 0a20 2020 2020 2020 2020 2020 2020  k(.             
+0000b940: 2020 2073 656c 662e 6c6f 672c 0a20 2020     self.log,.   
+0000b950: 2020 2020 2020 2020 2020 2020 2078 6275               xbu
+0000b960: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0000b970: 2020 7061 7468 2c0a 2020 2020 2020 2020    path,.        
+0000b980: 2020 2020 2020 2020 7365 6c66 2e76 7061          self.vpa
+0000b990: 7468 2c0a 2020 2020 2020 2020 2020 2020  th,.            
+0000b9a0: 2020 2020 7365 6c66 2e68 6f73 742c 0a20      self.host,. 
+0000b9b0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+0000b9c0: 656c 662e 756e 616d 652c 0a20 2020 2020  elf.uname,.     
+0000b9d0: 2020 2020 2020 2020 2020 2061 742c 0a20             at,. 
+0000b9e0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+0000b9f0: 656d 6169 6e73 2c0a 2020 2020 2020 2020  emains,.        
+0000ba00: 2020 2020 2020 2020 7365 6c66 2e69 702c          self.ip,
+0000ba10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000ba20: 2061 742c 0a20 2020 2020 2020 2020 2020   at,.           
+0000ba30: 2020 2020 2022 222c 0a20 2020 2020 2020       "",.       
+0000ba40: 2020 2020 2029 3a0a 2020 2020 2020 2020       ):.        
+0000ba50: 2020 2020 2020 2020 7420 3d20 2275 706c          t = "upl
+0000ba60: 6f61 6420 626c 6f63 6b65 6420 6279 2078  oad blocked by x
+0000ba70: 6275 2073 6572 7665 7220 636f 6e66 6967  bu server config
+0000ba80: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
+0000ba90: 2020 7365 6c66 2e6c 6f67 2874 2c20 3129    self.log(t, 1)
+0000baa0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000bab0: 2072 6169 7365 2050 6562 6b61 6328 3430   raise Pebkac(40
+0000bac0: 332c 2074 290a 0a20 2020 2020 2020 2069  3, t)..        i
+0000bad0: 6620 6973 5f70 7574 2061 6e64 206e 6f74  f is_put and not
+0000bae0: 2028 7365 6c66 2e61 7267 732e 6e6f 5f64   (self.args.no_d
+0000baf0: 6176 206f 7220 7365 6c66 2e61 7267 732e  av or self.args.
+0000bb00: 6e77 2920 616e 6420 626f 732e 7061 7468  nw) and bos.path
+0000bb10: 2e65 7869 7374 7328 7061 7468 293a 0a20  .exists(path):. 
+0000bb20: 2020 2020 2020 2020 2020 2023 2061 6c6c             # all
+0000bb30: 6f77 206f 7665 7277 7269 7465 2069 662e  ow overwrite if.
+0000bb40: 2e2e 0a20 2020 2020 2020 2020 2020 2023  ...            #
+0000bb50: 2020 2a20 766f 6c66 6c61 6720 2764 6177    * volflag 'daw
+0000bb60: 2720 6973 2073 6574 2c20 6f72 2063 6c69  ' is set, or cli
+0000bb70: 656e 7420 6973 2064 6566 696e 6974 656c  ent is definitel
+0000bb80: 7920 7765 6264 6176 0a20 2020 2020 2020  y webdav.       
+0000bb90: 2020 2020 2023 2020 2a20 616e 6420 6163       #  * and ac
+0000bba0: 636f 756e 7420 6861 7320 6465 6c65 7465  count has delete
+0000bbb0: 2d61 6363 6573 730a 2020 2020 2020 2020  -access.        
+0000bbc0: 2020 2020 2320 6f72 2e2e 2e0a 2020 2020      # or....    
+0000bbd0: 2020 2020 2020 2020 2320 202a 2066 696c          #  * fil
+0000bbe0: 6520 6578 6973 7473 2c20 6973 2065 6d70  e exists, is emp
+0000bbf0: 7479 2c20 7375 6666 6963 6965 6e74 6c79  ty, sufficiently
+0000bc00: 206e 6577 0a20 2020 2020 2020 2020 2020   new.           
+0000bc10: 2023 2020 2a20 616e 6420 7468 6572 6520   #  * and there 
+0000bc20: 6973 206e 6f20 2e50 4152 5449 414c 0a0a  is no .PARTIAL..
+0000bc30: 2020 2020 2020 2020 2020 2020 746e 616d              tnam
+0000bc40: 203d 2066 6e20 2b20 222e 5041 5254 4941   = fn + ".PARTIA
+0000bc50: 4c22 0a20 2020 2020 2020 2020 2020 2069  L".            i
+0000bc60: 6620 7365 6c66 2e61 7267 732e 646f 7470  f self.args.dotp
+0000bc70: 6172 743a 0a20 2020 2020 2020 2020 2020  art:.           
+0000bc80: 2020 2020 2074 6e61 6d20 3d20 222e 2220       tnam = "." 
+0000bc90: 2b20 746e 616d 0a0a 2020 2020 2020 2020  + tnam..        
+0000bca0: 2020 2020 6966 2028 0a20 2020 2020 2020      if (.       
+0000bcb0: 2020 2020 2020 2020 2073 656c 662e 6361           self.ca
+0000bcc0: 6e5f 6465 6c65 7465 0a20 2020 2020 2020  n_delete.       
+0000bcd0: 2020 2020 2020 2020 2061 6e64 2028 7666           and (vf
+0000bce0: 732e 666c 6167 732e 6765 7428 2264 6177  s.flags.get("daw
+0000bcf0: 2229 206f 7220 2278 2d6f 632d 6d74 696d  ") or "x-oc-mtim
+0000bd00: 6522 2069 6e20 7365 6c66 2e68 6561 6465  e" in self.heade
+0000bd10: 7273 290a 2020 2020 2020 2020 2020 2020  rs).            
+0000bd20: 2920 6f72 2028 0a20 2020 2020 2020 2020  ) or (.         
+0000bd30: 2020 2020 2020 206e 6f74 2062 6f73 2e70         not bos.p
+0000bd40: 6174 682e 6578 6973 7473 286f 732e 7061  ath.exists(os.pa
+0000bd50: 7468 2e6a 6f69 6e28 6664 6972 2c20 746e  th.join(fdir, tn
+0000bd60: 616d 2929 0a20 2020 2020 2020 2020 2020  am)).           
+0000bd70: 2020 2020 2061 6e64 206e 6f74 2062 6f73       and not bos
+0000bd80: 2e70 6174 682e 6765 7473 697a 6528 7061  .path.getsize(pa
+0000bd90: 7468 290a 2020 2020 2020 2020 2020 2020  th).            
+0000bda0: 2020 2020 616e 6420 626f 732e 7061 7468      and bos.path
+0000bdb0: 2e67 6574 6d74 696d 6528 7061 7468 2920  .getmtime(path) 
+0000bdc0: 3e3d 2074 696d 652e 7469 6d65 2829 202d  >= time.time() -
+0000bdd0: 2073 656c 662e 6172 6773 2e62 6c61 6e6b   self.args.blank
+0000bde0: 5f77 740a 2020 2020 2020 2020 2020 2020  _wt.            
+0000bdf0: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+0000be00: 2020 2023 2073 6d61 6c6c 2074 6f63 746f     # small tocto
+0000be10: 752c 2062 7574 2062 6574 7465 7220 7468  u, but better th
+0000be20: 616e 2063 6c6f 6262 6572 696e 6720 6120  an clobbering a 
+0000be30: 6861 7264 6c69 6e6b 0a20 2020 2020 2020  hardlink.       
+0000be40: 2020 2020 2020 2020 2062 6f73 2e75 6e6c           bos.unl
+0000be50: 696e 6b28 7061 7468 290a 0a20 2020 2020  ink(path)..     
+0000be60: 2020 2077 6974 6820 7265 6e5f 6f70 656e     with ren_open
+0000be70: 2866 6e2c 202a 6f70 656e 5f61 2c20 2a2a  (fn, *open_a, **
+0000be80: 7061 7261 6d73 2920 6173 207a 6677 3a0a  params) as zfw:.
+0000be90: 2020 2020 2020 2020 2020 2020 662c 2066              f, f
+0000bea0: 6e20 3d20 7a66 775b 226f 727a 225d 0a20  n = zfw["orz"]. 
+0000beb0: 2020 2020 2020 2020 2020 2070 6174 6820             path 
+0000bec0: 3d20 6f73 2e70 6174 682e 6a6f 696e 2866  = os.path.join(f
+0000bed0: 6469 722c 2066 6e29 0a20 2020 2020 2020  dir, fn).       
+0000bee0: 2020 2020 2070 6f73 745f 737a 2c20 7368       post_sz, sh
+0000bef0: 615f 6865 782c 2073 6861 5f62 3634 203d  a_hex, sha_b64 =
+0000bf00: 2068 6173 6863 6f70 7928 7265 6164 6572   hashcopy(reader
+0000bf10: 2c20 662c 2073 656c 662e 6172 6773 2e73  , f, self.args.s
+0000bf20: 5f77 725f 736c 7029 0a0a 2020 2020 2020  _wr_slp)..      
+0000bf30: 2020 6966 206c 696d 3a0a 2020 2020 2020    if lim:.      
+0000bf40: 2020 2020 2020 6c69 6d2e 6e75 7028 7365        lim.nup(se
+0000bf50: 6c66 2e69 7029 0a20 2020 2020 2020 2020  lf.ip).         
+0000bf60: 2020 206c 696d 2e62 7570 2873 656c 662e     lim.bup(self.
+0000bf70: 6970 2c20 706f 7374 5f73 7a29 0a20 2020  ip, post_sz).   
+0000bf80: 2020 2020 2020 2020 2074 7279 3a0a 2020           try:.  
+0000bf90: 2020 2020 2020 2020 2020 2020 2020 6c69                li
+0000bfa0: 6d2e 6368 6b5f 737a 2870 6f73 745f 737a  m.chk_sz(post_sz
+0000bfb0: 290a 2020 2020 2020 2020 2020 2020 6578  ).            ex
+0000bfc0: 6365 7074 3a0a 2020 2020 2020 2020 2020  cept:.          
+0000bfd0: 2020 2020 2020 626f 732e 756e 6c69 6e6b        bos.unlink
+0000bfe0: 2870 6174 6829 0a20 2020 2020 2020 2020  (path).         
+0000bff0: 2020 2020 2020 2072 6169 7365 0a0a 2020         raise..  
+0000c000: 2020 2020 2020 6966 2073 656c 662e 6172        if self.ar
+0000c010: 6773 2e6e 773a 0a20 2020 2020 2020 2020  gs.nw:.         
+0000c020: 2020 2072 6574 7572 6e20 706f 7374 5f73     return post_s
+0000c030: 7a2c 2073 6861 5f68 6578 2c20 7368 615f  z, sha_hex, sha_
+0000c040: 6236 342c 2072 656d 6169 6e73 2c20 7061  b64, remains, pa
+0000c050: 7468 2c20 2222 0a0a 2020 2020 2020 2020  th, ""..        
+0000c060: 6174 203d 206d 7420 3d20 7469 6d65 2e74  at = mt = time.t
+0000c070: 696d 6528 2920 2d20 6c69 6665 7469 6d65  ime() - lifetime
+0000c080: 0a20 2020 2020 2020 2063 6c69 5f6d 7420  .        cli_mt 
+0000c090: 3d20 7365 6c66 2e68 6561 6465 7273 2e67  = self.headers.g
+0000c0a0: 6574 2822 782d 6f63 2d6d 7469 6d65 2229  et("x-oc-mtime")
+0000c0b0: 0a20 2020 2020 2020 2069 6620 636c 695f  .        if cli_
+0000c0c0: 6d74 3a0a 2020 2020 2020 2020 2020 2020  mt:.            
+0000c0d0: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
+0000c0e0: 2020 2020 206d 7420 3d20 696e 7428 636c       mt = int(cl
+0000c0f0: 695f 6d74 290a 2020 2020 2020 2020 2020  i_mt).          
+0000c100: 2020 2020 2020 7469 6d65 7320 3d20 2869        times = (i
+0000c110: 6e74 2874 696d 652e 7469 6d65 2829 292c  nt(time.time()),
+0000c120: 206d 7429 0a20 2020 2020 2020 2020 2020   mt).           
+0000c130: 2020 2020 2062 6f73 2e75 7469 6d65 2870       bos.utime(p
+0000c140: 6174 682c 2074 696d 6573 2c20 4661 6c73  ath, times, Fals
+0000c150: 6529 0a20 2020 2020 2020 2020 2020 2065  e).            e
+0000c160: 7863 6570 743a 0a20 2020 2020 2020 2020  xcept:.         
+0000c170: 2020 2020 2020 2070 6173 730a 0a20 2020         pass..   
+0000c180: 2020 2020 2069 6620 6e61 6d65 6c65 7373       if nameless
+0000c190: 2061 6e64 2022 6d61 6769 6322 2069 6e20   and "magic" in 
+0000c1a0: 7666 732e 666c 6167 733a 0a20 2020 2020  vfs.flags:.     
+0000c1b0: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
+0000c1c0: 2020 2020 2020 2020 2020 2020 6578 7420              ext 
+0000c1d0: 3d20 7365 6c66 2e63 6f6e 6e2e 6873 7276  = self.conn.hsrv
+0000c1e0: 2e6d 6167 6963 6961 6e2e 6578 7428 7061  .magician.ext(pa
+0000c1f0: 7468 290a 2020 2020 2020 2020 2020 2020  th).            
+0000c200: 6578 6365 7074 2045 7863 6570 7469 6f6e  except Exception
+0000c210: 2061 7320 6578 3a0a 2020 2020 2020 2020   as ex:.        
+0000c220: 2020 2020 2020 2020 7365 6c66 2e6c 6f67          self.log
+0000c230: 2822 6669 6c65 7479 7065 2064 6574 6563  ("filetype detec
+0000c240: 7469 6f6e 2066 6169 6c65 6420 666f 7220  tion failed for 
+0000c250: 5b7b 7d5d 3a20 7b7d 222e 666f 726d 6174  [{}]: {}".format
+0000c260: 2870 6174 682c 2065 7829 2c20 3629 0a20  (path, ex), 6). 
+0000c270: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+0000c280: 7874 203d 204e 6f6e 650a 0a20 2020 2020  xt = None..     
+0000c290: 2020 2020 2020 2069 6620 6578 743a 0a20         if ext:. 
+0000c2a0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+0000c2b0: 6620 726e 643a 0a20 2020 2020 2020 2020  f rnd:.         
+0000c2c0: 2020 2020 2020 2020 2020 2066 6e32 203d             fn2 =
+0000c2d0: 2072 616e 645f 6e61 6d65 2866 6469 722c   rand_name(fdir,
+0000c2e0: 2022 612e 2220 2b20 6578 742c 2072 6e64   "a." + ext, rnd
+0000c2f0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0000c300: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+0000c310: 2020 2020 2020 2020 2020 2020 666e 3220              fn2 
+0000c320: 3d20 666e 2e72 7370 6c69 7428 222e 222c  = fn.rsplit(".",
+0000c330: 2031 295b 305d 202b 2022 2e22 202b 2065   1)[0] + "." + e
+0000c340: 7874 0a0a 2020 2020 2020 2020 2020 2020  xt..            
+0000c350: 2020 2020 7061 7261 6d73 5b22 7375 6666      params["suff
+0000c360: 6978 225d 203d 2073 7566 6669 785b 3a2d  ix"] = suffix[:-
+0000c370: 345d 0a20 2020 2020 2020 2020 2020 2020  4].             
+0000c380: 2020 2077 6974 6820 7265 6e5f 6f70 656e     with ren_open
+0000c390: 2866 6e2c 202a 6f70 656e 5f61 2c20 2a2a  (fn, *open_a, **
+0000c3a0: 7061 7261 6d73 2920 6173 207a 6677 3a0a  params) as zfw:.
+0000c3b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c3c0: 2020 2020 662c 2066 6e20 3d20 7a66 775b      f, fn = zfw[
+0000c3d0: 226f 727a 225d 0a0a 2020 2020 2020 2020  "orz"]..        
+0000c3e0: 2020 2020 2020 2020 7061 7468 3220 3d20          path2 = 
+0000c3f0: 6f73 2e70 6174 682e 6a6f 696e 2866 6469  os.path.join(fdi
+0000c400: 722c 2066 6e32 290a 2020 2020 2020 2020  r, fn2).        
+0000c410: 2020 2020 2020 2020 6174 6f6d 6963 5f6d          atomic_m
+0000c420: 6f76 6528 7061 7468 2c20 7061 7468 3229  ove(path, path2)
+0000c430: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000c440: 2066 6e20 3d20 666e 320a 2020 2020 2020   fn = fn2.      
+0000c450: 2020 2020 2020 2020 2020 7061 7468 203d            path =
+0000c460: 2070 6174 6832 0a0a 2020 2020 2020 2020   path2..        
+0000c470: 6966 2078 6175 2061 6e64 206e 6f74 2072  if xau and not r
+0000c480: 756e 686f 6f6b 280a 2020 2020 2020 2020  unhook(.        
+0000c490: 2020 2020 7365 6c66 2e6c 6f67 2c0a 2020      self.log,.  
+0000c4a0: 2020 2020 2020 2020 2020 7861 752c 0a20            xau,. 
+0000c4b0: 2020 2020 2020 2020 2020 2070 6174 682c             path,
+0000c4c0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+0000c4d0: 662e 7670 6174 682c 0a20 2020 2020 2020  f.vpath,.       
+0000c4e0: 2020 2020 2073 656c 662e 686f 7374 2c0a       self.host,.
+0000c4f0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+0000c500: 2e75 6e61 6d65 2c0a 2020 2020 2020 2020  .uname,.        
+0000c510: 2020 2020 6d74 2c0a 2020 2020 2020 2020      mt,.        
+0000c520: 2020 2020 706f 7374 5f73 7a2c 0a20 2020      post_sz,.   
+0000c530: 2020 2020 2020 2020 2073 656c 662e 6970           self.ip
+0000c540: 2c0a 2020 2020 2020 2020 2020 2020 6174  ,.            at
+0000c550: 2c0a 2020 2020 2020 2020 2020 2020 2222  ,.            ""
+0000c560: 2c0a 2020 2020 2020 2020 293a 0a20 2020  ,.        ):.   
+0000c570: 2020 2020 2020 2020 2074 203d 2022 7570           t = "up
+0000c580: 6c6f 6164 2062 6c6f 636b 6564 2062 7920  load blocked by 
+0000c590: 7861 7520 7365 7276 6572 2063 6f6e 6669  xau server confi
+0000c5a0: 6722 0a20 2020 2020 2020 2020 2020 2073  g".            s
+0000c5b0: 656c 662e 6c6f 6728 742c 2031 290a 2020  elf.log(t, 1).  
+0000c5c0: 2020 2020 2020 2020 2020 6f73 2e75 6e6c            os.unl
+0000c5d0: 696e 6b28 7061 7468 290a 2020 2020 2020  ink(path).      
+0000c5e0: 2020 2020 2020 7261 6973 6520 5065 626b        raise Pebk
+0000c5f0: 6163 2834 3033 2c20 7429 0a0a 2020 2020  ac(403, t)..    
+0000c600: 2020 2020 7666 732c 2072 656d 203d 2076      vfs, rem = v
+0000c610: 6673 2e67 6574 5f64 6276 2872 656d 290a  fs.get_dbv(rem).
+0000c620: 2020 2020 2020 2020 7365 6c66 2e63 6f6e          self.con
+0000c630: 6e2e 6873 7276 2e62 726f 6b65 722e 7361  n.hsrv.broker.sa
+0000c640: 7928 0a20 2020 2020 2020 2020 2020 2022  y(.            "
+0000c650: 7570 326b 2e68 6173 685f 6669 6c65 222c  up2k.hash_file",
+0000c660: 0a20 2020 2020 2020 2020 2020 2076 6673  .            vfs
+0000c670: 2e72 6561 6c70 6174 682c 0a20 2020 2020  .realpath,.     
+0000c680: 2020 2020 2020 2076 6673 2e76 7061 7468         vfs.vpath
+0000c690: 2c0a 2020 2020 2020 2020 2020 2020 7666  ,.            vf
+0000c6a0: 732e 666c 6167 732c 0a20 2020 2020 2020  s.flags,.       
+0000c6b0: 2020 2020 2072 656d 2c0a 2020 2020 2020       rem,.      
+0000c6c0: 2020 2020 2020 666e 2c0a 2020 2020 2020        fn,.      
+0000c6d0: 2020 2020 2020 7365 6c66 2e69 702c 0a20        self.ip,. 
+0000c6e0: 2020 2020 2020 2020 2020 2061 742c 0a20             at,. 
+0000c6f0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+0000c700: 756e 616d 652c 0a20 2020 2020 2020 2020  uname,.         
+0000c710: 2020 2054 7275 652c 0a20 2020 2020 2020     True,.       
+0000c720: 2029 0a0a 2020 2020 2020 2020 7673 7566   )..        vsuf
+0000c730: 203d 2022 220a 2020 2020 2020 2020 6966   = "".        if
+0000c740: 2028 7365 6c66 2e63 616e 5f72 6561 6420   (self.can_read 
+0000c750: 6f72 2073 656c 662e 6361 6e5f 7570 6765  or self.can_upge
+0000c760: 7429 2061 6e64 2022 666b 2220 696e 2076  t) and "fk" in v
+0000c770: 6673 2e66 6c61 6773 3a0a 2020 2020 2020  fs.flags:.      
+0000c780: 2020 2020 2020 7673 7566 203d 2022 3f6b        vsuf = "?k
+0000c790: 3d22 202b 2073 656c 662e 6765 6e5f 666b  =" + self.gen_fk
+0000c7a0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+0000c7b0: 2020 7365 6c66 2e61 7267 732e 666b 5f73    self.args.fk_s
+0000c7c0: 616c 742c 0a20 2020 2020 2020 2020 2020  alt,.           
+0000c7d0: 2020 2020 2070 6174 682c 0a20 2020 2020       path,.     
+0000c7e0: 2020 2020 2020 2020 2020 2070 6f73 745f             post_
+0000c7f0: 737a 2c0a 2020 2020 2020 2020 2020 2020  sz,.            
+0000c800: 2020 2020 3020 6966 2041 4e59 5749 4e20      0 if ANYWIN 
+0000c810: 656c 7365 2062 6f73 2e73 7461 7428 7061  else bos.stat(pa
+0000c820: 7468 292e 7374 5f69 6e6f 2c0a 2020 2020  th).st_ino,.    
+0000c830: 2020 2020 2020 2020 295b 3a20 7666 732e          )[: vfs.
+0000c840: 666c 6167 735b 2266 6b22 5d5d 0a0a 2020  flags["fk"]]..  
+0000c850: 2020 2020 2020 7670 6174 6820 3d20 222f        vpath = "/
+0000c860: 222e 6a6f 696e 285b 7820 666f 7220 7820  ".join([x for x 
+0000c870: 696e 205b 7666 732e 7670 6174 682c 2072  in [vfs.vpath, r
+0000c880: 656d 2c20 666e 5d20 6966 2078 5d29 0a20  em, fn] if x]). 
+0000c890: 2020 2020 2020 2076 7061 7468 203d 2071         vpath = q
+0000c8a0: 756f 7465 7028 7670 6174 6829 0a0a 2020  uotep(vpath)..  
+0000c8b0: 2020 2020 2020 7572 6c20 3d20 227b 7d3a        url = "{}:
+0000c8c0: 2f2f 7b7d 2f7b 7d22 2e66 6f72 6d61 7428  //{}/{}".format(
+0000c8d0: 0a20 2020 2020 2020 2020 2020 2022 6874  .            "ht
+0000c8e0: 7470 7322 2069 6620 7365 6c66 2e69 735f  tps" if self.is_
+0000c8f0: 6874 7470 7320 656c 7365 2022 6874 7470  https else "http
+0000c900: 222c 0a20 2020 2020 2020 2020 2020 2073  ",.            s
+0000c910: 656c 662e 686f 7374 2c0a 2020 2020 2020  elf.host,.      
+0000c920: 2020 2020 2020 7365 6c66 2e61 7267 732e        self.args.
+0000c930: 5253 202b 2076 7061 7468 202b 2076 7375  RS + vpath + vsu
+0000c940: 662c 0a20 2020 2020 2020 2029 0a0a 2020  f,.        )..  
+0000c950: 2020 2020 2020 7265 7475 726e 2070 6f73        return pos
+0000c960: 745f 737a 2c20 7368 615f 6865 782c 2073  t_sz, sha_hex, s
+0000c970: 6861 5f62 3634 2c20 7265 6d61 696e 732c  ha_b64, remains,
+0000c980: 2070 6174 682c 2075 726c 0a0a 2020 2020   path, url..    
+0000c990: 6465 6620 6861 6e64 6c65 5f73 7461 7368  def handle_stash
+0000c9a0: 2873 656c 662c 2069 735f 7075 7420 2920  (self, is_put ) 
+0000c9b0: 203a 0a20 2020 2020 2020 2070 6f73 745f   :.        post_
+0000c9c0: 737a 2c20 7368 615f 6865 782c 2073 6861  sz, sha_hex, sha
+0000c9d0: 5f62 3634 2c20 7265 6d61 696e 732c 2070  _b64, remains, p
+0000c9e0: 6174 682c 2075 726c 203d 2073 656c 662e  ath, url = self.
+0000c9f0: 6475 6d70 5f74 6f5f 6669 6c65 2869 735f  dump_to_file(is_
+0000ca00: 7075 7429 0a20 2020 2020 2020 2073 7064  put).        spd
+0000ca10: 203d 2073 656c 662e 5f73 7064 2870 6f73   = self._spd(pos
+0000ca20: 745f 737a 290a 2020 2020 2020 2020 7420  t_sz).        t 
+0000ca30: 3d20 227b 7d20 7772 6f74 6520 7b7d 2f7b  = "{} wrote {}/{
+0000ca40: 7d20 6279 7465 7320 746f 207b 7d20 2023  } bytes to {}  #
+0000ca50: 207b 7d22 0a20 2020 2020 2020 2073 656c   {}".        sel
+0000ca60: 662e 6c6f 6728 742e 666f 726d 6174 2873  f.log(t.format(s
+0000ca70: 7064 2c20 706f 7374 5f73 7a2c 2072 656d  pd, post_sz, rem
+0000ca80: 6169 6e73 2c20 7061 7468 2c20 7368 615f  ains, path, sha_
+0000ca90: 6236 345b 3a32 385d 2929 2020 2320 3231  b64[:28]))  # 21
+0000caa0: 0a0a 2020 2020 2020 2020 6163 203d 2073  ..        ac = s
+0000cab0: 656c 662e 7570 6172 616d 2e67 6574 280a  elf.uparam.get(.
+0000cac0: 2020 2020 2020 2020 2020 2020 2277 616e              "wan
+0000cad0: 7422 2c20 7365 6c66 2e68 6561 6465 7273  t", self.headers
+0000cae0: 2e67 6574 2822 6163 6365 7074 222c 2022  .get("accept", "
+0000caf0: 2229 2e6c 6f77 6572 2829 2e73 706c 6974  ").lower().split
+0000cb00: 2822 3b22 295b 2d31 5d0a 2020 2020 2020  (";")[-1].      
+0000cb10: 2020 290a 2020 2020 2020 2020 6966 2061    ).        if a
+0000cb20: 6320 3d3d 2022 7572 6c22 3a0a 2020 2020  c == "url":.    
+0000cb30: 2020 2020 2020 2020 7420 3d20 7572 6c0a          t = url.
+0000cb40: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+0000cb50: 2020 2020 2020 2020 2020 7420 3d20 227b            t = "{
+0000cb60: 7d5c 6e7b 7d5c 6e7b 7d5c 6e7b 7d5c 6e22  }\n{}\n{}\n{}\n"
+0000cb70: 2e66 6f72 6d61 7428 706f 7374 5f73 7a2c  .format(post_sz,
+0000cb80: 2073 6861 5f62 3634 2c20 7368 615f 6865   sha_b64, sha_he
+0000cb90: 785b 3a35 365d 2c20 7572 6c29 0a0a 2020  x[:56], url)..  
+0000cba0: 2020 2020 2020 6820 3d20 7b22 4c6f 6361        h = {"Loca
+0000cbb0: 7469 6f6e 223a 2075 726c 7d20 6966 2069  tion": url} if i
+0000cbc0: 735f 7075 7420 616e 6420 7572 6c20 656c  s_put and url el
+0000cbd0: 7365 207b 7d0a 0a20 2020 2020 2020 2069  se {}..        i
+0000cbe0: 6620 2278 2d6f 632d 6d74 696d 6522 2069  f "x-oc-mtime" i
+0000cbf0: 6e20 7365 6c66 2e68 6561 6465 7273 3a0a  n self.headers:.
+0000cc00: 2020 2020 2020 2020 2020 2020 685b 2258              h["X
+0000cc10: 2d4f 432d 4d54 696d 6522 5d20 3d20 2261  -OC-MTime"] = "a
+0000cc20: 6363 6570 7465 6422 0a20 2020 2020 2020  ccepted".       
+0000cc30: 2020 2020 2074 203d 2022 2220 2023 2073       t = ""  # s
+0000cc40: 6f6d 6520 7765 6264 6176 2063 6c69 656e  ome webdav clien
+0000cc50: 7473 2065 7870 6563 742f 7072 6566 6572  ts expect/prefer
+0000cc60: 2074 6869 730a 0a20 2020 2020 2020 2073   this..        s
+0000cc70: 656c 662e 7265 706c 7928 742e 656e 636f  elf.reply(t.enco
+0000cc80: 6465 2822 7574 662d 3822 292c 2032 3031  de("utf-8"), 201
+0000cc90: 2c20 6865 6164 6572 733d 6829 0a20 2020  , headers=h).   
+0000cca0: 2020 2020 2072 6574 7572 6e20 5472 7565       return True
+0000ccb0: 0a0a 2020 2020 6465 6620 6261 6b66 6c69  ..    def bakfli
+0000ccc0: 7028 7365 6c66 2c20 6620 2c20 6f66 7320  p(self, f , ofs 
+0000ccd0: 2c20 737a 202c 2073 6861 2029 2020 3a0a  , sz , sha )  :.
+0000cce0: 2020 2020 2020 2020 6966 206e 6f74 2073          if not s
+0000ccf0: 656c 662e 6172 6773 2e62 616b 5f66 6c69  elf.args.bak_fli
+0000cd00: 7073 206f 7220 7365 6c66 2e61 7267 732e  ps or self.args.
+0000cd10: 6e77 3a0a 2020 2020 2020 2020 2020 2020  nw:.            
+0000cd20: 7265 7475 726e 0a0a 2020 2020 2020 2020  return..        
+0000cd30: 7364 6972 203d 2073 656c 662e 6172 6773  sdir = self.args
+0000cd40: 2e62 665f 6469 720a 2020 2020 2020 2020  .bf_dir.        
+0000cd50: 6670 203d 206f 732e 7061 7468 2e6a 6f69  fp = os.path.joi
+0000cd60: 6e28 7364 6972 2c20 7368 6129 0a20 2020  n(sdir, sha).   
+0000cd70: 2020 2020 2069 6620 626f 732e 7061 7468       if bos.path
+0000cd80: 2e65 7869 7374 7328 6670 293a 0a20 2020  .exists(fp):.   
+0000cd90: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+0000cda0: 7365 6c66 2e6c 6f67 2822 6e6f 2062 616b  self.log("no bak
+0000cdb0: 666c 6970 3b20 6861 7665 2069 7422 2c20  flip; have it", 
+0000cdc0: 3629 0a0a 2020 2020 2020 2020 6966 206e  6)..        if n
+0000cdd0: 6f74 2062 6f73 2e70 6174 682e 6973 6469  ot bos.path.isdi
+0000cde0: 7228 7364 6972 293a 0a20 2020 2020 2020  r(sdir):.       
+0000cdf0: 2020 2020 2062 6f73 2e6d 616b 6564 6972       bos.makedir
+0000ce00: 7328 7364 6972 290a 0a20 2020 2020 2020  s(sdir)..       
+0000ce10: 2069 6620 6c65 6e28 626f 732e 6c69 7374   if len(bos.list
+0000ce20: 6469 7228 7364 6972 2929 203e 3d20 7365  dir(sdir)) >= se
+0000ce30: 6c66 2e61 7267 732e 6266 5f6e 633a 0a20  lf.args.bf_nc:. 
+0000ce40: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+0000ce50: 6e20 7365 6c66 2e6c 6f67 2822 6e6f 2062  n self.log("no b
+0000ce60: 616b 666c 6970 3b20 746f 6f20 6d61 6e79  akflip; too many
+0000ce70: 222c 2033 290a 0a20 2020 2020 2020 206e  ", 3)..        n
+0000ce80: 7265 6d20 3d20 737a 0a20 2020 2020 2020  rem = sz.       
+0000ce90: 2066 2e73 6565 6b28 6f66 7329 0a20 2020   f.seek(ofs).   
+0000cea0: 2020 2020 2077 6974 6820 6f70 656e 2866       with open(f
+0000ceb0: 702c 2022 7762 2229 2061 7320 666f 3a0a  p, "wb") as fo:.
+0000cec0: 2020 2020 2020 2020 2020 2020 7768 696c              whil
+0000ced0: 6520 6e72 656d 3a0a 2020 2020 2020 2020  e nrem:.        
+0000cee0: 2020 2020 2020 2020 6275 6620 3d20 662e          buf = f.
+0000cef0: 7265 6164 286d 696e 286e 7265 6d2c 2035  read(min(nrem, 5
+0000cf00: 3132 202a 2031 3032 3429 290a 2020 2020  12 * 1024)).    
+0000cf10: 2020 2020 2020 2020 2020 2020 6966 206e              if n
+0000cf20: 6f74 2062 7566 3a0a 2020 2020 2020 2020  ot buf:.        
+0000cf30: 2020 2020 2020 2020 2020 2020 6272 6561              brea
+0000cf40: 6b0a 0a20 2020 2020 2020 2020 2020 2020  k..             
+0000cf50: 2020 206e 7265 6d20 2d3d 206c 656e 2862     nrem -= len(b
+0000cf60: 7566 290a 2020 2020 2020 2020 2020 2020  uf).            
+0000cf70: 2020 2020 666f 2e77 7269 7465 2862 7566      fo.write(buf
+0000cf80: 290a 0a20 2020 2020 2020 2069 6620 6e72  )..        if nr
+0000cf90: 656d 3a0a 2020 2020 2020 2020 2020 2020  em:.            
+0000cfa0: 7365 6c66 2e6c 6f67 2822 6261 6b66 6c69  self.log("bakfli
+0000cfb0: 7020 7472 756e 6361 7465 643b 207b 7d20  p truncated; {} 
+0000cfc0: 7265 6d61 696e 7322 2e66 6f72 6d61 7428  remains".format(
+0000cfd0: 6e72 656d 292c 2031 290a 2020 2020 2020  nrem), 1).      
+0000cfe0: 2020 2020 2020 6174 6f6d 6963 5f6d 6f76        atomic_mov
+0000cff0: 6528 6670 2c20 6670 202b 2022 2e74 7275  e(fp, fp + ".tru
+0000d000: 6e63 2229 0a20 2020 2020 2020 2065 6c73  nc").        els
+0000d010: 653a 0a20 2020 2020 2020 2020 2020 2073  e:.            s
+0000d020: 656c 662e 6c6f 6728 2262 616b 666c 6970  elf.log("bakflip
+0000d030: 206f 6b22 2c20 3229 0a0a 2020 2020 6465   ok", 2)..    de
+0000d040: 6620 5f73 7064 2873 656c 662c 206e 6279  f _spd(self, nby
+0000d050: 7465 7320 2c20 6164 6420 203d 2054 7275  tes , add  = Tru
+0000d060: 6529 2020 3a0a 2020 2020 2020 2020 6966  e)  :.        if
+0000d070: 2061 6464 3a0a 2020 2020 2020 2020 2020   add:.          
+0000d080: 2020 7365 6c66 2e63 6f6e 6e2e 6e62 7974    self.conn.nbyt
+0000d090: 6520 2b3d 206e 6279 7465 730a 0a20 2020  e += nbytes..   
+0000d0a0: 2020 2020 2073 7064 3120 3d20 6765 745f       spd1 = get_
+0000d0b0: 7370 6428 6e62 7974 6573 2c20 7365 6c66  spd(nbytes, self
+0000d0c0: 2e74 3029 0a20 2020 2020 2020 2073 7064  .t0).        spd
+0000d0d0: 3220 3d20 6765 745f 7370 6428 7365 6c66  2 = get_spd(self
+0000d0e0: 2e63 6f6e 6e2e 6e62 7974 652c 2073 656c  .conn.nbyte, sel
+0000d0f0: 662e 636f 6e6e 2e74 3029 0a20 2020 2020  f.conn.t0).     
+0000d100: 2020 2072 6574 7572 6e20 2225 7320 2573     return "%s %s
+0000d110: 206e 2573 2220 2520 2873 7064 312c 2073   n%s" % (spd1, s
+0000d120: 7064 322c 2073 656c 662e 636f 6e6e 2e6e  pd2, self.conn.n
+0000d130: 7265 7129 0a0a 2020 2020 6465 6620 6861  req)..    def ha
+0000d140: 6e64 6c65 5f70 6f73 745f 6d75 6c74 6970  ndle_post_multip
+0000d150: 6172 7428 7365 6c66 2920 203a 0a20 2020  art(self)  :.   
+0000d160: 2020 2020 2073 656c 662e 7061 7273 6572       self.parser
+0000d170: 203d 204d 756c 7469 7061 7274 5061 7273   = MultipartPars
+0000d180: 6572 2873 656c 662e 6c6f 672c 2073 656c  er(self.log, sel
+0000d190: 662e 7372 2c20 7365 6c66 2e68 6561 6465  f.sr, self.heade
+0000d1a0: 7273 290a 2020 2020 2020 2020 7365 6c66  rs).        self
+0000d1b0: 2e70 6172 7365 722e 7061 7273 6528 290a  .parser.parse().
+0000d1c0: 0a20 2020 2020 2020 2061 6374 203d 2073  .        act = s
+0000d1d0: 656c 662e 7061 7273 6572 2e72 6571 7569  elf.parser.requi
+0000d1e0: 7265 2822 6163 7422 2c20 3634 290a 0a20  re("act", 64).. 
+0000d1f0: 2020 2020 2020 2069 6620 6163 7420 3d3d         if act ==
+0000d200: 2022 6c6f 6769 6e22 3a0a 2020 2020 2020   "login":.      
+0000d210: 2020 2020 2020 7265 7475 726e 2073 656c        return sel
+0000d220: 662e 6861 6e64 6c65 5f6c 6f67 696e 2829  f.handle_login()
+0000d230: 0a0a 2020 2020 2020 2020 6966 2061 6374  ..        if act
+0000d240: 203d 3d20 226d 6b64 6972 223a 0a20 2020   == "mkdir":.   
+0000d250: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+0000d260: 7365 6c66 2e68 616e 646c 655f 6d6b 6469  self.handle_mkdi
+0000d270: 7228 290a 0a20 2020 2020 2020 2069 6620  r()..        if 
+0000d280: 6163 7420 3d3d 2022 6e65 775f 6d64 223a  act == "new_md":
+0000d290: 0a20 2020 2020 2020 2020 2020 2023 206b  .            # k
+0000d2a0: 696e 6461 2073 696c 6c79 2062 7574 2068  inda silly but h
+0000d2b0: 6173 2074 6865 206c 6561 7374 2073 6964  as the least sid
+0000d2c0: 6520 6566 6665 6374 730a 2020 2020 2020  e effects.      
+0000d2d0: 2020 2020 2020 7265 7475 726e 2073 656c        return sel
+0000d2e0: 662e 6861 6e64 6c65 5f6e 6577 5f6d 6428  f.handle_new_md(
+0000d2f0: 290a 0a20 2020 2020 2020 2069 6620 6163  )..        if ac
+0000d300: 7420 3d3d 2022 6270 7574 223a 0a20 2020  t == "bput":.   
+0000d310: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+0000d320: 7365 6c66 2e68 616e 646c 655f 706c 6169  self.handle_plai
+0000d330: 6e5f 7570 6c6f 6164 2829 0a0a 2020 2020  n_upload()..    
+0000d340: 2020 2020 6966 2061 6374 203d 3d20 2274      if act == "t
+0000d350: 7075 7422 3a0a 2020 2020 2020 2020 2020  put":.          
+0000d360: 2020 7265 7475 726e 2073 656c 662e 6861    return self.ha
+0000d370: 6e64 6c65 5f74 6578 745f 7570 6c6f 6164  ndle_text_upload
+0000d380: 2829 0a0a 2020 2020 2020 2020 6966 2061  ()..        if a
+0000d390: 6374 203d 3d20 227a 6970 223a 0a20 2020  ct == "zip":.   
+0000d3a0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+0000d3b0: 7365 6c66 2e68 616e 646c 655f 7a69 705f  self.handle_zip_
+0000d3c0: 706f 7374 2829 0a0a 2020 2020 2020 2020  post()..        
+0000d3d0: 7261 6973 6520 5065 626b 6163 2834 3232  raise Pebkac(422
+0000d3e0: 2c20 2769 6e76 616c 6964 2061 6374 696f  , 'invalid actio
+0000d3f0: 6e20 227b 7d22 272e 666f 726d 6174 2861  n "{}"'.format(a
+0000d400: 6374 2929 0a0a 2020 2020 6465 6620 6861  ct))..    def ha
+0000d410: 6e64 6c65 5f7a 6970 5f70 6f73 7428 7365  ndle_zip_post(se
+0000d420: 6c66 2920 203a 0a20 2020 2020 2020 2061  lf)  :.        a
+0000d430: 7373 6572 7420 7365 6c66 2e70 6172 7365  ssert self.parse
+0000d440: 720a 2020 2020 2020 2020 7472 793a 0a20  r.        try:. 
+0000d450: 2020 2020 2020 2020 2020 206b 203d 206e             k = n
+0000d460: 6578 7428 7820 666f 7220 7820 696e 2073  ext(x for x in s
+0000d470: 656c 662e 7570 6172 616d 2069 6620 7820  elf.uparam if x 
+0000d480: 696e 2028 227a 6970 222c 2022 7461 7222  in ("zip", "tar"
+0000d490: 2929 0a20 2020 2020 2020 2065 7863 6570  )).        excep
+0000d4a0: 743a 0a20 2020 2020 2020 2020 2020 2072  t:.            r
+0000d4b0: 6169 7365 2050 6562 6b61 6328 3432 322c  aise Pebkac(422,
+0000d4c0: 2022 6e65 6564 207a 6970 206f 7220 7461   "need zip or ta
+0000d4d0: 7220 6b65 7977 6f72 6422 290a 0a20 2020  r keyword")..   
+0000d4e0: 2020 2020 2076 203d 2073 656c 662e 7570       v = self.up
+0000d4f0: 6172 616d 5b6b 5d0a 0a20 2020 2020 2020  aram[k]..       
+0000d500: 2076 6e2c 2072 656d 203d 2073 656c 662e   vn, rem = self.
+0000d510: 6173 7276 2e76 6673 2e67 6574 2873 656c  asrv.vfs.get(sel
+0000d520: 662e 7670 6174 682c 2073 656c 662e 756e  f.vpath, self.un
+0000d530: 616d 652c 2054 7275 652c 2046 616c 7365  ame, True, False
+0000d540: 290a 2020 2020 2020 2020 7a73 203d 2073  ).        zs = s
+0000d550: 656c 662e 7061 7273 6572 2e72 6571 7569  elf.parser.requi
+0000d560: 7265 2822 6669 6c65 7322 2c20 3130 3234  re("files", 1024
+0000d570: 202a 2031 3032 3429 0a20 2020 2020 2020   * 1024).       
+0000d580: 2069 6620 6e6f 7420 7a73 3a0a 2020 2020   if not zs:.    
+0000d590: 2020 2020 2020 2020 7261 6973 6520 5065          raise Pe
+0000d5a0: 626b 6163 2834 3232 2c20 226e 6565 6420  bkac(422, "need 
+0000d5b0: 6669 6c65 7320 6c69 7374 2229 0a0a 2020  files list")..  
+0000d5c0: 2020 2020 2020 6974 656d 7320 3d20 7a73        items = zs
+0000d5d0: 2e72 6570 6c61 6365 2822 5c72 222c 2022  .replace("\r", "
+0000d5e0: 2229 2e73 706c 6974 2822 5c6e 2229 0a20  ").split("\n"). 
+0000d5f0: 2020 2020 2020 2069 7465 6d73 203d 205b         items = [
+0000d600: 756e 7175 6f74 6570 2878 2920 666f 7220  unquotep(x) for 
+0000d610: 7820 696e 2069 7465 6d73 2069 6620 6974  x in items if it
+0000d620: 656d 735d 0a0a 2020 2020 2020 2020 7365  ems]..        se
+0000d630: 6c66 2e70 6172 7365 722e 6472 6f70 2829  lf.parser.drop()
+0000d640: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+0000d650: 7365 6c66 2e74 785f 7a69 7028 6b2c 2076  self.tx_zip(k, v
+0000d660: 2c20 2222 2c20 766e 2c20 7265 6d2c 2069  , "", vn, rem, i
+0000d670: 7465 6d73 2c20 7365 6c66 2e61 7267 732e  tems, self.args.
+0000d680: 6564 290a 0a20 2020 2064 6566 2068 616e  ed)..    def han
+0000d690: 646c 655f 706f 7374 5f6a 736f 6e28 7365  dle_post_json(se
+0000d6a0: 6c66 2920 203a 0a20 2020 2020 2020 2074  lf)  :.        t
+0000d6b0: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
+0000d6c0: 7265 6d61 696e 7320 3d20 696e 7428 7365  remains = int(se
+0000d6d0: 6c66 2e68 6561 6465 7273 5b22 636f 6e74  lf.headers["cont
+0000d6e0: 656e 742d 6c65 6e67 7468 225d 290a 2020  ent-length"]).  
+0000d6f0: 2020 2020 2020 6578 6365 7074 3a0a 2020        except:.  
+0000d700: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
+0000d710: 5065 626b 6163 2834 3131 290a 0a20 2020  Pebkac(411)..   
+0000d720: 2020 2020 2069 6620 7265 6d61 696e 7320       if remains 
+0000d730: 3e20 3130 3234 202a 2031 3032 343a 0a20  > 1024 * 1024:. 
+0000d740: 2020 2020 2020 2020 2020 2072 6169 7365             raise
+0000d750: 2050 6562 6b61 6328 3431 332c 2022 6a73   Pebkac(413, "js
+0000d760: 6f6e 2032 6269 6722 290a 0a20 2020 2020  on 2big")..     
+0000d770: 2020 2065 6e63 203d 2022 7574 662d 3822     enc = "utf-8"
+0000d780: 0a20 2020 2020 2020 2063 7479 7065 203d  .        ctype =
+0000d790: 2073 656c 662e 6865 6164 6572 732e 6765   self.headers.ge
+0000d7a0: 7428 2263 6f6e 7465 6e74 2d74 7970 6522  t("content-type"
+0000d7b0: 2c20 2222 292e 6c6f 7765 7228 290a 2020  , "").lower().  
+0000d7c0: 2020 2020 2020 6966 2022 6368 6172 7365        if "charse
+0000d7d0: 7422 2069 6e20 6374 7970 653a 0a20 2020  t" in ctype:.   
+0000d7e0: 2020 2020 2020 2020 2065 6e63 203d 2063           enc = c
+0000d7f0: 7479 7065 2e73 706c 6974 2822 6368 6172  type.split("char
+0000d800: 7365 7422 295b 315d 2e73 7472 6970 2822  set")[1].strip("
+0000d810: 203d 2229 2e73 706c 6974 2822 3b22 295b   =").split(";")[
+0000d820: 305d 2e73 7472 6970 2829 0a0a 2020 2020  0].strip()..    
+0000d830: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
+0000d840: 2020 2020 206a 736f 6e5f 6275 6620 3d20       json_buf = 
+0000d850: 7365 6c66 2e73 722e 7265 6376 5f65 7828  self.sr.recv_ex(
+0000d860: 7265 6d61 696e 7329 0a20 2020 2020 2020  remains).       
+0000d870: 2065 7863 6570 7420 556e 7265 6376 454f   except UnrecvEO
+0000d880: 463a 0a20 2020 2020 2020 2020 2020 2072  F:.            r
+0000d890: 6169 7365 2050 6562 6b61 6328 3432 322c  aise Pebkac(422,
+0000d8a0: 2022 636c 6965 6e74 2064 6973 636f 6e6e   "client disconn
+0000d8b0: 6563 7465 6420 7768 696c 6520 706f 7374  ected while post
+0000d8c0: 696e 6720 4a53 4f4e 2229 0a0a 2020 2020  ing JSON")..    
+0000d8d0: 2020 2020 7365 6c66 2e6c 6f67 2822 6465      self.log("de
+0000d8e0: 636f 6469 6e67 207b 7d20 6279 7465 7320  coding {} bytes 
+0000d8f0: 6f66 207b 7d20 6a73 6f6e 222e 666f 726d  of {} json".form
+0000d900: 6174 286c 656e 286a 736f 6e5f 6275 6629  at(len(json_buf)
+0000d910: 2c20 656e 6329 290a 2020 2020 2020 2020  , enc)).        
+0000d920: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
+0000d930: 2062 6f64 7920 3d20 6a73 6f6e 2e6c 6f61   body = json.loa
+0000d940: 6473 286a 736f 6e5f 6275 662e 6465 636f  ds(json_buf.deco
+0000d950: 6465 2865 6e63 2c20 2272 6570 6c61 6365  de(enc, "replace
+0000d960: 2229 290a 2020 2020 2020 2020 6578 6365  ")).        exce
+0000d970: 7074 3a0a 2020 2020 2020 2020 2020 2020  pt:.            
+0000d980: 7261 6973 6520 5065 626b 6163 2834 3232  raise Pebkac(422
+0000d990: 2c20 2279 6f75 2050 4f53 5465 6420 696e  , "you POSTed in
+0000d9a0: 7661 6c69 6420 6a73 6f6e 2229 0a0a 2020  valid json")..  
+0000d9b0: 2020 2020 2020 2320 7365 6c66 2e72 6570        # self.rep
+0000d9c0: 6c79 2862 2263 6c6f 7564 666c 6172 6522  ly(b"cloudflare"
+0000d9d0: 2c20 3530 3329 0a20 2020 2020 2020 2023  , 503).        #
+0000d9e0: 2072 6574 7572 6e20 5472 7565 0a0a 2020   return True..  
+0000d9f0: 2020 2020 2020 6966 2022 7372 6368 2220        if "srch" 
+0000da00: 696e 2073 656c 662e 7570 6172 616d 206f  in self.uparam o
+0000da10: 7220 2273 7263 6822 2069 6e20 626f 6479  r "srch" in body
+0000da20: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
+0000da30: 7475 726e 2073 656c 662e 6861 6e64 6c65  turn self.handle
+0000da40: 5f73 6561 7263 6828 626f 6479 290a 0a20  _search(body).. 
+0000da50: 2020 2020 2020 2069 6620 2264 656c 6574         if "delet
+0000da60: 6522 2069 6e20 7365 6c66 2e75 7061 7261  e" in self.upara
+0000da70: 6d3a 0a20 2020 2020 2020 2020 2020 2072  m:.            r
+0000da80: 6574 7572 6e20 7365 6c66 2e68 616e 646c  eturn self.handl
+0000da90: 655f 726d 2862 6f64 7929 0a0a 2020 2020  e_rm(body)..    
+0000daa0: 2020 2020 6e61 6d65 203d 2075 6e64 6f74      name = undot
+0000dab0: 2862 6f64 795b 226e 616d 6522 5d29 0a20  (body["name"]). 
+0000dac0: 2020 2020 2020 2069 6620 222f 2220 696e         if "/" in
+0000dad0: 206e 616d 653a 0a20 2020 2020 2020 2020   name:.         
+0000dae0: 2020 2072 6169 7365 2050 6562 6b61 6328     raise Pebkac(
+0000daf0: 3430 302c 2022 796f 7572 2063 6c69 656e  400, "your clien
+0000db00: 7420 6973 206f 6c64 3b20 7072 6573 7320  t is old; press 
+0000db10: 4354 524c 2d53 4849 4654 2d52 2061 6e64  CTRL-SHIFT-R and
+0000db20: 2074 7279 2061 6761 696e 2229 0a0a 2020   try again")..  
+0000db30: 2020 2020 2020 7666 732c 2072 656d 203d        vfs, rem =
+0000db40: 2073 656c 662e 6173 7276 2e76 6673 2e67   self.asrv.vfs.g
+0000db50: 6574 2873 656c 662e 7670 6174 682c 2073  et(self.vpath, s
+0000db60: 656c 662e 756e 616d 652c 2046 616c 7365  elf.uname, False
+0000db70: 2c20 5472 7565 290a 2020 2020 2020 2020  , True).        
+0000db80: 6462 762c 2076 7265 6d20 3d20 7666 732e  dbv, vrem = vfs.
+0000db90: 6765 745f 6462 7628 7265 6d29 0a0a 2020  get_dbv(rem)..  
+0000dba0: 2020 2020 2020 626f 6479 5b22 7674 6f70        body["vtop
+0000dbb0: 225d 203d 2064 6276 2e76 7061 7468 0a20  "] = dbv.vpath. 
+0000dbc0: 2020 2020 2020 2062 6f64 795b 2270 746f         body["pto
+0000dbd0: 7022 5d20 3d20 6462 762e 7265 616c 7061  p"] = dbv.realpa
+0000dbe0: 7468 0a20 2020 2020 2020 2062 6f64 795b  th.        body[
+0000dbf0: 2270 7265 6c22 5d20 3d20 7672 656d 0a20  "prel"] = vrem. 
+0000dc00: 2020 2020 2020 2062 6f64 795b 2268 6f73         body["hos
+0000dc10: 7422 5d20 3d20 7365 6c66 2e68 6f73 740a  t"] = self.host.
+0000dc20: 2020 2020 2020 2020 626f 6479 5b22 7573          body["us
+0000dc30: 6572 225d 203d 2073 656c 662e 756e 616d  er"] = self.unam
+0000dc40: 650a 2020 2020 2020 2020 626f 6479 5b22  e.        body["
+0000dc50: 6164 6472 225d 203d 2073 656c 662e 6970  addr"] = self.ip
+0000dc60: 0a20 2020 2020 2020 2062 6f64 795b 2276  .        body["v
+0000dc70: 6366 6722 5d20 3d20 6462 762e 666c 6167  cfg"] = dbv.flag
+0000dc80: 730a 0a20 2020 2020 2020 2069 6620 6e6f  s..        if no
+0000dc90: 7420 7365 6c66 2e63 616e 5f64 656c 6574  t self.can_delet
+0000dca0: 653a 0a20 2020 2020 2020 2020 2020 2062  e:.            b
+0000dcb0: 6f64 792e 706f 7028 2272 6570 6c61 6365  ody.pop("replace
+0000dcc0: 222c 204e 6f6e 6529 0a0a 2020 2020 2020  ", None)..      
+0000dcd0: 2020 6966 2072 656d 3a0a 2020 2020 2020    if rem:.      
+0000dce0: 2020 2020 2020 6473 7420 3d20 7666 732e        dst = vfs.
+0000dcf0: 6361 6e6f 6e69 6361 6c28 7265 6d29 0a20  canonical(rem). 
+0000dd00: 2020 2020 2020 2020 2020 2074 7279 3a0a             try:.
+0000dd10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000dd20: 6966 206e 6f74 2062 6f73 2e70 6174 682e  if not bos.path.
+0000dd30: 6973 6469 7228 6473 7429 3a0a 2020 2020  isdir(dst):.    
+0000dd40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000dd50: 626f 732e 6d61 6b65 6469 7273 2864 7374  bos.makedirs(dst
+0000dd60: 290a 2020 2020 2020 2020 2020 2020 6578  ).            ex
+0000dd70: 6365 7074 204f 5345 7272 6f72 2061 7320  cept OSError as 
+0000dd80: 6578 3a0a 2020 2020 2020 2020 2020 2020  ex:.            
+0000dd90: 2020 2020 7365 6c66 2e6c 6f67 2822 6d61      self.log("ma
+0000dda0: 6b65 6469 7273 2066 6169 6c65 6420 5b7b  kedirs failed [{
+0000ddb0: 7d5d 222e 666f 726d 6174 2864 7374 2929  }]".format(dst))
+0000ddc0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000ddd0: 2069 6620 6e6f 7420 626f 732e 7061 7468   if not bos.path
+0000dde0: 2e69 7364 6972 2864 7374 293a 0a20 2020  .isdir(dst):.   
+0000ddf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000de00: 2069 6620 6578 2e65 7272 6e6f 203d 3d20   if ex.errno == 
+0000de10: 6572 726e 6f2e 4541 4343 4553 3a0a 2020  errno.EACCES:.  
+0000de20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000de30: 2020 2020 2020 7261 6973 6520 5065 626b        raise Pebk
+0000de40: 6163 2835 3030 2c20 2274 6865 2073 6572  ac(500, "the ser
+0000de50: 7665 7220 4f53 2064 656e 6965 6420 7772  ver OS denied wr
+0000de60: 6974 652d 6163 6365 7373 2229 0a0a 2020  ite-access")..  
+0000de70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000de80: 2020 6966 2065 782e 6572 726e 6f20 3d3d    if ex.errno ==
+0000de90: 2065 7272 6e6f 2e45 4558 4953 543a 0a20   errno.EEXIST:. 
+0000dea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000deb0: 2020 2020 2020 2072 6169 7365 2050 6562         raise Peb
+0000dec0: 6b61 6328 3430 302c 2022 736f 6d65 2066  kac(400, "some f
+0000ded0: 696c 6520 676f 7420 796f 7572 2066 6f6c  ile got your fol
+0000dee0: 6465 7220 6e61 6d65 2229 0a0a 2020 2020  der name")..    
+0000def0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000df00: 7261 6973 6520 5065 626b 6163 2835 3030  raise Pebkac(500
+0000df10: 2c20 6d69 6e5f 6578 2829 290a 2020 2020  , min_ex()).    
+0000df20: 2020 2020 2020 2020 6578 6365 7074 3a0a          except:.
+0000df30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000df40: 7261 6973 6520 5065 626b 6163 2835 3030  raise Pebkac(500
+0000df50: 2c20 6d69 6e5f 6578 2829 290a 0a20 2020  , min_ex())..   
+0000df60: 2020 2020 2078 203d 2073 656c 662e 636f       x = self.co
+0000df70: 6e6e 2e68 7372 762e 6272 6f6b 6572 2e61  nn.hsrv.broker.a
+0000df80: 736b 2822 7570 326b 2e68 616e 646c 655f  sk("up2k.handle_
+0000df90: 6a73 6f6e 222c 2062 6f64 792c 2073 656c  json", body, sel
+0000dfa0: 662e 7532 6668 2e61 7073 290a 2020 2020  f.u2fh.aps).    
+0000dfb0: 2020 2020 7265 7420 3d20 782e 6765 7428      ret = x.get(
+0000dfc0: 290a 2020 2020 2020 2020 6966 2073 656c  ).        if sel
+0000dfd0: 662e 6973 5f76 7072 6f78 6965 643a 0a20  f.is_vproxied:. 
+0000dfe0: 2020 2020 2020 2020 2020 2069 6620 2270             if "p
+0000dff0: 7572 6c22 2069 6e20 7265 743a 0a20 2020  url" in ret:.   
+0000e000: 2020 2020 2020 2020 2020 2020 2072 6574               ret
+0000e010: 5b22 7075 726c 225d 203d 2073 656c 662e  ["purl"] = self.
+0000e020: 6172 6773 2e53 5220 2b20 7265 745b 2270  args.SR + ret["p
+0000e030: 7572 6c22 5d0a 0a20 2020 2020 2020 2072  url"]..        r
+0000e040: 6574 203d 206a 736f 6e2e 6475 6d70 7328  et = json.dumps(
+0000e050: 7265 7429 0a20 2020 2020 2020 2073 656c  ret).        sel
+0000e060: 662e 6c6f 6728 7265 7429 0a20 2020 2020  f.log(ret).     
+0000e070: 2020 2073 656c 662e 7265 706c 7928 7265     self.reply(re
+0000e080: 742e 656e 636f 6465 2822 7574 662d 3822  t.encode("utf-8"
+0000e090: 292c 206d 696d 653d 2261 7070 6c69 6361  ), mime="applica
+0000e0a0: 7469 6f6e 2f6a 736f 6e22 290a 2020 2020  tion/json").    
+0000e0b0: 2020 2020 7265 7475 726e 2054 7275 650a      return True.
+0000e0c0: 0a20 2020 2064 6566 2068 616e 646c 655f  .    def handle_
+0000e0d0: 7365 6172 6368 2873 656c 662c 2062 6f64  search(self, bod
+0000e0e0: 7920 2029 2020 3a0a 2020 2020 2020 2020  y  )  :.        
+0000e0f0: 6964 7820 3d20 7365 6c66 2e63 6f6e 6e2e  idx = self.conn.
+0000e100: 6765 745f 7532 6964 7828 290a 2020 2020  get_u2idx().    
+0000e110: 2020 2020 6966 206e 6f74 2069 6478 206f      if not idx o
+0000e120: 7220 6e6f 7420 6861 7361 7474 7228 6964  r not hasattr(id
+0000e130: 782c 2022 705f 656e 6422 293a 0a20 2020  x, "p_end"):.   
+0000e140: 2020 2020 2020 2020 2072 6169 7365 2050           raise P
+0000e150: 6562 6b61 6328 3530 302c 2022 7371 6c69  ebkac(500, "sqli
+0000e160: 7465 3320 6973 206e 6f74 2061 7661 696c  te3 is not avail
+0000e170: 6162 6c65 206f 6e20 7468 6520 7365 7276  able on the serv
+0000e180: 6572 3b20 6361 6e6e 6f74 2073 6561 7263  er; cannot searc
+0000e190: 6822 290a 0a20 2020 2020 2020 2076 6f6c  h")..        vol
+0000e1a0: 7320 3d20 5b5d 0a20 2020 2020 2020 2073  s = [].        s
+0000e1b0: 6565 6e20 3d20 7b7d 0a20 2020 2020 2020  een = {}.       
+0000e1c0: 2066 6f72 2076 746f 7020 696e 2073 656c   for vtop in sel
+0000e1d0: 662e 7276 6f6c 3a0a 2020 2020 2020 2020  f.rvol:.        
+0000e1e0: 2020 2020 7666 732c 205f 203d 2073 656c      vfs, _ = sel
+0000e1f0: 662e 6173 7276 2e76 6673 2e67 6574 2876  f.asrv.vfs.get(v
+0000e200: 746f 702c 2073 656c 662e 756e 616d 652c  top, self.uname,
+0000e210: 2054 7275 652c 2046 616c 7365 290a 2020   True, False).  
+0000e220: 2020 2020 2020 2020 2020 7666 7320 3d20            vfs = 
+0000e230: 7666 732e 6462 7620 6f72 2076 6673 0a20  vfs.dbv or vfs. 
+0000e240: 2020 2020 2020 2020 2020 2069 6620 7666             if vf
+0000e250: 7320 696e 2073 6565 6e3a 0a20 2020 2020  s in seen:.     
+0000e260: 2020 2020 2020 2020 2020 2063 6f6e 7469             conti
+0000e270: 6e75 650a 0a20 2020 2020 2020 2020 2020  nue..           
+0000e280: 2073 6565 6e5b 7666 735d 203d 2054 7275   seen[vfs] = Tru
+0000e290: 650a 2020 2020 2020 2020 2020 2020 766f  e.            vo
+0000e2a0: 6c73 2e61 7070 656e 6428 2876 6673 2e76  ls.append((vfs.v
+0000e2b0: 7061 7468 2c20 7666 732e 7265 616c 7061  path, vfs.realpa
+0000e2c0: 7468 2c20 7666 732e 666c 6167 7329 290a  th, vfs.flags)).
+0000e2d0: 0a20 2020 2020 2020 2074 3020 3d20 7469  .        t0 = ti
+0000e2e0: 6d65 2e74 696d 6528 290a 2020 2020 2020  me.time().      
+0000e2f0: 2020 6966 2069 6478 2e70 5f65 6e64 3a0a    if idx.p_end:.
+0000e300: 2020 2020 2020 2020 2020 2020 7065 6e61              pena
+0000e310: 6c74 7920 3d20 302e 370a 2020 2020 2020  lty = 0.7.      
+0000e320: 2020 2020 2020 745f 6964 6c65 203d 2074        t_idle = t
+0000e330: 3020 2d20 6964 782e 705f 656e 640a 2020  0 - idx.p_end.  
+0000e340: 2020 2020 2020 2020 2020 6966 2069 6478            if idx
+0000e350: 2e70 5f64 7572 203e 2030 2e37 2061 6e64  .p_dur > 0.7 and
+0000e360: 2074 5f69 646c 6520 3c20 7065 6e61 6c74   t_idle < penalt
+0000e370: 793a 0a20 2020 2020 2020 2020 2020 2020  y:.             
+0000e380: 2020 2074 203d 2022 7261 7465 2d6c 696d     t = "rate-lim
+0000e390: 6974 207b 3a2e 3166 7d20 7365 632c 2063  it {:.1f} sec, c
+0000e3a0: 6f73 7420 7b3a 2e32 667d 2c20 6964 6c65  ost {:.2f}, idle
+0000e3b0: 207b 3a2e 3266 7d22 0a20 2020 2020 2020   {:.2f}".       
+0000e3c0: 2020 2020 2020 2020 2072 6169 7365 2050           raise P
+0000e3d0: 6562 6b61 6328 3432 392c 2074 2e66 6f72  ebkac(429, t.for
+0000e3e0: 6d61 7428 7065 6e61 6c74 792c 2069 6478  mat(penalty, idx
+0000e3f0: 2e70 5f64 7572 2c20 745f 6964 6c65 2929  .p_dur, t_idle))
+0000e400: 0a0a 2020 2020 2020 2020 6966 2022 7372  ..        if "sr
+0000e410: 6368 2220 696e 2062 6f64 793a 0a20 2020  ch" in body:.   
+0000e420: 2020 2020 2020 2020 2023 2073 6561 7263           # searc
+0000e430: 6820 6279 2075 7032 6b20 6861 7368 6c69  h by up2k hashli
+0000e440: 7374 0a20 2020 2020 2020 2020 2020 2076  st.            v
+0000e450: 626f 6479 203d 2063 6f70 792e 6465 6570  body = copy.deep
+0000e460: 636f 7079 2862 6f64 7929 0a20 2020 2020  copy(body).     
+0000e470: 2020 2020 2020 2076 626f 6479 5b22 6861         vbody["ha
+0000e480: 7368 225d 203d 206c 656e 2876 626f 6479  sh"] = len(vbody
+0000e490: 5b22 6861 7368 225d 290a 2020 2020 2020  ["hash"]).      
+0000e4a0: 2020 2020 2020 7365 6c66 2e6c 6f67 2822        self.log("
+0000e4b0: 716a 3a20 2220 2b20 7265 7072 2876 626f  qj: " + repr(vbo
+0000e4c0: 6479 2929 0a20 2020 2020 2020 2020 2020  dy)).           
+0000e4d0: 2068 6974 7320 3d20 6964 782e 6673 6561   hits = idx.fsea
+0000e4e0: 7263 6828 766f 6c73 2c20 626f 6479 290a  rch(vols, body).
+0000e4f0: 2020 2020 2020 2020 2020 2020 6d73 6720              msg 
+0000e500: 203d 2072 6570 7228 6869 7473 290a 2020   = repr(hits).  
+0000e510: 2020 2020 2020 2020 2020 7461 676c 6973            taglis
+0000e520: 7420 203d 205b 5d0a 2020 2020 2020 2020  t  = [].        
+0000e530: 2020 2020 7472 756e 6320 3d20 4661 6c73      trunc = Fals
+0000e540: 650a 2020 2020 2020 2020 656c 7365 3a0a  e.        else:.
+0000e550: 2020 2020 2020 2020 2020 2020 2320 7365              # se
+0000e560: 6172 6368 2062 7920 7175 6572 7920 7061  arch by query pa
+0000e570: 7261 6d73 0a20 2020 2020 2020 2020 2020  rams.           
+0000e580: 2071 203d 2062 6f64 795b 2271 225d 0a20   q = body["q"]. 
+0000e590: 2020 2020 2020 2020 2020 206e 203d 2062             n = b
+0000e5a0: 6f64 792e 6765 7428 226e 222c 2073 656c  ody.get("n", sel
+0000e5b0: 662e 6172 6773 2e73 7263 685f 6869 7473  f.args.srch_hits
+0000e5c0: 290a 2020 2020 2020 2020 2020 2020 7365  ).            se
+0000e5d0: 6c66 2e6c 6f67 2822 716a 3a20 7b7d 207c  lf.log("qj: {} |
+0000e5e0: 7b7d 7c22 2e66 6f72 6d61 7428 712c 206e  {}|".format(q, n
+0000e5f0: 2929 0a20 2020 2020 2020 2020 2020 2068  )).            h
+0000e600: 6974 732c 2074 6167 6c69 7374 2c20 7472  its, taglist, tr
+0000e610: 756e 6320 3d20 6964 782e 7365 6172 6368  unc = idx.search
+0000e620: 2876 6f6c 732c 2071 2c20 6e29 0a20 2020  (vols, q, n).   
+0000e630: 2020 2020 2020 2020 206d 7367 203d 206c           msg = l
+0000e640: 656e 2868 6974 7329 0a0a 2020 2020 2020  en(hits)..      
+0000e650: 2020 6964 782e 705f 656e 6420 3d20 7469    idx.p_end = ti
+0000e660: 6d65 2e74 696d 6528 290a 2020 2020 2020  me.time().      
+0000e670: 2020 6964 782e 705f 6475 7220 3d20 6964    idx.p_dur = id
+0000e680: 782e 705f 656e 6420 2d20 7430 0a20 2020  x.p_end - t0.   
+0000e690: 2020 2020 2073 656c 662e 6c6f 6728 2271       self.log("q
+0000e6a0: 233a 207b 7d20 287b 3a2e 3266 7d73 2922  #: {} ({:.2f}s)"
+0000e6b0: 2e66 6f72 6d61 7428 6d73 672c 2069 6478  .format(msg, idx
+0000e6c0: 2e70 5f64 7572 2929 0a0a 2020 2020 2020  .p_dur))..      
+0000e6d0: 2020 6f72 6465 7220 3d20 5b5d 0a20 2020    order = [].   
+0000e6e0: 2020 2020 2063 6667 203d 2073 656c 662e       cfg = self.
+0000e6f0: 6172 6773 2e6d 7465 2e73 706c 6974 2822  args.mte.split("
+0000e700: 2c22 290a 2020 2020 2020 2020 666f 7220  ,").        for 
+0000e710: 7420 696e 2063 6667 3a0a 2020 2020 2020  t in cfg:.      
+0000e720: 2020 2020 2020 6966 2074 2069 6e20 7461        if t in ta
+0000e730: 676c 6973 743a 0a20 2020 2020 2020 2020  glist:.         
+0000e740: 2020 2020 2020 206f 7264 6572 2e61 7070         order.app
+0000e750: 656e 6428 7429 0a20 2020 2020 2020 2066  end(t).        f
+0000e760: 6f72 2074 2069 6e20 7461 676c 6973 743a  or t in taglist:
+0000e770: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+0000e780: 7420 6e6f 7420 696e 206f 7264 6572 3a0a  t not in order:.
+0000e790: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e7a0: 6f72 6465 722e 6170 7065 6e64 2874 290a  order.append(t).
+0000e7b0: 0a20 2020 2020 2020 2069 6620 7365 6c66  .        if self
+0000e7c0: 2e69 735f 7670 726f 7869 6564 3a0a 2020  .is_vproxied:.  
+0000e7d0: 2020 2020 2020 2020 2020 666f 7220 6869            for hi
+0000e7e0: 7420 696e 2068 6974 733a 0a20 2020 2020  t in hits:.     
+0000e7f0: 2020 2020 2020 2020 2020 2068 6974 5b22             hit["
+0000e800: 7270 225d 203d 2073 656c 662e 6172 6773  rp"] = self.args
+0000e810: 2e52 5320 2b20 6869 745b 2272 7022 5d0a  .RS + hit["rp"].
+0000e820: 0a20 2020 2020 2020 2072 6a20 3d20 7b22  .        rj = {"
+0000e830: 6869 7473 223a 2068 6974 732c 2022 7461  hits": hits, "ta
+0000e840: 675f 6f72 6465 7222 3a20 6f72 6465 722c  g_order": order,
+0000e850: 2022 7472 756e 6322 3a20 7472 756e 637d   "trunc": trunc}
+0000e860: 0a20 2020 2020 2020 2072 203d 206a 736f  .        r = jso
+0000e870: 6e2e 6475 6d70 7328 726a 292e 656e 636f  n.dumps(rj).enco
+0000e880: 6465 2822 7574 662d 3822 290a 2020 2020  de("utf-8").    
+0000e890: 2020 2020 7365 6c66 2e72 6570 6c79 2872      self.reply(r
+0000e8a0: 2c20 6d69 6d65 3d22 6170 706c 6963 6174  , mime="applicat
+0000e8b0: 696f 6e2f 6a73 6f6e 2229 0a20 2020 2020  ion/json").     
+0000e8c0: 2020 2072 6574 7572 6e20 5472 7565 0a0a     return True..
+0000e8d0: 2020 2020 6465 6620 6861 6e64 6c65 5f70      def handle_p
+0000e8e0: 6f73 745f 6269 6e61 7279 2873 656c 6629  ost_binary(self)
+0000e8f0: 2020 3a0a 2020 2020 2020 2020 7472 793a    :.        try:
+0000e900: 0a20 2020 2020 2020 2020 2020 2072 656d  .            rem
+0000e910: 6169 6e73 203d 2069 6e74 2873 656c 662e  ains = int(self.
+0000e920: 6865 6164 6572 735b 2263 6f6e 7465 6e74  headers["content
+0000e930: 2d6c 656e 6774 6822 5d29 0a20 2020 2020  -length"]).     
+0000e940: 2020 2065 7863 6570 743a 0a20 2020 2020     except:.     
+0000e950: 2020 2020 2020 2072 6169 7365 2050 6562         raise Peb
+0000e960: 6b61 6328 3430 302c 2022 796f 7520 6d75  kac(400, "you mu
+0000e970: 7374 2073 7570 706c 7920 6120 636f 6e74  st supply a cont
+0000e980: 656e 742d 6c65 6e67 7468 2066 6f72 2062  ent-length for b
+0000e990: 696e 6172 7920 504f 5354 2229 0a0a 2020  inary POST")..  
+0000e9a0: 2020 2020 2020 7472 793a 0a20 2020 2020        try:.     
+0000e9b0: 2020 2020 2020 2063 6861 7368 203d 2073         chash = s
+0000e9c0: 656c 662e 6865 6164 6572 735b 2278 2d75  elf.headers["x-u
+0000e9d0: 7032 6b2d 6861 7368 225d 0a20 2020 2020  p2k-hash"].     
+0000e9e0: 2020 2020 2020 2077 6172 6b20 3d20 7365         wark = se
+0000e9f0: 6c66 2e68 6561 6465 7273 5b22 782d 7570  lf.headers["x-up
+0000ea00: 326b 2d77 6172 6b22 5d0a 2020 2020 2020  2k-wark"].      
+0000ea10: 2020 6578 6365 7074 204b 6579 4572 726f    except KeyErro
+0000ea20: 723a 0a20 2020 2020 2020 2020 2020 2072  r:.            r
+0000ea30: 6169 7365 2050 6562 6b61 6328 3430 302c  aise Pebkac(400,
+0000ea40: 2022 6e65 6564 2068 6173 6820 616e 6420   "need hash and 
+0000ea50: 7761 726b 2068 6561 6465 7273 2066 6f72  wark headers for
+0000ea60: 2062 696e 6172 7920 504f 5354 2229 0a0a   binary POST")..
+0000ea70: 2020 2020 2020 2020 7666 732c 205f 203d          vfs, _ =
+0000ea80: 2073 656c 662e 6173 7276 2e76 6673 2e67   self.asrv.vfs.g
+0000ea90: 6574 2873 656c 662e 7670 6174 682c 2073  et(self.vpath, s
+0000eaa0: 656c 662e 756e 616d 652c 2046 616c 7365  elf.uname, False
+0000eab0: 2c20 5472 7565 290a 2020 2020 2020 2020  , True).        
+0000eac0: 7074 6f70 203d 2028 7666 732e 6462 7620  ptop = (vfs.dbv 
+0000ead0: 6f72 2076 6673 292e 7265 616c 7061 7468  or vfs).realpath
+0000eae0: 0a0a 2020 2020 2020 2020 7820 3d20 7365  ..        x = se
+0000eaf0: 6c66 2e63 6f6e 6e2e 6873 7276 2e62 726f  lf.conn.hsrv.bro
+0000eb00: 6b65 722e 6173 6b28 2275 7032 6b2e 6861  ker.ask("up2k.ha
+0000eb10: 6e64 6c65 5f63 6875 6e6b 222c 2070 746f  ndle_chunk", pto
+0000eb20: 702c 2077 6172 6b2c 2063 6861 7368 290a  p, wark, chash).
+0000eb30: 2020 2020 2020 2020 7265 7370 6f6e 7365          response
+0000eb40: 203d 2078 2e67 6574 2829 0a20 2020 2020   = x.get().     
+0000eb50: 2020 2063 6875 6e6b 7369 7a65 2c20 6373     chunksize, cs
+0000eb60: 7461 7274 2c20 7061 7468 2c20 6c61 7374  tart, path, last
+0000eb70: 6d6f 642c 2073 7072 7320 3d20 7265 7370  mod, sprs = resp
+0000eb80: 6f6e 7365 0a0a 2020 2020 2020 2020 7472  onse..        tr
+0000eb90: 793a 0a20 2020 2020 2020 2020 2020 2069  y:.            i
+0000eba0: 6620 7365 6c66 2e61 7267 732e 6e77 3a0a  f self.args.nw:.
+0000ebb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ebc0: 7061 7468 203d 206f 732e 6465 766e 756c  path = os.devnul
+0000ebd0: 6c0a 0a20 2020 2020 2020 2020 2020 2069  l..            i
+0000ebe0: 6620 7265 6d61 696e 7320 3e20 6368 756e  f remains > chun
+0000ebf0: 6b73 697a 653a 0a20 2020 2020 2020 2020  ksize:.         
+0000ec00: 2020 2020 2020 2072 6169 7365 2050 6562         raise Peb
+0000ec10: 6b61 6328 3430 302c 2022 796f 7572 2063  kac(400, "your c
+0000ec20: 6875 6e6b 2069 7320 746f 6f20 6269 6720  hunk is too big 
+0000ec30: 746f 2066 6974 2229 0a0a 2020 2020 2020  to fit")..      
+0000ec40: 2020 2020 2020 7365 6c66 2e6c 6f67 2822        self.log("
+0000ec50: 7772 6974 696e 6720 7b7d 2023 7b7d 2040  writing {} #{} @
+0000ec60: 7b7d 206c 656e 207b 7d22 2e66 6f72 6d61  {} len {}".forma
+0000ec70: 7428 7061 7468 2c20 6368 6173 682c 2063  t(path, chash, c
+0000ec80: 7374 6172 742c 2072 656d 6169 6e73 2929  start, remains))
+0000ec90: 0a0a 2020 2020 2020 2020 2020 2020 7265  ..            re
+0000eca0: 6164 6572 203d 2072 6561 645f 736f 636b  ader = read_sock
+0000ecb0: 6574 2873 656c 662e 7372 2c20 7265 6d61  et(self.sr, rema
+0000ecc0: 696e 7329 0a0a 2020 2020 2020 2020 2020  ins)..          
+0000ecd0: 2020 6620 3d20 4e6f 6e65 0a20 2020 2020    f = None.     
+0000ece0: 2020 2020 2020 2066 706f 6f6c 203d 206e         fpool = n
+0000ecf0: 6f74 2073 656c 662e 6172 6773 2e6e 6f5f  ot self.args.no_
+0000ed00: 6670 6f6f 6c20 616e 6420 7370 7273 0a20  fpool and sprs. 
+0000ed10: 2020 2020 2020 2020 2020 2069 6620 6670             if fp
+0000ed20: 6f6f 6c3a 0a20 2020 2020 2020 2020 2020  ool:.           
+0000ed30: 2020 2020 2077 6974 6820 7365 6c66 2e6d       with self.m
+0000ed40: 7574 6578 3a0a 2020 2020 2020 2020 2020  utex:.          
+0000ed50: 2020 2020 2020 2020 2020 7472 793a 0a20            try:. 
+0000ed60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ed70: 2020 2020 2020 2066 203d 2073 656c 662e         f = self.
+0000ed80: 7532 6668 2e70 6f70 2870 6174 6829 0a20  u2fh.pop(path). 
+0000ed90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000eda0: 2020 2065 7863 6570 743a 0a20 2020 2020     except:.     
+0000edb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000edc0: 2020 2070 6173 730a 0a20 2020 2020 2020     pass..       
+0000edd0: 2020 2020 2066 203d 2066 206f 7220 6f70       f = f or op
+0000ede0: 656e 2866 7365 6e63 2870 6174 6829 2c20  en(fsenc(path), 
+0000edf0: 2272 622b 222c 2035 3132 202a 2031 3032  "rb+", 512 * 102
+0000ee00: 3429 0a0a 2020 2020 2020 2020 2020 2020  4)..            
+0000ee10: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
+0000ee20: 2020 2020 2066 2e73 6565 6b28 6373 7461       f.seek(csta
+0000ee30: 7274 5b30 5d29 0a20 2020 2020 2020 2020  rt[0]).         
+0000ee40: 2020 2020 2020 2070 6f73 745f 737a 2c20         post_sz, 
+0000ee50: 5f2c 2073 6861 5f62 3634 203d 2068 6173  _, sha_b64 = has
+0000ee60: 6863 6f70 7928 7265 6164 6572 2c20 662c  hcopy(reader, f,
+0000ee70: 2073 656c 662e 6172 6773 2e73 5f77 725f   self.args.s_wr_
+0000ee80: 736c 7029 0a0a 2020 2020 2020 2020 2020  slp)..          
+0000ee90: 2020 2020 2020 6966 2073 6861 5f62 3634        if sha_b64
+0000eea0: 2021 3d20 6368 6173 683a 0a20 2020 2020   != chash:.     
+0000eeb0: 2020 2020 2020 2020 2020 2020 2020 2074                 t
+0000eec0: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
+0000eed0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+0000eee0: 2e62 616b 666c 6970 2866 2c20 6373 7461  .bakflip(f, csta
+0000eef0: 7274 5b30 5d2c 2070 6f73 745f 737a 2c20  rt[0], post_sz, 
+0000ef00: 7368 615f 6236 3429 0a20 2020 2020 2020  sha_b64).       
+0000ef10: 2020 2020 2020 2020 2020 2020 2065 7863               exc
+0000ef20: 6570 743a 0a20 2020 2020 2020 2020 2020  ept:.           
+0000ef30: 2020 2020 2020 2020 2020 2020 2073 656c               sel
+0000ef40: 662e 6c6f 6728 2262 616b 666c 6970 2066  f.log("bakflip f
+0000ef50: 6169 6c65 643a 2022 202b 206d 696e 5f65  ailed: " + min_e
+0000ef60: 7828 2929 0a0a 2020 2020 2020 2020 2020  x())..          
+0000ef70: 2020 2020 2020 2020 2020 7420 3d20 2279            t = "y
+0000ef80: 6f75 7220 6368 756e 6b20 676f 7420 636f  our chunk got co
+0000ef90: 7272 7570 7465 6420 736f 6d65 686f 7720  rrupted somehow 
+0000efa0: 2872 6563 6569 7665 6420 7b7d 2062 7974  (received {} byt
+0000efb0: 6573 293b 2065 7870 6563 7465 6420 7673  es); expected vs
+0000efc0: 2072 6563 6569 7665 6420 6861 7368 3a5c   received hash:\
+0000efd0: 6e7b 7d5c 6e7b 7d22 0a20 2020 2020 2020  n{}\n{}".       
+0000efe0: 2020 2020 2020 2020 2020 2020 2072 6169               rai
+0000eff0: 7365 2050 6562 6b61 6328 3430 302c 2074  se Pebkac(400, t
+0000f000: 2e66 6f72 6d61 7428 706f 7374 5f73 7a2c  .format(post_sz,
+0000f010: 2063 6861 7368 2c20 7368 615f 6236 3429   chash, sha_b64)
+0000f020: 290a 0a20 2020 2020 2020 2020 2020 2020  )..             
+0000f030: 2020 2069 6620 6c65 6e28 6373 7461 7274     if len(cstart
+0000f040: 2920 3e20 3120 616e 6420 7061 7468 2021  ) > 1 and path !
+0000f050: 3d20 6f73 2e64 6576 6e75 6c6c 3a0a 2020  = os.devnull:.  
+0000f060: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f070: 2020 7365 6c66 2e6c 6f67 280a 2020 2020    self.log(.    
+0000f080: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f090: 2020 2020 2263 6c6f 6e65 207b 7d20 746f      "clone {} to
+0000f0a0: 207b 7d22 2e66 6f72 6d61 7428 0a20 2020   {}".format(.   
+0000f0b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f0c0: 2020 2020 2020 2020 2063 7374 6172 745b           cstart[
+0000f0d0: 305d 2c20 2220 2620 222e 6a6f 696e 2875  0], " & ".join(u
+0000f0e0: 6e69 636f 6465 2878 2920 666f 7220 7820  nicode(x) for x 
+0000f0f0: 696e 2063 7374 6172 745b 313a 5d29 0a20  in cstart[1:]). 
+0000f100: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f110: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+0000f120: 2020 2020 2020 2020 2020 2020 2029 0a20               ). 
+0000f130: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f140: 2020 206f 6673 203d 2030 0a20 2020 2020     ofs = 0.     
+0000f150: 2020 2020 2020 2020 2020 2020 2020 2077                 w
+0000f160: 6869 6c65 206f 6673 203c 2063 6875 6e6b  hile ofs < chunk
+0000f170: 7369 7a65 3a0a 2020 2020 2020 2020 2020  size:.          
+0000f180: 2020 2020 2020 2020 2020 2020 2020 6275                bu
+0000f190: 6673 7a20 3d20 6d69 6e28 6368 756e 6b73  fsz = min(chunks
+0000f1a0: 697a 6520 2d20 6f66 732c 2034 202a 2031  ize - ofs, 4 * 1
+0000f1b0: 3032 3420 2a20 3130 3234 290a 2020 2020  024 * 1024).    
+0000f1c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f1d0: 2020 2020 662e 7365 656b 2863 7374 6172      f.seek(cstar
+0000f1e0: 745b 305d 202b 206f 6673 290a 2020 2020  t[0] + ofs).    
+0000f1f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f200: 2020 2020 6275 6620 3d20 662e 7265 6164      buf = f.read
+0000f210: 2862 7566 737a 290a 2020 2020 2020 2020  (bufsz).        
+0000f220: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f230: 666f 7220 776f 6673 2069 6e20 6373 7461  for wofs in csta
+0000f240: 7274 5b31 3a5d 3a0a 2020 2020 2020 2020  rt[1:]:.        
+0000f250: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f260: 2020 2020 662e 7365 656b 2877 6f66 7320      f.seek(wofs 
+0000f270: 2b20 6f66 7329 0a20 2020 2020 2020 2020  + ofs).         
+0000f280: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f290: 2020 2066 2e77 7269 7465 2862 7566 290a     f.write(buf).
+0000f2a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000f2b0: 2020 2020 2020 2020 206f 6673 202b 3d20           ofs += 
+0000f2c0: 6c65 6e28 6275 6629 0a0a 2020 2020 2020  len(buf)..      
+0000f2d0: 2020 2020 2020 2020 2020 2020 2020 7365                se
+0000f2e0: 6c66 2e6c 6f67 2822 636c 6f6e 6520 7b7d  lf.log("clone {}
+0000f2f0: 2064 6f6e 6522 2e66 6f72 6d61 7428 6373   done".format(cs
+0000f300: 7461 7274 5b30 5d29 290a 0a20 2020 2020  tart[0]))..     
+0000f310: 2020 2020 2020 2020 2020 2069 6620 6e6f             if no
+0000f320: 7420 6670 6f6f 6c3a 0a20 2020 2020 2020  t fpool:.       
+0000f330: 2020 2020 2020 2020 2020 2020 2066 2e63               f.c
+0000f340: 6c6f 7365 2829 0a20 2020 2020 2020 2020  lose().         
+0000f350: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+0000f360: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f370: 2077 6974 6820 7365 6c66 2e6d 7574 6578   with self.mutex
+0000f380: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0000f390: 2020 2020 2020 2020 2020 7365 6c66 2e75            self.u
+0000f3a0: 3266 682e 7075 7428 7061 7468 2c20 6629  2fh.put(path, f)
+0000f3b0: 0a20 2020 2020 2020 2020 2020 2065 7863  .            exc
+0000f3c0: 6570 743a 0a20 2020 2020 2020 2020 2020  ept:.           
+0000f3d0: 2020 2020 2023 206d 6179 6265 2062 7573       # maybe bus
+0000f3e0: 7465 6420 6861 6e64 6c65 2028 6567 2e20  ted handle (eg. 
+0000f3f0: 6469 736b 2077 656e 7420 6675 6c6c 290a  disk went full).
+0000f400: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f410: 662e 636c 6f73 6528 290a 2020 2020 2020  f.close().      
+0000f420: 2020 2020 2020 2020 2020 7261 6973 650a            raise.
+0000f430: 2020 2020 2020 2020 6669 6e61 6c6c 793a          finally:
+0000f440: 0a20 2020 2020 2020 2020 2020 2078 203d  .            x =
+0000f450: 2073 656c 662e 636f 6e6e 2e68 7372 762e   self.conn.hsrv.
+0000f460: 6272 6f6b 6572 2e61 736b 2822 7570 326b  broker.ask("up2k
+0000f470: 2e72 656c 6561 7365 5f63 6875 6e6b 222c  .release_chunk",
+0000f480: 2070 746f 702c 2077 6172 6b2c 2063 6861   ptop, wark, cha
+0000f490: 7368 290a 2020 2020 2020 2020 2020 2020  sh).            
+0000f4a0: 782e 6765 7428 2920 2023 2062 6c6f 636b  x.get()  # block
+0000f4b0: 2063 6c69 656e 7420 756e 7469 6c20 7265   client until re
+0000f4c0: 6c65 6173 6564 0a0a 2020 2020 2020 2020  leased..        
+0000f4d0: 7820 3d20 7365 6c66 2e63 6f6e 6e2e 6873  x = self.conn.hs
+0000f4e0: 7276 2e62 726f 6b65 722e 6173 6b28 2275  rv.broker.ask("u
+0000f4f0: 7032 6b2e 636f 6e66 6972 6d5f 6368 756e  p2k.confirm_chun
+0000f500: 6b22 2c20 7074 6f70 2c20 7761 726b 2c20  k", ptop, wark, 
+0000f510: 6368 6173 6829 0a20 2020 2020 2020 207a  chash).        z
+0000f520: 7469 7320 3d20 782e 6765 7428 290a 2020  tis = x.get().  
+0000f530: 2020 2020 2020 7472 793a 0a20 2020 2020        try:.     
+0000f540: 2020 2020 2020 206e 756d 5f6c 6566 742c         num_left,
+0000f550: 2066 696e 5f70 6174 6820 3d20 7a74 6973   fin_path = ztis
+0000f560: 0a20 2020 2020 2020 2065 7863 6570 743a  .        except:
+0000f570: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+0000f580: 662e 6c6f 7564 5f72 6570 6c79 287a 7469  f.loud_reply(zti
+0000f590: 732c 2073 7461 7475 733d 3530 3029 0a20  s, status=500). 
+0000f5a0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+0000f5b0: 6e20 4661 6c73 650a 0a20 2020 2020 2020  n False..       
+0000f5c0: 2069 6620 6e6f 7420 6e75 6d5f 6c65 6674   if not num_left
+0000f5d0: 2061 6e64 2066 706f 6f6c 3a0a 2020 2020   and fpool:.    
+0000f5e0: 2020 2020 2020 2020 7769 7468 2073 656c          with sel
+0000f5f0: 662e 6d75 7465 783a 0a20 2020 2020 2020  f.mutex:.       
+0000f600: 2020 2020 2020 2020 2073 656c 662e 7532           self.u2
+0000f610: 6668 2e63 6c6f 7365 2870 6174 6829 0a0a  fh.close(path)..
+0000f620: 2020 2020 2020 2020 6966 206e 6f74 206e          if not n
+0000f630: 756d 5f6c 6566 7420 616e 6420 6e6f 7420  um_left and not 
+0000f640: 7365 6c66 2e61 7267 732e 6e77 3a0a 2020  self.args.nw:.  
+0000f650: 2020 2020 2020 2020 2020 7365 6c66 2e63            self.c
+0000f660: 6f6e 6e2e 6873 7276 2e62 726f 6b65 722e  onn.hsrv.broker.
+0000f670: 6173 6b28 0a20 2020 2020 2020 2020 2020  ask(.           
+0000f680: 2020 2020 2022 7570 326b 2e66 696e 6973       "up2k.finis
+0000f690: 685f 7570 6c6f 6164 222c 2070 746f 702c  h_upload", ptop,
+0000f6a0: 2077 6172 6b2c 2073 656c 662e 7532 6668   wark, self.u2fh
+0000f6b0: 2e61 7073 0a20 2020 2020 2020 2020 2020  .aps.           
+0000f6c0: 2029 2e67 6574 2829 0a0a 2020 2020 2020   ).get()..      
+0000f6d0: 2020 6369 6e66 203d 2073 656c 662e 6865    cinf = self.he
+0000f6e0: 6164 6572 732e 6765 7428 2278 2d75 7032  aders.get("x-up2
+0000f6f0: 6b2d 7374 6174 222c 2022 2229 0a0a 2020  k-stat", "")..  
+0000f700: 2020 2020 2020 7370 6420 3d20 7365 6c66        spd = self
+0000f710: 2e5f 7370 6428 706f 7374 5f73 7a29 0a20  ._spd(post_sz). 
+0000f720: 2020 2020 2020 2073 656c 662e 6c6f 6728         self.log(
+0000f730: 227b 3a37 307d 2074 6861 6e6b 207b 7d22  "{:70} thank {}"
+0000f740: 2e66 6f72 6d61 7428 7370 642c 2063 696e  .format(spd, cin
+0000f750: 6629 290a 2020 2020 2020 2020 7365 6c66  f)).        self
+0000f760: 2e72 6570 6c79 2862 2274 6861 6e6b 2229  .reply(b"thank")
+0000f770: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+0000f780: 5472 7565 0a0a 2020 2020 6465 6620 6861  True..    def ha
+0000f790: 6e64 6c65 5f6c 6f67 696e 2873 656c 6629  ndle_login(self)
+0000f7a0: 2020 3a0a 2020 2020 2020 2020 6173 7365    :.        asse
+0000f7b0: 7274 2073 656c 662e 7061 7273 6572 0a20  rt self.parser. 
+0000f7c0: 2020 2020 2020 2070 7764 203d 2073 656c         pwd = sel
+0000f7d0: 662e 7061 7273 6572 2e72 6571 7569 7265  f.parser.require
+0000f7e0: 2822 6370 7077 6422 2c20 3634 290a 2020  ("cppwd", 64).  
+0000f7f0: 2020 2020 2020 7365 6c66 2e70 6172 7365        self.parse
+0000f800: 722e 6472 6f70 2829 0a0a 2020 2020 2020  r.drop()..      
+0000f810: 2020 7365 6c66 2e6f 7574 5f68 6561 6465    self.out_heade
+0000f820: 726c 6973 7420 3d20 5b0a 2020 2020 2020  rlist = [.      
+0000f830: 2020 2020 2020 7820 666f 7220 7820 696e        x for x in
+0000f840: 2073 656c 662e 6f75 745f 6865 6164 6572   self.out_header
+0000f850: 6c69 7374 2069 6620 785b 305d 2021 3d20  list if x[0] != 
+0000f860: 2253 6574 2d43 6f6f 6b69 6522 206f 7220  "Set-Cookie" or 
+0000f870: 2263 7070 7722 2021 3d20 785b 315d 5b3a  "cppw" != x[1][:
+0000f880: 345d 0a20 2020 2020 2020 205d 0a0a 2020  4].        ]..  
+0000f890: 2020 2020 2020 6473 7420 3d20 7365 6c66        dst = self
+0000f8a0: 2e61 7267 732e 5352 530a 2020 2020 2020  .args.SRS.      
+0000f8b0: 2020 6966 2073 656c 662e 7670 6174 683a    if self.vpath:
+0000f8c0: 0a20 2020 2020 2020 2020 2020 2064 7374  .            dst
+0000f8d0: 202b 3d20 7175 6f74 6570 2873 656c 662e   += quotep(self.
+0000f8e0: 7670 6174 6829 0a0a 2020 2020 2020 2020  vpath)..        
+0000f8f0: 6d73 6720 3d20 7365 6c66 2e67 6574 5f70  msg = self.get_p
+0000f900: 7764 5f63 6f6f 6b69 6528 7077 6429 0a20  wd_cookie(pwd). 
+0000f910: 2020 2020 2020 2068 746d 6c20 3d20 7365         html = se
+0000f920: 6c66 2e6a 3273 2822 6d73 6722 2c20 6831  lf.j2s("msg", h1
+0000f930: 3d6d 7367 2c20 6832 3d27 3c61 2068 7265  =msg, h2='<a hre
+0000f940: 663d 2227 202b 2064 7374 202b 2027 223e  f="' + dst + '">
+0000f950: 6163 6b3c 2f61 3e27 2c20 7265 6469 723d  ack</a>', redir=
+0000f960: 6473 7429 0a20 2020 2020 2020 2073 656c  dst).        sel
+0000f970: 662e 7265 706c 7928 6874 6d6c 2e65 6e63  f.reply(html.enc
+0000f980: 6f64 6528 2275 7466 2d38 2229 290a 2020  ode("utf-8")).  
+0000f990: 2020 2020 2020 7265 7475 726e 2054 7275        return Tru
+0000f9a0: 650a 0a20 2020 2064 6566 2067 6574 5f70  e..    def get_p
+0000f9b0: 7764 5f63 6f6f 6b69 6528 7365 6c66 2c20  wd_cookie(self, 
+0000f9c0: 7077 6420 2920 203a 0a20 2020 2020 2020  pwd )  :.       
+0000f9d0: 2069 6620 7077 6420 696e 2073 656c 662e   if pwd in self.
+0000f9e0: 6173 7276 2e69 6163 6374 3a0a 2020 2020  asrv.iacct:.    
+0000f9f0: 2020 2020 2020 2020 6d73 6720 3d20 226c          msg = "l
+0000fa00: 6f67 696e 206f 6b22 0a20 2020 2020 2020  ogin ok".       
+0000fa10: 2020 2020 2064 7572 203d 2069 6e74 2836       dur = int(6
+0000fa20: 3020 2a20 3630 202a 2073 656c 662e 6172  0 * 60 * self.ar
+0000fa30: 6773 2e6c 6f67 6f75 7429 0a20 2020 2020  gs.logout).     
+0000fa40: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+0000fa50: 2020 2020 2073 656c 662e 6c6f 6728 2269       self.log("i
+0000fa60: 6e76 616c 6964 2070 6173 7377 6f72 643a  nvalid password:
+0000fa70: 207b 7d22 2e66 6f72 6d61 7428 7077 6429   {}".format(pwd)
+0000fa80: 2c20 3329 0a20 2020 2020 2020 2020 2020  , 3).           
+0000fa90: 2067 203d 2073 656c 662e 636f 6e6e 2e68   g = self.conn.h
+0000faa0: 7372 762e 6770 7764 0a20 2020 2020 2020  srv.gpwd.       
+0000fab0: 2020 2020 2069 6620 672e 6c69 6d3a 0a20       if g.lim:. 
+0000fac0: 2020 2020 2020 2020 2020 2020 2020 2062                 b
+0000fad0: 6f6e 6b2c 2069 7020 3d20 672e 626f 6e6b  onk, ip = g.bonk
+0000fae0: 2873 656c 662e 6970 2c20 7077 6429 0a20  (self.ip, pwd). 
+0000faf0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+0000fb00: 6620 626f 6e6b 3a0a 2020 2020 2020 2020  f bonk:.        
+0000fb10: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+0000fb20: 2e6c 6f67 2822 636c 6965 6e74 2062 616e  .log("client ban
+0000fb30: 6e65 643a 2069 6e76 616c 6964 2070 6173  ned: invalid pas
+0000fb40: 7377 6f72 6473 222c 2031 290a 2020 2020  swords", 1).    
+0000fb50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000fb60: 7365 6c66 2e63 6f6e 6e2e 6873 7276 2e62  self.conn.hsrv.b
+0000fb70: 616e 735b 6970 5d20 3d20 626f 6e6b 0a0a  ans[ip] = bonk..
+0000fb80: 2020 2020 2020 2020 2020 2020 6d73 6720              msg 
+0000fb90: 3d20 226e 6177 2064 7564 6522 0a20 2020  = "naw dude".   
+0000fba0: 2020 2020 2020 2020 2070 7764 203d 2022           pwd = "
+0000fbb0: 7822 2020 2320 6e6f 7365 630a 2020 2020  x"  # nosec.    
+0000fbc0: 2020 2020 2020 2020 6475 7220 3d20 4e6f          dur = No
+0000fbd0: 6e65 0a0a 2020 2020 2020 2020 6966 2070  ne..        if p
+0000fbe0: 7764 203d 3d20 2278 223a 0a20 2020 2020  wd == "x":.     
+0000fbf0: 2020 2020 2020 2023 2072 6573 6574 2062         # reset b
+0000fc00: 6f74 6820 706c 6169 6e74 6578 7420 616e  oth plaintext an
+0000fc10: 6420 746c 730a 2020 2020 2020 2020 2020  d tls.          
+0000fc20: 2020 2320 286f 6e6c 7920 6166 6665 6374    # (only affect
+0000fc30: 7320 6163 7469 7665 2074 6c73 2063 6f6f  s active tls coo
+0000fc40: 6b69 6573 2077 6865 6e20 746c 7329 0a20  kies when tls). 
+0000fc50: 2020 2020 2020 2020 2020 2066 6f72 206b             for k
+0000fc60: 2069 6e20 2822 6370 7077 6422 2c20 2263   in ("cppwd", "c
+0000fc70: 7070 7773 2229 2069 6620 7365 6c66 2e69  ppws") if self.i
+0000fc80: 735f 6874 7470 7320 656c 7365 2028 2263  s_https else ("c
+0000fc90: 7070 7764 222c 293a 0a20 2020 2020 2020  ppwd",):.       
+0000fca0: 2020 2020 2020 2020 2063 6b20 3d20 6765           ck = ge
+0000fcb0: 6e63 6f6f 6b69 6528 6b2c 2070 7764 2c20  ncookie(k, pwd, 
+0000fcc0: 7365 6c66 2e61 7267 732e 522c 2046 616c  self.args.R, Fal
+0000fcd0: 7365 2c20 6475 7229 0a20 2020 2020 2020  se, dur).       
+0000fce0: 2020 2020 2020 2020 2073 656c 662e 6f75           self.ou
+0000fcf0: 745f 6865 6164 6572 6c69 7374 2e61 7070  t_headerlist.app
+0000fd00: 656e 6428 2822 5365 742d 436f 6f6b 6965  end(("Set-Cookie
+0000fd10: 222c 2063 6b29 290a 2020 2020 2020 2020  ", ck)).        
+0000fd20: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+0000fd30: 2020 6b20 3d20 2263 7070 7773 2220 6966    k = "cppws" if
+0000fd40: 2073 656c 662e 6973 5f68 7474 7073 2065   self.is_https e
+0000fd50: 6c73 6520 2263 7070 7764 220a 2020 2020  lse "cppwd".    
+0000fd60: 2020 2020 2020 2020 636b 203d 2067 656e          ck = gen
+0000fd70: 636f 6f6b 6965 286b 2c20 7077 642c 2073  cookie(k, pwd, s
+0000fd80: 656c 662e 6172 6773 2e52 2c20 7365 6c66  elf.args.R, self
+0000fd90: 2e69 735f 6874 7470 732c 2064 7572 290a  .is_https, dur).
+0000fda0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+0000fdb0: 2e6f 7574 5f68 6561 6465 726c 6973 742e  .out_headerlist.
+0000fdc0: 6170 7065 6e64 2828 2253 6574 2d43 6f6f  append(("Set-Coo
+0000fdd0: 6b69 6522 2c20 636b 2929 0a0a 2020 2020  kie", ck))..    
+0000fde0: 2020 2020 7265 7475 726e 206d 7367 0a0a      return msg..
+0000fdf0: 2020 2020 6465 6620 6861 6e64 6c65 5f6d      def handle_m
+0000fe00: 6b64 6972 2873 656c 6629 2020 3a0a 2020  kdir(self)  :.  
+0000fe10: 2020 2020 2020 6173 7365 7274 2073 656c        assert sel
+0000fe20: 662e 7061 7273 6572 0a20 2020 2020 2020  f.parser.       
+0000fe30: 206e 6577 5f64 6972 203d 2073 656c 662e   new_dir = self.
+0000fe40: 7061 7273 6572 2e72 6571 7569 7265 2822  parser.require("
+0000fe50: 6e61 6d65 222c 2035 3132 290a 2020 2020  name", 512).    
+0000fe60: 2020 2020 7365 6c66 2e70 6172 7365 722e      self.parser.
+0000fe70: 6472 6f70 2829 0a0a 2020 2020 2020 2020  drop()..        
+0000fe80: 7361 6e69 7469 7a65 6420 3d20 7361 6e69  sanitized = sani
+0000fe90: 7469 7a65 5f66 6e28 6e65 775f 6469 722c  tize_fn(new_dir,
+0000fea0: 2022 222c 205b 5d29 0a20 2020 2020 2020   "", []).       
+0000feb0: 2072 6574 7572 6e20 7365 6c66 2e5f 6d6b   return self._mk
+0000fec0: 6469 7228 766a 6f69 6e28 7365 6c66 2e76  dir(vjoin(self.v
+0000fed0: 7061 7468 2c20 7361 6e69 7469 7a65 6429  path, sanitized)
+0000fee0: 290a 0a20 2020 2064 6566 205f 6d6b 6469  )..    def _mkdi
+0000fef0: 7228 7365 6c66 2c20 7670 6174 6820 2c20  r(self, vpath , 
+0000ff00: 6461 7620 203d 2046 616c 7365 2920 203a  dav  = False)  :
+0000ff10: 0a20 2020 2020 2020 206e 756c 6c77 7269  .        nullwri
+0000ff20: 7465 203d 2073 656c 662e 6172 6773 2e6e  te = self.args.n
+0000ff30: 770a 2020 2020 2020 2020 7666 732c 2072  w.        vfs, r
+0000ff40: 656d 203d 2073 656c 662e 6173 7276 2e76  em = self.asrv.v
+0000ff50: 6673 2e67 6574 2876 7061 7468 2c20 7365  fs.get(vpath, se
+0000ff60: 6c66 2e75 6e61 6d65 2c20 4661 6c73 652c  lf.uname, False,
+0000ff70: 2054 7275 6529 0a20 2020 2020 2020 2073   True).        s
+0000ff80: 656c 662e 5f61 7373 6572 745f 7361 6665  elf._assert_safe
+0000ff90: 5f72 656d 2872 656d 290a 2020 2020 2020  _rem(rem).      
+0000ffa0: 2020 666e 203d 2076 6673 2e63 616e 6f6e    fn = vfs.canon
+0000ffb0: 6963 616c 2872 656d 290a 0a20 2020 2020  ical(rem)..     
+0000ffc0: 2020 2069 6620 6e6f 7420 6e75 6c6c 7772     if not nullwr
+0000ffd0: 6974 653a 0a20 2020 2020 2020 2020 2020  ite:.           
+0000ffe0: 2066 6469 7220 3d20 6f73 2e70 6174 682e   fdir = os.path.
+0000fff0: 6469 726e 616d 6528 666e 290a 0a20 2020  dirname(fn)..   
+00010000: 2020 2020 2020 2020 2069 6620 6e6f 7420           if not 
+00010010: 626f 732e 7061 7468 2e69 7364 6972 2866  bos.path.isdir(f
+00010020: 6469 7229 3a0a 2020 2020 2020 2020 2020  dir):.          
+00010030: 2020 2020 2020 7261 6973 6520 5065 626b        raise Pebk
+00010040: 6163 2834 3039 2c20 2270 6172 656e 7420  ac(409, "parent 
+00010050: 666f 6c64 6572 2064 6f65 7320 6e6f 7420  folder does not 
+00010060: 6578 6973 7422 290a 0a20 2020 2020 2020  exist")..       
+00010070: 2020 2020 2069 6620 626f 732e 7061 7468       if bos.path
+00010080: 2e69 7364 6972 2866 6e29 3a0a 2020 2020  .isdir(fn):.    
+00010090: 2020 2020 2020 2020 2020 2020 7261 6973              rais
+000100a0: 6520 5065 626b 6163 2834 3035 2c20 2274  e Pebkac(405, "t
+000100b0: 6861 7420 666f 6c64 6572 2065 7869 7374  hat folder exist
+000100c0: 7320 616c 7265 6164 7922 290a 0a20 2020  s already")..   
+000100d0: 2020 2020 2020 2020 2074 7279 3a0a 2020           try:.  
+000100e0: 2020 2020 2020 2020 2020 2020 2020 626f                bo
+000100f0: 732e 6d6b 6469 7228 666e 290a 2020 2020  s.mkdir(fn).    
+00010100: 2020 2020 2020 2020 6578 6365 7074 204f          except O
+00010110: 5345 7272 6f72 2061 7320 6578 3a0a 2020  SError as ex:.  
+00010120: 2020 2020 2020 2020 2020 2020 2020 6966                if
+00010130: 2065 782e 6572 726e 6f20 3d3d 2065 7272   ex.errno == err
+00010140: 6e6f 2e45 4143 4345 533a 0a20 2020 2020  no.EACCES:.     
+00010150: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+00010160: 6169 7365 2050 6562 6b61 6328 3530 302c  aise Pebkac(500,
+00010170: 2022 7468 6520 7365 7276 6572 204f 5320   "the server OS 
+00010180: 6465 6e69 6564 2077 7269 7465 2d61 6363  denied write-acc
+00010190: 6573 7322 290a 0a20 2020 2020 2020 2020  ess")..         
+000101a0: 2020 2020 2020 2072 6169 7365 2050 6562         raise Peb
+000101b0: 6b61 6328 3530 302c 2022 6d6b 6469 7220  kac(500, "mkdir 
+000101c0: 6661 696c 6564 3a5c 6e22 202b 206d 696e  failed:\n" + min
+000101d0: 5f65 7828 2929 0a20 2020 2020 2020 2020  _ex()).         
+000101e0: 2020 2065 7863 6570 743a 0a20 2020 2020     except:.     
+000101f0: 2020 2020 2020 2020 2020 2072 6169 7365             raise
+00010200: 2050 6562 6b61 6328 3530 302c 206d 696e   Pebkac(500, min
+00010210: 5f65 7828 2929 0a0a 2020 2020 2020 2020  _ex())..        
+00010220: 7365 6c66 2e6f 7574 5f68 6561 6465 7273  self.out_headers
+00010230: 5b22 582d 4e65 772d 4469 7222 5d20 3d20  ["X-New-Dir"] = 
+00010240: 7175 6f74 6570 2876 7061 7468 2e73 706c  quotep(vpath.spl
+00010250: 6974 2822 2f22 295b 2d31 5d29 0a0a 2020  it("/")[-1])..  
+00010260: 2020 2020 2020 6966 2064 6176 3a0a 2020        if dav:.  
+00010270: 2020 2020 2020 2020 2020 7365 6c66 2e72            self.r
+00010280: 6570 6c79 2862 2222 2c20 3230 3129 0a20  eply(b"", 201). 
+00010290: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+000102a0: 2020 2020 2020 2020 2073 656c 662e 7265           self.re
+000102b0: 6469 7265 6374 2876 7061 7468 2c20 7374  direct(vpath, st
+000102c0: 6174 7573 3d32 3031 290a 0a20 2020 2020  atus=201)..     
+000102d0: 2020 2072 6574 7572 6e20 5472 7565 0a0a     return True..
+000102e0: 2020 2020 6465 6620 6861 6e64 6c65 5f6e      def handle_n
+000102f0: 6577 5f6d 6428 7365 6c66 2920 203a 0a20  ew_md(self)  :. 
+00010300: 2020 2020 2020 2061 7373 6572 7420 7365         assert se
+00010310: 6c66 2e70 6172 7365 720a 2020 2020 2020  lf.parser.      
+00010320: 2020 6e65 775f 6669 6c65 203d 2073 656c    new_file = sel
+00010330: 662e 7061 7273 6572 2e72 6571 7569 7265  f.parser.require
+00010340: 2822 6e61 6d65 222c 2035 3132 290a 2020  ("name", 512).  
+00010350: 2020 2020 2020 7365 6c66 2e70 6172 7365        self.parse
+00010360: 722e 6472 6f70 2829 0a0a 2020 2020 2020  r.drop()..      
+00010370: 2020 6e75 6c6c 7772 6974 6520 3d20 7365    nullwrite = se
+00010380: 6c66 2e61 7267 732e 6e77 0a20 2020 2020  lf.args.nw.     
+00010390: 2020 2076 6673 2c20 7265 6d20 3d20 7365     vfs, rem = se
+000103a0: 6c66 2e61 7372 762e 7666 732e 6765 7428  lf.asrv.vfs.get(
+000103b0: 7365 6c66 2e76 7061 7468 2c20 7365 6c66  self.vpath, self
+000103c0: 2e75 6e61 6d65 2c20 4661 6c73 652c 2054  .uname, False, T
+000103d0: 7275 6529 0a20 2020 2020 2020 2073 656c  rue).        sel
+000103e0: 662e 5f61 7373 6572 745f 7361 6665 5f72  f._assert_safe_r
+000103f0: 656d 2872 656d 290a 0a20 2020 2020 2020  em(rem)..       
+00010400: 2069 6620 6e6f 7420 6e65 775f 6669 6c65   if not new_file
+00010410: 2e65 6e64 7377 6974 6828 222e 6d64 2229  .endswith(".md")
+00010420: 3a0a 2020 2020 2020 2020 2020 2020 6e65  :.            ne
+00010430: 775f 6669 6c65 202b 3d20 222e 6d64 220a  w_file += ".md".
+00010440: 0a20 2020 2020 2020 2073 616e 6974 697a  .        sanitiz
+00010450: 6564 203d 2073 616e 6974 697a 655f 666e  ed = sanitize_fn
+00010460: 286e 6577 5f66 696c 652c 2022 222c 205b  (new_file, "", [
+00010470: 5d29 0a0a 2020 2020 2020 2020 6966 206e  ])..        if n
+00010480: 6f74 206e 756c 6c77 7269 7465 3a0a 2020  ot nullwrite:.  
+00010490: 2020 2020 2020 2020 2020 6664 6972 203d            fdir =
+000104a0: 2076 6673 2e63 616e 6f6e 6963 616c 2872   vfs.canonical(r
+000104b0: 656d 290a 2020 2020 2020 2020 2020 2020  em).            
+000104c0: 666e 203d 206f 732e 7061 7468 2e6a 6f69  fn = os.path.joi
+000104d0: 6e28 6664 6972 2c20 7361 6e69 7469 7a65  n(fdir, sanitize
+000104e0: 6429 0a0a 2020 2020 2020 2020 2020 2020  d)..            
+000104f0: 6966 2062 6f73 2e70 6174 682e 6578 6973  if bos.path.exis
+00010500: 7473 2866 6e29 3a0a 2020 2020 2020 2020  ts(fn):.        
+00010510: 2020 2020 2020 2020 7261 6973 6520 5065          raise Pe
+00010520: 626b 6163 2835 3030 2c20 2274 6861 7420  bkac(500, "that 
+00010530: 6669 6c65 2065 7869 7374 7320 616c 7265  file exists alre
+00010540: 6164 7922 290a 0a20 2020 2020 2020 2020  ady")..         
+00010550: 2020 2077 6974 6820 6f70 656e 2866 7365     with open(fse
+00010560: 6e63 2866 6e29 2c20 2277 6222 2920 6173  nc(fn), "wb") as
+00010570: 2066 3a0a 2020 2020 2020 2020 2020 2020   f:.            
+00010580: 2020 2020 662e 7772 6974 6528 6222 6047      f.write(b"`G
+00010590: 5255 4e4e 5552 605c 6e22 290a 0a20 2020  RUNNUR`\n")..   
+000105a0: 2020 2020 2076 7061 7468 203d 2022 7b7d       vpath = "{}
+000105b0: 2f7b 7d22 2e66 6f72 6d61 7428 7365 6c66  /{}".format(self
+000105c0: 2e76 7061 7468 2c20 7361 6e69 7469 7a65  .vpath, sanitize
+000105d0: 6429 2e6c 7374 7269 7028 222f 2229 0a20  d).lstrip("/"). 
+000105e0: 2020 2020 2020 2073 656c 662e 7265 6469         self.redi
+000105f0: 7265 6374 2876 7061 7468 2c20 223f 6564  rect(vpath, "?ed
+00010600: 6974 2229 0a20 2020 2020 2020 2072 6574  it").        ret
+00010610: 7572 6e20 5472 7565 0a0a 2020 2020 6465  urn True..    de
+00010620: 6620 7570 6c6f 6164 5f66 6c61 6773 2873  f upload_flags(s
+00010630: 656c 662c 2076 6673 2029 2020 2020 2020  elf, vfs )      
+00010640: 3a0a 2020 2020 2020 2020 6966 2073 656c  :.        if sel
+00010650: 662e 6172 6773 2e6e 773a 0a20 2020 2020  f.args.nw:.     
+00010660: 2020 2020 2020 2072 6e64 203d 2030 0a20         rnd = 0. 
+00010670: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+00010680: 2020 2020 2020 2020 2072 6e64 203d 2069           rnd = i
+00010690: 6e74 2873 656c 662e 7570 6172 616d 2e67  nt(self.uparam.g
+000106a0: 6574 2822 7261 6e64 2229 206f 7220 7365  et("rand") or se
+000106b0: 6c66 2e68 6561 6465 7273 2e67 6574 2822  lf.headers.get("
+000106c0: 7261 6e64 2229 206f 7220 3029 0a20 2020  rand") or 0).   
+000106d0: 2020 2020 2020 2020 2069 6620 7666 732e           if vfs.
+000106e0: 666c 6167 732e 6765 7428 2272 616e 6422  flags.get("rand"
+000106f0: 293a 2020 2320 666f 7263 652d 656e 6162  ):  # force-enab
+00010700: 6c65 0a20 2020 2020 2020 2020 2020 2020  le.             
+00010710: 2020 2072 6e64 203d 206d 6178 2872 6e64     rnd = max(rnd
+00010720: 2c20 7666 732e 666c 6167 735b 226e 7261  , vfs.flags["nra
+00010730: 6e64 225d 290a 0a20 2020 2020 2020 2061  nd"])..        a
+00010740: 6320 3d20 7365 6c66 2e75 7061 7261 6d2e  c = self.uparam.
+00010750: 6765 7428 0a20 2020 2020 2020 2020 2020  get(.           
+00010760: 2022 7761 6e74 222c 2073 656c 662e 6865   "want", self.he
+00010770: 6164 6572 732e 6765 7428 2261 6363 6570  aders.get("accep
+00010780: 7422 2c20 2222 292e 6c6f 7765 7228 292e  t", "").lower().
+00010790: 7370 6c69 7428 223b 2229 5b2d 315d 0a20  split(";")[-1]. 
+000107a0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+000107b0: 2077 616e 745f 7572 6c20 3d20 6163 203d   want_url = ac =
+000107c0: 3d20 2275 726c 220a 2020 2020 2020 2020  = "url".        
+000107d0: 7a73 203d 2073 656c 662e 7570 6172 616d  zs = self.uparam
+000107e0: 2e67 6574 2822 6c69 6665 222c 2073 656c  .get("life", sel
+000107f0: 662e 6865 6164 6572 732e 6765 7428 226c  f.headers.get("l
+00010800: 6966 6522 2c20 2222 2929 0a20 2020 2020  ife", "")).     
+00010810: 2020 2069 6620 7a73 3a0a 2020 2020 2020     if zs:.      
+00010820: 2020 2020 2020 766c 6966 6520 3d20 7666        vlife = vf
+00010830: 732e 666c 6167 732e 6765 7428 226c 6966  s.flags.get("lif
+00010840: 6574 696d 6522 2920 6f72 2030 0a20 2020  etime") or 0.   
+00010850: 2020 2020 2020 2020 206c 6966 6574 696d           lifetim
+00010860: 6520 3d20 6d61 7828 302c 2069 6e74 2876  e = max(0, int(v
+00010870: 6c69 6665 202d 2069 6e74 287a 7329 2929  life - int(zs)))
+00010880: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
+00010890: 2020 2020 2020 2020 2020 206c 6966 6574             lifet
+000108a0: 696d 6520 3d20 300a 0a20 2020 2020 2020  ime = 0..       
+000108b0: 2072 6574 7572 6e20 280a 2020 2020 2020   return (.      
+000108c0: 2020 2020 2020 726e 642c 0a20 2020 2020        rnd,.     
+000108d0: 2020 2020 2020 2077 616e 745f 7572 6c2c         want_url,
+000108e0: 0a20 2020 2020 2020 2020 2020 206c 6966  .            lif
+000108f0: 6574 696d 652c 0a20 2020 2020 2020 2020  etime,.         
+00010900: 2020 2076 6673 2e66 6c61 6773 2e67 6574     vfs.flags.get
+00010910: 2822 7862 7522 2920 6f72 205b 5d2c 0a20  ("xbu") or [],. 
+00010920: 2020 2020 2020 2020 2020 2076 6673 2e66             vfs.f
+00010930: 6c61 6773 2e67 6574 2822 7861 7522 2920  lags.get("xau") 
+00010940: 6f72 205b 5d2c 0a20 2020 2020 2020 2029  or [],.        )
+00010950: 0a0a 2020 2020 6465 6620 6861 6e64 6c65  ..    def handle
+00010960: 5f70 6c61 696e 5f75 706c 6f61 6428 7365  _plain_upload(se
+00010970: 6c66 2920 203a 0a20 2020 2020 2020 2061  lf)  :.        a
+00010980: 7373 6572 7420 7365 6c66 2e70 6172 7365  ssert self.parse
+00010990: 720a 2020 2020 2020 2020 6e75 6c6c 7772  r.        nullwr
+000109a0: 6974 6520 3d20 7365 6c66 2e61 7267 732e  ite = self.args.
+000109b0: 6e77 0a20 2020 2020 2020 2076 6673 2c20  nw.        vfs, 
+000109c0: 7265 6d20 3d20 7365 6c66 2e61 7372 762e  rem = self.asrv.
+000109d0: 7666 732e 6765 7428 7365 6c66 2e76 7061  vfs.get(self.vpa
+000109e0: 7468 2c20 7365 6c66 2e75 6e61 6d65 2c20  th, self.uname, 
+000109f0: 4661 6c73 652c 2054 7275 6529 0a20 2020  False, True).   
+00010a00: 2020 2020 2073 656c 662e 5f61 7373 6572       self._asser
+00010a10: 745f 7361 6665 5f72 656d 2872 656d 290a  t_safe_rem(rem).
+00010a20: 0a20 2020 2020 2020 2075 706c 6f61 645f  .        upload_
+00010a30: 7670 6174 6820 3d20 7365 6c66 2e76 7061  vpath = self.vpa
+00010a40: 7468 0a20 2020 2020 2020 206c 696d 203d  th.        lim =
+00010a50: 2076 6673 2e67 6574 5f64 6276 2872 656d   vfs.get_dbv(rem
+00010a60: 295b 305d 2e6c 696d 0a20 2020 2020 2020  )[0].lim.       
+00010a70: 2066 6469 725f 6261 7365 203d 2076 6673   fdir_base = vfs
+00010a80: 2e63 616e 6f6e 6963 616c 2872 656d 290a  .canonical(rem).
+00010a90: 2020 2020 2020 2020 6966 206c 696d 3a0a          if lim:.
+00010aa0: 2020 2020 2020 2020 2020 2020 6664 6972              fdir
+00010ab0: 5f62 6173 652c 2072 656d 203d 206c 696d  _base, rem = lim
+00010ac0: 2e61 6c6c 2873 656c 662e 6970 2c20 7265  .all(self.ip, re
+00010ad0: 6d2c 202d 312c 2066 6469 725f 6261 7365  m, -1, fdir_base
+00010ae0: 290a 2020 2020 2020 2020 2020 2020 7570  ).            up
+00010af0: 6c6f 6164 5f76 7061 7468 203d 2022 7b7d  load_vpath = "{}
+00010b00: 2f7b 7d22 2e66 6f72 6d61 7428 7666 732e  /{}".format(vfs.
+00010b10: 7670 6174 682c 2072 656d 292e 7374 7269  vpath, rem).stri
+00010b20: 7028 222f 2229 0a20 2020 2020 2020 2020  p("/").         
+00010b30: 2020 2069 6620 6e6f 7420 6e75 6c6c 7772     if not nullwr
+00010b40: 6974 653a 0a20 2020 2020 2020 2020 2020  ite:.           
+00010b50: 2020 2020 2062 6f73 2e6d 616b 6564 6972       bos.makedir
+00010b60: 7328 6664 6972 5f62 6173 6529 0a0a 2020  s(fdir_base)..  
+00010b70: 2020 2020 2020 726e 642c 2077 616e 745f        rnd, want_
+00010b80: 7572 6c2c 206c 6966 6574 696d 652c 2078  url, lifetime, x
+00010b90: 6275 2c20 7861 7520 3d20 7365 6c66 2e75  bu, xau = self.u
+00010ba0: 706c 6f61 645f 666c 6167 7328 7666 7329  pload_flags(vfs)
+00010bb0: 0a0a 2020 2020 2020 2020 6669 6c65 7320  ..        files 
+00010bc0: 2020 2020 2020 3d20 5b5d 0a20 2020 2020        = [].     
+00010bd0: 2020 2023 2073 7a2c 2073 6861 5f68 6578     # sz, sha_hex
+00010be0: 2c20 7368 615f 6236 342c 2070 5f66 696c  , sha_b64, p_fil
+00010bf0: 652c 2066 6e61 6d65 2c20 6162 7370 6174  e, fname, abspat
+00010c00: 680a 2020 2020 2020 2020 6572 726d 7367  h.        errmsg
+00010c10: 203d 2022 220a 2020 2020 2020 2020 6469   = "".        di
+00010c20: 7020 3d20 7365 6c66 2e64 6970 2829 0a20  p = self.dip(). 
+00010c30: 2020 2020 2020 2074 3020 3d20 7469 6d65         t0 = time
+00010c40: 2e74 696d 6528 290a 2020 2020 2020 2020  .time().        
+00010c50: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
+00010c60: 2061 7373 6572 7420 7365 6c66 2e70 6172   assert self.par
+00010c70: 7365 722e 6765 6e0a 2020 2020 2020 2020  ser.gen.        
+00010c80: 2020 2020 666f 7220 6e66 696c 652c 2028      for nfile, (
+00010c90: 705f 6669 656c 642c 2070 5f66 696c 652c  p_field, p_file,
+00010ca0: 2070 5f64 6174 6129 2069 6e20 656e 756d   p_data) in enum
+00010cb0: 6572 6174 6528 7365 6c66 2e70 6172 7365  erate(self.parse
+00010cc0: 722e 6765 6e29 3a0a 2020 2020 2020 2020  r.gen):.        
+00010cd0: 2020 2020 2020 2020 6966 206e 6f74 2070          if not p
+00010ce0: 5f66 696c 653a 0a20 2020 2020 2020 2020  _file:.         
+00010cf0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+00010d00: 6c6f 6728 2264 6973 6361 7264 696e 6720  log("discarding 
+00010d10: 696e 636f 6d69 6e67 2066 696c 6520 7769  incoming file wi
+00010d20: 7468 6f75 7420 6669 6c65 6e61 6d65 2229  thout filename")
+00010d30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00010d40: 2020 2020 2023 2066 616c 6c74 6872 6f75       # fallthrou
+00010d50: 6768 0a0a 2020 2020 2020 2020 2020 2020  gh..            
+00010d60: 2020 2020 6664 6972 203d 2066 6469 725f      fdir = fdir_
+00010d70: 6261 7365 0a20 2020 2020 2020 2020 2020  base.           
+00010d80: 2020 2020 2066 6e61 6d65 203d 2073 616e       fname = san
+00010d90: 6974 697a 655f 666e 280a 2020 2020 2020  itize_fn(.      
+00010da0: 2020 2020 2020 2020 2020 2020 2020 705f                p_
+00010db0: 6669 6c65 206f 7220 2222 2c20 2222 2c20  file or "", "", 
+00010dc0: 5b22 2e70 726f 6c6f 6775 652e 6874 6d6c  [".prologue.html
+00010dd0: 222c 2022 2e65 7069 6c6f 6775 652e 6874  ", ".epilogue.ht
+00010de0: 6d6c 225d 0a20 2020 2020 2020 2020 2020  ml"].           
+00010df0: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
+00010e00: 2020 2020 2020 2069 6620 705f 6669 6c65         if p_file
+00010e10: 2061 6e64 206e 6f74 206e 756c 6c77 7269   and not nullwri
+00010e20: 7465 3a0a 2020 2020 2020 2020 2020 2020  te:.            
+00010e30: 2020 2020 2020 2020 6966 2072 6e64 3a0a          if rnd:.
+00010e40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010e50: 2020 2020 2020 2020 666e 616d 6520 3d20          fname = 
+00010e60: 7261 6e64 5f6e 616d 6528 6664 6972 2c20  rand_name(fdir, 
+00010e70: 666e 616d 652c 2072 6e64 290a 0a20 2020  fname, rnd)..   
+00010e80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010e90: 2069 6620 6e6f 7420 626f 732e 7061 7468   if not bos.path
+00010ea0: 2e69 7364 6972 2866 6469 7229 3a0a 2020  .isdir(fdir):.  
+00010eb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010ec0: 2020 2020 2020 7261 6973 6520 5065 626b        raise Pebk
+00010ed0: 6163 2834 3034 2c20 2274 6861 7420 666f  ac(404, "that fo
+00010ee0: 6c64 6572 2064 6f65 7320 6e6f 7420 6578  lder does not ex
+00010ef0: 6973 7422 290a 0a20 2020 2020 2020 2020  ist")..         
+00010f00: 2020 2020 2020 2020 2020 2073 7566 6669             suffi
+00010f10: 7820 3d20 222d 7b3a 2e36 667d 2d7b 7d22  x = "-{:.6f}-{}"
+00010f20: 2e66 6f72 6d61 7428 7469 6d65 2e74 696d  .format(time.tim
+00010f30: 6528 292c 2064 6970 290a 2020 2020 2020  e(), dip).      
+00010f40: 2020 2020 2020 2020 2020 2020 2020 6f70                op
+00010f50: 656e 5f61 7267 7320 3d20 7b22 6664 6972  en_args = {"fdir
+00010f60: 223a 2066 6469 722c 2022 7375 6666 6978  ": fdir, "suffix
+00010f70: 223a 2073 7566 6669 787d 0a0a 2020 2020  ": suffix}..    
+00010f80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010f90: 2320 7265 7365 7276 6520 6465 7374 696e  # reserve destin
+00010fa0: 6174 696f 6e20 6669 6c65 6e61 6d65 0a20  ation filename. 
+00010fb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010fc0: 2020 2077 6974 6820 7265 6e5f 6f70 656e     with ren_open
+00010fd0: 2866 6e61 6d65 2c20 2277 6222 2c20 6664  (fname, "wb", fd
+00010fe0: 6972 3d66 6469 722c 2073 7566 6669 783d  ir=fdir, suffix=
+00010ff0: 7375 6666 6978 2920 6173 207a 6677 3a0a  suffix) as zfw:.
+00011000: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011010: 2020 2020 2020 2020 666e 616d 6520 3d20          fname = 
+00011020: 7a66 775b 226f 727a 225d 5b31 5d0a 0a20  zfw["orz"][1].. 
 00011030: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011040: 2020 746e 616d 203d 2066 6e61 6d65 203d    tnam = fname =
-00011050: 206f 732e 6465 766e 756c 6c0a 2020 2020   os.devnull.    
+00011040: 2020 2074 6e61 6d20 3d20 666e 616d 6520     tnam = fname 
+00011050: 2b20 222e 5041 5254 4941 4c22 0a20 2020  + ".PARTIAL".   
 00011060: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011070: 6664 6972 203d 2061 6273 7061 7468 203d  fdir = abspath =
-00011080: 2022 220a 0a20 2020 2020 2020 2020 2020   ""..           
-00011090: 2020 2020 2069 6620 7862 753a 0a20 2020       if xbu:.   
-000110a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000110b0: 2061 7420 3d20 7469 6d65 2e74 696d 6528   at = time.time(
-000110c0: 2920 2d20 6c69 6665 7469 6d65 0a20 2020  ) - lifetime.   
-000110d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000110e0: 2069 6620 6e6f 7420 7275 6e68 6f6f 6b28   if not runhook(
-000110f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00011100: 2020 2020 2020 2020 2073 656c 662e 6c6f           self.lo
-00011110: 672c 0a20 2020 2020 2020 2020 2020 2020  g,.             
-00011120: 2020 2020 2020 2020 2020 2078 6275 2c0a             xbu,.
-00011130: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011140: 2020 2020 2020 2020 6162 7370 6174 682c          abspath,
+00011070: 2069 6620 7365 6c66 2e61 7267 732e 646f   if self.args.do
+00011080: 7470 6172 743a 0a20 2020 2020 2020 2020  tpart:.         
+00011090: 2020 2020 2020 2020 2020 2020 2020 2074                 t
+000110a0: 6e61 6d20 3d20 222e 2220 2b20 746e 616d  nam = "." + tnam
+000110b0: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+000110c0: 2020 2020 2020 6162 7370 6174 6820 3d20        abspath = 
+000110d0: 6f73 2e70 6174 682e 6a6f 696e 2866 6469  os.path.join(fdi
+000110e0: 722c 2066 6e61 6d65 290a 2020 2020 2020  r, fname).      
+000110f0: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
+00011100: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011110: 2020 2020 6f70 656e 5f61 7267 7320 3d20      open_args = 
+00011120: 7b7d 0a20 2020 2020 2020 2020 2020 2020  {}.             
+00011130: 2020 2020 2020 2074 6e61 6d20 3d20 666e         tnam = fn
+00011140: 616d 6520 3d20 6f73 2e64 6576 6e75 6c6c  ame = os.devnull
 00011150: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00011160: 2020 2020 2020 2020 2073 656c 662e 7670           self.vp
-00011170: 6174 682c 0a20 2020 2020 2020 2020 2020  ath,.           
-00011180: 2020 2020 2020 2020 2020 2020 2073 656c               sel
-00011190: 662e 686f 7374 2c0a 2020 2020 2020 2020  f.host,.        
-000111a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000111b0: 7365 6c66 2e75 6e61 6d65 2c0a 2020 2020  self.uname,.    
-000111c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000111d0: 2020 2020 6174 2c0a 2020 2020 2020 2020      at,.        
-000111e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000111f0: 302c 0a20 2020 2020 2020 2020 2020 2020  0,.             
-00011200: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-00011210: 6970 2c0a 2020 2020 2020 2020 2020 2020  ip,.            
-00011220: 2020 2020 2020 2020 2020 2020 6174 2c0a              at,.
-00011230: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011240: 2020 2020 2020 2020 2222 2c0a 2020 2020          "",.    
-00011250: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011260: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-00011270: 2020 2020 2020 2020 2020 2074 203d 2022             t = "
-00011280: 7570 6c6f 6164 2062 6c6f 636b 6564 2062  upload blocked b
-00011290: 7920 7862 7520 7365 7276 6572 2063 6f6e  y xbu server con
-000112a0: 6669 6722 0a20 2020 2020 2020 2020 2020  fig".           
-000112b0: 2020 2020 2020 2020 2020 2020 2073 656c               sel
-000112c0: 662e 6c6f 6728 742c 2031 290a 2020 2020  f.log(t, 1).    
+00011160: 2020 2020 2066 6469 7220 3d20 6162 7370       fdir = absp
+00011170: 6174 6820 3d20 2222 0a0a 2020 2020 2020  ath = ""..      
+00011180: 2020 2020 2020 2020 2020 6966 2078 6275            if xbu
+00011190: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+000111a0: 2020 2020 2020 6174 203d 2074 696d 652e        at = time.
+000111b0: 7469 6d65 2829 202d 206c 6966 6574 696d  time() - lifetim
+000111c0: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
+000111d0: 2020 2020 2020 6966 206e 6f74 2072 756e        if not run
+000111e0: 686f 6f6b 280a 2020 2020 2020 2020 2020  hook(.          
+000111f0: 2020 2020 2020 2020 2020 2020 2020 7365                se
+00011200: 6c66 2e6c 6f67 2c0a 2020 2020 2020 2020  lf.log,.        
+00011210: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011220: 7862 752c 0a20 2020 2020 2020 2020 2020  xbu,.           
+00011230: 2020 2020 2020 2020 2020 2020 2061 6273               abs
+00011240: 7061 7468 2c0a 2020 2020 2020 2020 2020  path,.          
+00011250: 2020 2020 2020 2020 2020 2020 2020 7365                se
+00011260: 6c66 2e76 7061 7468 2c0a 2020 2020 2020  lf.vpath,.      
+00011270: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011280: 2020 7365 6c66 2e68 6f73 742c 0a20 2020    self.host,.   
+00011290: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000112a0: 2020 2020 2073 656c 662e 756e 616d 652c       self.uname,
+000112b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000112c0: 2020 2020 2020 2020 2061 742c 0a20 2020           at,.   
 000112d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000112e0: 2020 2020 7261 6973 6520 5065 626b 6163      raise Pebkac
-000112f0: 2834 3033 2c20 7429 0a0a 2020 2020 2020  (403, t)..      
-00011300: 2020 2020 2020 2020 2020 6966 206c 696d            if lim
-00011310: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00011320: 2020 2020 2020 6c69 6d2e 6368 6b5f 6275        lim.chk_bu
-00011330: 7028 7365 6c66 2e69 7029 0a20 2020 2020  p(self.ip).     
-00011340: 2020 2020 2020 2020 2020 2020 2020 206c                 l
-00011350: 696d 2e63 686b 5f6e 7570 2873 656c 662e  im.chk_nup(self.
-00011360: 6970 290a 0a20 2020 2020 2020 2020 2020  ip)..           
-00011370: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
-00011380: 2020 2020 2020 2020 2020 2020 2020 6d61                ma
-00011390: 785f 737a 203d 2030 0a20 2020 2020 2020  x_sz = 0.       
-000113a0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-000113b0: 6c69 6d3a 0a20 2020 2020 2020 2020 2020  lim:.           
-000113c0: 2020 2020 2020 2020 2020 2020 2076 3120               v1 
-000113d0: 3d20 6c69 6d2e 736d 6178 0a20 2020 2020  = lim.smax.     
-000113e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000113f0: 2020 2076 3220 3d20 6c69 6d2e 6466 7620     v2 = lim.dfv 
-00011400: 2d20 6c69 6d2e 6466 6c0a 2020 2020 2020  - lim.dfl.      
-00011410: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011420: 2020 6d61 785f 737a 203d 206d 696e 2876    max_sz = min(v
-00011430: 312c 2076 3229 2069 6620 7631 2061 6e64  1, v2) if v1 and
-00011440: 2076 3220 656c 7365 2076 3120 6f72 2076   v2 else v1 or v
-00011450: 320a 0a20 2020 2020 2020 2020 2020 2020  2..             
-00011460: 2020 2020 2020 2077 6974 6820 7265 6e5f         with ren_
-00011470: 6f70 656e 2874 6e61 6d2c 2022 7762 222c  open(tnam, "wb",
-00011480: 2035 3132 202a 2031 3032 342c 202a 2a6f   512 * 1024, **o
-00011490: 7065 6e5f 6172 6773 2920 6173 207a 6677  pen_args) as zfw
-000114a0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-000114b0: 2020 2020 2020 2020 2020 662c 2074 6e61            f, tna
-000114c0: 6d20 3d20 7a66 775b 226f 727a 225d 0a20  m = zfw["orz"]. 
+000112e0: 2020 2020 2030 2c0a 2020 2020 2020 2020       0,.        
+000112f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011300: 7365 6c66 2e69 702c 0a20 2020 2020 2020  self.ip,.       
+00011310: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011320: 2061 742c 0a20 2020 2020 2020 2020 2020   at,.           
+00011330: 2020 2020 2020 2020 2020 2020 2022 222c               "",
+00011340: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00011350: 2020 2020 2029 3a0a 2020 2020 2020 2020       ):.        
+00011360: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011370: 7420 3d20 2275 706c 6f61 6420 626c 6f63  t = "upload bloc
+00011380: 6b65 6420 6279 2078 6275 2073 6572 7665  ked by xbu serve
+00011390: 7220 636f 6e66 6967 220a 2020 2020 2020  r config".      
+000113a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000113b0: 2020 7365 6c66 2e6c 6f67 2874 2c20 3129    self.log(t, 1)
+000113c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000113d0: 2020 2020 2020 2020 2072 6169 7365 2050           raise P
+000113e0: 6562 6b61 6328 3430 332c 2074 290a 0a20  ebkac(403, t).. 
+000113f0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00011400: 6620 6c69 6d3a 0a20 2020 2020 2020 2020  f lim:.         
+00011410: 2020 2020 2020 2020 2020 206c 696d 2e63             lim.c
+00011420: 686b 5f62 7570 2873 656c 662e 6970 290a  hk_bup(self.ip).
+00011430: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011440: 2020 2020 6c69 6d2e 6368 6b5f 6e75 7028      lim.chk_nup(
+00011450: 7365 6c66 2e69 7029 0a0a 2020 2020 2020  self.ip)..      
+00011460: 2020 2020 2020 2020 2020 7472 793a 0a20            try:. 
+00011470: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011480: 2020 206d 6178 5f73 7a20 3d20 300a 2020     max_sz = 0.  
+00011490: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000114a0: 2020 6966 206c 696d 3a0a 2020 2020 2020    if lim:.      
+000114b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000114c0: 2020 7631 203d 206c 696d 2e73 6d61 780a    v1 = lim.smax.
 000114d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000114e0: 2020 2020 2020 2074 6162 7370 6174 6820         tabspath 
-000114f0: 3d20 6f73 2e70 6174 682e 6a6f 696e 2866  = os.path.join(f
-00011500: 6469 722c 2074 6e61 6d29 0a20 2020 2020  dir, tnam).     
-00011510: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011520: 2020 2073 656c 662e 6c6f 6728 2277 7269     self.log("wri
-00011530: 7469 6e67 2074 6f20 7b7d 222e 666f 726d  ting to {}".form
-00011540: 6174 2874 6162 7370 6174 6829 290a 2020  at(tabspath)).  
-00011550: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011560: 2020 2020 2020 737a 2c20 7368 615f 6865        sz, sha_he
-00011570: 782c 2073 6861 5f62 3634 203d 2068 6173  x, sha_b64 = has
-00011580: 6863 6f70 7928 0a20 2020 2020 2020 2020  hcopy(.         
-00011590: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000115a0: 2020 2070 5f64 6174 612c 2066 2c20 7365     p_data, f, se
-000115b0: 6c66 2e61 7267 732e 735f 7772 5f73 6c70  lf.args.s_wr_slp
-000115c0: 2c20 6d61 785f 737a 0a20 2020 2020 2020  , max_sz.       
-000115d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000115e0: 2029 0a20 2020 2020 2020 2020 2020 2020   ).             
-000115f0: 2020 2020 2020 2020 2020 2069 6620 737a             if sz
-00011600: 203d 3d20 303a 0a20 2020 2020 2020 2020   == 0:.         
-00011610: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011620: 2020 2072 6169 7365 2050 6562 6b61 6328     raise Pebkac(
-00011630: 3430 302c 2022 656d 7074 7920 6669 6c65  400, "empty file
-00011640: 7320 696e 2070 6f73 7422 290a 0a20 2020  s in post")..   
-00011650: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011660: 2069 6620 6c69 6d3a 0a20 2020 2020 2020   if lim:.       
-00011670: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011680: 206c 696d 2e6e 7570 2873 656c 662e 6970   lim.nup(self.ip
-00011690: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-000116a0: 2020 2020 2020 2020 2020 6c69 6d2e 6275            lim.bu
-000116b0: 7028 7365 6c66 2e69 702c 2073 7a29 0a20  p(self.ip, sz). 
+000114e0: 2020 2020 2020 2020 7632 203d 206c 696d          v2 = lim
+000114f0: 2e64 6676 202d 206c 696d 2e64 666c 0a20  .dfv - lim.dfl. 
+00011500: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011510: 2020 2020 2020 206d 6178 5f73 7a20 3d20         max_sz = 
+00011520: 6d69 6e28 7631 2c20 7632 2920 6966 2076  min(v1, v2) if v
+00011530: 3120 616e 6420 7632 2065 6c73 6520 7631  1 and v2 else v1
+00011540: 206f 7220 7632 0a0a 2020 2020 2020 2020   or v2..        
+00011550: 2020 2020 2020 2020 2020 2020 7769 7468              with
+00011560: 2072 656e 5f6f 7065 6e28 746e 616d 2c20   ren_open(tnam, 
+00011570: 2277 6222 2c20 3531 3220 2a20 3130 3234  "wb", 512 * 1024
+00011580: 2c20 2a2a 6f70 656e 5f61 7267 7329 2061  , **open_args) a
+00011590: 7320 7a66 773a 0a20 2020 2020 2020 2020  s zfw:.         
+000115a0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+000115b0: 2c20 746e 616d 203d 207a 6677 5b22 6f72  , tnam = zfw["or
+000115c0: 7a22 5d0a 2020 2020 2020 2020 2020 2020  z"].            
+000115d0: 2020 2020 2020 2020 2020 2020 7461 6273              tabs
+000115e0: 7061 7468 203d 206f 732e 7061 7468 2e6a  path = os.path.j
+000115f0: 6f69 6e28 6664 6972 2c20 746e 616d 290a  oin(fdir, tnam).
+00011600: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011610: 2020 2020 2020 2020 7365 6c66 2e6c 6f67          self.log
+00011620: 2822 7772 6974 696e 6720 746f 207b 7d22  ("writing to {}"
+00011630: 2e66 6f72 6d61 7428 7461 6273 7061 7468  .format(tabspath
+00011640: 2929 0a20 2020 2020 2020 2020 2020 2020  )).             
+00011650: 2020 2020 2020 2020 2020 2073 7a2c 2073             sz, s
+00011660: 6861 5f68 6578 2c20 7368 615f 6236 3420  ha_hex, sha_b64 
+00011670: 3d20 6861 7368 636f 7079 280a 2020 2020  = hashcopy(.    
+00011680: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011690: 2020 2020 2020 2020 705f 6461 7461 2c20          p_data, 
+000116a0: 662c 2073 656c 662e 6172 6773 2e73 5f77  f, self.args.s_w
+000116b0: 725f 736c 702c 206d 6178 5f73 7a0a 2020  r_slp, max_sz.  
 000116c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000116d0: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
+000116d0: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
 000116e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000116f0: 2020 2020 2020 2020 6c69 6d2e 6368 6b5f          lim.chk_
-00011700: 6466 2874 6162 7370 6174 682c 2073 7a2c  df(tabspath, sz,
-00011710: 2054 7275 6529 0a20 2020 2020 2020 2020   True).         
-00011720: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011730: 2020 206c 696d 2e63 686b 5f73 7a28 737a     lim.chk_sz(sz
-00011740: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00011750: 2020 2020 2020 2020 2020 2020 2020 6c69                li
-00011760: 6d2e 6368 6b5f 6275 7028 7365 6c66 2e69  m.chk_bup(self.i
-00011770: 7029 0a20 2020 2020 2020 2020 2020 2020  p).             
-00011780: 2020 2020 2020 2020 2020 2020 2020 206c                 l
-00011790: 696d 2e63 686b 5f6e 7570 2873 656c 662e  im.chk_nup(self.
-000117a0: 6970 290a 2020 2020 2020 2020 2020 2020  ip).            
-000117b0: 2020 2020 2020 2020 2020 2020 6578 6365              exce
-000117c0: 7074 3a0a 2020 2020 2020 2020 2020 2020  pt:.            
-000117d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000117e0: 6966 206e 6f74 206e 756c 6c77 7269 7465  if not nullwrite
-000117f0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00011800: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011810: 2020 626f 732e 756e 6c69 6e6b 2874 6162    bos.unlink(tab
-00011820: 7370 6174 6829 0a20 2020 2020 2020 2020  spath).         
-00011830: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011840: 2020 2020 2020 2062 6f73 2e75 6e6c 696e         bos.unlin
-00011850: 6b28 6162 7370 6174 6829 0a20 2020 2020  k(abspath).     
-00011860: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011870: 2020 2020 2020 2066 6e61 6d65 203d 206f         fname = o
-00011880: 732e 6465 766e 756c 6c0a 2020 2020 2020  s.devnull.      
-00011890: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000118a0: 2020 2020 2020 7261 6973 650a 0a20 2020        raise..   
-000118b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000118c0: 2069 6620 6e6f 7420 6e75 6c6c 7772 6974   if not nullwrit
-000118d0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-000118e0: 2020 2020 2020 2020 2020 2061 746f 6d69             atomi
-000118f0: 635f 6d6f 7665 2874 6162 7370 6174 682c  c_move(tabspath,
-00011900: 2061 6273 7061 7468 290a 0a20 2020 2020   abspath)..     
-00011910: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00011920: 696c 6573 2e61 7070 656e 6428 0a20 2020  iles.append(.   
-00011930: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011940: 2020 2020 2028 737a 2c20 7368 615f 6865       (sz, sha_he
-00011950: 782c 2073 6861 5f62 3634 2c20 705f 6669  x, sha_b64, p_fi
-00011960: 6c65 206f 7220 2228 6469 7363 6172 6465  le or "(discarde
-00011970: 6429 222c 2066 6e61 6d65 2c20 6162 7370  d)", fname, absp
-00011980: 6174 6829 0a20 2020 2020 2020 2020 2020  ath).           
-00011990: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
-000119a0: 2020 2020 2020 2020 2020 2020 2020 2061                 a
-000119b0: 7420 3d20 7469 6d65 2e74 696d 6528 2920  t = time.time() 
-000119c0: 2d20 6c69 6665 7469 6d65 0a20 2020 2020  - lifetime.     
-000119d0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-000119e0: 6620 7861 7520 616e 6420 6e6f 7420 7275  f xau and not ru
-000119f0: 6e68 6f6f 6b28 0a20 2020 2020 2020 2020  nhook(.         
-00011a00: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-00011a10: 656c 662e 6c6f 672c 0a20 2020 2020 2020  elf.log,.       
-00011a20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011a30: 2078 6175 2c0a 2020 2020 2020 2020 2020   xau,.          
-00011a40: 2020 2020 2020 2020 2020 2020 2020 6162                ab
-00011a50: 7370 6174 682c 0a20 2020 2020 2020 2020  spath,.         
-00011a60: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-00011a70: 656c 662e 7670 6174 682c 0a20 2020 2020  elf.vpath,.     
-00011a80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011a90: 2020 2073 656c 662e 686f 7374 2c0a 2020     self.host,.  
-00011aa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011ab0: 2020 2020 2020 7365 6c66 2e75 6e61 6d65        self.uname
-00011ac0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00011ad0: 2020 2020 2020 2020 2020 6174 2c0a 2020            at,.  
-00011ae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011af0: 2020 2020 2020 737a 2c0a 2020 2020 2020        sz,.      
-00011b00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011b10: 2020 7365 6c66 2e69 702c 0a20 2020 2020    self.ip,.     
-00011b20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011b30: 2020 2061 742c 0a20 2020 2020 2020 2020     at,.         
-00011b40: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-00011b50: 222c 0a20 2020 2020 2020 2020 2020 2020  ",.             
-00011b60: 2020 2020 2020 2029 3a0a 2020 2020 2020         ):.      
+000116f0: 6966 2073 7a20 3d3d 2030 3a0a 2020 2020  if sz == 0:.    
+00011700: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011710: 2020 2020 2020 2020 7261 6973 6520 5065          raise Pe
+00011720: 626b 6163 2834 3030 2c20 2265 6d70 7479  bkac(400, "empty
+00011730: 2066 696c 6573 2069 6e20 706f 7374 2229   files in post")
+00011740: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00011750: 2020 2020 2020 6966 206c 696d 3a0a 2020        if lim:.  
+00011760: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011770: 2020 2020 2020 6c69 6d2e 6e75 7028 7365        lim.nup(se
+00011780: 6c66 2e69 7029 0a20 2020 2020 2020 2020  lf.ip).         
+00011790: 2020 2020 2020 2020 2020 2020 2020 206c                 l
+000117a0: 696d 2e62 7570 2873 656c 662e 6970 2c20  im.bup(self.ip, 
+000117b0: 737a 290a 2020 2020 2020 2020 2020 2020  sz).            
+000117c0: 2020 2020 2020 2020 2020 2020 7472 793a              try:
+000117d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000117e0: 2020 2020 2020 2020 2020 2020 206c 696d               lim
+000117f0: 2e63 686b 5f64 6628 7461 6273 7061 7468  .chk_df(tabspath
+00011800: 2c20 737a 2c20 5472 7565 290a 2020 2020  , sz, True).    
+00011810: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011820: 2020 2020 2020 2020 6c69 6d2e 6368 6b5f          lim.chk_
+00011830: 737a 2873 7a29 0a20 2020 2020 2020 2020  sz(sz).         
+00011840: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011850: 2020 206c 696d 2e63 686b 5f62 7570 2873     lim.chk_bup(s
+00011860: 656c 662e 6970 290a 2020 2020 2020 2020  elf.ip).        
+00011870: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011880: 2020 2020 6c69 6d2e 6368 6b5f 6e75 7028      lim.chk_nup(
+00011890: 7365 6c66 2e69 7029 0a20 2020 2020 2020  self.ip).       
+000118a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000118b0: 2065 7863 6570 743a 0a20 2020 2020 2020   except:.       
+000118c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000118d0: 2020 2020 2069 6620 6e6f 7420 6e75 6c6c       if not null
+000118e0: 7772 6974 653a 0a20 2020 2020 2020 2020  write:.         
+000118f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011900: 2020 2020 2020 2062 6f73 2e75 6e6c 696e         bos.unlin
+00011910: 6b28 7461 6273 7061 7468 290a 2020 2020  k(tabspath).    
+00011920: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011930: 2020 2020 2020 2020 2020 2020 626f 732e              bos.
+00011940: 756e 6c69 6e6b 2861 6273 7061 7468 290a  unlink(abspath).
+00011950: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011960: 2020 2020 2020 2020 2020 2020 666e 616d              fnam
+00011970: 6520 3d20 6f73 2e64 6576 6e75 6c6c 0a20  e = os.devnull. 
+00011980: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011990: 2020 2020 2020 2020 2020 2072 6169 7365             raise
+000119a0: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+000119b0: 2020 2020 2020 6966 206e 6f74 206e 756c        if not nul
+000119c0: 6c77 7269 7465 3a0a 2020 2020 2020 2020  lwrite:.        
+000119d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000119e0: 6174 6f6d 6963 5f6d 6f76 6528 7461 6273  atomic_move(tabs
+000119f0: 7061 7468 2c20 6162 7370 6174 6829 0a0a  path, abspath)..
+00011a00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011a10: 2020 2020 6669 6c65 732e 6170 7065 6e64      files.append
+00011a20: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00011a30: 2020 2020 2020 2020 2020 2873 7a2c 2073            (sz, s
+00011a40: 6861 5f68 6578 2c20 7368 615f 6236 342c  ha_hex, sha_b64,
+00011a50: 2070 5f66 696c 6520 6f72 2022 2864 6973   p_file or "(dis
+00011a60: 6361 7264 6564 2922 2c20 666e 616d 652c  carded)", fname,
+00011a70: 2061 6273 7061 7468 290a 2020 2020 2020   abspath).      
+00011a80: 2020 2020 2020 2020 2020 2020 2020 290a                ).
+00011a90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011aa0: 2020 2020 6174 203d 2074 696d 652e 7469      at = time.ti
+00011ab0: 6d65 2829 202d 206c 6966 6574 696d 650a  me() - lifetime.
+00011ac0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011ad0: 2020 2020 6966 2078 6175 2061 6e64 206e      if xau and n
+00011ae0: 6f74 2072 756e 686f 6f6b 280a 2020 2020  ot runhook(.    
+00011af0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011b00: 2020 2020 7365 6c66 2e6c 6f67 2c0a 2020      self.log,.  
+00011b10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011b20: 2020 2020 2020 7861 752c 0a20 2020 2020        xau,.     
+00011b30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011b40: 2020 2061 6273 7061 7468 2c0a 2020 2020     abspath,.    
+00011b50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011b60: 2020 2020 7365 6c66 2e76 7061 7468 2c0a      self.vpath,.
 00011b70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011b80: 2020 7420 3d20 2275 706c 6f61 6420 626c    t = "upload bl
-00011b90: 6f63 6b65 6420 6279 2078 6175 2073 6572  ocked by xau ser
-00011ba0: 7665 7220 636f 6e66 6967 220a 2020 2020  ver config".    
-00011bb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011bc0: 2020 2020 7365 6c66 2e6c 6f67 2874 2c20      self.log(t, 
-00011bd0: 3129 0a20 2020 2020 2020 2020 2020 2020  1).             
-00011be0: 2020 2020 2020 2020 2020 206f 732e 756e             os.un
-00011bf0: 6c69 6e6b 2861 6273 7061 7468 290a 2020  link(abspath).  
-00011c00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011c10: 2020 2020 2020 7261 6973 6520 5065 626b        raise Pebk
-00011c20: 6163 2834 3033 2c20 7429 0a0a 2020 2020  ac(403, t)..    
+00011b80: 2020 2020 2020 2020 7365 6c66 2e68 6f73          self.hos
+00011b90: 742c 0a20 2020 2020 2020 2020 2020 2020  t,.             
+00011ba0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+00011bb0: 756e 616d 652c 0a20 2020 2020 2020 2020  uname,.         
+00011bc0: 2020 2020 2020 2020 2020 2020 2020 2061                 a
+00011bd0: 742c 0a20 2020 2020 2020 2020 2020 2020  t,.             
+00011be0: 2020 2020 2020 2020 2020 2073 7a2c 0a20             sz,. 
+00011bf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011c00: 2020 2020 2020 2073 656c 662e 6970 2c0a         self.ip,.
+00011c10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011c20: 2020 2020 2020 2020 6174 2c0a 2020 2020          at,.    
 00011c30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011c40: 6462 762c 2076 7265 6d20 3d20 7666 732e  dbv, vrem = vfs.
-00011c50: 6765 745f 6462 7628 7265 6d29 0a20 2020  get_dbv(rem).   
+00011c40: 2020 2020 2222 2c0a 2020 2020 2020 2020      "",.        
+00011c50: 2020 2020 2020 2020 2020 2020 293a 0a20              ):. 
 00011c60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011c70: 2073 656c 662e 636f 6e6e 2e68 7372 762e   self.conn.hsrv.
-00011c80: 6272 6f6b 6572 2e73 6179 280a 2020 2020  broker.say(.    
-00011c90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011ca0: 2020 2020 2275 7032 6b2e 6861 7368 5f66      "up2k.hash_f
-00011cb0: 696c 6522 2c0a 2020 2020 2020 2020 2020  ile",.          
-00011cc0: 2020 2020 2020 2020 2020 2020 2020 6462                db
-00011cd0: 762e 7265 616c 7061 7468 2c0a 2020 2020  v.realpath,.    
-00011ce0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011cf0: 2020 2020 7666 732e 7670 6174 682c 0a20      vfs.vpath,. 
-00011d00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011d10: 2020 2020 2020 2064 6276 2e66 6c61 6773         dbv.flags
-00011d20: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00011d30: 2020 2020 2020 2020 2020 7672 656d 2c0a            vrem,.
-00011d40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011d50: 2020 2020 2020 2020 666e 616d 652c 0a20          fname,. 
-00011d60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011d70: 2020 2020 2020 2073 656c 662e 6970 2c0a         self.ip,.
-00011d80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011d90: 2020 2020 2020 2020 6174 2c0a 2020 2020          at,.    
-00011da0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011db0: 2020 2020 7365 6c66 2e75 6e61 6d65 2c0a      self.uname,.
-00011dc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011dd0: 2020 2020 2020 2020 5472 7565 2c0a 2020          True,.  
-00011de0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011df0: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
-00011e00: 2020 2020 2020 2020 7365 6c66 2e63 6f6e          self.con
-00011e10: 6e2e 6e62 7974 6520 2b3d 2073 7a0a 0a20  n.nbyte += sz.. 
-00011e20: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-00011e30: 7863 6570 7420 5065 626b 6163 3a0a 2020  xcept Pebkac:.  
-00011e40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011e50: 2020 7365 6c66 2e70 6172 7365 722e 6472    self.parser.dr
-00011e60: 6f70 2829 0a20 2020 2020 2020 2020 2020  op().           
-00011e70: 2020 2020 2020 2020 2072 6169 7365 0a0a           raise..
-00011e80: 2020 2020 2020 2020 6578 6365 7074 2050          except P
-00011e90: 6562 6b61 6320 6173 2065 783a 0a20 2020  ebkac as ex:.   
-00011ea0: 2020 2020 2020 2020 2065 7272 6d73 6720           errmsg 
-00011eb0: 3d20 766f 6c5f 7361 6e28 0a20 2020 2020  = vol_san(.     
-00011ec0: 2020 2020 2020 2020 2020 206c 6973 7428             list(
-00011ed0: 7365 6c66 2e61 7372 762e 7666 732e 616c  self.asrv.vfs.al
-00011ee0: 6c5f 766f 6c73 2e76 616c 7565 7328 2929  l_vols.values())
-00011ef0: 2c20 756e 6963 6f64 6528 6578 292e 656e  , unicode(ex).en
-00011f00: 636f 6465 2822 7574 662d 3822 290a 2020  code("utf-8").  
-00011f10: 2020 2020 2020 2020 2020 292e 6465 636f            ).deco
-00011f20: 6465 2822 7574 662d 3822 290a 0a20 2020  de("utf-8")..   
-00011f30: 2020 2020 2074 6420 3d20 6d61 7828 302e       td = max(0.
-00011f40: 312c 2074 696d 652e 7469 6d65 2829 202d  1, time.time() -
-00011f50: 2074 3029 0a20 2020 2020 2020 2073 7a5f   t0).        sz_
-00011f60: 746f 7461 6c20 3d20 7375 6d28 785b 305d  total = sum(x[0]
-00011f70: 2066 6f72 2078 2069 6e20 6669 6c65 7329   for x in files)
-00011f80: 0a20 2020 2020 2020 2073 7064 203d 2028  .        spd = (
-00011f90: 737a 5f74 6f74 616c 202f 2074 6429 202f  sz_total / td) /
-00011fa0: 2028 3130 3234 202a 2031 3032 3429 0a0a   (1024 * 1024)..
-00011fb0: 2020 2020 2020 2020 7374 6174 7573 203d          status =
-00011fc0: 2022 4f4b 220a 2020 2020 2020 2020 6966   "OK".        if
-00011fd0: 2065 7272 6d73 673a 0a20 2020 2020 2020   errmsg:.       
-00011fe0: 2020 2020 2073 656c 662e 6c6f 6728 6572       self.log(er
-00011ff0: 726d 7367 2c20 3329 0a20 2020 2020 2020  rmsg, 3).       
-00012000: 2020 2020 2073 7461 7475 7320 3d20 2245       status = "E
-00012010: 5252 4f52 220a 0a20 2020 2020 2020 206d  RROR"..        m
-00012020: 7367 203d 2022 7b7d 202f 2f20 7b7d 2062  sg = "{} // {} b
-00012030: 7974 6573 202f 2f20 7b3a 2e33 667d 204d  ytes // {:.3f} M
-00012040: 6942 2f73 5c6e 222e 666f 726d 6174 2873  iB/s\n".format(s
-00012050: 7461 7475 732c 2073 7a5f 746f 7461 6c2c  tatus, sz_total,
-00012060: 2073 7064 290a 2020 2020 2020 2020 6a6d   spd).        jm
-00012070: 7367 2020 203d 207b 0a20 2020 2020 2020  sg   = {.       
-00012080: 2020 2020 2022 7374 6174 7573 223a 2073       "status": s
-00012090: 7461 7475 732c 0a20 2020 2020 2020 2020  tatus,.         
-000120a0: 2020 2022 737a 223a 2073 7a5f 746f 7461     "sz": sz_tota
-000120b0: 6c2c 0a20 2020 2020 2020 2020 2020 2022  l,.            "
-000120c0: 6d62 7073 223a 2072 6f75 6e64 2873 7064  mbps": round(spd
-000120d0: 2c20 3329 2c0a 2020 2020 2020 2020 2020  , 3),.          
-000120e0: 2020 2266 696c 6573 223a 205b 5d2c 0a20    "files": [],. 
-000120f0: 2020 2020 2020 207d 0a0a 2020 2020 2020         }..      
-00012100: 2020 6966 2065 7272 6d73 673a 0a20 2020    if errmsg:.   
-00012110: 2020 2020 2020 2020 206d 7367 202b 3d20           msg += 
-00012120: 6572 726d 7367 202b 2022 5c6e 220a 2020  errmsg + "\n".  
-00012130: 2020 2020 2020 2020 2020 6a6d 7367 5b22            jmsg["
-00012140: 6572 726f 7222 5d20 3d20 6572 726d 7367  error"] = errmsg
-00012150: 0a20 2020 2020 2020 2020 2020 2065 7272  .            err
-00012160: 6d73 6720 3d20 2245 5252 4f52 3a20 2220  msg = "ERROR: " 
-00012170: 2b20 6572 726d 7367 0a0a 2020 2020 2020  + errmsg..      
-00012180: 2020 666f 7220 737a 2c20 7368 615f 6865    for sz, sha_he
-00012190: 782c 2073 6861 5f62 3634 2c20 6f66 6e2c  x, sha_b64, ofn,
-000121a0: 206c 666e 2c20 6170 2069 6e20 6669 6c65   lfn, ap in file
-000121b0: 733a 0a20 2020 2020 2020 2020 2020 2076  s:.            v
-000121c0: 7375 6620 3d20 2222 0a20 2020 2020 2020  suf = "".       
-000121d0: 2020 2020 2069 6620 2873 656c 662e 6361       if (self.ca
-000121e0: 6e5f 7265 6164 206f 7220 7365 6c66 2e63  n_read or self.c
-000121f0: 616e 5f75 7067 6574 2920 616e 6420 2266  an_upget) and "f
-00012200: 6b22 2069 6e20 7666 732e 666c 6167 733a  k" in vfs.flags:
-00012210: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00012220: 2076 7375 6620 3d20 223f 6b3d 2220 2b20   vsuf = "?k=" + 
-00012230: 7365 6c66 2e67 656e 5f66 6b28 0a20 2020  self.gen_fk(.   
-00012240: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012250: 2073 656c 662e 6172 6773 2e66 6b5f 7361   self.args.fk_sa
-00012260: 6c74 2c0a 2020 2020 2020 2020 2020 2020  lt,.            
-00012270: 2020 2020 2020 2020 6170 2c0a 2020 2020          ap,.    
-00012280: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012290: 737a 2c0a 2020 2020 2020 2020 2020 2020  sz,.            
-000122a0: 2020 2020 2020 2020 3020 6966 2041 4e59          0 if ANY
-000122b0: 5749 4e20 6f72 206e 6f74 2061 7020 656c  WIN or not ap el
-000122c0: 7365 2062 6f73 2e73 7461 7428 6170 292e  se bos.stat(ap).
-000122d0: 7374 5f69 6e6f 2c0a 2020 2020 2020 2020  st_ino,.        
-000122e0: 2020 2020 2020 2020 295b 3a20 7666 732e          )[: vfs.
-000122f0: 666c 6167 735b 2266 6b22 5d5d 0a0a 2020  flags["fk"]]..  
-00012300: 2020 2020 2020 2020 2020 7670 6174 6820            vpath 
-00012310: 3d20 227b 7d2f 7b7d 222e 666f 726d 6174  = "{}/{}".format
-00012320: 2875 706c 6f61 645f 7670 6174 682c 206c  (upload_vpath, l
-00012330: 666e 292e 7374 7269 7028 222f 2229 0a20  fn).strip("/"). 
-00012340: 2020 2020 2020 2020 2020 2072 656c 5f75             rel_u
-00012350: 726c 203d 2071 756f 7465 7028 7365 6c66  rl = quotep(self
-00012360: 2e61 7267 732e 5253 202b 2076 7061 7468  .args.RS + vpath
-00012370: 2920 2b20 7673 7566 0a20 2020 2020 2020  ) + vsuf.       
-00012380: 2020 2020 206d 7367 202b 3d20 2773 6861       msg += 'sha
-00012390: 3531 323a 207b 7d20 2f2f 207b 7d20 2f2f  512: {} // {} //
-000123a0: 207b 7d20 6279 7465 7320 2f2f 203c 6120   {} bytes // <a 
-000123b0: 6872 6566 3d22 2f7b 7d22 3e7b 7d3c 2f61  href="/{}">{}</a
-000123c0: 3e20 7b7d 5c6e 272e 666f 726d 6174 280a  > {}\n'.format(.
-000123d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000123e0: 7368 615f 6865 785b 3a35 365d 2c0a 2020  sha_hex[:56],.  
-000123f0: 2020 2020 2020 2020 2020 2020 2020 7368                sh
-00012400: 615f 6236 342c 0a20 2020 2020 2020 2020  a_b64,.         
-00012410: 2020 2020 2020 2073 7a2c 0a20 2020 2020         sz,.     
-00012420: 2020 2020 2020 2020 2020 2072 656c 5f75             rel_u
-00012430: 726c 2c0a 2020 2020 2020 2020 2020 2020  rl,.            
-00012440: 2020 2020 6874 6d6c 5f65 7363 6170 6528      html_escape(
-00012450: 6f66 6e2c 2063 726c 663d 5472 7565 292c  ofn, crlf=True),
-00012460: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00012470: 2076 7375 662c 0a20 2020 2020 2020 2020   vsuf,.         
-00012480: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
-00012490: 2023 2074 7275 6e63 6174 6564 2053 4841   # truncated SHA
-000124a0: 2d35 3132 2070 7265 7665 6e74 7320 6c65  -512 prevents le
-000124b0: 6e67 7468 2065 7874 656e 7369 6f6e 2061  ngth extension a
-000124c0: 7474 6163 6b73 3b0a 2020 2020 2020 2020  ttacks;.        
-000124d0: 2020 2020 2320 7573 696e 6720 5348 412d      # using SHA-
-000124e0: 3531 322f 3232 342c 206f 7074 696f 6e61  512/224, optiona
-000124f0: 6c6c 7920 5348 412d 3531 322f 3235 3620  lly SHA-512/256 
-00012500: 3d20 3a36 340a 2020 2020 2020 2020 2020  = :64.          
-00012510: 2020 6a70 6172 7420 3d20 7b0a 2020 2020    jpart = {.    
-00012520: 2020 2020 2020 2020 2020 2020 2275 726c              "url
-00012530: 223a 2022 7b7d 3a2f 2f7b 7d2f 7b7d 222e  ": "{}://{}/{}".
-00012540: 666f 726d 6174 280a 2020 2020 2020 2020  format(.        
-00012550: 2020 2020 2020 2020 2020 2020 2268 7474              "htt
-00012560: 7073 2220 6966 2073 656c 662e 6973 5f68  ps" if self.is_h
-00012570: 7474 7073 2065 6c73 6520 2268 7474 7022  ttps else "http"
-00012580: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00012590: 2020 2020 2020 7365 6c66 2e68 6f73 742c        self.host,
-000125a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000125b0: 2020 2020 2072 656c 5f75 726c 2c0a 2020       rel_url,.  
-000125c0: 2020 2020 2020 2020 2020 2020 2020 292c                ),
-000125d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000125e0: 2022 7368 6135 3132 223a 2073 6861 5f68   "sha512": sha_h
-000125f0: 6578 5b3a 3536 5d2c 0a20 2020 2020 2020  ex[:56],.       
-00012600: 2020 2020 2020 2020 2022 7368 615f 6236           "sha_b6
-00012610: 3422 3a20 7368 615f 6236 342c 0a20 2020  4": sha_b64,.   
-00012620: 2020 2020 2020 2020 2020 2020 2022 737a               "sz
-00012630: 223a 2073 7a2c 0a20 2020 2020 2020 2020  ": sz,.         
-00012640: 2020 2020 2020 2022 666e 223a 206c 666e         "fn": lfn
-00012650: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00012660: 2020 2266 6e5f 6f72 6967 223a 206f 666e    "fn_orig": ofn
-00012670: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00012680: 2020 2270 6174 6822 3a20 7265 6c5f 7572    "path": rel_ur
-00012690: 6c2c 0a20 2020 2020 2020 2020 2020 207d  l,.            }
-000126a0: 0a20 2020 2020 2020 2020 2020 206a 6d73  .            jms
-000126b0: 675b 2266 696c 6573 225d 2e61 7070 656e  g["files"].appen
-000126c0: 6428 6a70 6172 7429 0a0a 2020 2020 2020  d(jpart)..      
-000126d0: 2020 7673 7064 203d 2073 656c 662e 5f73    vspd = self._s
-000126e0: 7064 2873 7a5f 746f 7461 6c2c 2046 616c  pd(sz_total, Fal
-000126f0: 7365 290a 2020 2020 2020 2020 7365 6c66  se).        self
-00012700: 2e6c 6f67 2822 7b7d 207b 7d22 2e66 6f72  .log("{} {}".for
-00012710: 6d61 7428 7673 7064 2c20 6d73 6729 290a  mat(vspd, msg)).
-00012720: 0a20 2020 2020 2020 2073 7566 203d 2022  .        suf = "
-00012730: 220a 2020 2020 2020 2020 6966 206e 6f74  ".        if not
-00012740: 206e 756c 6c77 7269 7465 2061 6e64 2073   nullwrite and s
-00012750: 656c 662e 6172 6773 2e77 7269 7465 5f75  elf.args.write_u
-00012760: 706c 6f67 3a0a 2020 2020 2020 2020 2020  plog:.          
-00012770: 2020 7472 793a 0a20 2020 2020 2020 2020    try:.         
-00012780: 2020 2020 2020 206c 6f67 5f66 6e20 3d20         log_fn = 
-00012790: 2275 702e 7b3a 2e36 667d 2e74 7874 222e  "up.{:.6f}.txt".
-000127a0: 666f 726d 6174 2874 3029 0a20 2020 2020  format(t0).     
-000127b0: 2020 2020 2020 2020 2020 2077 6974 6820             with 
-000127c0: 6f70 656e 286c 6f67 5f66 6e2c 2022 7762  open(log_fn, "wb
-000127d0: 2229 2061 7320 663a 0a20 2020 2020 2020  ") as f:.       
-000127e0: 2020 2020 2020 2020 2020 2020 2066 7420               ft 
-000127f0: 3d20 227b 7d3a 7b7d 222e 666f 726d 6174  = "{}:{}".format
-00012800: 2873 656c 662e 6970 2c20 7365 6c66 2e61  (self.ip, self.a
-00012810: 6464 725b 315d 290a 2020 2020 2020 2020  ddr[1]).        
-00012820: 2020 2020 2020 2020 2020 2020 6674 203d              ft =
-00012830: 2022 7b7d 5c6e 7b7d 5c6e 7b7d 5c6e 222e   "{}\n{}\n{}\n".
-00012840: 666f 726d 6174 2866 742c 206d 7367 2e72  format(ft, msg.r
-00012850: 7374 7269 7028 292c 2065 7272 6d73 6729  strip(), errmsg)
-00012860: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00012870: 2020 2020 2066 2e77 7269 7465 2866 742e       f.write(ft.
-00012880: 656e 636f 6465 2822 7574 662d 3822 2929  encode("utf-8"))
-00012890: 0a20 2020 2020 2020 2020 2020 2065 7863  .            exc
-000128a0: 6570 7420 4578 6365 7074 696f 6e20 6173  ept Exception as
-000128b0: 2065 783a 0a20 2020 2020 2020 2020 2020   ex:.           
-000128c0: 2020 2020 2073 7566 203d 2022 5c6e 6661       suf = "\nfa
-000128d0: 696c 6564 2074 6f20 7772 6974 6520 7468  iled to write th
-000128e0: 6520 7570 6c6f 6164 2072 6570 6f72 743a  e upload report:
-000128f0: 207b 7d22 2e66 6f72 6d61 7428 6578 290a   {}".format(ex).
-00012900: 0a20 2020 2020 2020 2073 6320 3d20 3430  .        sc = 40
-00012910: 3020 6966 2065 7272 6d73 6720 656c 7365  0 if errmsg else
-00012920: 2032 3031 0a20 2020 2020 2020 2069 6620   201.        if 
-00012930: 7761 6e74 5f75 726c 3a0a 2020 2020 2020  want_url:.      
-00012940: 2020 2020 2020 6d73 6720 3d20 225c 6e22        msg = "\n"
-00012950: 2e6a 6f69 6e28 5b78 5b22 7572 6c22 5d20  .join([x["url"] 
-00012960: 666f 7220 7820 696e 206a 6d73 675b 2266  for x in jmsg["f
-00012970: 696c 6573 225d 5d29 0a20 2020 2020 2020  iles"]]).       
-00012980: 2020 2020 2069 6620 6572 726d 7367 3a0a       if errmsg:.
-00012990: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000129a0: 6d73 6720 2b3d 2022 5c6e 2220 2b20 6572  msg += "\n" + er
-000129b0: 726d 7367 0a0a 2020 2020 2020 2020 2020  rmsg..          
-000129c0: 2020 7365 6c66 2e72 6570 6c79 286d 7367    self.reply(msg
-000129d0: 2e65 6e63 6f64 6528 2275 7466 2d38 222c  .encode("utf-8",
-000129e0: 2022 7265 706c 6163 6522 292c 2073 7461   "replace"), sta
-000129f0: 7475 733d 7363 290a 2020 2020 2020 2020  tus=sc).        
-00012a00: 656c 6966 2022 6a22 2069 6e20 7365 6c66  elif "j" in self
-00012a10: 2e75 7061 7261 6d3a 0a20 2020 2020 2020  .uparam:.       
-00012a20: 2020 2020 206a 7478 7420 3d20 6a73 6f6e       jtxt = json
-00012a30: 2e64 756d 7073 286a 6d73 672c 2069 6e64  .dumps(jmsg, ind
-00012a40: 656e 743d 322c 2073 6f72 745f 6b65 7973  ent=2, sort_keys
-00012a50: 3d54 7275 6529 2e65 6e63 6f64 6528 2275  =True).encode("u
-00012a60: 7466 2d38 222c 2022 7265 706c 6163 6522  tf-8", "replace"
-00012a70: 290a 2020 2020 2020 2020 2020 2020 7365  ).            se
-00012a80: 6c66 2e72 6570 6c79 286a 7478 742c 206d  lf.reply(jtxt, m
-00012a90: 696d 653d 2261 7070 6c69 6361 7469 6f6e  ime="application
-00012aa0: 2f6a 736f 6e22 2c20 7374 6174 7573 3d73  /json", status=s
-00012ab0: 6329 0a20 2020 2020 2020 2065 6c73 653a  c).        else:
-00012ac0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-00012ad0: 662e 7265 6469 7265 6374 280a 2020 2020  f.redirect(.    
-00012ae0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00012af0: 2e76 7061 7468 2c0a 2020 2020 2020 2020  .vpath,.        
-00012b00: 2020 2020 2020 2020 6d73 673d 6d73 6720          msg=msg 
-00012b10: 2b20 7375 662c 0a20 2020 2020 2020 2020  + suf,.         
-00012b20: 2020 2020 2020 2066 6c61 766f 723d 2272         flavor="r
-00012b30: 6574 7572 6e20 746f 222c 0a20 2020 2020  eturn to",.     
-00012b40: 2020 2020 2020 2020 2020 2063 6c69 636b             click
-00012b50: 3d46 616c 7365 2c0a 2020 2020 2020 2020  =False,.        
-00012b60: 2020 2020 2020 2020 7374 6174 7573 3d73          status=s
-00012b70: 632c 0a20 2020 2020 2020 2020 2020 2029  c,.            )
-00012b80: 0a0a 2020 2020 2020 2020 6966 2065 7272  ..        if err
-00012b90: 6d73 673a 0a20 2020 2020 2020 2020 2020  msg:.           
-00012ba0: 2072 6574 7572 6e20 4661 6c73 650a 0a20   return False.. 
-00012bb0: 2020 2020 2020 2073 656c 662e 7061 7273         self.pars
-00012bc0: 6572 2e64 726f 7028 290a 2020 2020 2020  er.drop().      
-00012bd0: 2020 7265 7475 726e 2054 7275 650a 0a20    return True.. 
-00012be0: 2020 2064 6566 2068 616e 646c 655f 7465     def handle_te
-00012bf0: 7874 5f75 706c 6f61 6428 7365 6c66 2920  xt_upload(self) 
-00012c00: 203a 0a20 2020 2020 2020 2061 7373 6572   :.        asser
-00012c10: 7420 7365 6c66 2e70 6172 7365 720a 2020  t self.parser.  
-00012c20: 2020 2020 2020 7472 793a 0a20 2020 2020        try:.     
-00012c30: 2020 2020 2020 2063 6c69 5f6c 6173 746d         cli_lastm
-00012c40: 6f64 3320 3d20 696e 7428 7365 6c66 2e70  od3 = int(self.p
-00012c50: 6172 7365 722e 7265 7175 6972 6528 226c  arser.require("l
-00012c60: 6173 746d 6f64 222c 2031 3629 290a 2020  astmod", 16)).  
-00012c70: 2020 2020 2020 6578 6365 7074 3a0a 2020        except:.  
-00012c80: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
-00012c90: 5065 626b 6163 2834 3030 2c20 2263 6f75  Pebkac(400, "cou
-00012ca0: 6c64 206e 6f74 2072 6561 6420 6c61 7374  ld not read last
-00012cb0: 6d6f 6420 6672 6f6d 2072 6571 7565 7374  mod from request
-00012cc0: 2229 0a0a 2020 2020 2020 2020 6e75 6c6c  ")..        null
-00012cd0: 7772 6974 6520 3d20 7365 6c66 2e61 7267  write = self.arg
-00012ce0: 732e 6e77 0a20 2020 2020 2020 2076 6673  s.nw.        vfs
-00012cf0: 2c20 7265 6d20 3d20 7365 6c66 2e61 7372  , rem = self.asr
-00012d00: 762e 7666 732e 6765 7428 7365 6c66 2e76  v.vfs.get(self.v
-00012d10: 7061 7468 2c20 7365 6c66 2e75 6e61 6d65  path, self.uname
-00012d20: 2c20 5472 7565 2c20 5472 7565 290a 2020  , True, True).  
-00012d30: 2020 2020 2020 7365 6c66 2e5f 6173 7365        self._asse
-00012d40: 7274 5f73 6166 655f 7265 6d28 7265 6d29  rt_safe_rem(rem)
-00012d50: 0a0a 2020 2020 2020 2020 636c 656e 203d  ..        clen =
-00012d60: 2069 6e74 2873 656c 662e 6865 6164 6572   int(self.header
-00012d70: 732e 6765 7428 2263 6f6e 7465 6e74 2d6c  s.get("content-l
-00012d80: 656e 6774 6822 2c20 2d31 2929 0a20 2020  ength", -1)).   
-00012d90: 2020 2020 2069 6620 636c 656e 203d 3d20       if clen == 
-00012da0: 2d31 3a0a 2020 2020 2020 2020 2020 2020  -1:.            
-00012db0: 7261 6973 6520 5065 626b 6163 2834 3131  raise Pebkac(411
-00012dc0: 290a 0a20 2020 2020 2020 2072 702c 2066  )..        rp, f
-00012dd0: 6e20 3d20 7673 706c 6974 2872 656d 290a  n = vsplit(rem).
-00012de0: 2020 2020 2020 2020 6670 203d 2076 6673          fp = vfs
-00012df0: 2e63 616e 6f6e 6963 616c 2872 7029 0a20  .canonical(rp). 
-00012e00: 2020 2020 2020 206c 696d 203d 2076 6673         lim = vfs
-00012e10: 2e67 6574 5f64 6276 2872 656d 295b 305d  .get_dbv(rem)[0]
-00012e20: 2e6c 696d 0a20 2020 2020 2020 2069 6620  .lim.        if 
-00012e30: 6c69 6d3a 0a20 2020 2020 2020 2020 2020  lim:.           
-00012e40: 2066 702c 2072 7020 3d20 6c69 6d2e 616c   fp, rp = lim.al
-00012e50: 6c28 7365 6c66 2e69 702c 2072 702c 2063  l(self.ip, rp, c
-00012e60: 6c65 6e2c 2066 7029 0a20 2020 2020 2020  len, fp).       
-00012e70: 2020 2020 2062 6f73 2e6d 616b 6564 6972       bos.makedir
-00012e80: 7328 6670 290a 0a20 2020 2020 2020 2066  s(fp)..        f
-00012e90: 7020 3d20 6f73 2e70 6174 682e 6a6f 696e  p = os.path.join
-00012ea0: 2866 702c 2066 6e29 0a20 2020 2020 2020  (fp, fn).       
-00012eb0: 2072 656d 203d 2022 7b7d 2f7b 7d22 2e66   rem = "{}/{}".f
-00012ec0: 6f72 6d61 7428 7270 2c20 666e 292e 7374  ormat(rp, fn).st
-00012ed0: 7269 7028 222f 2229 0a0a 2020 2020 2020  rip("/")..      
-00012ee0: 2020 6966 206e 6f74 2072 656d 2e65 6e64    if not rem.end
-00012ef0: 7377 6974 6828 222e 6d64 2229 3a0a 2020  swith(".md"):.  
-00012f00: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
-00012f10: 5065 626b 6163 2834 3030 2c20 226f 6e6c  Pebkac(400, "onl
-00012f20: 7920 6d61 726b 646f 776e 2070 6c73 2229  y markdown pls")
-00012f30: 0a0a 2020 2020 2020 2020 6966 206e 756c  ..        if nul
-00012f40: 6c77 7269 7465 3a0a 2020 2020 2020 2020  lwrite:.        
-00012f50: 2020 2020 7265 7370 6f6e 7365 203d 206a      response = j
-00012f60: 736f 6e2e 6475 6d70 7328 7b22 6f6b 223a  son.dumps({"ok":
-00012f70: 2054 7275 652c 2022 6c61 7374 6d6f 6422   True, "lastmod"
-00012f80: 3a20 307d 290a 2020 2020 2020 2020 2020  : 0}).          
-00012f90: 2020 7365 6c66 2e6c 6f67 2872 6573 706f    self.log(respo
-00012fa0: 6e73 6529 0a20 2020 2020 2020 2020 2020  nse).           
-00012fb0: 2023 2054 4f44 4f20 7265 706c 7920 7368   # TODO reply sh
-00012fc0: 6f75 6c64 2070 6172 7365 722e 6472 6f70  ould parser.drop
-00012fd0: 2829 0a20 2020 2020 2020 2020 2020 2073  ().            s
-00012fe0: 656c 662e 7061 7273 6572 2e64 726f 7028  elf.parser.drop(
-00012ff0: 290a 2020 2020 2020 2020 2020 2020 7365  ).            se
-00013000: 6c66 2e72 6570 6c79 2872 6573 706f 6e73  lf.reply(respons
-00013010: 652e 656e 636f 6465 2822 7574 662d 3822  e.encode("utf-8"
-00013020: 2929 0a20 2020 2020 2020 2020 2020 2072  )).            r
-00013030: 6574 7572 6e20 5472 7565 0a0a 2020 2020  eturn True..    
-00013040: 2020 2020 7372 765f 6c61 7374 6d6f 6420      srv_lastmod 
-00013050: 3d20 2d31 2e30 0a20 2020 2020 2020 2073  = -1.0.        s
-00013060: 7276 5f6c 6173 746d 6f64 3320 3d20 2d31  rv_lastmod3 = -1
-00013070: 0a20 2020 2020 2020 2074 7279 3a0a 2020  .        try:.  
-00013080: 2020 2020 2020 2020 2020 7374 203d 2062            st = b
-00013090: 6f73 2e73 7461 7428 6670 290a 2020 2020  os.stat(fp).    
-000130a0: 2020 2020 2020 2020 7372 765f 6c61 7374          srv_last
-000130b0: 6d6f 6420 3d20 7374 2e73 745f 6d74 696d  mod = st.st_mtim
-000130c0: 650a 2020 2020 2020 2020 2020 2020 7372  e.            sr
-000130d0: 765f 6c61 7374 6d6f 6433 203d 2069 6e74  v_lastmod3 = int
-000130e0: 2873 7276 5f6c 6173 746d 6f64 202a 2031  (srv_lastmod * 1
-000130f0: 3030 3029 0a20 2020 2020 2020 2065 7863  000).        exc
-00013100: 6570 7420 4f53 4572 726f 7220 6173 2065  ept OSError as e
-00013110: 783a 0a20 2020 2020 2020 2020 2020 2069  x:.            i
-00013120: 6620 6578 2e65 7272 6e6f 2021 3d20 6572  f ex.errno != er
-00013130: 726e 6f2e 454e 4f45 4e54 3a0a 2020 2020  rno.ENOENT:.    
-00013140: 2020 2020 2020 2020 2020 2020 7261 6973              rais
-00013150: 650a 0a20 2020 2020 2020 2023 2069 6620  e..        # if 
-00013160: 6669 6c65 2065 7869 7374 732c 2063 6865  file exists, che
-00013170: 6b63 2074 6861 7420 7469 6d65 7374 616d  kc that timestam
-00013180: 7020 6d61 7463 6865 7320 7468 6520 636c  p matches the cl
-00013190: 6965 6e74 2773 0a20 2020 2020 2020 2069  ient's.        i
-000131a0: 6620 7372 765f 6c61 7374 6d6f 6420 3e3d  f srv_lastmod >=
-000131b0: 2030 3a0a 2020 2020 2020 2020 2020 2020   0:.            
-000131c0: 7361 6d65 5f6c 6173 746d 6f64 203d 2063  same_lastmod = c
-000131d0: 6c69 5f6c 6173 746d 6f64 3320 696e 205b  li_lastmod3 in [
-000131e0: 2d31 2c20 7372 765f 6c61 7374 6d6f 6433  -1, srv_lastmod3
-000131f0: 5d0a 2020 2020 2020 2020 2020 2020 6966  ].            if
-00013200: 206e 6f74 2073 616d 655f 6c61 7374 6d6f   not same_lastmo
-00013210: 643a 0a20 2020 2020 2020 2020 2020 2020  d:.             
-00013220: 2020 2023 2073 6f6d 6520 6669 6c65 7379     # some filesy
-00013230: 7374 656d 732f 7472 616e 7370 6f72 7473  stems/transports
-00013240: 206c 696d 6974 2070 7265 6369 7369 6f6e   limit precision
-00013250: 2074 6f20 3173 6563 2c20 686f 7065 6675   to 1sec, hopefu
-00013260: 6c6c 7920 666c 6f6f 7265 640a 2020 2020  lly floored.    
-00013270: 2020 2020 2020 2020 2020 2020 7361 6d65              same
-00013280: 5f6c 6173 746d 6f64 203d 2028 0a20 2020  _lastmod = (.   
-00013290: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000132a0: 2073 7276 5f6c 6173 746d 6f64 203d 3d20   srv_lastmod == 
-000132b0: 696e 7428 636c 695f 6c61 7374 6d6f 6433  int(cli_lastmod3
-000132c0: 202f 2031 3030 3029 0a20 2020 2020 2020   / 1000).       
-000132d0: 2020 2020 2020 2020 2020 2020 2061 6e64               and
-000132e0: 2063 6c69 5f6c 6173 746d 6f64 3320 3e20   cli_lastmod3 > 
-000132f0: 7372 765f 6c61 7374 6d6f 6433 0a20 2020  srv_lastmod3.   
-00013300: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013310: 2061 6e64 2063 6c69 5f6c 6173 746d 6f64   and cli_lastmod
-00013320: 3320 2d20 7372 765f 6c61 7374 6d6f 6433  3 - srv_lastmod3
-00013330: 203c 2031 3030 300a 2020 2020 2020 2020   < 1000.        
-00013340: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
-00013350: 2020 2020 2020 2069 6620 6e6f 7420 7361         if not sa
-00013360: 6d65 5f6c 6173 746d 6f64 3a0a 2020 2020  me_lastmod:.    
-00013370: 2020 2020 2020 2020 2020 2020 7265 7370              resp
-00013380: 6f6e 7365 203d 206a 736f 6e2e 6475 6d70  onse = json.dump
-00013390: 7328 0a20 2020 2020 2020 2020 2020 2020  s(.             
-000133a0: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
-000133b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000133c0: 2022 6f6b 223a 2046 616c 7365 2c0a 2020   "ok": False,.  
-000133d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000133e0: 2020 2020 2020 226c 6173 746d 6f64 223a        "lastmod":
-000133f0: 2073 7276 5f6c 6173 746d 6f64 332c 0a20   srv_lastmod3,. 
-00013400: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013410: 2020 2020 2020 2022 6e6f 7722 3a20 696e         "now": in
-00013420: 7428 7469 6d65 2e74 696d 6528 2920 2a20  t(time.time() * 
-00013430: 3130 3030 292c 0a20 2020 2020 2020 2020  1000),.         
-00013440: 2020 2020 2020 2020 2020 207d 0a20 2020             }.   
-00013450: 2020 2020 2020 2020 2020 2020 2029 0a20               ). 
-00013460: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-00013470: 656c 662e 6c6f 6728 0a20 2020 2020 2020  elf.log(.       
-00013480: 2020 2020 2020 2020 2020 2020 2022 7b7d               "{}
-00013490: 202d 207b 7d20 3d20 7b7d 222e 666f 726d   - {} = {}".form
-000134a0: 6174 280a 2020 2020 2020 2020 2020 2020  at(.            
-000134b0: 2020 2020 2020 2020 2020 2020 7372 765f              srv_
-000134c0: 6c61 7374 6d6f 6433 2c20 636c 695f 6c61  lastmod3, cli_la
-000134d0: 7374 6d6f 6433 2c20 7372 765f 6c61 7374  stmod3, srv_last
-000134e0: 6d6f 6433 202d 2063 6c69 5f6c 6173 746d  mod3 - cli_lastm
-000134f0: 6f64 330a 2020 2020 2020 2020 2020 2020  od3.            
-00013500: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-00013510: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
-00013520: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00013530: 2e6c 6f67 2872 6573 706f 6e73 6529 0a20  .log(response). 
-00013540: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-00013550: 656c 662e 7061 7273 6572 2e64 726f 7028  elf.parser.drop(
-00013560: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00013570: 2020 7365 6c66 2e72 6570 6c79 2872 6573    self.reply(res
-00013580: 706f 6e73 652e 656e 636f 6465 2822 7574  ponse.encode("ut
-00013590: 662d 3822 2929 0a20 2020 2020 2020 2020  f-8")).         
-000135a0: 2020 2020 2020 2072 6574 7572 6e20 5472         return Tr
-000135b0: 7565 0a0a 2020 2020 2020 2020 2020 2020  ue..            
-000135c0: 6d64 6972 2c20 6d66 696c 6520 3d20 6f73  mdir, mfile = os
-000135d0: 2e70 6174 682e 7370 6c69 7428 6670 290a  .path.split(fp).
-000135e0: 2020 2020 2020 2020 2020 2020 6d66 696c              mfil
-000135f0: 6532 203d 2022 7b7d 2e7b 3a2e 3366 7d2e  e2 = "{}.{:.3f}.
-00013600: 6d64 222e 666f 726d 6174 286d 6669 6c65  md".format(mfile
-00013610: 5b3a 2d33 5d2c 2073 7276 5f6c 6173 746d  [:-3], srv_lastm
-00013620: 6f64 290a 2020 2020 2020 2020 2020 2020  od).            
-00013630: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
-00013640: 2020 2020 2064 7020 3d20 6f73 2e70 6174       dp = os.pat
-00013650: 682e 6a6f 696e 286d 6469 722c 2022 2e68  h.join(mdir, ".h
-00013660: 6973 7422 290a 2020 2020 2020 2020 2020  ist").          
-00013670: 2020 2020 2020 626f 732e 6d6b 6469 7228        bos.mkdir(
-00013680: 6470 290a 2020 2020 2020 2020 2020 2020  dp).            
-00013690: 2020 2020 6869 6465 6469 7228 6470 290a      hidedir(dp).
-000136a0: 2020 2020 2020 2020 2020 2020 6578 6365              exce
-000136b0: 7074 3a0a 2020 2020 2020 2020 2020 2020  pt:.            
-000136c0: 2020 2020 7061 7373 0a20 2020 2020 2020      pass.       
-000136d0: 2020 2020 2062 6f73 2e72 656e 616d 6528       bos.rename(
-000136e0: 6670 2c20 6f73 2e70 6174 682e 6a6f 696e  fp, os.path.join
-000136f0: 286d 6469 722c 2022 2e68 6973 7422 2c20  (mdir, ".hist", 
-00013700: 6d66 696c 6532 2929 0a0a 2020 2020 2020  mfile2))..      
-00013710: 2020 6173 7365 7274 2073 656c 662e 7061    assert self.pa
-00013720: 7273 6572 2e67 656e 0a20 2020 2020 2020  rser.gen.       
-00013730: 2070 5f66 6965 6c64 2c20 5f2c 2070 5f64   p_field, _, p_d
-00013740: 6174 6120 3d20 6e65 7874 2873 656c 662e  ata = next(self.
-00013750: 7061 7273 6572 2e67 656e 290a 2020 2020  parser.gen).    
-00013760: 2020 2020 6966 2070 5f66 6965 6c64 2021      if p_field !
-00013770: 3d20 2262 6f64 7922 3a0a 2020 2020 2020  = "body":.      
-00013780: 2020 2020 2020 7261 6973 6520 5065 626b        raise Pebk
-00013790: 6163 2834 3030 2c20 2265 7870 6563 7465  ac(400, "expecte
-000137a0: 6420 626f 6479 2c20 676f 7420 7b7d 222e  d body, got {}".
-000137b0: 666f 726d 6174 2870 5f66 6965 6c64 2929  format(p_field))
-000137c0: 0a0a 2020 2020 2020 2020 6966 2062 6f73  ..        if bos
-000137d0: 2e70 6174 682e 6578 6973 7473 2866 7029  .path.exists(fp)
-000137e0: 3a0a 2020 2020 2020 2020 2020 2020 626f  :.            bo
-000137f0: 732e 756e 6c69 6e6b 2866 7029 0a0a 2020  s.unlink(fp)..  
-00013800: 2020 2020 2020 7769 7468 206f 7065 6e28        with open(
-00013810: 6673 656e 6328 6670 292c 2022 7762 222c  fsenc(fp), "wb",
-00013820: 2035 3132 202a 2031 3032 3429 2061 7320   512 * 1024) as 
-00013830: 663a 0a20 2020 2020 2020 2020 2020 2073  f:.            s
-00013840: 7a2c 2073 6861 3531 322c 205f 203d 2068  z, sha512, _ = h
-00013850: 6173 6863 6f70 7928 705f 6461 7461 2c20  ashcopy(p_data, 
-00013860: 662c 2073 656c 662e 6172 6773 2e73 5f77  f, self.args.s_w
-00013870: 725f 736c 7029 0a0a 2020 2020 2020 2020  r_slp)..        
-00013880: 6966 206c 696d 3a0a 2020 2020 2020 2020  if lim:.        
-00013890: 2020 2020 6c69 6d2e 6e75 7028 7365 6c66      lim.nup(self
-000138a0: 2e69 7029 0a20 2020 2020 2020 2020 2020  .ip).           
-000138b0: 206c 696d 2e62 7570 2873 656c 662e 6970   lim.bup(self.ip
-000138c0: 2c20 737a 290a 2020 2020 2020 2020 2020  , sz).          
-000138d0: 2020 7472 793a 0a20 2020 2020 2020 2020    try:.         
-000138e0: 2020 2020 2020 206c 696d 2e63 686b 5f73         lim.chk_s
-000138f0: 7a28 737a 290a 2020 2020 2020 2020 2020  z(sz).          
-00013900: 2020 6578 6365 7074 3a0a 2020 2020 2020    except:.      
-00013910: 2020 2020 2020 2020 2020 626f 732e 756e            bos.un
-00013920: 6c69 6e6b 2866 7029 0a20 2020 2020 2020  link(fp).       
-00013930: 2020 2020 2020 2020 2072 6169 7365 0a0a           raise..
-00013940: 2020 2020 2020 2020 6e65 775f 6c61 7374          new_last
-00013950: 6d6f 6420 3d20 626f 732e 7374 6174 2866  mod = bos.stat(f
-00013960: 7029 2e73 745f 6d74 696d 650a 2020 2020  p).st_mtime.    
-00013970: 2020 2020 6e65 775f 6c61 7374 6d6f 6433      new_lastmod3
-00013980: 203d 2069 6e74 286e 6577 5f6c 6173 746d   = int(new_lastm
-00013990: 6f64 202a 2031 3030 3029 0a20 2020 2020  od * 1000).     
-000139a0: 2020 2073 6861 3531 3220 3d20 7368 6135     sha512 = sha5
-000139b0: 3132 5b3a 3536 5d0a 0a20 2020 2020 2020  12[:56]..       
-000139c0: 2072 6573 706f 6e73 6520 3d20 6a73 6f6e   response = json
-000139d0: 2e64 756d 7073 280a 2020 2020 2020 2020  .dumps(.        
-000139e0: 2020 2020 7b22 6f6b 223a 2054 7275 652c      {"ok": True,
-000139f0: 2022 6c61 7374 6d6f 6422 3a20 6e65 775f   "lastmod": new_
-00013a00: 6c61 7374 6d6f 6433 2c20 2273 697a 6522  lastmod3, "size"
-00013a10: 3a20 737a 2c20 2273 6861 3531 3222 3a20  : sz, "sha512": 
-00013a20: 7368 6135 3132 7d0a 2020 2020 2020 2020  sha512}.        
-00013a30: 290a 2020 2020 2020 2020 7365 6c66 2e6c  ).        self.l
-00013a40: 6f67 2872 6573 706f 6e73 6529 0a20 2020  og(response).   
-00013a50: 2020 2020 2073 656c 662e 7061 7273 6572       self.parser
-00013a60: 2e64 726f 7028 290a 2020 2020 2020 2020  .drop().        
-00013a70: 7365 6c66 2e72 6570 6c79 2872 6573 706f  self.reply(respo
-00013a80: 6e73 652e 656e 636f 6465 2822 7574 662d  nse.encode("utf-
-00013a90: 3822 2929 0a20 2020 2020 2020 2072 6574  8")).        ret
-00013aa0: 7572 6e20 5472 7565 0a0a 2020 2020 6465  urn True..    de
-00013ab0: 6620 5f63 686b 5f6c 6173 746d 6f64 2873  f _chk_lastmod(s
-00013ac0: 656c 662c 2066 696c 655f 7473 2029 2020  elf, file_ts )  
-00013ad0: 203a 0a20 2020 2020 2020 2066 696c 655f   :.        file_
-00013ae0: 6c61 7374 6d6f 6420 3d20 666f 726d 6174  lastmod = format
-00013af0: 6461 7465 2866 696c 655f 7473 2c20 7573  date(file_ts, us
-00013b00: 6567 6d74 3d54 7275 6529 0a20 2020 2020  egmt=True).     
-00013b10: 2020 2063 6c69 5f6c 6173 746d 6f64 203d     cli_lastmod =
-00013b20: 2073 656c 662e 6865 6164 6572 732e 6765   self.headers.ge
-00013b30: 7428 2269 662d 6d6f 6469 6669 6564 2d73  t("if-modified-s
-00013b40: 696e 6365 2229 0a20 2020 2020 2020 2069  ince").        i
-00013b50: 6620 636c 695f 6c61 7374 6d6f 643a 0a20  f cli_lastmod:. 
-00013b60: 2020 2020 2020 2020 2020 2074 7279 3a0a             try:.
-00013b70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013b80: 2320 736f 6d65 2062 726f 7773 6572 2061  # some browser a
-00013b90: 7070 656e 6420 223b 206c 656e 6774 683d  ppend "; length=
-00013ba0: 3537 3322 0a20 2020 2020 2020 2020 2020  573".           
-00013bb0: 2020 2020 2063 6c69 5f6c 6173 746d 6f64       cli_lastmod
-00013bc0: 203d 2063 6c69 5f6c 6173 746d 6f64 2e73   = cli_lastmod.s
-00013bd0: 706c 6974 2822 3b22 295b 305d 2e73 7472  plit(";")[0].str
-00013be0: 6970 2829 0a20 2020 2020 2020 2020 2020  ip().           
-00013bf0: 2020 2020 2063 6c69 5f64 7420 3d20 7061       cli_dt = pa
-00013c00: 7273 6564 6174 6528 636c 695f 6c61 7374  rsedate(cli_last
-00013c10: 6d6f 6429 0a20 2020 2020 2020 2020 2020  mod).           
-00013c20: 2020 2020 2061 7373 6572 7420 636c 695f       assert cli_
-00013c30: 6474 0a20 2020 2020 2020 2020 2020 2020  dt.             
-00013c40: 2020 2063 6c69 5f74 7320 3d20 6361 6c65     cli_ts = cale
-00013c50: 6e64 6172 2e74 696d 6567 6d28 636c 695f  ndar.timegm(cli_
-00013c60: 6474 290a 2020 2020 2020 2020 2020 2020  dt).            
-00013c70: 2020 2020 7265 7475 726e 2066 696c 655f      return file_
-00013c80: 6c61 7374 6d6f 642c 2069 6e74 2866 696c  lastmod, int(fil
-00013c90: 655f 7473 2920 3e20 696e 7428 636c 695f  e_ts) > int(cli_
-00013ca0: 7473 290a 2020 2020 2020 2020 2020 2020  ts).            
-00013cb0: 6578 6365 7074 2045 7863 6570 7469 6f6e  except Exception
-00013cc0: 2061 7320 6578 3a0a 2020 2020 2020 2020   as ex:.        
-00013cd0: 2020 2020 2020 2020 7365 6c66 2e6c 6f67          self.log
-00013ce0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-00013cf0: 2020 2020 2020 226c 6173 746d 6f64 207b        "lastmod {
-00013d00: 7d5c 6e72 656d 6f74 653a 205b 7b7d 5d5c  }\nremote: [{}]\
-00013d10: 6e20 6c6f 6361 6c3a 205b 7b7d 5d22 2e66  n local: [{}]".f
-00013d20: 6f72 6d61 7428 0a20 2020 2020 2020 2020  ormat(.         
-00013d30: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-00013d40: 6570 7228 6578 292c 2063 6c69 5f6c 6173  epr(ex), cli_las
-00013d50: 746d 6f64 2c20 6669 6c65 5f6c 6173 746d  tmod, file_lastm
-00013d60: 6f64 0a20 2020 2020 2020 2020 2020 2020  od.             
-00013d70: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-00013d80: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
-00013d90: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-00013da0: 6e20 6669 6c65 5f6c 6173 746d 6f64 2c20  n file_lastmod, 
-00013db0: 6669 6c65 5f6c 6173 746d 6f64 2021 3d20  file_lastmod != 
-00013dc0: 636c 695f 6c61 7374 6d6f 640a 0a20 2020  cli_lastmod..   
-00013dd0: 2020 2020 2072 6574 7572 6e20 6669 6c65       return file
-00013de0: 5f6c 6173 746d 6f64 2c20 5472 7565 0a0a  _lastmod, True..
-00013df0: 2020 2020 6465 6620 7478 5f66 696c 6528      def tx_file(
-00013e00: 7365 6c66 2c20 7265 715f 7061 7468 2029  self, req_path )
-00013e10: 2020 3a0a 2020 2020 2020 2020 7374 6174    :.        stat
-00013e20: 7573 203d 2032 3030 0a20 2020 2020 2020  us = 200.       
-00013e30: 206c 6f67 6d73 6720 3d20 227b 3a34 7d20   logmsg = "{:4} 
-00013e40: 7b7d 2022 2e66 6f72 6d61 7428 2222 2c20  {} ".format("", 
-00013e50: 7365 6c66 2e72 6571 290a 2020 2020 2020  self.req).      
-00013e60: 2020 6c6f 6774 6169 6c20 3d20 2222 0a0a    logtail = ""..
-00013e70: 2020 2020 2020 2020 230a 2020 2020 2020          #.      
-00013e80: 2020 2320 6966 2072 6571 7565 7374 2069    # if request i
-00013e90: 7320 666f 7220 666f 6f2e 6a73 2c20 6368  s for foo.js, ch
-00013ea0: 6563 6b20 6966 2077 6520 6861 7665 2066  eck if we have f
-00013eb0: 6f6f 2e6a 732e 7b67 7a2c 6272 7d0a 0a20  oo.js.{gz,br}.. 
-00013ec0: 2020 2020 2020 2066 696c 655f 7473 203d         file_ts =
-00013ed0: 2030 0a20 2020 2020 2020 2065 6469 7469   0.        editi
-00013ee0: 6f6e 7320 2020 203d 207b 7d0a 2020 2020  ons    = {}.    
-00013ef0: 2020 2020 666f 7220 6578 7420 696e 205b      for ext in [
-00013f00: 2222 2c20 222e 677a 222c 2022 2e62 7222  "", ".gz", ".br"
-00013f10: 5d3a 0a20 2020 2020 2020 2020 2020 2074  ]:.            t
-00013f20: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
-00013f30: 2020 2020 6673 5f70 6174 6820 3d20 7265      fs_path = re
-00013f40: 715f 7061 7468 202b 2065 7874 0a20 2020  q_path + ext.   
-00013f50: 2020 2020 2020 2020 2020 2020 2073 7420               st 
-00013f60: 3d20 626f 732e 7374 6174 2866 735f 7061  = bos.stat(fs_pa
-00013f70: 7468 290a 2020 2020 2020 2020 2020 2020  th).            
-00013f80: 2020 2020 6966 2073 7461 742e 535f 4953      if stat.S_IS
-00013f90: 4449 5228 7374 2e73 745f 6d6f 6465 293a  DIR(st.st_mode):
-00013fa0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00013fb0: 2020 2020 2063 6f6e 7469 6e75 650a 0a20       continue.. 
-00013fc0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00013fd0: 6620 7374 6174 2e53 5f49 5342 4c4b 2873  f stat.S_ISBLK(s
-00013fe0: 742e 7374 5f6d 6f64 6529 3a0a 2020 2020  t.st_mode):.    
-00013ff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014000: 6664 203d 2062 6f73 2e6f 7065 6e28 6673  fd = bos.open(fs
-00014010: 5f70 6174 682c 206f 732e 4f5f 5244 4f4e  _path, os.O_RDON
-00014020: 4c59 290a 2020 2020 2020 2020 2020 2020  LY).            
-00014030: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
-00014040: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014050: 2020 2020 2073 7a20 3d20 6f73 2e6c 7365       sz = os.lse
-00014060: 656b 2866 642c 2030 2c20 6f73 2e53 4545  ek(fd, 0, os.SEE
-00014070: 4b5f 454e 4429 0a20 2020 2020 2020 2020  K_END).         
-00014080: 2020 2020 2020 2020 2020 2066 696e 616c             final
-00014090: 6c79 3a0a 2020 2020 2020 2020 2020 2020  ly:.            
-000140a0: 2020 2020 2020 2020 2020 2020 6f73 2e63              os.c
-000140b0: 6c6f 7365 2866 6429 0a20 2020 2020 2020  lose(fd).       
-000140c0: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
-000140d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000140e0: 2020 2073 7a20 3d20 7374 2e73 745f 7369     sz = st.st_si
-000140f0: 7a65 0a0a 2020 2020 2020 2020 2020 2020  ze..            
-00014100: 2020 2020 6669 6c65 5f74 7320 3d20 6d61      file_ts = ma
-00014110: 7828 6669 6c65 5f74 732c 2069 6e74 2873  x(file_ts, int(s
-00014120: 742e 7374 5f6d 7469 6d65 2929 0a20 2020  t.st_mtime)).   
-00014130: 2020 2020 2020 2020 2020 2020 2065 6469               edi
-00014140: 7469 6f6e 735b 6578 7420 6f72 2022 706c  tions[ext or "pl
-00014150: 6169 6e22 5d20 3d20 2866 735f 7061 7468  ain"] = (fs_path
-00014160: 2c20 737a 290a 2020 2020 2020 2020 2020  , sz).          
-00014170: 2020 6578 6365 7074 3a0a 2020 2020 2020    except:.      
-00014180: 2020 2020 2020 2020 2020 7061 7373 0a20            pass. 
-00014190: 2020 2020 2020 2020 2020 2069 6620 6e6f             if no
-000141a0: 7420 7365 6c66 2e76 7061 7468 2e73 7461  t self.vpath.sta
-000141b0: 7274 7377 6974 6828 222e 6370 722f 2229  rtswith(".cpr/")
-000141c0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-000141d0: 2020 6272 6561 6b0a 0a20 2020 2020 2020    break..       
-000141e0: 2069 6620 6e6f 7420 6564 6974 696f 6e73   if not editions
-000141f0: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
-00014200: 7475 726e 2073 656c 662e 7478 5f34 3034  turn self.tx_404
-00014210: 2829 0a0a 2020 2020 2020 2020 230a 2020  ()..        #.  
-00014220: 2020 2020 2020 2320 6966 2d6d 6f64 6966        # if-modif
-00014230: 6965 640a 0a20 2020 2020 2020 2066 696c  ied..        fil
-00014240: 655f 6c61 7374 6d6f 642c 2064 6f5f 7365  e_lastmod, do_se
-00014250: 6e64 203d 2073 656c 662e 5f63 686b 5f6c  nd = self._chk_l
-00014260: 6173 746d 6f64 2866 696c 655f 7473 290a  astmod(file_ts).
-00014270: 2020 2020 2020 2020 7365 6c66 2e6f 7574          self.out
-00014280: 5f68 6561 6465 7273 5b22 4c61 7374 2d4d  _headers["Last-M
-00014290: 6f64 6966 6965 6422 5d20 3d20 6669 6c65  odified"] = file
-000142a0: 5f6c 6173 746d 6f64 0a20 2020 2020 2020  _lastmod.       
-000142b0: 2069 6620 6e6f 7420 646f 5f73 656e 643a   if not do_send:
-000142c0: 0a20 2020 2020 2020 2020 2020 2073 7461  .            sta
-000142d0: 7475 7320 3d20 3330 340a 0a20 2020 2020  tus = 304..     
-000142e0: 2020 2023 0a20 2020 2020 2020 2023 2041     #.        # A
-000142f0: 6363 6570 742d 456e 636f 6469 6e67 2061  ccept-Encoding a
-00014300: 6e64 2055 4120 6465 6369 6465 7320 7768  nd UA decides wh
-00014310: 6963 6820 6564 6974 696f 6e20 746f 2073  ich edition to s
-00014320: 656e 640a 0a20 2020 2020 2020 2064 6563  end..        dec
-00014330: 6f6d 7072 6573 7320 3d20 4661 6c73 650a  ompress = False.
-00014340: 2020 2020 2020 2020 7375 7070 6f72 7465          supporte
-00014350: 645f 6564 6974 696f 6e73 203d 205b 0a20  d_editions = [. 
-00014360: 2020 2020 2020 2020 2020 2078 2e73 7472             x.str
-00014370: 6970 2829 0a20 2020 2020 2020 2020 2020  ip().           
-00014380: 2066 6f72 2078 2069 6e20 7365 6c66 2e68   for x in self.h
-00014390: 6561 6465 7273 2e67 6574 2822 6163 6365  eaders.get("acce
-000143a0: 7074 2d65 6e63 6f64 696e 6722 2c20 2222  pt-encoding", ""
-000143b0: 292e 6c6f 7765 7228 292e 7370 6c69 7428  ).lower().split(
-000143c0: 222c 2229 0a20 2020 2020 2020 205d 0a20  ",").        ]. 
-000143d0: 2020 2020 2020 2069 6620 222e 6272 2220         if ".br" 
-000143e0: 696e 2065 6469 7469 6f6e 7320 616e 6420  in editions and 
-000143f0: 2262 7222 2069 6e20 7375 7070 6f72 7465  "br" in supporte
-00014400: 645f 6564 6974 696f 6e73 3a0a 2020 2020  d_editions:.    
-00014410: 2020 2020 2020 2020 6973 5f63 6f6d 7072          is_compr
-00014420: 6573 7365 6420 3d20 5472 7565 0a20 2020  essed = True.   
-00014430: 2020 2020 2020 2020 2073 656c 6563 7465           selecte
-00014440: 645f 6564 6974 696f 6e20 3d20 222e 6272  d_edition = ".br
-00014450: 220a 2020 2020 2020 2020 2020 2020 6673  ".            fs
-00014460: 5f70 6174 682c 2066 696c 655f 737a 203d  _path, file_sz =
-00014470: 2065 6469 7469 6f6e 735b 222e 6272 225d   editions[".br"]
-00014480: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-00014490: 662e 6f75 745f 6865 6164 6572 735b 2243  f.out_headers["C
-000144a0: 6f6e 7465 6e74 2d45 6e63 6f64 696e 6722  ontent-Encoding"
-000144b0: 5d20 3d20 2262 7222 0a20 2020 2020 2020  ] = "br".       
-000144c0: 2065 6c69 6620 222e 677a 2220 696e 2065   elif ".gz" in e
-000144d0: 6469 7469 6f6e 733a 0a20 2020 2020 2020  ditions:.       
-000144e0: 2020 2020 2069 735f 636f 6d70 7265 7373       is_compress
-000144f0: 6564 203d 2054 7275 650a 2020 2020 2020  ed = True.      
-00014500: 2020 2020 2020 7365 6c65 6374 6564 5f65        selected_e
-00014510: 6469 7469 6f6e 203d 2022 2e67 7a22 0a20  dition = ".gz". 
-00014520: 2020 2020 2020 2020 2020 2066 735f 7061             fs_pa
-00014530: 7468 2c20 6669 6c65 5f73 7a20 3d20 6564  th, file_sz = ed
-00014540: 6974 696f 6e73 5b22 2e67 7a22 5d0a 2020  itions[".gz"].  
-00014550: 2020 2020 2020 2020 2020 6966 2022 677a            if "gz
-00014560: 6970 2220 6e6f 7420 696e 2073 7570 706f  ip" not in suppo
-00014570: 7274 6564 5f65 6469 7469 6f6e 733a 0a20  rted_editions:. 
-00014580: 2020 2020 2020 2020 2020 2020 2020 2064                 d
-00014590: 6563 6f6d 7072 6573 7320 3d20 5472 7565  ecompress = True
-000145a0: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
-000145b0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-000145c0: 2020 2069 6620 7265 2e6d 6174 6368 2872     if re.match(r
-000145d0: 224d 5349 4520 5b34 2d36 5d5c 2e22 2c20  "MSIE [4-6]\.", 
-000145e0: 7365 6c66 2e75 6129 2061 6e64 2022 2053  self.ua) and " S
-000145f0: 5631 2220 6e6f 7420 696e 2073 656c 662e  V1" not in self.
-00014600: 7561 3a0a 2020 2020 2020 2020 2020 2020  ua:.            
-00014610: 2020 2020 2020 2020 6465 636f 6d70 7265          decompre
-00014620: 7373 203d 2054 7275 650a 0a20 2020 2020  ss = True..     
-00014630: 2020 2020 2020 2069 6620 6e6f 7420 6465         if not de
-00014640: 636f 6d70 7265 7373 3a0a 2020 2020 2020  compress:.      
-00014650: 2020 2020 2020 2020 2020 7365 6c66 2e6f            self.o
-00014660: 7574 5f68 6561 6465 7273 5b22 436f 6e74  ut_headers["Cont
-00014670: 656e 742d 456e 636f 6469 6e67 225d 203d  ent-Encoding"] =
-00014680: 2022 677a 6970 220a 2020 2020 2020 2020   "gzip".        
-00014690: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-000146a0: 2020 6973 5f63 6f6d 7072 6573 7365 6420    is_compressed 
-000146b0: 3d20 4661 6c73 650a 2020 2020 2020 2020  = False.        
-000146c0: 2020 2020 7365 6c65 6374 6564 5f65 6469      selected_edi
-000146d0: 7469 6f6e 203d 2022 706c 6169 6e22 0a0a  tion = "plain"..
-000146e0: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
-000146f0: 2020 2020 2020 2020 2066 735f 7061 7468           fs_path
-00014700: 2c20 6669 6c65 5f73 7a20 3d20 6564 6974  , file_sz = edit
-00014710: 696f 6e73 5b73 656c 6563 7465 645f 6564  ions[selected_ed
-00014720: 6974 696f 6e5d 0a20 2020 2020 2020 2020  ition].         
-00014730: 2020 206c 6f67 6d73 6720 2b3d 2022 7b7d     logmsg += "{}
-00014740: 2022 2e66 6f72 6d61 7428 7365 6c65 6374   ".format(select
-00014750: 6564 5f65 6469 7469 6f6e 2e6c 7374 7269  ed_edition.lstri
-00014760: 7028 222e 2229 290a 2020 2020 2020 2020  p(".")).        
-00014770: 6578 6365 7074 3a0a 2020 2020 2020 2020  except:.        
-00014780: 2020 2020 2320 636c 6965 6e74 2069 7320      # client is 
-00014790: 6f6c 6420 616e 6420 7765 206f 6e6c 7920  old and we only 
-000147a0: 6861 7665 202e 6272 0a20 2020 2020 2020  have .br.       
-000147b0: 2020 2020 2023 2028 636f 756c 6420 6d61       # (could ma
-000147c0: 6b65 2062 726f 746c 6920 6120 6465 7020  ke brotli a dep 
-000147d0: 746f 2066 6978 2074 6869 7320 6275 7420  to fix this but 
-000147e0: 6974 2773 206e 6f74 2077 6f72 7468 290a  it's not worth).
-000147f0: 2020 2020 2020 2020 2020 2020 7261 6973              rais
-00014800: 6520 5065 626b 6163 2834 3034 290a 0a20  e Pebkac(404).. 
-00014810: 2020 2020 2020 2023 0a20 2020 2020 2020         #.       
-00014820: 2023 2070 6172 7469 616c 0a0a 2020 2020   # partial..    
-00014830: 2020 2020 6c6f 7765 7220 3d20 300a 2020      lower = 0.  
-00014840: 2020 2020 2020 7570 7065 7220 3d20 6669        upper = fi
-00014850: 6c65 5f73 7a0a 2020 2020 2020 2020 6872  le_sz.        hr
-00014860: 616e 6765 203d 2073 656c 662e 6865 6164  ange = self.head
-00014870: 6572 732e 6765 7428 2272 616e 6765 2229  ers.get("range")
-00014880: 0a0a 2020 2020 2020 2020 2320 6c65 7427  ..        # let'
-00014890: 7320 6e6f 7420 7375 7070 6f72 7420 3230  s not support 20
-000148a0: 3620 7769 7468 2063 6f6d 7072 6573 7369  6 with compressi
-000148b0: 6f6e 0a20 2020 2020 2020 2023 2061 6e64  on.        # and
-000148c0: 206d 756c 7469 7261 6e67 6520 2f20 6d75   multirange / mu
-000148d0: 6c74 6970 6172 7420 6973 2061 6c73 6f20  ltipart is also 
-000148e0: 6e6f 742d 696d 706c 2028 6d6f 7374 6c79  not-impl (mostly
-000148f0: 2062 6563 6175 7365 2063 616c 6375 6c61   because calcula
-00014900: 7469 6e67 2063 6f6e 7465 6e74 6c65 6e67  ting contentleng
-00014910: 7468 2069 7320 6120 7061 696e 290a 2020  th is a pain).  
-00014920: 2020 2020 2020 6966 2064 6f5f 7365 6e64        if do_send
-00014930: 2061 6e64 206e 6f74 2069 735f 636f 6d70   and not is_comp
-00014940: 7265 7373 6564 2061 6e64 2068 7261 6e67  ressed and hrang
-00014950: 6520 616e 6420 6669 6c65 5f73 7a20 616e  e and file_sz an
-00014960: 6420 222c 2220 6e6f 7420 696e 2068 7261  d "," not in hra
-00014970: 6e67 653a 0a20 2020 2020 2020 2020 2020  nge:.           
-00014980: 2074 7279 3a0a 2020 2020 2020 2020 2020   try:.          
-00014990: 2020 2020 2020 6966 206e 6f74 2068 7261        if not hra
-000149a0: 6e67 652e 6c6f 7765 7228 292e 7374 6172  nge.lower().star
-000149b0: 7473 7769 7468 2822 6279 7465 7322 293a  tswith("bytes"):
-000149c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000149d0: 2020 2020 2072 6169 7365 2045 7863 6570       raise Excep
-000149e0: 7469 6f6e 2829 0a0a 2020 2020 2020 2020  tion()..        
-000149f0: 2020 2020 2020 2020 612c 2062 203d 2068          a, b = h
-00014a00: 7261 6e67 652e 7370 6c69 7428 223d 222c  range.split("=",
-00014a10: 2031 295b 315d 2e73 706c 6974 2822 2d22   1)[1].split("-"
-00014a20: 290a 0a20 2020 2020 2020 2020 2020 2020  )..             
-00014a30: 2020 2069 6620 612e 7374 7269 7028 293a     if a.strip():
-00014a40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00014a50: 2020 2020 206c 6f77 6572 203d 2069 6e74       lower = int
-00014a60: 2861 2e73 7472 6970 2829 290a 2020 2020  (a.strip()).    
-00014a70: 2020 2020 2020 2020 2020 2020 656c 7365              else
-00014a80: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00014a90: 2020 2020 2020 6c6f 7765 7220 3d20 300a        lower = 0.
-00014aa0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00014ab0: 2069 6620 622e 7374 7269 7028 293a 0a20   if b.strip():. 
-00014ac0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014ad0: 2020 2075 7070 6572 203d 2069 6e74 2862     upper = int(b
-00014ae0: 2e73 7472 6970 2829 2920 2b20 310a 2020  .strip()) + 1.  
-00014af0: 2020 2020 2020 2020 2020 2020 2020 656c                el
-00014b00: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-00014b10: 2020 2020 2020 2020 7570 7065 7220 3d20          upper = 
-00014b20: 6669 6c65 5f73 7a0a 0a20 2020 2020 2020  file_sz..       
-00014b30: 2020 2020 2020 2020 2069 6620 7570 7065           if uppe
-00014b40: 7220 3e20 6669 6c65 5f73 7a3a 0a20 2020  r > file_sz:.   
-00014b50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014b60: 2075 7070 6572 203d 2066 696c 655f 737a   upper = file_sz
-00014b70: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00014b80: 2020 6966 206c 6f77 6572 203c 2030 206f    if lower < 0 o
-00014b90: 7220 6c6f 7765 7220 3e3d 2075 7070 6572  r lower >= upper
-00014ba0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00014bb0: 2020 2020 2020 7261 6973 6520 4578 6365        raise Exce
-00014bc0: 7074 696f 6e28 290a 0a20 2020 2020 2020  ption()..       
-00014bd0: 2020 2020 2065 7863 6570 743a 0a20 2020       except:.   
-00014be0: 2020 2020 2020 2020 2020 2020 2065 7272               err
-00014bf0: 203d 2022 696e 7661 6c69 6420 7261 6e67   = "invalid rang
-00014c00: 6520 287b 7d29 2c20 7369 7a65 3d7b 7d22  e ({}), size={}"
-00014c10: 2e66 6f72 6d61 7428 6872 616e 6765 2c20  .format(hrange, 
-00014c20: 6669 6c65 5f73 7a29 0a20 2020 2020 2020  file_sz).       
-00014c30: 2020 2020 2020 2020 2073 656c 662e 6c6f           self.lo
-00014c40: 7564 5f72 6570 6c79 280a 2020 2020 2020  ud_reply(.      
-00014c50: 2020 2020 2020 2020 2020 2020 2020 6572                er
-00014c60: 722c 0a20 2020 2020 2020 2020 2020 2020  r,.             
-00014c70: 2020 2020 2020 2073 7461 7475 733d 3431         status=41
-00014c80: 362c 0a20 2020 2020 2020 2020 2020 2020  6,.             
-00014c90: 2020 2020 2020 2068 6561 6465 7273 3d7b         headers={
-00014ca0: 2243 6f6e 7465 6e74 2d52 616e 6765 223a  "Content-Range":
-00014cb0: 2022 6279 7465 7320 2a2f 7b7d 222e 666f   "bytes */{}".fo
-00014cc0: 726d 6174 2866 696c 655f 737a 297d 2c0a  rmat(file_sz)},.
-00014cd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014ce0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00014cf0: 2020 7265 7475 726e 2054 7275 650a 0a20    return True.. 
-00014d00: 2020 2020 2020 2020 2020 2073 7461 7475             statu
-00014d10: 7320 3d20 3230 360a 2020 2020 2020 2020  s = 206.        
-00014d20: 2020 2020 7365 6c66 2e6f 7574 5f68 6561      self.out_hea
-00014d30: 6465 7273 5b22 436f 6e74 656e 742d 5261  ders["Content-Ra
-00014d40: 6e67 6522 5d20 3d20 2262 7974 6573 207b  nge"] = "bytes {
-00014d50: 7d2d 7b7d 2f7b 7d22 2e66 6f72 6d61 7428  }-{}/{}".format(
-00014d60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00014d70: 206c 6f77 6572 2c20 7570 7065 7220 2d20   lower, upper - 
-00014d80: 312c 2066 696c 655f 737a 0a20 2020 2020  1, file_sz.     
-00014d90: 2020 2020 2020 2029 0a0a 2020 2020 2020         )..      
-00014da0: 2020 2020 2020 6c6f 6774 6169 6c20 2b3d        logtail +=
-00014db0: 2022 205b 5c30 3333 5b33 366d 7b7d 2d7b   " [\033[36m{}-{
-00014dc0: 7d5c 3033 335b 306d 5d22 2e66 6f72 6d61  }\033[0m]".forma
-00014dd0: 7428 6c6f 7765 722c 2075 7070 6572 290a  t(lower, upper).
-00014de0: 0a20 2020 2020 2020 2075 7365 5f73 656e  .        use_sen
-00014df0: 6466 696c 6520 3d20 4661 6c73 650a 2020  dfile = False.  
-00014e00: 2020 2020 2020 6966 2064 6563 6f6d 7072        if decompr
-00014e10: 6573 733a 0a20 2020 2020 2020 2020 2020  ess:.           
-00014e20: 206f 7065 6e5f 6675 6e63 2020 3d20 677a   open_func  = gz
-00014e30: 6970 2e6f 7065 6e0a 2020 2020 2020 2020  ip.open.        
-00014e40: 2020 2020 6f70 656e 5f61 7267 7320 203d      open_args  =
-00014e50: 205b 6673 656e 6328 6673 5f70 6174 6829   [fsenc(fs_path)
-00014e60: 2c20 2272 6222 5d0a 2020 2020 2020 2020  , "rb"].        
-00014e70: 2020 2020 2320 436f 6e74 656e 742d 4c65      # Content-Le
-00014e80: 6e67 7468 203a 3d20 6f72 6967 696e 616c  ngth := original
-00014e90: 2066 696c 6520 7369 7a65 0a20 2020 2020   file size.     
-00014ea0: 2020 2020 2020 2075 7070 6572 203d 2067         upper = g
-00014eb0: 7a69 705f 6f72 6967 5f73 7a28 6673 5f70  zip_orig_sz(fs_p
-00014ec0: 6174 6829 0a20 2020 2020 2020 2065 6c73  ath).        els
-00014ed0: 653a 0a20 2020 2020 2020 2020 2020 206f  e:.            o
-00014ee0: 7065 6e5f 6675 6e63 203d 206f 7065 6e0a  pen_func = open.
-00014ef0: 2020 2020 2020 2020 2020 2020 2320 3531              # 51
-00014f00: 3220 6b42 2069 7320 6f70 7469 6d61 6c20  2 kB is optimal 
-00014f10: 666f 7220 6875 6765 2066 696c 6573 2c20  for huge files, 
-00014f20: 7573 6520 3634 6b0a 2020 2020 2020 2020  use 64k.        
-00014f30: 2020 2020 6f70 656e 5f61 7267 7320 3d20      open_args = 
-00014f40: 5b66 7365 6e63 2866 735f 7061 7468 292c  [fsenc(fs_path),
-00014f50: 2022 7262 222c 2036 3420 2a20 3130 3234   "rb", 64 * 1024
-00014f60: 5d0a 2020 2020 2020 2020 2020 2020 7573  ].            us
-00014f70: 655f 7365 6e64 6669 6c65 203d 2028 0a20  e_sendfile = (. 
-00014f80: 2020 2020 2020 2020 2020 2020 2020 206e                 n
-00014f90: 6f74 2073 656c 662e 746c 7320 2023 0a20  ot self.tls  #. 
-00014fa0: 2020 2020 2020 2020 2020 2020 2020 2061                 a
-00014fb0: 6e64 206e 6f74 2073 656c 662e 6172 6773  nd not self.args
-00014fc0: 2e6e 6f5f 7365 6e64 6669 6c65 0a20 2020  .no_sendfile.   
-00014fd0: 2020 2020 2020 2020 2020 2020 2061 6e64               and
-00014fe0: 2068 6173 6174 7472 286f 732c 2022 7365   hasattr(os, "se
-00014ff0: 6e64 6669 6c65 2229 0a20 2020 2020 2020  ndfile").       
-00015000: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
-00015010: 230a 2020 2020 2020 2020 2320 7365 6e64  #.        # send
-00015020: 2072 6570 6c79 0a0a 2020 2020 2020 2020   reply..        
-00015030: 6966 2069 735f 636f 6d70 7265 7373 6564  if is_compressed
-00015040: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
-00015050: 6c66 2e6f 7574 5f68 6561 6465 7273 5b22  lf.out_headers["
-00015060: 4361 6368 652d 436f 6e74 726f 6c22 5d20  Cache-Control"] 
-00015070: 3d20 226d 6178 2d61 6765 3d36 3034 3836  = "max-age=60486
-00015080: 3922 0a20 2020 2020 2020 2065 6c73 653a  9".        else:
-00015090: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-000150a0: 662e 7065 726d 6974 5f63 6163 6869 6e67  f.permit_caching
-000150b0: 2829 0a0a 2020 2020 2020 2020 6966 2022  ()..        if "
-000150c0: 7478 7422 2069 6e20 7365 6c66 2e75 7061  txt" in self.upa
-000150d0: 7261 6d3a 0a20 2020 2020 2020 2020 2020  ram:.           
-000150e0: 206d 696d 6520 3d20 2274 6578 742f 706c   mime = "text/pl
-000150f0: 6169 6e3b 2063 6861 7273 6574 3d7b 7d22  ain; charset={}"
-00015100: 2e66 6f72 6d61 7428 7365 6c66 2e75 7061  .format(self.upa
-00015110: 7261 6d5b 2274 7874 225d 206f 7220 2275  ram["txt"] or "u
-00015120: 7466 2d38 2229 0a20 2020 2020 2020 2065  tf-8").        e
-00015130: 6c69 6620 226d 696d 6522 2069 6e20 7365  lif "mime" in se
-00015140: 6c66 2e75 7061 7261 6d3a 0a20 2020 2020  lf.uparam:.     
-00015150: 2020 2020 2020 206d 696d 6520 3d20 7374         mime = st
-00015160: 7228 7365 6c66 2e75 7061 7261 6d2e 6765  r(self.uparam.ge
-00015170: 7428 226d 696d 6522 2929 0a20 2020 2020  t("mime")).     
-00015180: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-00015190: 2020 2020 206d 696d 6520 3d20 6775 6573       mime = gues
-000151a0: 735f 6d69 6d65 2872 6571 5f70 6174 6829  s_mime(req_path)
-000151b0: 0a0a 2020 2020 2020 2020 7365 6c66 2e6f  ..        self.o
-000151c0: 7574 5f68 6561 6465 7273 5b22 4163 6365  ut_headers["Acce
-000151d0: 7074 2d52 616e 6765 7322 5d20 3d20 2262  pt-Ranges"] = "b
-000151e0: 7974 6573 220a 2020 2020 2020 2020 7365  ytes".        se
-000151f0: 6c66 2e73 656e 645f 6865 6164 6572 7328  lf.send_headers(
-00015200: 6c65 6e67 7468 3d75 7070 6572 202d 206c  length=upper - l
-00015210: 6f77 6572 2c20 7374 6174 7573 3d73 7461  ower, status=sta
-00015220: 7475 732c 206d 696d 653d 6d69 6d65 290a  tus, mime=mime).
-00015230: 0a20 2020 2020 2020 206c 6f67 6d73 6720  .        logmsg 
-00015240: 2b3d 2075 6e69 636f 6465 2873 7461 7475  += unicode(statu
-00015250: 7329 202b 206c 6f67 7461 696c 0a0a 2020  s) + logtail..  
-00015260: 2020 2020 2020 6966 2073 656c 662e 6d6f        if self.mo
-00015270: 6465 203d 3d20 2248 4541 4422 206f 7220  de == "HEAD" or 
-00015280: 6e6f 7420 646f 5f73 656e 643a 0a20 2020  not do_send:.   
-00015290: 2020 2020 2020 2020 2069 6620 7365 6c66           if self
-000152a0: 2e64 6f5f 6c6f 673a 0a20 2020 2020 2020  .do_log:.       
-000152b0: 2020 2020 2020 2020 2073 656c 662e 6c6f           self.lo
-000152c0: 6728 6c6f 676d 7367 290a 0a20 2020 2020  g(logmsg)..     
-000152d0: 2020 2020 2020 2072 6574 7572 6e20 5472         return Tr
-000152e0: 7565 0a0a 2020 2020 2020 2020 7265 7420  ue..        ret 
-000152f0: 3d20 5472 7565 0a20 2020 2020 2020 2077  = True.        w
-00015300: 6974 6820 6f70 656e 5f66 756e 6328 2a6f  ith open_func(*o
-00015310: 7065 6e5f 6172 6773 2920 6173 2066 3a0a  pen_args) as f:.
-00015320: 2020 2020 2020 2020 2020 2020 7365 6e64              send
-00015330: 6675 6e20 3d20 7365 6e64 6669 6c65 5f6b  fun = sendfile_k
-00015340: 6572 6e20 6966 2075 7365 5f73 656e 6466  ern if use_sendf
-00015350: 696c 6520 656c 7365 2073 656e 6466 696c  ile else sendfil
-00015360: 655f 7079 0a20 2020 2020 2020 2020 2020  e_py.           
-00015370: 2072 656d 6169 6e73 203d 2073 656e 6466   remains = sendf
-00015380: 756e 280a 2020 2020 2020 2020 2020 2020  un(.            
-00015390: 2020 2020 7365 6c66 2e6c 6f67 2c20 6c6f      self.log, lo
-000153a0: 7765 722c 2075 7070 6572 2c20 662c 2073  wer, upper, f, s
-000153b0: 656c 662e 732c 2073 656c 662e 6172 6773  elf.s, self.args
-000153c0: 2e73 5f77 725f 737a 2c20 7365 6c66 2e61  .s_wr_sz, self.a
-000153d0: 7267 732e 735f 7772 5f73 6c70 0a20 2020  rgs.s_wr_slp.   
-000153e0: 2020 2020 2020 2020 2029 0a0a 2020 2020           )..    
-000153f0: 2020 2020 6966 2072 656d 6169 6e73 203e      if remains >
-00015400: 2030 3a0a 2020 2020 2020 2020 2020 2020   0:.            
-00015410: 6c6f 676d 7367 202b 3d20 2220 5c30 3333  logmsg += " \033
-00015420: 5b33 316d 2220 2b20 756e 6963 6f64 6528  [31m" + unicode(
-00015430: 7570 7065 7220 2d20 7265 6d61 696e 7329  upper - remains)
-00015440: 202b 2022 5c30 3333 5b30 6d22 0a20 2020   + "\033[0m".   
-00015450: 2020 2020 2020 2020 2073 656c 662e 6b65           self.ke
-00015460: 6570 616c 6976 6520 3d20 4661 6c73 650a  epalive = False.
-00015470: 0a20 2020 2020 2020 2073 7064 203d 2073  .        spd = s
-00015480: 656c 662e 5f73 7064 2828 7570 7065 7220  elf._spd((upper 
-00015490: 2d20 6c6f 7765 7229 202d 2072 656d 6169  - lower) - remai
-000154a0: 6e73 290a 2020 2020 2020 2020 6966 2073  ns).        if s
-000154b0: 656c 662e 646f 5f6c 6f67 3a0a 2020 2020  elf.do_log:.    
-000154c0: 2020 2020 2020 2020 7365 6c66 2e6c 6f67          self.log
-000154d0: 2822 7b7d 2c20 207b 7d22 2e66 6f72 6d61  ("{},  {}".forma
-000154e0: 7428 6c6f 676d 7367 2c20 7370 6429 290a  t(logmsg, spd)).
-000154f0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-00015500: 7265 740a 0a20 2020 2064 6566 2074 785f  ret..    def tx_
-00015510: 7a69 7028 0a20 2020 2020 2020 2073 656c  zip(.        sel
-00015520: 662c 0a20 2020 2020 2020 2066 6d74 202c  f,.        fmt ,
-00015530: 0a20 2020 2020 2020 2075 6172 6720 2c0a  .        uarg ,.
-00015540: 2020 2020 2020 2020 7670 6174 6820 2c0a          vpath ,.
-00015550: 2020 2020 2020 2020 766e 202c 0a20 2020          vn ,.   
-00015560: 2020 2020 2072 656d 202c 0a20 2020 2020       rem ,.     
-00015570: 2020 2069 7465 6d73 202c 0a20 2020 2020     items ,.     
-00015580: 2020 2064 6f74 7320 2c0a 2020 2020 2920     dots ,.    ) 
-00015590: 203a 0a20 2020 2020 2020 2069 6620 7365   :.        if se
-000155a0: 6c66 2e61 7267 732e 6e6f 5f7a 6970 3a0a  lf.args.no_zip:.
-000155b0: 2020 2020 2020 2020 2020 2020 7261 6973              rais
-000155c0: 6520 5065 626b 6163 2834 3030 2c20 226e  e Pebkac(400, "n
-000155d0: 6f74 2065 6e61 626c 6564 2229 0a0a 2020  ot enabled")..  
-000155e0: 2020 2020 2020 6c6f 676d 7367 203d 2022        logmsg = "
-000155f0: 7b3a 347d 207b 7d20 222e 666f 726d 6174  {:4} {} ".format
-00015600: 2822 222c 2073 656c 662e 7265 7129 0a20  ("", self.req). 
-00015610: 2020 2020 2020 2073 656c 662e 6b65 6570         self.keep
-00015620: 616c 6976 6520 3d20 4661 6c73 650a 0a20  alive = False.. 
-00015630: 2020 2020 2020 2069 6620 666d 7420 3d3d         if fmt ==
-00015640: 2022 7461 7222 3a0a 2020 2020 2020 2020   "tar":.        
-00015650: 2020 2020 6d69 6d65 203d 2022 6170 706c      mime = "appl
-00015660: 6963 6174 696f 6e2f 782d 7461 7222 0a20  ication/x-tar". 
-00015670: 2020 2020 2020 2020 2020 2070 6163 6b65             packe
-00015680: 7220 203d 2053 7472 6561 6d54 6172 0a20  r  = StreamTar. 
-00015690: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-000156a0: 2020 2020 2020 2020 206d 696d 6520 3d20           mime = 
-000156b0: 2261 7070 6c69 6361 7469 6f6e 2f7a 6970  "application/zip
-000156c0: 220a 2020 2020 2020 2020 2020 2020 7061  ".            pa
-000156d0: 636b 6572 203d 2053 7472 6561 6d5a 6970  cker = StreamZip
-000156e0: 0a0a 2020 2020 2020 2020 666e 203d 2069  ..        fn = i
-000156f0: 7465 6d73 5b30 5d20 6966 2069 7465 6d73  tems[0] if items
-00015700: 2061 6e64 2069 7465 6d73 5b30 5d20 656c   and items[0] el
-00015710: 7365 2073 656c 662e 7670 6174 680a 2020  se self.vpath.  
-00015720: 2020 2020 2020 6966 2066 6e3a 0a20 2020        if fn:.   
-00015730: 2020 2020 2020 2020 2066 6e20 3d20 666e           fn = fn
-00015740: 2e72 7374 7269 7028 222f 2229 2e73 706c  .rstrip("/").spl
-00015750: 6974 2822 2f22 295b 2d31 5d0a 2020 2020  it("/")[-1].    
-00015760: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-00015770: 2020 2020 2020 666e 203d 2073 656c 662e        fn = self.
-00015780: 686f 7374 2e73 706c 6974 2822 3a22 295b  host.split(":")[
-00015790: 305d 0a0a 2020 2020 2020 2020 7361 6665  0]..        safe
-000157a0: 203d 2028 7374 7269 6e67 2e61 7363 6969   = (string.ascii
-000157b0: 5f6c 6574 7465 7273 202b 2073 7472 696e  _letters + strin
-000157c0: 672e 6469 6769 7473 292e 7265 706c 6163  g.digits).replac
-000157d0: 6528 2225 222c 2022 2229 0a20 2020 2020  e("%", "").     
-000157e0: 2020 2061 666e 203d 2022 222e 6a6f 696e     afn = "".join
-000157f0: 285b 7820 6966 2078 2069 6e20 7361 6665  ([x if x in safe
-00015800: 2e72 6570 6c61 6365 2827 2227 2c20 2222  .replace('"', ""
-00015810: 2920 656c 7365 2022 5f22 2066 6f72 2078  ) else "_" for x
-00015820: 2069 6e20 666e 5d29 0a20 2020 2020 2020   in fn]).       
-00015830: 2062 6173 6369 6920 3d20 756e 6963 6f64   bascii = unicod
-00015840: 6528 7361 6665 292e 656e 636f 6465 2822  e(safe).encode("
-00015850: 7574 662d 3822 290a 2020 2020 2020 2020  utf-8").        
-00015860: 7a62 203d 2066 6e2e 656e 636f 6465 2822  zb = fn.encode("
-00015870: 7574 662d 3822 2c20 2278 6d6c 6368 6172  utf-8", "xmlchar
-00015880: 7265 6672 6570 6c61 6365 2229 0a20 2020  refreplace").   
-00015890: 2020 2020 2069 6620 6e6f 7420 5059 323a       if not PY2:
-000158a0: 0a20 2020 2020 2020 2020 2020 207a 626c  .            zbl
-000158b0: 203d 205b 0a20 2020 2020 2020 2020 2020   = [.           
-000158c0: 2020 2020 2063 6872 2878 292e 656e 636f       chr(x).enco
-000158d0: 6465 2822 7574 662d 3822 290a 2020 2020  de("utf-8").    
-000158e0: 2020 2020 2020 2020 2020 2020 6966 2078              if x
-000158f0: 2069 6e20 6261 7363 6969 0a20 2020 2020   in bascii.     
-00015900: 2020 2020 2020 2020 2020 2065 6c73 6520             else 
-00015910: 2225 7b3a 3032 787d 222e 666f 726d 6174  "%{:02x}".format
-00015920: 2878 292e 656e 636f 6465 2822 6173 6369  (x).encode("asci
-00015930: 6922 290a 2020 2020 2020 2020 2020 2020  i").            
-00015940: 2020 2020 666f 7220 7820 696e 207a 620a      for x in zb.
-00015950: 2020 2020 2020 2020 2020 2020 5d0a 2020              ].  
-00015960: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-00015970: 2020 2020 2020 2020 7a62 6c20 3d20 5b75          zbl = [u
-00015980: 6e69 636f 6465 2878 2920 6966 2078 2069  nicode(x) if x i
-00015990: 6e20 6261 7363 6969 2065 6c73 6520 2225  n bascii else "%
-000159a0: 7b3a 3032 787d 222e 666f 726d 6174 286f  {:02x}".format(o
-000159b0: 7264 2878 2929 2066 6f72 2078 2069 6e20  rd(x)) for x in 
-000159c0: 7a62 5d0a 0a20 2020 2020 2020 2075 666e  zb]..        ufn
-000159d0: 203d 2062 2222 2e6a 6f69 6e28 7a62 6c29   = b"".join(zbl)
-000159e0: 2e64 6563 6f64 6528 2261 7363 6969 2229  .decode("ascii")
-000159f0: 0a0a 2020 2020 2020 2020 6364 6973 203d  ..        cdis =
-00015a00: 2022 6174 7461 6368 6d65 6e74 3b20 6669   "attachment; fi
-00015a10: 6c65 6e61 6d65 3d5c 227b 7d2e 7b7d 5c22  lename=\"{}.{}\"
-00015a20: 3b20 6669 6c65 6e61 6d65 2a3d 5554 462d  ; filename*=UTF-
-00015a30: 3827 277b 7d2e 7b7d 220a 2020 2020 2020  8''{}.{}".      
-00015a40: 2020 6364 6973 203d 2063 6469 732e 666f    cdis = cdis.fo
-00015a50: 726d 6174 2861 666e 2c20 666d 742c 2075  rmat(afn, fmt, u
-00015a60: 666e 2c20 666d 7429 0a20 2020 2020 2020  fn, fmt).       
-00015a70: 2073 656c 662e 6c6f 6728 6364 6973 290a   self.log(cdis).
-00015a80: 2020 2020 2020 2020 7365 6c66 2e73 656e          self.sen
-00015a90: 645f 6865 6164 6572 7328 4e6f 6e65 2c20  d_headers(None, 
-00015aa0: 6d69 6d65 3d6d 696d 652c 2068 6561 6465  mime=mime, heade
-00015ab0: 7273 3d7b 2243 6f6e 7465 6e74 2d44 6973  rs={"Content-Dis
-00015ac0: 706f 7369 7469 6f6e 223a 2063 6469 737d  position": cdis}
-00015ad0: 290a 0a20 2020 2020 2020 2066 6765 6e20  )..        fgen 
-00015ae0: 3d20 766e 2e7a 6970 6765 6e28 0a20 2020  = vn.zipgen(.   
-00015af0: 2020 2020 2020 2020 2076 7061 7468 2c20           vpath, 
-00015b00: 7265 6d2c 2073 6574 2869 7465 6d73 292c  rem, set(items),
-00015b10: 2073 656c 662e 756e 616d 652c 2064 6f74   self.uname, dot
-00015b20: 732c 2046 616c 7365 2c20 6e6f 7420 7365  s, False, not se
-00015b30: 6c66 2e61 7267 732e 6e6f 5f73 6361 6e64  lf.args.no_scand
-00015b40: 6972 0a20 2020 2020 2020 2029 0a20 2020  ir.        ).   
-00015b50: 2020 2020 2023 2066 6f72 2066 2069 6e20       # for f in 
-00015b60: 6667 656e 3a20 7072 696e 7428 7265 7072  fgen: print(repr
-00015b70: 287b 6b3a 2066 5b6b 5d20 666f 7220 6b20  ({k: f[k] for k 
-00015b80: 696e 205b 2276 7022 2c20 2261 7022 5d7d  in ["vp", "ap"]}
-00015b90: 2929 0a20 2020 2020 2020 2062 6765 6e20  )).        bgen 
-00015ba0: 3d20 7061 636b 6572 2873 656c 662e 6c6f  = packer(self.lo
-00015bb0: 672c 2066 6765 6e2c 2075 7466 383d 2275  g, fgen, utf8="u
-00015bc0: 7466 2220 696e 2075 6172 672c 2070 7265  tf" in uarg, pre
-00015bd0: 5f63 7263 3d22 6372 6322 2069 6e20 7561  _crc="crc" in ua
-00015be0: 7267 290a 2020 2020 2020 2020 6273 656e  rg).        bsen
-00015bf0: 7420 3d20 300a 2020 2020 2020 2020 666f  t = 0.        fo
-00015c00: 7220 6275 6620 696e 2062 6765 6e2e 6765  r buf in bgen.ge
-00015c10: 6e28 293a 0a20 2020 2020 2020 2020 2020  n():.           
-00015c20: 2069 6620 6e6f 7420 6275 663a 0a20 2020   if not buf:.   
-00015c30: 2020 2020 2020 2020 2020 2020 2062 7265               bre
-00015c40: 616b 0a0a 2020 2020 2020 2020 2020 2020  ak..            
-00015c50: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
-00015c60: 2020 2020 2073 656c 662e 732e 7365 6e64       self.s.send
-00015c70: 616c 6c28 6275 6629 0a20 2020 2020 2020  all(buf).       
-00015c80: 2020 2020 2020 2020 2062 7365 6e74 202b           bsent +
-00015c90: 3d20 6c65 6e28 6275 6629 0a20 2020 2020  = len(buf).     
-00015ca0: 2020 2020 2020 2065 7863 6570 743a 0a20         except:. 
-00015cb0: 2020 2020 2020 2020 2020 2020 2020 206c                 l
-00015cc0: 6f67 6d73 6720 2b3d 2022 205c 3033 335b  ogmsg += " \033[
-00015cd0: 3331 6d22 202b 2075 6e69 636f 6465 2862  31m" + unicode(b
-00015ce0: 7365 6e74 2920 2b20 225c 3033 335b 306d  sent) + "\033[0m
-00015cf0: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
-00015d00: 2020 6272 6561 6b0a 0a20 2020 2020 2020    break..       
-00015d10: 2073 7064 203d 2073 656c 662e 5f73 7064   spd = self._spd
-00015d20: 2862 7365 6e74 290a 2020 2020 2020 2020  (bsent).        
-00015d30: 7365 6c66 2e6c 6f67 2822 7b7d 2c20 207b  self.log("{},  {
-00015d40: 7d22 2e66 6f72 6d61 7428 6c6f 676d 7367  }".format(logmsg
-00015d50: 2c20 7370 6429 290a 2020 2020 2020 2020  , spd)).        
-00015d60: 7265 7475 726e 2054 7275 650a 0a20 2020  return True..   
-00015d70: 2064 6566 2074 785f 6963 6f28 7365 6c66   def tx_ico(self
-00015d80: 2c20 6578 7420 2c20 6578 6163 7420 203d  , ext , exact  =
-00015d90: 2046 616c 7365 2920 203a 0a20 2020 2020   False)  :.     
-00015da0: 2020 2073 656c 662e 7065 726d 6974 5f63     self.permit_c
-00015db0: 6163 6869 6e67 2829 0a20 2020 2020 2020  aching().       
-00015dc0: 2069 6620 6578 742e 656e 6473 7769 7468   if ext.endswith
-00015dd0: 2822 2f22 293a 0a20 2020 2020 2020 2020  ("/"):.         
-00015de0: 2020 2065 7874 203d 2022 666f 6c64 6572     ext = "folder
-00015df0: 220a 2020 2020 2020 2020 2020 2020 6578  ".            ex
-00015e00: 6163 7420 3d20 5472 7565 0a0a 2020 2020  act = True..    
-00015e10: 2020 2020 6261 6420 3d20 7265 2e63 6f6d      bad = re.com
-00015e20: 7069 6c65 2872 225b 5d28 297b 7d2f 205b  pile(r"[](){}/ [
-00015e30: 5d7c 5e5b 302d 395f 2d5d 2a24 2229 0a20  ]|^[0-9_-]*$"). 
-00015e40: 2020 2020 2020 206e 203d 2065 7874 2e73         n = ext.s
-00015e50: 706c 6974 2822 2e22 295b 3a3a 2d31 5d0a  plit(".")[::-1].
-00015e60: 2020 2020 2020 2020 6966 206e 6f74 2065          if not e
-00015e70: 7861 6374 3a0a 2020 2020 2020 2020 2020  xact:.          
-00015e80: 2020 6e20 3d20 6e5b 3a2d 315d 0a0a 2020    n = n[:-1]..  
-00015e90: 2020 2020 2020 6578 7420 3d20 2222 0a20        ext = "". 
-00015ea0: 2020 2020 2020 2066 6f72 2076 2069 6e20         for v in 
-00015eb0: 6e3a 0a20 2020 2020 2020 2020 2020 2069  n:.            i
-00015ec0: 6620 6c65 6e28 7629 203e 2037 206f 7220  f len(v) > 7 or 
-00015ed0: 6261 642e 7365 6172 6368 2876 293a 0a20  bad.search(v):. 
-00015ee0: 2020 2020 2020 2020 2020 2020 2020 2062                 b
-00015ef0: 7265 616b 0a0a 2020 2020 2020 2020 2020  reak..          
-00015f00: 2020 6578 7420 3d20 227b 7d2e 7b7d 222e    ext = "{}.{}".
-00015f10: 666f 726d 6174 2876 2c20 6578 7429 0a0a  format(v, ext)..
-00015f20: 2020 2020 2020 2020 6578 7420 3d20 6578          ext = ex
-00015f30: 742e 7273 7472 6970 2822 2e22 2920 6f72  t.rstrip(".") or
-00015f40: 2022 756e 6b22 0a20 2020 2020 2020 2069   "unk".        i
-00015f50: 6620 6c65 6e28 6578 7429 203e 2031 313a  f len(ext) > 11:
-00015f60: 0a20 2020 2020 2020 2020 2020 2065 7874  .            ext
-00015f70: 203d 2022 e28b af22 202b 2065 7874 5b2d   = "..." + ext[-
-00015f80: 393a 5d0a 0a20 2020 2020 2020 2023 2063  9:]..        # c
-00015f90: 6872 6f6d 6520 6361 6e6e 6f74 2068 616e  hrome cannot han
-00015fa0: 646c 6520 6d6f 7265 2074 6861 6e20 7e32  dle more than ~2
-00015fb0: 3030 3020 756e 6971 7565 2053 5647 730a  000 unique SVGs.
-00015fc0: 2020 2020 2020 2020 6368 726f 6d65 203d          chrome =
-00015fd0: 2022 2072 763a 2220 6e6f 7420 696e 2073   " rv:" not in s
-00015fe0: 656c 662e 7561 0a20 2020 2020 2020 206d  elf.ua.        m
-00015ff0: 696d 652c 2069 636f 203d 2073 656c 662e  ime, ico = self.
-00016000: 6963 6f2e 6765 7428 6578 742c 206e 6f74  ico.get(ext, not
-00016010: 2065 7861 6374 2c20 6368 726f 6d65 290a   exact, chrome).
-00016020: 0a20 2020 2020 2020 206c 6d20 3d20 666f  .        lm = fo
-00016030: 726d 6174 6461 7465 2873 656c 662e 452e  rmatdate(self.E.
-00016040: 7430 2c20 7573 6567 6d74 3d54 7275 6529  t0, usegmt=True)
-00016050: 0a20 2020 2020 2020 2073 656c 662e 7265  .        self.re
-00016060: 706c 7928 6963 6f2c 206d 696d 653d 6d69  ply(ico, mime=mi
-00016070: 6d65 2c20 6865 6164 6572 733d 7b22 4c61  me, headers={"La
-00016080: 7374 2d4d 6f64 6966 6965 6422 3a20 6c6d  st-Modified": lm
-00016090: 7d29 0a20 2020 2020 2020 2072 6574 7572  }).        retur
-000160a0: 6e20 5472 7565 0a0a 2020 2020 6465 6620  n True..    def 
-000160b0: 7478 5f6d 6428 7365 6c66 2c20 6673 5f70  tx_md(self, fs_p
-000160c0: 6174 6820 2920 203a 0a20 2020 2020 2020  ath )  :.       
-000160d0: 206c 6f67 6d73 6720 3d20 227b 3a34 7d20   logmsg = "{:4} 
-000160e0: 7b7d 2022 2e66 6f72 6d61 7428 2222 2c20  {} ".format("", 
-000160f0: 7365 6c66 2e72 6571 290a 0a20 2020 2020  self.req)..     
-00016100: 2020 2069 6620 6e6f 7420 7365 6c66 2e63     if not self.c
-00016110: 616e 5f77 7269 7465 3a0a 2020 2020 2020  an_write:.      
-00016120: 2020 2020 2020 6966 2022 6564 6974 2220        if "edit" 
-00016130: 696e 2073 656c 662e 7570 6172 616d 206f  in self.uparam o
-00016140: 7220 2265 6469 7432 2220 696e 2073 656c  r "edit2" in sel
-00016150: 662e 7570 6172 616d 3a0a 2020 2020 2020  f.uparam:.      
-00016160: 2020 2020 2020 2020 2020 7265 7475 726e            return
-00016170: 2073 656c 662e 7478 5f34 3034 2854 7275   self.tx_404(Tru
-00016180: 6529 0a0a 2020 2020 2020 2020 7470 6c20  e)..        tpl 
-00016190: 3d20 226d 6465 2220 6966 2022 6564 6974  = "mde" if "edit
-000161a0: 3222 2069 6e20 7365 6c66 2e75 7061 7261  2" in self.upara
-000161b0: 6d20 656c 7365 2022 6d64 220a 2020 2020  m else "md".    
-000161c0: 2020 2020 6874 6d6c 5f70 6174 6820 3d20      html_path = 
-000161d0: 6f73 2e70 6174 682e 6a6f 696e 2873 656c  os.path.join(sel
-000161e0: 662e 452e 6d6f 642c 2022 7765 6222 2c20  f.E.mod, "web", 
-000161f0: 227b 7d2e 6874 6d6c 222e 666f 726d 6174  "{}.html".format
-00016200: 2874 706c 2929 0a20 2020 2020 2020 2074  (tpl)).        t
-00016210: 656d 706c 6174 6520 3d20 7365 6c66 2e6a  emplate = self.j
-00016220: 326a 2874 706c 290a 0a20 2020 2020 2020  2j(tpl)..       
-00016230: 2073 7420 3d20 626f 732e 7374 6174 2866   st = bos.stat(f
-00016240: 735f 7061 7468 290a 2020 2020 2020 2020  s_path).        
-00016250: 7473 5f6d 6420 3d20 7374 2e73 745f 6d74  ts_md = st.st_mt
-00016260: 696d 650a 0a20 2020 2020 2020 2073 7420  ime..        st 
-00016270: 3d20 626f 732e 7374 6174 2868 746d 6c5f  = bos.stat(html_
-00016280: 7061 7468 290a 2020 2020 2020 2020 7473  path).        ts
-00016290: 5f68 746d 6c20 3d20 7374 2e73 745f 6d74  _html = st.st_mt
-000162a0: 696d 650a 0a20 2020 2020 2020 2073 7a5f  ime..        sz_
-000162b0: 6d64 203d 2030 0a20 2020 2020 2020 2066  md = 0.        f
-000162c0: 6f72 2062 7566 2069 6e20 7969 656c 6466  or buf in yieldf
-000162d0: 696c 6528 6673 5f70 6174 6829 3a0a 2020  ile(fs_path):.  
-000162e0: 2020 2020 2020 2020 2020 737a 5f6d 6420            sz_md 
-000162f0: 2b3d 206c 656e 2862 7566 290a 2020 2020  += len(buf).    
-00016300: 2020 2020 2020 2020 666f 7220 632c 2076          for c, v
-00016310: 2069 6e20 5b28 6222 2622 2c20 3429 2c20   in [(b"&", 4), 
-00016320: 2862 223c 222c 2033 292c 2028 6222 3e22  (b"<", 3), (b">"
-00016330: 2c20 3329 5d3a 0a20 2020 2020 2020 2020  , 3)]:.         
-00016340: 2020 2020 2020 2073 7a5f 6d64 202b 3d20         sz_md += 
-00016350: 286c 656e 2862 7566 2920 2d20 6c65 6e28  (len(buf) - len(
-00016360: 6275 662e 7265 706c 6163 6528 632c 2062  buf.replace(c, b
-00016370: 2222 2929 2920 2a20 760a 0a20 2020 2020  ""))) * v..     
-00016380: 2020 2066 696c 655f 7473 203d 2069 6e74     file_ts = int
-00016390: 286d 6178 2874 735f 6d64 2c20 7473 5f68  (max(ts_md, ts_h
-000163a0: 746d 6c2c 2073 656c 662e 452e 7430 2929  tml, self.E.t0))
-000163b0: 0a20 2020 2020 2020 2066 696c 655f 6c61  .        file_la
-000163c0: 7374 6d6f 642c 2064 6f5f 7365 6e64 203d  stmod, do_send =
-000163d0: 2073 656c 662e 5f63 686b 5f6c 6173 746d   self._chk_lastm
-000163e0: 6f64 2866 696c 655f 7473 290a 2020 2020  od(file_ts).    
-000163f0: 2020 2020 7365 6c66 2e6f 7574 5f68 6561      self.out_hea
-00016400: 6465 7273 5b22 4c61 7374 2d4d 6f64 6966  ders["Last-Modif
-00016410: 6965 6422 5d20 3d20 6669 6c65 5f6c 6173  ied"] = file_las
-00016420: 746d 6f64 0a20 2020 2020 2020 2073 656c  tmod.        sel
-00016430: 662e 6f75 745f 6865 6164 6572 732e 7570  f.out_headers.up
-00016440: 6461 7465 284e 4f5f 4341 4348 4529 0a20  date(NO_CACHE). 
-00016450: 2020 2020 2020 2073 7461 7475 7320 3d20         status = 
-00016460: 3230 3020 6966 2064 6f5f 7365 6e64 2065  200 if do_send e
-00016470: 6c73 6520 3330 340a 0a20 2020 2020 2020  lse 304..       
-00016480: 2061 7267 5f62 6173 6520 3d20 223f 220a   arg_base = "?".
-00016490: 2020 2020 2020 2020 6966 2022 6b22 2069          if "k" i
-000164a0: 6e20 7365 6c66 2e75 7061 7261 6d3a 0a20  n self.uparam:. 
-000164b0: 2020 2020 2020 2020 2020 2061 7267 5f62             arg_b
-000164c0: 6173 6520 3d20 223f 6b3d 7b7d 2622 2e66  ase = "?k={}&".f
-000164d0: 6f72 6d61 7428 7365 6c66 2e75 7061 7261  ormat(self.upara
-000164e0: 6d5b 226b 225d 290a 0a20 2020 2020 2020  m["k"])..       
-000164f0: 2062 6f75 6e64 6172 7920 3d20 225c 726f   boundary = "\ro
-00016500: 6c6c 5c74 6964 6522 0a20 2020 2020 2020  ll\tide".       
-00016510: 2074 6172 6773 203d 207b 0a20 2020 2020   targs = {.     
-00016520: 2020 2020 2020 2022 7222 3a20 7365 6c66         "r": self
-00016530: 2e61 7267 732e 5352 2069 6620 7365 6c66  .args.SR if self
-00016540: 2e69 735f 7670 726f 7869 6564 2065 6c73  .is_vproxied els
-00016550: 6520 2222 2c0a 2020 2020 2020 2020 2020  e "",.          
-00016560: 2020 2274 7322 3a20 7365 6c66 2e63 6f6e    "ts": self.con
-00016570: 6e2e 6873 7276 2e63 6163 6865 6275 7374  n.hsrv.cachebust
-00016580: 6572 2829 2c0a 2020 2020 2020 2020 2020  er(),.          
-00016590: 2020 2273 7663 6e61 6d65 223a 2073 656c    "svcname": sel
-000165a0: 662e 6172 6773 2e64 6f63 7469 746c 652c  f.args.doctitle,
-000165b0: 0a20 2020 2020 2020 2020 2020 2022 6874  .            "ht
-000165c0: 6d6c 5f68 6561 6422 3a20 7365 6c66 2e68  ml_head": self.h
-000165d0: 746d 6c5f 6865 6164 2c0a 2020 2020 2020  tml_head,.      
-000165e0: 2020 2020 2020 2265 6469 7422 3a20 2265        "edit": "e
-000165f0: 6469 7422 2069 6e20 7365 6c66 2e75 7061  dit" in self.upa
-00016600: 7261 6d2c 0a20 2020 2020 2020 2020 2020  ram,.           
-00016610: 2022 7469 746c 6522 3a20 6874 6d6c 5f65   "title": html_e
-00016620: 7363 6170 6528 7365 6c66 2e76 7061 7468  scape(self.vpath
-00016630: 2c20 6372 6c66 3d54 7275 6529 2c0a 2020  , crlf=True),.  
-00016640: 2020 2020 2020 2020 2020 226c 6173 746d            "lastm
-00016650: 6f64 223a 2069 6e74 2874 735f 6d64 202a  od": int(ts_md *
-00016660: 2031 3030 3029 2c0a 2020 2020 2020 2020   1000),.        
-00016670: 2020 2020 226c 616e 6722 3a20 7365 6c66      "lang": self
-00016680: 2e61 7267 732e 6c61 6e67 2c0a 2020 2020  .args.lang,.    
-00016690: 2020 2020 2020 2020 2266 6176 6963 6f22          "favico"
-000166a0: 3a20 7365 6c66 2e61 7267 732e 6661 7669  : self.args.favi
-000166b0: 636f 2c0a 2020 2020 2020 2020 2020 2020  co,.            
-000166c0: 2268 6176 655f 656d 7022 3a20 7365 6c66  "have_emp": self
-000166d0: 2e61 7267 732e 656d 702c 0a20 2020 2020  .args.emp,.     
-000166e0: 2020 2020 2020 2022 6d64 5f63 686b 5f72         "md_chk_r
-000166f0: 6174 6522 3a20 7365 6c66 2e61 7267 732e  ate": self.args.
-00016700: 6d63 722c 0a20 2020 2020 2020 2020 2020  mcr,.           
-00016710: 2022 6d64 223a 2062 6f75 6e64 6172 792c   "md": boundary,
-00016720: 0a20 2020 2020 2020 2020 2020 2022 6172  .            "ar
-00016730: 675f 6261 7365 223a 2061 7267 5f62 6173  g_base": arg_bas
-00016740: 652c 0a20 2020 2020 2020 207d 0a20 2020  e,.        }.   
-00016750: 2020 2020 207a 7320 3d20 7465 6d70 6c61       zs = templa
-00016760: 7465 2e72 656e 6465 7228 2a2a 7461 7267  te.render(**targ
-00016770: 7329 2e65 6e63 6f64 6528 2275 7466 2d38  s).encode("utf-8
-00016780: 222c 2022 7265 706c 6163 6522 290a 2020  ", "replace").  
-00016790: 2020 2020 2020 6874 6d6c 203d 207a 732e        html = zs.
-000167a0: 7370 6c69 7428 626f 756e 6461 7279 2e65  split(boundary.e
-000167b0: 6e63 6f64 6528 2275 7466 2d38 2229 290a  ncode("utf-8")).
-000167c0: 2020 2020 2020 2020 6966 206c 656e 2868          if len(h
-000167d0: 746d 6c29 2021 3d20 323a 0a20 2020 2020  tml) != 2:.     
-000167e0: 2020 2020 2020 2072 6169 7365 2045 7863         raise Exc
-000167f0: 6570 7469 6f6e 2822 626f 756e 6461 7279  eption("boundary
-00016800: 2061 7070 6561 7273 2069 6e20 2220 2b20   appears in " + 
-00016810: 6874 6d6c 5f70 6174 6829 0a0a 2020 2020  html_path)..    
-00016820: 2020 2020 7365 6c66 2e73 656e 645f 6865      self.send_he
-00016830: 6164 6572 7328 737a 5f6d 6420 2b20 6c65  aders(sz_md + le
-00016840: 6e28 6874 6d6c 5b30 5d29 202b 206c 656e  n(html[0]) + len
-00016850: 2868 746d 6c5b 315d 292c 2073 7461 7475  (html[1]), statu
-00016860: 7329 0a0a 2020 2020 2020 2020 6c6f 676d  s)..        logm
-00016870: 7367 202b 3d20 756e 6963 6f64 6528 7374  sg += unicode(st
-00016880: 6174 7573 290a 2020 2020 2020 2020 6966  atus).        if
-00016890: 2073 656c 662e 6d6f 6465 203d 3d20 2248   self.mode == "H
-000168a0: 4541 4422 206f 7220 6e6f 7420 646f 5f73  EAD" or not do_s
-000168b0: 656e 643a 0a20 2020 2020 2020 2020 2020  end:.           
-000168c0: 2069 6620 7365 6c66 2e64 6f5f 6c6f 673a   if self.do_log:
-000168d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000168e0: 2073 656c 662e 6c6f 6728 6c6f 676d 7367   self.log(logmsg
-000168f0: 290a 0a20 2020 2020 2020 2020 2020 2072  )..            r
-00016900: 6574 7572 6e20 5472 7565 0a0a 2020 2020  eturn True..    
-00016910: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
-00016920: 2020 2020 2073 656c 662e 732e 7365 6e64       self.s.send
-00016930: 616c 6c28 6874 6d6c 5b30 5d29 0a20 2020  all(html[0]).   
-00016940: 2020 2020 2020 2020 2066 6f72 2062 7566           for buf
-00016950: 2069 6e20 7969 656c 6466 696c 6528 6673   in yieldfile(fs
-00016960: 5f70 6174 6829 3a0a 2020 2020 2020 2020  _path):.        
-00016970: 2020 2020 2020 2020 7365 6c66 2e73 2e73          self.s.s
-00016980: 656e 6461 6c6c 2868 746d 6c5f 6265 7363  endall(html_besc
-00016990: 6170 6528 6275 6629 290a 0a20 2020 2020  ape(buf))..     
-000169a0: 2020 2020 2020 2073 656c 662e 732e 7365         self.s.se
-000169b0: 6e64 616c 6c28 6874 6d6c 5b31 5d29 0a0a  ndall(html[1])..
-000169c0: 2020 2020 2020 2020 6578 6365 7074 3a0a          except:.
-000169d0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-000169e0: 2e6c 6f67 286c 6f67 6d73 6720 2b20 2220  .log(logmsg + " 
-000169f0: 5c30 3333 5b33 316d 642f 635c 3033 335b  \033[31md/c\033[
-00016a00: 306d 2229 0a20 2020 2020 2020 2020 2020  0m").           
-00016a10: 2072 6574 7572 6e20 4661 6c73 650a 0a20   return False.. 
-00016a20: 2020 2020 2020 2069 6620 7365 6c66 2e64         if self.d
-00016a30: 6f5f 6c6f 673a 0a20 2020 2020 2020 2020  o_log:.         
-00016a40: 2020 2073 656c 662e 6c6f 6728 6c6f 676d     self.log(logm
-00016a50: 7367 202b 2022 2022 202b 2075 6e69 636f  sg + " " + unico
-00016a60: 6465 286c 656e 2868 746d 6c29 2929 0a0a  de(len(html)))..
-00016a70: 2020 2020 2020 2020 7265 7475 726e 2054          return T
-00016a80: 7275 650a 0a20 2020 2064 6566 2074 785f  rue..    def tx_
-00016a90: 7376 6373 2873 656c 6629 2020 3a0a 2020  svcs(self)  :.  
-00016aa0: 2020 2020 2020 616e 616d 6520 3d20 7265        aname = re
-00016ab0: 2e73 7562 2822 5b5e 302d 3961 2d7a 412d  .sub("[^0-9a-zA-
-00016ac0: 5a5d 2b22 2c20 2222 2c20 7365 6c66 2e61  Z]+", "", self.a
-00016ad0: 7267 732e 6e61 6d65 2920 6f72 2022 6122  rgs.name) or "a"
-00016ae0: 0a20 2020 2020 2020 2065 7020 3d20 7365  .        ep = se
-00016af0: 6c66 2e68 6f73 740a 2020 2020 2020 2020  lf.host.        
-00016b00: 686f 7374 203d 2065 702e 7370 6c69 7428  host = ep.split(
-00016b10: 223a 2229 5b30 5d0a 2020 2020 2020 2020  ":")[0].        
-00016b20: 6870 6f72 7420 3d20 6570 5b65 702e 6669  hport = ep[ep.fi
-00016b30: 6e64 2822 3a22 2920 3a5d 2069 6620 223a  nd(":") :] if ":
-00016b40: 2220 696e 2065 7020 656c 7365 2022 220a  " in ep else "".
-00016b50: 2020 2020 2020 2020 7269 7020 3d20 280a          rip = (.
-00016b60: 2020 2020 2020 2020 2020 2020 686f 7374              host
-00016b70: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-00016b80: 7365 6c66 2e61 7267 732e 7263 6c6f 6e65  self.args.rclone
-00016b90: 5f6d 646e 7320 6f72 206e 6f74 2073 656c  _mdns or not sel
-00016ba0: 662e 6172 6773 2e7a 6d0a 2020 2020 2020  f.args.zm.      
-00016bb0: 2020 2020 2020 656c 7365 2073 656c 662e        else self.
-00016bc0: 636f 6e6e 2e68 7372 762e 6e6d 2e6d 6170  conn.hsrv.nm.map
-00016bd0: 2873 656c 662e 6970 2920 6f72 2068 6f73  (self.ip) or hos
-00016be0: 740a 2020 2020 2020 2020 290a 2020 2020  t.        ).    
-00016bf0: 2020 2020 7670 203d 2028 7365 6c66 2e75      vp = (self.u
-00016c00: 7061 7261 6d5b 2268 6322 5d20 6f72 2022  param["hc"] or "
-00016c10: 2229 2e6c 7374 7269 7028 222f 2229 0a20  ").lstrip("/"). 
-00016c20: 2020 2020 2020 2068 746d 6c20 3d20 7365         html = se
-00016c30: 6c66 2e6a 3273 280a 2020 2020 2020 2020  lf.j2s(.        
-00016c40: 2020 2020 2273 7663 7322 2c0a 2020 2020      "svcs",.    
-00016c50: 2020 2020 2020 2020 6172 6773 3d73 656c          args=sel
-00016c60: 662e 6172 6773 2c0a 2020 2020 2020 2020  f.args,.        
-00016c70: 2020 2020 6163 6373 3d62 6f6f 6c28 7365      accs=bool(se
-00016c80: 6c66 2e61 7372 762e 6163 6374 292c 0a20  lf.asrv.acct),. 
-00016c90: 2020 2020 2020 2020 2020 2073 3d22 7322             s="s"
-00016ca0: 2069 6620 7365 6c66 2e69 735f 6874 7470   if self.is_http
-00016cb0: 7320 656c 7365 2022 222c 0a20 2020 2020  s else "",.     
-00016cc0: 2020 2020 2020 2072 6970 3d72 6970 2c0a         rip=rip,.
-00016cd0: 2020 2020 2020 2020 2020 2020 6570 3d65              ep=e
-00016ce0: 702c 0a20 2020 2020 2020 2020 2020 2076  p,.            v
-00016cf0: 703d 7670 2c0a 2020 2020 2020 2020 2020  p=vp,.          
-00016d00: 2020 7276 703d 766a 6f69 6e28 7365 6c66    rvp=vjoin(self
-00016d10: 2e61 7267 732e 522c 2076 7029 2c0a 2020  .args.R, vp),.  
-00016d20: 2020 2020 2020 2020 2020 686f 7374 3d68            host=h
-00016d30: 6f73 742c 0a20 2020 2020 2020 2020 2020  ost,.           
-00016d40: 2068 706f 7274 3d68 706f 7274 2c0a 2020   hport=hport,.  
-00016d50: 2020 2020 2020 2020 2020 616e 616d 653d            aname=
-00016d60: 616e 616d 652c 0a20 2020 2020 2020 2020  aname,.         
-00016d70: 2020 2070 773d 7365 6c66 2e70 7720 6f72     pw=self.pw or
-00016d80: 2022 7077 222c 0a20 2020 2020 2020 2029   "pw",.        )
-00016d90: 0a20 2020 2020 2020 2073 656c 662e 7265  .        self.re
-00016da0: 706c 7928 6874 6d6c 2e65 6e63 6f64 6528  ply(html.encode(
-00016db0: 2275 7466 2d38 2229 290a 2020 2020 2020  "utf-8")).      
-00016dc0: 2020 7265 7475 726e 2054 7275 650a 0a20    return True.. 
-00016dd0: 2020 2064 6566 2074 785f 6d6f 756e 7473     def tx_mounts
-00016de0: 2873 656c 6629 2020 3a0a 2020 2020 2020  (self)  :.      
-00016df0: 2020 7375 6620 3d20 7365 6c66 2e75 726c    suf = self.url
-00016e00: 7128 7b7d 2c20 5b22 6822 5d29 0a20 2020  q({}, ["h"]).   
-00016e10: 2020 2020 2061 766f 6c20 3d20 5b78 2066       avol = [x f
-00016e20: 6f72 2078 2069 6e20 7365 6c66 2e77 766f  or x in self.wvo
-00016e30: 6c20 6966 2078 2069 6e20 7365 6c66 2e72  l if x in self.r
-00016e40: 766f 6c5d 0a20 2020 2020 2020 2072 766f  vol].        rvo
-00016e50: 6c2c 2077 766f 6c2c 2061 766f 6c20 3d20  l, wvol, avol = 
-00016e60: 5b0a 2020 2020 2020 2020 2020 2020 5b28  [.            [(
-00016e70: 222f 2220 2b20 7829 2e72 7374 7269 7028  "/" + x).rstrip(
-00016e80: 222f 2229 202b 2022 2f22 2066 6f72 2078  "/") + "/" for x
-00016e90: 2069 6e20 795d 0a20 2020 2020 2020 2020   in y].         
-00016ea0: 2020 2066 6f72 2079 2069 6e20 5b73 656c     for y in [sel
-00016eb0: 662e 7276 6f6c 2c20 7365 6c66 2e77 766f  f.rvol, self.wvo
-00016ec0: 6c2c 2061 766f 6c5d 0a20 2020 2020 2020  l, avol].       
-00016ed0: 205d 0a0a 2020 2020 2020 2020 6966 2061   ]..        if a
-00016ee0: 766f 6c20 616e 6420 6e6f 7420 7365 6c66  vol and not self
-00016ef0: 2e61 7267 732e 6e6f 5f72 6573 6361 6e3a  .args.no_rescan:
-00016f00: 0a20 2020 2020 2020 2020 2020 2078 203d  .            x =
-00016f10: 2073 656c 662e 636f 6e6e 2e68 7372 762e   self.conn.hsrv.
-00016f20: 6272 6f6b 6572 2e61 736b 2822 7570 326b  broker.ask("up2k
-00016f30: 2e67 6574 5f73 7461 7465 2229 0a20 2020  .get_state").   
-00016f40: 2020 2020 2020 2020 2076 7320 3d20 6a73           vs = js
-00016f50: 6f6e 2e6c 6f61 6473 2878 2e67 6574 2829  on.loads(x.get()
-00016f60: 290a 2020 2020 2020 2020 2020 2020 7673  ).            vs
-00016f70: 7461 7465 203d 207b 2822 2f22 202b 206b  tate = {("/" + k
-00016f80: 292e 7273 7472 6970 2822 2f22 2920 2b20  ).rstrip("/") + 
-00016f90: 222f 223a 2076 2066 6f72 206b 2c20 7620  "/": v for k, v 
-00016fa0: 696e 2076 735b 2276 6f6c 7374 6174 6522  in vs["volstate"
-00016fb0: 5d2e 6974 656d 7328 297d 0a20 2020 2020  ].items()}.     
-00016fc0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-00016fd0: 2020 2020 2076 7374 6174 6520 3d20 7b7d       vstate = {}
-00016fe0: 0a20 2020 2020 2020 2020 2020 2076 7320  .            vs 
-00016ff0: 3d20 7b0a 2020 2020 2020 2020 2020 2020  = {.            
-00017000: 2020 2020 2273 6361 6e6e 696e 6722 3a20      "scanning": 
-00017010: 4e6f 6e65 2c0a 2020 2020 2020 2020 2020  None,.          
-00017020: 2020 2020 2020 2268 6173 6871 223a 204e        "hashq": N
-00017030: 6f6e 652c 0a20 2020 2020 2020 2020 2020  one,.           
-00017040: 2020 2020 2022 7461 6771 223a 204e 6f6e       "tagq": Non
-00017050: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
-00017060: 2020 2022 6d74 7071 223a 204e 6f6e 652c     "mtpq": None,
-00017070: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00017080: 2022 6462 7774 223a 204e 6f6e 652c 0a20   "dbwt": None,. 
-00017090: 2020 2020 2020 2020 2020 207d 0a0a 2020             }..  
-000170a0: 2020 2020 2020 666d 7420 3d20 7365 6c66        fmt = self
-000170b0: 2e75 7061 7261 6d2e 6765 7428 226c 7322  .uparam.get("ls"
-000170c0: 2c20 2222 290a 2020 2020 2020 2020 6966  , "").        if
-000170d0: 206e 6f74 2066 6d74 2061 6e64 2028 7365   not fmt and (se
-000170e0: 6c66 2e75 612e 7374 6172 7473 7769 7468  lf.ua.startswith
-000170f0: 2822 6375 726c 2f22 2920 6f72 2073 656c  ("curl/") or sel
-00017100: 662e 7561 2e73 7461 7274 7377 6974 6828  f.ua.startswith(
-00017110: 2266 6574 6368 2229 293a 0a20 2020 2020  "fetch")):.     
-00017120: 2020 2020 2020 2066 6d74 203d 2022 7622         fmt = "v"
-00017130: 0a0a 2020 2020 2020 2020 6966 2066 6d74  ..        if fmt
-00017140: 2069 6e20 5b22 7622 2c20 2274 222c 2022   in ["v", "t", "
-00017150: 7478 7422 5d3a 0a20 2020 2020 2020 2020  txt"]:.         
-00017160: 2020 2069 6620 7365 6c66 2e75 6e61 6d65     if self.uname
-00017170: 203d 3d20 222a 223a 0a20 2020 2020 2020   == "*":.       
-00017180: 2020 2020 2020 2020 2074 7874 203d 2022           txt = "
-00017190: 686f 7764 7920 7374 7261 6e67 6572 2028  howdy stranger (
-000171a0: 796f 7527 7265 206e 6f74 206c 6f67 6765  you're not logge
-000171b0: 6420 696e 2922 0a20 2020 2020 2020 2020  d in)".         
-000171c0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-000171d0: 2020 2020 2020 2020 2074 7874 203d 2022           txt = "
-000171e0: 7765 6c63 6f6d 6520 6261 636b 207b 7d22  welcome back {}"
-000171f0: 2e66 6f72 6d61 7428 7365 6c66 2e75 6e61  .format(self.una
-00017200: 6d65 290a 0a20 2020 2020 2020 2020 2020  me)..           
-00017210: 2069 6620 7673 7461 7465 3a0a 2020 2020   if vstate:.    
-00017220: 2020 2020 2020 2020 2020 2020 7478 7420              txt 
-00017230: 2b3d 2022 5c6e 7374 6174 7573 3a22 0a20  += "\nstatus:". 
-00017240: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00017250: 6f72 206b 2069 6e20 5b22 7363 616e 6e69  or k in ["scanni
-00017260: 6e67 222c 2022 6861 7368 7122 2c20 2274  ng", "hashq", "t
-00017270: 6167 7122 2c20 226d 7470 7122 2c20 2264  agq", "mtpq", "d
-00017280: 6277 7422 5d3a 0a20 2020 2020 2020 2020  bwt"]:.         
-00017290: 2020 2020 2020 2020 2020 2074 7874 202b             txt +
-000172a0: 3d20 2220 7b7d 287b 7d29 222e 666f 726d  = " {}({})".form
-000172b0: 6174 286b 2c20 7673 5b6b 5d29 0a0a 2020  at(k, vs[k])..  
-000172c0: 2020 2020 2020 2020 2020 6966 2072 766f            if rvo
-000172d0: 6c3a 0a20 2020 2020 2020 2020 2020 2020  l:.             
-000172e0: 2020 2074 7874 202b 3d20 225c 6e79 6f75     txt += "\nyou
-000172f0: 2063 616e 2062 726f 7773 653a 220a 2020   can browse:".  
-00017300: 2020 2020 2020 2020 2020 2020 2020 666f                fo
-00017310: 7220 7620 696e 2072 766f 6c3a 0a20 2020  r v in rvol:.   
-00017320: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017330: 2074 7874 202b 3d20 225c 6e20 2022 202b   txt += "\n  " +
-00017340: 2076 0a0a 2020 2020 2020 2020 2020 2020   v..            
-00017350: 6966 2077 766f 6c3a 0a20 2020 2020 2020  if wvol:.       
-00017360: 2020 2020 2020 2020 2074 7874 202b 3d20           txt += 
-00017370: 225c 6e79 6f75 2063 616e 2075 706c 6f61  "\nyou can uploa
-00017380: 6420 746f 3a22 0a20 2020 2020 2020 2020  d to:".         
-00017390: 2020 2020 2020 2066 6f72 2076 2069 6e20         for v in 
-000173a0: 7776 6f6c 3a0a 2020 2020 2020 2020 2020  wvol:.          
-000173b0: 2020 2020 2020 2020 2020 7478 7420 2b3d            txt +=
-000173c0: 2022 5c6e 2020 2220 2b20 760a 0a20 2020   "\n  " + v..   
-000173d0: 2020 2020 2020 2020 207a 6220 3d20 7478           zb = tx
-000173e0: 742e 656e 636f 6465 2822 7574 662d 3822  t.encode("utf-8"
-000173f0: 2c20 2272 6570 6c61 6365 2229 202b 2062  , "replace") + b
-00017400: 225c 6e22 0a20 2020 2020 2020 2020 2020  "\n".           
-00017410: 2073 656c 662e 7265 706c 7928 7a62 2c20   self.reply(zb, 
-00017420: 6d69 6d65 3d22 7465 7874 2f70 6c61 696e  mime="text/plain
-00017430: 3b20 6368 6172 7365 743d 7574 662d 3822  ; charset=utf-8"
-00017440: 290a 2020 2020 2020 2020 2020 2020 7265  ).            re
-00017450: 7475 726e 2054 7275 650a 0a20 2020 2020  turn True..     
-00017460: 2020 2068 746d 6c20 3d20 7365 6c66 2e6a     html = self.j
-00017470: 3273 280a 2020 2020 2020 2020 2020 2020  2s(.            
-00017480: 2273 706c 6173 6822 2c0a 2020 2020 2020  "splash",.      
-00017490: 2020 2020 2020 7468 6973 3d73 656c 662c        this=self,
-000174a0: 0a20 2020 2020 2020 2020 2020 2071 7670  .            qvp
-000174b0: 6174 683d 7175 6f74 6570 2873 656c 662e  ath=quotep(self.
-000174c0: 7670 6174 6829 2c0a 2020 2020 2020 2020  vpath),.        
-000174d0: 2020 2020 7276 6f6c 3d72 766f 6c2c 0a20      rvol=rvol,. 
-000174e0: 2020 2020 2020 2020 2020 2077 766f 6c3d             wvol=
-000174f0: 7776 6f6c 2c0a 2020 2020 2020 2020 2020  wvol,.          
-00017500: 2020 6176 6f6c 3d61 766f 6c2c 0a20 2020    avol=avol,.   
-00017510: 2020 2020 2020 2020 2076 7374 6174 653d           vstate=
-00017520: 7673 7461 7465 2c0a 2020 2020 2020 2020  vstate,.        
-00017530: 2020 2020 7363 616e 6e69 6e67 3d76 735b      scanning=vs[
-00017540: 2273 6361 6e6e 696e 6722 5d2c 0a20 2020  "scanning"],.   
-00017550: 2020 2020 2020 2020 2068 6173 6871 3d76           hashq=v
-00017560: 735b 2268 6173 6871 225d 2c0a 2020 2020  s["hashq"],.    
-00017570: 2020 2020 2020 2020 7461 6771 3d76 735b          tagq=vs[
-00017580: 2274 6167 7122 5d2c 0a20 2020 2020 2020  "tagq"],.       
-00017590: 2020 2020 206d 7470 713d 7673 5b22 6d74       mtpq=vs["mt
-000175a0: 7071 225d 2c0a 2020 2020 2020 2020 2020  pq"],.          
-000175b0: 2020 6462 7774 3d76 735b 2264 6277 7422    dbwt=vs["dbwt"
-000175c0: 5d2c 0a20 2020 2020 2020 2020 2020 2075  ],.            u
-000175d0: 726c 5f73 7566 3d73 7566 2c0a 2020 2020  rl_suf=suf,.    
-000175e0: 2020 2020 2020 2020 6b33 3034 3d73 656c          k304=sel
-000175f0: 662e 6b33 3034 2829 2c0a 2020 2020 2020  f.k304(),.      
-00017600: 2020 2020 2020 7665 723d 535f 5645 5253        ver=S_VERS
-00017610: 494f 4e20 6966 2073 656c 662e 6172 6773  ION if self.args
-00017620: 2e76 6572 2065 6c73 6520 2222 2c0a 2020  .ver else "",.  
-00017630: 2020 2020 2020 2020 2020 6168 7474 7073            ahttps
-00017640: 3d22 2220 6966 2073 656c 662e 6973 5f68  ="" if self.is_h
-00017650: 7474 7073 2065 6c73 6520 2268 7474 7073  ttps else "https
-00017660: 3a2f 2f22 202b 2073 656c 662e 686f 7374  ://" + self.host
-00017670: 202b 2073 656c 662e 7265 712c 0a20 2020   + self.req,.   
-00017680: 2020 2020 2029 0a20 2020 2020 2020 2073       ).        s
-00017690: 656c 662e 7265 706c 7928 6874 6d6c 2e65  elf.reply(html.e
-000176a0: 6e63 6f64 6528 2275 7466 2d38 2229 290a  ncode("utf-8")).
-000176b0: 2020 2020 2020 2020 7265 7475 726e 2054          return T
-000176c0: 7275 650a 0a20 2020 2064 6566 2073 6574  rue..    def set
-000176d0: 5f6b 3330 3428 7365 6c66 2920 203a 0a20  _k304(self)  :. 
-000176e0: 2020 2020 2020 2063 6b20 3d20 6765 6e63         ck = genc
-000176f0: 6f6f 6b69 6528 226b 3330 3422 2c20 7365  ookie("k304", se
-00017700: 6c66 2e75 7061 7261 6d5b 226b 3330 3422  lf.uparam["k304"
-00017710: 5d2c 2073 656c 662e 6172 6773 2e52 2c20  ], self.args.R, 
-00017720: 4661 6c73 652c 2038 3634 3030 202a 2032  False, 86400 * 2
-00017730: 3939 290a 2020 2020 2020 2020 7365 6c66  99).        self
-00017740: 2e6f 7574 5f68 6561 6465 726c 6973 742e  .out_headerlist.
-00017750: 6170 7065 6e64 2828 2253 6574 2d43 6f6f  append(("Set-Coo
-00017760: 6b69 6522 2c20 636b 2929 0a20 2020 2020  kie", ck)).     
-00017770: 2020 2073 656c 662e 7265 6469 7265 6374     self.redirect
-00017780: 2822 222c 2022 3f68 2363 6322 290a 2020  ("", "?h#cc").  
-00017790: 2020 2020 2020 7265 7475 726e 2054 7275        return Tru
-000177a0: 650a 0a20 2020 2064 6566 2073 6574 636b  e..    def setck
-000177b0: 2873 656c 6629 2020 3a0a 2020 2020 2020  (self)  :.      
-000177c0: 2020 6b2c 2076 203d 2073 656c 662e 7570    k, v = self.up
-000177d0: 6172 616d 5b22 7365 7463 6b22 5d2e 7370  aram["setck"].sp
-000177e0: 6c69 7428 223d 222c 2031 290a 2020 2020  lit("=", 1).    
-000177f0: 2020 2020 7420 3d20 4e6f 6e65 2069 6620      t = None if 
-00017800: 7620 3d3d 2022 2220 656c 7365 2038 3634  v == "" else 864
-00017810: 3030 202a 2032 3939 0a20 2020 2020 2020  00 * 299.       
-00017820: 2063 6b20 3d20 6765 6e63 6f6f 6b69 6528   ck = gencookie(
-00017830: 6b2c 2076 2c20 7365 6c66 2e61 7267 732e  k, v, self.args.
-00017840: 522c 2046 616c 7365 2c20 7429 0a20 2020  R, False, t).   
-00017850: 2020 2020 2073 656c 662e 6f75 745f 6865       self.out_he
-00017860: 6164 6572 6c69 7374 2e61 7070 656e 6428  aderlist.append(
-00017870: 2822 5365 742d 436f 6f6b 6965 222c 2063  ("Set-Cookie", c
-00017880: 6b29 290a 2020 2020 2020 2020 7365 6c66  k)).        self
-00017890: 2e72 6570 6c79 2862 226f 375c 6e22 290a  .reply(b"o7\n").
-000178a0: 2020 2020 2020 2020 7265 7475 726e 2054          return T
-000178b0: 7275 650a 0a20 2020 2064 6566 2073 6574  rue..    def set
-000178c0: 5f63 6667 5f72 6573 6574 2873 656c 6629  _cfg_reset(self)
-000178d0: 2020 3a0a 2020 2020 2020 2020 666f 7220    :.        for 
-000178e0: 6b20 696e 2028 226b 3330 3422 2c20 226a  k in ("k304", "j
-000178f0: 7322 2c20 2269 6478 6822 2c20 2263 7070  s", "idxh", "cpp
-00017900: 7764 222c 2022 6370 7077 7322 293a 0a20  wd", "cppws"):. 
-00017910: 2020 2020 2020 2020 2020 2063 6f6f 6b69             cooki
-00017920: 6520 3d20 6765 6e63 6f6f 6b69 6528 6b2c  e = gencookie(k,
-00017930: 2022 7822 2c20 7365 6c66 2e61 7267 732e   "x", self.args.
-00017940: 522c 2046 616c 7365 2c20 4e6f 6e65 290a  R, False, None).
-00017950: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00017960: 2e6f 7574 5f68 6561 6465 726c 6973 742e  .out_headerlist.
-00017970: 6170 7065 6e64 2828 2253 6574 2d43 6f6f  append(("Set-Coo
-00017980: 6b69 6522 2c20 636f 6f6b 6965 2929 0a0a  kie", cookie))..
-00017990: 2020 2020 2020 2020 7365 6c66 2e72 6564          self.red
-000179a0: 6972 6563 7428 2222 2c20 223f 6823 6363  irect("", "?h#cc
-000179b0: 2229 0a20 2020 2020 2020 2072 6574 7572  ").        retur
-000179c0: 6e20 5472 7565 0a0a 2020 2020 6465 6620  n True..    def 
-000179d0: 7478 5f34 3034 2873 656c 662c 2069 735f  tx_404(self, is_
-000179e0: 3430 3320 203d 2046 616c 7365 2920 203a  403  = False)  :
-000179f0: 0a20 2020 2020 2020 2072 6320 3d20 3430  .        rc = 40
-00017a00: 340a 2020 2020 2020 2020 6966 2073 656c  4.        if sel
-00017a10: 662e 6172 6773 2e76 6167 7565 5f34 3033  f.args.vague_403
-00017a20: 3a0a 2020 2020 2020 2020 2020 2020 7420  :.            t 
-00017a30: 3d20 273c 6831 2069 643d 226e 223e 3430  = '<h1 id="n">40
-00017a40: 3420 6e6f 7420 666f 756e 6420 266e 6273  4 not found &nbs
-00017a50: 703b e294 9028 20c2 b420 2d60 29e2 948c  p;...( .. -`)...
-00017a60: 3c2f 6831 3e3c 7020 6964 3d22 6f22 3e6f  </h1><p id="o">o
-00017a70: 7220 6d61 7962 6520 796f 7520 646f 6e5c  r maybe you don\
-00017a80: 2774 2068 6176 6520 6163 6365 7373 202d  't have access -
-00017a90: 2d20 7472 7920 6c6f 6767 696e 6720 696e  - try logging in
-00017aa0: 206f 7220 3c61 2068 7265 663d 227b 7d2f   or <a href="{}/
-00017ab0: 3f68 223e 676f 2068 6f6d 653c 2f61 3e3c  ?h">go home</a><
-00017ac0: 2f70 3e27 0a20 2020 2020 2020 2065 6c69  /p>'.        eli
-00017ad0: 6620 6973 5f34 3033 3a0a 2020 2020 2020  f is_403:.      
-00017ae0: 2020 2020 2020 7420 3d20 273c 6831 2069        t = '<h1 i
-00017af0: 643d 2270 223e 3430 3320 666f 7262 6964  d="p">403 forbid
-00017b00: 6465 6e61 2026 6e62 7370 3b7e e294 bbe2  dena &nbsp;~....
-00017b10: 9481 e294 bb3c 2f68 313e 3c70 2069 643d  .....</h1><p id=
-00017b20: 2271 223e 796f 755c 276c 6c20 6861 7665  "q">you\'ll have
-00017b30: 2074 6f20 6c6f 6720 696e 206f 7220 3c61   to log in or <a
-00017b40: 2068 7265 663d 227b 7d2f 3f68 223e 676f   href="{}/?h">go
-00017b50: 2068 6f6d 653c 2f61 3e3c 2f70 3e27 0a20   home</a></p>'. 
-00017b60: 2020 2020 2020 2020 2020 2072 6320 3d20             rc = 
-00017b70: 3430 330a 2020 2020 2020 2020 656c 7365  403.        else
-00017b80: 3a0a 2020 2020 2020 2020 2020 2020 7420  :.            t 
-00017b90: 3d20 273c 6831 2069 643d 226e 223e 3430  = '<h1 id="n">40
-00017ba0: 3420 6e6f 7420 666f 756e 6420 266e 6273  4 not found &nbs
-00017bb0: 703b e294 9028 20c2 b420 2d60 29e2 948c  p;...( .. -`)...
-00017bc0: 3c2f 6831 3e3c 703e 3c61 2069 643d 2272  </h1><p><a id="r
-00017bd0: 2220 6872 6566 3d22 7b7d 2f3f 6822 3e67  " href="{}/?h">g
-00017be0: 6f20 686f 6d65 3c2f 613e 3c2f 703e 270a  o home</a></p>'.
-00017bf0: 0a20 2020 2020 2020 2074 203d 2074 2e66  .        t = t.f
-00017c00: 6f72 6d61 7428 7365 6c66 2e61 7267 732e  ormat(self.args.
-00017c10: 5352 290a 2020 2020 2020 2020 6874 6d6c  SR).        html
-00017c20: 203d 2073 656c 662e 6a32 7328 2273 706c   = self.j2s("spl
-00017c30: 6173 6822 2c20 7468 6973 3d73 656c 662c  ash", this=self,
-00017c40: 2071 7670 6174 683d 7175 6f74 6570 2873   qvpath=quotep(s
-00017c50: 656c 662e 7670 6174 6829 2c20 6d73 673d  elf.vpath), msg=
-00017c60: 7429 0a20 2020 2020 2020 2073 656c 662e  t).        self.
-00017c70: 7265 706c 7928 6874 6d6c 2e65 6e63 6f64  reply(html.encod
-00017c80: 6528 2275 7466 2d38 2229 2c20 7374 6174  e("utf-8"), stat
-00017c90: 7573 3d72 6329 0a20 2020 2020 2020 2072  us=rc).        r
-00017ca0: 6574 7572 6e20 5472 7565 0a0a 2020 2020  eturn True..    
-00017cb0: 6465 6620 7363 616e 766f 6c28 7365 6c66  def scanvol(self
-00017cc0: 2920 203a 0a20 2020 2020 2020 2069 6620  )  :.        if 
-00017cd0: 6e6f 7420 7365 6c66 2e63 616e 5f72 6561  not self.can_rea
-00017ce0: 6420 6f72 206e 6f74 2073 656c 662e 6361  d or not self.ca
-00017cf0: 6e5f 7772 6974 653a 0a20 2020 2020 2020  n_write:.       
-00017d00: 2020 2020 2072 6169 7365 2050 6562 6b61       raise Pebka
-00017d10: 6328 3430 332c 2022 6e6f 7420 616c 6c6f  c(403, "not allo
-00017d20: 7765 6420 666f 7220 7573 6572 2022 202b  wed for user " +
-00017d30: 2073 656c 662e 756e 616d 6529 0a0a 2020   self.uname)..  
-00017d40: 2020 2020 2020 6966 2073 656c 662e 6172        if self.ar
-00017d50: 6773 2e6e 6f5f 7265 7363 616e 3a0a 2020  gs.no_rescan:.  
-00017d60: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
-00017d70: 5065 626b 6163 2834 3033 2c20 2274 6865  Pebkac(403, "the
-00017d80: 2072 6573 6361 6e20 6665 6174 7572 6520   rescan feature 
-00017d90: 6973 2064 6973 6162 6c65 6420 696e 2073  is disabled in s
-00017da0: 6572 7665 7220 636f 6e66 6967 2229 0a0a  erver config")..
-00017db0: 2020 2020 2020 2020 766e 2c20 5f20 3d20          vn, _ = 
-00017dc0: 7365 6c66 2e61 7372 762e 7666 732e 6765  self.asrv.vfs.ge
-00017dd0: 7428 7365 6c66 2e76 7061 7468 2c20 7365  t(self.vpath, se
-00017de0: 6c66 2e75 6e61 6d65 2c20 5472 7565 2c20  lf.uname, True, 
-00017df0: 5472 7565 290a 0a20 2020 2020 2020 2061  True)..        a
-00017e00: 7267 7320 3d20 5b73 656c 662e 6173 7276  rgs = [self.asrv
-00017e10: 2e76 6673 2e61 6c6c 5f76 6f6c 732c 205b  .vfs.all_vols, [
-00017e20: 766e 2e76 7061 7468 5d2c 2046 616c 7365  vn.vpath], False
-00017e30: 2c20 5472 7565 5d0a 0a20 2020 2020 2020  , True]..       
-00017e40: 2078 203d 2073 656c 662e 636f 6e6e 2e68   x = self.conn.h
-00017e50: 7372 762e 6272 6f6b 6572 2e61 736b 2822  srv.broker.ask("
-00017e60: 7570 326b 2e72 6573 6361 6e22 2c20 2a61  up2k.rescan", *a
-00017e70: 7267 7329 0a20 2020 2020 2020 2065 7272  rgs).        err
-00017e80: 203d 2078 2e67 6574 2829 0a20 2020 2020   = x.get().     
-00017e90: 2020 2069 6620 6e6f 7420 6572 723a 0a20     if not err:. 
-00017ea0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-00017eb0: 7265 6469 7265 6374 2822 222c 2022 3f68  redirect("", "?h
-00017ec0: 2229 0a20 2020 2020 2020 2020 2020 2072  ").            r
-00017ed0: 6574 7572 6e20 5472 7565 0a0a 2020 2020  eturn True..    
-00017ee0: 2020 2020 7261 6973 6520 5065 626b 6163      raise Pebkac
-00017ef0: 2835 3030 2c20 6572 7229 0a0a 2020 2020  (500, err)..    
-00017f00: 6465 6620 6861 6e64 6c65 5f72 656c 6f61  def handle_reloa
-00017f10: 6428 7365 6c66 2920 203a 0a20 2020 2020  d(self)  :.     
-00017f20: 2020 2061 6374 203d 2073 656c 662e 7570     act = self.up
-00017f30: 6172 616d 2e67 6574 2822 7265 6c6f 6164  aram.get("reload
-00017f40: 2229 0a20 2020 2020 2020 2069 6620 6163  ").        if ac
-00017f50: 7420 213d 2022 6366 6722 3a0a 2020 2020  t != "cfg":.    
-00017f60: 2020 2020 2020 2020 7261 6973 6520 5065          raise Pe
-00017f70: 626b 6163 2834 3030 2c20 226f 6e6c 7920  bkac(400, "only 
-00017f80: 636f 6e66 6967 2066 696c 6573 2028 2763  config files ('c
-00017f90: 6667 2729 2063 616e 2062 6520 7265 6c6f  fg') can be relo
-00017fa0: 6164 6564 2072 6e22 290a 0a20 2020 2020  aded rn")..     
-00017fb0: 2020 2069 6620 6e6f 7420 5b78 2066 6f72     if not [x for
-00017fc0: 2078 2069 6e20 7365 6c66 2e77 766f 6c20   x in self.wvol 
-00017fd0: 6966 2078 2069 6e20 7365 6c66 2e72 766f  if x in self.rvo
-00017fe0: 6c5d 3a0a 2020 2020 2020 2020 2020 2020  l]:.            
-00017ff0: 7261 6973 6520 5065 626b 6163 2834 3033  raise Pebkac(403
-00018000: 2c20 226e 6f74 2061 6c6c 6f77 6564 2066  , "not allowed f
-00018010: 6f72 2075 7365 7220 2220 2b20 7365 6c66  or user " + self
-00018020: 2e75 6e61 6d65 290a 0a20 2020 2020 2020  .uname)..       
-00018030: 2069 6620 7365 6c66 2e61 7267 732e 6e6f   if self.args.no
-00018040: 5f72 656c 6f61 643a 0a20 2020 2020 2020  _reload:.       
-00018050: 2020 2020 2072 6169 7365 2050 6562 6b61       raise Pebka
-00018060: 6328 3430 332c 2022 7468 6520 7265 6c6f  c(403, "the relo
-00018070: 6164 2066 6561 7475 7265 2069 7320 6469  ad feature is di
-00018080: 7361 626c 6564 2069 6e20 7365 7276 6572  sabled in server
-00018090: 2063 6f6e 6669 6722 290a 0a20 2020 2020   config")..     
-000180a0: 2020 2078 203d 2073 656c 662e 636f 6e6e     x = self.conn
-000180b0: 2e68 7372 762e 6272 6f6b 6572 2e61 736b  .hsrv.broker.ask
-000180c0: 2822 7265 6c6f 6164 2229 0a20 2020 2020  ("reload").     
-000180d0: 2020 2072 6574 7572 6e20 7365 6c66 2e72     return self.r
-000180e0: 6564 6972 6563 7428 2222 2c20 223f 6822  edirect("", "?h"
-000180f0: 2c20 782e 6765 7428 292c 2022 7265 7475  , x.get(), "retu
-00018100: 726e 2074 6f22 2c20 4661 6c73 6529 0a0a  rn to", False)..
-00018110: 2020 2020 6465 6620 7478 5f73 7461 636b      def tx_stack
-00018120: 2873 656c 6629 2020 3a0a 2020 2020 2020  (self)  :.      
-00018130: 2020 6966 206e 6f74 205b 7820 666f 7220    if not [x for 
-00018140: 7820 696e 2073 656c 662e 7776 6f6c 2069  x in self.wvol i
-00018150: 6620 7820 696e 2073 656c 662e 7276 6f6c  f x in self.rvol
-00018160: 5d3a 0a20 2020 2020 2020 2020 2020 2072  ]:.            r
-00018170: 6169 7365 2050 6562 6b61 6328 3430 332c  aise Pebkac(403,
-00018180: 2022 6e6f 7420 616c 6c6f 7765 6420 666f   "not allowed fo
-00018190: 7220 7573 6572 2022 202b 2073 656c 662e  r user " + self.
-000181a0: 756e 616d 6529 0a0a 2020 2020 2020 2020  uname)..        
-000181b0: 6966 2073 656c 662e 6172 6773 2e6e 6f5f  if self.args.no_
-000181c0: 7374 6163 6b3a 0a20 2020 2020 2020 2020  stack:.         
-000181d0: 2020 2072 6169 7365 2050 6562 6b61 6328     raise Pebkac(
-000181e0: 3430 332c 2022 7468 6520 7374 6163 6b64  403, "the stackd
-000181f0: 756d 7020 6665 6174 7572 6520 6973 2064  ump feature is d
-00018200: 6973 6162 6c65 6420 696e 2073 6572 7665  isabled in serve
-00018210: 7220 636f 6e66 6967 2229 0a0a 2020 2020  r config")..    
-00018220: 2020 2020 7265 7420 3d20 223c 7072 653e      ret = "<pre>
-00018230: 7b7d 5c6e 7b7d 222e 666f 726d 6174 2874  {}\n{}".format(t
-00018240: 696d 652e 7469 6d65 2829 2c20 6874 6d6c  ime.time(), html
-00018250: 5f65 7363 6170 6528 616c 6c74 7261 6365  _escape(alltrace
-00018260: 2829 2929 0a20 2020 2020 2020 2073 656c  ())).        sel
-00018270: 662e 7265 706c 7928 7265 742e 656e 636f  f.reply(ret.enco
-00018280: 6465 2822 7574 662d 3822 2929 0a20 2020  de("utf-8")).   
-00018290: 2020 2020 2072 6574 7572 6e20 5472 7565       return True
-000182a0: 0a0a 2020 2020 6465 6620 7478 5f74 7265  ..    def tx_tre
-000182b0: 6528 7365 6c66 2920 203a 0a20 2020 2020  e(self)  :.     
-000182c0: 2020 2074 6f70 203d 2073 656c 662e 7570     top = self.up
-000182d0: 6172 616d 5b22 7472 6565 225d 206f 7220  aram["tree"] or 
-000182e0: 2222 0a20 2020 2020 2020 2064 7374 203d  "".        dst =
-000182f0: 2073 656c 662e 7670 6174 680a 2020 2020   self.vpath.    
-00018300: 2020 2020 6966 2074 6f70 2069 6e20 5b22      if top in ["
-00018310: 2e22 2c20 222e 2e22 5d3a 0a20 2020 2020  .", ".."]:.     
-00018320: 2020 2020 2020 2074 6f70 203d 2075 6e64         top = und
-00018330: 6f74 2873 656c 662e 7670 6174 6820 2b20  ot(self.vpath + 
-00018340: 222f 2220 2b20 746f 7029 0a0a 2020 2020  "/" + top)..    
-00018350: 2020 2020 6966 2074 6f70 203d 3d20 6473      if top == ds
-00018360: 743a 0a20 2020 2020 2020 2020 2020 2064  t:.            d
-00018370: 7374 203d 2022 220a 2020 2020 2020 2020  st = "".        
-00018380: 656c 6966 2074 6f70 3a0a 2020 2020 2020  elif top:.      
-00018390: 2020 2020 2020 6966 206e 6f74 2064 7374        if not dst
-000183a0: 2e73 7461 7274 7377 6974 6828 746f 7020  .startswith(top 
-000183b0: 2b20 222f 2229 3a0a 2020 2020 2020 2020  + "/"):.        
-000183c0: 2020 2020 2020 2020 7261 6973 6520 5065          raise Pe
-000183d0: 626b 6163 2834 3030 2c20 2261 7267 2066  bkac(400, "arg f
-000183e0: 756e 6b22 290a 0a20 2020 2020 2020 2020  unk")..         
-000183f0: 2020 2064 7374 203d 2064 7374 5b6c 656e     dst = dst[len
-00018400: 2874 6f70 2920 2b20 3120 3a5d 0a0a 2020  (top) + 1 :]..  
-00018410: 2020 2020 2020 7265 7420 3d20 7365 6c66        ret = self
-00018420: 2e67 656e 5f74 7265 6528 746f 702c 2064  .gen_tree(top, d
-00018430: 7374 290a 2020 2020 2020 2020 6966 2073  st).        if s
-00018440: 656c 662e 6973 5f76 7072 6f78 6965 643a  elf.is_vproxied:
-00018450: 0a20 2020 2020 2020 2020 2020 2070 6172  .            par
-00018460: 656e 7473 203d 2073 656c 662e 6172 6773  ents = self.args
-00018470: 2e52 2e73 706c 6974 2822 2f22 290a 2020  .R.split("/").  
-00018480: 2020 2020 2020 2020 2020 666f 7220 7061            for pa
-00018490: 7265 6e74 2069 6e20 7265 7665 7273 6564  rent in reversed
-000184a0: 2870 6172 656e 7473 293a 0a20 2020 2020  (parents):.     
-000184b0: 2020 2020 2020 2020 2020 2072 6574 203d             ret =
-000184c0: 207b 226b 2573 2220 2520 2870 6172 656e   {"k%s" % (paren
-000184d0: 742c 293a 2072 6574 2c20 2261 223a 205b  t,): ret, "a": [
-000184e0: 5d7d 0a0a 2020 2020 2020 2020 7a73 203d  ]}..        zs =
-000184f0: 206a 736f 6e2e 6475 6d70 7328 7265 7429   json.dumps(ret)
-00018500: 0a20 2020 2020 2020 2073 656c 662e 7265  .        self.re
-00018510: 706c 7928 7a73 2e65 6e63 6f64 6528 2275  ply(zs.encode("u
-00018520: 7466 2d38 2229 2c20 6d69 6d65 3d22 6170  tf-8"), mime="ap
-00018530: 706c 6963 6174 696f 6e2f 6a73 6f6e 2229  plication/json")
-00018540: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-00018550: 5472 7565 0a0a 2020 2020 6465 6620 6765  True..    def ge
-00018560: 6e5f 7472 6565 2873 656c 662c 2074 6f70  n_tree(self, top
-00018570: 202c 2074 6172 6765 7420 2920 2020 3a0a   , target )   :.
-00018580: 2020 2020 2020 2020 7265 7420 2020 3d20          ret   = 
-00018590: 7b7d 0a20 2020 2020 2020 2065 7863 6c20  {}.        excl 
-000185a0: 3d20 4e6f 6e65 0a20 2020 2020 2020 2069  = None.        i
-000185b0: 6620 7461 7267 6574 3a0a 2020 2020 2020  f target:.      
-000185c0: 2020 2020 2020 6578 636c 2c20 7461 7267        excl, targ
-000185d0: 6574 203d 2028 7461 7267 6574 2e73 706c  et = (target.spl
-000185e0: 6974 2822 2f22 2c20 3129 202b 205b 2222  it("/", 1) + [""
-000185f0: 5d29 5b3a 325d 0a20 2020 2020 2020 2020  ])[:2].         
-00018600: 2020 2073 7562 203d 2073 656c 662e 6765     sub = self.ge
-00018610: 6e5f 7472 6565 2822 2f22 2e6a 6f69 6e28  n_tree("/".join(
-00018620: 5b74 6f70 2c20 6578 636c 5d29 2e73 7472  [top, excl]).str
-00018630: 6970 2822 2f22 292c 2074 6172 6765 7429  ip("/"), target)
-00018640: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-00018650: 5b22 6b22 202b 2071 756f 7465 7028 6578  ["k" + quotep(ex
-00018660: 636c 295d 203d 2073 7562 0a0a 2020 2020  cl)] = sub..    
-00018670: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
-00018680: 2020 2020 2076 6e2c 2072 656d 203d 2073       vn, rem = s
-00018690: 656c 662e 6173 7276 2e76 6673 2e67 6574  elf.asrv.vfs.get
-000186a0: 2874 6f70 2c20 7365 6c66 2e75 6e61 6d65  (top, self.uname
-000186b0: 2c20 5472 7565 2c20 4661 6c73 6529 0a20  , True, False). 
-000186c0: 2020 2020 2020 2020 2020 2066 7372 6f6f             fsroo
-000186d0: 742c 2076 6673 5f6c 732c 2076 6673 5f76  t, vfs_ls, vfs_v
-000186e0: 6972 7420 3d20 766e 2e6c 7328 0a20 2020  irt = vn.ls(.   
-000186f0: 2020 2020 2020 2020 2020 2020 2072 656d               rem
-00018700: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00018710: 2020 7365 6c66 2e75 6e61 6d65 2c0a 2020    self.uname,.  
-00018720: 2020 2020 2020 2020 2020 2020 2020 6e6f                no
-00018730: 7420 7365 6c66 2e61 7267 732e 6e6f 5f73  t self.args.no_s
-00018740: 6361 6e64 6972 2c0a 2020 2020 2020 2020  candir,.        
-00018750: 2020 2020 2020 2020 5b5b 5472 7565 2c20          [[True, 
-00018760: 4661 6c73 655d 2c20 5b46 616c 7365 2c20  False], [False, 
-00018770: 5472 7565 5d5d 2c0a 2020 2020 2020 2020  True]],.        
-00018780: 2020 2020 290a 2020 2020 2020 2020 6578      ).        ex
-00018790: 6365 7074 3a0a 2020 2020 2020 2020 2020  cept:.          
-000187a0: 2020 7666 735f 6c73 203d 205b 5d0a 2020    vfs_ls = [].  
-000187b0: 2020 2020 2020 2020 2020 7666 735f 7669            vfs_vi
-000187c0: 7274 203d 207b 7d0a 2020 2020 2020 2020  rt = {}.        
-000187d0: 2020 2020 666f 7220 7620 696e 2073 656c      for v in sel
-000187e0: 662e 7276 6f6c 3a0a 2020 2020 2020 2020  f.rvol:.        
-000187f0: 2020 2020 2020 2020 6431 2c20 6432 203d          d1, d2 =
-00018800: 2076 2e72 7370 6c69 7428 222f 222c 2031   v.rsplit("/", 1
-00018810: 2920 6966 2022 2f22 2069 6e20 7620 656c  ) if "/" in v el
-00018820: 7365 205b 2222 2c20 765d 0a20 2020 2020  se ["", v].     
-00018830: 2020 2020 2020 2020 2020 2069 6620 6431             if d1
-00018840: 203d 3d20 746f 703a 0a20 2020 2020 2020   == top:.       
-00018850: 2020 2020 2020 2020 2020 2020 2076 6673               vfs
-00018860: 5f76 6972 745b 6432 5d20 3d20 7365 6c66  _virt[d2] = self
-00018870: 2e61 7372 762e 7666 7320 2023 2074 7970  .asrv.vfs  # typ
-00018880: 6563 686b 2c20 7661 6c75 6520 6e65 7665  echk, value neve
-00018890: 7220 7265 6164 0a0a 2020 2020 2020 2020  r read..        
-000188a0: 6469 7273 203d 205b 5d0a 0a20 2020 2020  dirs = []..     
-000188b0: 2020 2064 6972 6e61 6d65 7320 3d20 5b78     dirnames = [x
-000188c0: 5b30 5d20 666f 7220 7820 696e 2076 6673  [0] for x in vfs
-000188d0: 5f6c 7320 6966 2073 7461 742e 535f 4953  _ls if stat.S_IS
-000188e0: 4449 5228 785b 315d 2e73 745f 6d6f 6465  DIR(x[1].st_mode
-000188f0: 295d 0a0a 2020 2020 2020 2020 6966 206e  )]..        if n
-00018900: 6f74 2073 656c 662e 6172 6773 2e65 6420  ot self.args.ed 
-00018910: 6f72 2022 646f 7473 2220 6e6f 7420 696e  or "dots" not in
-00018920: 2073 656c 662e 7570 6172 616d 3a0a 2020   self.uparam:.  
-00018930: 2020 2020 2020 2020 2020 6469 726e 616d            dirnam
-00018940: 6573 203d 2065 7863 6c75 6465 5f64 6f74  es = exclude_dot
-00018950: 6669 6c65 7328 6469 726e 616d 6573 290a  files(dirnames).
-00018960: 0a20 2020 2020 2020 2066 6f72 2066 6e20  .        for fn 
-00018970: 696e 205b 7820 666f 7220 7820 696e 2064  in [x for x in d
-00018980: 6972 6e61 6d65 7320 6966 2078 2021 3d20  irnames if x != 
-00018990: 6578 636c 5d3a 0a20 2020 2020 2020 2020  excl]:.         
-000189a0: 2020 2064 6972 732e 6170 7065 6e64 2871     dirs.append(q
-000189b0: 756f 7465 7028 666e 2929 0a0a 2020 2020  uotep(fn))..    
-000189c0: 2020 2020 666f 7220 7820 696e 2076 6673      for x in vfs
-000189d0: 5f76 6972 743a 0a20 2020 2020 2020 2020  _virt:.         
-000189e0: 2020 2069 6620 7820 213d 2065 7863 6c3a     if x != excl:
-000189f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00018a00: 2064 6972 732e 6170 7065 6e64 2878 290a   dirs.append(x).
-00018a10: 0a20 2020 2020 2020 2072 6574 5b22 6122  .        ret["a"
-00018a20: 5d20 3d20 6469 7273 0a20 2020 2020 2020  ] = dirs.       
-00018a30: 2072 6574 7572 6e20 7265 740a 0a20 2020   return ret..   
-00018a40: 2064 6566 2074 785f 7570 7328 7365 6c66   def tx_ups(self
-00018a50: 2920 203a 0a20 2020 2020 2020 2069 6620  )  :.        if 
-00018a60: 6e6f 7420 7365 6c66 2e61 7267 732e 756e  not self.args.un
-00018a70: 706f 7374 3a0a 2020 2020 2020 2020 2020  post:.          
-00018a80: 2020 7261 6973 6520 5065 626b 6163 2834    raise Pebkac(4
-00018a90: 3033 2c20 2274 6865 2075 6e70 6f73 7420  03, "the unpost 
-00018aa0: 6665 6174 7572 6520 6973 2064 6973 6162  feature is disab
-00018ab0: 6c65 6420 696e 2073 6572 7665 7220 636f  led in server co
-00018ac0: 6e66 6967 2229 0a0a 2020 2020 2020 2020  nfig")..        
-00018ad0: 6964 7820 3d20 7365 6c66 2e63 6f6e 6e2e  idx = self.conn.
-00018ae0: 6765 745f 7532 6964 7828 290a 2020 2020  get_u2idx().    
-00018af0: 2020 2020 6966 206e 6f74 2069 6478 206f      if not idx o
-00018b00: 7220 6e6f 7420 6861 7361 7474 7228 6964  r not hasattr(id
-00018b10: 782c 2022 705f 656e 6422 293a 0a20 2020  x, "p_end"):.   
-00018b20: 2020 2020 2020 2020 2072 6169 7365 2050           raise P
-00018b30: 6562 6b61 6328 3530 302c 2022 7371 6c69  ebkac(500, "sqli
-00018b40: 7465 3320 6973 206e 6f74 2061 7661 696c  te3 is not avail
-00018b50: 6162 6c65 206f 6e20 7468 6520 7365 7276  able on the serv
-00018b60: 6572 3b20 6361 6e6e 6f74 2075 6e70 6f73  er; cannot unpos
-00018b70: 7422 290a 0a20 2020 2020 2020 2066 696c  t")..        fil
-00018b80: 7420 3d20 7365 6c66 2e75 7061 7261 6d2e  t = self.uparam.
-00018b90: 6765 7428 2266 696c 7465 7222 290a 2020  get("filter").  
-00018ba0: 2020 2020 2020 6669 6c74 203d 2075 6e71        filt = unq
-00018bb0: 756f 7465 7028 6669 6c74 206f 7220 2222  uotep(filt or ""
-00018bc0: 290a 2020 2020 2020 2020 6c6d 203d 2022  ).        lm = "
-00018bd0: 7570 7320 5b7b 7d5d 222e 666f 726d 6174  ups [{}]".format
-00018be0: 2866 696c 7429 0a20 2020 2020 2020 2073  (filt).        s
-00018bf0: 656c 662e 6c6f 6728 6c6d 290a 0a20 2020  elf.log(lm)..   
-00018c00: 2020 2020 2072 6574 2020 203d 205b 5d0a       ret   = [].
-00018c10: 2020 2020 2020 2020 7430 203d 2074 696d          t0 = tim
-00018c20: 652e 7469 6d65 2829 0a20 2020 2020 2020  e.time().       
-00018c30: 206c 696d 203d 2074 696d 652e 7469 6d65   lim = time.time
-00018c40: 2829 202d 2073 656c 662e 6172 6773 2e75  () - self.args.u
-00018c50: 6e70 6f73 740a 2020 2020 2020 2020 666b  npost.        fk
-00018c60: 5f76 6f6c 7320 3d20 7b0a 2020 2020 2020  _vols = {.      
-00018c70: 2020 2020 2020 766f 6c3a 2076 6f6c 2e66        vol: vol.f
-00018c80: 6c61 6773 5b22 666b 225d 0a20 2020 2020  lags["fk"].     
-00018c90: 2020 2020 2020 2066 6f72 2076 702c 2076         for vp, v
-00018ca0: 6f6c 2069 6e20 7365 6c66 2e61 7372 762e  ol in self.asrv.
-00018cb0: 7666 732e 616c 6c5f 766f 6c73 2e69 7465  vfs.all_vols.ite
-00018cc0: 6d73 2829 0a20 2020 2020 2020 2020 2020  ms().           
-00018cd0: 2069 6620 2266 6b22 2069 6e20 766f 6c2e   if "fk" in vol.
-00018ce0: 666c 6167 7320 616e 6420 2876 7020 696e  flags and (vp in
-00018cf0: 2073 656c 662e 7276 6f6c 206f 7220 7670   self.rvol or vp
-00018d00: 2069 6e20 7365 6c66 2e75 7076 6f6c 290a   in self.upvol).
-00018d10: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
-00018d20: 2020 666f 7220 766f 6c20 696e 2073 656c    for vol in sel
-00018d30: 662e 6173 7276 2e76 6673 2e61 6c6c 5f76  f.asrv.vfs.all_v
-00018d40: 6f6c 732e 7661 6c75 6573 2829 3a0a 2020  ols.values():.  
-00018d50: 2020 2020 2020 2020 2020 6375 7220 3d20            cur = 
-00018d60: 6964 782e 6765 745f 6375 7228 766f 6c2e  idx.get_cur(vol.
-00018d70: 7265 616c 7061 7468 290a 2020 2020 2020  realpath).      
-00018d80: 2020 2020 2020 6966 206e 6f74 2063 7572        if not cur
-00018d90: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00018da0: 2020 636f 6e74 696e 7565 0a0a 2020 2020    continue..    
-00018db0: 2020 2020 2020 2020 6e66 6b20 3d20 666b          nfk = fk
-00018dc0: 5f76 6f6c 732e 6765 7428 766f 6c2c 2030  _vols.get(vol, 0
-00018dd0: 290a 0a20 2020 2020 2020 2020 2020 2071  )..            q
-00018de0: 203d 2022 7365 6c65 6374 2073 7a2c 2072   = "select sz, r
-00018df0: 642c 2066 6e2c 2061 7420 6672 6f6d 2075  d, fn, at from u
-00018e00: 7020 7768 6572 6520 6970 3d3f 2061 6e64  p where ip=? and
-00018e10: 2061 743e 3f22 0a20 2020 2020 2020 2020   at>?".         
-00018e20: 2020 2066 6f72 2073 7a2c 2072 642c 2066     for sz, rd, f
-00018e30: 6e2c 2061 7420 696e 2063 7572 2e65 7865  n, at in cur.exe
-00018e40: 6375 7465 2871 2c20 2873 656c 662e 6970  cute(q, (self.ip
-00018e50: 2c20 6c69 6d29 293a 0a20 2020 2020 2020  , lim)):.       
-00018e60: 2020 2020 2020 2020 2076 7020 3d20 222f           vp = "/
-00018e70: 2220 2b20 222f 222e 6a6f 696e 2878 2066  " + "/".join(x f
-00018e80: 6f72 2078 2069 6e20 5b76 6f6c 2e76 7061  or x in [vol.vpa
-00018e90: 7468 2c20 7264 2c20 666e 5d20 6966 2078  th, rd, fn] if x
-00018ea0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00018eb0: 2020 6966 2066 696c 7420 616e 6420 6669    if filt and fi
-00018ec0: 6c74 206e 6f74 2069 6e20 7670 3a0a 2020  lt not in vp:.  
-00018ed0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018ee0: 2020 636f 6e74 696e 7565 0a0a 2020 2020    continue..    
-00018ef0: 2020 2020 2020 2020 2020 2020 7276 203d              rv =
-00018f00: 207b 2276 7022 3a20 7175 6f74 6570 2876   {"vp": quotep(v
-00018f10: 7029 2c20 2273 7a22 3a20 737a 2c20 2261  p), "sz": sz, "a
-00018f20: 7422 3a20 6174 2c20 226e 666b 223a 206e  t": at, "nfk": n
-00018f30: 666b 7d0a 2020 2020 2020 2020 2020 2020  fk}.            
-00018f40: 2020 2020 6966 206e 666b 3a0a 2020 2020      if nfk:.    
-00018f50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018f60: 7276 5b22 6170 225d 203d 2076 6f6c 2e63  rv["ap"] = vol.c
-00018f70: 616e 6f6e 6963 616c 2876 6a6f 696e 2872  anonical(vjoin(r
-00018f80: 642c 2066 6e29 290a 0a20 2020 2020 2020  d, fn))..       
-00018f90: 2020 2020 2020 2020 2072 6574 2e61 7070           ret.app
-00018fa0: 656e 6428 7276 290a 2020 2020 2020 2020  end(rv).        
-00018fb0: 2020 2020 2020 2020 6966 206c 656e 2872          if len(r
-00018fc0: 6574 2920 3e20 3330 3030 3a0a 2020 2020  et) > 3000:.    
-00018fd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018fe0: 7265 742e 736f 7274 286b 6579 3d6c 616d  ret.sort(key=lam
-00018ff0: 6264 6120 783a 2078 5b22 6174 225d 2c20  bda x: x["at"], 
-00019000: 7265 7665 7273 653d 5472 7565 2920 2023  reverse=True)  #
-00019010: 2074 7970 653a 2069 676e 6f72 650a 2020   type: ignore.  
-00019020: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019030: 2020 7265 7420 3d20 7265 745b 3a32 3030    ret = ret[:200
-00019040: 305d 0a0a 2020 2020 2020 2020 7265 742e  0]..        ret.
-00019050: 736f 7274 286b 6579 3d6c 616d 6264 6120  sort(key=lambda 
-00019060: 783a 2078 5b22 6174 225d 2c20 7265 7665  x: x["at"], reve
-00019070: 7273 653d 5472 7565 2920 2023 2074 7970  rse=True)  # typ
-00019080: 653a 2069 676e 6f72 650a 2020 2020 2020  e: ignore.      
-00019090: 2020 6e20 3d20 300a 2020 2020 2020 2020    n = 0.        
-000190a0: 666f 7220 7276 2069 6e20 7265 745b 3a31  for rv in ret[:1
-000190b0: 3130 3030 5d3a 0a20 2020 2020 2020 2020  1000]:.         
-000190c0: 2020 206e 666b 203d 2072 762e 706f 7028     nfk = rv.pop(
-000190d0: 226e 666b 2229 0a20 2020 2020 2020 2020  "nfk").         
-000190e0: 2020 2069 6620 6e6f 7420 6e66 6b3a 0a20     if not nfk:. 
-000190f0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-00019100: 6f6e 7469 6e75 650a 0a20 2020 2020 2020  ontinue..       
-00019110: 2020 2020 2061 7020 3d20 7276 2e70 6f70       ap = rv.pop
-00019120: 2822 6170 2229 0a20 2020 2020 2020 2020  ("ap").         
-00019130: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
-00019140: 2020 2020 2020 2020 7374 203d 2062 6f73          st = bos
-00019150: 2e73 7461 7428 6170 290a 2020 2020 2020  .stat(ap).      
-00019160: 2020 2020 2020 6578 6365 7074 3a0a 2020        except:.  
-00019170: 2020 2020 2020 2020 2020 2020 2020 636f                co
-00019180: 6e74 696e 7565 0a0a 2020 2020 2020 2020  ntinue..        
-00019190: 2020 2020 666b 203d 2073 656c 662e 6765      fk = self.ge
-000191a0: 6e5f 666b 280a 2020 2020 2020 2020 2020  n_fk(.          
-000191b0: 2020 2020 2020 7365 6c66 2e61 7267 732e        self.args.
-000191c0: 666b 5f73 616c 742c 2061 702c 2073 742e  fk_salt, ap, st.
-000191d0: 7374 5f73 697a 652c 2030 2069 6620 414e  st_size, 0 if AN
-000191e0: 5957 494e 2065 6c73 6520 7374 2e73 745f  YWIN else st.st_
-000191f0: 696e 6f0a 2020 2020 2020 2020 2020 2020  ino.            
-00019200: 290a 2020 2020 2020 2020 2020 2020 7276  ).            rv
-00019210: 5b22 7670 225d 202b 3d20 223f 6b3d 2220  ["vp"] += "?k=" 
-00019220: 2b20 666b 5b3a 6e66 6b5d 0a0a 2020 2020  + fk[:nfk]..    
-00019230: 2020 2020 2020 2020 6e20 2b3d 2031 0a20          n += 1. 
-00019240: 2020 2020 2020 2020 2020 2069 6620 6e20             if n 
-00019250: 3e20 3230 3030 3a0a 2020 2020 2020 2020  > 2000:.        
-00019260: 2020 2020 2020 2020 6272 6561 6b0a 0a20          break.. 
-00019270: 2020 2020 2020 2072 6574 203d 2072 6574         ret = ret
-00019280: 5b3a 3230 3030 5d0a 0a20 2020 2020 2020  [:2000]..       
-00019290: 2069 6620 7365 6c66 2e69 735f 7670 726f   if self.is_vpro
-000192a0: 7869 6564 3a0a 2020 2020 2020 2020 2020  xied:.          
-000192b0: 2020 666f 7220 7620 696e 2072 6574 3a0a    for v in ret:.
-000192c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000192d0: 765b 2276 7022 5d20 3d20 7365 6c66 2e61  v["vp"] = self.a
-000192e0: 7267 732e 5352 202b 2076 5b22 7670 225d  rgs.SR + v["vp"]
-000192f0: 0a0a 2020 2020 2020 2020 6a74 7874 203d  ..        jtxt =
-00019300: 206a 736f 6e2e 6475 6d70 7328 7265 742c   json.dumps(ret,
-00019310: 2069 6e64 656e 743d 322c 2073 6f72 745f   indent=2, sort_
-00019320: 6b65 7973 3d54 7275 6529 2e65 6e63 6f64  keys=True).encod
-00019330: 6528 2275 7466 2d38 222c 2022 7265 706c  e("utf-8", "repl
-00019340: 6163 6522 290a 2020 2020 2020 2020 7365  ace").        se
-00019350: 6c66 2e6c 6f67 2822 7b7d 2023 7b7d 207b  lf.log("{} #{} {
-00019360: 3a2e 3266 7d73 6563 222e 666f 726d 6174  :.2f}sec".format
-00019370: 286c 6d2c 206c 656e 2872 6574 292c 2074  (lm, len(ret), t
-00019380: 696d 652e 7469 6d65 2829 202d 2074 3029  ime.time() - t0)
-00019390: 290a 2020 2020 2020 2020 7365 6c66 2e72  ).        self.r
-000193a0: 6570 6c79 286a 7478 742c 206d 696d 653d  eply(jtxt, mime=
-000193b0: 2261 7070 6c69 6361 7469 6f6e 2f6a 736f  "application/jso
-000193c0: 6e22 290a 2020 2020 2020 2020 7265 7475  n").        retu
-000193d0: 726e 2054 7275 650a 0a20 2020 2064 6566  rn True..    def
-000193e0: 2068 616e 646c 655f 726d 2873 656c 662c   handle_rm(self,
-000193f0: 2072 6571 2029 2020 3a0a 2020 2020 2020   req )  :.      
-00019400: 2020 6966 206e 6f74 2072 6571 2061 6e64    if not req and
-00019410: 206e 6f74 2073 656c 662e 6361 6e5f 6465   not self.can_de
-00019420: 6c65 7465 3a0a 2020 2020 2020 2020 2020  lete:.          
-00019430: 2020 7261 6973 6520 5065 626b 6163 2834    raise Pebkac(4
-00019440: 3033 2c20 226e 6f74 2061 6c6c 6f77 6564  03, "not allowed
-00019450: 2066 6f72 2075 7365 7220 2220 2b20 7365   for user " + se
-00019460: 6c66 2e75 6e61 6d65 290a 0a20 2020 2020  lf.uname)..     
-00019470: 2020 2069 6620 7365 6c66 2e61 7267 732e     if self.args.
-00019480: 6e6f 5f64 656c 3a0a 2020 2020 2020 2020  no_del:.        
-00019490: 2020 2020 7261 6973 6520 5065 626b 6163      raise Pebkac
-000194a0: 2834 3033 2c20 2274 6865 2064 656c 6574  (403, "the delet
-000194b0: 6520 6665 6174 7572 6520 6973 2064 6973  e feature is dis
-000194c0: 6162 6c65 6420 696e 2073 6572 7665 7220  abled in server 
-000194d0: 636f 6e66 6967 2229 0a0a 2020 2020 2020  config")..      
-000194e0: 2020 6966 206e 6f74 2072 6571 3a0a 2020    if not req:.  
-000194f0: 2020 2020 2020 2020 2020 7265 7120 3d20            req = 
-00019500: 5b73 656c 662e 7670 6174 685d 0a20 2020  [self.vpath].   
-00019510: 2020 2020 2065 6c69 6620 7365 6c66 2e69       elif self.i
-00019520: 735f 7670 726f 7869 6564 3a0a 2020 2020  s_vproxied:.    
-00019530: 2020 2020 2020 2020 7265 7120 3d20 5b78          req = [x
-00019540: 5b6c 656e 2873 656c 662e 6172 6773 2e53  [len(self.args.S
-00019550: 5229 203a 5d20 666f 7220 7820 696e 2072  R) :] for x in r
-00019560: 6571 5d0a 0a20 2020 2020 2020 206e 6c69  eq]..        nli
-00019570: 6d20 3d20 696e 7428 7365 6c66 2e75 7061  m = int(self.upa
-00019580: 7261 6d2e 6765 7428 226c 696d 2229 206f  ram.get("lim") o
-00019590: 7220 3029 0a20 2020 2020 2020 206c 696d  r 0).        lim
-000195a0: 203d 205b 6e6c 696d 2c20 6e6c 696d 5d20   = [nlim, nlim] 
-000195b0: 6966 206e 6c69 6d20 656c 7365 205b 5d0a  if nlim else [].
-000195c0: 0a20 2020 2020 2020 2078 203d 2073 656c  .        x = sel
-000195d0: 662e 636f 6e6e 2e68 7372 762e 6272 6f6b  f.conn.hsrv.brok
-000195e0: 6572 2e61 736b 280a 2020 2020 2020 2020  er.ask(.        
-000195f0: 2020 2020 2275 7032 6b2e 6861 6e64 6c65      "up2k.handle
-00019600: 5f72 6d22 2c20 7365 6c66 2e75 6e61 6d65  _rm", self.uname
-00019610: 2c20 7365 6c66 2e69 702c 2072 6571 2c20  , self.ip, req, 
-00019620: 6c69 6d2c 2046 616c 7365 0a20 2020 2020  lim, False.     
-00019630: 2020 2029 0a20 2020 2020 2020 2073 656c     ).        sel
-00019640: 662e 6c6f 7564 5f72 6570 6c79 2878 2e67  f.loud_reply(x.g
-00019650: 6574 2829 290a 2020 2020 2020 2020 7265  et()).        re
-00019660: 7475 726e 2054 7275 650a 0a20 2020 2064  turn True..    d
-00019670: 6566 2068 616e 646c 655f 6d76 2873 656c  ef handle_mv(sel
-00019680: 6629 2020 3a0a 2020 2020 2020 2020 2320  f)  :.        # 
-00019690: 6675 6c6c 2070 6174 6820 6f66 206e 6577  full path of new
-000196a0: 206c 6f63 2028 696e 636c 2066 696c 656e   loc (incl filen
-000196b0: 616d 6529 0a20 2020 2020 2020 2064 7374  ame).        dst
-000196c0: 203d 2073 656c 662e 7570 6172 616d 2e67   = self.uparam.g
-000196d0: 6574 2822 6d6f 7665 2229 0a0a 2020 2020  et("move")..    
-000196e0: 2020 2020 6966 2073 656c 662e 6973 5f76      if self.is_v
-000196f0: 7072 6f78 6965 6420 616e 6420 6473 7420  proxied and dst 
-00019700: 616e 6420 6473 742e 7374 6172 7473 7769  and dst.startswi
-00019710: 7468 2873 656c 662e 6172 6773 2e53 5229  th(self.args.SR)
-00019720: 3a0a 2020 2020 2020 2020 2020 2020 6473  :.            ds
-00019730: 7420 3d20 6473 745b 6c65 6e28 7365 6c66  t = dst[len(self
-00019740: 2e61 7267 732e 5253 2920 3a5d 0a0a 2020  .args.RS) :]..  
-00019750: 2020 2020 2020 6966 206e 6f74 2064 7374        if not dst
-00019760: 3a0a 2020 2020 2020 2020 2020 2020 7261  :.            ra
-00019770: 6973 6520 5065 626b 6163 2834 3030 2c20  ise Pebkac(400, 
-00019780: 226e 6565 6420 6473 7420 7670 6174 6822  "need dst vpath"
-00019790: 290a 0a20 2020 2020 2020 2023 2078 2d77  )..        # x-w
-000197a0: 7777 2d66 6f72 6d2d 7572 6c65 6e63 6f64  ww-form-urlencod
-000197b0: 6564 2028 7572 6c20 7175 6572 7920 7061  ed (url query pa
-000197c0: 7274 2920 7573 6573 0a20 2020 2020 2020  rt) uses.       
-000197d0: 2023 2065 6974 6865 7220 2b20 6f72 2025   # either + or %
-000197e0: 3230 2066 6f72 2030 7832 3020 736f 2068  20 for 0x20 so h
-000197f0: 616e 646c 6520 626f 7468 0a20 2020 2020  andle both.     
-00019800: 2020 2064 7374 203d 2075 6e71 756f 7465     dst = unquote
-00019810: 7028 6473 742e 7265 706c 6163 6528 222b  p(dst.replace("+
-00019820: 222c 2022 2022 2929 0a20 2020 2020 2020  ", " ")).       
-00019830: 2072 6574 7572 6e20 7365 6c66 2e5f 6d76   return self._mv
-00019840: 2873 656c 662e 7670 6174 682c 2064 7374  (self.vpath, dst
-00019850: 2e6c 7374 7269 7028 222f 2229 290a 0a20  .lstrip("/")).. 
-00019860: 2020 2064 6566 205f 6d76 2873 656c 662c     def _mv(self,
-00019870: 2076 7372 6320 2c20 7664 7374 2029 2020   vsrc , vdst )  
-00019880: 3a0a 2020 2020 2020 2020 6966 206e 6f74  :.        if not
-00019890: 2073 656c 662e 6361 6e5f 6d6f 7665 3a0a   self.can_move:.
-000198a0: 2020 2020 2020 2020 2020 2020 7261 6973              rais
-000198b0: 6520 5065 626b 6163 2834 3033 2c20 226e  e Pebkac(403, "n
-000198c0: 6f74 2061 6c6c 6f77 6564 2066 6f72 2075  ot allowed for u
-000198d0: 7365 7220 2220 2b20 7365 6c66 2e75 6e61  ser " + self.una
-000198e0: 6d65 290a 0a20 2020 2020 2020 2069 6620  me)..        if 
-000198f0: 7365 6c66 2e61 7267 732e 6e6f 5f6d 763a  self.args.no_mv:
-00019900: 0a20 2020 2020 2020 2020 2020 2072 6169  .            rai
-00019910: 7365 2050 6562 6b61 6328 3430 332c 2022  se Pebkac(403, "
-00019920: 7468 6520 7265 6e61 6d65 2f6d 6f76 6520  the rename/move 
-00019930: 6665 6174 7572 6520 6973 2064 6973 6162  feature is disab
-00019940: 6c65 6420 696e 2073 6572 7665 7220 636f  led in server co
-00019950: 6e66 6967 2229 0a0a 2020 2020 2020 2020  nfig")..        
-00019960: 7820 3d20 7365 6c66 2e63 6f6e 6e2e 6873  x = self.conn.hs
-00019970: 7276 2e62 726f 6b65 722e 6173 6b28 2275  rv.broker.ask("u
-00019980: 7032 6b2e 6861 6e64 6c65 5f6d 7622 2c20  p2k.handle_mv", 
-00019990: 7365 6c66 2e75 6e61 6d65 2c20 7673 7263  self.uname, vsrc
-000199a0: 2c20 7664 7374 290a 2020 2020 2020 2020  , vdst).        
-000199b0: 7365 6c66 2e6c 6f75 645f 7265 706c 7928  self.loud_reply(
-000199c0: 782e 6765 7428 292c 2073 7461 7475 733d  x.get(), status=
-000199d0: 3230 3129 0a20 2020 2020 2020 2072 6574  201).        ret
-000199e0: 7572 6e20 5472 7565 0a0a 2020 2020 6465  urn True..    de
-000199f0: 6620 7478 5f6c 7328 7365 6c66 2c20 6c73  f tx_ls(self, ls
-00019a00: 2020 2920 203a 0a20 2020 2020 2020 2064    )  :.        d
-00019a10: 6972 7320 3d20 6c73 5b22 6469 7273 225d  irs = ls["dirs"]
-00019a20: 0a20 2020 2020 2020 2066 696c 6573 203d  .        files =
-00019a30: 206c 735b 2266 696c 6573 225d 0a20 2020   ls["files"].   
-00019a40: 2020 2020 2061 7267 203d 2073 656c 662e       arg = self.
-00019a50: 7570 6172 616d 5b22 6c73 225d 0a20 2020  uparam["ls"].   
-00019a60: 2020 2020 2069 6620 6172 6720 696e 205b       if arg in [
-00019a70: 2276 222c 2022 7422 2c20 2274 7874 225d  "v", "t", "txt"]
-00019a80: 3a0a 2020 2020 2020 2020 2020 2020 7472  :.            tr
-00019a90: 793a 0a20 2020 2020 2020 2020 2020 2020  y:.             
-00019aa0: 2020 2062 6967 6765 7374 203d 206d 6178     biggest = max
-00019ab0: 286c 735b 2266 696c 6573 225d 202b 206c  (ls["files"] + l
-00019ac0: 735b 2264 6972 7322 5d2c 206b 6579 3d69  s["dirs"], key=i
-00019ad0: 7465 6d67 6574 7465 7228 2273 7a22 2929  temgetter("sz"))
-00019ae0: 5b22 737a 225d 0a20 2020 2020 2020 2020  ["sz"].         
-00019af0: 2020 2065 7863 6570 743a 0a20 2020 2020     except:.     
-00019b00: 2020 2020 2020 2020 2020 2062 6967 6765             bigge
-00019b10: 7374 203d 2030 0a0a 2020 2020 2020 2020  st = 0..        
-00019b20: 2020 2020 6966 2061 7267 203d 3d20 2276      if arg == "v
-00019b30: 223a 0a20 2020 2020 2020 2020 2020 2020  ":.             
-00019b40: 2020 2066 6d74 203d 2022 5c30 3333 5b30     fmt = "\033[0
-00019b50: 3b37 3b33 366d 7b7b 7d7d 7b7b 3a3e 7b7d  ;7;36m{{}}{{:>{}
-00019b60: 7d7d 5c30 3333 5b30 6d20 7b7b 7d7d 220a  }}\033[0m {{}}".
-00019b70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019b80: 6e66 6d74 203d 2022 7b7d 220a 2020 2020  nfmt = "{}".    
-00019b90: 2020 2020 2020 2020 2020 2020 6269 6767              bigg
-00019ba0: 6573 7420 3d20 300a 2020 2020 2020 2020  est = 0.        
-00019bb0: 2020 2020 2020 2020 6632 203d 2022 222e          f2 = "".
-00019bc0: 6a6f 696e 280a 2020 2020 2020 2020 2020  join(.          
-00019bd0: 2020 2020 2020 2020 2020 227b 7d7b 7b7d            "{}{{}
-00019be0: 7d22 2e66 6f72 6d61 7428 7829 0a20 2020  }".format(x).   
-00019bf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019c00: 2066 6f72 2078 2069 6e20 5b0a 2020 2020   for x in [.    
-00019c10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019c20: 2020 2020 225c 3033 335b 376d 222c 0a20      "\033[7m",. 
+00011c70: 2020 2020 2020 2074 203d 2022 7570 6c6f         t = "uplo
+00011c80: 6164 2062 6c6f 636b 6564 2062 7920 7861  ad blocked by xa
+00011c90: 7520 7365 7276 6572 2063 6f6e 6669 6722  u server config"
+00011ca0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00011cb0: 2020 2020 2020 2020 2073 656c 662e 6c6f           self.lo
+00011cc0: 6728 742c 2031 290a 2020 2020 2020 2020  g(t, 1).        
+00011cd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011ce0: 6f73 2e75 6e6c 696e 6b28 6162 7370 6174  os.unlink(abspat
+00011cf0: 6829 0a20 2020 2020 2020 2020 2020 2020  h).             
+00011d00: 2020 2020 2020 2020 2020 2072 6169 7365             raise
+00011d10: 2050 6562 6b61 6328 3430 332c 2074 290a   Pebkac(403, t).
+00011d20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00011d30: 2020 2020 2064 6276 2c20 7672 656d 203d       dbv, vrem =
+00011d40: 2076 6673 2e67 6574 5f64 6276 2872 656d   vfs.get_dbv(rem
+00011d50: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00011d60: 2020 2020 2020 7365 6c66 2e63 6f6e 6e2e        self.conn.
+00011d70: 6873 7276 2e62 726f 6b65 722e 7361 7928  hsrv.broker.say(
+00011d80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00011d90: 2020 2020 2020 2020 2022 7570 326b 2e68           "up2k.h
+00011da0: 6173 685f 6669 6c65 222c 0a20 2020 2020  ash_file",.     
+00011db0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011dc0: 2020 2064 6276 2e72 6561 6c70 6174 682c     dbv.realpath,
+00011dd0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00011de0: 2020 2020 2020 2020 2076 6673 2e76 7061           vfs.vpa
+00011df0: 7468 2c0a 2020 2020 2020 2020 2020 2020  th,.            
+00011e00: 2020 2020 2020 2020 2020 2020 6462 762e              dbv.
+00011e10: 666c 6167 732c 0a20 2020 2020 2020 2020  flags,.         
+00011e20: 2020 2020 2020 2020 2020 2020 2020 2076                 v
+00011e30: 7265 6d2c 0a20 2020 2020 2020 2020 2020  rem,.           
+00011e40: 2020 2020 2020 2020 2020 2020 2066 6e61               fna
+00011e50: 6d65 2c0a 2020 2020 2020 2020 2020 2020  me,.            
+00011e60: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+00011e70: 2e69 702c 0a20 2020 2020 2020 2020 2020  .ip,.           
+00011e80: 2020 2020 2020 2020 2020 2020 2061 742c               at,
+00011e90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00011ea0: 2020 2020 2020 2020 2073 656c 662e 756e           self.un
+00011eb0: 616d 652c 0a20 2020 2020 2020 2020 2020  ame,.           
+00011ec0: 2020 2020 2020 2020 2020 2020 2054 7275               Tru
+00011ed0: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
+00011ee0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+00011ef0: 2020 2020 2020 2020 2020 2020 2073 656c               sel
+00011f00: 662e 636f 6e6e 2e6e 6279 7465 202b 3d20  f.conn.nbyte += 
+00011f10: 737a 0a0a 2020 2020 2020 2020 2020 2020  sz..            
+00011f20: 2020 2020 6578 6365 7074 2050 6562 6b61      except Pebka
+00011f30: 633a 0a20 2020 2020 2020 2020 2020 2020  c:.             
+00011f40: 2020 2020 2020 2073 656c 662e 7061 7273         self.pars
+00011f50: 6572 2e64 726f 7028 290a 2020 2020 2020  er.drop().      
+00011f60: 2020 2020 2020 2020 2020 2020 2020 7261                ra
+00011f70: 6973 650a 0a20 2020 2020 2020 2065 7863  ise..        exc
+00011f80: 6570 7420 5065 626b 6163 2061 7320 6578  ept Pebkac as ex
+00011f90: 3a0a 2020 2020 2020 2020 2020 2020 6572  :.            er
+00011fa0: 726d 7367 203d 2076 6f6c 5f73 616e 280a  rmsg = vol_san(.
+00011fb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011fc0: 6c69 7374 2873 656c 662e 6173 7276 2e76  list(self.asrv.v
+00011fd0: 6673 2e61 6c6c 5f76 6f6c 732e 7661 6c75  fs.all_vols.valu
+00011fe0: 6573 2829 292c 2075 6e69 636f 6465 2865  es()), unicode(e
+00011ff0: 7829 2e65 6e63 6f64 6528 2275 7466 2d38  x).encode("utf-8
+00012000: 2229 0a20 2020 2020 2020 2020 2020 2029  ").            )
+00012010: 2e64 6563 6f64 6528 2275 7466 2d38 2229  .decode("utf-8")
+00012020: 0a0a 2020 2020 2020 2020 7464 203d 206d  ..        td = m
+00012030: 6178 2830 2e31 2c20 7469 6d65 2e74 696d  ax(0.1, time.tim
+00012040: 6528 2920 2d20 7430 290a 2020 2020 2020  e() - t0).      
+00012050: 2020 737a 5f74 6f74 616c 203d 2073 756d    sz_total = sum
+00012060: 2878 5b30 5d20 666f 7220 7820 696e 2066  (x[0] for x in f
+00012070: 696c 6573 290a 2020 2020 2020 2020 7370  iles).        sp
+00012080: 6420 3d20 2873 7a5f 746f 7461 6c20 2f20  d = (sz_total / 
+00012090: 7464 2920 2f20 2831 3032 3420 2a20 3130  td) / (1024 * 10
+000120a0: 3234 290a 0a20 2020 2020 2020 2073 7461  24)..        sta
+000120b0: 7475 7320 3d20 224f 4b22 0a20 2020 2020  tus = "OK".     
+000120c0: 2020 2069 6620 6572 726d 7367 3a0a 2020     if errmsg:.  
+000120d0: 2020 2020 2020 2020 2020 7365 6c66 2e6c            self.l
+000120e0: 6f67 2865 7272 6d73 672c 2033 290a 2020  og(errmsg, 3).  
+000120f0: 2020 2020 2020 2020 2020 7374 6174 7573            status
+00012100: 203d 2022 4552 524f 5222 0a0a 2020 2020   = "ERROR"..    
+00012110: 2020 2020 6d73 6720 3d20 227b 7d20 2f2f      msg = "{} //
+00012120: 207b 7d20 6279 7465 7320 2f2f 207b 3a2e   {} bytes // {:.
+00012130: 3366 7d20 4d69 422f 735c 6e22 2e66 6f72  3f} MiB/s\n".for
+00012140: 6d61 7428 7374 6174 7573 2c20 737a 5f74  mat(status, sz_t
+00012150: 6f74 616c 2c20 7370 6429 0a20 2020 2020  otal, spd).     
+00012160: 2020 206a 6d73 6720 2020 3d20 7b0a 2020     jmsg   = {.  
+00012170: 2020 2020 2020 2020 2020 2273 7461 7475            "statu
+00012180: 7322 3a20 7374 6174 7573 2c0a 2020 2020  s": status,.    
+00012190: 2020 2020 2020 2020 2273 7a22 3a20 737a          "sz": sz
+000121a0: 5f74 6f74 616c 2c0a 2020 2020 2020 2020  _total,.        
+000121b0: 2020 2020 226d 6270 7322 3a20 726f 756e      "mbps": roun
+000121c0: 6428 7370 642c 2033 292c 0a20 2020 2020  d(spd, 3),.     
+000121d0: 2020 2020 2020 2022 6669 6c65 7322 3a20         "files": 
+000121e0: 5b5d 2c0a 2020 2020 2020 2020 7d0a 0a20  [],.        }.. 
+000121f0: 2020 2020 2020 2069 6620 6572 726d 7367         if errmsg
+00012200: 3a0a 2020 2020 2020 2020 2020 2020 6d73  :.            ms
+00012210: 6720 2b3d 2065 7272 6d73 6720 2b20 225c  g += errmsg + "\
+00012220: 6e22 0a20 2020 2020 2020 2020 2020 206a  n".            j
+00012230: 6d73 675b 2265 7272 6f72 225d 203d 2065  msg["error"] = e
+00012240: 7272 6d73 670a 2020 2020 2020 2020 2020  rrmsg.          
+00012250: 2020 6572 726d 7367 203d 2022 4552 524f    errmsg = "ERRO
+00012260: 523a 2022 202b 2065 7272 6d73 670a 0a20  R: " + errmsg.. 
+00012270: 2020 2020 2020 2066 6f72 2073 7a2c 2073         for sz, s
+00012280: 6861 5f68 6578 2c20 7368 615f 6236 342c  ha_hex, sha_b64,
+00012290: 206f 666e 2c20 6c66 6e2c 2061 7020 696e   ofn, lfn, ap in
+000122a0: 2066 696c 6573 3a0a 2020 2020 2020 2020   files:.        
+000122b0: 2020 2020 7673 7566 203d 2022 220a 2020      vsuf = "".  
+000122c0: 2020 2020 2020 2020 2020 6966 2028 7365            if (se
+000122d0: 6c66 2e63 616e 5f72 6561 6420 6f72 2073  lf.can_read or s
+000122e0: 656c 662e 6361 6e5f 7570 6765 7429 2061  elf.can_upget) a
+000122f0: 6e64 2022 666b 2220 696e 2076 6673 2e66  nd "fk" in vfs.f
+00012300: 6c61 6773 3a0a 2020 2020 2020 2020 2020  lags:.          
+00012310: 2020 2020 2020 7673 7566 203d 2022 3f6b        vsuf = "?k
+00012320: 3d22 202b 2073 656c 662e 6765 6e5f 666b  =" + self.gen_fk
+00012330: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00012340: 2020 2020 2020 7365 6c66 2e61 7267 732e        self.args.
+00012350: 666b 5f73 616c 742c 0a20 2020 2020 2020  fk_salt,.       
+00012360: 2020 2020 2020 2020 2020 2020 2061 702c               ap,
+00012370: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00012380: 2020 2020 2073 7a2c 0a20 2020 2020 2020       sz,.       
+00012390: 2020 2020 2020 2020 2020 2020 2030 2069               0 i
+000123a0: 6620 414e 5957 494e 206f 7220 6e6f 7420  f ANYWIN or not 
+000123b0: 6170 2065 6c73 6520 626f 732e 7374 6174  ap else bos.stat
+000123c0: 2861 7029 2e73 745f 696e 6f2c 0a20 2020  (ap).st_ino,.   
+000123d0: 2020 2020 2020 2020 2020 2020 2029 5b3a               )[:
+000123e0: 2076 6673 2e66 6c61 6773 5b22 666b 225d   vfs.flags["fk"]
+000123f0: 5d0a 0a20 2020 2020 2020 2020 2020 2076  ]..            v
+00012400: 7061 7468 203d 2022 7b7d 2f7b 7d22 2e66  path = "{}/{}".f
+00012410: 6f72 6d61 7428 7570 6c6f 6164 5f76 7061  ormat(upload_vpa
+00012420: 7468 2c20 6c66 6e29 2e73 7472 6970 2822  th, lfn).strip("
+00012430: 2f22 290a 2020 2020 2020 2020 2020 2020  /").            
+00012440: 7265 6c5f 7572 6c20 3d20 7175 6f74 6570  rel_url = quotep
+00012450: 2873 656c 662e 6172 6773 2e52 5320 2b20  (self.args.RS + 
+00012460: 7670 6174 6829 202b 2076 7375 660a 2020  vpath) + vsuf.  
+00012470: 2020 2020 2020 2020 2020 6d73 6720 2b3d            msg +=
+00012480: 2027 7368 6135 3132 3a20 7b7d 202f 2f20   'sha512: {} // 
+00012490: 7b7d 202f 2f20 7b7d 2062 7974 6573 202f  {} // {} bytes /
+000124a0: 2f20 3c61 2068 7265 663d 222f 7b7d 223e  / <a href="/{}">
+000124b0: 7b7d 3c2f 613e 207b 7d5c 6e27 2e66 6f72  {}</a> {}\n'.for
+000124c0: 6d61 7428 0a20 2020 2020 2020 2020 2020  mat(.           
+000124d0: 2020 2020 2073 6861 5f68 6578 5b3a 3536       sha_hex[:56
+000124e0: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
+000124f0: 2020 2073 6861 5f62 3634 2c0a 2020 2020     sha_b64,.    
+00012500: 2020 2020 2020 2020 2020 2020 737a 2c0a              sz,.
+00012510: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012520: 7265 6c5f 7572 6c2c 0a20 2020 2020 2020  rel_url,.       
+00012530: 2020 2020 2020 2020 2068 746d 6c5f 6573           html_es
+00012540: 6361 7065 286f 666e 2c20 6372 6c66 3d54  cape(ofn, crlf=T
+00012550: 7275 6529 2c0a 2020 2020 2020 2020 2020  rue),.          
+00012560: 2020 2020 2020 7673 7566 2c0a 2020 2020        vsuf,.    
+00012570: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+00012580: 2020 2020 2020 2320 7472 756e 6361 7465        # truncate
+00012590: 6420 5348 412d 3531 3220 7072 6576 656e  d SHA-512 preven
+000125a0: 7473 206c 656e 6774 6820 6578 7465 6e73  ts length extens
+000125b0: 696f 6e20 6174 7461 636b 733b 0a20 2020  ion attacks;.   
+000125c0: 2020 2020 2020 2020 2023 2075 7369 6e67           # using
+000125d0: 2053 4841 2d35 3132 2f32 3234 2c20 6f70   SHA-512/224, op
+000125e0: 7469 6f6e 616c 6c79 2053 4841 2d35 3132  tionally SHA-512
+000125f0: 2f32 3536 203d 203a 3634 0a20 2020 2020  /256 = :64.     
+00012600: 2020 2020 2020 206a 7061 7274 203d 207b         jpart = {
+00012610: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00012620: 2022 7572 6c22 3a20 227b 7d3a 2f2f 7b7d   "url": "{}://{}
+00012630: 2f7b 7d22 2e66 6f72 6d61 7428 0a20 2020  /{}".format(.   
+00012640: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012650: 2022 6874 7470 7322 2069 6620 7365 6c66   "https" if self
+00012660: 2e69 735f 6874 7470 7320 656c 7365 2022  .is_https else "
+00012670: 6874 7470 222c 0a20 2020 2020 2020 2020  http",.         
+00012680: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+00012690: 686f 7374 2c0a 2020 2020 2020 2020 2020  host,.          
+000126a0: 2020 2020 2020 2020 2020 7265 6c5f 7572            rel_ur
+000126b0: 6c2c 0a20 2020 2020 2020 2020 2020 2020  l,.             
+000126c0: 2020 2029 2c0a 2020 2020 2020 2020 2020     ),.          
+000126d0: 2020 2020 2020 2273 6861 3531 3222 3a20        "sha512": 
+000126e0: 7368 615f 6865 785b 3a35 365d 2c0a 2020  sha_hex[:56],.  
+000126f0: 2020 2020 2020 2020 2020 2020 2020 2273                "s
+00012700: 6861 5f62 3634 223a 2073 6861 5f62 3634  ha_b64": sha_b64
+00012710: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00012720: 2020 2273 7a22 3a20 737a 2c0a 2020 2020    "sz": sz,.    
+00012730: 2020 2020 2020 2020 2020 2020 2266 6e22              "fn"
+00012740: 3a20 6c66 6e2c 0a20 2020 2020 2020 2020  : lfn,.         
+00012750: 2020 2020 2020 2022 666e 5f6f 7269 6722         "fn_orig"
+00012760: 3a20 6f66 6e2c 0a20 2020 2020 2020 2020  : ofn,.         
+00012770: 2020 2020 2020 2022 7061 7468 223a 2072         "path": r
+00012780: 656c 5f75 726c 2c0a 2020 2020 2020 2020  el_url,.        
+00012790: 2020 2020 7d0a 2020 2020 2020 2020 2020      }.          
+000127a0: 2020 6a6d 7367 5b22 6669 6c65 7322 5d2e    jmsg["files"].
+000127b0: 6170 7065 6e64 286a 7061 7274 290a 0a20  append(jpart).. 
+000127c0: 2020 2020 2020 2076 7370 6420 3d20 7365         vspd = se
+000127d0: 6c66 2e5f 7370 6428 737a 5f74 6f74 616c  lf._spd(sz_total
+000127e0: 2c20 4661 6c73 6529 0a20 2020 2020 2020  , False).       
+000127f0: 2073 656c 662e 6c6f 6728 227b 7d20 7b7d   self.log("{} {}
+00012800: 222e 666f 726d 6174 2876 7370 642c 206d  ".format(vspd, m
+00012810: 7367 2929 0a0a 2020 2020 2020 2020 7375  sg))..        su
+00012820: 6620 3d20 2222 0a20 2020 2020 2020 2069  f = "".        i
+00012830: 6620 6e6f 7420 6e75 6c6c 7772 6974 6520  f not nullwrite 
+00012840: 616e 6420 7365 6c66 2e61 7267 732e 7772  and self.args.wr
+00012850: 6974 655f 7570 6c6f 673a 0a20 2020 2020  ite_uplog:.     
+00012860: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
+00012870: 2020 2020 2020 2020 2020 2020 6c6f 675f              log_
+00012880: 666e 203d 2022 7570 2e7b 3a2e 3666 7d2e  fn = "up.{:.6f}.
+00012890: 7478 7422 2e66 6f72 6d61 7428 7430 290a  txt".format(t0).
+000128a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000128b0: 7769 7468 206f 7065 6e28 6c6f 675f 666e  with open(log_fn
+000128c0: 2c20 2277 6222 2920 6173 2066 3a0a 2020  , "wb") as f:.  
+000128d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000128e0: 2020 6674 203d 2022 7b7d 3a7b 7d22 2e66    ft = "{}:{}".f
+000128f0: 6f72 6d61 7428 7365 6c66 2e69 702c 2073  ormat(self.ip, s
+00012900: 656c 662e 6164 6472 5b31 5d29 0a20 2020  elf.addr[1]).   
+00012910: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012920: 2066 7420 3d20 227b 7d5c 6e7b 7d5c 6e7b   ft = "{}\n{}\n{
+00012930: 7d5c 6e22 2e66 6f72 6d61 7428 6674 2c20  }\n".format(ft, 
+00012940: 6d73 672e 7273 7472 6970 2829 2c20 6572  msg.rstrip(), er
+00012950: 726d 7367 290a 2020 2020 2020 2020 2020  rmsg).          
+00012960: 2020 2020 2020 2020 2020 662e 7772 6974            f.writ
+00012970: 6528 6674 2e65 6e63 6f64 6528 2275 7466  e(ft.encode("utf
+00012980: 2d38 2229 290a 2020 2020 2020 2020 2020  -8")).          
+00012990: 2020 6578 6365 7074 2045 7863 6570 7469    except Excepti
+000129a0: 6f6e 2061 7320 6578 3a0a 2020 2020 2020  on as ex:.      
+000129b0: 2020 2020 2020 2020 2020 7375 6620 3d20            suf = 
+000129c0: 225c 6e66 6169 6c65 6420 746f 2077 7269  "\nfailed to wri
+000129d0: 7465 2074 6865 2075 706c 6f61 6420 7265  te the upload re
+000129e0: 706f 7274 3a20 7b7d 222e 666f 726d 6174  port: {}".format
+000129f0: 2865 7829 0a0a 2020 2020 2020 2020 7363  (ex)..        sc
+00012a00: 203d 2034 3030 2069 6620 6572 726d 7367   = 400 if errmsg
+00012a10: 2065 6c73 6520 3230 310a 2020 2020 2020   else 201.      
+00012a20: 2020 6966 2077 616e 745f 7572 6c3a 0a20    if want_url:. 
+00012a30: 2020 2020 2020 2020 2020 206d 7367 203d             msg =
+00012a40: 2022 5c6e 222e 6a6f 696e 285b 785b 2275   "\n".join([x["u
+00012a50: 726c 225d 2066 6f72 2078 2069 6e20 6a6d  rl"] for x in jm
+00012a60: 7367 5b22 6669 6c65 7322 5d5d 290a 2020  sg["files"]]).  
+00012a70: 2020 2020 2020 2020 2020 6966 2065 7272            if err
+00012a80: 6d73 673a 0a20 2020 2020 2020 2020 2020  msg:.           
+00012a90: 2020 2020 206d 7367 202b 3d20 225c 6e22       msg += "\n"
+00012aa0: 202b 2065 7272 6d73 670a 0a20 2020 2020   + errmsg..     
+00012ab0: 2020 2020 2020 2073 656c 662e 7265 706c         self.repl
+00012ac0: 7928 6d73 672e 656e 636f 6465 2822 7574  y(msg.encode("ut
+00012ad0: 662d 3822 2c20 2272 6570 6c61 6365 2229  f-8", "replace")
+00012ae0: 2c20 7374 6174 7573 3d73 6329 0a20 2020  , status=sc).   
+00012af0: 2020 2020 2065 6c69 6620 226a 2220 696e       elif "j" in
+00012b00: 2073 656c 662e 7570 6172 616d 3a0a 2020   self.uparam:.  
+00012b10: 2020 2020 2020 2020 2020 6a74 7874 203d            jtxt =
+00012b20: 206a 736f 6e2e 6475 6d70 7328 6a6d 7367   json.dumps(jmsg
+00012b30: 2c20 696e 6465 6e74 3d32 2c20 736f 7274  , indent=2, sort
+00012b40: 5f6b 6579 733d 5472 7565 292e 656e 636f  _keys=True).enco
+00012b50: 6465 2822 7574 662d 3822 2c20 2272 6570  de("utf-8", "rep
+00012b60: 6c61 6365 2229 0a20 2020 2020 2020 2020  lace").         
+00012b70: 2020 2073 656c 662e 7265 706c 7928 6a74     self.reply(jt
+00012b80: 7874 2c20 6d69 6d65 3d22 6170 706c 6963  xt, mime="applic
+00012b90: 6174 696f 6e2f 6a73 6f6e 222c 2073 7461  ation/json", sta
+00012ba0: 7475 733d 7363 290a 2020 2020 2020 2020  tus=sc).        
+00012bb0: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+00012bc0: 2020 7365 6c66 2e72 6564 6972 6563 7428    self.redirect(
+00012bd0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00012be0: 2073 656c 662e 7670 6174 682c 0a20 2020   self.vpath,.   
+00012bf0: 2020 2020 2020 2020 2020 2020 206d 7367               msg
+00012c00: 3d6d 7367 202b 2073 7566 2c0a 2020 2020  =msg + suf,.    
+00012c10: 2020 2020 2020 2020 2020 2020 666c 6176              flav
+00012c20: 6f72 3d22 7265 7475 726e 2074 6f22 2c0a  or="return to",.
+00012c30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012c40: 636c 6963 6b3d 4661 6c73 652c 0a20 2020  click=False,.   
+00012c50: 2020 2020 2020 2020 2020 2020 2073 7461               sta
+00012c60: 7475 733d 7363 2c0a 2020 2020 2020 2020  tus=sc,.        
+00012c70: 2020 2020 290a 0a20 2020 2020 2020 2069      )..        i
+00012c80: 6620 6572 726d 7367 3a0a 2020 2020 2020  f errmsg:.      
+00012c90: 2020 2020 2020 7265 7475 726e 2046 616c        return Fal
+00012ca0: 7365 0a0a 2020 2020 2020 2020 7365 6c66  se..        self
+00012cb0: 2e70 6172 7365 722e 6472 6f70 2829 0a20  .parser.drop(). 
+00012cc0: 2020 2020 2020 2072 6574 7572 6e20 5472         return Tr
+00012cd0: 7565 0a0a 2020 2020 6465 6620 6861 6e64  ue..    def hand
+00012ce0: 6c65 5f74 6578 745f 7570 6c6f 6164 2873  le_text_upload(s
+00012cf0: 656c 6629 2020 3a0a 2020 2020 2020 2020  elf)  :.        
+00012d00: 6173 7365 7274 2073 656c 662e 7061 7273  assert self.pars
+00012d10: 6572 0a20 2020 2020 2020 2074 7279 3a0a  er.        try:.
+00012d20: 2020 2020 2020 2020 2020 2020 636c 695f              cli_
+00012d30: 6c61 7374 6d6f 6433 203d 2069 6e74 2873  lastmod3 = int(s
+00012d40: 656c 662e 7061 7273 6572 2e72 6571 7569  elf.parser.requi
+00012d50: 7265 2822 6c61 7374 6d6f 6422 2c20 3136  re("lastmod", 16
+00012d60: 2929 0a20 2020 2020 2020 2065 7863 6570  )).        excep
+00012d70: 743a 0a20 2020 2020 2020 2020 2020 2072  t:.            r
+00012d80: 6169 7365 2050 6562 6b61 6328 3430 302c  aise Pebkac(400,
+00012d90: 2022 636f 756c 6420 6e6f 7420 7265 6164   "could not read
+00012da0: 206c 6173 746d 6f64 2066 726f 6d20 7265   lastmod from re
+00012db0: 7175 6573 7422 290a 0a20 2020 2020 2020  quest")..       
+00012dc0: 206e 756c 6c77 7269 7465 203d 2073 656c   nullwrite = sel
+00012dd0: 662e 6172 6773 2e6e 770a 2020 2020 2020  f.args.nw.      
+00012de0: 2020 7666 732c 2072 656d 203d 2073 656c    vfs, rem = sel
+00012df0: 662e 6173 7276 2e76 6673 2e67 6574 2873  f.asrv.vfs.get(s
+00012e00: 656c 662e 7670 6174 682c 2073 656c 662e  elf.vpath, self.
+00012e10: 756e 616d 652c 2054 7275 652c 2054 7275  uname, True, Tru
+00012e20: 6529 0a20 2020 2020 2020 2073 656c 662e  e).        self.
+00012e30: 5f61 7373 6572 745f 7361 6665 5f72 656d  _assert_safe_rem
+00012e40: 2872 656d 290a 0a20 2020 2020 2020 2063  (rem)..        c
+00012e50: 6c65 6e20 3d20 696e 7428 7365 6c66 2e68  len = int(self.h
+00012e60: 6561 6465 7273 2e67 6574 2822 636f 6e74  eaders.get("cont
+00012e70: 656e 742d 6c65 6e67 7468 222c 202d 3129  ent-length", -1)
+00012e80: 290a 2020 2020 2020 2020 6966 2063 6c65  ).        if cle
+00012e90: 6e20 3d3d 202d 313a 0a20 2020 2020 2020  n == -1:.       
+00012ea0: 2020 2020 2072 6169 7365 2050 6562 6b61       raise Pebka
+00012eb0: 6328 3431 3129 0a0a 2020 2020 2020 2020  c(411)..        
+00012ec0: 7270 2c20 666e 203d 2076 7370 6c69 7428  rp, fn = vsplit(
+00012ed0: 7265 6d29 0a20 2020 2020 2020 2066 7020  rem).        fp 
+00012ee0: 3d20 7666 732e 6361 6e6f 6e69 6361 6c28  = vfs.canonical(
+00012ef0: 7270 290a 2020 2020 2020 2020 6c69 6d20  rp).        lim 
+00012f00: 3d20 7666 732e 6765 745f 6462 7628 7265  = vfs.get_dbv(re
+00012f10: 6d29 5b30 5d2e 6c69 6d0a 2020 2020 2020  m)[0].lim.      
+00012f20: 2020 6966 206c 696d 3a0a 2020 2020 2020    if lim:.      
+00012f30: 2020 2020 2020 6670 2c20 7270 203d 206c        fp, rp = l
+00012f40: 696d 2e61 6c6c 2873 656c 662e 6970 2c20  im.all(self.ip, 
+00012f50: 7270 2c20 636c 656e 2c20 6670 290a 2020  rp, clen, fp).  
+00012f60: 2020 2020 2020 2020 2020 626f 732e 6d61            bos.ma
+00012f70: 6b65 6469 7273 2866 7029 0a0a 2020 2020  kedirs(fp)..    
+00012f80: 2020 2020 6670 203d 206f 732e 7061 7468      fp = os.path
+00012f90: 2e6a 6f69 6e28 6670 2c20 666e 290a 2020  .join(fp, fn).  
+00012fa0: 2020 2020 2020 7265 6d20 3d20 227b 7d2f        rem = "{}/
+00012fb0: 7b7d 222e 666f 726d 6174 2872 702c 2066  {}".format(rp, f
+00012fc0: 6e29 2e73 7472 6970 2822 2f22 290a 0a20  n).strip("/").. 
+00012fd0: 2020 2020 2020 2069 6620 6e6f 7420 7265         if not re
+00012fe0: 6d2e 656e 6473 7769 7468 2822 2e6d 6422  m.endswith(".md"
+00012ff0: 293a 0a20 2020 2020 2020 2020 2020 2072  ):.            r
+00013000: 6169 7365 2050 6562 6b61 6328 3430 302c  aise Pebkac(400,
+00013010: 2022 6f6e 6c79 206d 6172 6b64 6f77 6e20   "only markdown 
+00013020: 706c 7322 290a 0a20 2020 2020 2020 2069  pls")..        i
+00013030: 6620 6e75 6c6c 7772 6974 653a 0a20 2020  f nullwrite:.   
+00013040: 2020 2020 2020 2020 2072 6573 706f 6e73           respons
+00013050: 6520 3d20 6a73 6f6e 2e64 756d 7073 287b  e = json.dumps({
+00013060: 226f 6b22 3a20 5472 7565 2c20 226c 6173  "ok": True, "las
+00013070: 746d 6f64 223a 2030 7d29 0a20 2020 2020  tmod": 0}).     
+00013080: 2020 2020 2020 2073 656c 662e 6c6f 6728         self.log(
+00013090: 7265 7370 6f6e 7365 290a 2020 2020 2020  response).      
+000130a0: 2020 2020 2020 2320 544f 444f 2072 6570        # TODO rep
+000130b0: 6c79 2073 686f 756c 6420 7061 7273 6572  ly should parser
+000130c0: 2e64 726f 7028 290a 2020 2020 2020 2020  .drop().        
+000130d0: 2020 2020 7365 6c66 2e70 6172 7365 722e      self.parser.
+000130e0: 6472 6f70 2829 0a20 2020 2020 2020 2020  drop().         
+000130f0: 2020 2073 656c 662e 7265 706c 7928 7265     self.reply(re
+00013100: 7370 6f6e 7365 2e65 6e63 6f64 6528 2275  sponse.encode("u
+00013110: 7466 2d38 2229 290a 2020 2020 2020 2020  tf-8")).        
+00013120: 2020 2020 7265 7475 726e 2054 7275 650a      return True.
+00013130: 0a20 2020 2020 2020 2073 7276 5f6c 6173  .        srv_las
+00013140: 746d 6f64 203d 202d 312e 300a 2020 2020  tmod = -1.0.    
+00013150: 2020 2020 7372 765f 6c61 7374 6d6f 6433      srv_lastmod3
+00013160: 203d 202d 310a 2020 2020 2020 2020 7472   = -1.        tr
+00013170: 793a 0a20 2020 2020 2020 2020 2020 2073  y:.            s
+00013180: 7420 3d20 626f 732e 7374 6174 2866 7029  t = bos.stat(fp)
+00013190: 0a20 2020 2020 2020 2020 2020 2073 7276  .            srv
+000131a0: 5f6c 6173 746d 6f64 203d 2073 742e 7374  _lastmod = st.st
+000131b0: 5f6d 7469 6d65 0a20 2020 2020 2020 2020  _mtime.         
+000131c0: 2020 2073 7276 5f6c 6173 746d 6f64 3320     srv_lastmod3 
+000131d0: 3d20 696e 7428 7372 765f 6c61 7374 6d6f  = int(srv_lastmo
+000131e0: 6420 2a20 3130 3030 290a 2020 2020 2020  d * 1000).      
+000131f0: 2020 6578 6365 7074 204f 5345 7272 6f72    except OSError
+00013200: 2061 7320 6578 3a0a 2020 2020 2020 2020   as ex:.        
+00013210: 2020 2020 6966 2065 782e 6572 726e 6f20      if ex.errno 
+00013220: 213d 2065 7272 6e6f 2e45 4e4f 454e 543a  != errno.ENOENT:
+00013230: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00013240: 2072 6169 7365 0a0a 2020 2020 2020 2020   raise..        
+00013250: 2320 6966 2066 696c 6520 6578 6973 7473  # if file exists
+00013260: 2c20 6368 656b 6320 7468 6174 2074 696d  , chekc that tim
+00013270: 6573 7461 6d70 206d 6174 6368 6573 2074  estamp matches t
+00013280: 6865 2063 6c69 656e 7427 730a 2020 2020  he client's.    
+00013290: 2020 2020 6966 2073 7276 5f6c 6173 746d      if srv_lastm
+000132a0: 6f64 203e 3d20 303a 0a20 2020 2020 2020  od >= 0:.       
+000132b0: 2020 2020 2073 616d 655f 6c61 7374 6d6f       same_lastmo
+000132c0: 6420 3d20 636c 695f 6c61 7374 6d6f 6433  d = cli_lastmod3
+000132d0: 2069 6e20 5b2d 312c 2073 7276 5f6c 6173   in [-1, srv_las
+000132e0: 746d 6f64 335d 0a20 2020 2020 2020 2020  tmod3].         
+000132f0: 2020 2069 6620 6e6f 7420 7361 6d65 5f6c     if not same_l
+00013300: 6173 746d 6f64 3a0a 2020 2020 2020 2020  astmod:.        
+00013310: 2020 2020 2020 2020 2320 736f 6d65 2066          # some f
+00013320: 696c 6573 7973 7465 6d73 2f74 7261 6e73  ilesystems/trans
+00013330: 706f 7274 7320 6c69 6d69 7420 7072 6563  ports limit prec
+00013340: 6973 696f 6e20 746f 2031 7365 632c 2068  ision to 1sec, h
+00013350: 6f70 6566 756c 6c79 2066 6c6f 6f72 6564  opefully floored
+00013360: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00013370: 2073 616d 655f 6c61 7374 6d6f 6420 3d20   same_lastmod = 
+00013380: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00013390: 2020 2020 2020 7372 765f 6c61 7374 6d6f        srv_lastmo
+000133a0: 6420 3d3d 2069 6e74 2863 6c69 5f6c 6173  d == int(cli_las
+000133b0: 746d 6f64 3320 2f20 3130 3030 290a 2020  tmod3 / 1000).  
+000133c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000133d0: 2020 616e 6420 636c 695f 6c61 7374 6d6f    and cli_lastmo
+000133e0: 6433 203e 2073 7276 5f6c 6173 746d 6f64  d3 > srv_lastmod
+000133f0: 330a 2020 2020 2020 2020 2020 2020 2020  3.              
+00013400: 2020 2020 2020 616e 6420 636c 695f 6c61        and cli_la
+00013410: 7374 6d6f 6433 202d 2073 7276 5f6c 6173  stmod3 - srv_las
+00013420: 746d 6f64 3320 3c20 3130 3030 0a20 2020  tmod3 < 1000.   
+00013430: 2020 2020 2020 2020 2020 2020 2029 0a0a               )..
+00013440: 2020 2020 2020 2020 2020 2020 6966 206e              if n
+00013450: 6f74 2073 616d 655f 6c61 7374 6d6f 643a  ot same_lastmod:
+00013460: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00013470: 2072 6573 706f 6e73 6520 3d20 6a73 6f6e   response = json
+00013480: 2e64 756d 7073 280a 2020 2020 2020 2020  .dumps(.        
+00013490: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
+000134a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000134b0: 2020 2020 2020 226f 6b22 3a20 4661 6c73        "ok": Fals
+000134c0: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
+000134d0: 2020 2020 2020 2020 2020 2022 6c61 7374             "last
+000134e0: 6d6f 6422 3a20 7372 765f 6c61 7374 6d6f  mod": srv_lastmo
+000134f0: 6433 2c0a 2020 2020 2020 2020 2020 2020  d3,.            
+00013500: 2020 2020 2020 2020 2020 2020 226e 6f77              "now
+00013510: 223a 2069 6e74 2874 696d 652e 7469 6d65  ": int(time.time
+00013520: 2829 202a 2031 3030 3029 2c0a 2020 2020  () * 1000),.    
+00013530: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013540: 7d0a 2020 2020 2020 2020 2020 2020 2020  }.              
+00013550: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
+00013560: 2020 2020 7365 6c66 2e6c 6f67 280a 2020      self.log(.  
+00013570: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013580: 2020 227b 7d20 2d20 7b7d 203d 207b 7d22    "{} - {} = {}"
+00013590: 2e66 6f72 6d61 7428 0a20 2020 2020 2020  .format(.       
+000135a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000135b0: 2073 7276 5f6c 6173 746d 6f64 332c 2063   srv_lastmod3, c
+000135c0: 6c69 5f6c 6173 746d 6f64 332c 2073 7276  li_lastmod3, srv
+000135d0: 5f6c 6173 746d 6f64 3320 2d20 636c 695f  _lastmod3 - cli_
+000135e0: 6c61 7374 6d6f 6433 0a20 2020 2020 2020  lastmod3.       
+000135f0: 2020 2020 2020 2020 2020 2020 2029 0a20               ). 
+00013600: 2020 2020 2020 2020 2020 2020 2020 2029                 )
+00013610: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00013620: 2073 656c 662e 6c6f 6728 7265 7370 6f6e   self.log(respon
+00013630: 7365 290a 2020 2020 2020 2020 2020 2020  se).            
+00013640: 2020 2020 7365 6c66 2e70 6172 7365 722e      self.parser.
+00013650: 6472 6f70 2829 0a20 2020 2020 2020 2020  drop().         
+00013660: 2020 2020 2020 2073 656c 662e 7265 706c         self.repl
+00013670: 7928 7265 7370 6f6e 7365 2e65 6e63 6f64  y(response.encod
+00013680: 6528 2275 7466 2d38 2229 290a 2020 2020  e("utf-8")).    
+00013690: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+000136a0: 726e 2054 7275 650a 0a20 2020 2020 2020  rn True..       
+000136b0: 2020 2020 206d 6469 722c 206d 6669 6c65       mdir, mfile
+000136c0: 203d 206f 732e 7061 7468 2e73 706c 6974   = os.path.split
+000136d0: 2866 7029 0a20 2020 2020 2020 2020 2020  (fp).           
+000136e0: 206d 6669 6c65 3220 3d20 227b 7d2e 7b3a   mfile2 = "{}.{:
+000136f0: 2e33 667d 2e6d 6422 2e66 6f72 6d61 7428  .3f}.md".format(
+00013700: 6d66 696c 655b 3a2d 335d 2c20 7372 765f  mfile[:-3], srv_
+00013710: 6c61 7374 6d6f 6429 0a20 2020 2020 2020  lastmod).       
+00013720: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
+00013730: 2020 2020 2020 2020 2020 6470 203d 206f            dp = o
+00013740: 732e 7061 7468 2e6a 6f69 6e28 6d64 6972  s.path.join(mdir
+00013750: 2c20 222e 6869 7374 2229 0a20 2020 2020  , ".hist").     
+00013760: 2020 2020 2020 2020 2020 2062 6f73 2e6d             bos.m
+00013770: 6b64 6972 2864 7029 0a20 2020 2020 2020  kdir(dp).       
+00013780: 2020 2020 2020 2020 2068 6964 6564 6972           hidedir
+00013790: 2864 7029 0a20 2020 2020 2020 2020 2020  (dp).           
+000137a0: 2065 7863 6570 743a 0a20 2020 2020 2020   except:.       
+000137b0: 2020 2020 2020 2020 2070 6173 730a 2020           pass.  
+000137c0: 2020 2020 2020 2020 2020 626f 732e 7265            bos.re
+000137d0: 6e61 6d65 2866 702c 206f 732e 7061 7468  name(fp, os.path
+000137e0: 2e6a 6f69 6e28 6d64 6972 2c20 222e 6869  .join(mdir, ".hi
+000137f0: 7374 222c 206d 6669 6c65 3229 290a 0a20  st", mfile2)).. 
+00013800: 2020 2020 2020 2061 7373 6572 7420 7365         assert se
+00013810: 6c66 2e70 6172 7365 722e 6765 6e0a 2020  lf.parser.gen.  
+00013820: 2020 2020 2020 705f 6669 656c 642c 205f        p_field, _
+00013830: 2c20 705f 6461 7461 203d 206e 6578 7428  , p_data = next(
+00013840: 7365 6c66 2e70 6172 7365 722e 6765 6e29  self.parser.gen)
+00013850: 0a20 2020 2020 2020 2069 6620 705f 6669  .        if p_fi
+00013860: 656c 6420 213d 2022 626f 6479 223a 0a20  eld != "body":. 
+00013870: 2020 2020 2020 2020 2020 2072 6169 7365             raise
+00013880: 2050 6562 6b61 6328 3430 302c 2022 6578   Pebkac(400, "ex
+00013890: 7065 6374 6564 2062 6f64 792c 2067 6f74  pected body, got
+000138a0: 207b 7d22 2e66 6f72 6d61 7428 705f 6669   {}".format(p_fi
+000138b0: 656c 6429 290a 0a20 2020 2020 2020 2069  eld))..        i
+000138c0: 6620 626f 732e 7061 7468 2e65 7869 7374  f bos.path.exist
+000138d0: 7328 6670 293a 0a20 2020 2020 2020 2020  s(fp):.         
+000138e0: 2020 2062 6f73 2e75 6e6c 696e 6b28 6670     bos.unlink(fp
+000138f0: 290a 0a20 2020 2020 2020 2077 6974 6820  )..        with 
+00013900: 6f70 656e 2866 7365 6e63 2866 7029 2c20  open(fsenc(fp), 
+00013910: 2277 6222 2c20 3531 3220 2a20 3130 3234  "wb", 512 * 1024
+00013920: 2920 6173 2066 3a0a 2020 2020 2020 2020  ) as f:.        
+00013930: 2020 2020 737a 2c20 7368 6135 3132 2c20      sz, sha512, 
+00013940: 5f20 3d20 6861 7368 636f 7079 2870 5f64  _ = hashcopy(p_d
+00013950: 6174 612c 2066 2c20 7365 6c66 2e61 7267  ata, f, self.arg
+00013960: 732e 735f 7772 5f73 6c70 290a 0a20 2020  s.s_wr_slp)..   
+00013970: 2020 2020 2069 6620 6c69 6d3a 0a20 2020       if lim:.   
+00013980: 2020 2020 2020 2020 206c 696d 2e6e 7570           lim.nup
+00013990: 2873 656c 662e 6970 290a 2020 2020 2020  (self.ip).      
+000139a0: 2020 2020 2020 6c69 6d2e 6275 7028 7365        lim.bup(se
+000139b0: 6c66 2e69 702c 2073 7a29 0a20 2020 2020  lf.ip, sz).     
+000139c0: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
+000139d0: 2020 2020 2020 2020 2020 2020 6c69 6d2e              lim.
+000139e0: 6368 6b5f 737a 2873 7a29 0a20 2020 2020  chk_sz(sz).     
+000139f0: 2020 2020 2020 2065 7863 6570 743a 0a20         except:. 
+00013a00: 2020 2020 2020 2020 2020 2020 2020 2062                 b
+00013a10: 6f73 2e75 6e6c 696e 6b28 6670 290a 2020  os.unlink(fp).  
+00013a20: 2020 2020 2020 2020 2020 2020 2020 7261                ra
+00013a30: 6973 650a 0a20 2020 2020 2020 206e 6577  ise..        new
+00013a40: 5f6c 6173 746d 6f64 203d 2062 6f73 2e73  _lastmod = bos.s
+00013a50: 7461 7428 6670 292e 7374 5f6d 7469 6d65  tat(fp).st_mtime
+00013a60: 0a20 2020 2020 2020 206e 6577 5f6c 6173  .        new_las
+00013a70: 746d 6f64 3320 3d20 696e 7428 6e65 775f  tmod3 = int(new_
+00013a80: 6c61 7374 6d6f 6420 2a20 3130 3030 290a  lastmod * 1000).
+00013a90: 2020 2020 2020 2020 7368 6135 3132 203d          sha512 =
+00013aa0: 2073 6861 3531 325b 3a35 365d 0a0a 2020   sha512[:56]..  
+00013ab0: 2020 2020 2020 7265 7370 6f6e 7365 203d        response =
+00013ac0: 206a 736f 6e2e 6475 6d70 7328 0a20 2020   json.dumps(.   
+00013ad0: 2020 2020 2020 2020 207b 226f 6b22 3a20           {"ok": 
+00013ae0: 5472 7565 2c20 226c 6173 746d 6f64 223a  True, "lastmod":
+00013af0: 206e 6577 5f6c 6173 746d 6f64 332c 2022   new_lastmod3, "
+00013b00: 7369 7a65 223a 2073 7a2c 2022 7368 6135  size": sz, "sha5
+00013b10: 3132 223a 2073 6861 3531 327d 0a20 2020  12": sha512}.   
+00013b20: 2020 2020 2029 0a20 2020 2020 2020 2073       ).        s
+00013b30: 656c 662e 6c6f 6728 7265 7370 6f6e 7365  elf.log(response
+00013b40: 290a 2020 2020 2020 2020 7365 6c66 2e70  ).        self.p
+00013b50: 6172 7365 722e 6472 6f70 2829 0a20 2020  arser.drop().   
+00013b60: 2020 2020 2073 656c 662e 7265 706c 7928       self.reply(
+00013b70: 7265 7370 6f6e 7365 2e65 6e63 6f64 6528  response.encode(
+00013b80: 2275 7466 2d38 2229 290a 2020 2020 2020  "utf-8")).      
+00013b90: 2020 7265 7475 726e 2054 7275 650a 0a20    return True.. 
+00013ba0: 2020 2064 6566 205f 6368 6b5f 6c61 7374     def _chk_last
+00013bb0: 6d6f 6428 7365 6c66 2c20 6669 6c65 5f74  mod(self, file_t
+00013bc0: 7320 2920 2020 3a0a 2020 2020 2020 2020  s )   :.        
+00013bd0: 6669 6c65 5f6c 6173 746d 6f64 203d 2066  file_lastmod = f
+00013be0: 6f72 6d61 7464 6174 6528 6669 6c65 5f74  ormatdate(file_t
+00013bf0: 732c 2075 7365 676d 743d 5472 7565 290a  s, usegmt=True).
+00013c00: 2020 2020 2020 2020 636c 695f 6c61 7374          cli_last
+00013c10: 6d6f 6420 3d20 7365 6c66 2e68 6561 6465  mod = self.heade
+00013c20: 7273 2e67 6574 2822 6966 2d6d 6f64 6966  rs.get("if-modif
+00013c30: 6965 642d 7369 6e63 6522 290a 2020 2020  ied-since").    
+00013c40: 2020 2020 6966 2063 6c69 5f6c 6173 746d      if cli_lastm
+00013c50: 6f64 3a0a 2020 2020 2020 2020 2020 2020  od:.            
+00013c60: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
+00013c70: 2020 2020 2023 2073 6f6d 6520 6272 6f77       # some brow
+00013c80: 7365 7220 6170 7065 6e64 2022 3b20 6c65  ser append "; le
+00013c90: 6e67 7468 3d35 3733 220a 2020 2020 2020  ngth=573".      
+00013ca0: 2020 2020 2020 2020 2020 636c 695f 6c61            cli_la
+00013cb0: 7374 6d6f 6420 3d20 636c 695f 6c61 7374  stmod = cli_last
+00013cc0: 6d6f 642e 7370 6c69 7428 223b 2229 5b30  mod.split(";")[0
+00013cd0: 5d2e 7374 7269 7028 290a 2020 2020 2020  ].strip().      
+00013ce0: 2020 2020 2020 2020 2020 636c 695f 6474            cli_dt
+00013cf0: 203d 2070 6172 7365 6461 7465 2863 6c69   = parsedate(cli
+00013d00: 5f6c 6173 746d 6f64 290a 2020 2020 2020  _lastmod).      
+00013d10: 2020 2020 2020 2020 2020 6173 7365 7274            assert
+00013d20: 2063 6c69 5f64 740a 2020 2020 2020 2020   cli_dt.        
+00013d30: 2020 2020 2020 2020 636c 695f 7473 203d          cli_ts =
+00013d40: 2063 616c 656e 6461 722e 7469 6d65 676d   calendar.timegm
+00013d50: 2863 6c69 5f64 7429 0a20 2020 2020 2020  (cli_dt).       
+00013d60: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+00013d70: 6669 6c65 5f6c 6173 746d 6f64 2c20 696e  file_lastmod, in
+00013d80: 7428 6669 6c65 5f74 7329 203e 2069 6e74  t(file_ts) > int
+00013d90: 2863 6c69 5f74 7329 0a20 2020 2020 2020  (cli_ts).       
+00013da0: 2020 2020 2065 7863 6570 7420 4578 6365       except Exce
+00013db0: 7074 696f 6e20 6173 2065 783a 0a20 2020  ption as ex:.   
+00013dc0: 2020 2020 2020 2020 2020 2020 2073 656c               sel
+00013dd0: 662e 6c6f 6728 0a20 2020 2020 2020 2020  f.log(.         
+00013de0: 2020 2020 2020 2020 2020 2022 6c61 7374             "last
+00013df0: 6d6f 6420 7b7d 5c6e 7265 6d6f 7465 3a20  mod {}\nremote: 
+00013e00: 5b7b 7d5d 5c6e 206c 6f63 616c 3a20 5b7b  [{}]\n local: [{
+00013e10: 7d5d 222e 666f 726d 6174 280a 2020 2020  }]".format(.    
+00013e20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013e30: 2020 2020 7265 7072 2865 7829 2c20 636c      repr(ex), cl
+00013e40: 695f 6c61 7374 6d6f 642c 2066 696c 655f  i_lastmod, file_
+00013e50: 6c61 7374 6d6f 640a 2020 2020 2020 2020  lastmod.        
+00013e60: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
+00013e70: 2020 2020 2020 2020 2020 2020 2020 290a                ).
+00013e80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013e90: 7265 7475 726e 2066 696c 655f 6c61 7374  return file_last
+00013ea0: 6d6f 642c 2066 696c 655f 6c61 7374 6d6f  mod, file_lastmo
+00013eb0: 6420 213d 2063 6c69 5f6c 6173 746d 6f64  d != cli_lastmod
+00013ec0: 0a0a 2020 2020 2020 2020 7265 7475 726e  ..        return
+00013ed0: 2066 696c 655f 6c61 7374 6d6f 642c 2054   file_lastmod, T
+00013ee0: 7275 650a 0a20 2020 2064 6566 2074 785f  rue..    def tx_
+00013ef0: 6669 6c65 2873 656c 662c 2072 6571 5f70  file(self, req_p
+00013f00: 6174 6820 2920 203a 0a20 2020 2020 2020  ath )  :.       
+00013f10: 2073 7461 7475 7320 3d20 3230 300a 2020   status = 200.  
+00013f20: 2020 2020 2020 6c6f 676d 7367 203d 2022        logmsg = "
+00013f30: 7b3a 347d 207b 7d20 222e 666f 726d 6174  {:4} {} ".format
+00013f40: 2822 222c 2073 656c 662e 7265 7129 0a20  ("", self.req). 
+00013f50: 2020 2020 2020 206c 6f67 7461 696c 203d         logtail =
+00013f60: 2022 220a 0a20 2020 2020 2020 2023 0a20   ""..        #. 
+00013f70: 2020 2020 2020 2023 2069 6620 7265 7175         # if requ
+00013f80: 6573 7420 6973 2066 6f72 2066 6f6f 2e6a  est is for foo.j
+00013f90: 732c 2063 6865 636b 2069 6620 7765 2068  s, check if we h
+00013fa0: 6176 6520 666f 6f2e 6a73 2e7b 677a 2c62  ave foo.js.{gz,b
+00013fb0: 727d 0a0a 2020 2020 2020 2020 6669 6c65  r}..        file
+00013fc0: 5f74 7320 3d20 300a 2020 2020 2020 2020  _ts = 0.        
+00013fd0: 6564 6974 696f 6e73 2020 2020 3d20 7b7d  editions    = {}
+00013fe0: 0a20 2020 2020 2020 2066 6f72 2065 7874  .        for ext
+00013ff0: 2069 6e20 5b22 222c 2022 2e67 7a22 2c20   in ["", ".gz", 
+00014000: 222e 6272 225d 3a0a 2020 2020 2020 2020  ".br"]:.        
+00014010: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
+00014020: 2020 2020 2020 2020 2066 735f 7061 7468           fs_path
+00014030: 203d 2072 6571 5f70 6174 6820 2b20 6578   = req_path + ex
+00014040: 740a 2020 2020 2020 2020 2020 2020 2020  t.              
+00014050: 2020 7374 203d 2062 6f73 2e73 7461 7428    st = bos.stat(
+00014060: 6673 5f70 6174 6829 0a20 2020 2020 2020  fs_path).       
+00014070: 2020 2020 2020 2020 2069 6620 7374 6174           if stat
+00014080: 2e53 5f49 5344 4952 2873 742e 7374 5f6d  .S_ISDIR(st.st_m
+00014090: 6f64 6529 3a0a 2020 2020 2020 2020 2020  ode):.          
+000140a0: 2020 2020 2020 2020 2020 636f 6e74 696e            contin
+000140b0: 7565 0a0a 2020 2020 2020 2020 2020 2020  ue..            
+000140c0: 2020 2020 6966 2073 7461 742e 535f 4953      if stat.S_IS
+000140d0: 424c 4b28 7374 2e73 745f 6d6f 6465 293a  BLK(st.st_mode):
+000140e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000140f0: 2020 2020 2066 6420 3d20 626f 732e 6f70       fd = bos.op
+00014100: 656e 2866 735f 7061 7468 2c20 6f73 2e4f  en(fs_path, os.O
+00014110: 5f52 444f 4e4c 5929 0a20 2020 2020 2020  _RDONLY).       
+00014120: 2020 2020 2020 2020 2020 2020 2074 7279               try
+00014130: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00014140: 2020 2020 2020 2020 2020 737a 203d 206f            sz = o
+00014150: 732e 6c73 6565 6b28 6664 2c20 302c 206f  s.lseek(fd, 0, o
+00014160: 732e 5345 454b 5f45 4e44 290a 2020 2020  s.SEEK_END).    
+00014170: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014180: 6669 6e61 6c6c 793a 0a20 2020 2020 2020  finally:.       
+00014190: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000141a0: 206f 732e 636c 6f73 6528 6664 290a 2020   os.close(fd).  
+000141b0: 2020 2020 2020 2020 2020 2020 2020 656c                el
+000141c0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+000141d0: 2020 2020 2020 2020 737a 203d 2073 742e          sz = st.
+000141e0: 7374 5f73 697a 650a 0a20 2020 2020 2020  st_size..       
+000141f0: 2020 2020 2020 2020 2066 696c 655f 7473           file_ts
+00014200: 203d 206d 6178 2866 696c 655f 7473 2c20   = max(file_ts, 
+00014210: 696e 7428 7374 2e73 745f 6d74 696d 6529  int(st.st_mtime)
+00014220: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00014230: 2020 6564 6974 696f 6e73 5b65 7874 206f    editions[ext o
+00014240: 7220 2270 6c61 696e 225d 203d 2028 6673  r "plain"] = (fs
+00014250: 5f70 6174 682c 2073 7a29 0a20 2020 2020  _path, sz).     
+00014260: 2020 2020 2020 2065 7863 6570 743a 0a20         except:. 
+00014270: 2020 2020 2020 2020 2020 2020 2020 2070                 p
+00014280: 6173 730a 2020 2020 2020 2020 2020 2020  ass.            
+00014290: 6966 206e 6f74 2073 656c 662e 7670 6174  if not self.vpat
+000142a0: 682e 7374 6172 7473 7769 7468 2822 2e63  h.startswith(".c
+000142b0: 7072 2f22 293a 0a20 2020 2020 2020 2020  pr/"):.         
+000142c0: 2020 2020 2020 2062 7265 616b 0a0a 2020         break..  
+000142d0: 2020 2020 2020 6966 206e 6f74 2065 6469        if not edi
+000142e0: 7469 6f6e 733a 0a20 2020 2020 2020 2020  tions:.         
+000142f0: 2020 2072 6574 7572 6e20 7365 6c66 2e74     return self.t
+00014300: 785f 3430 3428 290a 0a20 2020 2020 2020  x_404()..       
+00014310: 2023 0a20 2020 2020 2020 2023 2069 662d   #.        # if-
+00014320: 6d6f 6469 6669 6564 0a0a 2020 2020 2020  modified..      
+00014330: 2020 6669 6c65 5f6c 6173 746d 6f64 2c20    file_lastmod, 
+00014340: 646f 5f73 656e 6420 3d20 7365 6c66 2e5f  do_send = self._
+00014350: 6368 6b5f 6c61 7374 6d6f 6428 6669 6c65  chk_lastmod(file
+00014360: 5f74 7329 0a20 2020 2020 2020 2073 656c  _ts).        sel
+00014370: 662e 6f75 745f 6865 6164 6572 735b 224c  f.out_headers["L
+00014380: 6173 742d 4d6f 6469 6669 6564 225d 203d  ast-Modified"] =
+00014390: 2066 696c 655f 6c61 7374 6d6f 640a 2020   file_lastmod.  
+000143a0: 2020 2020 2020 6966 206e 6f74 2064 6f5f        if not do_
+000143b0: 7365 6e64 3a0a 2020 2020 2020 2020 2020  send:.          
+000143c0: 2020 7374 6174 7573 203d 2033 3034 0a0a    status = 304..
+000143d0: 2020 2020 2020 2020 230a 2020 2020 2020          #.      
+000143e0: 2020 2320 4163 6365 7074 2d45 6e63 6f64    # Accept-Encod
+000143f0: 696e 6720 616e 6420 5541 2064 6563 6964  ing and UA decid
+00014400: 6573 2077 6869 6368 2065 6469 7469 6f6e  es which edition
+00014410: 2074 6f20 7365 6e64 0a0a 2020 2020 2020   to send..      
+00014420: 2020 6465 636f 6d70 7265 7373 203d 2046    decompress = F
+00014430: 616c 7365 0a20 2020 2020 2020 2073 7570  alse.        sup
+00014440: 706f 7274 6564 5f65 6469 7469 6f6e 7320  ported_editions 
+00014450: 3d20 5b0a 2020 2020 2020 2020 2020 2020  = [.            
+00014460: 782e 7374 7269 7028 290a 2020 2020 2020  x.strip().      
+00014470: 2020 2020 2020 666f 7220 7820 696e 2073        for x in s
+00014480: 656c 662e 6865 6164 6572 732e 6765 7428  elf.headers.get(
+00014490: 2261 6363 6570 742d 656e 636f 6469 6e67  "accept-encoding
+000144a0: 222c 2022 2229 2e6c 6f77 6572 2829 2e73  ", "").lower().s
+000144b0: 706c 6974 2822 2c22 290a 2020 2020 2020  plit(",").      
+000144c0: 2020 5d0a 2020 2020 2020 2020 6966 2022    ].        if "
+000144d0: 2e62 7222 2069 6e20 6564 6974 696f 6e73  .br" in editions
+000144e0: 2061 6e64 2022 6272 2220 696e 2073 7570   and "br" in sup
+000144f0: 706f 7274 6564 5f65 6469 7469 6f6e 733a  ported_editions:
+00014500: 0a20 2020 2020 2020 2020 2020 2069 735f  .            is_
+00014510: 636f 6d70 7265 7373 6564 203d 2054 7275  compressed = Tru
+00014520: 650a 2020 2020 2020 2020 2020 2020 7365  e.            se
+00014530: 6c65 6374 6564 5f65 6469 7469 6f6e 203d  lected_edition =
+00014540: 2022 2e62 7222 0a20 2020 2020 2020 2020   ".br".         
+00014550: 2020 2066 735f 7061 7468 2c20 6669 6c65     fs_path, file
+00014560: 5f73 7a20 3d20 6564 6974 696f 6e73 5b22  _sz = editions["
+00014570: 2e62 7222 5d0a 2020 2020 2020 2020 2020  .br"].          
+00014580: 2020 7365 6c66 2e6f 7574 5f68 6561 6465    self.out_heade
+00014590: 7273 5b22 436f 6e74 656e 742d 456e 636f  rs["Content-Enco
+000145a0: 6469 6e67 225d 203d 2022 6272 220a 2020  ding"] = "br".  
+000145b0: 2020 2020 2020 656c 6966 2022 2e67 7a22        elif ".gz"
+000145c0: 2069 6e20 6564 6974 696f 6e73 3a0a 2020   in editions:.  
+000145d0: 2020 2020 2020 2020 2020 6973 5f63 6f6d            is_com
+000145e0: 7072 6573 7365 6420 3d20 5472 7565 0a20  pressed = True. 
+000145f0: 2020 2020 2020 2020 2020 2073 656c 6563             selec
+00014600: 7465 645f 6564 6974 696f 6e20 3d20 222e  ted_edition = ".
+00014610: 677a 220a 2020 2020 2020 2020 2020 2020  gz".            
+00014620: 6673 5f70 6174 682c 2066 696c 655f 737a  fs_path, file_sz
+00014630: 203d 2065 6469 7469 6f6e 735b 222e 677a   = editions[".gz
+00014640: 225d 0a20 2020 2020 2020 2020 2020 2069  "].            i
+00014650: 6620 2267 7a69 7022 206e 6f74 2069 6e20  f "gzip" not in 
+00014660: 7375 7070 6f72 7465 645f 6564 6974 696f  supported_editio
+00014670: 6e73 3a0a 2020 2020 2020 2020 2020 2020  ns:.            
+00014680: 2020 2020 6465 636f 6d70 7265 7373 203d      decompress =
+00014690: 2054 7275 650a 2020 2020 2020 2020 2020   True.          
+000146a0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+000146b0: 2020 2020 2020 2020 6966 2072 652e 6d61          if re.ma
+000146c0: 7463 6828 7222 4d53 4945 205b 342d 365d  tch(r"MSIE [4-6]
+000146d0: 5c2e 222c 2073 656c 662e 7561 2920 616e  \.", self.ua) an
+000146e0: 6420 2220 5356 3122 206e 6f74 2069 6e20  d " SV1" not in 
+000146f0: 7365 6c66 2e75 613a 0a20 2020 2020 2020  self.ua:.       
+00014700: 2020 2020 2020 2020 2020 2020 2064 6563               dec
+00014710: 6f6d 7072 6573 7320 3d20 5472 7565 0a0a  ompress = True..
+00014720: 2020 2020 2020 2020 2020 2020 6966 206e              if n
+00014730: 6f74 2064 6563 6f6d 7072 6573 733a 0a20  ot decompress:. 
+00014740: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00014750: 656c 662e 6f75 745f 6865 6164 6572 735b  elf.out_headers[
+00014760: 2243 6f6e 7465 6e74 2d45 6e63 6f64 696e  "Content-Encodin
+00014770: 6722 5d20 3d20 2267 7a69 7022 0a20 2020  g"] = "gzip".   
+00014780: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+00014790: 2020 2020 2020 2069 735f 636f 6d70 7265         is_compre
+000147a0: 7373 6564 203d 2046 616c 7365 0a20 2020  ssed = False.   
+000147b0: 2020 2020 2020 2020 2073 656c 6563 7465           selecte
+000147c0: 645f 6564 6974 696f 6e20 3d20 2270 6c61  d_edition = "pla
+000147d0: 696e 220a 0a20 2020 2020 2020 2074 7279  in"..        try
+000147e0: 3a0a 2020 2020 2020 2020 2020 2020 6673  :.            fs
+000147f0: 5f70 6174 682c 2066 696c 655f 737a 203d  _path, file_sz =
+00014800: 2065 6469 7469 6f6e 735b 7365 6c65 6374   editions[select
+00014810: 6564 5f65 6469 7469 6f6e 5d0a 2020 2020  ed_edition].    
+00014820: 2020 2020 2020 2020 6c6f 676d 7367 202b          logmsg +
+00014830: 3d20 227b 7d20 222e 666f 726d 6174 2873  = "{} ".format(s
+00014840: 656c 6563 7465 645f 6564 6974 696f 6e2e  elected_edition.
+00014850: 6c73 7472 6970 2822 2e22 2929 0a20 2020  lstrip(".")).   
+00014860: 2020 2020 2065 7863 6570 743a 0a20 2020       except:.   
+00014870: 2020 2020 2020 2020 2023 2063 6c69 656e           # clien
+00014880: 7420 6973 206f 6c64 2061 6e64 2077 6520  t is old and we 
+00014890: 6f6e 6c79 2068 6176 6520 2e62 720a 2020  only have .br.  
+000148a0: 2020 2020 2020 2020 2020 2320 2863 6f75            # (cou
+000148b0: 6c64 206d 616b 6520 6272 6f74 6c69 2061  ld make brotli a
+000148c0: 2064 6570 2074 6f20 6669 7820 7468 6973   dep to fix this
+000148d0: 2062 7574 2069 7427 7320 6e6f 7420 776f   but it's not wo
+000148e0: 7274 6829 0a20 2020 2020 2020 2020 2020  rth).           
+000148f0: 2072 6169 7365 2050 6562 6b61 6328 3430   raise Pebkac(40
+00014900: 3429 0a0a 2020 2020 2020 2020 230a 2020  4)..        #.  
+00014910: 2020 2020 2020 2320 7061 7274 6961 6c0a        # partial.
+00014920: 0a20 2020 2020 2020 206c 6f77 6572 203d  .        lower =
+00014930: 2030 0a20 2020 2020 2020 2075 7070 6572   0.        upper
+00014940: 203d 2066 696c 655f 737a 0a20 2020 2020   = file_sz.     
+00014950: 2020 2068 7261 6e67 6520 3d20 7365 6c66     hrange = self
+00014960: 2e68 6561 6465 7273 2e67 6574 2822 7261  .headers.get("ra
+00014970: 6e67 6522 290a 0a20 2020 2020 2020 2023  nge")..        #
+00014980: 206c 6574 2773 206e 6f74 2073 7570 706f   let's not suppo
+00014990: 7274 2032 3036 2077 6974 6820 636f 6d70  rt 206 with comp
+000149a0: 7265 7373 696f 6e0a 2020 2020 2020 2020  ression.        
+000149b0: 2320 616e 6420 6d75 6c74 6972 616e 6765  # and multirange
+000149c0: 202f 206d 756c 7469 7061 7274 2069 7320   / multipart is 
+000149d0: 616c 736f 206e 6f74 2d69 6d70 6c20 286d  also not-impl (m
+000149e0: 6f73 746c 7920 6265 6361 7573 6520 6361  ostly because ca
+000149f0: 6c63 756c 6174 696e 6720 636f 6e74 656e  lculating conten
+00014a00: 746c 656e 6774 6820 6973 2061 2070 6169  tlength is a pai
+00014a10: 6e29 0a20 2020 2020 2020 2069 6620 646f  n).        if do
+00014a20: 5f73 656e 6420 616e 6420 6e6f 7420 6973  _send and not is
+00014a30: 5f63 6f6d 7072 6573 7365 6420 616e 6420  _compressed and 
+00014a40: 6872 616e 6765 2061 6e64 2066 696c 655f  hrange and file_
+00014a50: 737a 2061 6e64 2022 2c22 206e 6f74 2069  sz and "," not i
+00014a60: 6e20 6872 616e 6765 3a0a 2020 2020 2020  n hrange:.      
+00014a70: 2020 2020 2020 7472 793a 0a20 2020 2020        try:.     
+00014a80: 2020 2020 2020 2020 2020 2069 6620 6e6f             if no
+00014a90: 7420 6872 616e 6765 2e6c 6f77 6572 2829  t hrange.lower()
+00014aa0: 2e73 7461 7274 7377 6974 6828 2262 7974  .startswith("byt
+00014ab0: 6573 2229 3a0a 2020 2020 2020 2020 2020  es"):.          
+00014ac0: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
+00014ad0: 4578 6365 7074 696f 6e28 290a 0a20 2020  Exception()..   
+00014ae0: 2020 2020 2020 2020 2020 2020 2061 2c20               a, 
+00014af0: 6220 3d20 6872 616e 6765 2e73 706c 6974  b = hrange.split
+00014b00: 2822 3d22 2c20 3129 5b31 5d2e 7370 6c69  ("=", 1)[1].spli
+00014b10: 7428 222d 2229 0a0a 2020 2020 2020 2020  t("-")..        
+00014b20: 2020 2020 2020 2020 6966 2061 2e73 7472          if a.str
+00014b30: 6970 2829 3a0a 2020 2020 2020 2020 2020  ip():.          
+00014b40: 2020 2020 2020 2020 2020 6c6f 7765 7220            lower 
+00014b50: 3d20 696e 7428 612e 7374 7269 7028 2929  = int(a.strip())
+00014b60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00014b70: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+00014b80: 2020 2020 2020 2020 2020 206c 6f77 6572             lower
+00014b90: 203d 2030 0a0a 2020 2020 2020 2020 2020   = 0..          
+00014ba0: 2020 2020 2020 6966 2062 2e73 7472 6970        if b.strip
+00014bb0: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
+00014bc0: 2020 2020 2020 2020 7570 7065 7220 3d20          upper = 
+00014bd0: 696e 7428 622e 7374 7269 7028 2929 202b  int(b.strip()) +
+00014be0: 2031 0a20 2020 2020 2020 2020 2020 2020   1.             
+00014bf0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+00014c00: 2020 2020 2020 2020 2020 2020 2075 7070               upp
+00014c10: 6572 203d 2066 696c 655f 737a 0a0a 2020  er = file_sz..  
+00014c20: 2020 2020 2020 2020 2020 2020 2020 6966                if
+00014c30: 2075 7070 6572 203e 2066 696c 655f 737a   upper > file_sz
+00014c40: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00014c50: 2020 2020 2020 7570 7065 7220 3d20 6669        upper = fi
+00014c60: 6c65 5f73 7a0a 0a20 2020 2020 2020 2020  le_sz..         
+00014c70: 2020 2020 2020 2069 6620 6c6f 7765 7220         if lower 
+00014c80: 3c20 3020 6f72 206c 6f77 6572 203e 3d20  < 0 or lower >= 
+00014c90: 7570 7065 723a 0a20 2020 2020 2020 2020  upper:.         
+00014ca0: 2020 2020 2020 2020 2020 2072 6169 7365             raise
+00014cb0: 2045 7863 6570 7469 6f6e 2829 0a0a 2020   Exception()..  
+00014cc0: 2020 2020 2020 2020 2020 6578 6365 7074            except
+00014cd0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00014ce0: 2020 6572 7220 3d20 2269 6e76 616c 6964    err = "invalid
+00014cf0: 2072 616e 6765 2028 7b7d 292c 2073 697a   range ({}), siz
+00014d00: 653d 7b7d 222e 666f 726d 6174 2868 7261  e={}".format(hra
+00014d10: 6e67 652c 2066 696c 655f 737a 290a 2020  nge, file_sz).  
+00014d20: 2020 2020 2020 2020 2020 2020 2020 7365                se
+00014d30: 6c66 2e6c 6f75 645f 7265 706c 7928 0a20  lf.loud_reply(. 
+00014d40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014d50: 2020 2065 7272 2c0a 2020 2020 2020 2020     err,.        
+00014d60: 2020 2020 2020 2020 2020 2020 7374 6174              stat
+00014d70: 7573 3d34 3136 2c0a 2020 2020 2020 2020  us=416,.        
+00014d80: 2020 2020 2020 2020 2020 2020 6865 6164              head
+00014d90: 6572 733d 7b22 436f 6e74 656e 742d 5261  ers={"Content-Ra
+00014da0: 6e67 6522 3a20 2262 7974 6573 202a 2f7b  nge": "bytes */{
+00014db0: 7d22 2e66 6f72 6d61 7428 6669 6c65 5f73  }".format(file_s
+00014dc0: 7a29 7d2c 0a20 2020 2020 2020 2020 2020  z)},.           
+00014dd0: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
+00014de0: 2020 2020 2020 2072 6574 7572 6e20 5472         return Tr
+00014df0: 7565 0a0a 2020 2020 2020 2020 2020 2020  ue..            
+00014e00: 7374 6174 7573 203d 2032 3036 0a20 2020  status = 206.   
+00014e10: 2020 2020 2020 2020 2073 656c 662e 6f75           self.ou
+00014e20: 745f 6865 6164 6572 735b 2243 6f6e 7465  t_headers["Conte
+00014e30: 6e74 2d52 616e 6765 225d 203d 2022 6279  nt-Range"] = "by
+00014e40: 7465 7320 7b7d 2d7b 7d2f 7b7d 222e 666f  tes {}-{}/{}".fo
+00014e50: 726d 6174 280a 2020 2020 2020 2020 2020  rmat(.          
+00014e60: 2020 2020 2020 6c6f 7765 722c 2075 7070        lower, upp
+00014e70: 6572 202d 2031 2c20 6669 6c65 5f73 7a0a  er - 1, file_sz.
+00014e80: 2020 2020 2020 2020 2020 2020 290a 0a20              ).. 
+00014e90: 2020 2020 2020 2020 2020 206c 6f67 7461             logta
+00014ea0: 696c 202b 3d20 2220 5b5c 3033 335b 3336  il += " [\033[36
+00014eb0: 6d7b 7d2d 7b7d 5c30 3333 5b30 6d5d 222e  m{}-{}\033[0m]".
+00014ec0: 666f 726d 6174 286c 6f77 6572 2c20 7570  format(lower, up
+00014ed0: 7065 7229 0a0a 2020 2020 2020 2020 7573  per)..        us
+00014ee0: 655f 7365 6e64 6669 6c65 203d 2046 616c  e_sendfile = Fal
+00014ef0: 7365 0a20 2020 2020 2020 2069 6620 6465  se.        if de
+00014f00: 636f 6d70 7265 7373 3a0a 2020 2020 2020  compress:.      
+00014f10: 2020 2020 2020 6f70 656e 5f66 756e 6320        open_func 
+00014f20: 203d 2067 7a69 702e 6f70 656e 0a20 2020   = gzip.open.   
+00014f30: 2020 2020 2020 2020 206f 7065 6e5f 6172           open_ar
+00014f40: 6773 2020 3d20 5b66 7365 6e63 2866 735f  gs  = [fsenc(fs_
+00014f50: 7061 7468 292c 2022 7262 225d 0a20 2020  path), "rb"].   
+00014f60: 2020 2020 2020 2020 2023 2043 6f6e 7465           # Conte
+00014f70: 6e74 2d4c 656e 6774 6820 3a3d 206f 7269  nt-Length := ori
+00014f80: 6769 6e61 6c20 6669 6c65 2073 697a 650a  ginal file size.
+00014f90: 2020 2020 2020 2020 2020 2020 7570 7065              uppe
+00014fa0: 7220 3d20 677a 6970 5f6f 7269 675f 737a  r = gzip_orig_sz
+00014fb0: 2866 735f 7061 7468 290a 2020 2020 2020  (fs_path).      
+00014fc0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+00014fd0: 2020 2020 6f70 656e 5f66 756e 6320 3d20      open_func = 
+00014fe0: 6f70 656e 0a20 2020 2020 2020 2020 2020  open.           
+00014ff0: 2023 2035 3132 206b 4220 6973 206f 7074   # 512 kB is opt
+00015000: 696d 616c 2066 6f72 2068 7567 6520 6669  imal for huge fi
+00015010: 6c65 732c 2075 7365 2036 346b 0a20 2020  les, use 64k.   
+00015020: 2020 2020 2020 2020 206f 7065 6e5f 6172           open_ar
+00015030: 6773 203d 205b 6673 656e 6328 6673 5f70  gs = [fsenc(fs_p
+00015040: 6174 6829 2c20 2272 6222 2c20 3634 202a  ath), "rb", 64 *
+00015050: 2031 3032 345d 0a20 2020 2020 2020 2020   1024].         
+00015060: 2020 2075 7365 5f73 656e 6466 696c 6520     use_sendfile 
+00015070: 3d20 280a 2020 2020 2020 2020 2020 2020  = (.            
+00015080: 2020 2020 6e6f 7420 7365 6c66 2e74 6c73      not self.tls
+00015090: 2020 230a 2020 2020 2020 2020 2020 2020    #.            
+000150a0: 2020 2020 616e 6420 6e6f 7420 7365 6c66      and not self
+000150b0: 2e61 7267 732e 6e6f 5f73 656e 6466 696c  .args.no_sendfil
+000150c0: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
+000150d0: 2020 616e 6420 6861 7361 7474 7228 6f73    and hasattr(os
+000150e0: 2c20 2273 656e 6466 696c 6522 290a 2020  , "sendfile").  
+000150f0: 2020 2020 2020 2020 2020 290a 0a20 2020            )..   
+00015100: 2020 2020 2023 0a20 2020 2020 2020 2023       #.        #
+00015110: 2073 656e 6420 7265 706c 790a 0a20 2020   send reply..   
+00015120: 2020 2020 2069 6620 6973 5f63 6f6d 7072       if is_compr
+00015130: 6573 7365 643a 0a20 2020 2020 2020 2020  essed:.         
+00015140: 2020 2073 656c 662e 6f75 745f 6865 6164     self.out_head
+00015150: 6572 735b 2243 6163 6865 2d43 6f6e 7472  ers["Cache-Contr
+00015160: 6f6c 225d 203d 2022 6d61 782d 6167 653d  ol"] = "max-age=
+00015170: 3630 3438 3639 220a 2020 2020 2020 2020  604869".        
+00015180: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+00015190: 2020 7365 6c66 2e70 6572 6d69 745f 6361    self.permit_ca
+000151a0: 6368 696e 6728 290a 0a20 2020 2020 2020  ching()..       
+000151b0: 2069 6620 2274 7874 2220 696e 2073 656c   if "txt" in sel
+000151c0: 662e 7570 6172 616d 3a0a 2020 2020 2020  f.uparam:.      
+000151d0: 2020 2020 2020 6d69 6d65 203d 2022 7465        mime = "te
+000151e0: 7874 2f70 6c61 696e 3b20 6368 6172 7365  xt/plain; charse
+000151f0: 743d 7b7d 222e 666f 726d 6174 2873 656c  t={}".format(sel
+00015200: 662e 7570 6172 616d 5b22 7478 7422 5d20  f.uparam["txt"] 
+00015210: 6f72 2022 7574 662d 3822 290a 2020 2020  or "utf-8").    
+00015220: 2020 2020 656c 6966 2022 6d69 6d65 2220      elif "mime" 
+00015230: 696e 2073 656c 662e 7570 6172 616d 3a0a  in self.uparam:.
+00015240: 2020 2020 2020 2020 2020 2020 6d69 6d65              mime
+00015250: 203d 2073 7472 2873 656c 662e 7570 6172   = str(self.upar
+00015260: 616d 2e67 6574 2822 6d69 6d65 2229 290a  am.get("mime")).
+00015270: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+00015280: 2020 2020 2020 2020 2020 6d69 6d65 203d            mime =
+00015290: 2067 7565 7373 5f6d 696d 6528 7265 715f   guess_mime(req_
+000152a0: 7061 7468 290a 0a20 2020 2020 2020 2073  path)..        s
+000152b0: 656c 662e 6f75 745f 6865 6164 6572 735b  elf.out_headers[
+000152c0: 2241 6363 6570 742d 5261 6e67 6573 225d  "Accept-Ranges"]
+000152d0: 203d 2022 6279 7465 7322 0a20 2020 2020   = "bytes".     
+000152e0: 2020 2073 656c 662e 7365 6e64 5f68 6561     self.send_hea
+000152f0: 6465 7273 286c 656e 6774 683d 7570 7065  ders(length=uppe
+00015300: 7220 2d20 6c6f 7765 722c 2073 7461 7475  r - lower, statu
+00015310: 733d 7374 6174 7573 2c20 6d69 6d65 3d6d  s=status, mime=m
+00015320: 696d 6529 0a0a 2020 2020 2020 2020 6c6f  ime)..        lo
+00015330: 676d 7367 202b 3d20 756e 6963 6f64 6528  gmsg += unicode(
+00015340: 7374 6174 7573 2920 2b20 6c6f 6774 6169  status) + logtai
+00015350: 6c0a 0a20 2020 2020 2020 2069 6620 7365  l..        if se
+00015360: 6c66 2e6d 6f64 6520 3d3d 2022 4845 4144  lf.mode == "HEAD
+00015370: 2220 6f72 206e 6f74 2064 6f5f 7365 6e64  " or not do_send
+00015380: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
+00015390: 2073 656c 662e 646f 5f6c 6f67 3a0a 2020   self.do_log:.  
+000153a0: 2020 2020 2020 2020 2020 2020 2020 7365                se
+000153b0: 6c66 2e6c 6f67 286c 6f67 6d73 6729 0a0a  lf.log(logmsg)..
+000153c0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+000153d0: 726e 2054 7275 650a 0a20 2020 2020 2020  rn True..       
+000153e0: 2072 6574 203d 2054 7275 650a 2020 2020   ret = True.    
+000153f0: 2020 2020 7769 7468 206f 7065 6e5f 6675      with open_fu
+00015400: 6e63 282a 6f70 656e 5f61 7267 7329 2061  nc(*open_args) a
+00015410: 7320 663a 0a20 2020 2020 2020 2020 2020  s f:.           
+00015420: 2073 656e 6466 756e 203d 2073 656e 6466   sendfun = sendf
+00015430: 696c 655f 6b65 726e 2069 6620 7573 655f  ile_kern if use_
+00015440: 7365 6e64 6669 6c65 2065 6c73 6520 7365  sendfile else se
+00015450: 6e64 6669 6c65 5f70 790a 2020 2020 2020  ndfile_py.      
+00015460: 2020 2020 2020 7265 6d61 696e 7320 3d20        remains = 
+00015470: 7365 6e64 6675 6e28 0a20 2020 2020 2020  sendfun(.       
+00015480: 2020 2020 2020 2020 2073 656c 662e 6c6f           self.lo
+00015490: 672c 206c 6f77 6572 2c20 7570 7065 722c  g, lower, upper,
+000154a0: 2066 2c20 7365 6c66 2e73 2c20 7365 6c66   f, self.s, self
+000154b0: 2e61 7267 732e 735f 7772 5f73 7a2c 2073  .args.s_wr_sz, s
+000154c0: 656c 662e 6172 6773 2e73 5f77 725f 736c  elf.args.s_wr_sl
+000154d0: 700a 2020 2020 2020 2020 2020 2020 290a  p.            ).
+000154e0: 0a20 2020 2020 2020 2069 6620 7265 6d61  .        if rema
+000154f0: 696e 7320 3e20 303a 0a20 2020 2020 2020  ins > 0:.       
+00015500: 2020 2020 206c 6f67 6d73 6720 2b3d 2022       logmsg += "
+00015510: 205c 3033 335b 3331 6d22 202b 2075 6e69   \033[31m" + uni
+00015520: 636f 6465 2875 7070 6572 202d 2072 656d  code(upper - rem
+00015530: 6169 6e73 2920 2b20 225c 3033 335b 306d  ains) + "\033[0m
+00015540: 220a 2020 2020 2020 2020 2020 2020 7365  ".            se
+00015550: 6c66 2e6b 6565 7061 6c69 7665 203d 2046  lf.keepalive = F
+00015560: 616c 7365 0a0a 2020 2020 2020 2020 7370  alse..        sp
+00015570: 6420 3d20 7365 6c66 2e5f 7370 6428 2875  d = self._spd((u
+00015580: 7070 6572 202d 206c 6f77 6572 2920 2d20  pper - lower) - 
+00015590: 7265 6d61 696e 7329 0a20 2020 2020 2020  remains).       
+000155a0: 2069 6620 7365 6c66 2e64 6f5f 6c6f 673a   if self.do_log:
+000155b0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+000155c0: 662e 6c6f 6728 227b 7d2c 2020 7b7d 222e  f.log("{},  {}".
+000155d0: 666f 726d 6174 286c 6f67 6d73 672c 2073  format(logmsg, s
+000155e0: 7064 2929 0a0a 2020 2020 2020 2020 7265  pd))..        re
+000155f0: 7475 726e 2072 6574 0a0a 2020 2020 6465  turn ret..    de
+00015600: 6620 7478 5f7a 6970 280a 2020 2020 2020  f tx_zip(.      
+00015610: 2020 7365 6c66 2c0a 2020 2020 2020 2020    self,.        
+00015620: 666d 7420 2c0a 2020 2020 2020 2020 7561  fmt ,.        ua
+00015630: 7267 202c 0a20 2020 2020 2020 2076 7061  rg ,.        vpa
+00015640: 7468 202c 0a20 2020 2020 2020 2076 6e20  th ,.        vn 
+00015650: 2c0a 2020 2020 2020 2020 7265 6d20 2c0a  ,.        rem ,.
+00015660: 2020 2020 2020 2020 6974 656d 7320 2c0a          items ,.
+00015670: 2020 2020 2020 2020 646f 7473 202c 0a20          dots ,. 
+00015680: 2020 2029 2020 3a0a 2020 2020 2020 2020     )  :.        
+00015690: 6966 2073 656c 662e 6172 6773 2e6e 6f5f  if self.args.no_
+000156a0: 7a69 703a 0a20 2020 2020 2020 2020 2020  zip:.           
+000156b0: 2072 6169 7365 2050 6562 6b61 6328 3430   raise Pebkac(40
+000156c0: 302c 2022 6e6f 7420 656e 6162 6c65 6422  0, "not enabled"
+000156d0: 290a 0a20 2020 2020 2020 206c 6f67 6d73  )..        logms
+000156e0: 6720 3d20 227b 3a34 7d20 7b7d 2022 2e66  g = "{:4} {} ".f
+000156f0: 6f72 6d61 7428 2222 2c20 7365 6c66 2e72  ormat("", self.r
+00015700: 6571 290a 2020 2020 2020 2020 7365 6c66  eq).        self
+00015710: 2e6b 6565 7061 6c69 7665 203d 2046 616c  .keepalive = Fal
+00015720: 7365 0a0a 2020 2020 2020 2020 6966 2066  se..        if f
+00015730: 6d74 203d 3d20 2274 6172 223a 0a20 2020  mt == "tar":.   
+00015740: 2020 2020 2020 2020 206d 696d 6520 3d20           mime = 
+00015750: 2261 7070 6c69 6361 7469 6f6e 2f78 2d74  "application/x-t
+00015760: 6172 220a 2020 2020 2020 2020 2020 2020  ar".            
+00015770: 7061 636b 6572 2020 3d20 5374 7265 616d  packer  = Stream
+00015780: 5461 720a 2020 2020 2020 2020 656c 7365  Tar.        else
+00015790: 3a0a 2020 2020 2020 2020 2020 2020 6d69  :.            mi
+000157a0: 6d65 203d 2022 6170 706c 6963 6174 696f  me = "applicatio
+000157b0: 6e2f 7a69 7022 0a20 2020 2020 2020 2020  n/zip".         
+000157c0: 2020 2070 6163 6b65 7220 3d20 5374 7265     packer = Stre
+000157d0: 616d 5a69 700a 0a20 2020 2020 2020 2066  amZip..        f
+000157e0: 6e20 3d20 6974 656d 735b 305d 2069 6620  n = items[0] if 
+000157f0: 6974 656d 7320 616e 6420 6974 656d 735b  items and items[
+00015800: 305d 2065 6c73 6520 7365 6c66 2e76 7061  0] else self.vpa
+00015810: 7468 0a20 2020 2020 2020 2069 6620 666e  th.        if fn
+00015820: 3a0a 2020 2020 2020 2020 2020 2020 666e  :.            fn
+00015830: 203d 2066 6e2e 7273 7472 6970 2822 2f22   = fn.rstrip("/"
+00015840: 292e 7370 6c69 7428 222f 2229 5b2d 315d  ).split("/")[-1]
+00015850: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
+00015860: 2020 2020 2020 2020 2020 2066 6e20 3d20             fn = 
+00015870: 7365 6c66 2e68 6f73 742e 7370 6c69 7428  self.host.split(
+00015880: 223a 2229 5b30 5d0a 0a20 2020 2020 2020  ":")[0]..       
+00015890: 2073 6166 6520 3d20 2873 7472 696e 672e   safe = (string.
+000158a0: 6173 6369 695f 6c65 7474 6572 7320 2b20  ascii_letters + 
+000158b0: 7374 7269 6e67 2e64 6967 6974 7329 2e72  string.digits).r
+000158c0: 6570 6c61 6365 2822 2522 2c20 2222 290a  eplace("%", "").
+000158d0: 2020 2020 2020 2020 6166 6e20 3d20 2222          afn = ""
+000158e0: 2e6a 6f69 6e28 5b78 2069 6620 7820 696e  .join([x if x in
+000158f0: 2073 6166 652e 7265 706c 6163 6528 2722   safe.replace('"
+00015900: 272c 2022 2229 2065 6c73 6520 225f 2220  ', "") else "_" 
+00015910: 666f 7220 7820 696e 2066 6e5d 290a 2020  for x in fn]).  
+00015920: 2020 2020 2020 6261 7363 6969 203d 2075        bascii = u
+00015930: 6e69 636f 6465 2873 6166 6529 2e65 6e63  nicode(safe).enc
+00015940: 6f64 6528 2275 7466 2d38 2229 0a20 2020  ode("utf-8").   
+00015950: 2020 2020 207a 6220 3d20 666e 2e65 6e63       zb = fn.enc
+00015960: 6f64 6528 2275 7466 2d38 222c 2022 786d  ode("utf-8", "xm
+00015970: 6c63 6861 7272 6566 7265 706c 6163 6522  lcharrefreplace"
+00015980: 290a 2020 2020 2020 2020 6966 206e 6f74  ).        if not
+00015990: 2050 5932 3a0a 2020 2020 2020 2020 2020   PY2:.          
+000159a0: 2020 7a62 6c20 3d20 5b0a 2020 2020 2020    zbl = [.      
+000159b0: 2020 2020 2020 2020 2020 6368 7228 7829            chr(x)
+000159c0: 2e65 6e63 6f64 6528 2275 7466 2d38 2229  .encode("utf-8")
+000159d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000159e0: 2069 6620 7820 696e 2062 6173 6369 690a   if x in bascii.
+000159f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015a00: 656c 7365 2022 257b 3a30 3278 7d22 2e66  else "%{:02x}".f
+00015a10: 6f72 6d61 7428 7829 2e65 6e63 6f64 6528  ormat(x).encode(
+00015a20: 2261 7363 6969 2229 0a20 2020 2020 2020  "ascii").       
+00015a30: 2020 2020 2020 2020 2066 6f72 2078 2069           for x i
+00015a40: 6e20 7a62 0a20 2020 2020 2020 2020 2020  n zb.           
+00015a50: 205d 0a20 2020 2020 2020 2065 6c73 653a   ].        else:
+00015a60: 0a20 2020 2020 2020 2020 2020 207a 626c  .            zbl
+00015a70: 203d 205b 756e 6963 6f64 6528 7829 2069   = [unicode(x) i
+00015a80: 6620 7820 696e 2062 6173 6369 6920 656c  f x in bascii el
+00015a90: 7365 2022 257b 3a30 3278 7d22 2e66 6f72  se "%{:02x}".for
+00015aa0: 6d61 7428 6f72 6428 7829 2920 666f 7220  mat(ord(x)) for 
+00015ab0: 7820 696e 207a 625d 0a0a 2020 2020 2020  x in zb]..      
+00015ac0: 2020 7566 6e20 3d20 6222 222e 6a6f 696e    ufn = b"".join
+00015ad0: 287a 626c 292e 6465 636f 6465 2822 6173  (zbl).decode("as
+00015ae0: 6369 6922 290a 0a20 2020 2020 2020 2063  cii")..        c
+00015af0: 6469 7320 3d20 2261 7474 6163 686d 656e  dis = "attachmen
+00015b00: 743b 2066 696c 656e 616d 653d 5c22 7b7d  t; filename=\"{}
+00015b10: 2e7b 7d5c 223b 2066 696c 656e 616d 652a  .{}\"; filename*
+00015b20: 3d55 5446 2d38 2727 7b7d 2e7b 7d22 0a20  =UTF-8''{}.{}". 
+00015b30: 2020 2020 2020 2063 6469 7320 3d20 6364         cdis = cd
+00015b40: 6973 2e66 6f72 6d61 7428 6166 6e2c 2066  is.format(afn, f
+00015b50: 6d74 2c20 7566 6e2c 2066 6d74 290a 2020  mt, ufn, fmt).  
+00015b60: 2020 2020 2020 7365 6c66 2e6c 6f67 2863        self.log(c
+00015b70: 6469 7329 0a20 2020 2020 2020 2073 656c  dis).        sel
+00015b80: 662e 7365 6e64 5f68 6561 6465 7273 284e  f.send_headers(N
+00015b90: 6f6e 652c 206d 696d 653d 6d69 6d65 2c20  one, mime=mime, 
+00015ba0: 6865 6164 6572 733d 7b22 436f 6e74 656e  headers={"Conten
+00015bb0: 742d 4469 7370 6f73 6974 696f 6e22 3a20  t-Disposition": 
+00015bc0: 6364 6973 7d29 0a0a 2020 2020 2020 2020  cdis})..        
+00015bd0: 6667 656e 203d 2076 6e2e 7a69 7067 656e  fgen = vn.zipgen
+00015be0: 280a 2020 2020 2020 2020 2020 2020 7670  (.            vp
+00015bf0: 6174 682c 2072 656d 2c20 7365 7428 6974  ath, rem, set(it
+00015c00: 656d 7329 2c20 7365 6c66 2e75 6e61 6d65  ems), self.uname
+00015c10: 2c20 646f 7473 2c20 4661 6c73 652c 206e  , dots, False, n
+00015c20: 6f74 2073 656c 662e 6172 6773 2e6e 6f5f  ot self.args.no_
+00015c30: 7363 616e 6469 720a 2020 2020 2020 2020  scandir.        
+00015c40: 290a 2020 2020 2020 2020 2320 666f 7220  ).        # for 
+00015c50: 6620 696e 2066 6765 6e3a 2070 7269 6e74  f in fgen: print
+00015c60: 2872 6570 7228 7b6b 3a20 665b 6b5d 2066  (repr({k: f[k] f
+00015c70: 6f72 206b 2069 6e20 5b22 7670 222c 2022  or k in ["vp", "
+00015c80: 6170 225d 7d29 290a 2020 2020 2020 2020  ap"]})).        
+00015c90: 6267 656e 203d 2070 6163 6b65 7228 7365  bgen = packer(se
+00015ca0: 6c66 2e6c 6f67 2c20 6667 656e 2c20 7574  lf.log, fgen, ut
+00015cb0: 6638 3d22 7574 6622 2069 6e20 7561 7267  f8="utf" in uarg
+00015cc0: 2c20 7072 655f 6372 633d 2263 7263 2220  , pre_crc="crc" 
+00015cd0: 696e 2075 6172 6729 0a20 2020 2020 2020  in uarg).       
+00015ce0: 2062 7365 6e74 203d 2030 0a20 2020 2020   bsent = 0.     
+00015cf0: 2020 2066 6f72 2062 7566 2069 6e20 6267     for buf in bg
+00015d00: 656e 2e67 656e 2829 3a0a 2020 2020 2020  en.gen():.      
+00015d10: 2020 2020 2020 6966 206e 6f74 2062 7566        if not buf
+00015d20: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00015d30: 2020 6272 6561 6b0a 0a20 2020 2020 2020    break..       
+00015d40: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
+00015d50: 2020 2020 2020 2020 2020 7365 6c66 2e73            self.s
+00015d60: 2e73 656e 6461 6c6c 2862 7566 290a 2020  .sendall(buf).  
+00015d70: 2020 2020 2020 2020 2020 2020 2020 6273                bs
+00015d80: 656e 7420 2b3d 206c 656e 2862 7566 290a  ent += len(buf).
+00015d90: 2020 2020 2020 2020 2020 2020 6578 6365              exce
+00015da0: 7074 3a0a 2020 2020 2020 2020 2020 2020  pt:.            
+00015db0: 2020 2020 6c6f 676d 7367 202b 3d20 2220      logmsg += " 
+00015dc0: 5c30 3333 5b33 316d 2220 2b20 756e 6963  \033[31m" + unic
+00015dd0: 6f64 6528 6273 656e 7429 202b 2022 5c30  ode(bsent) + "\0
+00015de0: 3333 5b30 6d22 0a20 2020 2020 2020 2020  33[0m".         
+00015df0: 2020 2020 2020 2062 7265 616b 0a0a 2020         break..  
+00015e00: 2020 2020 2020 7370 6420 3d20 7365 6c66        spd = self
+00015e10: 2e5f 7370 6428 6273 656e 7429 0a20 2020  ._spd(bsent).   
+00015e20: 2020 2020 2073 656c 662e 6c6f 6728 227b       self.log("{
+00015e30: 7d2c 2020 7b7d 222e 666f 726d 6174 286c  },  {}".format(l
+00015e40: 6f67 6d73 672c 2073 7064 2929 0a20 2020  ogmsg, spd)).   
+00015e50: 2020 2020 2072 6574 7572 6e20 5472 7565       return True
+00015e60: 0a0a 2020 2020 6465 6620 7478 5f69 636f  ..    def tx_ico
+00015e70: 2873 656c 662c 2065 7874 202c 2065 7861  (self, ext , exa
+00015e80: 6374 2020 3d20 4661 6c73 6529 2020 3a0a  ct  = False)  :.
+00015e90: 2020 2020 2020 2020 7365 6c66 2e70 6572          self.per
+00015ea0: 6d69 745f 6361 6368 696e 6728 290a 2020  mit_caching().  
+00015eb0: 2020 2020 2020 6966 2065 7874 2e65 6e64        if ext.end
+00015ec0: 7377 6974 6828 222f 2229 3a0a 2020 2020  swith("/"):.    
+00015ed0: 2020 2020 2020 2020 6578 7420 3d20 2266          ext = "f
+00015ee0: 6f6c 6465 7222 0a20 2020 2020 2020 2020  older".         
+00015ef0: 2020 2065 7861 6374 203d 2054 7275 650a     exact = True.
+00015f00: 0a20 2020 2020 2020 2062 6164 203d 2072  .        bad = r
+00015f10: 652e 636f 6d70 696c 6528 7222 5b5d 2829  e.compile(r"[]()
+00015f20: 7b7d 2f20 5b5d 7c5e 5b30 2d39 5f2d 5d2a  {}/ []|^[0-9_-]*
+00015f30: 2422 290a 2020 2020 2020 2020 6e20 3d20  $").        n = 
+00015f40: 6578 742e 7370 6c69 7428 222e 2229 5b3a  ext.split(".")[:
+00015f50: 3a2d 315d 0a20 2020 2020 2020 2069 6620  :-1].        if 
+00015f60: 6e6f 7420 6578 6163 743a 0a20 2020 2020  not exact:.     
+00015f70: 2020 2020 2020 206e 203d 206e 5b3a 2d31         n = n[:-1
+00015f80: 5d0a 0a20 2020 2020 2020 2065 7874 203d  ]..        ext =
+00015f90: 2022 220a 2020 2020 2020 2020 666f 7220   "".        for 
+00015fa0: 7620 696e 206e 3a0a 2020 2020 2020 2020  v in n:.        
+00015fb0: 2020 2020 6966 206c 656e 2876 2920 3e20      if len(v) > 
+00015fc0: 3720 6f72 2062 6164 2e73 6561 7263 6828  7 or bad.search(
+00015fd0: 7629 3a0a 2020 2020 2020 2020 2020 2020  v):.            
+00015fe0: 2020 2020 6272 6561 6b0a 0a20 2020 2020      break..     
+00015ff0: 2020 2020 2020 2065 7874 203d 2022 7b7d         ext = "{}
+00016000: 2e7b 7d22 2e66 6f72 6d61 7428 762c 2065  .{}".format(v, e
+00016010: 7874 290a 0a20 2020 2020 2020 2065 7874  xt)..        ext
+00016020: 203d 2065 7874 2e72 7374 7269 7028 222e   = ext.rstrip(".
+00016030: 2229 206f 7220 2275 6e6b 220a 2020 2020  ") or "unk".    
+00016040: 2020 2020 6966 206c 656e 2865 7874 2920      if len(ext) 
+00016050: 3e20 3131 3a0a 2020 2020 2020 2020 2020  > 11:.          
+00016060: 2020 6578 7420 3d20 22e2 8baf 2220 2b20    ext = "..." + 
+00016070: 6578 745b 2d39 3a5d 0a0a 2020 2020 2020  ext[-9:]..      
+00016080: 2020 2320 6368 726f 6d65 2063 616e 6e6f    # chrome canno
+00016090: 7420 6861 6e64 6c65 206d 6f72 6520 7468  t handle more th
+000160a0: 616e 207e 3230 3030 2075 6e69 7175 6520  an ~2000 unique 
+000160b0: 5356 4773 0a20 2020 2020 2020 2063 6872  SVGs.        chr
+000160c0: 6f6d 6520 3d20 2220 7276 3a22 206e 6f74  ome = " rv:" not
+000160d0: 2069 6e20 7365 6c66 2e75 610a 2020 2020   in self.ua.    
+000160e0: 2020 2020 6d69 6d65 2c20 6963 6f20 3d20      mime, ico = 
+000160f0: 7365 6c66 2e69 636f 2e67 6574 2865 7874  self.ico.get(ext
+00016100: 2c20 6e6f 7420 6578 6163 742c 2063 6872  , not exact, chr
+00016110: 6f6d 6529 0a0a 2020 2020 2020 2020 6c6d  ome)..        lm
+00016120: 203d 2066 6f72 6d61 7464 6174 6528 7365   = formatdate(se
+00016130: 6c66 2e45 2e74 302c 2075 7365 676d 743d  lf.E.t0, usegmt=
+00016140: 5472 7565 290a 2020 2020 2020 2020 7365  True).        se
+00016150: 6c66 2e72 6570 6c79 2869 636f 2c20 6d69  lf.reply(ico, mi
+00016160: 6d65 3d6d 696d 652c 2068 6561 6465 7273  me=mime, headers
+00016170: 3d7b 224c 6173 742d 4d6f 6469 6669 6564  ={"Last-Modified
+00016180: 223a 206c 6d7d 290a 2020 2020 2020 2020  ": lm}).        
+00016190: 7265 7475 726e 2054 7275 650a 0a20 2020  return True..   
+000161a0: 2064 6566 2074 785f 6d64 2873 656c 662c   def tx_md(self,
+000161b0: 2066 735f 7061 7468 2029 2020 3a0a 2020   fs_path )  :.  
+000161c0: 2020 2020 2020 6c6f 676d 7367 203d 2022        logmsg = "
+000161d0: 2020 2020 2025 7320 4025 7320 2220 2520       %s @%s " % 
+000161e0: 2873 656c 662e 7265 712c 2073 656c 662e  (self.req, self.
+000161f0: 756e 616d 6529 0a0a 2020 2020 2020 2020  uname)..        
+00016200: 6966 206e 6f74 2073 656c 662e 6361 6e5f  if not self.can_
+00016210: 7772 6974 653a 0a20 2020 2020 2020 2020  write:.         
+00016220: 2020 2069 6620 2265 6469 7422 2069 6e20     if "edit" in 
+00016230: 7365 6c66 2e75 7061 7261 6d20 6f72 2022  self.uparam or "
+00016240: 6564 6974 3222 2069 6e20 7365 6c66 2e75  edit2" in self.u
+00016250: 7061 7261 6d3a 0a20 2020 2020 2020 2020  param:.         
+00016260: 2020 2020 2020 2072 6574 7572 6e20 7365         return se
+00016270: 6c66 2e74 785f 3430 3428 5472 7565 290a  lf.tx_404(True).
+00016280: 0a20 2020 2020 2020 2074 706c 203d 2022  .        tpl = "
+00016290: 6d64 6522 2069 6620 2265 6469 7432 2220  mde" if "edit2" 
+000162a0: 696e 2073 656c 662e 7570 6172 616d 2065  in self.uparam e
+000162b0: 6c73 6520 226d 6422 0a20 2020 2020 2020  lse "md".       
+000162c0: 2068 746d 6c5f 7061 7468 203d 206f 732e   html_path = os.
+000162d0: 7061 7468 2e6a 6f69 6e28 7365 6c66 2e45  path.join(self.E
+000162e0: 2e6d 6f64 2c20 2277 6562 222c 2022 7b7d  .mod, "web", "{}
+000162f0: 2e68 746d 6c22 2e66 6f72 6d61 7428 7470  .html".format(tp
+00016300: 6c29 290a 2020 2020 2020 2020 7465 6d70  l)).        temp
+00016310: 6c61 7465 203d 2073 656c 662e 6a32 6a28  late = self.j2j(
+00016320: 7470 6c29 0a0a 2020 2020 2020 2020 7374  tpl)..        st
+00016330: 203d 2062 6f73 2e73 7461 7428 6673 5f70   = bos.stat(fs_p
+00016340: 6174 6829 0a20 2020 2020 2020 2074 735f  ath).        ts_
+00016350: 6d64 203d 2073 742e 7374 5f6d 7469 6d65  md = st.st_mtime
+00016360: 0a0a 2020 2020 2020 2020 7374 203d 2062  ..        st = b
+00016370: 6f73 2e73 7461 7428 6874 6d6c 5f70 6174  os.stat(html_pat
+00016380: 6829 0a20 2020 2020 2020 2074 735f 6874  h).        ts_ht
+00016390: 6d6c 203d 2073 742e 7374 5f6d 7469 6d65  ml = st.st_mtime
+000163a0: 0a0a 2020 2020 2020 2020 737a 5f6d 6420  ..        sz_md 
+000163b0: 3d20 300a 2020 2020 2020 2020 666f 7220  = 0.        for 
+000163c0: 6275 6620 696e 2079 6965 6c64 6669 6c65  buf in yieldfile
+000163d0: 2866 735f 7061 7468 293a 0a20 2020 2020  (fs_path):.     
+000163e0: 2020 2020 2020 2073 7a5f 6d64 202b 3d20         sz_md += 
+000163f0: 6c65 6e28 6275 6629 0a20 2020 2020 2020  len(buf).       
+00016400: 2020 2020 2066 6f72 2063 2c20 7620 696e       for c, v in
+00016410: 205b 2862 2226 222c 2034 292c 2028 6222   [(b"&", 4), (b"
+00016420: 3c22 2c20 3329 2c20 2862 223e 222c 2033  <", 3), (b">", 3
+00016430: 295d 3a0a 2020 2020 2020 2020 2020 2020  )]:.            
+00016440: 2020 2020 737a 5f6d 6420 2b3d 2028 6c65      sz_md += (le
+00016450: 6e28 6275 6629 202d 206c 656e 2862 7566  n(buf) - len(buf
+00016460: 2e72 6570 6c61 6365 2863 2c20 6222 2229  .replace(c, b"")
+00016470: 2929 202a 2076 0a0a 2020 2020 2020 2020  )) * v..        
+00016480: 6669 6c65 5f74 7320 3d20 696e 7428 6d61  file_ts = int(ma
+00016490: 7828 7473 5f6d 642c 2074 735f 6874 6d6c  x(ts_md, ts_html
+000164a0: 2c20 7365 6c66 2e45 2e74 3029 290a 2020  , self.E.t0)).  
+000164b0: 2020 2020 2020 6669 6c65 5f6c 6173 746d        file_lastm
+000164c0: 6f64 2c20 646f 5f73 656e 6420 3d20 7365  od, do_send = se
+000164d0: 6c66 2e5f 6368 6b5f 6c61 7374 6d6f 6428  lf._chk_lastmod(
+000164e0: 6669 6c65 5f74 7329 0a20 2020 2020 2020  file_ts).       
+000164f0: 2073 656c 662e 6f75 745f 6865 6164 6572   self.out_header
+00016500: 735b 224c 6173 742d 4d6f 6469 6669 6564  s["Last-Modified
+00016510: 225d 203d 2066 696c 655f 6c61 7374 6d6f  "] = file_lastmo
+00016520: 640a 2020 2020 2020 2020 7365 6c66 2e6f  d.        self.o
+00016530: 7574 5f68 6561 6465 7273 2e75 7064 6174  ut_headers.updat
+00016540: 6528 4e4f 5f43 4143 4845 290a 2020 2020  e(NO_CACHE).    
+00016550: 2020 2020 7374 6174 7573 203d 2032 3030      status = 200
+00016560: 2069 6620 646f 5f73 656e 6420 656c 7365   if do_send else
+00016570: 2033 3034 0a0a 2020 2020 2020 2020 6172   304..        ar
+00016580: 675f 6261 7365 203d 2022 3f22 0a20 2020  g_base = "?".   
+00016590: 2020 2020 2069 6620 226b 2220 696e 2073       if "k" in s
+000165a0: 656c 662e 7570 6172 616d 3a0a 2020 2020  elf.uparam:.    
+000165b0: 2020 2020 2020 2020 6172 675f 6261 7365          arg_base
+000165c0: 203d 2022 3f6b 3d7b 7d26 222e 666f 726d   = "?k={}&".form
+000165d0: 6174 2873 656c 662e 7570 6172 616d 5b22  at(self.uparam["
+000165e0: 6b22 5d29 0a0a 2020 2020 2020 2020 626f  k"])..        bo
+000165f0: 756e 6461 7279 203d 2022 5c72 6f6c 6c5c  undary = "\roll\
+00016600: 7469 6465 220a 2020 2020 2020 2020 7461  tide".        ta
+00016610: 7267 7320 3d20 7b0a 2020 2020 2020 2020  rgs = {.        
+00016620: 2020 2020 2272 223a 2073 656c 662e 6172      "r": self.ar
+00016630: 6773 2e53 5220 6966 2073 656c 662e 6973  gs.SR if self.is
+00016640: 5f76 7072 6f78 6965 6420 656c 7365 2022  _vproxied else "
+00016650: 222c 0a20 2020 2020 2020 2020 2020 2022  ",.            "
+00016660: 7473 223a 2073 656c 662e 636f 6e6e 2e68  ts": self.conn.h
+00016670: 7372 762e 6361 6368 6562 7573 7465 7228  srv.cachebuster(
+00016680: 292c 0a20 2020 2020 2020 2020 2020 2022  ),.            "
+00016690: 7376 636e 616d 6522 3a20 7365 6c66 2e61  svcname": self.a
+000166a0: 7267 732e 646f 6374 6974 6c65 2c0a 2020  rgs.doctitle,.  
+000166b0: 2020 2020 2020 2020 2020 2268 746d 6c5f            "html_
+000166c0: 6865 6164 223a 2073 656c 662e 6874 6d6c  head": self.html
+000166d0: 5f68 6561 642c 0a20 2020 2020 2020 2020  _head,.         
+000166e0: 2020 2022 6564 6974 223a 2022 6564 6974     "edit": "edit
+000166f0: 2220 696e 2073 656c 662e 7570 6172 616d  " in self.uparam
+00016700: 2c0a 2020 2020 2020 2020 2020 2020 2274  ,.            "t
+00016710: 6974 6c65 223a 2068 746d 6c5f 6573 6361  itle": html_esca
+00016720: 7065 2873 656c 662e 7670 6174 682c 2063  pe(self.vpath, c
+00016730: 726c 663d 5472 7565 292c 0a20 2020 2020  rlf=True),.     
+00016740: 2020 2020 2020 2022 6c61 7374 6d6f 6422         "lastmod"
+00016750: 3a20 696e 7428 7473 5f6d 6420 2a20 3130  : int(ts_md * 10
+00016760: 3030 292c 0a20 2020 2020 2020 2020 2020  00),.           
+00016770: 2022 6c61 6e67 223a 2073 656c 662e 6172   "lang": self.ar
+00016780: 6773 2e6c 616e 672c 0a20 2020 2020 2020  gs.lang,.       
+00016790: 2020 2020 2022 6661 7669 636f 223a 2073       "favico": s
+000167a0: 656c 662e 6172 6773 2e66 6176 6963 6f2c  elf.args.favico,
+000167b0: 0a20 2020 2020 2020 2020 2020 2022 6861  .            "ha
+000167c0: 7665 5f65 6d70 223a 2073 656c 662e 6172  ve_emp": self.ar
+000167d0: 6773 2e65 6d70 2c0a 2020 2020 2020 2020  gs.emp,.        
+000167e0: 2020 2020 226d 645f 6368 6b5f 7261 7465      "md_chk_rate
+000167f0: 223a 2073 656c 662e 6172 6773 2e6d 6372  ": self.args.mcr
+00016800: 2c0a 2020 2020 2020 2020 2020 2020 226d  ,.            "m
+00016810: 6422 3a20 626f 756e 6461 7279 2c0a 2020  d": boundary,.  
+00016820: 2020 2020 2020 2020 2020 2261 7267 5f62            "arg_b
+00016830: 6173 6522 3a20 6172 675f 6261 7365 2c0a  ase": arg_base,.
+00016840: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
+00016850: 2020 7a73 203d 2074 656d 706c 6174 652e    zs = template.
+00016860: 7265 6e64 6572 282a 2a74 6172 6773 292e  render(**targs).
+00016870: 656e 636f 6465 2822 7574 662d 3822 2c20  encode("utf-8", 
+00016880: 2272 6570 6c61 6365 2229 0a20 2020 2020  "replace").     
+00016890: 2020 2068 746d 6c20 3d20 7a73 2e73 706c     html = zs.spl
+000168a0: 6974 2862 6f75 6e64 6172 792e 656e 636f  it(boundary.enco
+000168b0: 6465 2822 7574 662d 3822 2929 0a20 2020  de("utf-8")).   
+000168c0: 2020 2020 2069 6620 6c65 6e28 6874 6d6c       if len(html
+000168d0: 2920 213d 2032 3a0a 2020 2020 2020 2020  ) != 2:.        
+000168e0: 2020 2020 7261 6973 6520 4578 6365 7074      raise Except
+000168f0: 696f 6e28 2262 6f75 6e64 6172 7920 6170  ion("boundary ap
+00016900: 7065 6172 7320 696e 2022 202b 2068 746d  pears in " + htm
+00016910: 6c5f 7061 7468 290a 0a20 2020 2020 2020  l_path)..       
+00016920: 2073 656c 662e 7365 6e64 5f68 6561 6465   self.send_heade
+00016930: 7273 2873 7a5f 6d64 202b 206c 656e 2868  rs(sz_md + len(h
+00016940: 746d 6c5b 305d 2920 2b20 6c65 6e28 6874  tml[0]) + len(ht
+00016950: 6d6c 5b31 5d29 2c20 7374 6174 7573 290a  ml[1]), status).
+00016960: 0a20 2020 2020 2020 206c 6f67 6d73 6720  .        logmsg 
+00016970: 2b3d 2075 6e69 636f 6465 2873 7461 7475  += unicode(statu
+00016980: 7329 0a20 2020 2020 2020 2069 6620 7365  s).        if se
+00016990: 6c66 2e6d 6f64 6520 3d3d 2022 4845 4144  lf.mode == "HEAD
+000169a0: 2220 6f72 206e 6f74 2064 6f5f 7365 6e64  " or not do_send
+000169b0: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
+000169c0: 2073 656c 662e 646f 5f6c 6f67 3a0a 2020   self.do_log:.  
+000169d0: 2020 2020 2020 2020 2020 2020 2020 7365                se
+000169e0: 6c66 2e6c 6f67 286c 6f67 6d73 6729 0a0a  lf.log(logmsg)..
+000169f0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+00016a00: 726e 2054 7275 650a 0a20 2020 2020 2020  rn True..       
+00016a10: 2074 7279 3a0a 2020 2020 2020 2020 2020   try:.          
+00016a20: 2020 7365 6c66 2e73 2e73 656e 6461 6c6c    self.s.sendall
+00016a30: 2868 746d 6c5b 305d 290a 2020 2020 2020  (html[0]).      
+00016a40: 2020 2020 2020 666f 7220 6275 6620 696e        for buf in
+00016a50: 2079 6965 6c64 6669 6c65 2866 735f 7061   yieldfile(fs_pa
+00016a60: 7468 293a 0a20 2020 2020 2020 2020 2020  th):.           
+00016a70: 2020 2020 2073 656c 662e 732e 7365 6e64       self.s.send
+00016a80: 616c 6c28 6874 6d6c 5f62 6573 6361 7065  all(html_bescape
+00016a90: 2862 7566 2929 0a0a 2020 2020 2020 2020  (buf))..        
+00016aa0: 2020 2020 7365 6c66 2e73 2e73 656e 6461      self.s.senda
+00016ab0: 6c6c 2868 746d 6c5b 315d 290a 0a20 2020  ll(html[1])..   
+00016ac0: 2020 2020 2065 7863 6570 743a 0a20 2020       except:.   
+00016ad0: 2020 2020 2020 2020 2073 656c 662e 6c6f           self.lo
+00016ae0: 6728 6c6f 676d 7367 202b 2022 205c 3033  g(logmsg + " \03
+00016af0: 335b 3331 6d64 2f63 5c30 3333 5b30 6d22  3[31md/c\033[0m"
+00016b00: 290a 2020 2020 2020 2020 2020 2020 7265  ).            re
+00016b10: 7475 726e 2046 616c 7365 0a0a 2020 2020  turn False..    
+00016b20: 2020 2020 6966 2073 656c 662e 646f 5f6c      if self.do_l
+00016b30: 6f67 3a0a 2020 2020 2020 2020 2020 2020  og:.            
+00016b40: 7365 6c66 2e6c 6f67 286c 6f67 6d73 6720  self.log(logmsg 
+00016b50: 2b20 2220 2220 2b20 756e 6963 6f64 6528  + " " + unicode(
+00016b60: 6c65 6e28 6874 6d6c 2929 290a 0a20 2020  len(html)))..   
+00016b70: 2020 2020 2072 6574 7572 6e20 5472 7565       return True
+00016b80: 0a0a 2020 2020 6465 6620 7478 5f73 7663  ..    def tx_svc
+00016b90: 7328 7365 6c66 2920 203a 0a20 2020 2020  s(self)  :.     
+00016ba0: 2020 2061 6e61 6d65 203d 2072 652e 7375     aname = re.su
+00016bb0: 6228 225b 5e30 2d39 612d 7a41 2d5a 5d2b  b("[^0-9a-zA-Z]+
+00016bc0: 222c 2022 222c 2073 656c 662e 6172 6773  ", "", self.args
+00016bd0: 2e6e 616d 6529 206f 7220 2261 220a 2020  .name) or "a".  
+00016be0: 2020 2020 2020 6570 203d 2073 656c 662e        ep = self.
+00016bf0: 686f 7374 0a20 2020 2020 2020 2068 6f73  host.        hos
+00016c00: 7420 3d20 6570 2e73 706c 6974 2822 3a22  t = ep.split(":"
+00016c10: 295b 305d 0a20 2020 2020 2020 2068 706f  )[0].        hpo
+00016c20: 7274 203d 2065 705b 6570 2e66 696e 6428  rt = ep[ep.find(
+00016c30: 223a 2229 203a 5d20 6966 2022 3a22 2069  ":") :] if ":" i
+00016c40: 6e20 6570 2065 6c73 6520 2222 0a20 2020  n ep else "".   
+00016c50: 2020 2020 2072 6970 203d 2028 0a20 2020       rip = (.   
+00016c60: 2020 2020 2020 2020 2068 6f73 740a 2020           host.  
+00016c70: 2020 2020 2020 2020 2020 6966 2073 656c            if sel
+00016c80: 662e 6172 6773 2e72 636c 6f6e 655f 6d64  f.args.rclone_md
+00016c90: 6e73 206f 7220 6e6f 7420 7365 6c66 2e61  ns or not self.a
+00016ca0: 7267 732e 7a6d 0a20 2020 2020 2020 2020  rgs.zm.         
+00016cb0: 2020 2065 6c73 6520 7365 6c66 2e63 6f6e     else self.con
+00016cc0: 6e2e 6873 7276 2e6e 6d2e 6d61 7028 7365  n.hsrv.nm.map(se
+00016cd0: 6c66 2e69 7029 206f 7220 686f 7374 0a20  lf.ip) or host. 
+00016ce0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+00016cf0: 2076 7020 3d20 2873 656c 662e 7570 6172   vp = (self.upar
+00016d00: 616d 5b22 6863 225d 206f 7220 2222 292e  am["hc"] or "").
+00016d10: 6c73 7472 6970 2822 2f22 290a 2020 2020  lstrip("/").    
+00016d20: 2020 2020 6874 6d6c 203d 2073 656c 662e      html = self.
+00016d30: 6a32 7328 0a20 2020 2020 2020 2020 2020  j2s(.           
+00016d40: 2022 7376 6373 222c 0a20 2020 2020 2020   "svcs",.       
+00016d50: 2020 2020 2061 7267 733d 7365 6c66 2e61       args=self.a
+00016d60: 7267 732c 0a20 2020 2020 2020 2020 2020  rgs,.           
+00016d70: 2061 6363 733d 626f 6f6c 2873 656c 662e   accs=bool(self.
+00016d80: 6173 7276 2e61 6363 7429 2c0a 2020 2020  asrv.acct),.    
+00016d90: 2020 2020 2020 2020 733d 2273 2220 6966          s="s" if
+00016da0: 2073 656c 662e 6973 5f68 7474 7073 2065   self.is_https e
+00016db0: 6c73 6520 2222 2c0a 2020 2020 2020 2020  lse "",.        
+00016dc0: 2020 2020 7269 703d 7269 702c 0a20 2020      rip=rip,.   
+00016dd0: 2020 2020 2020 2020 2065 703d 6570 2c0a           ep=ep,.
+00016de0: 2020 2020 2020 2020 2020 2020 7670 3d76              vp=v
+00016df0: 702c 0a20 2020 2020 2020 2020 2020 2072  p,.            r
+00016e00: 7670 3d76 6a6f 696e 2873 656c 662e 6172  vp=vjoin(self.ar
+00016e10: 6773 2e52 2c20 7670 292c 0a20 2020 2020  gs.R, vp),.     
+00016e20: 2020 2020 2020 2068 6f73 743d 686f 7374         host=host
+00016e30: 2c0a 2020 2020 2020 2020 2020 2020 6870  ,.            hp
+00016e40: 6f72 743d 6870 6f72 742c 0a20 2020 2020  ort=hport,.     
+00016e50: 2020 2020 2020 2061 6e61 6d65 3d61 6e61         aname=ana
+00016e60: 6d65 2c0a 2020 2020 2020 2020 2020 2020  me,.            
+00016e70: 7077 3d73 656c 662e 7077 206f 7220 2270  pw=self.pw or "p
+00016e80: 7722 2c0a 2020 2020 2020 2020 290a 2020  w",.        ).  
+00016e90: 2020 2020 2020 7365 6c66 2e72 6570 6c79        self.reply
+00016ea0: 2868 746d 6c2e 656e 636f 6465 2822 7574  (html.encode("ut
+00016eb0: 662d 3822 2929 0a20 2020 2020 2020 2072  f-8")).        r
+00016ec0: 6574 7572 6e20 5472 7565 0a0a 2020 2020  eturn True..    
+00016ed0: 6465 6620 7478 5f6d 6f75 6e74 7328 7365  def tx_mounts(se
+00016ee0: 6c66 2920 203a 0a20 2020 2020 2020 2073  lf)  :.        s
+00016ef0: 7566 203d 2073 656c 662e 7572 6c71 287b  uf = self.urlq({
+00016f00: 7d2c 205b 2268 225d 290a 2020 2020 2020  }, ["h"]).      
+00016f10: 2020 6176 6f6c 203d 205b 7820 666f 7220    avol = [x for 
+00016f20: 7820 696e 2073 656c 662e 7776 6f6c 2069  x in self.wvol i
+00016f30: 6620 7820 696e 2073 656c 662e 7276 6f6c  f x in self.rvol
+00016f40: 5d0a 2020 2020 2020 2020 7276 6f6c 2c20  ].        rvol, 
+00016f50: 7776 6f6c 2c20 6176 6f6c 203d 205b 0a20  wvol, avol = [. 
+00016f60: 2020 2020 2020 2020 2020 205b 2822 2f22             [("/"
+00016f70: 202b 2078 292e 7273 7472 6970 2822 2f22   + x).rstrip("/"
+00016f80: 2920 2b20 222f 2220 666f 7220 7820 696e  ) + "/" for x in
+00016f90: 2079 5d0a 2020 2020 2020 2020 2020 2020   y].            
+00016fa0: 666f 7220 7920 696e 205b 7365 6c66 2e72  for y in [self.r
+00016fb0: 766f 6c2c 2073 656c 662e 7776 6f6c 2c20  vol, self.wvol, 
+00016fc0: 6176 6f6c 5d0a 2020 2020 2020 2020 5d0a  avol].        ].
+00016fd0: 0a20 2020 2020 2020 2069 6620 6176 6f6c  .        if avol
+00016fe0: 2061 6e64 206e 6f74 2073 656c 662e 6172   and not self.ar
+00016ff0: 6773 2e6e 6f5f 7265 7363 616e 3a0a 2020  gs.no_rescan:.  
+00017000: 2020 2020 2020 2020 2020 7820 3d20 7365            x = se
+00017010: 6c66 2e63 6f6e 6e2e 6873 7276 2e62 726f  lf.conn.hsrv.bro
+00017020: 6b65 722e 6173 6b28 2275 7032 6b2e 6765  ker.ask("up2k.ge
+00017030: 745f 7374 6174 6522 290a 2020 2020 2020  t_state").      
+00017040: 2020 2020 2020 7673 203d 206a 736f 6e2e        vs = json.
+00017050: 6c6f 6164 7328 782e 6765 7428 2929 0a20  loads(x.get()). 
+00017060: 2020 2020 2020 2020 2020 2076 7374 6174             vstat
+00017070: 6520 3d20 7b28 222f 2220 2b20 6b29 2e72  e = {("/" + k).r
+00017080: 7374 7269 7028 222f 2229 202b 2022 2f22  strip("/") + "/"
+00017090: 3a20 7620 666f 7220 6b2c 2076 2069 6e20  : v for k, v in 
+000170a0: 7673 5b22 766f 6c73 7461 7465 225d 2e69  vs["volstate"].i
+000170b0: 7465 6d73 2829 7d0a 2020 2020 2020 2020  tems()}.        
+000170c0: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+000170d0: 2020 7673 7461 7465 203d 207b 7d0a 2020    vstate = {}.  
+000170e0: 2020 2020 2020 2020 2020 7673 203d 207b            vs = {
+000170f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00017100: 2022 7363 616e 6e69 6e67 223a 204e 6f6e   "scanning": Non
+00017110: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
+00017120: 2020 2022 6861 7368 7122 3a20 4e6f 6e65     "hashq": None
+00017130: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00017140: 2020 2274 6167 7122 3a20 4e6f 6e65 2c0a    "tagq": None,.
+00017150: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017160: 226d 7470 7122 3a20 4e6f 6e65 2c0a 2020  "mtpq": None,.  
+00017170: 2020 2020 2020 2020 2020 2020 2020 2264                "d
+00017180: 6277 7422 3a20 4e6f 6e65 2c0a 2020 2020  bwt": None,.    
+00017190: 2020 2020 2020 2020 7d0a 0a20 2020 2020          }..     
+000171a0: 2020 2066 6d74 203d 2073 656c 662e 7570     fmt = self.up
+000171b0: 6172 616d 2e67 6574 2822 6c73 222c 2022  aram.get("ls", "
+000171c0: 2229 0a20 2020 2020 2020 2069 6620 6e6f  ").        if no
+000171d0: 7420 666d 7420 616e 6420 2873 656c 662e  t fmt and (self.
+000171e0: 7561 2e73 7461 7274 7377 6974 6828 2263  ua.startswith("c
+000171f0: 7572 6c2f 2229 206f 7220 7365 6c66 2e75  url/") or self.u
+00017200: 612e 7374 6172 7473 7769 7468 2822 6665  a.startswith("fe
+00017210: 7463 6822 2929 3a0a 2020 2020 2020 2020  tch")):.        
+00017220: 2020 2020 666d 7420 3d20 2276 220a 0a20      fmt = "v".. 
+00017230: 2020 2020 2020 2069 6620 666d 7420 696e         if fmt in
+00017240: 205b 2276 222c 2022 7422 2c20 2274 7874   ["v", "t", "txt
+00017250: 225d 3a0a 2020 2020 2020 2020 2020 2020  "]:.            
+00017260: 6966 2073 656c 662e 756e 616d 6520 3d3d  if self.uname ==
+00017270: 2022 2a22 3a0a 2020 2020 2020 2020 2020   "*":.          
+00017280: 2020 2020 2020 7478 7420 3d20 2268 6f77        txt = "how
+00017290: 6479 2073 7472 616e 6765 7220 2879 6f75  dy stranger (you
+000172a0: 2772 6520 6e6f 7420 6c6f 6767 6564 2069  're not logged i
+000172b0: 6e29 220a 2020 2020 2020 2020 2020 2020  n)".            
+000172c0: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+000172d0: 2020 2020 2020 7478 7420 3d20 2277 656c        txt = "wel
+000172e0: 636f 6d65 2062 6163 6b20 7b7d 222e 666f  come back {}".fo
+000172f0: 726d 6174 2873 656c 662e 756e 616d 6529  rmat(self.uname)
+00017300: 0a0a 2020 2020 2020 2020 2020 2020 6966  ..            if
+00017310: 2076 7374 6174 653a 0a20 2020 2020 2020   vstate:.       
+00017320: 2020 2020 2020 2020 2074 7874 202b 3d20           txt += 
+00017330: 225c 6e73 7461 7475 733a 220a 2020 2020  "\nstatus:".    
+00017340: 2020 2020 2020 2020 2020 2020 666f 7220              for 
+00017350: 6b20 696e 205b 2273 6361 6e6e 696e 6722  k in ["scanning"
+00017360: 2c20 2268 6173 6871 222c 2022 7461 6771  , "hashq", "tagq
+00017370: 222c 2022 6d74 7071 222c 2022 6462 7774  ", "mtpq", "dbwt
+00017380: 225d 3a0a 2020 2020 2020 2020 2020 2020  "]:.            
+00017390: 2020 2020 2020 2020 7478 7420 2b3d 2022          txt += "
+000173a0: 207b 7d28 7b7d 2922 2e66 6f72 6d61 7428   {}({})".format(
+000173b0: 6b2c 2076 735b 6b5d 290a 0a20 2020 2020  k, vs[k])..     
+000173c0: 2020 2020 2020 2069 6620 7276 6f6c 3a0a         if rvol:.
+000173d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000173e0: 7478 7420 2b3d 2022 5c6e 796f 7520 6361  txt += "\nyou ca
+000173f0: 6e20 6272 6f77 7365 3a22 0a20 2020 2020  n browse:".     
+00017400: 2020 2020 2020 2020 2020 2066 6f72 2076             for v
+00017410: 2069 6e20 7276 6f6c 3a0a 2020 2020 2020   in rvol:.      
+00017420: 2020 2020 2020 2020 2020 2020 2020 7478                tx
+00017430: 7420 2b3d 2022 5c6e 2020 2220 2b20 760a  t += "\n  " + v.
+00017440: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+00017450: 7776 6f6c 3a0a 2020 2020 2020 2020 2020  wvol:.          
+00017460: 2020 2020 2020 7478 7420 2b3d 2022 5c6e        txt += "\n
+00017470: 796f 7520 6361 6e20 7570 6c6f 6164 2074  you can upload t
+00017480: 6f3a 220a 2020 2020 2020 2020 2020 2020  o:".            
+00017490: 2020 2020 666f 7220 7620 696e 2077 766f      for v in wvo
+000174a0: 6c3a 0a20 2020 2020 2020 2020 2020 2020  l:.             
+000174b0: 2020 2020 2020 2074 7874 202b 3d20 225c         txt += "\
+000174c0: 6e20 2022 202b 2076 0a0a 2020 2020 2020  n  " + v..      
+000174d0: 2020 2020 2020 7a62 203d 2074 7874 2e65        zb = txt.e
+000174e0: 6e63 6f64 6528 2275 7466 2d38 222c 2022  ncode("utf-8", "
+000174f0: 7265 706c 6163 6522 2920 2b20 6222 5c6e  replace") + b"\n
+00017500: 220a 2020 2020 2020 2020 2020 2020 7365  ".            se
+00017510: 6c66 2e72 6570 6c79 287a 622c 206d 696d  lf.reply(zb, mim
+00017520: 653d 2274 6578 742f 706c 6169 6e3b 2063  e="text/plain; c
+00017530: 6861 7273 6574 3d75 7466 2d38 2229 0a20  harset=utf-8"). 
+00017540: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+00017550: 6e20 5472 7565 0a0a 2020 2020 2020 2020  n True..        
+00017560: 6874 6d6c 203d 2073 656c 662e 6a32 7328  html = self.j2s(
+00017570: 0a20 2020 2020 2020 2020 2020 2022 7370  .            "sp
+00017580: 6c61 7368 222c 0a20 2020 2020 2020 2020  lash",.         
+00017590: 2020 2074 6869 733d 7365 6c66 2c0a 2020     this=self,.  
+000175a0: 2020 2020 2020 2020 2020 7176 7061 7468            qvpath
+000175b0: 3d71 756f 7465 7028 7365 6c66 2e76 7061  =quotep(self.vpa
+000175c0: 7468 292c 0a20 2020 2020 2020 2020 2020  th),.           
+000175d0: 2072 766f 6c3d 7276 6f6c 2c0a 2020 2020   rvol=rvol,.    
+000175e0: 2020 2020 2020 2020 7776 6f6c 3d77 766f          wvol=wvo
+000175f0: 6c2c 0a20 2020 2020 2020 2020 2020 2061  l,.            a
+00017600: 766f 6c3d 6176 6f6c 2c0a 2020 2020 2020  vol=avol,.      
+00017610: 2020 2020 2020 7673 7461 7465 3d76 7374        vstate=vst
+00017620: 6174 652c 0a20 2020 2020 2020 2020 2020  ate,.           
+00017630: 2073 6361 6e6e 696e 673d 7673 5b22 7363   scanning=vs["sc
+00017640: 616e 6e69 6e67 225d 2c0a 2020 2020 2020  anning"],.      
+00017650: 2020 2020 2020 6861 7368 713d 7673 5b22        hashq=vs["
+00017660: 6861 7368 7122 5d2c 0a20 2020 2020 2020  hashq"],.       
+00017670: 2020 2020 2074 6167 713d 7673 5b22 7461       tagq=vs["ta
+00017680: 6771 225d 2c0a 2020 2020 2020 2020 2020  gq"],.          
+00017690: 2020 6d74 7071 3d76 735b 226d 7470 7122    mtpq=vs["mtpq"
+000176a0: 5d2c 0a20 2020 2020 2020 2020 2020 2064  ],.            d
+000176b0: 6277 743d 7673 5b22 6462 7774 225d 2c0a  bwt=vs["dbwt"],.
+000176c0: 2020 2020 2020 2020 2020 2020 7572 6c5f              url_
+000176d0: 7375 663d 7375 662c 0a20 2020 2020 2020  suf=suf,.       
+000176e0: 2020 2020 206b 3330 343d 7365 6c66 2e6b       k304=self.k
+000176f0: 3330 3428 292c 0a20 2020 2020 2020 2020  304(),.         
+00017700: 2020 2076 6572 3d53 5f56 4552 5349 4f4e     ver=S_VERSION
+00017710: 2069 6620 7365 6c66 2e61 7267 732e 7665   if self.args.ve
+00017720: 7220 656c 7365 2022 222c 0a20 2020 2020  r else "",.     
+00017730: 2020 2020 2020 2061 6874 7470 733d 2222         ahttps=""
+00017740: 2069 6620 7365 6c66 2e69 735f 6874 7470   if self.is_http
+00017750: 7320 656c 7365 2022 6874 7470 733a 2f2f  s else "https://
+00017760: 2220 2b20 7365 6c66 2e68 6f73 7420 2b20  " + self.host + 
+00017770: 7365 6c66 2e72 6571 2c0a 2020 2020 2020  self.req,.      
+00017780: 2020 290a 2020 2020 2020 2020 7365 6c66    ).        self
+00017790: 2e72 6570 6c79 2868 746d 6c2e 656e 636f  .reply(html.enco
+000177a0: 6465 2822 7574 662d 3822 2929 0a20 2020  de("utf-8")).   
+000177b0: 2020 2020 2072 6574 7572 6e20 5472 7565       return True
+000177c0: 0a0a 2020 2020 6465 6620 7365 745f 6b33  ..    def set_k3
+000177d0: 3034 2873 656c 6629 2020 3a0a 2020 2020  04(self)  :.    
+000177e0: 2020 2020 636b 203d 2067 656e 636f 6f6b      ck = gencook
+000177f0: 6965 2822 6b33 3034 222c 2073 656c 662e  ie("k304", self.
+00017800: 7570 6172 616d 5b22 6b33 3034 225d 2c20  uparam["k304"], 
+00017810: 7365 6c66 2e61 7267 732e 522c 2046 616c  self.args.R, Fal
+00017820: 7365 2c20 3836 3430 3020 2a20 3239 3929  se, 86400 * 299)
+00017830: 0a20 2020 2020 2020 2073 656c 662e 6f75  .        self.ou
+00017840: 745f 6865 6164 6572 6c69 7374 2e61 7070  t_headerlist.app
+00017850: 656e 6428 2822 5365 742d 436f 6f6b 6965  end(("Set-Cookie
+00017860: 222c 2063 6b29 290a 2020 2020 2020 2020  ", ck)).        
+00017870: 7365 6c66 2e72 6564 6972 6563 7428 2222  self.redirect(""
+00017880: 2c20 223f 6823 6363 2229 0a20 2020 2020  , "?h#cc").     
+00017890: 2020 2072 6574 7572 6e20 5472 7565 0a0a     return True..
+000178a0: 2020 2020 6465 6620 7365 7463 6b28 7365      def setck(se
+000178b0: 6c66 2920 203a 0a20 2020 2020 2020 206b  lf)  :.        k
+000178c0: 2c20 7620 3d20 7365 6c66 2e75 7061 7261  , v = self.upara
+000178d0: 6d5b 2273 6574 636b 225d 2e73 706c 6974  m["setck"].split
+000178e0: 2822 3d22 2c20 3129 0a20 2020 2020 2020  ("=", 1).       
+000178f0: 2074 203d 204e 6f6e 6520 6966 2076 203d   t = None if v =
+00017900: 3d20 2222 2065 6c73 6520 3836 3430 3020  = "" else 86400 
+00017910: 2a20 3239 390a 2020 2020 2020 2020 636b  * 299.        ck
+00017920: 203d 2067 656e 636f 6f6b 6965 286b 2c20   = gencookie(k, 
+00017930: 762c 2073 656c 662e 6172 6773 2e52 2c20  v, self.args.R, 
+00017940: 4661 6c73 652c 2074 290a 2020 2020 2020  False, t).      
+00017950: 2020 7365 6c66 2e6f 7574 5f68 6561 6465    self.out_heade
+00017960: 726c 6973 742e 6170 7065 6e64 2828 2253  rlist.append(("S
+00017970: 6574 2d43 6f6f 6b69 6522 2c20 636b 2929  et-Cookie", ck))
+00017980: 0a20 2020 2020 2020 2073 656c 662e 7265  .        self.re
+00017990: 706c 7928 6222 6f37 5c6e 2229 0a20 2020  ply(b"o7\n").   
+000179a0: 2020 2020 2072 6574 7572 6e20 5472 7565       return True
+000179b0: 0a0a 2020 2020 6465 6620 7365 745f 6366  ..    def set_cf
+000179c0: 675f 7265 7365 7428 7365 6c66 2920 203a  g_reset(self)  :
+000179d0: 0a20 2020 2020 2020 2066 6f72 206b 2069  .        for k i
+000179e0: 6e20 2822 6b33 3034 222c 2022 6a73 222c  n ("k304", "js",
+000179f0: 2022 6964 7868 222c 2022 6370 7077 6422   "idxh", "cppwd"
+00017a00: 2c20 2263 7070 7773 2229 3a0a 2020 2020  , "cppws"):.    
+00017a10: 2020 2020 2020 2020 636f 6f6b 6965 203d          cookie =
+00017a20: 2067 656e 636f 6f6b 6965 286b 2c20 2278   gencookie(k, "x
+00017a30: 222c 2073 656c 662e 6172 6773 2e52 2c20  ", self.args.R, 
+00017a40: 4661 6c73 652c 204e 6f6e 6529 0a20 2020  False, None).   
+00017a50: 2020 2020 2020 2020 2073 656c 662e 6f75           self.ou
+00017a60: 745f 6865 6164 6572 6c69 7374 2e61 7070  t_headerlist.app
+00017a70: 656e 6428 2822 5365 742d 436f 6f6b 6965  end(("Set-Cookie
+00017a80: 222c 2063 6f6f 6b69 6529 290a 0a20 2020  ", cookie))..   
+00017a90: 2020 2020 2073 656c 662e 7265 6469 7265       self.redire
+00017aa0: 6374 2822 222c 2022 3f68 2363 6322 290a  ct("", "?h#cc").
+00017ab0: 2020 2020 2020 2020 7265 7475 726e 2054          return T
+00017ac0: 7275 650a 0a20 2020 2064 6566 2074 785f  rue..    def tx_
+00017ad0: 3430 3428 7365 6c66 2c20 6973 5f34 3033  404(self, is_403
+00017ae0: 2020 3d20 4661 6c73 6529 2020 3a0a 2020    = False)  :.  
+00017af0: 2020 2020 2020 7263 203d 2034 3034 0a20        rc = 404. 
+00017b00: 2020 2020 2020 2069 6620 7365 6c66 2e61         if self.a
+00017b10: 7267 732e 7661 6775 655f 3430 333a 0a20  rgs.vague_403:. 
+00017b20: 2020 2020 2020 2020 2020 2074 203d 2027             t = '
+00017b30: 3c68 3120 6964 3d22 6e22 3e34 3034 206e  <h1 id="n">404 n
+00017b40: 6f74 2066 6f75 6e64 2026 6e62 7370 3be2  ot found &nbsp;.
+00017b50: 9490 2820 c2b4 202d 6029 e294 8c3c 2f68  ..( .. -`)...</h
+00017b60: 313e 3c70 2069 643d 226f 223e 6f72 206d  1><p id="o">or m
+00017b70: 6179 6265 2079 6f75 2064 6f6e 5c27 7420  aybe you don\'t 
+00017b80: 6861 7665 2061 6363 6573 7320 2d2d 2074  have access -- t
+00017b90: 7279 206c 6f67 6769 6e67 2069 6e20 6f72  ry logging in or
+00017ba0: 203c 6120 6872 6566 3d22 7b7d 2f3f 6822   <a href="{}/?h"
+00017bb0: 3e67 6f20 686f 6d65 3c2f 613e 3c2f 703e  >go home</a></p>
+00017bc0: 270a 2020 2020 2020 2020 656c 6966 2069  '.        elif i
+00017bd0: 735f 3430 333a 0a20 2020 2020 2020 2020  s_403:.         
+00017be0: 2020 2074 203d 2027 3c68 3120 6964 3d22     t = '<h1 id="
+00017bf0: 7022 3e34 3033 2066 6f72 6269 6464 656e  p">403 forbidden
+00017c00: 6120 266e 6273 703b 7ee2 94bb e294 81e2  a &nbsp;~.......
+00017c10: 94bb 3c2f 6831 3e3c 7020 6964 3d22 7122  ..</h1><p id="q"
+00017c20: 3e79 6f75 5c27 6c6c 2068 6176 6520 746f  >you\'ll have to
+00017c30: 206c 6f67 2069 6e20 6f72 203c 6120 6872   log in or <a hr
+00017c40: 6566 3d22 7b7d 2f3f 6822 3e67 6f20 686f  ef="{}/?h">go ho
+00017c50: 6d65 3c2f 613e 3c2f 703e 270a 2020 2020  me</a></p>'.    
+00017c60: 2020 2020 2020 2020 7263 203d 2034 3033          rc = 403
+00017c70: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
+00017c80: 2020 2020 2020 2020 2020 2074 203d 2027             t = '
+00017c90: 3c68 3120 6964 3d22 6e22 3e34 3034 206e  <h1 id="n">404 n
+00017ca0: 6f74 2066 6f75 6e64 2026 6e62 7370 3be2  ot found &nbsp;.
+00017cb0: 9490 2820 c2b4 202d 6029 e294 8c3c 2f68  ..( .. -`)...</h
+00017cc0: 313e 3c70 3e3c 6120 6964 3d22 7222 2068  1><p><a id="r" h
+00017cd0: 7265 663d 227b 7d2f 3f68 223e 676f 2068  ref="{}/?h">go h
+00017ce0: 6f6d 653c 2f61 3e3c 2f70 3e27 0a0a 2020  ome</a></p>'..  
+00017cf0: 2020 2020 2020 7420 3d20 742e 666f 726d        t = t.form
+00017d00: 6174 2873 656c 662e 6172 6773 2e53 5229  at(self.args.SR)
+00017d10: 0a20 2020 2020 2020 2068 746d 6c20 3d20  .        html = 
+00017d20: 7365 6c66 2e6a 3273 2822 7370 6c61 7368  self.j2s("splash
+00017d30: 222c 2074 6869 733d 7365 6c66 2c20 7176  ", this=self, qv
+00017d40: 7061 7468 3d71 756f 7465 7028 7365 6c66  path=quotep(self
+00017d50: 2e76 7061 7468 292c 206d 7367 3d74 290a  .vpath), msg=t).
+00017d60: 2020 2020 2020 2020 7365 6c66 2e72 6570          self.rep
+00017d70: 6c79 2868 746d 6c2e 656e 636f 6465 2822  ly(html.encode("
+00017d80: 7574 662d 3822 292c 2073 7461 7475 733d  utf-8"), status=
+00017d90: 7263 290a 2020 2020 2020 2020 7265 7475  rc).        retu
+00017da0: 726e 2054 7275 650a 0a20 2020 2064 6566  rn True..    def
+00017db0: 2073 6361 6e76 6f6c 2873 656c 6629 2020   scanvol(self)  
+00017dc0: 3a0a 2020 2020 2020 2020 6966 206e 6f74  :.        if not
+00017dd0: 2073 656c 662e 6361 6e5f 7265 6164 206f   self.can_read o
+00017de0: 7220 6e6f 7420 7365 6c66 2e63 616e 5f77  r not self.can_w
+00017df0: 7269 7465 3a0a 2020 2020 2020 2020 2020  rite:.          
+00017e00: 2020 7261 6973 6520 5065 626b 6163 2834    raise Pebkac(4
+00017e10: 3033 2c20 226e 6f74 2061 6c6c 6f77 6564  03, "not allowed
+00017e20: 2066 6f72 2075 7365 7220 2220 2b20 7365   for user " + se
+00017e30: 6c66 2e75 6e61 6d65 290a 0a20 2020 2020  lf.uname)..     
+00017e40: 2020 2069 6620 7365 6c66 2e61 7267 732e     if self.args.
+00017e50: 6e6f 5f72 6573 6361 6e3a 0a20 2020 2020  no_rescan:.     
+00017e60: 2020 2020 2020 2072 6169 7365 2050 6562         raise Peb
+00017e70: 6b61 6328 3430 332c 2022 7468 6520 7265  kac(403, "the re
+00017e80: 7363 616e 2066 6561 7475 7265 2069 7320  scan feature is 
+00017e90: 6469 7361 626c 6564 2069 6e20 7365 7276  disabled in serv
+00017ea0: 6572 2063 6f6e 6669 6722 290a 0a20 2020  er config")..   
+00017eb0: 2020 2020 2076 6e2c 205f 203d 2073 656c       vn, _ = sel
+00017ec0: 662e 6173 7276 2e76 6673 2e67 6574 2873  f.asrv.vfs.get(s
+00017ed0: 656c 662e 7670 6174 682c 2073 656c 662e  elf.vpath, self.
+00017ee0: 756e 616d 652c 2054 7275 652c 2054 7275  uname, True, Tru
+00017ef0: 6529 0a0a 2020 2020 2020 2020 6172 6773  e)..        args
+00017f00: 203d 205b 7365 6c66 2e61 7372 762e 7666   = [self.asrv.vf
+00017f10: 732e 616c 6c5f 766f 6c73 2c20 5b76 6e2e  s.all_vols, [vn.
+00017f20: 7670 6174 685d 2c20 4661 6c73 652c 2054  vpath], False, T
+00017f30: 7275 655d 0a0a 2020 2020 2020 2020 7820  rue]..        x 
+00017f40: 3d20 7365 6c66 2e63 6f6e 6e2e 6873 7276  = self.conn.hsrv
+00017f50: 2e62 726f 6b65 722e 6173 6b28 2275 7032  .broker.ask("up2
+00017f60: 6b2e 7265 7363 616e 222c 202a 6172 6773  k.rescan", *args
+00017f70: 290a 2020 2020 2020 2020 6572 7220 3d20  ).        err = 
+00017f80: 782e 6765 7428 290a 2020 2020 2020 2020  x.get().        
+00017f90: 6966 206e 6f74 2065 7272 3a0a 2020 2020  if not err:.    
+00017fa0: 2020 2020 2020 2020 7365 6c66 2e72 6564          self.red
+00017fb0: 6972 6563 7428 2222 2c20 223f 6822 290a  irect("", "?h").
+00017fc0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+00017fd0: 726e 2054 7275 650a 0a20 2020 2020 2020  rn True..       
+00017fe0: 2072 6169 7365 2050 6562 6b61 6328 3530   raise Pebkac(50
+00017ff0: 302c 2065 7272 290a 0a20 2020 2064 6566  0, err)..    def
+00018000: 2068 616e 646c 655f 7265 6c6f 6164 2873   handle_reload(s
+00018010: 656c 6629 2020 3a0a 2020 2020 2020 2020  elf)  :.        
+00018020: 6163 7420 3d20 7365 6c66 2e75 7061 7261  act = self.upara
+00018030: 6d2e 6765 7428 2272 656c 6f61 6422 290a  m.get("reload").
+00018040: 2020 2020 2020 2020 6966 2061 6374 2021          if act !
+00018050: 3d20 2263 6667 223a 0a20 2020 2020 2020  = "cfg":.       
+00018060: 2020 2020 2072 6169 7365 2050 6562 6b61       raise Pebka
+00018070: 6328 3430 302c 2022 6f6e 6c79 2063 6f6e  c(400, "only con
+00018080: 6669 6720 6669 6c65 7320 2827 6366 6727  fig files ('cfg'
+00018090: 2920 6361 6e20 6265 2072 656c 6f61 6465  ) can be reloade
+000180a0: 6420 726e 2229 0a0a 2020 2020 2020 2020  d rn")..        
+000180b0: 6966 206e 6f74 205b 7820 666f 7220 7820  if not [x for x 
+000180c0: 696e 2073 656c 662e 7776 6f6c 2069 6620  in self.wvol if 
+000180d0: 7820 696e 2073 656c 662e 7276 6f6c 5d3a  x in self.rvol]:
+000180e0: 0a20 2020 2020 2020 2020 2020 2072 6169  .            rai
+000180f0: 7365 2050 6562 6b61 6328 3430 332c 2022  se Pebkac(403, "
+00018100: 6e6f 7420 616c 6c6f 7765 6420 666f 7220  not allowed for 
+00018110: 7573 6572 2022 202b 2073 656c 662e 756e  user " + self.un
+00018120: 616d 6529 0a0a 2020 2020 2020 2020 6966  ame)..        if
+00018130: 2073 656c 662e 6172 6773 2e6e 6f5f 7265   self.args.no_re
+00018140: 6c6f 6164 3a0a 2020 2020 2020 2020 2020  load:.          
+00018150: 2020 7261 6973 6520 5065 626b 6163 2834    raise Pebkac(4
+00018160: 3033 2c20 2274 6865 2072 656c 6f61 6420  03, "the reload 
+00018170: 6665 6174 7572 6520 6973 2064 6973 6162  feature is disab
+00018180: 6c65 6420 696e 2073 6572 7665 7220 636f  led in server co
+00018190: 6e66 6967 2229 0a0a 2020 2020 2020 2020  nfig")..        
+000181a0: 7820 3d20 7365 6c66 2e63 6f6e 6e2e 6873  x = self.conn.hs
+000181b0: 7276 2e62 726f 6b65 722e 6173 6b28 2272  rv.broker.ask("r
+000181c0: 656c 6f61 6422 290a 2020 2020 2020 2020  eload").        
+000181d0: 7265 7475 726e 2073 656c 662e 7265 6469  return self.redi
+000181e0: 7265 6374 2822 222c 2022 3f68 222c 2078  rect("", "?h", x
+000181f0: 2e67 6574 2829 2c20 2272 6574 7572 6e20  .get(), "return 
+00018200: 746f 222c 2046 616c 7365 290a 0a20 2020  to", False)..   
+00018210: 2064 6566 2074 785f 7374 6163 6b28 7365   def tx_stack(se
+00018220: 6c66 2920 203a 0a20 2020 2020 2020 2069  lf)  :.        i
+00018230: 6620 6e6f 7420 5b78 2066 6f72 2078 2069  f not [x for x i
+00018240: 6e20 7365 6c66 2e77 766f 6c20 6966 2078  n self.wvol if x
+00018250: 2069 6e20 7365 6c66 2e72 766f 6c5d 3a0a   in self.rvol]:.
+00018260: 2020 2020 2020 2020 2020 2020 7261 6973              rais
+00018270: 6520 5065 626b 6163 2834 3033 2c20 226e  e Pebkac(403, "n
+00018280: 6f74 2061 6c6c 6f77 6564 2066 6f72 2075  ot allowed for u
+00018290: 7365 7220 2220 2b20 7365 6c66 2e75 6e61  ser " + self.una
+000182a0: 6d65 290a 0a20 2020 2020 2020 2069 6620  me)..        if 
+000182b0: 7365 6c66 2e61 7267 732e 6e6f 5f73 7461  self.args.no_sta
+000182c0: 636b 3a0a 2020 2020 2020 2020 2020 2020  ck:.            
+000182d0: 7261 6973 6520 5065 626b 6163 2834 3033  raise Pebkac(403
+000182e0: 2c20 2274 6865 2073 7461 636b 6475 6d70  , "the stackdump
+000182f0: 2066 6561 7475 7265 2069 7320 6469 7361   feature is disa
+00018300: 626c 6564 2069 6e20 7365 7276 6572 2063  bled in server c
+00018310: 6f6e 6669 6722 290a 0a20 2020 2020 2020  onfig")..       
+00018320: 2072 6574 203d 2022 3c70 7265 3e7b 7d5c   ret = "<pre>{}\
+00018330: 6e7b 7d22 2e66 6f72 6d61 7428 7469 6d65  n{}".format(time
+00018340: 2e74 696d 6528 292c 2068 746d 6c5f 6573  .time(), html_es
+00018350: 6361 7065 2861 6c6c 7472 6163 6528 2929  cape(alltrace())
+00018360: 290a 2020 2020 2020 2020 7365 6c66 2e72  ).        self.r
+00018370: 6570 6c79 2872 6574 2e65 6e63 6f64 6528  eply(ret.encode(
+00018380: 2275 7466 2d38 2229 290a 2020 2020 2020  "utf-8")).      
+00018390: 2020 7265 7475 726e 2054 7275 650a 0a20    return True.. 
+000183a0: 2020 2064 6566 2074 785f 7472 6565 2873     def tx_tree(s
+000183b0: 656c 6629 2020 3a0a 2020 2020 2020 2020  elf)  :.        
+000183c0: 746f 7020 3d20 7365 6c66 2e75 7061 7261  top = self.upara
+000183d0: 6d5b 2274 7265 6522 5d20 6f72 2022 220a  m["tree"] or "".
+000183e0: 2020 2020 2020 2020 6473 7420 3d20 7365          dst = se
+000183f0: 6c66 2e76 7061 7468 0a20 2020 2020 2020  lf.vpath.       
+00018400: 2069 6620 746f 7020 696e 205b 222e 222c   if top in [".",
+00018410: 2022 2e2e 225d 3a0a 2020 2020 2020 2020   ".."]:.        
+00018420: 2020 2020 746f 7020 3d20 756e 646f 7428      top = undot(
+00018430: 7365 6c66 2e76 7061 7468 202b 2022 2f22  self.vpath + "/"
+00018440: 202b 2074 6f70 290a 0a20 2020 2020 2020   + top)..       
+00018450: 2069 6620 746f 7020 3d3d 2064 7374 3a0a   if top == dst:.
+00018460: 2020 2020 2020 2020 2020 2020 6473 7420              dst 
+00018470: 3d20 2222 0a20 2020 2020 2020 2065 6c69  = "".        eli
+00018480: 6620 746f 703a 0a20 2020 2020 2020 2020  f top:.         
+00018490: 2020 2069 6620 6e6f 7420 6473 742e 7374     if not dst.st
+000184a0: 6172 7473 7769 7468 2874 6f70 202b 2022  artswith(top + "
+000184b0: 2f22 293a 0a20 2020 2020 2020 2020 2020  /"):.           
+000184c0: 2020 2020 2072 6169 7365 2050 6562 6b61       raise Pebka
+000184d0: 6328 3430 302c 2022 6172 6720 6675 6e6b  c(400, "arg funk
+000184e0: 2229 0a0a 2020 2020 2020 2020 2020 2020  ")..            
+000184f0: 6473 7420 3d20 6473 745b 6c65 6e28 746f  dst = dst[len(to
+00018500: 7029 202b 2031 203a 5d0a 0a20 2020 2020  p) + 1 :]..     
+00018510: 2020 2072 6574 203d 2073 656c 662e 6765     ret = self.ge
+00018520: 6e5f 7472 6565 2874 6f70 2c20 6473 7429  n_tree(top, dst)
+00018530: 0a20 2020 2020 2020 2069 6620 7365 6c66  .        if self
+00018540: 2e69 735f 7670 726f 7869 6564 3a0a 2020  .is_vproxied:.  
+00018550: 2020 2020 2020 2020 2020 7061 7265 6e74            parent
+00018560: 7320 3d20 7365 6c66 2e61 7267 732e 522e  s = self.args.R.
+00018570: 7370 6c69 7428 222f 2229 0a20 2020 2020  split("/").     
+00018580: 2020 2020 2020 2066 6f72 2070 6172 656e         for paren
+00018590: 7420 696e 2072 6576 6572 7365 6428 7061  t in reversed(pa
+000185a0: 7265 6e74 7329 3a0a 2020 2020 2020 2020  rents):.        
+000185b0: 2020 2020 2020 2020 7265 7420 3d20 7b22          ret = {"
+000185c0: 6b25 7322 2025 2028 7061 7265 6e74 2c29  k%s" % (parent,)
+000185d0: 3a20 7265 742c 2022 6122 3a20 5b5d 7d0a  : ret, "a": []}.
+000185e0: 0a20 2020 2020 2020 207a 7320 3d20 6a73  .        zs = js
+000185f0: 6f6e 2e64 756d 7073 2872 6574 290a 2020  on.dumps(ret).  
+00018600: 2020 2020 2020 7365 6c66 2e72 6570 6c79        self.reply
+00018610: 287a 732e 656e 636f 6465 2822 7574 662d  (zs.encode("utf-
+00018620: 3822 292c 206d 696d 653d 2261 7070 6c69  8"), mime="appli
+00018630: 6361 7469 6f6e 2f6a 736f 6e22 290a 2020  cation/json").  
+00018640: 2020 2020 2020 7265 7475 726e 2054 7275        return Tru
+00018650: 650a 0a20 2020 2064 6566 2067 656e 5f74  e..    def gen_t
+00018660: 7265 6528 7365 6c66 2c20 746f 7020 2c20  ree(self, top , 
+00018670: 7461 7267 6574 2029 2020 203a 0a20 2020  target )   :.   
+00018680: 2020 2020 2072 6574 2020 203d 207b 7d0a       ret   = {}.
+00018690: 2020 2020 2020 2020 6578 636c 203d 204e          excl = N
+000186a0: 6f6e 650a 2020 2020 2020 2020 6966 2074  one.        if t
+000186b0: 6172 6765 743a 0a20 2020 2020 2020 2020  arget:.         
+000186c0: 2020 2065 7863 6c2c 2074 6172 6765 7420     excl, target 
+000186d0: 3d20 2874 6172 6765 742e 7370 6c69 7428  = (target.split(
+000186e0: 222f 222c 2031 2920 2b20 5b22 225d 295b  "/", 1) + [""])[
+000186f0: 3a32 5d0a 2020 2020 2020 2020 2020 2020  :2].            
+00018700: 7375 6220 3d20 7365 6c66 2e67 656e 5f74  sub = self.gen_t
+00018710: 7265 6528 222f 222e 6a6f 696e 285b 746f  ree("/".join([to
+00018720: 702c 2065 7863 6c5d 292e 7374 7269 7028  p, excl]).strip(
+00018730: 222f 2229 2c20 7461 7267 6574 290a 2020  "/"), target).  
+00018740: 2020 2020 2020 2020 2020 7265 745b 226b            ret["k
+00018750: 2220 2b20 7175 6f74 6570 2865 7863 6c29  " + quotep(excl)
+00018760: 5d20 3d20 7375 620a 0a20 2020 2020 2020  ] = sub..       
+00018770: 2074 7279 3a0a 2020 2020 2020 2020 2020   try:.          
+00018780: 2020 766e 2c20 7265 6d20 3d20 7365 6c66    vn, rem = self
+00018790: 2e61 7372 762e 7666 732e 6765 7428 746f  .asrv.vfs.get(to
+000187a0: 702c 2073 656c 662e 756e 616d 652c 2054  p, self.uname, T
+000187b0: 7275 652c 2046 616c 7365 290a 2020 2020  rue, False).    
+000187c0: 2020 2020 2020 2020 6673 726f 6f74 2c20          fsroot, 
+000187d0: 7666 735f 6c73 2c20 7666 735f 7669 7274  vfs_ls, vfs_virt
+000187e0: 203d 2076 6e2e 6c73 280a 2020 2020 2020   = vn.ls(.      
+000187f0: 2020 2020 2020 2020 2020 7265 6d2c 0a20            rem,. 
+00018800: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00018810: 656c 662e 756e 616d 652c 0a20 2020 2020  elf.uname,.     
+00018820: 2020 2020 2020 2020 2020 206e 6f74 2073             not s
+00018830: 656c 662e 6172 6773 2e6e 6f5f 7363 616e  elf.args.no_scan
+00018840: 6469 722c 0a20 2020 2020 2020 2020 2020  dir,.           
+00018850: 2020 2020 205b 5b54 7275 652c 2046 616c       [[True, Fal
+00018860: 7365 5d2c 205b 4661 6c73 652c 2054 7275  se], [False, Tru
+00018870: 655d 5d2c 0a20 2020 2020 2020 2020 2020  e]],.           
+00018880: 2029 0a20 2020 2020 2020 2065 7863 6570   ).        excep
+00018890: 743a 0a20 2020 2020 2020 2020 2020 2076  t:.            v
+000188a0: 6673 5f6c 7320 3d20 5b5d 0a20 2020 2020  fs_ls = [].     
+000188b0: 2020 2020 2020 2076 6673 5f76 6972 7420         vfs_virt 
+000188c0: 3d20 7b7d 0a20 2020 2020 2020 2020 2020  = {}.           
+000188d0: 2066 6f72 2076 2069 6e20 7365 6c66 2e72   for v in self.r
+000188e0: 766f 6c3a 0a20 2020 2020 2020 2020 2020  vol:.           
+000188f0: 2020 2020 2064 312c 2064 3220 3d20 762e       d1, d2 = v.
+00018900: 7273 706c 6974 2822 2f22 2c20 3129 2069  rsplit("/", 1) i
+00018910: 6620 222f 2220 696e 2076 2065 6c73 6520  f "/" in v else 
+00018920: 5b22 222c 2076 5d0a 2020 2020 2020 2020  ["", v].        
+00018930: 2020 2020 2020 2020 6966 2064 3120 3d3d          if d1 ==
+00018940: 2074 6f70 3a0a 2020 2020 2020 2020 2020   top:.          
+00018950: 2020 2020 2020 2020 2020 7666 735f 7669            vfs_vi
+00018960: 7274 5b64 325d 203d 2073 656c 662e 6173  rt[d2] = self.as
+00018970: 7276 2e76 6673 2020 2320 7479 7065 6368  rv.vfs  # typech
+00018980: 6b2c 2076 616c 7565 206e 6576 6572 2072  k, value never r
+00018990: 6561 640a 0a20 2020 2020 2020 2064 6972  ead..        dir
+000189a0: 7320 3d20 5b5d 0a0a 2020 2020 2020 2020  s = []..        
+000189b0: 6469 726e 616d 6573 203d 205b 785b 305d  dirnames = [x[0]
+000189c0: 2066 6f72 2078 2069 6e20 7666 735f 6c73   for x in vfs_ls
+000189d0: 2069 6620 7374 6174 2e53 5f49 5344 4952   if stat.S_ISDIR
+000189e0: 2878 5b31 5d2e 7374 5f6d 6f64 6529 5d0a  (x[1].st_mode)].
+000189f0: 0a20 2020 2020 2020 2069 6620 6e6f 7420  .        if not 
+00018a00: 7365 6c66 2e61 7267 732e 6564 206f 7220  self.args.ed or 
+00018a10: 2264 6f74 7322 206e 6f74 2069 6e20 7365  "dots" not in se
+00018a20: 6c66 2e75 7061 7261 6d3a 0a20 2020 2020  lf.uparam:.     
+00018a30: 2020 2020 2020 2064 6972 6e61 6d65 7320         dirnames 
+00018a40: 3d20 6578 636c 7564 655f 646f 7466 696c  = exclude_dotfil
+00018a50: 6573 2864 6972 6e61 6d65 7329 0a0a 2020  es(dirnames)..  
+00018a60: 2020 2020 2020 666f 7220 666e 2069 6e20        for fn in 
+00018a70: 5b78 2066 6f72 2078 2069 6e20 6469 726e  [x for x in dirn
+00018a80: 616d 6573 2069 6620 7820 213d 2065 7863  ames if x != exc
+00018a90: 6c5d 3a0a 2020 2020 2020 2020 2020 2020  l]:.            
+00018aa0: 6469 7273 2e61 7070 656e 6428 7175 6f74  dirs.append(quot
+00018ab0: 6570 2866 6e29 290a 0a20 2020 2020 2020  ep(fn))..       
+00018ac0: 2066 6f72 2078 2069 6e20 7666 735f 7669   for x in vfs_vi
+00018ad0: 7274 3a0a 2020 2020 2020 2020 2020 2020  rt:.            
+00018ae0: 6966 2078 2021 3d20 6578 636c 3a0a 2020  if x != excl:.  
+00018af0: 2020 2020 2020 2020 2020 2020 2020 6469                di
+00018b00: 7273 2e61 7070 656e 6428 7829 0a0a 2020  rs.append(x)..  
+00018b10: 2020 2020 2020 7265 745b 2261 225d 203d        ret["a"] =
+00018b20: 2064 6972 730a 2020 2020 2020 2020 7265   dirs.        re
+00018b30: 7475 726e 2072 6574 0a0a 2020 2020 6465  turn ret..    de
+00018b40: 6620 7478 5f75 7073 2873 656c 6629 2020  f tx_ups(self)  
+00018b50: 3a0a 2020 2020 2020 2020 6966 206e 6f74  :.        if not
+00018b60: 2073 656c 662e 6172 6773 2e75 6e70 6f73   self.args.unpos
+00018b70: 743a 0a20 2020 2020 2020 2020 2020 2072  t:.            r
+00018b80: 6169 7365 2050 6562 6b61 6328 3430 332c  aise Pebkac(403,
+00018b90: 2022 7468 6520 756e 706f 7374 2066 6561   "the unpost fea
+00018ba0: 7475 7265 2069 7320 6469 7361 626c 6564  ture is disabled
+00018bb0: 2069 6e20 7365 7276 6572 2063 6f6e 6669   in server confi
+00018bc0: 6722 290a 0a20 2020 2020 2020 2069 6478  g")..        idx
+00018bd0: 203d 2073 656c 662e 636f 6e6e 2e67 6574   = self.conn.get
+00018be0: 5f75 3269 6478 2829 0a20 2020 2020 2020  _u2idx().       
+00018bf0: 2069 6620 6e6f 7420 6964 7820 6f72 206e   if not idx or n
+00018c00: 6f74 2068 6173 6174 7472 2869 6478 2c20  ot hasattr(idx, 
+00018c10: 2270 5f65 6e64 2229 3a0a 2020 2020 2020  "p_end"):.      
+00018c20: 2020 2020 2020 7261 6973 6520 5065 626b        raise Pebk
+00018c30: 6163 2835 3030 2c20 2273 716c 6974 6533  ac(500, "sqlite3
+00018c40: 2069 7320 6e6f 7420 6176 6169 6c61 626c   is not availabl
+00018c50: 6520 6f6e 2074 6865 2073 6572 7665 723b  e on the server;
+00018c60: 2063 616e 6e6f 7420 756e 706f 7374 2229   cannot unpost")
+00018c70: 0a0a 2020 2020 2020 2020 6669 6c74 203d  ..        filt =
+00018c80: 2073 656c 662e 7570 6172 616d 2e67 6574   self.uparam.get
+00018c90: 2822 6669 6c74 6572 2229 0a20 2020 2020  ("filter").     
+00018ca0: 2020 2066 696c 7420 3d20 756e 7175 6f74     filt = unquot
+00018cb0: 6570 2866 696c 7420 6f72 2022 2229 0a20  ep(filt or ""). 
+00018cc0: 2020 2020 2020 206c 6d20 3d20 2275 7073         lm = "ups
+00018cd0: 205b 7b7d 5d22 2e66 6f72 6d61 7428 6669   [{}]".format(fi
+00018ce0: 6c74 290a 2020 2020 2020 2020 7365 6c66  lt).        self
+00018cf0: 2e6c 6f67 286c 6d29 0a0a 2020 2020 2020  .log(lm)..      
+00018d00: 2020 7265 7420 2020 3d20 5b5d 0a20 2020    ret   = [].   
+00018d10: 2020 2020 2074 3020 3d20 7469 6d65 2e74       t0 = time.t
+00018d20: 696d 6528 290a 2020 2020 2020 2020 6c69  ime().        li
+00018d30: 6d20 3d20 7469 6d65 2e74 696d 6528 2920  m = time.time() 
+00018d40: 2d20 7365 6c66 2e61 7267 732e 756e 706f  - self.args.unpo
+00018d50: 7374 0a20 2020 2020 2020 2066 6b5f 766f  st.        fk_vo
+00018d60: 6c73 203d 207b 0a20 2020 2020 2020 2020  ls = {.         
+00018d70: 2020 2076 6f6c 3a20 766f 6c2e 666c 6167     vol: vol.flag
+00018d80: 735b 2266 6b22 5d0a 2020 2020 2020 2020  s["fk"].        
+00018d90: 2020 2020 666f 7220 7670 2c20 766f 6c20      for vp, vol 
+00018da0: 696e 2073 656c 662e 6173 7276 2e76 6673  in self.asrv.vfs
+00018db0: 2e61 6c6c 5f76 6f6c 732e 6974 656d 7328  .all_vols.items(
+00018dc0: 290a 2020 2020 2020 2020 2020 2020 6966  ).            if
+00018dd0: 2022 666b 2220 696e 2076 6f6c 2e66 6c61   "fk" in vol.fla
+00018de0: 6773 2061 6e64 2028 7670 2069 6e20 7365  gs and (vp in se
+00018df0: 6c66 2e72 766f 6c20 6f72 2076 7020 696e  lf.rvol or vp in
+00018e00: 2073 656c 662e 7570 766f 6c29 0a20 2020   self.upvol).   
+00018e10: 2020 2020 207d 0a20 2020 2020 2020 2066       }.        f
+00018e20: 6f72 2076 6f6c 2069 6e20 7365 6c66 2e61  or vol in self.a
+00018e30: 7372 762e 7666 732e 616c 6c5f 766f 6c73  srv.vfs.all_vols
+00018e40: 2e76 616c 7565 7328 293a 0a20 2020 2020  .values():.     
+00018e50: 2020 2020 2020 2063 7572 203d 2069 6478         cur = idx
+00018e60: 2e67 6574 5f63 7572 2876 6f6c 2e72 6561  .get_cur(vol.rea
+00018e70: 6c70 6174 6829 0a20 2020 2020 2020 2020  lpath).         
+00018e80: 2020 2069 6620 6e6f 7420 6375 723a 0a20     if not cur:. 
+00018e90: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+00018ea0: 6f6e 7469 6e75 650a 0a20 2020 2020 2020  ontinue..       
+00018eb0: 2020 2020 206e 666b 203d 2066 6b5f 766f       nfk = fk_vo
+00018ec0: 6c73 2e67 6574 2876 6f6c 2c20 3029 0a0a  ls.get(vol, 0)..
+00018ed0: 2020 2020 2020 2020 2020 2020 7120 3d20              q = 
+00018ee0: 2273 656c 6563 7420 737a 2c20 7264 2c20  "select sz, rd, 
+00018ef0: 666e 2c20 6174 2066 726f 6d20 7570 2077  fn, at from up w
+00018f00: 6865 7265 2069 703d 3f20 616e 6420 6174  here ip=? and at
+00018f10: 3e3f 220a 2020 2020 2020 2020 2020 2020  >?".            
+00018f20: 666f 7220 737a 2c20 7264 2c20 666e 2c20  for sz, rd, fn, 
+00018f30: 6174 2069 6e20 6375 722e 6578 6563 7574  at in cur.execut
+00018f40: 6528 712c 2028 7365 6c66 2e69 702c 206c  e(q, (self.ip, l
+00018f50: 696d 2929 3a0a 2020 2020 2020 2020 2020  im)):.          
+00018f60: 2020 2020 2020 7670 203d 2022 2f22 202b        vp = "/" +
+00018f70: 2022 2f22 2e6a 6f69 6e28 7820 666f 7220   "/".join(x for 
+00018f80: 7820 696e 205b 766f 6c2e 7670 6174 682c  x in [vol.vpath,
+00018f90: 2072 642c 2066 6e5d 2069 6620 7829 0a20   rd, fn] if x). 
+00018fa0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00018fb0: 6620 6669 6c74 2061 6e64 2066 696c 7420  f filt and filt 
+00018fc0: 6e6f 7420 696e 2076 703a 0a20 2020 2020  not in vp:.     
+00018fd0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+00018fe0: 6f6e 7469 6e75 650a 0a20 2020 2020 2020  ontinue..       
+00018ff0: 2020 2020 2020 2020 2072 7620 3d20 7b22           rv = {"
+00019000: 7670 223a 2071 756f 7465 7028 7670 292c  vp": quotep(vp),
+00019010: 2022 737a 223a 2073 7a2c 2022 6174 223a   "sz": sz, "at":
+00019020: 2061 742c 2022 6e66 6b22 3a20 6e66 6b7d   at, "nfk": nfk}
+00019030: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00019040: 2069 6620 6e66 6b3a 0a20 2020 2020 2020   if nfk:.       
+00019050: 2020 2020 2020 2020 2020 2020 2072 765b               rv[
+00019060: 2261 7022 5d20 3d20 766f 6c2e 6361 6e6f  "ap"] = vol.cano
+00019070: 6e69 6361 6c28 766a 6f69 6e28 7264 2c20  nical(vjoin(rd, 
+00019080: 666e 2929 0a0a 2020 2020 2020 2020 2020  fn))..          
+00019090: 2020 2020 2020 7265 742e 6170 7065 6e64        ret.append
+000190a0: 2872 7629 0a20 2020 2020 2020 2020 2020  (rv).           
+000190b0: 2020 2020 2069 6620 6c65 6e28 7265 7429       if len(ret)
+000190c0: 203e 2033 3030 303a 0a20 2020 2020 2020   > 3000:.       
+000190d0: 2020 2020 2020 2020 2020 2020 2072 6574               ret
+000190e0: 2e73 6f72 7428 6b65 793d 6c61 6d62 6461  .sort(key=lambda
+000190f0: 2078 3a20 785b 2261 7422 5d2c 2072 6576   x: x["at"], rev
+00019100: 6572 7365 3d54 7275 6529 2020 2320 7479  erse=True)  # ty
+00019110: 7065 3a20 6967 6e6f 7265 0a20 2020 2020  pe: ignore.     
+00019120: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+00019130: 6574 203d 2072 6574 5b3a 3230 3030 5d0a  et = ret[:2000].
+00019140: 0a20 2020 2020 2020 2072 6574 2e73 6f72  .        ret.sor
+00019150: 7428 6b65 793d 6c61 6d62 6461 2078 3a20  t(key=lambda x: 
+00019160: 785b 2261 7422 5d2c 2072 6576 6572 7365  x["at"], reverse
+00019170: 3d54 7275 6529 2020 2320 7479 7065 3a20  =True)  # type: 
+00019180: 6967 6e6f 7265 0a20 2020 2020 2020 206e  ignore.        n
+00019190: 203d 2030 0a20 2020 2020 2020 2066 6f72   = 0.        for
+000191a0: 2072 7620 696e 2072 6574 5b3a 3131 3030   rv in ret[:1100
+000191b0: 305d 3a0a 2020 2020 2020 2020 2020 2020  0]:.            
+000191c0: 6e66 6b20 3d20 7276 2e70 6f70 2822 6e66  nfk = rv.pop("nf
+000191d0: 6b22 290a 2020 2020 2020 2020 2020 2020  k").            
+000191e0: 6966 206e 6f74 206e 666b 3a0a 2020 2020  if not nfk:.    
+000191f0: 2020 2020 2020 2020 2020 2020 636f 6e74              cont
+00019200: 696e 7565 0a0a 2020 2020 2020 2020 2020  inue..          
+00019210: 2020 6170 203d 2072 762e 706f 7028 2261    ap = rv.pop("a
+00019220: 7022 290a 2020 2020 2020 2020 2020 2020  p").            
+00019230: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
+00019240: 2020 2020 2073 7420 3d20 626f 732e 7374       st = bos.st
+00019250: 6174 2861 7029 0a20 2020 2020 2020 2020  at(ap).         
+00019260: 2020 2065 7863 6570 743a 0a20 2020 2020     except:.     
+00019270: 2020 2020 2020 2020 2020 2063 6f6e 7469             conti
+00019280: 6e75 650a 0a20 2020 2020 2020 2020 2020  nue..           
+00019290: 2066 6b20 3d20 7365 6c66 2e67 656e 5f66   fk = self.gen_f
+000192a0: 6b28 0a20 2020 2020 2020 2020 2020 2020  k(.             
+000192b0: 2020 2073 656c 662e 6172 6773 2e66 6b5f     self.args.fk_
+000192c0: 7361 6c74 2c20 6170 2c20 7374 2e73 745f  salt, ap, st.st_
+000192d0: 7369 7a65 2c20 3020 6966 2041 4e59 5749  size, 0 if ANYWI
+000192e0: 4e20 656c 7365 2073 742e 7374 5f69 6e6f  N else st.st_ino
+000192f0: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
+00019300: 2020 2020 2020 2020 2020 2072 765b 2276             rv["v
+00019310: 7022 5d20 2b3d 2022 3f6b 3d22 202b 2066  p"] += "?k=" + f
+00019320: 6b5b 3a6e 666b 5d0a 0a20 2020 2020 2020  k[:nfk]..       
+00019330: 2020 2020 206e 202b 3d20 310a 2020 2020       n += 1.    
+00019340: 2020 2020 2020 2020 6966 206e 203e 2032          if n > 2
+00019350: 3030 303a 0a20 2020 2020 2020 2020 2020  000:.           
+00019360: 2020 2020 2062 7265 616b 0a0a 2020 2020       break..    
+00019370: 2020 2020 7265 7420 3d20 7265 745b 3a32      ret = ret[:2
+00019380: 3030 305d 0a0a 2020 2020 2020 2020 6966  000]..        if
+00019390: 2073 656c 662e 6973 5f76 7072 6f78 6965   self.is_vproxie
+000193a0: 643a 0a20 2020 2020 2020 2020 2020 2066  d:.            f
+000193b0: 6f72 2076 2069 6e20 7265 743a 0a20 2020  or v in ret:.   
+000193c0: 2020 2020 2020 2020 2020 2020 2076 5b22               v["
+000193d0: 7670 225d 203d 2073 656c 662e 6172 6773  vp"] = self.args
+000193e0: 2e53 5220 2b20 765b 2276 7022 5d0a 0a20  .SR + v["vp"].. 
+000193f0: 2020 2020 2020 206a 7478 7420 3d20 6a73         jtxt = js
+00019400: 6f6e 2e64 756d 7073 2872 6574 2c20 696e  on.dumps(ret, in
+00019410: 6465 6e74 3d32 2c20 736f 7274 5f6b 6579  dent=2, sort_key
+00019420: 733d 5472 7565 292e 656e 636f 6465 2822  s=True).encode("
+00019430: 7574 662d 3822 2c20 2272 6570 6c61 6365  utf-8", "replace
+00019440: 2229 0a20 2020 2020 2020 2073 656c 662e  ").        self.
+00019450: 6c6f 6728 227b 7d20 237b 7d20 7b3a 2e32  log("{} #{} {:.2
+00019460: 667d 7365 6322 2e66 6f72 6d61 7428 6c6d  f}sec".format(lm
+00019470: 2c20 6c65 6e28 7265 7429 2c20 7469 6d65  , len(ret), time
+00019480: 2e74 696d 6528 2920 2d20 7430 2929 0a20  .time() - t0)). 
+00019490: 2020 2020 2020 2073 656c 662e 7265 706c         self.repl
+000194a0: 7928 6a74 7874 2c20 6d69 6d65 3d22 6170  y(jtxt, mime="ap
+000194b0: 706c 6963 6174 696f 6e2f 6a73 6f6e 2229  plication/json")
+000194c0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+000194d0: 5472 7565 0a0a 2020 2020 6465 6620 6861  True..    def ha
+000194e0: 6e64 6c65 5f72 6d28 7365 6c66 2c20 7265  ndle_rm(self, re
+000194f0: 7120 2920 203a 0a20 2020 2020 2020 2069  q )  :.        i
+00019500: 6620 6e6f 7420 7265 7120 616e 6420 6e6f  f not req and no
+00019510: 7420 7365 6c66 2e63 616e 5f64 656c 6574  t self.can_delet
+00019520: 653a 0a20 2020 2020 2020 2020 2020 2072  e:.            r
+00019530: 6169 7365 2050 6562 6b61 6328 3430 332c  aise Pebkac(403,
+00019540: 2022 6e6f 7420 616c 6c6f 7765 6420 666f   "not allowed fo
+00019550: 7220 7573 6572 2022 202b 2073 656c 662e  r user " + self.
+00019560: 756e 616d 6529 0a0a 2020 2020 2020 2020  uname)..        
+00019570: 6966 2073 656c 662e 6172 6773 2e6e 6f5f  if self.args.no_
+00019580: 6465 6c3a 0a20 2020 2020 2020 2020 2020  del:.           
+00019590: 2072 6169 7365 2050 6562 6b61 6328 3430   raise Pebkac(40
+000195a0: 332c 2022 7468 6520 6465 6c65 7465 2066  3, "the delete f
+000195b0: 6561 7475 7265 2069 7320 6469 7361 626c  eature is disabl
+000195c0: 6564 2069 6e20 7365 7276 6572 2063 6f6e  ed in server con
+000195d0: 6669 6722 290a 0a20 2020 2020 2020 2069  fig")..        i
+000195e0: 6620 6e6f 7420 7265 713a 0a20 2020 2020  f not req:.     
+000195f0: 2020 2020 2020 2072 6571 203d 205b 7365         req = [se
+00019600: 6c66 2e76 7061 7468 5d0a 2020 2020 2020  lf.vpath].      
+00019610: 2020 656c 6966 2073 656c 662e 6973 5f76    elif self.is_v
+00019620: 7072 6f78 6965 643a 0a20 2020 2020 2020  proxied:.       
+00019630: 2020 2020 2072 6571 203d 205b 785b 6c65       req = [x[le
+00019640: 6e28 7365 6c66 2e61 7267 732e 5352 2920  n(self.args.SR) 
+00019650: 3a5d 2066 6f72 2078 2069 6e20 7265 715d  :] for x in req]
+00019660: 0a0a 2020 2020 2020 2020 6e6c 696d 203d  ..        nlim =
+00019670: 2069 6e74 2873 656c 662e 7570 6172 616d   int(self.uparam
+00019680: 2e67 6574 2822 6c69 6d22 2920 6f72 2030  .get("lim") or 0
+00019690: 290a 2020 2020 2020 2020 6c69 6d20 3d20  ).        lim = 
+000196a0: 5b6e 6c69 6d2c 206e 6c69 6d5d 2069 6620  [nlim, nlim] if 
+000196b0: 6e6c 696d 2065 6c73 6520 5b5d 0a0a 2020  nlim else []..  
+000196c0: 2020 2020 2020 7820 3d20 7365 6c66 2e63        x = self.c
+000196d0: 6f6e 6e2e 6873 7276 2e62 726f 6b65 722e  onn.hsrv.broker.
+000196e0: 6173 6b28 0a20 2020 2020 2020 2020 2020  ask(.           
+000196f0: 2022 7570 326b 2e68 616e 646c 655f 726d   "up2k.handle_rm
+00019700: 222c 2073 656c 662e 756e 616d 652c 2073  ", self.uname, s
+00019710: 656c 662e 6970 2c20 7265 712c 206c 696d  elf.ip, req, lim
+00019720: 2c20 4661 6c73 650a 2020 2020 2020 2020  , False.        
+00019730: 290a 2020 2020 2020 2020 7365 6c66 2e6c  ).        self.l
+00019740: 6f75 645f 7265 706c 7928 782e 6765 7428  oud_reply(x.get(
+00019750: 2929 0a20 2020 2020 2020 2072 6574 7572  )).        retur
+00019760: 6e20 5472 7565 0a0a 2020 2020 6465 6620  n True..    def 
+00019770: 6861 6e64 6c65 5f6d 7628 7365 6c66 2920  handle_mv(self) 
+00019780: 203a 0a20 2020 2020 2020 2023 2066 756c   :.        # ful
+00019790: 6c20 7061 7468 206f 6620 6e65 7720 6c6f  l path of new lo
+000197a0: 6320 2869 6e63 6c20 6669 6c65 6e61 6d65  c (incl filename
+000197b0: 290a 2020 2020 2020 2020 6473 7420 3d20  ).        dst = 
+000197c0: 7365 6c66 2e75 7061 7261 6d2e 6765 7428  self.uparam.get(
+000197d0: 226d 6f76 6522 290a 0a20 2020 2020 2020  "move")..       
+000197e0: 2069 6620 7365 6c66 2e69 735f 7670 726f   if self.is_vpro
+000197f0: 7869 6564 2061 6e64 2064 7374 2061 6e64  xied and dst and
+00019800: 2064 7374 2e73 7461 7274 7377 6974 6828   dst.startswith(
+00019810: 7365 6c66 2e61 7267 732e 5352 293a 0a20  self.args.SR):. 
+00019820: 2020 2020 2020 2020 2020 2064 7374 203d             dst =
+00019830: 2064 7374 5b6c 656e 2873 656c 662e 6172   dst[len(self.ar
+00019840: 6773 2e52 5329 203a 5d0a 0a20 2020 2020  gs.RS) :]..     
+00019850: 2020 2069 6620 6e6f 7420 6473 743a 0a20     if not dst:. 
+00019860: 2020 2020 2020 2020 2020 2072 6169 7365             raise
+00019870: 2050 6562 6b61 6328 3430 302c 2022 6e65   Pebkac(400, "ne
+00019880: 6564 2064 7374 2076 7061 7468 2229 0a0a  ed dst vpath")..
+00019890: 2020 2020 2020 2020 2320 782d 7777 772d          # x-www-
+000198a0: 666f 726d 2d75 726c 656e 636f 6465 6420  form-urlencoded 
+000198b0: 2875 726c 2071 7565 7279 2070 6172 7429  (url query part)
+000198c0: 2075 7365 730a 2020 2020 2020 2020 2320   uses.        # 
+000198d0: 6569 7468 6572 202b 206f 7220 2532 3020  either + or %20 
+000198e0: 666f 7220 3078 3230 2073 6f20 6861 6e64  for 0x20 so hand
+000198f0: 6c65 2062 6f74 680a 2020 2020 2020 2020  le both.        
+00019900: 6473 7420 3d20 756e 7175 6f74 6570 2864  dst = unquotep(d
+00019910: 7374 2e72 6570 6c61 6365 2822 2b22 2c20  st.replace("+", 
+00019920: 2220 2229 290a 2020 2020 2020 2020 7265  " ")).        re
+00019930: 7475 726e 2073 656c 662e 5f6d 7628 7365  turn self._mv(se
+00019940: 6c66 2e76 7061 7468 2c20 6473 742e 6c73  lf.vpath, dst.ls
+00019950: 7472 6970 2822 2f22 2929 0a0a 2020 2020  trip("/"))..    
+00019960: 6465 6620 5f6d 7628 7365 6c66 2c20 7673  def _mv(self, vs
+00019970: 7263 202c 2076 6473 7420 2920 203a 0a20  rc , vdst )  :. 
+00019980: 2020 2020 2020 2069 6620 6e6f 7420 7365         if not se
+00019990: 6c66 2e63 616e 5f6d 6f76 653a 0a20 2020  lf.can_move:.   
+000199a0: 2020 2020 2020 2020 2072 6169 7365 2050           raise P
+000199b0: 6562 6b61 6328 3430 332c 2022 6e6f 7420  ebkac(403, "not 
+000199c0: 616c 6c6f 7765 6420 666f 7220 7573 6572  allowed for user
+000199d0: 2022 202b 2073 656c 662e 756e 616d 6529   " + self.uname)
+000199e0: 0a0a 2020 2020 2020 2020 6966 2073 656c  ..        if sel
+000199f0: 662e 6172 6773 2e6e 6f5f 6d76 3a0a 2020  f.args.no_mv:.  
+00019a00: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
+00019a10: 5065 626b 6163 2834 3033 2c20 2274 6865  Pebkac(403, "the
+00019a20: 2072 656e 616d 652f 6d6f 7665 2066 6561   rename/move fea
+00019a30: 7475 7265 2069 7320 6469 7361 626c 6564  ture is disabled
+00019a40: 2069 6e20 7365 7276 6572 2063 6f6e 6669   in server confi
+00019a50: 6722 290a 0a20 2020 2020 2020 2078 203d  g")..        x =
+00019a60: 2073 656c 662e 636f 6e6e 2e68 7372 762e   self.conn.hsrv.
+00019a70: 6272 6f6b 6572 2e61 736b 2822 7570 326b  broker.ask("up2k
+00019a80: 2e68 616e 646c 655f 6d76 222c 2073 656c  .handle_mv", sel
+00019a90: 662e 756e 616d 652c 2076 7372 632c 2076  f.uname, vsrc, v
+00019aa0: 6473 7429 0a20 2020 2020 2020 2073 656c  dst).        sel
+00019ab0: 662e 6c6f 7564 5f72 6570 6c79 2878 2e67  f.loud_reply(x.g
+00019ac0: 6574 2829 2c20 7374 6174 7573 3d32 3031  et(), status=201
+00019ad0: 290a 2020 2020 2020 2020 7265 7475 726e  ).        return
+00019ae0: 2054 7275 650a 0a20 2020 2064 6566 2074   True..    def t
+00019af0: 785f 6c73 2873 656c 662c 206c 7320 2029  x_ls(self, ls  )
+00019b00: 2020 3a0a 2020 2020 2020 2020 6469 7273    :.        dirs
+00019b10: 203d 206c 735b 2264 6972 7322 5d0a 2020   = ls["dirs"].  
+00019b20: 2020 2020 2020 6669 6c65 7320 3d20 6c73        files = ls
+00019b30: 5b22 6669 6c65 7322 5d0a 2020 2020 2020  ["files"].      
+00019b40: 2020 6172 6720 3d20 7365 6c66 2e75 7061    arg = self.upa
+00019b50: 7261 6d5b 226c 7322 5d0a 2020 2020 2020  ram["ls"].      
+00019b60: 2020 6966 2061 7267 2069 6e20 5b22 7622    if arg in ["v"
+00019b70: 2c20 2274 222c 2022 7478 7422 5d3a 0a20  , "t", "txt"]:. 
+00019b80: 2020 2020 2020 2020 2020 2074 7279 3a0a             try:.
+00019b90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019ba0: 6269 6767 6573 7420 3d20 6d61 7828 6c73  biggest = max(ls
+00019bb0: 5b22 6669 6c65 7322 5d20 2b20 6c73 5b22  ["files"] + ls["
+00019bc0: 6469 7273 225d 2c20 6b65 793d 6974 656d  dirs"], key=item
+00019bd0: 6765 7474 6572 2822 737a 2229 295b 2273  getter("sz"))["s
+00019be0: 7a22 5d0a 2020 2020 2020 2020 2020 2020  z"].            
+00019bf0: 6578 6365 7074 3a0a 2020 2020 2020 2020  except:.        
+00019c00: 2020 2020 2020 2020 6269 6767 6573 7420          biggest 
+00019c10: 3d20 300a 0a20 2020 2020 2020 2020 2020  = 0..           
+00019c20: 2069 6620 6172 6720 3d3d 2022 7622 3a0a   if arg == "v":.
 00019c30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019c40: 2020 2020 2020 2022 5c30 3333 5b32 376d         "\033[27m
-00019c50: 222c 0a20 2020 2020 2020 2020 2020 2020  ",.             
-00019c60: 2020 2020 2020 2020 2020 2022 222c 0a20             "",. 
-00019c70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019c80: 2020 2020 2020 2022 5c30 3333 5b30 3b31         "\033[0;1
-00019c90: 6d22 2c0a 2020 2020 2020 2020 2020 2020  m",.            
-00019ca0: 2020 2020 2020 2020 2020 2020 225c 3033              "\03
-00019cb0: 335b 303b 3336 6d22 2c0a 2020 2020 2020  3[0;36m",.      
-00019cc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019cd0: 2020 225c 3033 335b 306d 222c 0a20 2020    "\033[0m",.   
-00019ce0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019cf0: 205d 0a20 2020 2020 2020 2020 2020 2020   ].             
-00019d00: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
-00019d10: 2020 2020 2063 7461 6220 3d20 7b22 4222       ctab = {"B"
-00019d20: 3a20 362c 2022 4b22 3a20 352c 2022 4d22  : 6, "K": 5, "M"
-00019d30: 3a20 312c 2022 4722 3a20 337d 0a20 2020  : 1, "G": 3}.   
-00019d40: 2020 2020 2020 2020 2020 2020 2066 6f72               for
-00019d50: 206c 7374 2069 6e20 5b64 6972 732c 2066   lst in [dirs, f
-00019d60: 696c 6573 5d3a 0a20 2020 2020 2020 2020  iles]:.         
-00019d70: 2020 2020 2020 2020 2020 2066 6f72 2078             for x
-00019d80: 2069 6e20 6c73 743a 0a20 2020 2020 2020   in lst:.       
-00019d90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019da0: 2061 203d 2078 5b22 6474 225d 2e72 6570   a = x["dt"].rep
-00019db0: 6c61 6365 2822 2d22 2c20 2220 2229 2e72  lace("-", " ").r
-00019dc0: 6570 6c61 6365 2822 3a22 2c20 2220 2229  eplace(":", " ")
-00019dd0: 2e73 706c 6974 2822 2022 290a 2020 2020  .split(" ").    
-00019de0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019df0: 2020 2020 785b 2264 7422 5d20 3d20 6632      x["dt"] = f2
-00019e00: 2e66 6f72 6d61 7428 2a6c 6973 7428 6129  .format(*list(a)
-00019e10: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00019e20: 2020 2020 2020 2020 2020 737a 203d 2068            sz = h
-00019e30: 756d 616e 7369 7a65 2878 5b22 737a 225d  umansize(x["sz"]
-00019e40: 2c20 5472 7565 290a 2020 2020 2020 2020  , True).        
-00019e50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019e60: 785b 2273 7a22 5d20 3d20 225c 3033 335b  x["sz"] = "\033[
-00019e70: 303b 337b 7d6d 207b 3a3e 357d 222e 666f  0;3{}m {:>5}".fo
-00019e80: 726d 6174 2863 7461 622e 6765 7428 737a  rmat(ctab.get(sz
-00019e90: 5b2d 313a 5d2c 2030 292c 2073 7a29 0a20  [-1:], 0), sz). 
-00019ea0: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
-00019eb0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00019ec0: 2066 6d74 203d 2022 7b7b 7d7d 2020 7b7b   fmt = "{{}}  {{
-00019ed0: 3a7b 7d2c 7d7d 2020 7b7b 7d7d 220a 2020  :{},}}  {{}}".  
-00019ee0: 2020 2020 2020 2020 2020 2020 2020 6e66                nf
-00019ef0: 6d74 203d 2022 7b3a 2c7d 220a 0a20 2020  mt = "{:,}"..   
-00019f00: 2020 2020 2020 2020 2066 6f72 2078 2069           for x i
-00019f10: 6e20 6469 7273 3a0a 2020 2020 2020 2020  n dirs:.        
-00019f20: 2020 2020 2020 2020 6e20 3d20 785b 226e          n = x["n
-00019f30: 616d 6522 5d20 2b20 222f 220a 2020 2020  ame"] + "/".    
-00019f40: 2020 2020 2020 2020 2020 2020 6966 2061              if a
-00019f50: 7267 203d 3d20 2276 223a 0a20 2020 2020  rg == "v":.     
-00019f60: 2020 2020 2020 2020 2020 2020 2020 206e                 n
-00019f70: 203d 2022 5c30 3333 5b39 346d 2220 2b20   = "\033[94m" + 
-00019f80: 6e0a 0a20 2020 2020 2020 2020 2020 2020  n..             
-00019f90: 2020 2078 5b22 6e61 6d65 225d 203d 206e     x["name"] = n
-00019fa0: 0a0a 2020 2020 2020 2020 2020 2020 666d  ..            fm
-00019fb0: 7420 3d20 666d 742e 666f 726d 6174 286c  t = fmt.format(l
-00019fc0: 656e 286e 666d 742e 666f 726d 6174 2862  en(nfmt.format(b
-00019fd0: 6967 6765 7374 2929 290a 2020 2020 2020  iggest))).      
-00019fe0: 2020 2020 2020 7265 746c 203d 205b 0a20        retl = [. 
-00019ff0: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-0001a000: 2320 7b7d 3a20 7b7d 222e 666f 726d 6174  # {}: {}".format
-0001a010: 2878 2c20 6c73 5b78 5d29 0a20 2020 2020  (x, ls[x]).     
-0001a020: 2020 2020 2020 2020 2020 2066 6f72 2078             for x
-0001a030: 2069 6e20 5b22 6163 6374 222c 2022 7065   in ["acct", "pe
-0001a040: 726d 7322 2c20 2273 7276 696e 6622 5d0a  rms", "srvinf"].
-0001a050: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a060: 6966 2078 2069 6e20 6c73 0a20 2020 2020  if x in ls.     
-0001a070: 2020 2020 2020 205d 0a20 2020 2020 2020         ].       
-0001a080: 2020 2020 2072 6574 6c20 2b3d 205b 0a20       retl += [. 
-0001a090: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-0001a0a0: 6d74 2e66 6f72 6d61 7428 785b 2264 7422  mt.format(x["dt"
-0001a0b0: 5d2c 2078 5b22 737a 225d 2c20 785b 226e  ], x["sz"], x["n
-0001a0c0: 616d 6522 5d29 0a20 2020 2020 2020 2020  ame"]).         
-0001a0d0: 2020 2020 2020 2066 6f72 2079 2069 6e20         for y in 
-0001a0e0: 5b64 6972 732c 2066 696c 6573 5d0a 2020  [dirs, files].  
-0001a0f0: 2020 2020 2020 2020 2020 2020 2020 666f                fo
-0001a100: 7220 7820 696e 2079 0a20 2020 2020 2020  r x in y.       
-0001a110: 2020 2020 205d 0a20 2020 2020 2020 2020       ].         
-0001a120: 2020 2072 6574 203d 2022 5c6e 222e 6a6f     ret = "\n".jo
-0001a130: 696e 2872 6574 6c29 0a20 2020 2020 2020  in(retl).       
-0001a140: 2020 2020 206d 696d 6520 3d20 2274 6578       mime = "tex
-0001a150: 742f 706c 6169 6e3b 2063 6861 7273 6574  t/plain; charset
-0001a160: 3d75 7466 2d38 220a 2020 2020 2020 2020  =utf-8".        
-0001a170: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-0001a180: 2020 5b78 2e70 6f70 286b 2920 666f 7220    [x.pop(k) for 
-0001a190: 6b20 696e 205b 226e 616d 6522 2c20 2264  k in ["name", "d
-0001a1a0: 7422 5d20 666f 7220 7920 696e 205b 6469  t"] for y in [di
-0001a1b0: 7273 2c20 6669 6c65 735d 2066 6f72 2078  rs, files] for x
-0001a1c0: 2069 6e20 795d 0a0a 2020 2020 2020 2020   in y]..        
-0001a1d0: 2020 2020 7265 7420 3d20 6a73 6f6e 2e64      ret = json.d
-0001a1e0: 756d 7073 286c 7329 0a20 2020 2020 2020  umps(ls).       
-0001a1f0: 2020 2020 206d 696d 6520 3d20 2261 7070       mime = "app
-0001a200: 6c69 6361 7469 6f6e 2f6a 736f 6e22 0a0a  lication/json"..
-0001a210: 2020 2020 2020 2020 7265 7420 2b3d 2022          ret += "
-0001a220: 5c6e 5c30 3333 5b30 6d22 2069 6620 6172  \n\033[0m" if ar
-0001a230: 6720 3d3d 2022 7622 2065 6c73 6520 225c  g == "v" else "\
-0001a240: 6e22 0a20 2020 2020 2020 2073 656c 662e  n".        self.
-0001a250: 7265 706c 7928 7265 742e 656e 636f 6465  reply(ret.encode
-0001a260: 2822 7574 662d 3822 2c20 2272 6570 6c61  ("utf-8", "repla
-0001a270: 6365 2229 2c20 6d69 6d65 3d6d 696d 6529  ce"), mime=mime)
-0001a280: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-0001a290: 5472 7565 0a0a 2020 2020 6465 6620 7478  True..    def tx
-0001a2a0: 5f62 726f 7773 6572 2873 656c 6629 2020  _browser(self)  
-0001a2b0: 3a0a 2020 2020 2020 2020 7670 6174 6820  :.        vpath 
-0001a2c0: 3d20 2222 0a20 2020 2020 2020 2076 706e  = "".        vpn
-0001a2d0: 6f64 6573 203d 205b 5b22 222c 2022 2f22  odes = [["", "/"
-0001a2e0: 5d5d 0a20 2020 2020 2020 2069 6620 7365  ]].        if se
-0001a2f0: 6c66 2e76 7061 7468 3a0a 2020 2020 2020  lf.vpath:.      
-0001a300: 2020 2020 2020 666f 7220 6e6f 6465 2069        for node i
-0001a310: 6e20 7365 6c66 2e76 7061 7468 2e73 706c  n self.vpath.spl
-0001a320: 6974 2822 2f22 293a 0a20 2020 2020 2020  it("/"):.       
-0001a330: 2020 2020 2020 2020 2069 6620 6e6f 7420           if not 
-0001a340: 7670 6174 683a 0a20 2020 2020 2020 2020  vpath:.         
-0001a350: 2020 2020 2020 2020 2020 2076 7061 7468             vpath
-0001a360: 203d 206e 6f64 650a 2020 2020 2020 2020   = node.        
-0001a370: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-0001a380: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a390: 2020 7670 6174 6820 2b3d 2022 2f22 202b    vpath += "/" +
-0001a3a0: 206e 6f64 650a 0a20 2020 2020 2020 2020   node..         
-0001a3b0: 2020 2020 2020 2076 706e 6f64 6573 2e61         vpnodes.a
-0001a3c0: 7070 656e 6428 5b71 756f 7465 7028 7670  ppend([quotep(vp
-0001a3d0: 6174 6829 202b 2022 2f22 2c20 6874 6d6c  ath) + "/", html
-0001a3e0: 5f65 7363 6170 6528 6e6f 6465 2c20 6372  _escape(node, cr
-0001a3f0: 6c66 3d54 7275 6529 5d29 0a0a 2020 2020  lf=True)])..    
-0001a400: 2020 2020 766e 2c20 7265 6d20 3d20 7365      vn, rem = se
-0001a410: 6c66 2e61 7372 762e 7666 732e 6765 7428  lf.asrv.vfs.get(
-0001a420: 7365 6c66 2e76 7061 7468 2c20 7365 6c66  self.vpath, self
-0001a430: 2e75 6e61 6d65 2c20 4661 6c73 652c 2046  .uname, False, F
-0001a440: 616c 7365 290a 2020 2020 2020 2020 6162  alse).        ab
-0001a450: 7370 6174 6820 3d20 766e 2e64 6361 6e6f  spath = vn.dcano
-0001a460: 6e69 6361 6c28 7265 6d29 0a20 2020 2020  nical(rem).     
-0001a470: 2020 2064 6276 2c20 7672 656d 203d 2076     dbv, vrem = v
-0001a480: 6e2e 6765 745f 6462 7628 7265 6d29 0a0a  n.get_dbv(rem)..
-0001a490: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
-0001a4a0: 2020 2020 2020 2020 2073 7420 3d20 626f           st = bo
-0001a4b0: 732e 7374 6174 2861 6273 7061 7468 290a  s.stat(abspath).
-0001a4c0: 2020 2020 2020 2020 6578 6365 7074 3a0a          except:.
-0001a4d0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-0001a4e0: 726e 2073 656c 662e 7478 5f34 3034 2829  rn self.tx_404()
-0001a4f0: 0a0a 2020 2020 2020 2020 6966 2072 656d  ..        if rem
-0001a500: 2e73 7461 7274 7377 6974 6828 222e 6869  .startswith(".hi
-0001a510: 7374 2f75 7032 6b2e 2229 206f 7220 280a  st/up2k.") or (.
-0001a520: 2020 2020 2020 2020 2020 2020 7265 6d2e              rem.
-0001a530: 656e 6473 7769 7468 2822 2f64 6972 2e74  endswith("/dir.t
-0001a540: 7874 2229 2061 6e64 2072 656d 2e73 7461  xt") and rem.sta
-0001a550: 7274 7377 6974 6828 222e 6869 7374 2f74  rtswith(".hist/t
-0001a560: 682f 2229 0a20 2020 2020 2020 2029 3a0a  h/").        ):.
-0001a570: 2020 2020 2020 2020 2020 2020 7261 6973              rais
-0001a580: 6520 5065 626b 6163 2834 3033 290a 0a20  e Pebkac(403).. 
-0001a590: 2020 2020 2020 2065 3264 203d 2022 6532         e2d = "e2
-0001a5a0: 6422 2069 6e20 766e 2e66 6c61 6773 0a20  d" in vn.flags. 
-0001a5b0: 2020 2020 2020 2065 3274 203d 2022 6532         e2t = "e2
-0001a5c0: 7422 2069 6e20 766e 2e66 6c61 6773 0a0a  t" in vn.flags..
-0001a5d0: 2020 2020 2020 2020 7365 6c66 2e68 746d          self.htm
-0001a5e0: 6c5f 6865 6164 203d 2076 6e2e 666c 6167  l_head = vn.flag
-0001a5f0: 732e 6765 7428 2268 746d 6c5f 6865 6164  s.get("html_head
-0001a600: 222c 2022 2229 0a20 2020 2020 2020 2069  ", "").        i
-0001a610: 6620 766e 2e66 6c61 6773 2e67 6574 2822  f vn.flags.get("
-0001a620: 6e6f 726f 626f 7473 2229 206f 7220 2262  norobots") or "b
-0001a630: 2220 696e 2073 656c 662e 7570 6172 616d  " in self.uparam
-0001a640: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
-0001a650: 6c66 2e6f 7574 5f68 6561 6465 7273 5b22  lf.out_headers["
-0001a660: 582d 526f 626f 7473 2d54 6167 225d 203d  X-Robots-Tag"] =
-0001a670: 2022 6e6f 696e 6465 782c 206e 6f66 6f6c   "noindex, nofol
-0001a680: 6c6f 7722 0a20 2020 2020 2020 2065 6c73  low".        els
-0001a690: 653a 0a20 2020 2020 2020 2020 2020 2073  e:.            s
-0001a6a0: 656c 662e 6f75 745f 6865 6164 6572 732e  elf.out_headers.
-0001a6b0: 706f 7028 2258 2d52 6f62 6f74 732d 5461  pop("X-Robots-Ta
-0001a6c0: 6722 2c20 4e6f 6e65 290a 0a20 2020 2020  g", None)..     
-0001a6d0: 2020 2069 735f 6469 7220 3d20 7374 6174     is_dir = stat
-0001a6e0: 2e53 5f49 5344 4952 2873 742e 7374 5f6d  .S_ISDIR(st.st_m
-0001a6f0: 6f64 6529 0a20 2020 2020 2020 2069 6375  ode).        icu
-0001a700: 7220 3d20 4e6f 6e65 0a20 2020 2020 2020  r = None.       
-0001a710: 2069 6620 6973 5f64 6972 2061 6e64 2028   if is_dir and (
-0001a720: 6532 7420 6f72 2065 3264 293a 0a20 2020  e2t or e2d):.   
-0001a730: 2020 2020 2020 2020 2069 6478 203d 2073           idx = s
-0001a740: 656c 662e 636f 6e6e 2e67 6574 5f75 3269  elf.conn.get_u2i
-0001a750: 6478 2829 0a20 2020 2020 2020 2020 2020  dx().           
-0001a760: 2069 6620 6964 7820 616e 6420 6861 7361   if idx and hasa
-0001a770: 7474 7228 6964 782c 2022 705f 656e 6422  ttr(idx, "p_end"
-0001a780: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-0001a790: 2020 2069 6375 7220 3d20 6964 782e 6765     icur = idx.ge
-0001a7a0: 745f 6375 7228 6462 762e 7265 616c 7061  t_cur(dbv.realpa
-0001a7b0: 7468 290a 0a20 2020 2020 2020 2069 6620  th)..        if 
-0001a7c0: 7365 6c66 2e63 616e 5f72 6561 643a 0a20  self.can_read:. 
-0001a7d0: 2020 2020 2020 2020 2020 2074 685f 666d             th_fm
-0001a7e0: 7420 3d20 7365 6c66 2e75 7061 7261 6d2e  t = self.uparam.
-0001a7f0: 6765 7428 2274 6822 290a 2020 2020 2020  get("th").      
-0001a800: 2020 2020 2020 6966 2074 685f 666d 7420        if th_fmt 
-0001a810: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
-0001a820: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-0001a830: 6973 5f64 6972 3a0a 2020 2020 2020 2020  is_dir:.        
-0001a840: 2020 2020 2020 2020 2020 2020 7672 656d              vrem
-0001a850: 203d 2076 7265 6d2e 7273 7472 6970 2822   = vrem.rstrip("
-0001a860: 2f22 290a 2020 2020 2020 2020 2020 2020  /").            
-0001a870: 2020 2020 2020 2020 6966 2069 6375 7220          if icur 
-0001a880: 616e 6420 7672 656d 3a0a 2020 2020 2020  and vrem:.      
-0001a890: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a8a0: 2020 7120 3d20 2273 656c 6563 7420 666e    q = "select fn
-0001a8b0: 2066 726f 6d20 6376 2077 6865 7265 2072   from cv where r
-0001a8c0: 643d 3f20 616e 6420 646e 3d3f 220a 2020  d=? and dn=?".  
-0001a8d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a8e0: 2020 2020 2020 6372 642c 2063 646e 203d        crd, cdn =
-0001a8f0: 2076 7265 6d2e 7273 706c 6974 2822 2f22   vrem.rsplit("/"
-0001a900: 2c20 3129 2069 6620 222f 2220 696e 2076  , 1) if "/" in v
-0001a910: 7265 6d20 656c 7365 2028 2222 2c20 7672  rem else ("", vr
-0001a920: 656d 290a 2020 2020 2020 2020 2020 2020  em).            
-0001a930: 2020 2020 2020 2020 2020 2020 2320 6e6f              # no
-0001a940: 206d 6f6a 6962 616b 6520 7375 7070 6f72   mojibake suppor
-0001a950: 743a 0a20 2020 2020 2020 2020 2020 2020  t:.             
-0001a960: 2020 2020 2020 2020 2020 2074 7279 3a0a             try:.
-0001a970: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a980: 2020 2020 2020 2020 2020 2020 6366 6e20              cfn 
-0001a990: 3d20 6963 7572 2e65 7865 6375 7465 2871  = icur.execute(q
-0001a9a0: 2c20 2863 7264 2c20 6364 6e29 292e 6665  , (crd, cdn)).fe
-0001a9b0: 7463 686f 6e65 2829 0a20 2020 2020 2020  tchone().       
-0001a9c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a9d0: 2020 2020 2069 6620 6366 6e3a 0a20 2020       if cfn:.   
-0001a9e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a9f0: 2020 2020 2020 2020 2020 2020 2066 6e20               fn 
-0001aa00: 3d20 6366 6e5b 305d 0a20 2020 2020 2020  = cfn[0].       
-0001aa10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001aa20: 2020 2020 2020 2020 2066 7020 3d20 6f73           fp = os
-0001aa30: 2e70 6174 682e 6a6f 696e 2861 6273 7061  .path.join(abspa
-0001aa40: 7468 2c20 666e 290a 2020 2020 2020 2020  th, fn).        
+00019c40: 666d 7420 3d20 225c 3033 335b 303b 373b  fmt = "\033[0;7;
+00019c50: 3336 6d7b 7b7d 7d7b 7b3a 3e7b 7d7d 7d5c  36m{{}}{{:>{}}}\
+00019c60: 3033 335b 306d 207b 7b7d 7d22 0a20 2020  033[0m {{}}".   
+00019c70: 2020 2020 2020 2020 2020 2020 206e 666d               nfm
+00019c80: 7420 3d20 227b 7d22 0a20 2020 2020 2020  t = "{}".       
+00019c90: 2020 2020 2020 2020 2062 6967 6765 7374           biggest
+00019ca0: 203d 2030 0a20 2020 2020 2020 2020 2020   = 0.           
+00019cb0: 2020 2020 2066 3220 3d20 2222 2e6a 6f69       f2 = "".joi
+00019cc0: 6e28 0a20 2020 2020 2020 2020 2020 2020  n(.             
+00019cd0: 2020 2020 2020 2022 7b7d 7b7b 7d7d 222e         "{}{{}}".
+00019ce0: 666f 726d 6174 2878 290a 2020 2020 2020  format(x).      
+00019cf0: 2020 2020 2020 2020 2020 2020 2020 666f                fo
+00019d00: 7220 7820 696e 205b 0a20 2020 2020 2020  r x in [.       
+00019d10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019d20: 2022 5c30 3333 5b37 6d22 2c0a 2020 2020   "\033[7m",.    
+00019d30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019d40: 2020 2020 225c 3033 335b 3237 6d22 2c0a      "\033[27m",.
+00019d50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019d60: 2020 2020 2020 2020 2222 2c0a 2020 2020          "",.    
+00019d70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019d80: 2020 2020 225c 3033 335b 303b 316d 222c      "\033[0;1m",
+00019d90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00019da0: 2020 2020 2020 2020 2022 5c30 3333 5b30           "\033[0
+00019db0: 3b33 366d 222c 0a20 2020 2020 2020 2020  ;36m",.         
+00019dc0: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+00019dd0: 5c30 3333 5b30 6d22 2c0a 2020 2020 2020  \033[0m",.      
+00019de0: 2020 2020 2020 2020 2020 2020 2020 5d0a                ].
+00019df0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019e00: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00019e10: 2020 6374 6162 203d 207b 2242 223a 2036    ctab = {"B": 6
+00019e20: 2c20 224b 223a 2035 2c20 224d 223a 2031  , "K": 5, "M": 1
+00019e30: 2c20 2247 223a 2033 7d0a 2020 2020 2020  , "G": 3}.      
+00019e40: 2020 2020 2020 2020 2020 666f 7220 6c73            for ls
+00019e50: 7420 696e 205b 6469 7273 2c20 6669 6c65  t in [dirs, file
+00019e60: 735d 3a0a 2020 2020 2020 2020 2020 2020  s]:.            
+00019e70: 2020 2020 2020 2020 666f 7220 7820 696e          for x in
+00019e80: 206c 7374 3a0a 2020 2020 2020 2020 2020   lst:.          
+00019e90: 2020 2020 2020 2020 2020 2020 2020 6120                a 
+00019ea0: 3d20 785b 2264 7422 5d2e 7265 706c 6163  = x["dt"].replac
+00019eb0: 6528 222d 222c 2022 2022 292e 7265 706c  e("-", " ").repl
+00019ec0: 6163 6528 223a 222c 2022 2022 292e 7370  ace(":", " ").sp
+00019ed0: 6c69 7428 2220 2229 0a20 2020 2020 2020  lit(" ").       
+00019ee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019ef0: 2078 5b22 6474 225d 203d 2066 322e 666f   x["dt"] = f2.fo
+00019f00: 726d 6174 282a 6c69 7374 2861 2929 0a20  rmat(*list(a)). 
+00019f10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019f20: 2020 2020 2020 2073 7a20 3d20 6875 6d61         sz = huma
+00019f30: 6e73 697a 6528 785b 2273 7a22 5d2c 2054  nsize(x["sz"], T
+00019f40: 7275 6529 0a20 2020 2020 2020 2020 2020  rue).           
+00019f50: 2020 2020 2020 2020 2020 2020 2078 5b22               x["
+00019f60: 737a 225d 203d 2022 5c30 3333 5b30 3b33  sz"] = "\033[0;3
+00019f70: 7b7d 6d20 7b3a 3e35 7d22 2e66 6f72 6d61  {}m {:>5}".forma
+00019f80: 7428 6374 6162 2e67 6574 2873 7a5b 2d31  t(ctab.get(sz[-1
+00019f90: 3a5d 2c20 3029 2c20 737a 290a 2020 2020  :], 0), sz).    
+00019fa0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+00019fb0: 2020 2020 2020 2020 2020 2020 2020 666d                fm
+00019fc0: 7420 3d20 227b 7b7d 7d20 207b 7b3a 7b7d  t = "{{}}  {{:{}
+00019fd0: 2c7d 7d20 207b 7b7d 7d22 0a20 2020 2020  ,}}  {{}}".     
+00019fe0: 2020 2020 2020 2020 2020 206e 666d 7420             nfmt 
+00019ff0: 3d20 227b 3a2c 7d22 0a0a 2020 2020 2020  = "{:,}"..      
+0001a000: 2020 2020 2020 666f 7220 7820 696e 2064        for x in d
+0001a010: 6972 733a 0a20 2020 2020 2020 2020 2020  irs:.           
+0001a020: 2020 2020 206e 203d 2078 5b22 6e61 6d65       n = x["name
+0001a030: 225d 202b 2022 2f22 0a20 2020 2020 2020  "] + "/".       
+0001a040: 2020 2020 2020 2020 2069 6620 6172 6720           if arg 
+0001a050: 3d3d 2022 7622 3a0a 2020 2020 2020 2020  == "v":.        
+0001a060: 2020 2020 2020 2020 2020 2020 6e20 3d20              n = 
+0001a070: 225c 3033 335b 3934 6d22 202b 206e 0a0a  "\033[94m" + n..
+0001a080: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a090: 785b 226e 616d 6522 5d20 3d20 6e0a 0a20  x["name"] = n.. 
+0001a0a0: 2020 2020 2020 2020 2020 2066 6d74 203d             fmt =
+0001a0b0: 2066 6d74 2e66 6f72 6d61 7428 6c65 6e28   fmt.format(len(
+0001a0c0: 6e66 6d74 2e66 6f72 6d61 7428 6269 6767  nfmt.format(bigg
+0001a0d0: 6573 7429 2929 0a20 2020 2020 2020 2020  est))).         
+0001a0e0: 2020 2072 6574 6c20 3d20 5b0a 2020 2020     retl = [.    
+0001a0f0: 2020 2020 2020 2020 2020 2020 2223 207b              "# {
+0001a100: 7d3a 207b 7d22 2e66 6f72 6d61 7428 782c  }: {}".format(x,
+0001a110: 206c 735b 785d 290a 2020 2020 2020 2020   ls[x]).        
+0001a120: 2020 2020 2020 2020 666f 7220 7820 696e          for x in
+0001a130: 205b 2261 6363 7422 2c20 2270 6572 6d73   ["acct", "perms
+0001a140: 222c 2022 7372 7669 6e66 225d 0a20 2020  ", "srvinf"].   
+0001a150: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+0001a160: 7820 696e 206c 730a 2020 2020 2020 2020  x in ls.        
+0001a170: 2020 2020 5d0a 2020 2020 2020 2020 2020      ].          
+0001a180: 2020 7265 746c 202b 3d20 5b0a 2020 2020    retl += [.    
+0001a190: 2020 2020 2020 2020 2020 2020 666d 742e              fmt.
+0001a1a0: 666f 726d 6174 2878 5b22 6474 225d 2c20  format(x["dt"], 
+0001a1b0: 785b 2273 7a22 5d2c 2078 5b22 6e61 6d65  x["sz"], x["name
+0001a1c0: 225d 290a 2020 2020 2020 2020 2020 2020  "]).            
+0001a1d0: 2020 2020 666f 7220 7920 696e 205b 6469      for y in [di
+0001a1e0: 7273 2c20 6669 6c65 735d 0a20 2020 2020  rs, files].     
+0001a1f0: 2020 2020 2020 2020 2020 2066 6f72 2078             for x
+0001a200: 2069 6e20 790a 2020 2020 2020 2020 2020   in y.          
+0001a210: 2020 5d0a 2020 2020 2020 2020 2020 2020    ].            
+0001a220: 7265 7420 3d20 225c 6e22 2e6a 6f69 6e28  ret = "\n".join(
+0001a230: 7265 746c 290a 2020 2020 2020 2020 2020  retl).          
+0001a240: 2020 6d69 6d65 203d 2022 7465 7874 2f70    mime = "text/p
+0001a250: 6c61 696e 3b20 6368 6172 7365 743d 7574  lain; charset=ut
+0001a260: 662d 3822 0a20 2020 2020 2020 2065 6c73  f-8".        els
+0001a270: 653a 0a20 2020 2020 2020 2020 2020 205b  e:.            [
+0001a280: 782e 706f 7028 6b29 2066 6f72 206b 2069  x.pop(k) for k i
+0001a290: 6e20 5b22 6e61 6d65 222c 2022 6474 225d  n ["name", "dt"]
+0001a2a0: 2066 6f72 2079 2069 6e20 5b64 6972 732c   for y in [dirs,
+0001a2b0: 2066 696c 6573 5d20 666f 7220 7820 696e   files] for x in
+0001a2c0: 2079 5d0a 0a20 2020 2020 2020 2020 2020   y]..           
+0001a2d0: 2072 6574 203d 206a 736f 6e2e 6475 6d70   ret = json.dump
+0001a2e0: 7328 6c73 290a 2020 2020 2020 2020 2020  s(ls).          
+0001a2f0: 2020 6d69 6d65 203d 2022 6170 706c 6963    mime = "applic
+0001a300: 6174 696f 6e2f 6a73 6f6e 220a 0a20 2020  ation/json"..   
+0001a310: 2020 2020 2072 6574 202b 3d20 225c 6e5c       ret += "\n\
+0001a320: 3033 335b 306d 2220 6966 2061 7267 203d  033[0m" if arg =
+0001a330: 3d20 2276 2220 656c 7365 2022 5c6e 220a  = "v" else "\n".
+0001a340: 2020 2020 2020 2020 7365 6c66 2e72 6570          self.rep
+0001a350: 6c79 2872 6574 2e65 6e63 6f64 6528 2275  ly(ret.encode("u
+0001a360: 7466 2d38 222c 2022 7265 706c 6163 6522  tf-8", "replace"
+0001a370: 292c 206d 696d 653d 6d69 6d65 290a 2020  ), mime=mime).  
+0001a380: 2020 2020 2020 7265 7475 726e 2054 7275        return Tru
+0001a390: 650a 0a20 2020 2064 6566 2074 785f 6272  e..    def tx_br
+0001a3a0: 6f77 7365 7228 7365 6c66 2920 203a 0a20  owser(self)  :. 
+0001a3b0: 2020 2020 2020 2076 7061 7468 203d 2022         vpath = "
+0001a3c0: 220a 2020 2020 2020 2020 7670 6e6f 6465  ".        vpnode
+0001a3d0: 7320 3d20 5b5b 2222 2c20 222f 225d 5d0a  s = [["", "/"]].
+0001a3e0: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
+0001a3f0: 7670 6174 683a 0a20 2020 2020 2020 2020  vpath:.         
+0001a400: 2020 2066 6f72 206e 6f64 6520 696e 2073     for node in s
+0001a410: 656c 662e 7670 6174 682e 7370 6c69 7428  elf.vpath.split(
+0001a420: 222f 2229 3a0a 2020 2020 2020 2020 2020  "/"):.          
+0001a430: 2020 2020 2020 6966 206e 6f74 2076 7061        if not vpa
+0001a440: 7468 3a0a 2020 2020 2020 2020 2020 2020  th:.            
+0001a450: 2020 2020 2020 2020 7670 6174 6820 3d20          vpath = 
+0001a460: 6e6f 6465 0a20 2020 2020 2020 2020 2020  node.           
+0001a470: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+0001a480: 2020 2020 2020 2020 2020 2020 2020 2076                 v
+0001a490: 7061 7468 202b 3d20 222f 2220 2b20 6e6f  path += "/" + no
+0001a4a0: 6465 0a0a 2020 2020 2020 2020 2020 2020  de..            
+0001a4b0: 2020 2020 7670 6e6f 6465 732e 6170 7065      vpnodes.appe
+0001a4c0: 6e64 285b 7175 6f74 6570 2876 7061 7468  nd([quotep(vpath
+0001a4d0: 2920 2b20 222f 222c 2068 746d 6c5f 6573  ) + "/", html_es
+0001a4e0: 6361 7065 286e 6f64 652c 2063 726c 663d  cape(node, crlf=
+0001a4f0: 5472 7565 295d 290a 0a20 2020 2020 2020  True)])..       
+0001a500: 2076 6e2c 2072 656d 203d 2073 656c 662e   vn, rem = self.
+0001a510: 6173 7276 2e76 6673 2e67 6574 2873 656c  asrv.vfs.get(sel
+0001a520: 662e 7670 6174 682c 2073 656c 662e 756e  f.vpath, self.un
+0001a530: 616d 652c 2046 616c 7365 2c20 4661 6c73  ame, False, Fals
+0001a540: 6529 0a20 2020 2020 2020 2061 6273 7061  e).        abspa
+0001a550: 7468 203d 2076 6e2e 6463 616e 6f6e 6963  th = vn.dcanonic
+0001a560: 616c 2872 656d 290a 2020 2020 2020 2020  al(rem).        
+0001a570: 6462 762c 2076 7265 6d20 3d20 766e 2e67  dbv, vrem = vn.g
+0001a580: 6574 5f64 6276 2872 656d 290a 0a20 2020  et_dbv(rem)..   
+0001a590: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
+0001a5a0: 2020 2020 2020 7374 203d 2062 6f73 2e73        st = bos.s
+0001a5b0: 7461 7428 6162 7370 6174 6829 0a20 2020  tat(abspath).   
+0001a5c0: 2020 2020 2065 7863 6570 743a 0a20 2020       except:.   
+0001a5d0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+0001a5e0: 7365 6c66 2e74 785f 3430 3428 290a 0a20  self.tx_404().. 
+0001a5f0: 2020 2020 2020 2069 6620 7265 6d2e 7374         if rem.st
+0001a600: 6172 7473 7769 7468 2822 2e68 6973 742f  artswith(".hist/
+0001a610: 7570 326b 2e22 2920 6f72 2028 0a20 2020  up2k.") or (.   
+0001a620: 2020 2020 2020 2020 2072 656d 2e65 6e64           rem.end
+0001a630: 7377 6974 6828 222f 6469 722e 7478 7422  swith("/dir.txt"
+0001a640: 2920 616e 6420 7265 6d2e 7374 6172 7473  ) and rem.starts
+0001a650: 7769 7468 2822 2e68 6973 742f 7468 2f22  with(".hist/th/"
+0001a660: 290a 2020 2020 2020 2020 293a 0a20 2020  ).        ):.   
+0001a670: 2020 2020 2020 2020 2072 6169 7365 2050           raise P
+0001a680: 6562 6b61 6328 3430 3329 0a0a 2020 2020  ebkac(403)..    
+0001a690: 2020 2020 6532 6420 3d20 2265 3264 2220      e2d = "e2d" 
+0001a6a0: 696e 2076 6e2e 666c 6167 730a 2020 2020  in vn.flags.    
+0001a6b0: 2020 2020 6532 7420 3d20 2265 3274 2220      e2t = "e2t" 
+0001a6c0: 696e 2076 6e2e 666c 6167 730a 0a20 2020  in vn.flags..   
+0001a6d0: 2020 2020 2073 656c 662e 6874 6d6c 5f68       self.html_h
+0001a6e0: 6561 6420 3d20 766e 2e66 6c61 6773 2e67  ead = vn.flags.g
+0001a6f0: 6574 2822 6874 6d6c 5f68 6561 6422 2c20  et("html_head", 
+0001a700: 2222 290a 2020 2020 2020 2020 6966 2076  "").        if v
+0001a710: 6e2e 666c 6167 732e 6765 7428 226e 6f72  n.flags.get("nor
+0001a720: 6f62 6f74 7322 2920 6f72 2022 6222 2069  obots") or "b" i
+0001a730: 6e20 7365 6c66 2e75 7061 7261 6d3a 0a20  n self.uparam:. 
+0001a740: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+0001a750: 6f75 745f 6865 6164 6572 735b 2258 2d52  out_headers["X-R
+0001a760: 6f62 6f74 732d 5461 6722 5d20 3d20 226e  obots-Tag"] = "n
+0001a770: 6f69 6e64 6578 2c20 6e6f 666f 6c6c 6f77  oindex, nofollow
+0001a780: 220a 2020 2020 2020 2020 656c 7365 3a0a  ".        else:.
+0001a790: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+0001a7a0: 2e6f 7574 5f68 6561 6465 7273 2e70 6f70  .out_headers.pop
+0001a7b0: 2822 582d 526f 626f 7473 2d54 6167 222c  ("X-Robots-Tag",
+0001a7c0: 204e 6f6e 6529 0a0a 2020 2020 2020 2020   None)..        
+0001a7d0: 6973 5f64 6972 203d 2073 7461 742e 535f  is_dir = stat.S_
+0001a7e0: 4953 4449 5228 7374 2e73 745f 6d6f 6465  ISDIR(st.st_mode
+0001a7f0: 290a 2020 2020 2020 2020 6963 7572 203d  ).        icur =
+0001a800: 204e 6f6e 650a 2020 2020 2020 2020 6966   None.        if
+0001a810: 2069 735f 6469 7220 616e 6420 2865 3274   is_dir and (e2t
+0001a820: 206f 7220 6532 6429 3a0a 2020 2020 2020   or e2d):.      
+0001a830: 2020 2020 2020 6964 7820 3d20 7365 6c66        idx = self
+0001a840: 2e63 6f6e 6e2e 6765 745f 7532 6964 7828  .conn.get_u2idx(
+0001a850: 290a 2020 2020 2020 2020 2020 2020 6966  ).            if
+0001a860: 2069 6478 2061 6e64 2068 6173 6174 7472   idx and hasattr
+0001a870: 2869 6478 2c20 2270 5f65 6e64 2229 3a0a  (idx, "p_end"):.
+0001a880: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a890: 6963 7572 203d 2069 6478 2e67 6574 5f63  icur = idx.get_c
+0001a8a0: 7572 2864 6276 2e72 6561 6c70 6174 6829  ur(dbv.realpath)
+0001a8b0: 0a0a 2020 2020 2020 2020 6966 2073 656c  ..        if sel
+0001a8c0: 662e 6361 6e5f 7265 6164 3a0a 2020 2020  f.can_read:.    
+0001a8d0: 2020 2020 2020 2020 7468 5f66 6d74 203d          th_fmt =
+0001a8e0: 2073 656c 662e 7570 6172 616d 2e67 6574   self.uparam.get
+0001a8f0: 2822 7468 2229 0a20 2020 2020 2020 2020  ("th").         
+0001a900: 2020 2069 6620 7468 5f66 6d74 2069 7320     if th_fmt is 
+0001a910: 6e6f 7420 4e6f 6e65 3a0a 2020 2020 2020  not None:.      
+0001a920: 2020 2020 2020 2020 2020 6966 2069 735f            if is_
+0001a930: 6469 723a 0a20 2020 2020 2020 2020 2020  dir:.           
+0001a940: 2020 2020 2020 2020 2076 7265 6d20 3d20           vrem = 
+0001a950: 7672 656d 2e72 7374 7269 7028 222f 2229  vrem.rstrip("/")
+0001a960: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001a970: 2020 2020 2069 6620 6963 7572 2061 6e64       if icur and
+0001a980: 2076 7265 6d3a 0a20 2020 2020 2020 2020   vrem:.         
+0001a990: 2020 2020 2020 2020 2020 2020 2020 2071                 q
+0001a9a0: 203d 2022 7365 6c65 6374 2066 6e20 6672   = "select fn fr
+0001a9b0: 6f6d 2063 7620 7768 6572 6520 7264 3d3f  om cv where rd=?
+0001a9c0: 2061 6e64 2064 6e3d 3f22 0a20 2020 2020   and dn=?".     
+0001a9d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a9e0: 2020 2063 7264 2c20 6364 6e20 3d20 7672     crd, cdn = vr
+0001a9f0: 656d 2e72 7370 6c69 7428 222f 222c 2031  em.rsplit("/", 1
+0001aa00: 2920 6966 2022 2f22 2069 6e20 7672 656d  ) if "/" in vrem
+0001aa10: 2065 6c73 6520 2822 222c 2076 7265 6d29   else ("", vrem)
+0001aa20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001aa30: 2020 2020 2020 2020 2023 206e 6f20 6d6f           # no mo
+0001aa40: 6a69 6261 6b65 2073 7570 706f 7274 3a0a  jibake support:.
 0001aa50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001aa60: 2020 2020 2020 2020 6966 2062 6f73 2e70          if bos.p
-0001aa70: 6174 682e 6578 6973 7473 2866 7029 3a0a  ath.exists(fp):.
-0001aa80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001aa90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001aaa0: 2020 2020 7672 656d 203d 2022 7b7d 2f7b      vrem = "{}/{
-0001aab0: 7d22 2e66 6f72 6d61 7428 7672 656d 2c20  }".format(vrem, 
-0001aac0: 666e 292e 7374 7269 7028 222f 2229 0a20  fn).strip("/"). 
-0001aad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001aa60: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
+0001aa70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001aa80: 2020 2020 2020 2020 2063 666e 203d 2069           cfn = i
+0001aa90: 6375 722e 6578 6563 7574 6528 712c 2028  cur.execute(q, (
+0001aaa0: 6372 642c 2063 646e 2929 2e66 6574 6368  crd, cdn)).fetch
+0001aab0: 6f6e 6528 290a 2020 2020 2020 2020 2020  one().          
+0001aac0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001aad0: 2020 6966 2063 666e 3a0a 2020 2020 2020    if cfn:.      
 0001aae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001aaf0: 2020 2069 735f 6469 7220 3d20 4661 6c73     is_dir = Fals
-0001ab00: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
-0001ab10: 2020 2020 2020 2020 2020 6578 6365 7074            except
-0001ab20: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0001ab30: 2020 2020 2020 2020 2020 2020 2020 7061                pa
-0001ab40: 7373 0a20 2020 2020 2020 2020 2020 2020  ss.             
-0001ab50: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-0001ab60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ab70: 2020 2020 2066 6f72 2066 6e20 696e 2073       for fn in s
-0001ab80: 656c 662e 6172 6773 2e74 685f 636f 7665  elf.args.th_cove
-0001ab90: 7273 3a0a 2020 2020 2020 2020 2020 2020  rs:.            
-0001aba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001abb0: 6670 203d 206f 732e 7061 7468 2e6a 6f69  fp = os.path.joi
-0001abc0: 6e28 6162 7370 6174 682c 2066 6e29 0a20  n(abspath, fn). 
+0001aaf0: 2020 2020 2020 2020 2020 666e 203d 2063            fn = c
+0001ab00: 666e 5b30 5d0a 2020 2020 2020 2020 2020  fn[0].          
+0001ab10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ab20: 2020 2020 2020 6670 203d 206f 732e 7061        fp = os.pa
+0001ab30: 7468 2e6a 6f69 6e28 6162 7370 6174 682c  th.join(abspath,
+0001ab40: 2066 6e29 0a20 2020 2020 2020 2020 2020   fn).           
+0001ab50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ab60: 2020 2020 2069 6620 626f 732e 7061 7468       if bos.path
+0001ab70: 2e65 7869 7374 7328 6670 293a 0a20 2020  .exists(fp):.   
+0001ab80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ab90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001aba0: 2076 7265 6d20 3d20 227b 7d2f 7b7d 222e   vrem = "{}/{}".
+0001abb0: 666f 726d 6174 2876 7265 6d2c 2066 6e29  format(vrem, fn)
+0001abc0: 2e73 7472 6970 2822 2f22 290a 2020 2020  .strip("/").    
 0001abd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001abe0: 2020 2020 2020 2020 2020 2069 6620 626f             if bo
-0001abf0: 732e 7061 7468 2e65 7869 7374 7328 6670  s.path.exists(fp
-0001ac00: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-0001ac10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ac20: 2020 2076 7265 6d20 3d20 227b 7d2f 7b7d     vrem = "{}/{}
-0001ac30: 222e 666f 726d 6174 2876 7265 6d2c 2066  ".format(vrem, f
-0001ac40: 6e29 2e73 7472 6970 2822 2f22 290a 2020  n).strip("/").  
-0001ac50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ac60: 2020 2020 2020 2020 2020 2020 2020 6973                is
-0001ac70: 5f64 6972 203d 2046 616c 7365 0a20 2020  _dir = False.   
-0001ac80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ac90: 2020 2020 2020 2020 2020 2020 2062 7265               bre
-0001aca0: 616b 0a0a 2020 2020 2020 2020 2020 2020  ak..            
-0001acb0: 2020 2020 2020 2020 6966 2069 735f 6469          if is_di
-0001acc0: 723a 0a20 2020 2020 2020 2020 2020 2020  r:.             
-0001acd0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-0001ace0: 6e20 7365 6c66 2e74 785f 6963 6f28 2261  n self.tx_ico("a
-0001acf0: 2e66 6f6c 6465 7222 290a 0a20 2020 2020  .folder")..     
-0001ad00: 2020 2020 2020 2020 2020 2074 6870 203d             thp =
-0001ad10: 204e 6f6e 650a 2020 2020 2020 2020 2020   None.          
-0001ad20: 2020 2020 2020 6966 2073 656c 662e 7468        if self.th
-0001ad30: 756d 6263 6c69 3a0a 2020 2020 2020 2020  umbcli:.        
-0001ad40: 2020 2020 2020 2020 2020 2020 7468 7020              thp 
-0001ad50: 3d20 7365 6c66 2e74 6875 6d62 636c 692e  = self.thumbcli.
-0001ad60: 6765 7428 6462 762c 2076 7265 6d2c 2069  get(dbv, vrem, i
-0001ad70: 6e74 2873 742e 7374 5f6d 7469 6d65 292c  nt(st.st_mtime),
-0001ad80: 2074 685f 666d 7429 0a0a 2020 2020 2020   th_fmt)..      
-0001ad90: 2020 2020 2020 2020 2020 6966 2074 6870            if thp
-0001ada0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0001adb0: 2020 2020 2020 7265 7475 726e 2073 656c        return sel
-0001adc0: 662e 7478 5f66 696c 6528 7468 7029 0a0a  f.tx_file(thp)..
-0001add0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ade0: 6966 2074 685f 666d 7420 3d3d 2022 7022  if th_fmt == "p"
-0001adf0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0001ae00: 2020 2020 2020 7261 6973 6520 5065 626b        raise Pebk
-0001ae10: 6163 2834 3034 290a 0a20 2020 2020 2020  ac(404)..       
-0001ae20: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-0001ae30: 7365 6c66 2e74 785f 6963 6f28 7265 6d29  self.tx_ico(rem)
-0001ae40: 0a0a 2020 2020 2020 2020 6966 206e 6f74  ..        if not
-0001ae50: 2069 735f 6469 7220 616e 6420 2873 656c   is_dir and (sel
-0001ae60: 662e 6361 6e5f 7265 6164 206f 7220 7365  f.can_read or se
-0001ae70: 6c66 2e63 616e 5f67 6574 293a 0a20 2020  lf.can_get):.   
-0001ae80: 2020 2020 2020 2020 2069 6620 6e6f 7420           if not 
-0001ae90: 7365 6c66 2e63 616e 5f72 6561 6420 616e  self.can_read an
-0001aea0: 6420 2266 6b22 2069 6e20 766e 2e66 6c61  d "fk" in vn.fla
-0001aeb0: 6773 3a0a 2020 2020 2020 2020 2020 2020  gs:.            
-0001aec0: 2020 2020 636f 7272 6563 7420 3d20 7365      correct = se
-0001aed0: 6c66 2e67 656e 5f66 6b28 0a20 2020 2020  lf.gen_fk(.     
-0001aee0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-0001aef0: 656c 662e 6172 6773 2e66 6b5f 7361 6c74  elf.args.fk_salt
-0001af00: 2c20 6162 7370 6174 682c 2073 742e 7374  , abspath, st.st
-0001af10: 5f73 697a 652c 2030 2069 6620 414e 5957  _size, 0 if ANYW
-0001af20: 494e 2065 6c73 6520 7374 2e73 745f 696e  IN else st.st_in
-0001af30: 6f0a 2020 2020 2020 2020 2020 2020 2020  o.              
-0001af40: 2020 295b 3a20 766e 2e66 6c61 6773 5b22    )[: vn.flags["
-0001af50: 666b 225d 5d0a 2020 2020 2020 2020 2020  fk"]].          
-0001af60: 2020 2020 2020 676f 7420 3d20 7365 6c66        got = self
-0001af70: 2e75 7061 7261 6d2e 6765 7428 226b 2229  .uparam.get("k")
-0001af80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001af90: 2069 6620 676f 7420 213d 2063 6f72 7265   if got != corre
-0001afa0: 6374 3a0a 2020 2020 2020 2020 2020 2020  ct:.            
-0001afb0: 2020 2020 2020 2020 7365 6c66 2e6c 6f67          self.log
-0001afc0: 2822 7772 6f6e 6720 6669 6c65 6b65 792c  ("wrong filekey,
-0001afd0: 2077 616e 7420 7b7d 2c20 676f 7420 7b7d   want {}, got {}
-0001afe0: 222e 666f 726d 6174 2863 6f72 7265 6374  ".format(correct
-0001aff0: 2c20 676f 7429 290a 2020 2020 2020 2020  , got)).        
-0001b000: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-0001b010: 726e 2073 656c 662e 7478 5f34 3034 2829  rn self.tx_404()
-0001b020: 0a0a 2020 2020 2020 2020 2020 2020 6966  ..            if
-0001b030: 2061 6273 7061 7468 2e65 6e64 7377 6974   abspath.endswit
-0001b040: 6828 222e 6d64 2229 2061 6e64 2028 0a20  h(".md") and (. 
-0001b050: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-0001b060: 7622 2069 6e20 7365 6c66 2e75 7061 7261  v" in self.upara
-0001b070: 6d20 6f72 2022 6564 6974 2220 696e 2073  m or "edit" in s
-0001b080: 656c 662e 7570 6172 616d 206f 7220 2265  elf.uparam or "e
-0001b090: 6469 7432 2220 696e 2073 656c 662e 7570  dit2" in self.up
-0001b0a0: 6172 616d 0a20 2020 2020 2020 2020 2020  aram.           
-0001b0b0: 2029 3a0a 2020 2020 2020 2020 2020 2020   ):.            
-0001b0c0: 2020 2020 7265 7475 726e 2073 656c 662e      return self.
-0001b0d0: 7478 5f6d 6428 6162 7370 6174 6829 0a0a  tx_md(abspath)..
-0001b0e0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-0001b0f0: 726e 2073 656c 662e 7478 5f66 696c 6528  rn self.tx_file(
-0001b100: 6162 7370 6174 6829 0a0a 2020 2020 2020  abspath)..      
-0001b110: 2020 656c 6966 2069 735f 6469 7220 616e    elif is_dir an
-0001b120: 6420 6e6f 7420 7365 6c66 2e63 616e 5f72  d not self.can_r
-0001b130: 6561 6420 616e 6420 6e6f 7420 7365 6c66  ead and not self
-0001b140: 2e63 616e 5f77 7269 7465 3a0a 2020 2020  .can_write:.    
-0001b150: 2020 2020 2020 2020 7265 7475 726e 2073          return s
-0001b160: 656c 662e 7478 5f34 3034 2854 7275 6529  elf.tx_404(True)
-0001b170: 0a0a 2020 2020 2020 2020 7372 765f 696e  ..        srv_in
-0001b180: 666f 203d 205b 5d0a 0a20 2020 2020 2020  fo = []..       
-0001b190: 2074 7279 3a0a 2020 2020 2020 2020 2020   try:.          
-0001b1a0: 2020 6966 206e 6f74 2073 656c 662e 6172    if not self.ar
-0001b1b0: 6773 2e6e 6968 3a0a 2020 2020 2020 2020  gs.nih:.        
-0001b1c0: 2020 2020 2020 2020 7372 765f 696e 666f          srv_info
-0001b1d0: 2e61 7070 656e 6428 7365 6c66 2e61 7267  .append(self.arg
-0001b1e0: 732e 6e61 6d65 290a 2020 2020 2020 2020  s.name).        
-0001b1f0: 6578 6365 7074 3a0a 2020 2020 2020 2020  except:.        
-0001b200: 2020 2020 7365 6c66 2e6c 6f67 2822 2377      self.log("#w
-0001b210: 6f77 2023 7768 6f61 2229 0a0a 2020 2020  ow #whoa")..    
-0001b220: 2020 2020 6966 206e 6f74 2073 656c 662e      if not self.
-0001b230: 6172 6773 2e6e 6964 3a0a 2020 2020 2020  args.nid:.      
-0001b240: 2020 2020 2020 6672 6565 2c20 746f 7461        free, tota
-0001b250: 6c20 3d20 6765 745f 6466 2861 6273 7061  l = get_df(abspa
-0001b260: 7468 290a 2020 2020 2020 2020 2020 2020  th).            
-0001b270: 6966 2074 6f74 616c 2069 7320 6e6f 7420  if total is not 
-0001b280: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
-0001b290: 2020 2020 2020 6831 203d 2068 756d 616e        h1 = human
-0001b2a0: 7369 7a65 2866 7265 6520 6f72 2030 290a  size(free or 0).
-0001b2b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b2c0: 6832 203d 2068 756d 616e 7369 7a65 2874  h2 = humansize(t
-0001b2d0: 6f74 616c 290a 2020 2020 2020 2020 2020  otal).          
-0001b2e0: 2020 2020 2020 7372 765f 696e 666f 2e61        srv_info.a
-0001b2f0: 7070 656e 6428 227b 7d20 6672 6565 206f  ppend("{} free o
-0001b300: 6620 7b7d 222e 666f 726d 6174 2868 312c  f {}".format(h1,
-0001b310: 2068 3229 290a 2020 2020 2020 2020 2020   h2)).          
-0001b320: 2020 656c 6966 2066 7265 6520 6973 206e    elif free is n
-0001b330: 6f74 204e 6f6e 653a 0a20 2020 2020 2020  ot None:.       
-0001b340: 2020 2020 2020 2020 2073 7276 5f69 6e66           srv_inf
-0001b350: 6f2e 6170 7065 6e64 2868 756d 616e 7369  o.append(humansi
-0001b360: 7a65 2866 7265 652c 2054 7275 6529 202b  ze(free, True) +
-0001b370: 2022 2066 7265 6522 290a 0a20 2020 2020   " free")..     
-0001b380: 2020 2073 7276 5f69 6e66 6f74 203d 2022     srv_infot = "
-0001b390: 3c2f 7370 616e 3e20 2f2f 203c 7370 616e  </span> // <span
-0001b3a0: 3e22 2e6a 6f69 6e28 7372 765f 696e 666f  >".join(srv_info
-0001b3b0: 290a 0a20 2020 2020 2020 2070 6572 6d73  )..        perms
-0001b3c0: 203d 205b 5d0a 2020 2020 2020 2020 6966   = [].        if
-0001b3d0: 2073 656c 662e 6361 6e5f 7265 6164 3a0a   self.can_read:.
-0001b3e0: 2020 2020 2020 2020 2020 2020 7065 726d              perm
-0001b3f0: 732e 6170 7065 6e64 2822 7265 6164 2229  s.append("read")
-0001b400: 0a20 2020 2020 2020 2069 6620 7365 6c66  .        if self
-0001b410: 2e63 616e 5f77 7269 7465 3a0a 2020 2020  .can_write:.    
-0001b420: 2020 2020 2020 2020 7065 726d 732e 6170          perms.ap
-0001b430: 7065 6e64 2822 7772 6974 6522 290a 2020  pend("write").  
-0001b440: 2020 2020 2020 6966 2073 656c 662e 6361        if self.ca
-0001b450: 6e5f 6d6f 7665 3a0a 2020 2020 2020 2020  n_move:.        
-0001b460: 2020 2020 7065 726d 732e 6170 7065 6e64      perms.append
-0001b470: 2822 6d6f 7665 2229 0a20 2020 2020 2020  ("move").       
-0001b480: 2069 6620 7365 6c66 2e63 616e 5f64 656c   if self.can_del
-0001b490: 6574 653a 0a20 2020 2020 2020 2020 2020  ete:.           
-0001b4a0: 2070 6572 6d73 2e61 7070 656e 6428 2264   perms.append("d
-0001b4b0: 656c 6574 6522 290a 2020 2020 2020 2020  elete").        
-0001b4c0: 6966 2073 656c 662e 6361 6e5f 6765 743a  if self.can_get:
-0001b4d0: 0a20 2020 2020 2020 2020 2020 2070 6572  .            per
-0001b4e0: 6d73 2e61 7070 656e 6428 2267 6574 2229  ms.append("get")
-0001b4f0: 0a20 2020 2020 2020 2069 6620 7365 6c66  .        if self
-0001b500: 2e63 616e 5f75 7067 6574 3a0a 2020 2020  .can_upget:.    
-0001b510: 2020 2020 2020 2020 7065 726d 732e 6170          perms.ap
-0001b520: 7065 6e64 2822 7570 6765 7422 290a 0a20  pend("upget").. 
-0001b530: 2020 2020 2020 2075 726c 5f73 7566 203d         url_suf =
-0001b540: 2073 656c 662e 7572 6c71 287b 7d2c 205b   self.urlq({}, [
-0001b550: 226b 225d 290a 2020 2020 2020 2020 6973  "k"]).        is
-0001b560: 5f6c 7320 3d20 226c 7322 2069 6e20 7365  _ls = "ls" in se
-0001b570: 6c66 2e75 7061 7261 6d0a 2020 2020 2020  lf.uparam.      
-0001b580: 2020 6973 5f6a 7320 3d20 7365 6c66 2e61    is_js = self.a
-0001b590: 7267 732e 666f 7263 655f 6a73 206f 7220  rgs.force_js or 
-0001b5a0: 7365 6c66 2e63 6f6f 6b69 6573 2e67 6574  self.cookies.get
-0001b5b0: 2822 6a73 2229 203d 3d20 2279 220a 0a20  ("js") == "y".. 
-0001b5c0: 2020 2020 2020 2069 6620 6e6f 7420 6973         if not is
-0001b5d0: 5f6c 7320 616e 6420 2873 656c 662e 7561  _ls and (self.ua
-0001b5e0: 2e73 7461 7274 7377 6974 6828 2263 7572  .startswith("cur
-0001b5f0: 6c2f 2229 206f 7220 7365 6c66 2e75 612e  l/") or self.ua.
-0001b600: 7374 6172 7473 7769 7468 2822 6665 7463  startswith("fetc
-0001b610: 6822 2929 3a0a 2020 2020 2020 2020 2020  h")):.          
-0001b620: 2020 7365 6c66 2e75 7061 7261 6d5b 226c    self.uparam["l
-0001b630: 7322 5d20 3d20 2276 220a 2020 2020 2020  s"] = "v".      
-0001b640: 2020 2020 2020 6973 5f6c 7320 3d20 5472        is_ls = Tr
-0001b650: 7565 0a0a 2020 2020 2020 2020 7470 6c20  ue..        tpl 
-0001b660: 3d20 2262 726f 7773 6572 220a 2020 2020  = "browser".    
-0001b670: 2020 2020 6966 2022 6222 2069 6e20 7365      if "b" in se
-0001b680: 6c66 2e75 7061 7261 6d3a 0a20 2020 2020  lf.uparam:.     
-0001b690: 2020 2020 2020 2074 706c 203d 2022 6272         tpl = "br
-0001b6a0: 6f77 7365 7232 220a 2020 2020 2020 2020  owser2".        
-0001b6b0: 2020 2020 6973 5f6a 7320 3d20 4661 6c73      is_js = Fals
-0001b6c0: 650a 0a20 2020 2020 2020 206c 6f67 7565  e..        logue
-0001b6d0: 7320 3d20 5b22 222c 2022 225d 0a20 2020  s = ["", ""].   
-0001b6e0: 2020 2020 2069 6620 6e6f 7420 7365 6c66       if not self
-0001b6f0: 2e61 7267 732e 6e6f 5f6c 6f67 7565 733a  .args.no_logues:
-0001b700: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
-0001b710: 206e 2c20 666e 2069 6e20 656e 756d 6572   n, fn in enumer
-0001b720: 6174 6528 5b22 2e70 726f 6c6f 6775 652e  ate([".prologue.
-0001b730: 6874 6d6c 222c 2022 2e65 7069 6c6f 6775  html", ".epilogu
-0001b740: 652e 6874 6d6c 225d 293a 0a20 2020 2020  e.html"]):.     
-0001b750: 2020 2020 2020 2020 2020 2066 6e20 3d20             fn = 
-0001b760: 6f73 2e70 6174 682e 6a6f 696e 2861 6273  os.path.join(abs
-0001b770: 7061 7468 2c20 666e 290a 2020 2020 2020  path, fn).      
-0001b780: 2020 2020 2020 2020 2020 6966 2062 6f73            if bos
-0001b790: 2e70 6174 682e 6578 6973 7473 2866 6e29  .path.exists(fn)
-0001b7a0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0001b7b0: 2020 2020 2020 7769 7468 206f 7065 6e28        with open(
-0001b7c0: 6673 656e 6328 666e 292c 2022 7262 2229  fsenc(fn), "rb")
-0001b7d0: 2061 7320 663a 0a20 2020 2020 2020 2020   as f:.         
-0001b7e0: 2020 2020 2020 2020 2020 2020 2020 206c                 l
-0001b7f0: 6f67 7565 735b 6e5d 203d 2066 2e72 6561  ogues[n] = f.rea
-0001b800: 6428 292e 6465 636f 6465 2822 7574 662d  d().decode("utf-
-0001b810: 3822 290a 0a20 2020 2020 2020 2072 6561  8")..        rea
-0001b820: 646d 6520 3d20 2222 0a20 2020 2020 2020  dme = "".       
-0001b830: 2069 6620 6e6f 7420 7365 6c66 2e61 7267   if not self.arg
-0001b840: 732e 6e6f 5f72 6561 646d 6520 616e 6420  s.no_readme and 
-0001b850: 6e6f 7420 6c6f 6775 6573 5b31 5d3a 0a20  not logues[1]:. 
-0001b860: 2020 2020 2020 2020 2020 2066 6f72 2066             for f
-0001b870: 6e20 696e 205b 2252 4541 444d 452e 6d64  n in ["README.md
-0001b880: 222c 2022 7265 6164 6d65 2e6d 6422 5d3a  ", "readme.md"]:
-0001b890: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001b8a0: 2066 6e20 3d20 6f73 2e70 6174 682e 6a6f   fn = os.path.jo
-0001b8b0: 696e 2861 6273 7061 7468 2c20 666e 290a  in(abspath, fn).
-0001b8c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b8d0: 6966 2062 6f73 2e70 6174 682e 6973 6669  if bos.path.isfi
-0001b8e0: 6c65 2866 6e29 3a0a 2020 2020 2020 2020  le(fn):.        
-0001b8f0: 2020 2020 2020 2020 2020 2020 7769 7468              with
-0001b900: 206f 7065 6e28 6673 656e 6328 666e 292c   open(fsenc(fn),
-0001b910: 2022 7262 2229 2061 7320 663a 0a20 2020   "rb") as f:.   
-0001b920: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b930: 2020 2020 2072 6561 646d 6520 3d20 662e       readme = f.
-0001b940: 7265 6164 2829 2e64 6563 6f64 6528 2275  read().decode("u
-0001b950: 7466 2d38 2229 0a20 2020 2020 2020 2020  tf-8").         
-0001b960: 2020 2020 2020 2020 2020 2020 2020 2062                 b
-0001b970: 7265 616b 0a0a 2020 2020 2020 2020 7666  reak..        vf
-0001b980: 203d 2076 6e2e 666c 6167 730a 2020 2020   = vn.flags.    
-0001b990: 2020 2020 6c73 5f72 6574 203d 207b 0a20      ls_ret = {. 
-0001b9a0: 2020 2020 2020 2020 2020 2022 6469 7273             "dirs
-0001b9b0: 223a 205b 5d2c 0a20 2020 2020 2020 2020  ": [],.         
-0001b9c0: 2020 2022 6669 6c65 7322 3a20 5b5d 2c0a     "files": [],.
-0001b9d0: 2020 2020 2020 2020 2020 2020 2274 6167              "tag
-0001b9e0: 6c69 7374 223a 205b 5d2c 0a20 2020 2020  list": [],.     
-0001b9f0: 2020 2020 2020 2022 7372 7669 6e66 223a         "srvinf":
-0001ba00: 2073 7276 5f69 6e66 6f74 2c0a 2020 2020   srv_infot,.    
-0001ba10: 2020 2020 2020 2020 2261 6363 7422 3a20          "acct": 
-0001ba20: 7365 6c66 2e75 6e61 6d65 2c0a 2020 2020  self.uname,.    
-0001ba30: 2020 2020 2020 2020 2269 6478 223a 2065          "idx": e
-0001ba40: 3264 2c0a 2020 2020 2020 2020 2020 2020  2d,.            
-0001ba50: 2269 7461 6722 3a20 6532 742c 0a20 2020  "itag": e2t,.   
-0001ba60: 2020 2020 2020 2020 2022 6c69 6665 7469           "lifeti
-0001ba70: 6d65 223a 2076 6e2e 666c 6167 732e 6765  me": vn.flags.ge
-0001ba80: 7428 226c 6966 6574 696d 6522 2920 6f72  t("lifetime") or
-0001ba90: 2030 2c0a 2020 2020 2020 2020 2020 2020   0,.            
-0001baa0: 2266 7261 6e64 223a 2062 6f6f 6c28 766e  "frand": bool(vn
-0001bab0: 2e66 6c61 6773 2e67 6574 2822 7261 6e64  .flags.get("rand
-0001bac0: 2229 292c 0a20 2020 2020 2020 2020 2020  ")),.           
-0001bad0: 2022 7065 726d 7322 3a20 7065 726d 732c   "perms": perms,
-0001bae0: 0a20 2020 2020 2020 2020 2020 2022 6c6f  .            "lo
-0001baf0: 6775 6573 223a 206c 6f67 7565 732c 0a20  gues": logues,. 
-0001bb00: 2020 2020 2020 2020 2020 2022 7265 6164             "read
-0001bb10: 6d65 223a 2072 6561 646d 652c 0a20 2020  me": readme,.   
-0001bb20: 2020 2020 207d 0a20 2020 2020 2020 206a       }.        j
-0001bb30: 3261 203d 207b 0a20 2020 2020 2020 2020  2a = {.         
-0001bb40: 2020 2022 7664 6972 223a 2071 756f 7465     "vdir": quote
-0001bb50: 7028 7365 6c66 2e76 7061 7468 292c 0a20  p(self.vpath),. 
-0001bb60: 2020 2020 2020 2020 2020 2022 7670 6e6f             "vpno
-0001bb70: 6465 7322 3a20 7670 6e6f 6465 732c 0a20  des": vpnodes,. 
-0001bb80: 2020 2020 2020 2020 2020 2022 6669 6c65             "file
-0001bb90: 7322 3a20 5b5d 2c0a 2020 2020 2020 2020  s": [],.        
-0001bba0: 2020 2020 226c 7330 223a 204e 6f6e 652c      "ls0": None,
-0001bbb0: 0a20 2020 2020 2020 2020 2020 2022 6163  .            "ac
-0001bbc0: 6374 223a 2073 656c 662e 756e 616d 652c  ct": self.uname,
-0001bbd0: 0a20 2020 2020 2020 2020 2020 2022 7065  .            "pe
-0001bbe0: 726d 7322 3a20 6a73 6f6e 2e64 756d 7073  rms": json.dumps
-0001bbf0: 2870 6572 6d73 292c 0a20 2020 2020 2020  (perms),.       
-0001bc00: 2020 2020 2022 6c69 6665 7469 6d65 223a       "lifetime":
-0001bc10: 206c 735f 7265 745b 226c 6966 6574 696d   ls_ret["lifetim
-0001bc20: 6522 5d2c 0a20 2020 2020 2020 2020 2020  e"],.           
-0001bc30: 2022 6672 616e 6422 3a20 626f 6f6c 2876   "frand": bool(v
-0001bc40: 6e2e 666c 6167 732e 6765 7428 2272 616e  n.flags.get("ran
-0001bc50: 6422 2929 2c0a 2020 2020 2020 2020 2020  d")),.          
-0001bc60: 2020 2274 6167 6c69 7374 223a 205b 5d2c    "taglist": [],
-0001bc70: 0a20 2020 2020 2020 2020 2020 2022 6465  .            "de
-0001bc80: 665f 6863 6f6c 7322 3a20 5b5d 2c0a 2020  f_hcols": [],.  
-0001bc90: 2020 2020 2020 2020 2020 2268 6176 655f            "have_
-0001bca0: 656d 7022 3a20 7365 6c66 2e61 7267 732e  emp": self.args.
-0001bcb0: 656d 702c 0a20 2020 2020 2020 2020 2020  emp,.           
-0001bcc0: 2022 6861 7665 5f75 7032 6b5f 6964 7822   "have_up2k_idx"
-0001bcd0: 3a20 6532 642c 0a20 2020 2020 2020 2020  : e2d,.         
-0001bce0: 2020 2022 6861 7665 5f74 6167 735f 6964     "have_tags_id
-0001bcf0: 7822 3a20 6532 742c 0a20 2020 2020 2020  x": e2t,.       
-0001bd00: 2020 2020 2022 6861 7665 5f61 636f 6465       "have_acode
-0001bd10: 223a 2028 6e6f 7420 7365 6c66 2e61 7267  ": (not self.arg
-0001bd20: 732e 6e6f 5f61 636f 6465 292c 0a20 2020  s.no_acode),.   
-0001bd30: 2020 2020 2020 2020 2022 6861 7665 5f6d           "have_m
-0001bd40: 7622 3a20 286e 6f74 2073 656c 662e 6172  v": (not self.ar
-0001bd50: 6773 2e6e 6f5f 6d76 292c 0a20 2020 2020  gs.no_mv),.     
-0001bd60: 2020 2020 2020 2022 6861 7665 5f64 656c         "have_del
-0001bd70: 223a 2028 6e6f 7420 7365 6c66 2e61 7267  ": (not self.arg
-0001bd80: 732e 6e6f 5f64 656c 292c 0a20 2020 2020  s.no_del),.     
-0001bd90: 2020 2020 2020 2022 6861 7665 5f7a 6970         "have_zip
-0001bda0: 223a 2028 6e6f 7420 7365 6c66 2e61 7267  ": (not self.arg
-0001bdb0: 732e 6e6f 5f7a 6970 292c 0a20 2020 2020  s.no_zip),.     
-0001bdc0: 2020 2020 2020 2022 6861 7665 5f75 6e70         "have_unp
-0001bdd0: 6f73 7422 3a20 696e 7428 7365 6c66 2e61  ost": int(self.a
-0001bde0: 7267 732e 756e 706f 7374 292c 0a20 2020  rgs.unpost),.   
-0001bdf0: 2020 2020 2020 2020 2022 6861 7665 5f62           "have_b
-0001be00: 5f75 223a 2028 7365 6c66 2e63 616e 5f77  _u": (self.can_w
-0001be10: 7269 7465 2061 6e64 2073 656c 662e 7570  rite and self.up
-0001be20: 6172 616d 2e67 6574 2822 6222 2920 3d3d  aram.get("b") ==
-0001be30: 2022 7522 292c 0a20 2020 2020 2020 2020   "u"),.         
-0001be40: 2020 2022 7362 5f6d 6422 3a20 2222 2069     "sb_md": "" i
-0001be50: 6620 226e 6f5f 7362 5f6d 6422 2069 6e20  f "no_sb_md" in 
-0001be60: 7666 2065 6c73 6520 2876 662e 6765 7428  vf else (vf.get(
-0001be70: 226d 645f 7362 6622 2920 6f72 2022 7922  "md_sbf") or "y"
-0001be80: 292c 0a20 2020 2020 2020 2020 2020 2022  ),.            "
-0001be90: 7362 5f6c 6722 3a20 2222 2069 6620 226e  sb_lg": "" if "n
-0001bea0: 6f5f 7362 5f6c 6722 2069 6e20 7666 2065  o_sb_lg" in vf e
-0001beb0: 6c73 6520 2876 662e 6765 7428 226c 675f  lse (vf.get("lg_
-0001bec0: 7362 6622 2920 6f72 2022 7922 292c 0a20  sbf") or "y"),. 
-0001bed0: 2020 2020 2020 2020 2020 2022 7572 6c5f             "url_
-0001bee0: 7375 6622 3a20 7572 6c5f 7375 662c 0a20  suf": url_suf,. 
-0001bef0: 2020 2020 2020 2020 2020 2022 6c6f 6775             "logu
-0001bf00: 6573 223a 206c 6f67 7565 732c 0a20 2020  es": logues,.   
-0001bf10: 2020 2020 2020 2020 2022 7265 6164 6d65           "readme
-0001bf20: 223a 2072 6561 646d 652c 0a20 2020 2020  ": readme,.     
-0001bf30: 2020 2020 2020 2022 7469 746c 6522 3a20         "title": 
-0001bf40: 6874 6d6c 5f65 7363 6170 6528 7365 6c66  html_escape(self
-0001bf50: 2e76 7061 7468 2c20 6372 6c66 3d54 7275  .vpath, crlf=Tru
-0001bf60: 6529 206f 7220 22f0 9f92 bef0 9f8e 8922  e) or "........"
-0001bf70: 2c0a 2020 2020 2020 2020 2020 2020 2273  ,.            "s
-0001bf80: 7276 5f69 6e66 6f22 3a20 7372 765f 696e  rv_info": srv_in
-0001bf90: 666f 742c 0a20 2020 2020 2020 2020 2020  fot,.           
-0001bfa0: 2022 6474 6865 6d65 223a 2073 656c 662e   "dtheme": self.
-0001bfb0: 6172 6773 2e74 6865 6d65 2c0a 2020 2020  args.theme,.    
-0001bfc0: 2020 2020 2020 2020 2274 6865 6d65 7322          "themes"
-0001bfd0: 3a20 7365 6c66 2e61 7267 732e 7468 656d  : self.args.them
-0001bfe0: 6573 2c0a 2020 2020 2020 2020 2020 2020  es,.            
-0001bff0: 2274 7572 626f 6c76 6c22 3a20 7365 6c66  "turbolvl": self
-0001c000: 2e61 7267 732e 7475 7262 6f2c 0a20 2020  .args.turbo,.   
-0001c010: 2020 2020 2020 2020 2022 6964 7868 223a           "idxh":
-0001c020: 2069 6e74 2873 656c 662e 6172 6773 2e69   int(self.args.i
-0001c030: 6829 2c0a 2020 2020 2020 2020 2020 2020  h),.            
-0001c040: 2275 3273 6f72 7422 3a20 7365 6c66 2e61  "u2sort": self.a
-0001c050: 7267 732e 7532 736f 7274 2c0a 2020 2020  rgs.u2sort,.    
-0001c060: 2020 2020 7d0a 0a20 2020 2020 2020 2069      }..        i
-0001c070: 6620 7365 6c66 2e61 7267 732e 6a73 5f62  f self.args.js_b
-0001c080: 726f 7773 6572 3a0a 2020 2020 2020 2020  rowser:.        
-0001c090: 2020 2020 6a32 615b 226a 7322 5d20 3d20      j2a["js"] = 
-0001c0a0: 7365 6c66 2e61 7267 732e 6a73 5f62 726f  self.args.js_bro
-0001c0b0: 7773 6572 0a0a 2020 2020 2020 2020 6966  wser..        if
-0001c0c0: 2073 656c 662e 6172 6773 2e63 7373 5f62   self.args.css_b
-0001c0d0: 726f 7773 6572 3a0a 2020 2020 2020 2020  rowser:.        
-0001c0e0: 2020 2020 6a32 615b 2263 7373 225d 203d      j2a["css"] =
-0001c0f0: 2073 656c 662e 6172 6773 2e63 7373 5f62   self.args.css_b
-0001c100: 726f 7773 6572 0a0a 2020 2020 2020 2020  rowser..        
-0001c110: 6966 206e 6f74 2073 656c 662e 636f 6e6e  if not self.conn
-0001c120: 2e68 7372 762e 7072 6973 6d3a 0a20 2020  .hsrv.prism:.   
-0001c130: 2020 2020 2020 2020 206a 3261 5b22 6e6f           j2a["no
-0001c140: 5f70 7269 736d 225d 203d 2054 7275 650a  _prism"] = True.
-0001c150: 0a20 2020 2020 2020 2069 6620 6e6f 7420  .        if not 
-0001c160: 7365 6c66 2e63 616e 5f72 6561 643a 0a20  self.can_read:. 
-0001c170: 2020 2020 2020 2020 2020 2069 6620 6973             if is
-0001c180: 5f6c 733a 0a20 2020 2020 2020 2020 2020  _ls:.           
-0001c190: 2020 2020 2072 6574 7572 6e20 7365 6c66       return self
-0001c1a0: 2e74 785f 6c73 286c 735f 7265 7429 0a0a  .tx_ls(ls_ret)..
-0001c1b0: 2020 2020 2020 2020 2020 2020 6966 206e              if n
-0001c1c0: 6f74 2073 7461 742e 535f 4953 4449 5228  ot stat.S_ISDIR(
-0001c1d0: 7374 2e73 745f 6d6f 6465 293a 0a20 2020  st.st_mode):.   
-0001c1e0: 2020 2020 2020 2020 2020 2020 2072 6574               ret
-0001c1f0: 7572 6e20 7365 6c66 2e74 785f 3430 3428  urn self.tx_404(
-0001c200: 5472 7565 290a 0a20 2020 2020 2020 2020  True)..         
-0001c210: 2020 2069 6620 227a 6970 2220 696e 2073     if "zip" in s
-0001c220: 656c 662e 7570 6172 616d 206f 7220 2274  elf.uparam or "t
-0001c230: 6172 2220 696e 2073 656c 662e 7570 6172  ar" in self.upar
-0001c240: 616d 3a0a 2020 2020 2020 2020 2020 2020  am:.            
-0001c250: 2020 2020 7261 6973 6520 5065 626b 6163      raise Pebkac
-0001c260: 2834 3033 290a 0a20 2020 2020 2020 2020  (403)..         
-0001c270: 2020 2068 746d 6c20 3d20 7365 6c66 2e6a     html = self.j
-0001c280: 3273 2874 706c 2c20 2a2a 6a32 6129 0a20  2s(tpl, **j2a). 
-0001c290: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-0001c2a0: 7265 706c 7928 6874 6d6c 2e65 6e63 6f64  reply(html.encod
-0001c2b0: 6528 2275 7466 2d38 222c 2022 7265 706c  e("utf-8", "repl
-0001c2c0: 6163 6522 2929 0a20 2020 2020 2020 2020  ace")).         
-0001c2d0: 2020 2072 6574 7572 6e20 5472 7565 0a0a     return True..
-0001c2e0: 2020 2020 2020 2020 666f 7220 6b20 696e          for k in
-0001c2f0: 205b 227a 6970 222c 2022 7461 7222 5d3a   ["zip", "tar"]:
-0001c300: 0a20 2020 2020 2020 2020 2020 2076 203d  .            v =
-0001c310: 2073 656c 662e 7570 6172 616d 2e67 6574   self.uparam.get
-0001c320: 286b 290a 2020 2020 2020 2020 2020 2020  (k).            
-0001c330: 6966 2076 2069 7320 6e6f 7420 4e6f 6e65  if v is not None
-0001c340: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0001c350: 2020 7265 7475 726e 2073 656c 662e 7478    return self.tx
-0001c360: 5f7a 6970 286b 2c20 762c 2073 656c 662e  _zip(k, v, self.
-0001c370: 7670 6174 682c 2076 6e2c 2072 656d 2c20  vpath, vn, rem, 
-0001c380: 5b5d 2c20 7365 6c66 2e61 7267 732e 6564  [], self.args.ed
-0001c390: 290a 0a20 2020 2020 2020 2066 7372 6f6f  )..        fsroo
-0001c3a0: 742c 2076 6673 5f6c 732c 2076 6673 5f76  t, vfs_ls, vfs_v
-0001c3b0: 6972 7420 3d20 766e 2e6c 7328 0a20 2020  irt = vn.ls(.   
-0001c3c0: 2020 2020 2020 2020 2072 656d 2c0a 2020           rem,.  
-0001c3d0: 2020 2020 2020 2020 2020 7365 6c66 2e75            self.u
-0001c3e0: 6e61 6d65 2c0a 2020 2020 2020 2020 2020  name,.          
-0001c3f0: 2020 6e6f 7420 7365 6c66 2e61 7267 732e    not self.args.
-0001c400: 6e6f 5f73 6361 6e64 6972 2c0a 2020 2020  no_scandir,.    
-0001c410: 2020 2020 2020 2020 5b5b 5472 7565 2c20          [[True, 
-0001c420: 4661 6c73 655d 2c20 5b46 616c 7365 2c20  False], [False, 
-0001c430: 5472 7565 5d5d 2c0a 2020 2020 2020 2020  True]],.        
-0001c440: 2020 2020 6c73 7461 743d 226c 7422 2069      lstat="lt" i
-0001c450: 6e20 7365 6c66 2e75 7061 7261 6d2c 0a20  n self.uparam,. 
-0001c460: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-0001c470: 2073 7461 7473 203d 207b 6b3a 2076 2066   stats = {k: v f
-0001c480: 6f72 206b 2c20 7620 696e 2076 6673 5f6c  or k, v in vfs_l
-0001c490: 737d 0a20 2020 2020 2020 206c 735f 6e61  s}.        ls_na
-0001c4a0: 6d65 7320 3d20 5b78 5b30 5d20 666f 7220  mes = [x[0] for 
-0001c4b0: 7820 696e 2076 6673 5f6c 735d 0a20 2020  x in vfs_ls].   
-0001c4c0: 2020 2020 206c 735f 6e61 6d65 732e 6578       ls_names.ex
-0001c4d0: 7465 6e64 286c 6973 7428 7666 735f 7669  tend(list(vfs_vi
-0001c4e0: 7274 2e6b 6579 7328 2929 290a 0a20 2020  rt.keys()))..   
-0001c4f0: 2020 2020 2023 2063 6865 636b 2066 6f72       # check for
-0001c500: 206f 6c64 2076 6572 7369 6f6e 7320 6f66   old versions of
-0001c510: 2066 696c 6573 2c0a 2020 2020 2020 2020   files,.        
-0001c520: 2320 5b6e 756d 2d62 6163 6b75 7073 2c20  # [num-backups, 
-0001c530: 6d6f 7374 2d72 6563 656e 742c 2068 6973  most-recent, his
-0001c540: 742d 7061 7468 5d0a 2020 2020 2020 2020  t-path].        
-0001c550: 6869 7374 2020 2020 203d 207b 7d0a 2020  hist     = {}.  
-0001c560: 2020 2020 2020 6869 7374 6469 7220 3d20        histdir = 
-0001c570: 6f73 2e70 6174 682e 6a6f 696e 2866 7372  os.path.join(fsr
-0001c580: 6f6f 742c 2022 2e68 6973 7422 290a 2020  oot, ".hist").  
-0001c590: 2020 2020 2020 7074 6e20 3d20 7265 2e63        ptn = re.c
-0001c5a0: 6f6d 7069 6c65 2872 2228 2e2a 295c 2e28  ompile(r"(.*)\.(
-0001c5b0: 5b30 2d39 5d2b 5c2e 5b30 2d39 5d7b 337d  [0-9]+\.[0-9]{3}
-0001c5c0: 2928 5c2e 5b5e 5c2e 5d2b 2924 2229 0a20  )(\.[^\.]+)$"). 
-0001c5d0: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
-0001c5e0: 2020 2020 2020 2020 666f 7220 6866 6e20          for hfn 
-0001c5f0: 696e 2062 6f73 2e6c 6973 7464 6972 2868  in bos.listdir(h
-0001c600: 6973 7464 6972 293a 0a20 2020 2020 2020  istdir):.       
-0001c610: 2020 2020 2020 2020 206d 203d 2070 746e           m = ptn
-0001c620: 2e6d 6174 6368 2868 666e 290a 2020 2020  .match(hfn).    
-0001c630: 2020 2020 2020 2020 2020 2020 6966 206e              if n
-0001c640: 6f74 206d 3a0a 2020 2020 2020 2020 2020  ot m:.          
-0001c650: 2020 2020 2020 2020 2020 636f 6e74 696e            contin
-0001c660: 7565 0a0a 2020 2020 2020 2020 2020 2020  ue..            
-0001c670: 2020 2020 666e 203d 206d 2e67 726f 7570      fn = m.group
-0001c680: 2831 2920 2b20 6d2e 6772 6f75 7028 3329  (1) + m.group(3)
-0001c690: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001c6a0: 206e 2c20 7473 2c20 5f20 3d20 6869 7374   n, ts, _ = hist
-0001c6b0: 2e67 6574 2866 6e2c 2028 302c 2030 2c20  .get(fn, (0, 0, 
-0001c6c0: 2222 2929 0a20 2020 2020 2020 2020 2020  "")).           
-0001c6d0: 2020 2020 2068 6973 745b 666e 5d20 3d20       hist[fn] = 
-0001c6e0: 286e 202b 2031 2c20 6d61 7828 7473 2c20  (n + 1, max(ts, 
-0001c6f0: 666c 6f61 7428 6d2e 6772 6f75 7028 3229  float(m.group(2)
-0001c700: 2929 2c20 6866 6e29 0a20 2020 2020 2020  )), hfn).       
-0001c710: 2065 7863 6570 743a 0a20 2020 2020 2020   except:.       
-0001c720: 2020 2020 2070 6173 730a 0a20 2020 2020       pass..     
-0001c730: 2020 2023 2073 686f 7720 646f 7466 696c     # show dotfil
-0001c740: 6573 2069 6620 7065 726d 6974 7465 6420  es if permitted 
-0001c750: 616e 6420 7265 7175 6573 7465 640a 2020  and requested.  
-0001c760: 2020 2020 2020 6966 206e 6f74 2073 656c        if not sel
-0001c770: 662e 6172 6773 2e65 6420 6f72 2022 646f  f.args.ed or "do
-0001c780: 7473 2220 6e6f 7420 696e 2073 656c 662e  ts" not in self.
-0001c790: 7570 6172 616d 3a0a 2020 2020 2020 2020  uparam:.        
-0001c7a0: 2020 2020 6c73 5f6e 616d 6573 203d 2065      ls_names = e
-0001c7b0: 7863 6c75 6465 5f64 6f74 6669 6c65 7328  xclude_dotfiles(
-0001c7c0: 6c73 5f6e 616d 6573 290a 0a20 2020 2020  ls_names)..     
-0001c7d0: 2020 2061 6464 5f66 6b20 3d20 766e 2e66     add_fk = vn.f
-0001c7e0: 6c61 6773 2e67 6574 2822 666b 2229 0a0a  lags.get("fk")..
-0001c7f0: 2020 2020 2020 2020 6469 7273 203d 205b          dirs = [
-0001c800: 5d0a 2020 2020 2020 2020 6669 6c65 7320  ].        files 
-0001c810: 3d20 5b5d 0a20 2020 2020 2020 2066 6f72  = [].        for
-0001c820: 2066 6e20 696e 206c 735f 6e61 6d65 733a   fn in ls_names:
-0001c830: 0a20 2020 2020 2020 2020 2020 2062 6173  .            bas
-0001c840: 6520 3d20 2222 0a20 2020 2020 2020 2020  e = "".         
-0001c850: 2020 2068 7265 6620 3d20 666e 0a20 2020     href = fn.   
-0001c860: 2020 2020 2020 2020 2069 6620 6e6f 7420           if not 
-0001c870: 6973 5f6c 7320 616e 6420 6e6f 7420 6973  is_ls and not is
-0001c880: 5f6a 7320 616e 6420 6e6f 7420 7365 6c66  _js and not self
-0001c890: 2e74 7261 696c 696e 675f 736c 6173 6820  .trailing_slash 
-0001c8a0: 616e 6420 7670 6174 683a 0a20 2020 2020  and vpath:.     
-0001c8b0: 2020 2020 2020 2020 2020 2062 6173 6520             base 
-0001c8c0: 3d20 222f 2220 2b20 7670 6174 6820 2b20  = "/" + vpath + 
-0001c8d0: 222f 220a 2020 2020 2020 2020 2020 2020  "/".            
-0001c8e0: 2020 2020 6872 6566 203d 2062 6173 6520      href = base 
-0001c8f0: 2b20 666e 0a0a 2020 2020 2020 2020 2020  + fn..          
-0001c900: 2020 6966 2066 6e20 696e 2076 6673 5f76    if fn in vfs_v
-0001c910: 6972 743a 0a20 2020 2020 2020 2020 2020  irt:.           
-0001c920: 2020 2020 2066 7370 6174 6820 3d20 7666       fspath = vf
-0001c930: 735f 7669 7274 5b66 6e5d 2e72 6561 6c70  s_virt[fn].realp
-0001c940: 6174 680a 2020 2020 2020 2020 2020 2020  ath.            
-0001c950: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-0001c960: 2020 2020 2020 6673 7061 7468 203d 2066        fspath = f
-0001c970: 7372 6f6f 7420 2b20 222f 2220 2b20 666e  sroot + "/" + fn
-0001c980: 0a0a 2020 2020 2020 2020 2020 2020 7472  ..            tr
-0001c990: 793a 0a20 2020 2020 2020 2020 2020 2020  y:.             
-0001c9a0: 2020 206c 696e 6620 3d20 7374 6174 732e     linf = stats.
-0001c9b0: 6765 7428 666e 2920 6f72 2062 6f73 2e6c  get(fn) or bos.l
-0001c9c0: 7374 6174 2866 7370 6174 6829 0a20 2020  stat(fspath).   
-0001c9d0: 2020 2020 2020 2020 2020 2020 2069 6e66               inf
-0001c9e0: 203d 2062 6f73 2e73 7461 7428 6673 7061   = bos.stat(fspa
-0001c9f0: 7468 2920 6966 2073 7461 742e 535f 4953  th) if stat.S_IS
-0001ca00: 4c4e 4b28 6c69 6e66 2e73 745f 6d6f 6465  LNK(linf.st_mode
-0001ca10: 2920 656c 7365 206c 696e 660a 2020 2020  ) else linf.    
-0001ca20: 2020 2020 2020 2020 6578 6365 7074 3a0a          except:.
-0001ca30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ca40: 7365 6c66 2e6c 6f67 2822 6272 6f6b 656e  self.log("broken
-0001ca50: 2073 796d 6c69 6e6b 3a20 7b7d 222e 666f   symlink: {}".fo
-0001ca60: 726d 6174 2872 6570 7228 6673 7061 7468  rmat(repr(fspath
-0001ca70: 2929 290a 2020 2020 2020 2020 2020 2020  ))).            
-0001ca80: 2020 2020 636f 6e74 696e 7565 0a0a 2020      continue..  
-0001ca90: 2020 2020 2020 2020 2020 6973 5f64 6972            is_dir
-0001caa0: 203d 2073 7461 742e 535f 4953 4449 5228   = stat.S_ISDIR(
-0001cab0: 696e 662e 7374 5f6d 6f64 6529 0a20 2020  inf.st_mode).   
-0001cac0: 2020 2020 2020 2020 2069 6620 6973 5f64           if is_d
-0001cad0: 6972 3a0a 2020 2020 2020 2020 2020 2020  ir:.            
-0001cae0: 2020 2020 6872 6566 202b 3d20 222f 220a      href += "/".
-0001caf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001cb00: 6966 2073 656c 662e 6172 6773 2e6e 6f5f  if self.args.no_
-0001cb10: 7a69 703a 0a20 2020 2020 2020 2020 2020  zip:.           
-0001cb20: 2020 2020 2020 2020 206d 6172 6769 6e20           margin 
-0001cb30: 3d20 2244 4952 220a 2020 2020 2020 2020  = "DIR".        
-0001cb40: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-0001cb50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001cb60: 2020 6d61 7267 696e 203d 2027 3c61 2068    margin = '<a h
-0001cb70: 7265 663d 2225 733f 7a69 7022 2072 656c  ref="%s?zip" rel
-0001cb80: 3d22 6e6f 666f 6c6c 6f77 223e 7a69 703c  ="nofollow">zip<
-0001cb90: 2f61 3e27 2025 2028 7175 6f74 6570 2868  /a>' % (quotep(h
-0001cba0: 7265 6629 2c29 0a20 2020 2020 2020 2020  ref),).         
-0001cbb0: 2020 2065 6c69 6620 666e 2069 6e20 6869     elif fn in hi
-0001cbc0: 7374 3a0a 2020 2020 2020 2020 2020 2020  st:.            
-0001cbd0: 2020 2020 6d61 7267 696e 203d 2027 3c61      margin = '<a
-0001cbe0: 2068 7265 663d 2225 732e 6869 7374 2f25   href="%s.hist/%
-0001cbf0: 7322 3e23 2573 3c2f 613e 2720 2520 280a  s">#%s</a>' % (.
-0001cc00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001cc10: 2020 2020 6261 7365 2c0a 2020 2020 2020      base,.      
-0001cc20: 2020 2020 2020 2020 2020 2020 2020 6874                ht
-0001cc30: 6d6c 5f65 7363 6170 6528 6869 7374 5b66  ml_escape(hist[f
-0001cc40: 6e5d 5b32 5d2c 2071 756f 743d 5472 7565  n][2], quot=True
-0001cc50: 2c20 6372 6c66 3d54 7275 6529 2c0a 2020  , crlf=True),.  
-0001cc60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001cc70: 2020 6869 7374 5b66 6e5d 5b30 5d2c 0a20    hist[fn][0],. 
-0001cc80: 2020 2020 2020 2020 2020 2020 2020 2029                 )
-0001cc90: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
-0001cca0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-0001ccb0: 2020 206d 6172 6769 6e20 3d20 222d 220a     margin = "-".
-0001ccc0: 0a20 2020 2020 2020 2020 2020 2073 7a20  .            sz 
-0001ccd0: 3d20 696e 662e 7374 5f73 697a 650a 2020  = inf.st_size.  
-0001cce0: 2020 2020 2020 2020 2020 7a64 203d 2064            zd = d
-0001ccf0: 6174 6574 696d 652e 7574 6366 726f 6d74  atetime.utcfromt
-0001cd00: 696d 6573 7461 6d70 286c 696e 662e 7374  imestamp(linf.st
-0001cd10: 5f6d 7469 6d65 290a 2020 2020 2020 2020  _mtime).        
-0001cd20: 2020 2020 6474 203d 2022 2530 3464 2d25      dt = "%04d-%
-0001cd30: 3032 642d 2530 3264 2025 3032 643a 2530  02d-%02d %02d:%0
-0001cd40: 3264 3a25 3032 6422 2025 2028 0a20 2020  2d:%02d" % (.   
-0001cd50: 2020 2020 2020 2020 2020 2020 207a 642e               zd.
-0001cd60: 7965 6172 2c0a 2020 2020 2020 2020 2020  year,.          
-0001cd70: 2020 2020 2020 7a64 2e6d 6f6e 7468 2c0a        zd.month,.
-0001cd80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001cd90: 7a64 2e64 6179 2c0a 2020 2020 2020 2020  zd.day,.        
-0001cda0: 2020 2020 2020 2020 7a64 2e68 6f75 722c          zd.hour,
-0001cdb0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001cdc0: 207a 642e 6d69 6e75 7465 2c0a 2020 2020   zd.minute,.    
-0001cdd0: 2020 2020 2020 2020 2020 2020 7a64 2e73              zd.s
-0001cde0: 6563 6f6e 642c 0a20 2020 2020 2020 2020  econd,.         
-0001cdf0: 2020 2029 0a0a 2020 2020 2020 2020 2020     )..          
-0001ce00: 2020 7472 793a 0a20 2020 2020 2020 2020    try:.         
-0001ce10: 2020 2020 2020 2065 7874 203d 2022 2d2d         ext = "--
-0001ce20: 2d22 2069 6620 6973 5f64 6972 2065 6c73  -" if is_dir els
-0001ce30: 6520 666e 2e72 7370 6c69 7428 222e 222c  e fn.rsplit(".",
-0001ce40: 2031 295b 315d 0a20 2020 2020 2020 2020   1)[1].         
-0001ce50: 2020 2020 2020 2069 6620 6c65 6e28 6578         if len(ex
-0001ce60: 7429 203e 2031 363a 0a20 2020 2020 2020  t) > 16:.       
-0001ce70: 2020 2020 2020 2020 2020 2020 2065 7874               ext
-0001ce80: 203d 2065 7874 5b3a 3136 5d0a 2020 2020   = ext[:16].    
-0001ce90: 2020 2020 2020 2020 6578 6365 7074 3a0a          except:.
-0001cea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ceb0: 6578 7420 3d20 2225 220a 0a20 2020 2020  ext = "%"..     
-0001cec0: 2020 2020 2020 2069 6620 6164 645f 666b         if add_fk
-0001ced0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0001cee0: 2020 6872 6566 203d 2022 2573 3f6b 3d25    href = "%s?k=%
-0001cef0: 7322 2025 2028 0a20 2020 2020 2020 2020  s" % (.         
-0001cf00: 2020 2020 2020 2020 2020 2071 756f 7465             quote
-0001cf10: 7028 6872 6566 292c 0a20 2020 2020 2020  p(href),.       
-0001cf20: 2020 2020 2020 2020 2020 2020 2073 656c               sel
-0001cf30: 662e 6765 6e5f 666b 280a 2020 2020 2020  f.gen_fk(.      
-0001cf40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001cf50: 2020 7365 6c66 2e61 7267 732e 666b 5f73    self.args.fk_s
-0001cf60: 616c 742c 2066 7370 6174 682c 2073 7a2c  alt, fspath, sz,
-0001cf70: 2030 2069 6620 414e 5957 494e 2065 6c73   0 if ANYWIN els
-0001cf80: 6520 696e 662e 7374 5f69 6e6f 0a20 2020  e inf.st_ino.   
-0001cf90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001cfa0: 2029 5b3a 6164 645f 666b 5d2c 0a20 2020   )[:add_fk],.   
-0001cfb0: 2020 2020 2020 2020 2020 2020 2029 0a20               ). 
-0001cfc0: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
-0001cfd0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001cfe0: 2068 7265 6620 3d20 7175 6f74 6570 2868   href = quotep(h
-0001cff0: 7265 6629 0a0a 2020 2020 2020 2020 2020  ref)..          
-0001d000: 2020 6974 656d 203d 207b 0a20 2020 2020    item = {.     
-0001d010: 2020 2020 2020 2020 2020 2022 6c65 6164             "lead
-0001d020: 223a 206d 6172 6769 6e2c 0a20 2020 2020  ": margin,.     
-0001d030: 2020 2020 2020 2020 2020 2022 6872 6566             "href
-0001d040: 223a 2068 7265 662c 0a20 2020 2020 2020  ": href,.       
-0001d050: 2020 2020 2020 2020 2022 6e61 6d65 223a           "name":
-0001d060: 2066 6e2c 0a20 2020 2020 2020 2020 2020   fn,.           
-0001d070: 2020 2020 2022 737a 223a 2073 7a2c 0a20       "sz": sz,. 
-0001d080: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-0001d090: 6578 7422 3a20 6578 742c 0a20 2020 2020  ext": ext,.     
-0001d0a0: 2020 2020 2020 2020 2020 2022 6474 223a             "dt":
-0001d0b0: 2064 742c 0a20 2020 2020 2020 2020 2020   dt,.           
-0001d0c0: 2020 2020 2022 7473 223a 2069 6e74 286c       "ts": int(l
-0001d0d0: 696e 662e 7374 5f6d 7469 6d65 292c 0a20  inf.st_mtime),. 
-0001d0e0: 2020 2020 2020 2020 2020 207d 0a20 2020             }.   
-0001d0f0: 2020 2020 2020 2020 2069 6620 6973 5f64           if is_d
-0001d100: 6972 3a0a 2020 2020 2020 2020 2020 2020  ir:.            
-0001d110: 2020 2020 6469 7273 2e61 7070 656e 6428      dirs.append(
-0001d120: 6974 656d 290a 2020 2020 2020 2020 2020  item).          
-0001d130: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-0001d140: 2020 2020 2020 2020 6669 6c65 732e 6170          files.ap
-0001d150: 7065 6e64 2869 7465 6d29 0a20 2020 2020  pend(item).     
-0001d160: 2020 2020 2020 2020 2020 2069 7465 6d5b             item[
-0001d170: 2272 6422 5d20 3d20 7265 6d0a 0a20 2020  "rd"] = rem..   
-0001d180: 2020 2020 2069 6620 280a 2020 2020 2020       if (.      
-0001d190: 2020 2020 2020 7365 6c66 2e63 6f6f 6b69        self.cooki
-0001d1a0: 6573 2e67 6574 2822 6964 7868 2229 203d  es.get("idxh") =
-0001d1b0: 3d20 2279 220a 2020 2020 2020 2020 2020  = "y".          
-0001d1c0: 2020 616e 6420 226c 7322 206e 6f74 2069    and "ls" not i
-0001d1d0: 6e20 7365 6c66 2e75 7061 7261 6d0a 2020  n self.uparam.  
-0001d1e0: 2020 2020 2020 2020 2020 616e 6420 2276            and "v
-0001d1f0: 2220 6e6f 7420 696e 2073 656c 662e 7570  " not in self.up
-0001d200: 6172 616d 0a20 2020 2020 2020 2029 3a0a  aram.        ):.
-0001d210: 2020 2020 2020 2020 2020 2020 6964 785f              idx_
-0001d220: 6874 6d6c 203d 2073 6574 285b 2269 6e64  html = set(["ind
-0001d230: 6578 2e68 746d 222c 2022 696e 6465 782e  ex.htm", "index.
-0001d240: 6874 6d6c 225d 290a 2020 2020 2020 2020  html"]).        
-0001d250: 2020 2020 666f 7220 6974 656d 2069 6e20      for item in 
-0001d260: 6669 6c65 733a 0a20 2020 2020 2020 2020  files:.         
-0001d270: 2020 2020 2020 2069 6620 6974 656d 5b22         if item["
-0001d280: 6e61 6d65 225d 2069 6e20 6964 785f 6874  name"] in idx_ht
-0001d290: 6d6c 3a0a 2020 2020 2020 2020 2020 2020  ml:.            
-0001d2a0: 2020 2020 2020 2020 2320 646f 2066 756c          # do ful
-0001d2b0: 6c20 7265 736f 6c76 6520 696e 2063 6173  l resolve in cas
-0001d2c0: 6520 6f66 2073 6861 646f 7765 6420 6669  e of shadowed fi
-0001d2d0: 6c65 0a20 2020 2020 2020 2020 2020 2020  le.             
-0001d2e0: 2020 2020 2020 2076 7020 3d20 766a 6f69         vp = vjoi
-0001d2f0: 6e28 7365 6c66 2e76 7061 7468 2e73 706c  n(self.vpath.spl
-0001d300: 6974 2822 3f22 295b 305d 2c20 6974 656d  it("?")[0], item
-0001d310: 5b22 6e61 6d65 225d 290a 2020 2020 2020  ["name"]).      
-0001d320: 2020 2020 2020 2020 2020 2020 2020 766e                vn
-0001d330: 2c20 7265 6d20 3d20 7365 6c66 2e61 7372  , rem = self.asr
-0001d340: 762e 7666 732e 6765 7428 7670 2c20 7365  v.vfs.get(vp, se
-0001d350: 6c66 2e75 6e61 6d65 2c20 5472 7565 2c20  lf.uname, True, 
-0001d360: 4661 6c73 6529 0a20 2020 2020 2020 2020  False).         
-0001d370: 2020 2020 2020 2020 2020 2061 7020 3d20             ap = 
-0001d380: 766e 2e63 616e 6f6e 6963 616c 2872 656d  vn.canonical(rem
-0001d390: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-0001d3a0: 2020 2020 2020 7265 7475 726e 2073 656c        return sel
-0001d3b0: 662e 7478 5f66 696c 6528 6170 2920 2023  f.tx_file(ap)  #
-0001d3c0: 2069 7320 6e6f 2d63 6163 6865 0a0a 2020   is no-cache..  
-0001d3d0: 2020 2020 2020 7461 6773 6574 2020 3d20        tagset  = 
-0001d3e0: 7365 7428 290a 2020 2020 2020 2020 666f  set().        fo
-0001d3f0: 7220 6665 2069 6e20 6669 6c65 733a 0a20  r fe in files:. 
-0001d400: 2020 2020 2020 2020 2020 2066 6e20 3d20             fn = 
-0001d410: 6665 5b22 6e61 6d65 225d 0a20 2020 2020  fe["name"].     
-0001d420: 2020 2020 2020 2072 6420 3d20 6665 5b22         rd = fe["
-0001d430: 7264 225d 0a20 2020 2020 2020 2020 2020  rd"].           
-0001d440: 2064 656c 2066 655b 2272 6422 5d0a 2020   del fe["rd"].  
-0001d450: 2020 2020 2020 2020 2020 6966 206e 6f74            if not
-0001d460: 2069 6375 723a 0a20 2020 2020 2020 2020   icur:.         
-0001d470: 2020 2020 2020 2063 6f6e 7469 6e75 650a         continue.
-0001d480: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-0001d490: 766e 2021 3d20 6462 763a 0a20 2020 2020  vn != dbv:.     
-0001d4a0: 2020 2020 2020 2020 2020 205f 2c20 7264             _, rd
-0001d4b0: 203d 2076 6e2e 6765 745f 6462 7628 7264   = vn.get_dbv(rd
-0001d4c0: 290a 0a20 2020 2020 2020 2020 2020 2071  )..            q
-0001d4d0: 203d 2022 7365 6c65 6374 206d 742e 6b2c   = "select mt.k,
-0001d4e0: 206d 742e 7620 6672 6f6d 2075 7020 696e   mt.v from up in
-0001d4f0: 6e65 7220 6a6f 696e 206d 7420 6f6e 206d  ner join mt on m
-0001d500: 742e 7720 3d20 7375 6273 7472 2875 702e  t.w = substr(up.
-0001d510: 772c 312c 3136 2920 7768 6572 6520 7570  w,1,16) where up
-0001d520: 2e72 6420 3d20 3f20 616e 6420 7570 2e66  .rd = ? and up.f
-0001d530: 6e20 3d20 3f20 616e 6420 2b6d 742e 6b20  n = ? and +mt.k 
-0001d540: 213d 2027 7827 220a 2020 2020 2020 2020  != 'x'".        
-0001d550: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
-0001d560: 2020 2020 2020 2020 2072 203d 2069 6375           r = icu
-0001d570: 722e 6578 6563 7574 6528 712c 2028 7264  r.execute(q, (rd
-0001d580: 2c20 666e 2929 0a20 2020 2020 2020 2020  , fn)).         
-0001d590: 2020 2065 7863 6570 7420 4578 6365 7074     except Except
-0001d5a0: 696f 6e20 6173 2065 783a 0a20 2020 2020  ion as ex:.     
-0001d5b0: 2020 2020 2020 2020 2020 2069 6620 2264             if "d
-0001d5c0: 6174 6162 6173 6520 6973 206c 6f63 6b65  atabase is locke
-0001d5d0: 6422 2069 6e20 7374 7228 6578 293a 0a20  d" in str(ex):. 
-0001d5e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001d5f0: 2020 2062 7265 616b 0a0a 2020 2020 2020     break..      
-0001d600: 2020 2020 2020 2020 2020 7472 793a 0a20            try:. 
-0001d610: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001d620: 2020 2061 7267 7320 3d20 7333 656e 6328     args = s3enc(
-0001d630: 6964 782e 6d65 6d5f 6375 722c 2072 642c  idx.mem_cur, rd,
-0001d640: 2066 6e29 0a20 2020 2020 2020 2020 2020   fn).           
-0001d650: 2020 2020 2020 2020 2072 203d 2069 6375           r = icu
-0001d660: 722e 6578 6563 7574 6528 712c 2061 7267  r.execute(q, arg
-0001d670: 7329 0a20 2020 2020 2020 2020 2020 2020  s).             
-0001d680: 2020 2065 7863 6570 743a 0a20 2020 2020     except:.     
-0001d690: 2020 2020 2020 2020 2020 2020 2020 2074                 t
-0001d6a0: 203d 2022 7461 6720 7265 6164 2065 7272   = "tag read err
-0001d6b0: 6f72 2c20 7b7d 2f7b 7d5c 6e7b 7d22 0a20  or, {}/{}\n{}". 
-0001d6c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001d6d0: 2020 2073 656c 662e 6c6f 6728 742e 666f     self.log(t.fo
-0001d6e0: 726d 6174 2872 642c 2066 6e2c 206d 696e  rmat(rd, fn, min
-0001d6f0: 5f65 7828 2929 290a 2020 2020 2020 2020  _ex())).        
-0001d700: 2020 2020 2020 2020 2020 2020 6272 6561              brea
-0001d710: 6b0a 0a20 2020 2020 2020 2020 2020 2066  k..            f
-0001d720: 655b 2274 6167 7322 5d20 3d20 7b6b 3a20  e["tags"] = {k: 
-0001d730: 7620 666f 7220 6b2c 2076 2069 6e20 727d  v for k, v in r}
-0001d740: 0a20 2020 2020 2020 2020 2020 205f 203d  .            _ =
-0001d750: 205b 7461 6773 6574 2e61 6464 286b 2920   [tagset.add(k) 
-0001d760: 666f 7220 6b20 696e 2066 655b 2274 6167  for k in fe["tag
-0001d770: 7322 5d5d 0a0a 2020 2020 2020 2020 6966  s"]]..        if
-0001d780: 2069 6375 723a 0a20 2020 2020 2020 2020   icur:.         
-0001d790: 2020 2074 6167 6c69 7374 203d 205b 6b20     taglist = [k 
-0001d7a0: 666f 7220 6b20 696e 2076 6e2e 666c 6167  for k in vn.flag
-0001d7b0: 732e 6765 7428 226d 7465 222c 2022 2229  s.get("mte", "")
-0001d7c0: 2e73 706c 6974 2822 2c22 2920 6966 206b  .split(",") if k
-0001d7d0: 2069 6e20 7461 6773 6574 5d0a 2020 2020   in tagset].    
-0001d7e0: 2020 2020 2020 2020 666f 7220 6665 2069          for fe i
-0001d7f0: 6e20 6469 7273 3a0a 2020 2020 2020 2020  n dirs:.        
-0001d800: 2020 2020 2020 2020 6665 5b22 7461 6773          fe["tags
-0001d810: 225d 203d 207b 7d0a 2020 2020 2020 2020  "] = {}.        
-0001d820: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-0001d830: 2020 7461 676c 6973 7420 3d20 6c69 7374    taglist = list
-0001d840: 2874 6167 7365 7429 0a0a 2020 2020 2020  (tagset)..      
-0001d850: 2020 6966 2069 735f 6c73 3a0a 2020 2020    if is_ls:.    
-0001d860: 2020 2020 2020 2020 6c73 5f72 6574 5b22          ls_ret["
-0001d870: 6469 7273 225d 203d 2064 6972 730a 2020  dirs"] = dirs.  
-0001d880: 2020 2020 2020 2020 2020 6c73 5f72 6574            ls_ret
-0001d890: 5b22 6669 6c65 7322 5d20 3d20 6669 6c65  ["files"] = file
-0001d8a0: 730a 2020 2020 2020 2020 2020 2020 6c73  s.            ls
-0001d8b0: 5f72 6574 5b22 7461 676c 6973 7422 5d20  _ret["taglist"] 
-0001d8c0: 3d20 7461 676c 6973 740a 2020 2020 2020  = taglist.      
-0001d8d0: 2020 2020 2020 7265 7475 726e 2073 656c        return sel
-0001d8e0: 662e 7478 5f6c 7328 6c73 5f72 6574 290a  f.tx_ls(ls_ret).
-0001d8f0: 0a20 2020 2020 2020 2064 6f63 203d 2073  .        doc = s
-0001d900: 656c 662e 7570 6172 616d 2e67 6574 2822  elf.uparam.get("
-0001d910: 646f 6322 2920 6966 2073 656c 662e 6361  doc") if self.ca
-0001d920: 6e5f 7265 6164 2065 6c73 6520 4e6f 6e65  n_read else None
-0001d930: 0a20 2020 2020 2020 2069 6620 646f 633a  .        if doc:
-0001d940: 0a20 2020 2020 2020 2020 2020 2064 6f63  .            doc
-0001d950: 203d 2075 6e71 756f 7465 7028 646f 632e   = unquotep(doc.
-0001d960: 7265 706c 6163 6528 222b 222c 2022 2022  replace("+", " "
-0001d970: 292e 7370 6c69 7428 223f 2229 5b30 5d29  ).split("?")[0])
-0001d980: 0a20 2020 2020 2020 2020 2020 206a 3261  .            j2a
-0001d990: 5b22 646f 636e 616d 6522 5d20 3d20 646f  ["docname"] = do
-0001d9a0: 630a 2020 2020 2020 2020 2020 2020 646f  c.            do
-0001d9b0: 6374 7874 203d 204e 6f6e 650a 2020 2020  ctxt = None.    
-0001d9c0: 2020 2020 2020 2020 6966 206e 6578 7428          if next(
-0001d9d0: 2878 2066 6f72 2078 2069 6e20 6669 6c65  (x for x in file
-0001d9e0: 7320 6966 2078 5b22 6e61 6d65 225d 203d  s if x["name"] =
-0001d9f0: 3d20 646f 6329 2c20 4e6f 6e65 293a 0a20  = doc), None):. 
-0001da00: 2020 2020 2020 2020 2020 2020 2020 2064                 d
-0001da10: 6f63 7061 7468 203d 206f 732e 7061 7468  ocpath = os.path
-0001da20: 2e6a 6f69 6e28 6162 7370 6174 682c 2064  .join(abspath, d
-0001da30: 6f63 290a 2020 2020 2020 2020 2020 2020  oc).            
-0001da40: 2020 2020 737a 203d 2062 6f73 2e70 6174      sz = bos.pat
-0001da50: 682e 6765 7473 697a 6528 646f 6370 6174  h.getsize(docpat
-0001da60: 6829 0a20 2020 2020 2020 2020 2020 2020  h).             
-0001da70: 2020 2069 6620 737a 203c 2031 3032 3420     if sz < 1024 
-0001da80: 2a20 7365 6c66 2e61 7267 732e 7478 745f  * self.args.txt_
-0001da90: 6d61 783a 0a20 2020 2020 2020 2020 2020  max:.           
-0001daa0: 2020 2020 2020 2020 2077 6974 6820 6f70           with op
-0001dab0: 656e 2866 7365 6e63 2864 6f63 7061 7468  en(fsenc(docpath
-0001dac0: 292c 2022 7262 2229 2061 7320 663a 0a20  ), "rb") as f:. 
-0001dad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001dae0: 2020 2020 2020 2064 6f63 7478 7420 3d20         doctxt = 
-0001daf0: 662e 7265 6164 2829 2e64 6563 6f64 6528  f.read().decode(
-0001db00: 2275 7466 2d38 222c 2022 7265 706c 6163  "utf-8", "replac
-0001db10: 6522 290a 2020 2020 2020 2020 2020 2020  e").            
-0001db20: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-0001db30: 2020 2020 2020 7365 6c66 2e6c 6f67 2822        self.log("
-0001db40: 646f 6320 3430 343a 205b 7b7d 5d22 2e66  doc 404: [{}]".f
-0001db50: 6f72 6d61 7428 646f 6329 2c20 633d 3629  ormat(doc), c=6)
-0001db60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001db70: 2064 6f63 7478 7420 3d20 2228 2074 6578   doctxt = "( tex
-0001db80: 7466 696c 6520 6e6f 7420 666f 756e 6420  tfile not found 
-0001db90: 2922 0a0a 2020 2020 2020 2020 2020 2020  )"..            
-0001dba0: 6966 2064 6f63 7478 7420 6973 206e 6f74  if doctxt is not
-0001dbb0: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
-0001dbc0: 2020 2020 2020 206a 3261 5b22 646f 6322         j2a["doc"
-0001dbd0: 5d20 3d20 646f 6374 7874 0a0a 2020 2020  ] = doctxt..    
-0001dbe0: 2020 2020 666f 7220 6420 696e 2064 6972      for d in dir
-0001dbf0: 733a 0a20 2020 2020 2020 2020 2020 2064  s:.            d
-0001dc00: 5b22 6e61 6d65 225d 202b 3d20 222f 220a  ["name"] += "/".
-0001dc10: 0a20 2020 2020 2020 2064 6972 732e 736f  .        dirs.so
-0001dc20: 7274 286b 6579 3d69 7465 6d67 6574 7465  rt(key=itemgette
-0001dc30: 7228 226e 616d 6522 2929 0a0a 2020 2020  r("name"))..    
-0001dc40: 2020 2020 6966 2069 735f 6a73 3a0a 2020      if is_js:.  
-0001dc50: 2020 2020 2020 2020 2020 6a32 615b 226c            j2a["l
-0001dc60: 7330 225d 203d 207b 2264 6972 7322 3a20  s0"] = {"dirs": 
-0001dc70: 6469 7273 2c20 2266 696c 6573 223a 2066  dirs, "files": f
-0001dc80: 696c 6573 2c20 2274 6167 6c69 7374 223a  iles, "taglist":
-0001dc90: 2074 6167 6c69 7374 7d0a 2020 2020 2020   taglist}.      
-0001dca0: 2020 2020 2020 6a32 615b 2266 696c 6573        j2a["files
-0001dcb0: 225d 203d 205b 5d0a 2020 2020 2020 2020  "] = [].        
-0001dcc0: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-0001dcd0: 2020 6a32 615b 2266 696c 6573 225d 203d    j2a["files"] =
-0001dce0: 2064 6972 7320 2b20 6669 6c65 730a 0a20   dirs + files.. 
-0001dcf0: 2020 2020 2020 206a 3261 5b22 7461 676c         j2a["tagl
-0001dd00: 6973 7422 5d20 3d20 7461 676c 6973 740a  ist"] = taglist.
-0001dd10: 2020 2020 2020 2020 6a32 615b 2274 7874          j2a["txt
-0001dd20: 5f65 7874 225d 203d 2073 656c 662e 6172  _ext"] = self.ar
-0001dd30: 6773 2e74 6578 7466 696c 6573 2e72 6570  gs.textfiles.rep
-0001dd40: 6c61 6365 2822 2c22 2c20 2220 2229 0a0a  lace(",", " ")..
-0001dd50: 2020 2020 2020 2020 6966 2022 6d74 6822          if "mth"
-0001dd60: 2069 6e20 766e 2e66 6c61 6773 3a0a 2020   in vn.flags:.  
-0001dd70: 2020 2020 2020 2020 2020 6a32 615b 2264            j2a["d
-0001dd80: 6566 5f68 636f 6c73 225d 203d 2076 6e2e  ef_hcols"] = vn.
-0001dd90: 666c 6167 735b 226d 7468 225d 2e73 706c  flags["mth"].spl
-0001dda0: 6974 2822 2c22 290a 0a20 2020 2020 2020  it(",")..       
-0001ddb0: 2068 746d 6c20 3d20 7365 6c66 2e6a 3273   html = self.j2s
-0001ddc0: 2874 706c 2c20 2a2a 6a32 6129 0a20 2020  (tpl, **j2a).   
-0001ddd0: 2020 2020 2073 656c 662e 7265 706c 7928       self.reply(
-0001dde0: 6874 6d6c 2e65 6e63 6f64 6528 2275 7466  html.encode("utf
-0001ddf0: 2d38 222c 2022 7265 706c 6163 6522 2929  -8", "replace"))
-0001de00: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-0001de10: 5472 7565 0a                             True.
+0001abe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001abf0: 6973 5f64 6972 203d 2046 616c 7365 0a20  is_dir = False. 
+0001ac00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ac10: 2020 2020 2020 2065 7863 6570 743a 0a20         except:. 
+0001ac20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ac30: 2020 2020 2020 2020 2020 2070 6173 730a             pass.
+0001ac40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ac50: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+0001ac60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ac70: 2020 666f 7220 666e 2069 6e20 7365 6c66    for fn in self
+0001ac80: 2e61 7267 732e 7468 5f63 6f76 6572 733a  .args.th_covers:
+0001ac90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001aca0: 2020 2020 2020 2020 2020 2020 2066 7020               fp 
+0001acb0: 3d20 6f73 2e70 6174 682e 6a6f 696e 2861  = os.path.join(a
+0001acc0: 6273 7061 7468 2c20 666e 290a 2020 2020  bspath, fn).    
+0001acd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ace0: 2020 2020 2020 2020 6966 2062 6f73 2e70          if bos.p
+0001acf0: 6174 682e 6578 6973 7473 2866 7029 3a0a  ath.exists(fp):.
+0001ad00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ad10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ad20: 7672 656d 203d 2022 7b7d 2f7b 7d22 2e66  vrem = "{}/{}".f
+0001ad30: 6f72 6d61 7428 7672 656d 2c20 666e 292e  ormat(vrem, fn).
+0001ad40: 7374 7269 7028 222f 2229 0a20 2020 2020  strip("/").     
+0001ad50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ad60: 2020 2020 2020 2020 2020 2069 735f 6469             is_di
+0001ad70: 7220 3d20 4661 6c73 650a 2020 2020 2020  r = False.      
+0001ad80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ad90: 2020 2020 2020 2020 2020 6272 6561 6b0a            break.
+0001ada0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001adb0: 2020 2020 2069 6620 6973 5f64 6972 3a0a       if is_dir:.
+0001adc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001add0: 2020 2020 2020 2020 7265 7475 726e 2073          return s
+0001ade0: 656c 662e 7478 5f69 636f 2822 612e 666f  elf.tx_ico("a.fo
+0001adf0: 6c64 6572 2229 0a0a 2020 2020 2020 2020  lder")..        
+0001ae00: 2020 2020 2020 2020 7468 7020 3d20 4e6f          thp = No
+0001ae10: 6e65 0a20 2020 2020 2020 2020 2020 2020  ne.             
+0001ae20: 2020 2069 6620 7365 6c66 2e74 6875 6d62     if self.thumb
+0001ae30: 636c 693a 0a20 2020 2020 2020 2020 2020  cli:.           
+0001ae40: 2020 2020 2020 2020 2074 6870 203d 2073           thp = s
+0001ae50: 656c 662e 7468 756d 6263 6c69 2e67 6574  elf.thumbcli.get
+0001ae60: 2864 6276 2c20 7672 656d 2c20 696e 7428  (dbv, vrem, int(
+0001ae70: 7374 2e73 745f 6d74 696d 6529 2c20 7468  st.st_mtime), th
+0001ae80: 5f66 6d74 290a 0a20 2020 2020 2020 2020  _fmt)..         
+0001ae90: 2020 2020 2020 2069 6620 7468 703a 0a20         if thp:. 
+0001aea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001aeb0: 2020 2072 6574 7572 6e20 7365 6c66 2e74     return self.t
+0001aec0: 785f 6669 6c65 2874 6870 290a 0a20 2020  x_file(thp)..   
+0001aed0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+0001aee0: 7468 5f66 6d74 203d 3d20 2270 223a 0a20  th_fmt == "p":. 
+0001aef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001af00: 2020 2072 6169 7365 2050 6562 6b61 6328     raise Pebkac(
+0001af10: 3430 3429 0a0a 2020 2020 2020 2020 2020  404)..          
+0001af20: 2020 2020 2020 7265 7475 726e 2073 656c        return sel
+0001af30: 662e 7478 5f69 636f 2872 656d 290a 0a20  f.tx_ico(rem).. 
+0001af40: 2020 2020 2020 2069 6620 6e6f 7420 6973         if not is
+0001af50: 5f64 6972 2061 6e64 2028 7365 6c66 2e63  _dir and (self.c
+0001af60: 616e 5f72 6561 6420 6f72 2073 656c 662e  an_read or self.
+0001af70: 6361 6e5f 6765 7429 3a0a 2020 2020 2020  can_get):.      
+0001af80: 2020 2020 2020 6966 206e 6f74 2073 656c        if not sel
+0001af90: 662e 6361 6e5f 7265 6164 2061 6e64 2022  f.can_read and "
+0001afa0: 666b 2220 696e 2076 6e2e 666c 6167 733a  fk" in vn.flags:
+0001afb0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001afc0: 2063 6f72 7265 6374 203d 2073 656c 662e   correct = self.
+0001afd0: 6765 6e5f 666b 280a 2020 2020 2020 2020  gen_fk(.        
+0001afe0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+0001aff0: 2e61 7267 732e 666b 5f73 616c 742c 2061  .args.fk_salt, a
+0001b000: 6273 7061 7468 2c20 7374 2e73 745f 7369  bspath, st.st_si
+0001b010: 7a65 2c20 3020 6966 2041 4e59 5749 4e20  ze, 0 if ANYWIN 
+0001b020: 656c 7365 2073 742e 7374 5f69 6e6f 0a20  else st.st_ino. 
+0001b030: 2020 2020 2020 2020 2020 2020 2020 2029                 )
+0001b040: 5b3a 2076 6e2e 666c 6167 735b 2266 6b22  [: vn.flags["fk"
+0001b050: 5d5d 0a20 2020 2020 2020 2020 2020 2020  ]].             
+0001b060: 2020 2067 6f74 203d 2073 656c 662e 7570     got = self.up
+0001b070: 6172 616d 2e67 6574 2822 6b22 290a 2020  aram.get("k").  
+0001b080: 2020 2020 2020 2020 2020 2020 2020 6966                if
+0001b090: 2067 6f74 2021 3d20 636f 7272 6563 743a   got != correct:
+0001b0a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001b0b0: 2020 2020 2073 656c 662e 6c6f 6728 2277       self.log("w
+0001b0c0: 726f 6e67 2066 696c 656b 6579 2c20 7761  rong filekey, wa
+0001b0d0: 6e74 207b 7d2c 2067 6f74 207b 7d22 2e66  nt {}, got {}".f
+0001b0e0: 6f72 6d61 7428 636f 7272 6563 742c 2067  ormat(correct, g
+0001b0f0: 6f74 2929 0a20 2020 2020 2020 2020 2020  ot)).           
+0001b100: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+0001b110: 7365 6c66 2e74 785f 3430 3428 290a 0a20  self.tx_404().. 
+0001b120: 2020 2020 2020 2020 2020 2069 6620 6162             if ab
+0001b130: 7370 6174 682e 656e 6473 7769 7468 2822  spath.endswith("
+0001b140: 2e6d 6422 2920 616e 6420 280a 2020 2020  .md") and (.    
+0001b150: 2020 2020 2020 2020 2020 2020 2276 2220              "v" 
+0001b160: 696e 2073 656c 662e 7570 6172 616d 206f  in self.uparam o
+0001b170: 7220 2265 6469 7422 2069 6e20 7365 6c66  r "edit" in self
+0001b180: 2e75 7061 7261 6d20 6f72 2022 6564 6974  .uparam or "edit
+0001b190: 3222 2069 6e20 7365 6c66 2e75 7061 7261  2" in self.upara
+0001b1a0: 6d0a 2020 2020 2020 2020 2020 2020 293a  m.            ):
+0001b1b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001b1c0: 2072 6574 7572 6e20 7365 6c66 2e74 785f   return self.tx_
+0001b1d0: 6d64 2861 6273 7061 7468 290a 0a20 2020  md(abspath)..   
+0001b1e0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+0001b1f0: 7365 6c66 2e74 785f 6669 6c65 2861 6273  self.tx_file(abs
+0001b200: 7061 7468 290a 0a20 2020 2020 2020 2065  path)..        e
+0001b210: 6c69 6620 6973 5f64 6972 2061 6e64 206e  lif is_dir and n
+0001b220: 6f74 2073 656c 662e 6361 6e5f 7265 6164  ot self.can_read
+0001b230: 2061 6e64 206e 6f74 2073 656c 662e 6361   and not self.ca
+0001b240: 6e5f 7772 6974 653a 0a20 2020 2020 2020  n_write:.       
+0001b250: 2020 2020 2072 6574 7572 6e20 7365 6c66       return self
+0001b260: 2e74 785f 3430 3428 5472 7565 290a 0a20  .tx_404(True).. 
+0001b270: 2020 2020 2020 2073 7276 5f69 6e66 6f20         srv_info 
+0001b280: 3d20 5b5d 0a0a 2020 2020 2020 2020 7472  = []..        tr
+0001b290: 793a 0a20 2020 2020 2020 2020 2020 2069  y:.            i
+0001b2a0: 6620 6e6f 7420 7365 6c66 2e61 7267 732e  f not self.args.
+0001b2b0: 6e69 683a 0a20 2020 2020 2020 2020 2020  nih:.           
+0001b2c0: 2020 2020 2073 7276 5f69 6e66 6f2e 6170       srv_info.ap
+0001b2d0: 7065 6e64 2873 656c 662e 6172 6773 2e6e  pend(self.args.n
+0001b2e0: 616d 6529 0a20 2020 2020 2020 2065 7863  ame).        exc
+0001b2f0: 6570 743a 0a20 2020 2020 2020 2020 2020  ept:.           
+0001b300: 2073 656c 662e 6c6f 6728 2223 776f 7720   self.log("#wow 
+0001b310: 2377 686f 6122 290a 0a20 2020 2020 2020  #whoa")..       
+0001b320: 2069 6620 6e6f 7420 7365 6c66 2e61 7267   if not self.arg
+0001b330: 732e 6e69 643a 0a20 2020 2020 2020 2020  s.nid:.         
+0001b340: 2020 2066 7265 652c 2074 6f74 616c 203d     free, total =
+0001b350: 2067 6574 5f64 6628 6162 7370 6174 6829   get_df(abspath)
+0001b360: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+0001b370: 746f 7461 6c20 6973 206e 6f74 204e 6f6e  total is not Non
+0001b380: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+0001b390: 2020 2068 3120 3d20 6875 6d61 6e73 697a     h1 = humansiz
+0001b3a0: 6528 6672 6565 206f 7220 3029 0a20 2020  e(free or 0).   
+0001b3b0: 2020 2020 2020 2020 2020 2020 2068 3220               h2 
+0001b3c0: 3d20 6875 6d61 6e73 697a 6528 746f 7461  = humansize(tota
+0001b3d0: 6c29 0a20 2020 2020 2020 2020 2020 2020  l).             
+0001b3e0: 2020 2073 7276 5f69 6e66 6f2e 6170 7065     srv_info.appe
+0001b3f0: 6e64 2822 7b7d 2066 7265 6520 6f66 207b  nd("{} free of {
+0001b400: 7d22 2e66 6f72 6d61 7428 6831 2c20 6832  }".format(h1, h2
+0001b410: 2929 0a20 2020 2020 2020 2020 2020 2065  )).            e
+0001b420: 6c69 6620 6672 6565 2069 7320 6e6f 7420  lif free is not 
+0001b430: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
+0001b440: 2020 2020 2020 7372 765f 696e 666f 2e61        srv_info.a
+0001b450: 7070 656e 6428 6875 6d61 6e73 697a 6528  ppend(humansize(
+0001b460: 6672 6565 2c20 5472 7565 2920 2b20 2220  free, True) + " 
+0001b470: 6672 6565 2229 0a0a 2020 2020 2020 2020  free")..        
+0001b480: 7372 765f 696e 666f 7420 3d20 223c 2f73  srv_infot = "</s
+0001b490: 7061 6e3e 202f 2f20 3c73 7061 6e3e 222e  pan> // <span>".
+0001b4a0: 6a6f 696e 2873 7276 5f69 6e66 6f29 0a0a  join(srv_info)..
+0001b4b0: 2020 2020 2020 2020 7065 726d 7320 3d20          perms = 
+0001b4c0: 5b5d 0a20 2020 2020 2020 2069 6620 7365  [].        if se
+0001b4d0: 6c66 2e63 616e 5f72 6561 643a 0a20 2020  lf.can_read:.   
+0001b4e0: 2020 2020 2020 2020 2070 6572 6d73 2e61           perms.a
+0001b4f0: 7070 656e 6428 2272 6561 6422 290a 2020  ppend("read").  
+0001b500: 2020 2020 2020 6966 2073 656c 662e 6361        if self.ca
+0001b510: 6e5f 7772 6974 653a 0a20 2020 2020 2020  n_write:.       
+0001b520: 2020 2020 2070 6572 6d73 2e61 7070 656e       perms.appen
+0001b530: 6428 2277 7269 7465 2229 0a20 2020 2020  d("write").     
+0001b540: 2020 2069 6620 7365 6c66 2e63 616e 5f6d     if self.can_m
+0001b550: 6f76 653a 0a20 2020 2020 2020 2020 2020  ove:.           
+0001b560: 2070 6572 6d73 2e61 7070 656e 6428 226d   perms.append("m
+0001b570: 6f76 6522 290a 2020 2020 2020 2020 6966  ove").        if
+0001b580: 2073 656c 662e 6361 6e5f 6465 6c65 7465   self.can_delete
+0001b590: 3a0a 2020 2020 2020 2020 2020 2020 7065  :.            pe
+0001b5a0: 726d 732e 6170 7065 6e64 2822 6465 6c65  rms.append("dele
+0001b5b0: 7465 2229 0a20 2020 2020 2020 2069 6620  te").        if 
+0001b5c0: 7365 6c66 2e63 616e 5f67 6574 3a0a 2020  self.can_get:.  
+0001b5d0: 2020 2020 2020 2020 2020 7065 726d 732e            perms.
+0001b5e0: 6170 7065 6e64 2822 6765 7422 290a 2020  append("get").  
+0001b5f0: 2020 2020 2020 6966 2073 656c 662e 6361        if self.ca
+0001b600: 6e5f 7570 6765 743a 0a20 2020 2020 2020  n_upget:.       
+0001b610: 2020 2020 2070 6572 6d73 2e61 7070 656e       perms.appen
+0001b620: 6428 2275 7067 6574 2229 0a0a 2020 2020  d("upget")..    
+0001b630: 2020 2020 7572 6c5f 7375 6620 3d20 7365      url_suf = se
+0001b640: 6c66 2e75 726c 7128 7b7d 2c20 5b22 6b22  lf.urlq({}, ["k"
+0001b650: 5d29 0a20 2020 2020 2020 2069 735f 6c73  ]).        is_ls
+0001b660: 203d 2022 6c73 2220 696e 2073 656c 662e   = "ls" in self.
+0001b670: 7570 6172 616d 0a20 2020 2020 2020 2069  uparam.        i
+0001b680: 735f 6a73 203d 2073 656c 662e 6172 6773  s_js = self.args
+0001b690: 2e66 6f72 6365 5f6a 7320 6f72 2073 656c  .force_js or sel
+0001b6a0: 662e 636f 6f6b 6965 732e 6765 7428 226a  f.cookies.get("j
+0001b6b0: 7322 2920 3d3d 2022 7922 0a0a 2020 2020  s") == "y"..    
+0001b6c0: 2020 2020 6966 206e 6f74 2069 735f 6c73      if not is_ls
+0001b6d0: 2061 6e64 2028 7365 6c66 2e75 612e 7374   and (self.ua.st
+0001b6e0: 6172 7473 7769 7468 2822 6375 726c 2f22  artswith("curl/"
+0001b6f0: 2920 6f72 2073 656c 662e 7561 2e73 7461  ) or self.ua.sta
+0001b700: 7274 7377 6974 6828 2266 6574 6368 2229  rtswith("fetch")
+0001b710: 293a 0a20 2020 2020 2020 2020 2020 2073  ):.            s
+0001b720: 656c 662e 7570 6172 616d 5b22 6c73 225d  elf.uparam["ls"]
+0001b730: 203d 2022 7622 0a20 2020 2020 2020 2020   = "v".         
+0001b740: 2020 2069 735f 6c73 203d 2054 7275 650a     is_ls = True.
+0001b750: 0a20 2020 2020 2020 2074 706c 203d 2022  .        tpl = "
+0001b760: 6272 6f77 7365 7222 0a20 2020 2020 2020  browser".       
+0001b770: 2069 6620 2262 2220 696e 2073 656c 662e   if "b" in self.
+0001b780: 7570 6172 616d 3a0a 2020 2020 2020 2020  uparam:.        
+0001b790: 2020 2020 7470 6c20 3d20 2262 726f 7773      tpl = "brows
+0001b7a0: 6572 3222 0a20 2020 2020 2020 2020 2020  er2".           
+0001b7b0: 2069 735f 6a73 203d 2046 616c 7365 0a0a   is_js = False..
+0001b7c0: 2020 2020 2020 2020 6c6f 6775 6573 203d          logues =
+0001b7d0: 205b 2222 2c20 2222 5d0a 2020 2020 2020   ["", ""].      
+0001b7e0: 2020 6966 206e 6f74 2073 656c 662e 6172    if not self.ar
+0001b7f0: 6773 2e6e 6f5f 6c6f 6775 6573 3a0a 2020  gs.no_logues:.  
+0001b800: 2020 2020 2020 2020 2020 666f 7220 6e2c            for n,
+0001b810: 2066 6e20 696e 2065 6e75 6d65 7261 7465   fn in enumerate
+0001b820: 285b 222e 7072 6f6c 6f67 7565 2e68 746d  ([".prologue.htm
+0001b830: 6c22 2c20 222e 6570 696c 6f67 7565 2e68  l", ".epilogue.h
+0001b840: 746d 6c22 5d29 3a0a 2020 2020 2020 2020  tml"]):.        
+0001b850: 2020 2020 2020 2020 666e 203d 206f 732e          fn = os.
+0001b860: 7061 7468 2e6a 6f69 6e28 6162 7370 6174  path.join(abspat
+0001b870: 682c 2066 6e29 0a20 2020 2020 2020 2020  h, fn).         
+0001b880: 2020 2020 2020 2069 6620 626f 732e 7061         if bos.pa
+0001b890: 7468 2e65 7869 7374 7328 666e 293a 0a20  th.exists(fn):. 
+0001b8a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b8b0: 2020 2077 6974 6820 6f70 656e 2866 7365     with open(fse
+0001b8c0: 6e63 2866 6e29 2c20 2272 6222 2920 6173  nc(fn), "rb") as
+0001b8d0: 2066 3a0a 2020 2020 2020 2020 2020 2020   f:.            
+0001b8e0: 2020 2020 2020 2020 2020 2020 6c6f 6775              logu
+0001b8f0: 6573 5b6e 5d20 3d20 662e 7265 6164 2829  es[n] = f.read()
+0001b900: 2e64 6563 6f64 6528 2275 7466 2d38 2229  .decode("utf-8")
+0001b910: 0a0a 2020 2020 2020 2020 7265 6164 6d65  ..        readme
+0001b920: 203d 2022 220a 2020 2020 2020 2020 6966   = "".        if
+0001b930: 206e 6f74 2073 656c 662e 6172 6773 2e6e   not self.args.n
+0001b940: 6f5f 7265 6164 6d65 2061 6e64 206e 6f74  o_readme and not
+0001b950: 206c 6f67 7565 735b 315d 3a0a 2020 2020   logues[1]:.    
+0001b960: 2020 2020 2020 2020 666f 7220 666e 2069          for fn i
+0001b970: 6e20 5b22 5245 4144 4d45 2e6d 6422 2c20  n ["README.md", 
+0001b980: 2272 6561 646d 652e 6d64 225d 3a0a 2020  "readme.md"]:.  
+0001b990: 2020 2020 2020 2020 2020 2020 2020 666e                fn
+0001b9a0: 203d 206f 732e 7061 7468 2e6a 6f69 6e28   = os.path.join(
+0001b9b0: 6162 7370 6174 682c 2066 6e29 0a20 2020  abspath, fn).   
+0001b9c0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+0001b9d0: 626f 732e 7061 7468 2e69 7366 696c 6528  bos.path.isfile(
+0001b9e0: 666e 293a 0a20 2020 2020 2020 2020 2020  fn):.           
+0001b9f0: 2020 2020 2020 2020 2077 6974 6820 6f70           with op
+0001ba00: 656e 2866 7365 6e63 2866 6e29 2c20 2272  en(fsenc(fn), "r
+0001ba10: 6222 2920 6173 2066 3a0a 2020 2020 2020  b") as f:.      
+0001ba20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ba30: 2020 7265 6164 6d65 203d 2066 2e72 6561    readme = f.rea
+0001ba40: 6428 292e 6465 636f 6465 2822 7574 662d  d().decode("utf-
+0001ba50: 3822 290a 2020 2020 2020 2020 2020 2020  8").            
+0001ba60: 2020 2020 2020 2020 2020 2020 6272 6561              brea
+0001ba70: 6b0a 0a20 2020 2020 2020 2076 6620 3d20  k..        vf = 
+0001ba80: 766e 2e66 6c61 6773 0a20 2020 2020 2020  vn.flags.       
+0001ba90: 206c 735f 7265 7420 3d20 7b0a 2020 2020   ls_ret = {.    
+0001baa0: 2020 2020 2020 2020 2264 6972 7322 3a20          "dirs": 
+0001bab0: 5b5d 2c0a 2020 2020 2020 2020 2020 2020  [],.            
+0001bac0: 2266 696c 6573 223a 205b 5d2c 0a20 2020  "files": [],.   
+0001bad0: 2020 2020 2020 2020 2022 7461 676c 6973           "taglis
+0001bae0: 7422 3a20 5b5d 2c0a 2020 2020 2020 2020  t": [],.        
+0001baf0: 2020 2020 2273 7276 696e 6622 3a20 7372      "srvinf": sr
+0001bb00: 765f 696e 666f 742c 0a20 2020 2020 2020  v_infot,.       
+0001bb10: 2020 2020 2022 6163 6374 223a 2073 656c       "acct": sel
+0001bb20: 662e 756e 616d 652c 0a20 2020 2020 2020  f.uname,.       
+0001bb30: 2020 2020 2022 6964 7822 3a20 6532 642c       "idx": e2d,
+0001bb40: 0a20 2020 2020 2020 2020 2020 2022 6974  .            "it
+0001bb50: 6167 223a 2065 3274 2c0a 2020 2020 2020  ag": e2t,.      
+0001bb60: 2020 2020 2020 226c 6966 6574 696d 6522        "lifetime"
+0001bb70: 3a20 766e 2e66 6c61 6773 2e67 6574 2822  : vn.flags.get("
+0001bb80: 6c69 6665 7469 6d65 2229 206f 7220 302c  lifetime") or 0,
+0001bb90: 0a20 2020 2020 2020 2020 2020 2022 6672  .            "fr
+0001bba0: 616e 6422 3a20 626f 6f6c 2876 6e2e 666c  and": bool(vn.fl
+0001bbb0: 6167 732e 6765 7428 2272 616e 6422 2929  ags.get("rand"))
+0001bbc0: 2c0a 2020 2020 2020 2020 2020 2020 2270  ,.            "p
+0001bbd0: 6572 6d73 223a 2070 6572 6d73 2c0a 2020  erms": perms,.  
+0001bbe0: 2020 2020 2020 2020 2020 226c 6f67 7565            "logue
+0001bbf0: 7322 3a20 6c6f 6775 6573 2c0a 2020 2020  s": logues,.    
+0001bc00: 2020 2020 2020 2020 2272 6561 646d 6522          "readme"
+0001bc10: 3a20 7265 6164 6d65 2c0a 2020 2020 2020  : readme,.      
+0001bc20: 2020 7d0a 2020 2020 2020 2020 6a32 6120    }.        j2a 
+0001bc30: 3d20 7b0a 2020 2020 2020 2020 2020 2020  = {.            
+0001bc40: 2276 6469 7222 3a20 7175 6f74 6570 2873  "vdir": quotep(s
+0001bc50: 656c 662e 7670 6174 6829 2c0a 2020 2020  elf.vpath),.    
+0001bc60: 2020 2020 2020 2020 2276 706e 6f64 6573          "vpnodes
+0001bc70: 223a 2076 706e 6f64 6573 2c0a 2020 2020  ": vpnodes,.    
+0001bc80: 2020 2020 2020 2020 2266 696c 6573 223a          "files":
+0001bc90: 205b 5d2c 0a20 2020 2020 2020 2020 2020   [],.           
+0001bca0: 2022 6c73 3022 3a20 4e6f 6e65 2c0a 2020   "ls0": None,.  
+0001bcb0: 2020 2020 2020 2020 2020 2261 6363 7422            "acct"
+0001bcc0: 3a20 7365 6c66 2e75 6e61 6d65 2c0a 2020  : self.uname,.  
+0001bcd0: 2020 2020 2020 2020 2020 2270 6572 6d73            "perms
+0001bce0: 223a 206a 736f 6e2e 6475 6d70 7328 7065  ": json.dumps(pe
+0001bcf0: 726d 7329 2c0a 2020 2020 2020 2020 2020  rms),.          
+0001bd00: 2020 226c 6966 6574 696d 6522 3a20 6c73    "lifetime": ls
+0001bd10: 5f72 6574 5b22 6c69 6665 7469 6d65 225d  _ret["lifetime"]
+0001bd20: 2c0a 2020 2020 2020 2020 2020 2020 2266  ,.            "f
+0001bd30: 7261 6e64 223a 2062 6f6f 6c28 766e 2e66  rand": bool(vn.f
+0001bd40: 6c61 6773 2e67 6574 2822 7261 6e64 2229  lags.get("rand")
+0001bd50: 292c 0a20 2020 2020 2020 2020 2020 2022  ),.            "
+0001bd60: 7461 676c 6973 7422 3a20 5b5d 2c0a 2020  taglist": [],.  
+0001bd70: 2020 2020 2020 2020 2020 2264 6566 5f68            "def_h
+0001bd80: 636f 6c73 223a 205b 5d2c 0a20 2020 2020  cols": [],.     
+0001bd90: 2020 2020 2020 2022 6861 7665 5f65 6d70         "have_emp
+0001bda0: 223a 2073 656c 662e 6172 6773 2e65 6d70  ": self.args.emp
+0001bdb0: 2c0a 2020 2020 2020 2020 2020 2020 2268  ,.            "h
+0001bdc0: 6176 655f 7570 326b 5f69 6478 223a 2065  ave_up2k_idx": e
+0001bdd0: 3264 2c0a 2020 2020 2020 2020 2020 2020  2d,.            
+0001bde0: 2268 6176 655f 7461 6773 5f69 6478 223a  "have_tags_idx":
+0001bdf0: 2065 3274 2c0a 2020 2020 2020 2020 2020   e2t,.          
+0001be00: 2020 2268 6176 655f 6163 6f64 6522 3a20    "have_acode": 
+0001be10: 286e 6f74 2073 656c 662e 6172 6773 2e6e  (not self.args.n
+0001be20: 6f5f 6163 6f64 6529 2c0a 2020 2020 2020  o_acode),.      
+0001be30: 2020 2020 2020 2268 6176 655f 6d76 223a        "have_mv":
+0001be40: 2028 6e6f 7420 7365 6c66 2e61 7267 732e   (not self.args.
+0001be50: 6e6f 5f6d 7629 2c0a 2020 2020 2020 2020  no_mv),.        
+0001be60: 2020 2020 2268 6176 655f 6465 6c22 3a20      "have_del": 
+0001be70: 286e 6f74 2073 656c 662e 6172 6773 2e6e  (not self.args.n
+0001be80: 6f5f 6465 6c29 2c0a 2020 2020 2020 2020  o_del),.        
+0001be90: 2020 2020 2268 6176 655f 7a69 7022 3a20      "have_zip": 
+0001bea0: 286e 6f74 2073 656c 662e 6172 6773 2e6e  (not self.args.n
+0001beb0: 6f5f 7a69 7029 2c0a 2020 2020 2020 2020  o_zip),.        
+0001bec0: 2020 2020 2268 6176 655f 756e 706f 7374      "have_unpost
+0001bed0: 223a 2069 6e74 2873 656c 662e 6172 6773  ": int(self.args
+0001bee0: 2e75 6e70 6f73 7429 2c0a 2020 2020 2020  .unpost),.      
+0001bef0: 2020 2020 2020 2268 6176 655f 625f 7522        "have_b_u"
+0001bf00: 3a20 2873 656c 662e 6361 6e5f 7772 6974  : (self.can_writ
+0001bf10: 6520 616e 6420 7365 6c66 2e75 7061 7261  e and self.upara
+0001bf20: 6d2e 6765 7428 2262 2229 203d 3d20 2275  m.get("b") == "u
+0001bf30: 2229 2c0a 2020 2020 2020 2020 2020 2020  "),.            
+0001bf40: 2273 625f 6d64 223a 2022 2220 6966 2022  "sb_md": "" if "
+0001bf50: 6e6f 5f73 625f 6d64 2220 696e 2076 6620  no_sb_md" in vf 
+0001bf60: 656c 7365 2028 7666 2e67 6574 2822 6d64  else (vf.get("md
+0001bf70: 5f73 6266 2229 206f 7220 2279 2229 2c0a  _sbf") or "y"),.
+0001bf80: 2020 2020 2020 2020 2020 2020 2273 625f              "sb_
+0001bf90: 6c67 223a 2022 2220 6966 2022 6e6f 5f73  lg": "" if "no_s
+0001bfa0: 625f 6c67 2220 696e 2076 6620 656c 7365  b_lg" in vf else
+0001bfb0: 2028 7666 2e67 6574 2822 6c67 5f73 6266   (vf.get("lg_sbf
+0001bfc0: 2229 206f 7220 2279 2229 2c0a 2020 2020  ") or "y"),.    
+0001bfd0: 2020 2020 2020 2020 2275 726c 5f73 7566          "url_suf
+0001bfe0: 223a 2075 726c 5f73 7566 2c0a 2020 2020  ": url_suf,.    
+0001bff0: 2020 2020 2020 2020 226c 6f67 7565 7322          "logues"
+0001c000: 3a20 6c6f 6775 6573 2c0a 2020 2020 2020  : logues,.      
+0001c010: 2020 2020 2020 2272 6561 646d 6522 3a20        "readme": 
+0001c020: 7265 6164 6d65 2c0a 2020 2020 2020 2020  readme,.        
+0001c030: 2020 2020 2274 6974 6c65 223a 2068 746d      "title": htm
+0001c040: 6c5f 6573 6361 7065 2873 656c 662e 7670  l_escape(self.vp
+0001c050: 6174 682c 2063 726c 663d 5472 7565 2920  ath, crlf=True) 
+0001c060: 6f72 2022 f09f 92be f09f 8e89 222c 0a20  or "........",. 
+0001c070: 2020 2020 2020 2020 2020 2022 7372 765f             "srv_
+0001c080: 696e 666f 223a 2073 7276 5f69 6e66 6f74  info": srv_infot
+0001c090: 2c0a 2020 2020 2020 2020 2020 2020 2264  ,.            "d
+0001c0a0: 7468 656d 6522 3a20 7365 6c66 2e61 7267  theme": self.arg
+0001c0b0: 732e 7468 656d 652c 0a20 2020 2020 2020  s.theme,.       
+0001c0c0: 2020 2020 2022 7468 656d 6573 223a 2073       "themes": s
+0001c0d0: 656c 662e 6172 6773 2e74 6865 6d65 732c  elf.args.themes,
+0001c0e0: 0a20 2020 2020 2020 2020 2020 2022 7475  .            "tu
+0001c0f0: 7262 6f6c 766c 223a 2073 656c 662e 6172  rbolvl": self.ar
+0001c100: 6773 2e74 7572 626f 2c0a 2020 2020 2020  gs.turbo,.      
+0001c110: 2020 2020 2020 2269 6478 6822 3a20 696e        "idxh": in
+0001c120: 7428 7365 6c66 2e61 7267 732e 6968 292c  t(self.args.ih),
+0001c130: 0a20 2020 2020 2020 2020 2020 2022 7532  .            "u2
+0001c140: 736f 7274 223a 2073 656c 662e 6172 6773  sort": self.args
+0001c150: 2e75 3273 6f72 742c 0a20 2020 2020 2020  .u2sort,.       
+0001c160: 207d 0a0a 2020 2020 2020 2020 6966 2073   }..        if s
+0001c170: 656c 662e 6172 6773 2e6a 735f 6272 6f77  elf.args.js_brow
+0001c180: 7365 723a 0a20 2020 2020 2020 2020 2020  ser:.           
+0001c190: 206a 3261 5b22 6a73 225d 203d 2073 656c   j2a["js"] = sel
+0001c1a0: 662e 6172 6773 2e6a 735f 6272 6f77 7365  f.args.js_browse
+0001c1b0: 720a 0a20 2020 2020 2020 2069 6620 7365  r..        if se
+0001c1c0: 6c66 2e61 7267 732e 6373 735f 6272 6f77  lf.args.css_brow
+0001c1d0: 7365 723a 0a20 2020 2020 2020 2020 2020  ser:.           
+0001c1e0: 206a 3261 5b22 6373 7322 5d20 3d20 7365   j2a["css"] = se
+0001c1f0: 6c66 2e61 7267 732e 6373 735f 6272 6f77  lf.args.css_brow
+0001c200: 7365 720a 0a20 2020 2020 2020 2069 6620  ser..        if 
+0001c210: 6e6f 7420 7365 6c66 2e63 6f6e 6e2e 6873  not self.conn.hs
+0001c220: 7276 2e70 7269 736d 3a0a 2020 2020 2020  rv.prism:.      
+0001c230: 2020 2020 2020 6a32 615b 226e 6f5f 7072        j2a["no_pr
+0001c240: 6973 6d22 5d20 3d20 5472 7565 0a0a 2020  ism"] = True..  
+0001c250: 2020 2020 2020 6966 206e 6f74 2073 656c        if not sel
+0001c260: 662e 6361 6e5f 7265 6164 3a0a 2020 2020  f.can_read:.    
+0001c270: 2020 2020 2020 2020 6966 2069 735f 6c73          if is_ls
+0001c280: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0001c290: 2020 7265 7475 726e 2073 656c 662e 7478    return self.tx
+0001c2a0: 5f6c 7328 6c73 5f72 6574 290a 0a20 2020  _ls(ls_ret)..   
+0001c2b0: 2020 2020 2020 2020 2069 6620 6e6f 7420           if not 
+0001c2c0: 7374 6174 2e53 5f49 5344 4952 2873 742e  stat.S_ISDIR(st.
+0001c2d0: 7374 5f6d 6f64 6529 3a0a 2020 2020 2020  st_mode):.      
+0001c2e0: 2020 2020 2020 2020 2020 7265 7475 726e            return
+0001c2f0: 2073 656c 662e 7478 5f34 3034 2854 7275   self.tx_404(Tru
+0001c300: 6529 0a0a 2020 2020 2020 2020 2020 2020  e)..            
+0001c310: 6966 2022 7a69 7022 2069 6e20 7365 6c66  if "zip" in self
+0001c320: 2e75 7061 7261 6d20 6f72 2022 7461 7222  .uparam or "tar"
+0001c330: 2069 6e20 7365 6c66 2e75 7061 7261 6d3a   in self.uparam:
+0001c340: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001c350: 2072 6169 7365 2050 6562 6b61 6328 3430   raise Pebkac(40
+0001c360: 3329 0a0a 2020 2020 2020 2020 2020 2020  3)..            
+0001c370: 6874 6d6c 203d 2073 656c 662e 6a32 7328  html = self.j2s(
+0001c380: 7470 6c2c 202a 2a6a 3261 290a 2020 2020  tpl, **j2a).    
+0001c390: 2020 2020 2020 2020 7365 6c66 2e72 6570          self.rep
+0001c3a0: 6c79 2868 746d 6c2e 656e 636f 6465 2822  ly(html.encode("
+0001c3b0: 7574 662d 3822 2c20 2272 6570 6c61 6365  utf-8", "replace
+0001c3c0: 2229 290a 2020 2020 2020 2020 2020 2020  ")).            
+0001c3d0: 7265 7475 726e 2054 7275 650a 0a20 2020  return True..   
+0001c3e0: 2020 2020 2066 6f72 206b 2069 6e20 5b22       for k in ["
+0001c3f0: 7a69 7022 2c20 2274 6172 225d 3a0a 2020  zip", "tar"]:.  
+0001c400: 2020 2020 2020 2020 2020 7620 3d20 7365            v = se
+0001c410: 6c66 2e75 7061 7261 6d2e 6765 7428 6b29  lf.uparam.get(k)
+0001c420: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+0001c430: 7620 6973 206e 6f74 204e 6f6e 653a 0a20  v is not None:. 
+0001c440: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+0001c450: 6574 7572 6e20 7365 6c66 2e74 785f 7a69  eturn self.tx_zi
+0001c460: 7028 6b2c 2076 2c20 7365 6c66 2e76 7061  p(k, v, self.vpa
+0001c470: 7468 2c20 766e 2c20 7265 6d2c 205b 5d2c  th, vn, rem, [],
+0001c480: 2073 656c 662e 6172 6773 2e65 6429 0a0a   self.args.ed)..
+0001c490: 2020 2020 2020 2020 6673 726f 6f74 2c20          fsroot, 
+0001c4a0: 7666 735f 6c73 2c20 7666 735f 7669 7274  vfs_ls, vfs_virt
+0001c4b0: 203d 2076 6e2e 6c73 280a 2020 2020 2020   = vn.ls(.      
+0001c4c0: 2020 2020 2020 7265 6d2c 0a20 2020 2020        rem,.     
+0001c4d0: 2020 2020 2020 2073 656c 662e 756e 616d         self.unam
+0001c4e0: 652c 0a20 2020 2020 2020 2020 2020 206e  e,.            n
+0001c4f0: 6f74 2073 656c 662e 6172 6773 2e6e 6f5f  ot self.args.no_
+0001c500: 7363 616e 6469 722c 0a20 2020 2020 2020  scandir,.       
+0001c510: 2020 2020 205b 5b54 7275 652c 2046 616c       [[True, Fal
+0001c520: 7365 5d2c 205b 4661 6c73 652c 2054 7275  se], [False, Tru
+0001c530: 655d 5d2c 0a20 2020 2020 2020 2020 2020  e]],.           
+0001c540: 206c 7374 6174 3d22 6c74 2220 696e 2073   lstat="lt" in s
+0001c550: 656c 662e 7570 6172 616d 2c0a 2020 2020  elf.uparam,.    
+0001c560: 2020 2020 290a 2020 2020 2020 2020 7374      ).        st
+0001c570: 6174 7320 3d20 7b6b 3a20 7620 666f 7220  ats = {k: v for 
+0001c580: 6b2c 2076 2069 6e20 7666 735f 6c73 7d0a  k, v in vfs_ls}.
+0001c590: 2020 2020 2020 2020 6c73 5f6e 616d 6573          ls_names
+0001c5a0: 203d 205b 785b 305d 2066 6f72 2078 2069   = [x[0] for x i
+0001c5b0: 6e20 7666 735f 6c73 5d0a 2020 2020 2020  n vfs_ls].      
+0001c5c0: 2020 6c73 5f6e 616d 6573 2e65 7874 656e    ls_names.exten
+0001c5d0: 6428 6c69 7374 2876 6673 5f76 6972 742e  d(list(vfs_virt.
+0001c5e0: 6b65 7973 2829 2929 0a0a 2020 2020 2020  keys()))..      
+0001c5f0: 2020 2320 6368 6563 6b20 666f 7220 6f6c    # check for ol
+0001c600: 6420 7665 7273 696f 6e73 206f 6620 6669  d versions of fi
+0001c610: 6c65 732c 0a20 2020 2020 2020 2023 205b  les,.        # [
+0001c620: 6e75 6d2d 6261 636b 7570 732c 206d 6f73  num-backups, mos
+0001c630: 742d 7265 6365 6e74 2c20 6869 7374 2d70  t-recent, hist-p
+0001c640: 6174 685d 0a20 2020 2020 2020 2068 6973  ath].        his
+0001c650: 7420 2020 2020 3d20 7b7d 0a20 2020 2020  t     = {}.     
+0001c660: 2020 2068 6973 7464 6972 203d 206f 732e     histdir = os.
+0001c670: 7061 7468 2e6a 6f69 6e28 6673 726f 6f74  path.join(fsroot
+0001c680: 2c20 222e 6869 7374 2229 0a20 2020 2020  , ".hist").     
+0001c690: 2020 2070 746e 203d 2072 652e 636f 6d70     ptn = re.comp
+0001c6a0: 696c 6528 7222 282e 2a29 5c2e 285b 302d  ile(r"(.*)\.([0-
+0001c6b0: 395d 2b5c 2e5b 302d 395d 7b33 7d29 285c  9]+\.[0-9]{3})(\
+0001c6c0: 2e5b 5e5c 2e5d 2b29 2422 290a 2020 2020  .[^\.]+)$").    
+0001c6d0: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
+0001c6e0: 2020 2020 2066 6f72 2068 666e 2069 6e20       for hfn in 
+0001c6f0: 626f 732e 6c69 7374 6469 7228 6869 7374  bos.listdir(hist
+0001c700: 6469 7229 3a0a 2020 2020 2020 2020 2020  dir):.          
+0001c710: 2020 2020 2020 6d20 3d20 7074 6e2e 6d61        m = ptn.ma
+0001c720: 7463 6828 6866 6e29 0a20 2020 2020 2020  tch(hfn).       
+0001c730: 2020 2020 2020 2020 2069 6620 6e6f 7420           if not 
+0001c740: 6d3a 0a20 2020 2020 2020 2020 2020 2020  m:.             
+0001c750: 2020 2020 2020 2063 6f6e 7469 6e75 650a         continue.
+0001c760: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001c770: 2066 6e20 3d20 6d2e 6772 6f75 7028 3129   fn = m.group(1)
+0001c780: 202b 206d 2e67 726f 7570 2833 290a 2020   + m.group(3).  
+0001c790: 2020 2020 2020 2020 2020 2020 2020 6e2c                n,
+0001c7a0: 2074 732c 205f 203d 2068 6973 742e 6765   ts, _ = hist.ge
+0001c7b0: 7428 666e 2c20 2830 2c20 302c 2022 2229  t(fn, (0, 0, "")
+0001c7c0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0001c7d0: 2020 6869 7374 5b66 6e5d 203d 2028 6e20    hist[fn] = (n 
+0001c7e0: 2b20 312c 206d 6178 2874 732c 2066 6c6f  + 1, max(ts, flo
+0001c7f0: 6174 286d 2e67 726f 7570 2832 2929 292c  at(m.group(2))),
+0001c800: 2068 666e 290a 2020 2020 2020 2020 6578   hfn).        ex
+0001c810: 6365 7074 3a0a 2020 2020 2020 2020 2020  cept:.          
+0001c820: 2020 7061 7373 0a0a 2020 2020 2020 2020    pass..        
+0001c830: 2320 7368 6f77 2064 6f74 6669 6c65 7320  # show dotfiles 
+0001c840: 6966 2070 6572 6d69 7474 6564 2061 6e64  if permitted and
+0001c850: 2072 6571 7565 7374 6564 0a20 2020 2020   requested.     
+0001c860: 2020 2069 6620 6e6f 7420 7365 6c66 2e61     if not self.a
+0001c870: 7267 732e 6564 206f 7220 2264 6f74 7322  rgs.ed or "dots"
+0001c880: 206e 6f74 2069 6e20 7365 6c66 2e75 7061   not in self.upa
+0001c890: 7261 6d3a 0a20 2020 2020 2020 2020 2020  ram:.           
+0001c8a0: 206c 735f 6e61 6d65 7320 3d20 6578 636c   ls_names = excl
+0001c8b0: 7564 655f 646f 7466 696c 6573 286c 735f  ude_dotfiles(ls_
+0001c8c0: 6e61 6d65 7329 0a0a 2020 2020 2020 2020  names)..        
+0001c8d0: 6164 645f 666b 203d 2076 6e2e 666c 6167  add_fk = vn.flag
+0001c8e0: 732e 6765 7428 2266 6b22 290a 0a20 2020  s.get("fk")..   
+0001c8f0: 2020 2020 2064 6972 7320 3d20 5b5d 0a20       dirs = []. 
+0001c900: 2020 2020 2020 2066 696c 6573 203d 205b         files = [
+0001c910: 5d0a 2020 2020 2020 2020 666f 7220 666e  ].        for fn
+0001c920: 2069 6e20 6c73 5f6e 616d 6573 3a0a 2020   in ls_names:.  
+0001c930: 2020 2020 2020 2020 2020 6261 7365 203d            base =
+0001c940: 2022 220a 2020 2020 2020 2020 2020 2020   "".            
+0001c950: 6872 6566 203d 2066 6e0a 2020 2020 2020  href = fn.      
+0001c960: 2020 2020 2020 6966 206e 6f74 2069 735f        if not is_
+0001c970: 6c73 2061 6e64 206e 6f74 2069 735f 6a73  ls and not is_js
+0001c980: 2061 6e64 206e 6f74 2073 656c 662e 7472   and not self.tr
+0001c990: 6169 6c69 6e67 5f73 6c61 7368 2061 6e64  ailing_slash and
+0001c9a0: 2076 7061 7468 3a0a 2020 2020 2020 2020   vpath:.        
+0001c9b0: 2020 2020 2020 2020 6261 7365 203d 2022          base = "
+0001c9c0: 2f22 202b 2076 7061 7468 202b 2022 2f22  /" + vpath + "/"
+0001c9d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001c9e0: 2068 7265 6620 3d20 6261 7365 202b 2066   href = base + f
+0001c9f0: 6e0a 0a20 2020 2020 2020 2020 2020 2069  n..            i
+0001ca00: 6620 666e 2069 6e20 7666 735f 7669 7274  f fn in vfs_virt
+0001ca10: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0001ca20: 2020 6673 7061 7468 203d 2076 6673 5f76    fspath = vfs_v
+0001ca30: 6972 745b 666e 5d2e 7265 616c 7061 7468  irt[fn].realpath
+0001ca40: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
+0001ca50: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+0001ca60: 2020 2066 7370 6174 6820 3d20 6673 726f     fspath = fsro
+0001ca70: 6f74 202b 2022 2f22 202b 2066 6e0a 0a20  ot + "/" + fn.. 
+0001ca80: 2020 2020 2020 2020 2020 2074 7279 3a0a             try:.
+0001ca90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001caa0: 6c69 6e66 203d 2073 7461 7473 2e67 6574  linf = stats.get
+0001cab0: 2866 6e29 206f 7220 626f 732e 6c73 7461  (fn) or bos.lsta
+0001cac0: 7428 6673 7061 7468 290a 2020 2020 2020  t(fspath).      
+0001cad0: 2020 2020 2020 2020 2020 696e 6620 3d20            inf = 
+0001cae0: 626f 732e 7374 6174 2866 7370 6174 6829  bos.stat(fspath)
+0001caf0: 2069 6620 7374 6174 2e53 5f49 534c 4e4b   if stat.S_ISLNK
+0001cb00: 286c 696e 662e 7374 5f6d 6f64 6529 2065  (linf.st_mode) e
+0001cb10: 6c73 6520 6c69 6e66 0a20 2020 2020 2020  lse linf.       
+0001cb20: 2020 2020 2065 7863 6570 743a 0a20 2020       except:.   
+0001cb30: 2020 2020 2020 2020 2020 2020 2073 656c               sel
+0001cb40: 662e 6c6f 6728 2262 726f 6b65 6e20 7379  f.log("broken sy
+0001cb50: 6d6c 696e 6b3a 207b 7d22 2e66 6f72 6d61  mlink: {}".forma
+0001cb60: 7428 7265 7072 2866 7370 6174 6829 2929  t(repr(fspath)))
+0001cb70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001cb80: 2063 6f6e 7469 6e75 650a 0a20 2020 2020   continue..     
+0001cb90: 2020 2020 2020 2069 735f 6469 7220 3d20         is_dir = 
+0001cba0: 7374 6174 2e53 5f49 5344 4952 2869 6e66  stat.S_ISDIR(inf
+0001cbb0: 2e73 745f 6d6f 6465 290a 2020 2020 2020  .st_mode).      
+0001cbc0: 2020 2020 2020 6966 2069 735f 6469 723a        if is_dir:
+0001cbd0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001cbe0: 2068 7265 6620 2b3d 2022 2f22 0a20 2020   href += "/".   
+0001cbf0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+0001cc00: 7365 6c66 2e61 7267 732e 6e6f 5f7a 6970  self.args.no_zip
+0001cc10: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0001cc20: 2020 2020 2020 6d61 7267 696e 203d 2022        margin = "
+0001cc30: 4449 5222 0a20 2020 2020 2020 2020 2020  DIR".           
+0001cc40: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+0001cc50: 2020 2020 2020 2020 2020 2020 2020 206d                 m
+0001cc60: 6172 6769 6e20 3d20 273c 6120 6872 6566  argin = '<a href
+0001cc70: 3d22 2573 3f7a 6970 2220 7265 6c3d 226e  ="%s?zip" rel="n
+0001cc80: 6f66 6f6c 6c6f 7722 3e7a 6970 3c2f 613e  ofollow">zip</a>
+0001cc90: 2720 2520 2871 756f 7465 7028 6872 6566  ' % (quotep(href
+0001cca0: 292c 290a 2020 2020 2020 2020 2020 2020  ),).            
+0001ccb0: 656c 6966 2066 6e20 696e 2068 6973 743a  elif fn in hist:
+0001ccc0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001ccd0: 206d 6172 6769 6e20 3d20 273c 6120 6872   margin = '<a hr
+0001cce0: 6566 3d22 2573 2e68 6973 742f 2573 223e  ef="%s.hist/%s">
+0001ccf0: 2325 733c 2f61 3e27 2025 2028 0a20 2020  #%s</a>' % (.   
+0001cd00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001cd10: 2062 6173 652c 0a20 2020 2020 2020 2020   base,.         
+0001cd20: 2020 2020 2020 2020 2020 2068 746d 6c5f             html_
+0001cd30: 6573 6361 7065 2868 6973 745b 666e 5d5b  escape(hist[fn][
+0001cd40: 325d 2c20 7175 6f74 3d54 7275 652c 2063  2], quot=True, c
+0001cd50: 726c 663d 5472 7565 292c 0a20 2020 2020  rlf=True),.     
+0001cd60: 2020 2020 2020 2020 2020 2020 2020 2068                 h
+0001cd70: 6973 745b 666e 5d5b 305d 2c0a 2020 2020  ist[fn][0],.    
+0001cd80: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
+0001cd90: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
+0001cda0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001cdb0: 6d61 7267 696e 203d 2022 2d22 0a0a 2020  margin = "-"..  
+0001cdc0: 2020 2020 2020 2020 2020 737a 203d 2069            sz = i
+0001cdd0: 6e66 2e73 745f 7369 7a65 0a20 2020 2020  nf.st_size.     
+0001cde0: 2020 2020 2020 207a 6420 3d20 6461 7465         zd = date
+0001cdf0: 7469 6d65 2e75 7463 6672 6f6d 7469 6d65  time.utcfromtime
+0001ce00: 7374 616d 7028 6c69 6e66 2e73 745f 6d74  stamp(linf.st_mt
+0001ce10: 696d 6529 0a20 2020 2020 2020 2020 2020  ime).           
+0001ce20: 2064 7420 3d20 2225 3034 642d 2530 3264   dt = "%04d-%02d
+0001ce30: 2d25 3032 6420 2530 3264 3a25 3032 643a  -%02d %02d:%02d:
+0001ce40: 2530 3264 2220 2520 280a 2020 2020 2020  %02d" % (.      
+0001ce50: 2020 2020 2020 2020 2020 7a64 2e79 6561            zd.yea
+0001ce60: 722c 0a20 2020 2020 2020 2020 2020 2020  r,.             
+0001ce70: 2020 207a 642e 6d6f 6e74 682c 0a20 2020     zd.month,.   
+0001ce80: 2020 2020 2020 2020 2020 2020 207a 642e               zd.
+0001ce90: 6461 792c 0a20 2020 2020 2020 2020 2020  day,.           
+0001cea0: 2020 2020 207a 642e 686f 7572 2c0a 2020       zd.hour,.  
+0001ceb0: 2020 2020 2020 2020 2020 2020 2020 7a64                zd
+0001cec0: 2e6d 696e 7574 652c 0a20 2020 2020 2020  .minute,.       
+0001ced0: 2020 2020 2020 2020 207a 642e 7365 636f           zd.seco
+0001cee0: 6e64 2c0a 2020 2020 2020 2020 2020 2020  nd,.            
+0001cef0: 290a 0a20 2020 2020 2020 2020 2020 2074  )..            t
+0001cf00: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
+0001cf10: 2020 2020 6578 7420 3d20 222d 2d2d 2220      ext = "---" 
+0001cf20: 6966 2069 735f 6469 7220 656c 7365 2066  if is_dir else f
+0001cf30: 6e2e 7273 706c 6974 2822 2e22 2c20 3129  n.rsplit(".", 1)
+0001cf40: 5b31 5d0a 2020 2020 2020 2020 2020 2020  [1].            
+0001cf50: 2020 2020 6966 206c 656e 2865 7874 2920      if len(ext) 
+0001cf60: 3e20 3136 3a0a 2020 2020 2020 2020 2020  > 16:.          
+0001cf70: 2020 2020 2020 2020 2020 6578 7420 3d20            ext = 
+0001cf80: 6578 745b 3a31 365d 0a20 2020 2020 2020  ext[:16].       
+0001cf90: 2020 2020 2065 7863 6570 743a 0a20 2020       except:.   
+0001cfa0: 2020 2020 2020 2020 2020 2020 2065 7874               ext
+0001cfb0: 203d 2022 2522 0a0a 2020 2020 2020 2020   = "%"..        
+0001cfc0: 2020 2020 6966 2061 6464 5f66 6b3a 0a20      if add_fk:. 
+0001cfd0: 2020 2020 2020 2020 2020 2020 2020 2068                 h
+0001cfe0: 7265 6620 3d20 2225 733f 6b3d 2573 2220  ref = "%s?k=%s" 
+0001cff0: 2520 280a 2020 2020 2020 2020 2020 2020  % (.            
+0001d000: 2020 2020 2020 2020 7175 6f74 6570 2868          quotep(h
+0001d010: 7265 6629 2c0a 2020 2020 2020 2020 2020  ref),.          
+0001d020: 2020 2020 2020 2020 2020 7365 6c66 2e67            self.g
+0001d030: 656e 5f66 6b28 0a20 2020 2020 2020 2020  en_fk(.         
+0001d040: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+0001d050: 656c 662e 6172 6773 2e66 6b5f 7361 6c74  elf.args.fk_salt
+0001d060: 2c20 6673 7061 7468 2c20 737a 2c20 3020  , fspath, sz, 0 
+0001d070: 6966 2041 4e59 5749 4e20 656c 7365 2069  if ANYWIN else i
+0001d080: 6e66 2e73 745f 696e 6f0a 2020 2020 2020  nf.st_ino.      
+0001d090: 2020 2020 2020 2020 2020 2020 2020 295b                )[
+0001d0a0: 3a61 6464 5f66 6b5d 2c0a 2020 2020 2020  :add_fk],.      
+0001d0b0: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+0001d0c0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+0001d0d0: 2020 2020 2020 2020 2020 2020 2020 6872                hr
+0001d0e0: 6566 203d 2071 756f 7465 7028 6872 6566  ef = quotep(href
+0001d0f0: 290a 0a20 2020 2020 2020 2020 2020 2069  )..            i
+0001d100: 7465 6d20 3d20 7b0a 2020 2020 2020 2020  tem = {.        
+0001d110: 2020 2020 2020 2020 226c 6561 6422 3a20          "lead": 
+0001d120: 6d61 7267 696e 2c0a 2020 2020 2020 2020  margin,.        
+0001d130: 2020 2020 2020 2020 2268 7265 6622 3a20          "href": 
+0001d140: 6872 6566 2c0a 2020 2020 2020 2020 2020  href,.          
+0001d150: 2020 2020 2020 226e 616d 6522 3a20 666e        "name": fn
+0001d160: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0001d170: 2020 2273 7a22 3a20 737a 2c0a 2020 2020    "sz": sz,.    
+0001d180: 2020 2020 2020 2020 2020 2020 2265 7874              "ext
+0001d190: 223a 2065 7874 2c0a 2020 2020 2020 2020  ": ext,.        
+0001d1a0: 2020 2020 2020 2020 2264 7422 3a20 6474          "dt": dt
+0001d1b0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0001d1c0: 2020 2274 7322 3a20 696e 7428 6c69 6e66    "ts": int(linf
+0001d1d0: 2e73 745f 6d74 696d 6529 2c0a 2020 2020  .st_mtime),.    
+0001d1e0: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
+0001d1f0: 2020 2020 2020 6966 2069 735f 6469 723a        if is_dir:
+0001d200: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001d210: 2064 6972 732e 6170 7065 6e64 2869 7465   dirs.append(ite
+0001d220: 6d29 0a20 2020 2020 2020 2020 2020 2065  m).            e
+0001d230: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+0001d240: 2020 2020 2066 696c 6573 2e61 7070 656e       files.appen
+0001d250: 6428 6974 656d 290a 2020 2020 2020 2020  d(item).        
+0001d260: 2020 2020 2020 2020 6974 656d 5b22 7264          item["rd
+0001d270: 225d 203d 2072 656d 0a0a 2020 2020 2020  "] = rem..      
+0001d280: 2020 6966 2028 0a20 2020 2020 2020 2020    if (.         
+0001d290: 2020 2073 656c 662e 636f 6f6b 6965 732e     self.cookies.
+0001d2a0: 6765 7428 2269 6478 6822 2920 3d3d 2022  get("idxh") == "
+0001d2b0: 7922 0a20 2020 2020 2020 2020 2020 2061  y".            a
+0001d2c0: 6e64 2022 6c73 2220 6e6f 7420 696e 2073  nd "ls" not in s
+0001d2d0: 656c 662e 7570 6172 616d 0a20 2020 2020  elf.uparam.     
+0001d2e0: 2020 2020 2020 2061 6e64 2022 7622 206e         and "v" n
+0001d2f0: 6f74 2069 6e20 7365 6c66 2e75 7061 7261  ot in self.upara
+0001d300: 6d0a 2020 2020 2020 2020 293a 0a20 2020  m.        ):.   
+0001d310: 2020 2020 2020 2020 2069 6478 5f68 746d           idx_htm
+0001d320: 6c20 3d20 7365 7428 5b22 696e 6465 782e  l = set(["index.
+0001d330: 6874 6d22 2c20 2269 6e64 6578 2e68 746d  htm", "index.htm
+0001d340: 6c22 5d29 0a20 2020 2020 2020 2020 2020  l"]).           
+0001d350: 2066 6f72 2069 7465 6d20 696e 2066 696c   for item in fil
+0001d360: 6573 3a0a 2020 2020 2020 2020 2020 2020  es:.            
+0001d370: 2020 2020 6966 2069 7465 6d5b 226e 616d      if item["nam
+0001d380: 6522 5d20 696e 2069 6478 5f68 746d 6c3a  e"] in idx_html:
+0001d390: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001d3a0: 2020 2020 2023 2064 6f20 6675 6c6c 2072       # do full r
+0001d3b0: 6573 6f6c 7665 2069 6e20 6361 7365 206f  esolve in case o
+0001d3c0: 6620 7368 6164 6f77 6564 2066 696c 650a  f shadowed file.
+0001d3d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d3e0: 2020 2020 7670 203d 2076 6a6f 696e 2873      vp = vjoin(s
+0001d3f0: 656c 662e 7670 6174 682e 7370 6c69 7428  elf.vpath.split(
+0001d400: 223f 2229 5b30 5d2c 2069 7465 6d5b 226e  "?")[0], item["n
+0001d410: 616d 6522 5d29 0a20 2020 2020 2020 2020  ame"]).         
+0001d420: 2020 2020 2020 2020 2020 2076 6e2c 2072             vn, r
+0001d430: 656d 203d 2073 656c 662e 6173 7276 2e76  em = self.asrv.v
+0001d440: 6673 2e67 6574 2876 702c 2073 656c 662e  fs.get(vp, self.
+0001d450: 756e 616d 652c 2054 7275 652c 2046 616c  uname, True, Fal
+0001d460: 7365 290a 2020 2020 2020 2020 2020 2020  se).            
+0001d470: 2020 2020 2020 2020 6170 203d 2076 6e2e          ap = vn.
+0001d480: 6361 6e6f 6e69 6361 6c28 7265 6d29 0a20  canonical(rem). 
+0001d490: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d4a0: 2020 2072 6574 7572 6e20 7365 6c66 2e74     return self.t
+0001d4b0: 785f 6669 6c65 2861 7029 2020 2320 6973  x_file(ap)  # is
+0001d4c0: 206e 6f2d 6361 6368 650a 0a20 2020 2020   no-cache..     
+0001d4d0: 2020 2074 6167 7365 7420 203d 2073 6574     tagset  = set
+0001d4e0: 2829 0a20 2020 2020 2020 2066 6f72 2066  ().        for f
+0001d4f0: 6520 696e 2066 696c 6573 3a0a 2020 2020  e in files:.    
+0001d500: 2020 2020 2020 2020 666e 203d 2066 655b          fn = fe[
+0001d510: 226e 616d 6522 5d0a 2020 2020 2020 2020  "name"].        
+0001d520: 2020 2020 7264 203d 2066 655b 2272 6422      rd = fe["rd"
+0001d530: 5d0a 2020 2020 2020 2020 2020 2020 6465  ].            de
+0001d540: 6c20 6665 5b22 7264 225d 0a20 2020 2020  l fe["rd"].     
+0001d550: 2020 2020 2020 2069 6620 6e6f 7420 6963         if not ic
+0001d560: 7572 3a0a 2020 2020 2020 2020 2020 2020  ur:.            
+0001d570: 2020 2020 636f 6e74 696e 7565 0a0a 2020      continue..  
+0001d580: 2020 2020 2020 2020 2020 6966 2076 6e20            if vn 
+0001d590: 213d 2064 6276 3a0a 2020 2020 2020 2020  != dbv:.        
+0001d5a0: 2020 2020 2020 2020 5f2c 2072 6420 3d20          _, rd = 
+0001d5b0: 766e 2e67 6574 5f64 6276 2872 6429 0a0a  vn.get_dbv(rd)..
+0001d5c0: 2020 2020 2020 2020 2020 2020 7120 3d20              q = 
+0001d5d0: 2273 656c 6563 7420 6d74 2e6b 2c20 6d74  "select mt.k, mt
+0001d5e0: 2e76 2066 726f 6d20 7570 2069 6e6e 6572  .v from up inner
+0001d5f0: 206a 6f69 6e20 6d74 206f 6e20 6d74 2e77   join mt on mt.w
+0001d600: 203d 2073 7562 7374 7228 7570 2e77 2c31   = substr(up.w,1
+0001d610: 2c31 3629 2077 6865 7265 2075 702e 7264  ,16) where up.rd
+0001d620: 203d 203f 2061 6e64 2075 702e 666e 203d   = ? and up.fn =
+0001d630: 203f 2061 6e64 202b 6d74 2e6b 2021 3d20   ? and +mt.k != 
+0001d640: 2778 2722 0a20 2020 2020 2020 2020 2020  'x'".           
+0001d650: 2074 7279 3a0a 2020 2020 2020 2020 2020   try:.          
+0001d660: 2020 2020 2020 7220 3d20 6963 7572 2e65        r = icur.e
+0001d670: 7865 6375 7465 2871 2c20 2872 642c 2066  xecute(q, (rd, f
+0001d680: 6e29 290a 2020 2020 2020 2020 2020 2020  n)).            
+0001d690: 6578 6365 7074 2045 7863 6570 7469 6f6e  except Exception
+0001d6a0: 2061 7320 6578 3a0a 2020 2020 2020 2020   as ex:.        
+0001d6b0: 2020 2020 2020 2020 6966 2022 6461 7461          if "data
+0001d6c0: 6261 7365 2069 7320 6c6f 636b 6564 2220  base is locked" 
+0001d6d0: 696e 2073 7472 2865 7829 3a0a 2020 2020  in str(ex):.    
+0001d6e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d6f0: 6272 6561 6b0a 0a20 2020 2020 2020 2020  break..         
+0001d700: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
+0001d710: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d720: 6172 6773 203d 2073 3365 6e63 2869 6478  args = s3enc(idx
+0001d730: 2e6d 656d 5f63 7572 2c20 7264 2c20 666e  .mem_cur, rd, fn
+0001d740: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0001d750: 2020 2020 2020 7220 3d20 6963 7572 2e65        r = icur.e
+0001d760: 7865 6375 7465 2871 2c20 6172 6773 290a  xecute(q, args).
+0001d770: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d780: 6578 6365 7074 3a0a 2020 2020 2020 2020  except:.        
+0001d790: 2020 2020 2020 2020 2020 2020 7420 3d20              t = 
+0001d7a0: 2274 6167 2072 6561 6420 6572 726f 722c  "tag read error,
+0001d7b0: 207b 7d2f 7b7d 5c6e 7b7d 220a 2020 2020   {}/{}\n{}".    
+0001d7c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d7d0: 7365 6c66 2e6c 6f67 2874 2e66 6f72 6d61  self.log(t.forma
+0001d7e0: 7428 7264 2c20 666e 2c20 6d69 6e5f 6578  t(rd, fn, min_ex
+0001d7f0: 2829 2929 0a20 2020 2020 2020 2020 2020  ())).           
+0001d800: 2020 2020 2020 2020 2062 7265 616b 0a0a           break..
+0001d810: 2020 2020 2020 2020 2020 2020 6665 5b22              fe["
+0001d820: 7461 6773 225d 203d 207b 6b3a 2076 2066  tags"] = {k: v f
+0001d830: 6f72 206b 2c20 7620 696e 2072 7d0a 2020  or k, v in r}.  
+0001d840: 2020 2020 2020 2020 2020 5f20 3d20 5b74            _ = [t
+0001d850: 6167 7365 742e 6164 6428 6b29 2066 6f72  agset.add(k) for
+0001d860: 206b 2069 6e20 6665 5b22 7461 6773 225d   k in fe["tags"]
+0001d870: 5d0a 0a20 2020 2020 2020 2069 6620 6963  ]..        if ic
+0001d880: 7572 3a0a 2020 2020 2020 2020 2020 2020  ur:.            
+0001d890: 7461 676c 6973 7420 3d20 5b6b 2066 6f72  taglist = [k for
+0001d8a0: 206b 2069 6e20 766e 2e66 6c61 6773 2e67   k in vn.flags.g
+0001d8b0: 6574 2822 6d74 6522 2c20 2222 292e 7370  et("mte", "").sp
+0001d8c0: 6c69 7428 222c 2229 2069 6620 6b20 696e  lit(",") if k in
+0001d8d0: 2074 6167 7365 745d 0a20 2020 2020 2020   tagset].       
+0001d8e0: 2020 2020 2066 6f72 2066 6520 696e 2064       for fe in d
+0001d8f0: 6972 733a 0a20 2020 2020 2020 2020 2020  irs:.           
+0001d900: 2020 2020 2066 655b 2274 6167 7322 5d20       fe["tags"] 
+0001d910: 3d20 7b7d 0a20 2020 2020 2020 2065 6c73  = {}.        els
+0001d920: 653a 0a20 2020 2020 2020 2020 2020 2074  e:.            t
+0001d930: 6167 6c69 7374 203d 206c 6973 7428 7461  aglist = list(ta
+0001d940: 6773 6574 290a 0a20 2020 2020 2020 2069  gset)..        i
+0001d950: 6620 6973 5f6c 733a 0a20 2020 2020 2020  f is_ls:.       
+0001d960: 2020 2020 206c 735f 7265 745b 2264 6972       ls_ret["dir
+0001d970: 7322 5d20 3d20 6469 7273 0a20 2020 2020  s"] = dirs.     
+0001d980: 2020 2020 2020 206c 735f 7265 745b 2266         ls_ret["f
+0001d990: 696c 6573 225d 203d 2066 696c 6573 0a20  iles"] = files. 
+0001d9a0: 2020 2020 2020 2020 2020 206c 735f 7265             ls_re
+0001d9b0: 745b 2274 6167 6c69 7374 225d 203d 2074  t["taglist"] = t
+0001d9c0: 6167 6c69 7374 0a20 2020 2020 2020 2020  aglist.         
+0001d9d0: 2020 2072 6574 7572 6e20 7365 6c66 2e74     return self.t
+0001d9e0: 785f 6c73 286c 735f 7265 7429 0a0a 2020  x_ls(ls_ret)..  
+0001d9f0: 2020 2020 2020 646f 6320 3d20 7365 6c66        doc = self
+0001da00: 2e75 7061 7261 6d2e 6765 7428 2264 6f63  .uparam.get("doc
+0001da10: 2229 2069 6620 7365 6c66 2e63 616e 5f72  ") if self.can_r
+0001da20: 6561 6420 656c 7365 204e 6f6e 650a 2020  ead else None.  
+0001da30: 2020 2020 2020 6966 2064 6f63 3a0a 2020        if doc:.  
+0001da40: 2020 2020 2020 2020 2020 646f 6320 3d20            doc = 
+0001da50: 756e 7175 6f74 6570 2864 6f63 2e72 6570  unquotep(doc.rep
+0001da60: 6c61 6365 2822 2b22 2c20 2220 2229 2e73  lace("+", " ").s
+0001da70: 706c 6974 2822 3f22 295b 305d 290a 2020  plit("?")[0]).  
+0001da80: 2020 2020 2020 2020 2020 6a32 615b 2264            j2a["d
+0001da90: 6f63 6e61 6d65 225d 203d 2064 6f63 0a20  ocname"] = doc. 
+0001daa0: 2020 2020 2020 2020 2020 2064 6f63 7478             doctx
+0001dab0: 7420 3d20 4e6f 6e65 0a20 2020 2020 2020  t = None.       
+0001dac0: 2020 2020 2069 6620 6e65 7874 2828 7820       if next((x 
+0001dad0: 666f 7220 7820 696e 2066 696c 6573 2069  for x in files i
+0001dae0: 6620 785b 226e 616d 6522 5d20 3d3d 2064  f x["name"] == d
+0001daf0: 6f63 292c 204e 6f6e 6529 3a0a 2020 2020  oc), None):.    
+0001db00: 2020 2020 2020 2020 2020 2020 646f 6370              docp
+0001db10: 6174 6820 3d20 6f73 2e70 6174 682e 6a6f  ath = os.path.jo
+0001db20: 696e 2861 6273 7061 7468 2c20 646f 6329  in(abspath, doc)
+0001db30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001db40: 2073 7a20 3d20 626f 732e 7061 7468 2e67   sz = bos.path.g
+0001db50: 6574 7369 7a65 2864 6f63 7061 7468 290a  etsize(docpath).
+0001db60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001db70: 6966 2073 7a20 3c20 3130 3234 202a 2073  if sz < 1024 * s
+0001db80: 656c 662e 6172 6773 2e74 7874 5f6d 6178  elf.args.txt_max
+0001db90: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0001dba0: 2020 2020 2020 7769 7468 206f 7065 6e28        with open(
+0001dbb0: 6673 656e 6328 646f 6370 6174 6829 2c20  fsenc(docpath), 
+0001dbc0: 2272 6222 2920 6173 2066 3a0a 2020 2020  "rb") as f:.    
+0001dbd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001dbe0: 2020 2020 646f 6374 7874 203d 2066 2e72      doctxt = f.r
+0001dbf0: 6561 6428 292e 6465 636f 6465 2822 7574  ead().decode("ut
+0001dc00: 662d 3822 2c20 2272 6570 6c61 6365 2229  f-8", "replace")
+0001dc10: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
+0001dc20: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+0001dc30: 2020 2073 656c 662e 6c6f 6728 2264 6f63     self.log("doc
+0001dc40: 2034 3034 3a20 5b7b 7d5d 222e 666f 726d   404: [{}]".form
+0001dc50: 6174 2864 6f63 292c 2063 3d36 290a 2020  at(doc), c=6).  
+0001dc60: 2020 2020 2020 2020 2020 2020 2020 646f                do
+0001dc70: 6374 7874 203d 2022 2820 7465 7874 6669  ctxt = "( textfi
+0001dc80: 6c65 206e 6f74 2066 6f75 6e64 2029 220a  le not found )".
+0001dc90: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+0001dca0: 646f 6374 7874 2069 7320 6e6f 7420 4e6f  doctxt is not No
+0001dcb0: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
+0001dcc0: 2020 2020 6a32 615b 2264 6f63 225d 203d      j2a["doc"] =
+0001dcd0: 2064 6f63 7478 740a 0a20 2020 2020 2020   doctxt..       
+0001dce0: 2066 6f72 2064 2069 6e20 6469 7273 3a0a   for d in dirs:.
+0001dcf0: 2020 2020 2020 2020 2020 2020 645b 226e              d["n
+0001dd00: 616d 6522 5d20 2b3d 2022 2f22 0a0a 2020  ame"] += "/"..  
+0001dd10: 2020 2020 2020 6469 7273 2e73 6f72 7428        dirs.sort(
+0001dd20: 6b65 793d 6974 656d 6765 7474 6572 2822  key=itemgetter("
+0001dd30: 6e61 6d65 2229 290a 0a20 2020 2020 2020  name"))..       
+0001dd40: 2069 6620 6973 5f6a 733a 0a20 2020 2020   if is_js:.     
+0001dd50: 2020 2020 2020 206a 3261 5b22 6c73 3022         j2a["ls0"
+0001dd60: 5d20 3d20 7b22 6469 7273 223a 2064 6972  ] = {"dirs": dir
+0001dd70: 732c 2022 6669 6c65 7322 3a20 6669 6c65  s, "files": file
+0001dd80: 732c 2022 7461 676c 6973 7422 3a20 7461  s, "taglist": ta
+0001dd90: 676c 6973 747d 0a20 2020 2020 2020 2020  glist}.         
+0001dda0: 2020 206a 3261 5b22 6669 6c65 7322 5d20     j2a["files"] 
+0001ddb0: 3d20 5b5d 0a20 2020 2020 2020 2065 6c73  = [].        els
+0001ddc0: 653a 0a20 2020 2020 2020 2020 2020 206a  e:.            j
+0001ddd0: 3261 5b22 6669 6c65 7322 5d20 3d20 6469  2a["files"] = di
+0001dde0: 7273 202b 2066 696c 6573 0a0a 2020 2020  rs + files..    
+0001ddf0: 2020 2020 6a32 615b 2274 6167 6c69 7374      j2a["taglist
+0001de00: 225d 203d 2074 6167 6c69 7374 0a20 2020  "] = taglist.   
+0001de10: 2020 2020 206a 3261 5b22 7478 745f 6578       j2a["txt_ex
+0001de20: 7422 5d20 3d20 7365 6c66 2e61 7267 732e  t"] = self.args.
+0001de30: 7465 7874 6669 6c65 732e 7265 706c 6163  textfiles.replac
+0001de40: 6528 222c 222c 2022 2022 290a 0a20 2020  e(",", " ")..   
+0001de50: 2020 2020 2069 6620 226d 7468 2220 696e       if "mth" in
+0001de60: 2076 6e2e 666c 6167 733a 0a20 2020 2020   vn.flags:.     
+0001de70: 2020 2020 2020 206a 3261 5b22 6465 665f         j2a["def_
+0001de80: 6863 6f6c 7322 5d20 3d20 766e 2e66 6c61  hcols"] = vn.fla
+0001de90: 6773 5b22 6d74 6822 5d2e 7370 6c69 7428  gs["mth"].split(
+0001dea0: 222c 2229 0a0a 2020 2020 2020 2020 6874  ",")..        ht
+0001deb0: 6d6c 203d 2073 656c 662e 6a32 7328 7470  ml = self.j2s(tp
+0001dec0: 6c2c 202a 2a6a 3261 290a 2020 2020 2020  l, **j2a).      
+0001ded0: 2020 7365 6c66 2e72 6570 6c79 2868 746d    self.reply(htm
+0001dee0: 6c2e 656e 636f 6465 2822 7574 662d 3822  l.encode("utf-8"
+0001def0: 2c20 2272 6570 6c61 6365 2229 290a 2020  , "replace")).  
+0001df00: 2020 2020 2020 7265 7475 726e 2054 7275        return Tru
+0001df10: 650a                                     e.
```

### Comparing `copyparty-1.7.0/copyparty/httpconn.py` & `copyparty-1.7.1/copyparty/httpconn.py`

 * *Files identical despite different names*

### Comparing `copyparty-1.7.0/copyparty/httpsrv.py` & `copyparty-1.7.1/copyparty/httpsrv.py`

 * *Files identical despite different names*

### Comparing `copyparty-1.7.0/copyparty/ico.py` & `copyparty-1.7.1/copyparty/ico.py`

 * *Files identical despite different names*

### Comparing `copyparty-1.7.0/copyparty/mdns.py` & `copyparty-1.7.1/copyparty/mdns.py`

 * *Files identical despite different names*

### Comparing `copyparty-1.7.0/copyparty/mtag.py` & `copyparty-1.7.1/copyparty/mtag.py`

 * *Files identical despite different names*

### Comparing `copyparty-1.7.0/copyparty/multicast.py` & `copyparty-1.7.1/copyparty/multicast.py`

 * *Files identical despite different names*

### Comparing `copyparty-1.7.0/copyparty/res/COPYING.txt` & `copyparty-1.7.1/copyparty/res/COPYING.txt`

 * *Files identical despite different names*

### Comparing `copyparty-1.7.0/copyparty/res/insecure.pem` & `copyparty-1.7.1/copyparty/res/insecure.pem`

 * *Files identical despite different names*

### Comparing `copyparty-1.7.0/copyparty/smbd.py` & `copyparty-1.7.1/copyparty/smbd.py`

 * *Files identical despite different names*

### Comparing `copyparty-1.7.0/copyparty/ssdp.py` & `copyparty-1.7.1/copyparty/ssdp.py`

 * *Files identical despite different names*

### Comparing `copyparty-1.7.0/copyparty/star.py` & `copyparty-1.7.1/copyparty/star.py`

 * *Files identical despite different names*

### Comparing `copyparty-1.7.0/copyparty/stolen/dnslib/bimap.py` & `copyparty-1.7.1/copyparty/stolen/dnslib/bimap.py`

 * *Files identical despite different names*

### Comparing `copyparty-1.7.0/copyparty/stolen/dnslib/buffer.py` & `copyparty-1.7.1/copyparty/stolen/dnslib/buffer.py`

 * *Files identical despite different names*

### Comparing `copyparty-1.7.0/copyparty/stolen/dnslib/dns.py` & `copyparty-1.7.1/copyparty/stolen/dnslib/dns.py`

 * *Files identical despite different names*

### Comparing `copyparty-1.7.0/copyparty/stolen/dnslib/label.py` & `copyparty-1.7.1/copyparty/stolen/dnslib/label.py`

 * *Files identical despite different names*

### Comparing `copyparty-1.7.0/copyparty/stolen/dnslib/lex.py` & `copyparty-1.7.1/copyparty/stolen/dnslib/lex.py`

 * *Files identical despite different names*

### Comparing `copyparty-1.7.0/copyparty/stolen/dnslib/ranges.py` & `copyparty-1.7.1/copyparty/stolen/dnslib/ranges.py`

 * *Files identical despite different names*

### Comparing `copyparty-1.7.0/copyparty/stolen/ifaddr/_posix.py` & `copyparty-1.7.1/copyparty/stolen/ifaddr/_posix.py`

 * *Files identical despite different names*

### Comparing `copyparty-1.7.0/copyparty/stolen/ifaddr/_shared.py` & `copyparty-1.7.1/copyparty/stolen/ifaddr/_shared.py`

 * *Files identical despite different names*

### Comparing `copyparty-1.7.0/copyparty/stolen/ifaddr/_win32.py` & `copyparty-1.7.1/copyparty/stolen/ifaddr/_win32.py`

 * *Files identical despite different names*

### Comparing `copyparty-1.7.0/copyparty/stolen/qrcodegen.py` & `copyparty-1.7.1/copyparty/stolen/qrcodegen.py`

 * *Files identical despite different names*

### Comparing `copyparty-1.7.0/copyparty/stolen/surrogateescape.py` & `copyparty-1.7.1/copyparty/stolen/surrogateescape.py`

 * *Files identical despite different names*

### Comparing `copyparty-1.7.0/copyparty/sutil.py` & `copyparty-1.7.1/copyparty/sutil.py`

 * *Files identical despite different names*

### Comparing `copyparty-1.7.0/copyparty/svchub.py` & `copyparty-1.7.1/copyparty/svchub.py`

 * *Files identical despite different names*

### Comparing `copyparty-1.7.0/copyparty/szip.py` & `copyparty-1.7.1/copyparty/szip.py`

 * *Files identical despite different names*

### Comparing `copyparty-1.7.0/copyparty/tcpsrv.py` & `copyparty-1.7.1/copyparty/tcpsrv.py`

 * *Files identical despite different names*

### Comparing `copyparty-1.7.0/copyparty/th_cli.py` & `copyparty-1.7.1/copyparty/th_cli.py`

 * *Files identical despite different names*

### Comparing `copyparty-1.7.0/copyparty/th_srv.py` & `copyparty-1.7.1/copyparty/th_srv.py`

 * *Files identical despite different names*

### Comparing `copyparty-1.7.0/copyparty/u2idx.py` & `copyparty-1.7.1/copyparty/u2idx.py`

 * *Files identical despite different names*

### Comparing `copyparty-1.7.0/copyparty/up2k.py` & `copyparty-1.7.1/copyparty/up2k.py`

 * *Files 0% similar despite different names*

```diff
@@ -66,16 +66,16 @@
     import sqlite3
 
 DB_VER = 5
 
 if TYPE_CHECKING:
     from .svchub import SvcHub
 
-zs = "avif,avifs,bmp,gif,heic,heics,heif,heifs,ico,j2p,j2k,jp2,jpeg,jpg,jpx,png,tga,tif,tiff,webp"
-CV_EXTS = set(zs.split(","))
+zsg = "avif,avifs,bmp,gif,heic,heics,heif,heifs,ico,j2p,j2k,jp2,jpeg,jpg,jpx,png,tga,tif,tiff,webp"
+CV_EXTS = set(zsg.split(","))
 
 
 class Dbw(object):
     def __init__(self, c , n , t )  :
         self.c = c
         self.n = n
         self.t = t
```

### Comparing `copyparty-1.7.0/copyparty/util.py` & `copyparty-1.7.1/copyparty/util.py`

 * *Files 1% similar despite different names*

```diff
@@ -276,19 +276,19 @@
 
 REKOBO_LKEY = {k.lower(): v for k, v in REKOBO_KEY.items()}
 
 
 pybin = sys.executable or ""
 if EXE:
     pybin = ""
-    for p in "python3 python".split():
+    for zsg in "python3 python".split():
         try:
-            p = shutil.which(p)
-            if p:
-                pybin = p
+            zsg = shutil.which(zsg)
+            if zsg:
+                pybin = zsg
                 break
         except:
             pass
 
 
 def py_desc()  :
     interp = platform.python_implementation()
@@ -1573,15 +1573,15 @@
         t = "fk({}) salt({}) size({}) inode({}) fspath({}) at({})"
         log(t.format(ret[:8], salt, fsize, inode, fspath, ctx), 5)
 
     return ret
 
 
 def gencookie(k , v , r , tls , dur )  :
-    v = v.replace(";", "")
+    v = v.replace("%", "%25").replace(";", "%3B")
     if dur:
         exp = formatdate(time.time() + dur, usegmt=True)
     else:
         exp = "Fri, 15 Aug 1997 01:00:00 GMT"
 
     return "{}={}; Path=/{}; Expires={}{}; SameSite=Lax".format(
         k, v, r, exp, "; Secure" if tls else ""
@@ -2300,15 +2300,15 @@
         elif len(esc) > 0:
             esc += ch
             if len(esc) == 3:
                 try:
                     ret += chr(int(esc[1:], 16))
                 except:
                     ret += esc
-                    esc = ""
+                esc = ""
 
         else:
             ret += ch
 
     if len(esc) > 0:
         ret += esc
```

### Comparing `copyparty-1.7.0/copyparty/web/a/webdav-cfg.bat` & `copyparty-1.7.1/copyparty/web/a/webdav-cfg.bat`

 * *Files identical despite different names*

### Comparing `copyparty-1.7.0/copyparty/web/browser.html` & `copyparty-1.7.1/copyparty/web/browser.html`

 * *Files identical despite different names*

### Comparing `copyparty-1.7.0/copyparty/web/browser2.html` & `copyparty-1.7.1/copyparty/web/browser2.html`

 * *Files identical despite different names*

### Comparing `copyparty-1.7.0/copyparty/web/cf.html` & `copyparty-1.7.1/copyparty/web/cf.html`

 * *Files identical despite different names*

### Comparing `copyparty-1.7.0/copyparty/web/deps/easymde.css.gz` & `copyparty-1.7.1/copyparty/web/deps/easymde.css.gz`

 * *Files identical despite different names*

### Comparing `copyparty-1.7.0/copyparty/web/deps/easymde.js.gz` & `copyparty-1.7.1/copyparty/web/deps/easymde.js.gz`

 * *Files identical despite different names*

### Comparing `copyparty-1.7.0/copyparty/web/deps/marked.js.gz` & `copyparty-1.7.1/copyparty/web/deps/marked.js.gz`

 * *Files identical despite different names*

### Comparing `copyparty-1.7.0/copyparty/web/deps/mini-fa.css.gz` & `copyparty-1.7.1/copyparty/web/deps/mini-fa.css.gz`

 * *Files identical despite different names*

### Comparing `copyparty-1.7.0/copyparty/web/deps/mini-fa.woff` & `copyparty-1.7.1/copyparty/web/deps/mini-fa.woff`

 * *Files identical despite different names*

### Comparing `copyparty-1.7.0/copyparty/web/deps/prism.css.gz` & `copyparty-1.7.1/copyparty/web/deps/prism.css.gz`

 * *Files identical despite different names*

### Comparing `copyparty-1.7.0/copyparty/web/deps/prism.js.gz` & `copyparty-1.7.1/copyparty/web/deps/prism.js.gz`

 * *Files identical despite different names*

### Comparing `copyparty-1.7.0/copyparty/web/deps/prismd.css.gz` & `copyparty-1.7.1/copyparty/web/deps/prismd.css.gz`

 * *Files identical despite different names*

### Comparing `copyparty-1.7.0/copyparty/web/deps/scp.woff2` & `copyparty-1.7.1/copyparty/web/deps/scp.woff2`

 * *Files identical despite different names*

### Comparing `copyparty-1.7.0/copyparty/web/deps/sha512.ac.js.gz` & `copyparty-1.7.1/copyparty/web/deps/sha512.ac.js.gz`

 * *Files identical despite different names*

### Comparing `copyparty-1.7.0/copyparty/web/deps/sha512.hw.js.gz` & `copyparty-1.7.1/copyparty/web/deps/sha512.hw.js.gz`

 * *Files identical despite different names*

### Comparing `copyparty-1.7.0/copyparty/web/md.html` & `copyparty-1.7.1/copyparty/web/md.html`

 * *Files identical despite different names*

### Comparing `copyparty-1.7.0/copyparty/web/mde.css.gz` & `copyparty-1.7.1/copyparty/web/mde.css.gz`

 * *Files identical despite different names*

### Comparing `copyparty-1.7.0/copyparty/web/mde.html` & `copyparty-1.7.1/copyparty/web/mde.html`

 * *Files identical despite different names*

### Comparing `copyparty-1.7.0/copyparty/web/msg.html` & `copyparty-1.7.1/copyparty/web/msg.html`

 * *Files identical despite different names*

### Comparing `copyparty-1.7.0/copyparty/web/splash.html` & `copyparty-1.7.1/copyparty/web/splash.html`

 * *Files identical despite different names*

### Comparing `copyparty-1.7.0/copyparty/web/splash.js.gz` & `copyparty-1.7.1/copyparty/web/splash.js.gz`

 * *Files identical despite different names*

### Comparing `copyparty-1.7.0/copyparty/web/svcs.html` & `copyparty-1.7.1/copyparty/web/svcs.html`

 * *Files 0% similar despite different names*

```diff
@@ -177,15 +177,15 @@
         <pre>
             partyfuse.py{% if accs %} -a <b>{{ pw }}</b>{% endif %} http{{ s }}://{{ ep }}/{{ rvp }} <b><span class="os win">W:</span><span class="os lin mac">mp</span></b>
         </pre>
         {% if s %}
         <p><em>note: if you are on LAN (or just dont have valid certificates), add <code>-td</code></em></p>
         {% endif %}
         <p>
-            you can use <a href="{{ r }}/.cpr/a/up2k.py">up2k.py</a> to upload (sometimes faster than web-browsers)
+            you can use <a href="{{ r }}/.cpr/a/u2c.py">u2c.py</a> to upload (sometimes faster than web-browsers)
         </p>
 
 
         {% if args.smb %}
         <h1>SMB / CIFS</h1>
         <em><a href="https://github.com/SecureAuthCorp/impacket/issues/1433">bug:</a> max ~300 files in each folder</em>
```

#### html2text {}

```diff
@@ -120,15 +120,15 @@
 ****** partyfuse ******
 partyfuse.py -- fast, read-only, needs winfsp doesn't need root
             partyfuse.py{% if accs %} -a {{ pw }}{% endif %} http{{ s }}://{
 { ep }}/{{ rvp }} W:mp
 {% if s %}
 note: if you are on LAN (or just dont have valid certificates), add -td
 {% endif %}
-you can use up2k.py to upload (sometimes faster than web-browsers)
+you can use u2c.py to upload (sometimes faster than web-browsers)
 {% if args.smb %}
 ****** SMB / CIFS ******
 bug: max ~300 files in each folder
                 net use w: \\{{ host }}\a{% if accs %} k /user:{{ pw }}{% endif
 %}
                 mount -t cifs -o{% if accs %}user={{ pw }},pass=k,{% endif
 %}vers={{ 1 if args.smb1 else 2 }}.0,port={{ args.smb_port }},uid=1000 //{
```

### Comparing `copyparty-1.7.0/copyparty.egg-info/PKG-INFO` & `copyparty-1.7.1/copyparty.egg-info/PKG-INFO`

 * *Files 1% similar despite different names*

```diff
@@ -1,15 +1,16 @@
 Metadata-Version: 2.1
 Name: copyparty
-Version: 1.7.0
-Summary: Portable file server with accelerated resumable uploads, deduplication, WebDAV, FTP, zeroconf, media indexer, video thumbnails, audio transcoding, and write-only folders
-Home-page: https://github.com/9001/copyparty
-Author: ed
-Author-email: copyparty@ocv.me
+Version: 1.7.1
+Summary:   Portable file server with accelerated resumable uploads, deduplication, WebDAV, FTP, zeroconf, media indexer, video thumbnails, audio transcoding, and write-only folders
+Author-email: ed <copyparty@ocv.me>
 License: MIT
+Project-URL: Source Code, https://github.com/9001/copyparty
+Project-URL: Bug Tracker, https://github.com/9001/copyparty/issues
+Project-URL: Demo Server, https://a.ocv.me/pub/demo/
 Classifier: Development Status :: 5 - Production/Stable
 Classifier: License :: OSI Approved :: MIT License
 Classifier: Programming Language :: Python
 Classifier: Programming Language :: Python :: 3
 Classifier: Programming Language :: Python :: 3.3
 Classifier: Programming Language :: Python :: 3.4
 Classifier: Programming Language :: Python :: 3.5
@@ -26,14 +27,15 @@
 Classifier: Environment :: Console
 Classifier: Environment :: No Input/Output (Daemon)
 Classifier: Intended Audience :: End Users/Desktop
 Classifier: Intended Audience :: System Administrators
 Classifier: Topic :: Communications :: File Sharing
 Classifier: Topic :: Internet :: File Transfer Protocol (FTP)
 Classifier: Topic :: Internet :: WWW/HTTP :: HTTP Servers
+Requires-Python: >=3.3
 Description-Content-Type: text/markdown
 Provides-Extra: thumbnails
 Provides-Extra: thumbnails2
 Provides-Extra: audiotags
 Provides-Extra: ftpd
 Provides-Extra: ftps
 License-File: LICENSE
@@ -140,17 +142,17 @@
 * [devnotes](#devnotes) - for build instructions etc, see [./docs/devnotes.md](./docs/devnotes.md)
 
 
 ## quickstart
 
 just run **[copyparty-sfx.py](https://github.com/9001/copyparty/releases/latest/download/copyparty-sfx.py)** -- that's it! 🎉
 
-* or install through pypi (python3 only): `python3 -m pip install --user -U copyparty`
+* or install through pypi: `python3 -m pip install --user -U copyparty`
 * or if you cannot install python, you can use [copyparty.exe](#copypartyexe) instead
-* or [install through nix](#nix-package), or [on NixOS](#nixos-module), or [on arch](#arch-package)
+* or install [on arch](#arch-package) ╱ [on NixOS](#nixos-module) ╱ [through nix](#nix-package)
 * or if you are on android, [install copyparty in termux](#install-on-android)
 * or if you prefer to [use docker](./scripts/docker/) 🐋 you can do that too
   * docker has all deps built-in, so skip this step:
 
 enable thumbnails (images/audio/video), media indexing, and audio transcoding by installing some recommended deps:
 
 * **Alpine:** `apk add py3-pillow ffmpeg`
@@ -341,15 +343,15 @@
 
 upgrade notes
 
 * `1.6.0` (2023-01-29):
   * http-api: delete/move is now `POST` instead of `GET`
   * everything other than `GET` and `HEAD` must pass [cors validation](#cors)
 * `1.5.0` (2022-12-03): [new chunksize formula](https://github.com/9001/copyparty/commit/54e1c8d261df) for files larger than 128 GiB
-  * **users:** upgrade to the latest [cli uploader](https://github.com/9001/copyparty/blob/hovudstraum/bin/up2k.py) if you use that
+  * **users:** upgrade to the latest [cli uploader](https://github.com/9001/copyparty/blob/hovudstraum/bin/u2c.py) if you use that
   * **devs:** update third-party up2k clients (if those even exist)
 
 
 # FAQ
 
 "frequently" asked questions
 
@@ -548,15 +550,15 @@
 you can also zip a selection of files or folders by clicking them in the browser, that brings up a selection editor and zip button in the bottom right
 
 ![copyparty-zipsel-fs8](https://user-images.githubusercontent.com/241032/129635374-e5136e01-470a-49b1-a762-848e8a4c9cdc.png)
 
 
 ## uploading
 
-drag files/folders into the web-browser to upload  (or use the [command-line uploader](https://github.com/9001/copyparty/tree/hovudstraum/bin#up2kpy))
+drag files/folders into the web-browser to upload  (or use the [command-line uploader](https://github.com/9001/copyparty/tree/hovudstraum/bin#u2cpy))
 
 this initiates an upload using `up2k`; there are two uploaders available:
 * `[🎈] bup`, the basic uploader, supports almost every browser since netscape 4.0
 * `[🚀] up2k`, the good / fancy one
 
 NB: you can undo/delete your own uploads with `[🧯]` [unpost](#unpost)
 
@@ -1410,18 +1412,18 @@
   * `chunk(){ curl -H pw:wark -T- http://127.0.0.1:3923/;}`  
     `chunk <movie.mkv`
 
 * bash: when curl and wget is not available or too boring
   * `(printf 'PUT /junk?pw=wark HTTP/1.1\r\n\r\n'; cat movie.mkv) | nc 127.0.0.1 3923`
   * `(printf 'PUT / HTTP/1.1\r\n\r\n'; cat movie.mkv) >/dev/tcp/127.0.0.1/3923`
 
-* python: [up2k.py](https://github.com/9001/copyparty/blob/hovudstraum/bin/up2k.py) is a command-line up2k client [(webm)](https://ocv.me/stuff/u2cli.webm)
+* python: [u2c.py](https://github.com/9001/copyparty/blob/hovudstraum/bin/u2c.py) is a command-line up2k client [(webm)](https://ocv.me/stuff/u2cli.webm)
   * file uploads, file-search, [folder sync](#folder-sync), autoresume of aborted/broken uploads
-  * can be downloaded from copyparty: controlpanel -> connect -> [up2k.py](http://127.0.0.1:3923/.cpr/a/up2k.py)
-  * see [./bin/README.md#up2kpy](bin/README.md#up2kpy)
+  * can be downloaded from copyparty: controlpanel -> connect -> [u2c.py](http://127.0.0.1:3923/.cpr/a/u2c.py)
+  * see [./bin/README.md#u2cpy](bin/README.md#u2cpy)
 
 * FUSE: mount a copyparty server as a local filesystem
   * cross-platform python client available in [./bin/](bin/)
   * can be downloaded from copyparty: controlpanel -> connect -> [partyfuse.py](http://127.0.0.1:3923/.cpr/a/partyfuse.py)
   * [rclone](https://rclone.org/) as client can give ~5x performance, see [./docs/rclone.md](docs/rclone.md)
 
 * sharex (screenshot utility): see [./contrib/sharex.sxcu](contrib/#sharexsxcu)
@@ -1436,19 +1438,19 @@
 NOTE: curl will not send the original filename if you use `-T` combined with url-params! Also, make sure to always leave a trailing slash in URLs unless you want to override the filename
 
 
 ## folder sync
 
 sync folders to/from copyparty
 
-the commandline uploader [up2k.py](https://github.com/9001/copyparty/tree/hovudstraum/bin#up2kpy) with `--dr` is the best way to sync a folder to copyparty; verifies checksums and does files in parallel, and deletes unexpected files on the server after upload has finished which makes file-renames really cheap (it'll rename serverside and skip uploading)
+the commandline uploader [u2c.py](https://github.com/9001/copyparty/tree/hovudstraum/bin#u2cpy) with `--dr` is the best way to sync a folder to copyparty; verifies checksums and does files in parallel, and deletes unexpected files on the server after upload has finished which makes file-renames really cheap (it'll rename serverside and skip uploading)
 
 alternatively there is [rclone](./docs/rclone.md) which allows for bidirectional sync and is *way* more flexible (stream files straight from sftp/s3/gcs to copyparty, ...), although there is no integrity check and it won't work with files over 100 MiB if copyparty is behind cloudflare
 
-* starting from rclone v1.63 (currently [in beta](https://beta.rclone.org/?filter=latest)), rclone will also be faster than up2k.py
+* starting from rclone v1.63 (currently [in beta](https://beta.rclone.org/?filter=latest)), rclone will also be faster than u2c.py
 
 
 ## mount as drive
 
 a remote copyparty server as a local filesystem;  go to the control-panel and click `connect` to see a list of commands to do that
 
 alternatively, some alternatives roughly sorted by speed (unreproducible benchmark), best first:
@@ -1507,15 +1509,15 @@
 ## client-side
 
 when uploading files,
 
 * chrome is recommended, at least compared to firefox:
   * up to 90% faster when hashing, especially on SSDs
   * up to 40% faster when uploading over extremely fast internets
-  * but [up2k.py](https://github.com/9001/copyparty/blob/hovudstraum/bin/up2k.py) can be 40% faster than chrome again
+  * but [u2c.py](https://github.com/9001/copyparty/blob/hovudstraum/bin/u2c.py) can be 40% faster than chrome again
 
 * if you're cpu-bottlenecked, or the browser is maxing a cpu core:
   * up to 30% faster uploads if you hide the upload status list by switching away from the `[🚀]` up2k ui-tab (or closing it)
     * optionally you can switch to the lightweight potato ui by clicking the `[🥔]`
     * switching to another browser-tab also works, the favicon will update every 10 seconds in that case
   * unlikely to be a problem, but can happen when uploding many small files, or your internet is too fast, or PC too slow
```

### Comparing `copyparty-1.7.0/copyparty.egg-info/SOURCES.txt` & `copyparty-1.7.1/copyparty.egg-info/SOURCES.txt`

 * *Files 2% similar despite different names*

```diff
@@ -1,13 +1,10 @@
 LICENSE
-MANIFEST.in
 README.md
-setup.py
-bin/partyfuse.py
-bin/up2k.py
+pyproject.toml
 copyparty/__init__.py
 copyparty/__main__.py
 copyparty/__version__.py
 copyparty/authsrv.py
 copyparty/broker_mp.py
 copyparty/broker_mpw.py
 copyparty/broker_thr.py
@@ -41,14 +38,15 @@
 copyparty.egg-info/entry_points.txt
 copyparty.egg-info/requires.txt
 copyparty.egg-info/top_level.txt
 copyparty/bos/__init__.py
 copyparty/bos/bos.py
 copyparty/bos/path.py
 copyparty/res/COPYING.txt
+copyparty/res/__init__.py
 copyparty/res/insecure.pem
 copyparty/stolen/__init__.py
 copyparty/stolen/qrcodegen.py
 copyparty/stolen/surrogateescape.py
 copyparty/stolen/dnslib/__init__.py
 copyparty/stolen/dnslib/bimap.py
 copyparty/stolen/dnslib/bit.py
@@ -63,15 +61,14 @@
 copyparty/stolen/ifaddr/_win32.py
 copyparty/web/baguettebox.js.gz
 copyparty/web/browser.css.gz
 copyparty/web/browser.html
 copyparty/web/browser.js.gz
 copyparty/web/browser2.html
 copyparty/web/cf.html
-copyparty/web/copyparty.gif
 copyparty/web/dbg-audio.js.gz
 copyparty/web/md.css.gz
 copyparty/web/md.html
 copyparty/web/md.js.gz
 copyparty/web/md2.css.gz
 copyparty/web/md2.js.gz
 copyparty/web/mde.css.gz
@@ -86,15 +83,15 @@
 copyparty/web/svcs.js.gz
 copyparty/web/ui.css.gz
 copyparty/web/up2k.js.gz
 copyparty/web/util.js.gz
 copyparty/web/w.hash.js.gz
 copyparty/web/a/__init__.py
 copyparty/web/a/partyfuse.py
-copyparty/web/a/up2k.py
+copyparty/web/a/u2c.py
 copyparty/web/a/webdav-cfg.bat
 copyparty/web/dd/2.png
 copyparty/web/dd/3.png
 copyparty/web/dd/4.png
 copyparty/web/dd/5.png
 copyparty/web/dd/__init__.py
 copyparty/web/deps/__init__.py
```

